# 前言

Nagios Core，作为 Nagios 监控框架的开源版本，是托管在类似 Unix 系统上的网络监控行业标准，如 GNU/Linux 或 BSD。它通常被网络和系统管理员用于检查主机之间的连接性，并确保网络服务按预期运行。

许多自家编写的脚本执行网络检查时，可能会迅速变得无法维护，而且对新手管理员来说，定制起来也不安全。而 Nagios Core 提供了一个严格且可配置的监控框架，以一致的方式进行检查，并向适当的人员和系统发送通知，告知它检测到的任何问题。

这使得 Nagios Core 成为一个非常通用的监控框架，而不是一个开箱即用的监控解决方案，这也让它在初学者中显得有些不友好，即便是经验丰富的管理员，也会觉得它有点像一个“黑盒子”。繁忙的管理员在设置 Nagios Core 系统时，通常会将其配置为每隔几分钟向一组主机发送 PING 请求，并在出现任何问题时发送电子邮件通知，而其他部分则不再处理。对于那些刚接触该系统的冒险型管理员，他们可能会设置一些 HTTP 检查，确保公司网站响应正常。

Nagios Core 的功能远不止这些，本书的食谱旨在强调精细化和控制 Nagios Core 检查、通知和报告的各种方法，而不仅仅是列出使用特定插件的指令，网上有成百上千个插件可以在 Nagios Exchange 平台上找到，网址为[`exchange.nagios.org/`](http://exchange.nagios.org/)。本书的根本目标是让管理员对 Nagios Core 的潜力产生兴趣，超越基础的默认检查行为，从而能够利用更多框架的功能，使其成为网络监控的核心。

这还包括安装甚至编写自定义插件，超出标准的 Nagios 插件集，编写和优化自己的检查，使用非常强大的**简单网络管理协议**（**SNMP**），记录和报告性能数据，优化通知行为，仅在适当的时间将适当的通知发送给适当的人或系统，基本的可视化选项，识别网络路径中的故障，巧妙使用默认的 Web 界面，甚至通过其他开源程序扩展 Nagios Core，所有这些都是为了检查几乎任何类型的主机属性或网络服务，适用于任何网络。

在可能的情况下，本书着重介绍由 Nagios 团队自己编写的插件，特别是 NRPE 和 NSCA。它省略了对流行的 NRPE 替代品`check_mk`以及 Nagios Core 的流行分支（如 Icinga）的讨论。为了深入理解高级 Nagios Core 配置，书中也未讨论任何配置前端或向导工具，如 NConf。最后，作为一本聚焦于免费可用的 Nagios Core 的 Packt 开源系列书籍，它也没有直接讨论 Nagios XI 的使用——这是 Nagios 团队支持的商业版软件。这样做是为了深入理解 Nagios Core 本身，而不是反映作者的个人观点；有兴趣的管理员应当研究所有这些项目（特别是`check_mk`）。

# 本书内容概述

第一章，*理解主机、服务和联系人*，解释了 Nagios Core 配置的基本构建块及其相互关系，并讨论了如何与每个构建块一起使用组。

第二章，*使用命令和插件*，解释了插件和命令的架构，包括安装新插件、定义现有插件的自定义使用，并通过用 Perl 编写新插件的过程进行讲解。

第三章，*使用检查和状态*，解释了 Nagios Core 如何执行检查以及如何自定义此行为，包括为主机和服务安排停机时间，以及管理那些一直上下波动的主机或服务的“波动”问题。

第四章，*配置通知*，解释了 Nagios Core 如何根据什么标准通知，何时通知以及通知给谁，包括实施自定义通知方法、对在一定时间内未解决的通知进行升级以及调度联系人轮换的示例。

第五章，*监控方法*，给出了一些标准 Nagios 插件集的使用示例，从基本的网络连接检查（如 PING 和 HTTP）到涉及 SNMP 使用的更复杂、更强大的检查。

第六章，*启用远程执行*，展示了如何使用 NRPE 来绕过无法直接通过网络检查系统属性的问题，并演示了更高级的`check_by_ssh`方法。

第七章，*使用 Web 界面*，展示了 Web 界面的一些不常用功能，实际控制 Nagios Core 的行为并查看高级报告，而不仅仅是查看当前状态信息。网络图的使用没有在此讨论，而是在下一章中进行介绍。

第八章，*管理网络布局*，解释了如何使 Nagios Core 了解您的网络的结构和功能，重点是主机和服务之间的相互依赖，以确保其正确运行，包括监控集群，并利用这些布局信息构建网络状态图，必要时可添加图标和背景。

第九章，*配置管理*，展示了如何在不使用前端的情况下，精简、优化并控制 Nagios Core 的配置。它专注于巧妙地使用组、模板和宏，并给出了使用模板语言`m4`程序化生成配置的示例。

第十章，*安全性与性能*，展示了如何管理简单的访问控制、调试运行时问题以及监控 Nagios Core 的性能，并演示了基本的监控冗余。

第十一章，*自动化与扩展 Nagios Core*，解释了如何通过命令文件将来自其他程序（包括 NSCA）的检查结果提交，从而提供有关外部进程的信息，并介绍了一些流行的插件（**NDOUtils**、**NagVis** 和 **Nagiosgrapher**）。

# 本书所需的内容

为了配合“标准”安装的 Nagios Core，本书中的配方假设已按照 [`nagios.sourceforge.net/docs/3_0/quickstart.html`](http://nagios.sourceforge.net/docs/3_0/quickstart.html) 中的 Nagios 快速入门指南，将 Nagios Core 3.0 或更高版本以及 Nagios 插件集安装在`/usr/local/nagios`目录下。

如果您的系统的软件包库包含您希望使用的 Nagios Core 3.0 或更高版本的包，这仍然是可能的，但所有文件的路径可能会非常不同。这在 Debian 或 Ubuntu 系统中的`nagios3`包上尤其常见。如果您熟悉您的打包系统所强加的安装布局差异，您仍然应该能够通过仅更改路径来跟随本书中的配方。

对于网页界面的截图，使用的是经典的 Nagios UI（白底黑字的菜单），这是从 3.0 版本起作为默认界面使用了多年，直到较新的“Exfoliation”风格（黑底白字菜单）成为了默认界面。虽然某些图形元素和样式不同，但所有文本内容和位置都相同，因此如果您已经安装了 Exfoliation 风格，就不必安装经典 UI，也能跟随本书进行操作。

如果您确实想要使用经典界面，以便您看到的内容与截图完全匹配，您可以通过在安装过程的最后一步添加以下内容来安装它：

```
# make install-classicui
```

本书是在 Nagios Core 4.0 的 alpha 版本测试期间编写的。我已经审阅了该 alpha 版本的更改日志，并且有信心所有的食谱在这个新版本的正式发布中都能正常工作。如果在 Nagios Core 4.0 发布后，您确实发现某些食谱存在问题，请参考“勘误”章节，告知出版商和作者。

# 本书适合谁阅读

本书面向那些熟悉通过命令行进行基本类 Unix 系统管理的系统和网络管理员。虽然本书最适合 GNU/Linux 管理员，但对于 BSD 管理员也应该适用。本书特别关注前言中提到的管理员类型：即那些熟悉使用类 Unix 系统，可能已经完成了一个基础的 Nagios Core 安装并且做了一些 PING 检查，现在希望学习如何更好地利用框架的强大功能，并深入理解其配置的管理员。

管理员应当熟悉为本书中讨论的扩展、插件和附加组件安装库依赖项。我们会尽量提到任何依赖项；然而，如何最佳安装这些依赖项将取决于系统及其软件包仓库。在几乎所有情况下，这应该仅仅是安装一些常见的库及其头文件，通常通过包管理系统进行安装。对于一些更复杂的情况，提供了 Debian 和 Ubuntu 的包名。

本书前五章中的较简单的食谱涉及到一些 Nagios Core 对象配置基础的回顾。对于刚刚安装了 Nagios Core 并完全没有相关经验的用户，建议在完成《Nagios 快速入门指南》后，从第一章《理解主机、服务和联系人》开始，因为后续章节假设读者已具备一定的知识。

# 约定

本书中，您将看到多种文本样式，用来区分不同类型的信息。以下是一些样式的示例，并附有它们的解释。

书中的代码词显示如下：“Nagios Core 只需要 PING 工具在其`check_ping`命令中需要的任何信息。”

代码块的设置方式如下：

```
define service {
    use                    generic-service
    host_name              sparta.naginet
    service_description    HTTP
    check_command          check_http
}
```

当我们希望引起您对代码块中特定部分的注意时，相关的行或项会以粗体显示：

```
define host {
    host_name              sparta.naginet
    alias                  sparta
    address                10.128.0.21
    max_check_attempts     3
    check_period           24x7
    check_command          check-host-alive
    contacts               nagiosadmin
 notification_interval  60
    notification_period    24x7
}
```

任何命令行输入或输出都会按如下格式书写：

```
# cd /usr/local/nagios/etc/objects
# vi sparta.naginet.cfg

```

**新术语** 和 **重要词汇** 会以粗体显示。您在屏幕上看到的词汇，例如菜单或对话框中的内容，会以这种方式出现在文本中：“如果服务器成功重启，网络界面应显示一个新的主机，在 **Hosts** 列表中，处于 **PENDING** 状态，等待进行检查该主机是否存活”。

# 读者反馈

我们始终欢迎读者的反馈。请告诉我们您对本书的看法——您喜欢什么或不喜欢什么。读者反馈对我们开发您真正能从中获益的书籍至关重要。

若要向我们发送一般反馈，只需发送电子邮件至 `<feedback@packtpub.com>`，并在邮件主题中提及书名。

如果您在某个领域拥有专业知识，并且有兴趣为书籍写作或贡献内容，请参阅我们的作者指南：[www.packtpub.com/authors](http://www.packtpub.com/authors)。

# 客户支持

现在，您已经成为一本 Packt 图书的骄傲拥有者，我们提供了一些帮助您最大化购买价值的内容。

## 下载示例代码

您可以从您在 [`www.packtpub.com`](http://www.packtpub.com) 购买的账户中下载所有 Packt 图书的示例代码文件。如果您是从其他地方购买的此书，您可以访问 [`www.packtpub.com/support`](http://www.packtpub.com/support)，并注册直接通过电子邮件接收文件。

## 勘误

尽管我们已尽一切努力确保内容的准确性，但错误难免发生。如果您在我们的书籍中发现任何错误——可能是文本或代码中的错误——我们非常感谢您将其报告给我们。通过这样做，您可以帮助其他读者避免困扰，并帮助我们改进后续版本的书籍。如果您发现任何勘误，请访问 [`www.packtpub.com/support`](http://www.packtpub.com/support) 报告，选择您的书籍，点击 **勘误** **提交** **表格** 链接，并填写勘误的详细信息。经核实后，您的勘误将被接受并上传到我们的网站，或添加到该书籍的现有勘误列表中。

## 盗版

互联网版权材料的盗版问题在所有媒体中都是一个持续存在的问题。在 Packt，我们非常重视保护我们的版权和许可。如果您在互联网上发现任何我们作品的非法复制品（无论何种形式），请立即向我们提供该地址或网站名称，以便我们采取措施。

请通过 `<copyright@packtpub.com>` 与我们联系，并提供涉嫌盗版资料的链接。

感谢您的帮助，保护我们的作者，以及帮助我们继续为您提供有价值的内容。

## 问题

如果你在书中的任何方面遇到问题，可以通过 `<questions@packtpub.com>` 联系我们，我们将尽力解决。
