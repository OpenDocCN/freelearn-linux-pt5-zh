# 第六章：更新引导加载程序和内核

前几章教你如何入门并充分利用硬件和软件。如前所述，软件包通过新版本自动更新；但是引导加载程序和内核不会自动更新。本章将介绍各种可用的引导加载程序以及不同的内核，并帮助你选择最合适的版本。

本章将涵盖以下主题：

+   各种引导加载程序和内核之间的区别

+   获取新的引导加载程序或内核

+   安装新的引导加载程序或内核

# 本章的先决条件

在本章中，你将需要前几章中使用的目标存储介质，如 SSD 或硬盘、USB 驱动器和 microSD 卡，用于引导。你还可以选择使用低容量的 microSD 卡代替。我在本书中使用的是一张 128 MB 的 microSD 卡，但即使是容量较小的卡也可以使用。只需要在 microSD 卡中放置引导加载程序、一些配置文件和一个内核，大约需要 4 MB 的空间，但实际上很难找到这样容量的 microSD 卡。

# 引导加载程序概述

引导加载程序是第一个加载的、实际上可以由用户修改的程序。社区和本书中使用的引导加载程序的名称是**u-boot**。它有两种不同的版本。首先是*lichee*变种，但它不再积极开发。之所以仍然存在，是因为它是目前唯一支持启动板载 NAND 闪存的引导加载程序。这个引导加载程序几乎总是预安装的，通常没有理由更换它。更有趣的是*sunxi*变种的 u-boot，它由社区积极开发，我们将在接下来的部分中详细介绍。

## U-boot-sunxi

由于已经有预编译版本的引导加载程序可用，本章内容并不涉及编译引导加载程序。每当对代码库进行新增时，都会编译一个新的引导加载程序。每个 u-boot 二进制文件都是为每块板子独特定制的，所有引导加载程序的完整列表可以在[`dl.linux-sunxi.org/nightly/u-boot-sunxi/u-boot-sunxi/u-boot-sunxi-latest/`](http://dl.linux-sunxi.org/nightly/u-boot-sunxi/u-boot-sunxi/u-boot-sunxi-latest/)找到。每块板子都有多个文件，具体如下：

+   一个以 `.build.txt` 结尾的构建日志文件

+   一个以 `.sha1` 结尾的生成文件的 `sha1` 哈希文件

+   归档文件中的生成文件清单，以 `.txt` 结尾

+   以 `.tar.xz` 结尾的编译二进制文件的存档

一旦手头的开发板正确的二进制文件进入下载阶段，使用 Linux 工具**wget**就变得非常简单。为了在 Cubieboard 上使用这个文件，可以使用以下命令：

```
packt@PacktPublishing:~$ wget http://dl.linux-sunxi.org/nightly/u-boot-sunxi/u-boot-sunxi/u-boot-sunxi-latest/u-boot-sunxi-cubieboard.tar.xz

```

这个文件需要被解压；`tar` 是一个常用的工具，`x` 参数表示提取，`J` 大写参数表示通过 `xz` 过滤，`v` 表示让 `tar` 显示详细信息，`f` 告诉 `tar` 下一个参数是文件名。

### 注意

压缩包中的目录名有一个复杂的结构附加在最后，很可能与本示例中的目录名不完全相同。

让我们更详细地看一下压缩包。首先，在 u-boot 标识符之后是架构名称，sunxi。接着是开发板的名称，在本例中是 Cubieboard。接下来的命令行是二进制文件编译时的时间戳。最后，末尾是特定 Git 提交的哈希值：

```
packt@PacktPublishing:~$ tar xJvf u-boot-sunxi-cubieboard.tar.xz
u-boot-sunxi-cubieboard-20140307T104232-b5bd4c9/
u-boot-sunxi-cubieboard-20140307T104232-b5bd4c9/u-boot-sunxi-with-spl.bin
u-boot-sunxi-cubieboard-20140307T104232-b5bd4c9/u-boot.bin
u-boot-sunxi-cubieboard-20140307T104232-b5bd4c9/sunxi-spl.bin

```

需要对这三个文件进行一些解释。当 Allwinner SoC 芯片第一次启动时，它无法访问主系统内存，也就是我们所说的 RAM。SoC 芯片内有一小部分内存，叫做 SRAM。然而，SRAM 太小，无法容纳整个 u-boot，所以 u-boot 被分成了两个部分：**次级程序加载器**（**SPL**）和实际的 u-boot。SPL 足以初始化内存并将较大的 u-boot 加载到内存中。这些文件都需要写入非常特定的区域，以便 SoC 理解从哪里启动。为了简化一点，提供了一个第三个文件，叫做 `u-boot-sunxi-with-spl.bin`。这个文件将两个部分结合并具有适当的间距，是目前唯一需要的文件。

## 安装引导加载程序

引导加载程序只能安装在一个位置，即使 SoC 可以从三个不同的位置启动。SPI-flash 在本书编写时尚不受支持。然而，一些早期实验表明这应该相对容易。虽然 u-boot 可以写入 NAND flash ROM，但社区开发的 u-boot 版本目前无法从 NAND flash 读取或写入。剩下的唯一选项是 microSD 卡，它一直被使用，且将继续被使用。

引导加载程序可以通过以下方式安装：

+   在 PC 或 Cubieboard 上使用 USB 转 microSD 适配器

+   使用 SD 卡读卡器在 PC 或开发板上

    ### 注意

    写引导加载程序时要非常小心。一个小小的错误就可能毁掉 SD 卡上的数据。例如，将引导加载程序写入 SD 卡的开始位置会破坏分区表。将引导加载程序写得稍微偏远一些可能会破坏 SD 卡上的文件系统。在这两种情况下，数据都会丢失，因为引导加载程序没有放在正确的位置，因此 SD 卡无法启动。

一个要求是 microSD 卡必须有一个分区表。microSD 卡没有分区表的情况是相当常见的。使用在第三章《安装操作系统》中获得的知识，应该在 microSD 卡上创建至少一个分区，且该分区至少有 4 MB 的空闲空间。该分区必须被格式化为 `fat`、`ext2`、`ext3` 或 `ext4`。

### 提示

如果没有从 microSD 卡挂载分区，例如启动分区，那么可以安全地移除当前使用的 microSD 卡并插入另一张卡。根据所使用的设备，确保将 `sdb` 替换为 `mmcblk0` 或分配给 SD 卡的任何设备节点。与比特无关。然而，复制某些文件可能会更棘手，并且在此期间可能需要将其存储在其他地方。

使用 `dd` 工具，将新的引导加载程序写入 `/dev/sdb`。请确保这真的是包含目标 SD 卡的设备节点。使用错误的设备节点可能会破坏重要数据，甚至导致系统无法启动。重要的参数是 `blocksize`（`bs`）和 `seek`，其中 `blocksize` 乘以 `seek` 表示 microSD 卡上的确切位置——在此情况下，正好是 8 KB。原因很简单；这是 SoC 芯片在 SD 卡上搜索引导加载程序的确切位置，以下命令对此进行了说明：

```
packt@PacktPublishing:~$ sudo dd if=u-boot-sunxi-a10-olinuxino-lime-20140307T10232-b5bd4c9/u-boot-sunxi-with-spl.bin of=/dev/sdb bs=1024 seek=8

```

## 完成引导加载程序

引导加载程序确实需要一些标准的配置文件，例如需要启动的内核。需要考虑的一些问题是传递给内核的参数和要加载到内存中的内核地址。有三个辅助文件可以安全地从以前的启动介质中复制。它们如下：

+   `boot.scr`：这是一个编译后的命令列表，u-boot 将执行这些命令

+   `uEnv.txt`：这是一个将传递给内核的变量列表

+   `boot.cmd`：这是用于生成 `boot.scr` 的源文件

    ### 提示

    `boot.cmd` 命令不是必须使用的，它只是一个非常有用的文件。要从 `boot.cmd` 创建 `boot.scr`，可以使用以下命令：

    ```
    mkimage -C none -A arm -T script -d boot.cmd boot.scr

    ```

复制了这三个文件后，Cubieboard 几乎可以启动，只剩下内核部分。

# 探索内核

对于基于 x86 的系统，通常只有一个内核；大多数情况下，这是由发行版提供的内核。这个内核通常是基于 [`www.kernel.org`](http://www.kernel.org) 的内核。这个内核通常被称为主线内核、原生内核或上游内核。对于基于 Allwinner 的 SoC 芯片，自 2012 年的 3.8 版本以来，社区开发的内核对其支持非常有限。也有一些较旧版本的内核，所有特性都是由 Allwinner 自己添加的。虽然这些更改的质量没有达到主线内核的标准，但目前来说，它是唯一的选择。尽管如此，它已接近功能完备，因此通常是迄今为止唯一可用的选择。所有这些不同的内核版本都可以在 Git 仓库中的各个分支上找到。就像 u-boot 一样，也有夜间预编译的镜像，可以在本书中使用。在继续下载这些预编译的归档文件之前，需要先解释一下不同版本的内容。

## SoC 的变种

Allwinner SoC 芯片有多个版本，例如 A10 系列。A10 系列在内部被称为 **sun4i**——sun 系列的第四代。同样，**sun5i** 是 A10S 和 A13 的内部名称。A31 和 A31S 被称为 **sun6i**，A20 被称为 **sun7i**，而新款 A23 被称为 **sun8i**。这些芯片的综合名称叫做 **sunxi**。对于几乎所有的内核版本和每种机器类型，都有一个 Git 分支或者一个夜间预编译的二进制版本。

### 各种内核的概述

对于初学者来说，加入 sunxi 社区后，他们常常对各种内核版本感到困惑，不确定该使用哪个内核。接下来的几个小节将简要介绍可用的不同版本。

#### 内核版本 2.6.36

内核版本 2.6.36 最初被 Allwinner 扣押，因为 Allwinner 拒绝发布 GPL 许可的代码。后来，Allwinner 基于的平板设备制造商解救了这个版本，Allwinner 官方发布了内核的源代码。随后，一个社区开始围绕这个源代码发布形成。这个版本已经过时很久了。

#### 内核版本 3.0 和 3.0 阶段

版本 3.0 是 sunxi 内核的第一个积极开发版本。3.0 内核的基础最初也是由第三方平板制造商释放的。社区从头开始重新启动，并投入了大量工作来释放这个内核。后来，全志（Allwinner）也发布了他们的 3.0 内核，但与社区构建的内核相比已经分化。例如，社区做的一件重要事情是统一各种机器类型。全志打算完全分开发布 sun4i 和 sun5i 内核，而社区将其合并为通用的 sunxi 内核和驱动程序。它从全志提供的内容中看到了许多其他改进，但并非所有补丁和修复都立即放入 3.0 系列中。补丁总是首先放入所谓的 3.0 阶段树中，在几周的测试后，这些补丁被合并回 3.0 树中。3.0 树在技术上也已经过时，但由于仍然被许多平板电脑使用，因此仍然活跃使用。

#### 内核版本 3.3

全志在社区已经开始并将所有内容移植到主流 3.4 内核之后发布了他们内核的新版本。社区从不使用 3.3 内核，因为全志未采用其中的任何错误修复和改进。有时它也被称为荔枝内核。

#### 内核版本 3.4 和 3.4 阶段

当 3.4 内核发布时，它被标记为**长期支持**（**LTS**）发布，意味着它将在延长的时间内接收支持和安全补丁。sunxi 硬件的驱动程序从 3.0 转移到 3.4，以在一个得到良好支持的内核版本上支持全志硬件。与 3.0 一样，3.4 的阶段变体持有所有新的补丁，并合并到 3.4 中，因为它被认为是稳定的。3.4 系列目前正在积极开发，并推荐日常使用。

#### 内核版本 experimental-3.14

版本 3.14 的高度实验性分支目前不可用。该想法是取 3.14 内核，这是一个 LTS 发布，然后将 3.4 sunxi 驱动程序应用到其中。与 3.4 的主要区别在于，3.14 是内核的一个发布版本，并且对 sunxi SoCs 有一些实际支持。只要这些内核被标记为实验性，除了用于实验外，不应该使用它们。

#### 内核的开发分支

针对主线内核编写的补丁会被发送到各种邮件列表进行审查。devel 分支（代表开发）尝试捕获所有这些正在审查的补丁，并将它们合并到主线跟随树中。换句话说，这个树目前支持大多数硬件，但随着审查过程的进行，它很可能会发生变化。这个内核应该仅在进行驱动开发、审查或想要帮助测试新事物时使用。然而，随着情况逐渐稳定，这个分支将来可能会被移除。

#### 下一分支的内核

与 devel 分支非常相似，它跟踪主线内核并保存已接受的补丁。它可以被视为 devel 内核的稳定变种。这个内核应该仅在需要下一个即将发布的内核版本时使用。

## 选择内核

由于有这么多可用的内核，目前唯一值得关注的内核是 3.4 内核。虽然当 3.14 内核脱离实验状态并开始替代 3.4 时，这种情况可能会发生变化，但目前它们并不是一个选择。确定了这个选择后，需要根据所使用的 Cubieboard 类型来选择机器类型。前面讨论过的变种部分将解释选择哪个机器类型。

## 安装内核

使用 `wget`，一个基于 A20 的内核将被下载并在以下示例中解压：

```
packt@PacktPublishing:~$ wget http://dl.linux-sunxi.org/nightly/linux-sunxi/linux-sunxi-3.4-sun7i/linux-sunxi-3.4-sun7i-latest.tar.xz
linux-sunxi-3.4-sun7i-20140215T115414-8ea347b/lib/
linux-sunxi-3.4-sun7i-20140215T115414-8ea347b/boot/

```

在这里，还将创建一个新的目录，该目录包含一个以 `datestamped` 和 `githash` 命名的目录。在这个目录下，将有两个子目录。boot 目录包含实际的内核文件，一个名为 **uImage** 的文件。该文件将被放置在 microSD 卡的第一个分区上。

## 安装内核模块

在内核中，驱动程序可以被编译到内核中并始终加载，或者它们可以从内核中分离出来，根据需要加载。这些分离的驱动程序称为模块，在大多数发行版中位于 `/lib/modules/`。复制这个目录即复制了新内核所需的所有文件。

### 提示

以下命令假设在 Cubieboard 上本地执行此操作。如果使用其他系统来执行复制，目标路径会有所不同：

```
packt@PacktPublishing:~$ sudo cp -ar linux-sunxi-3.4-sun7i-20140215T115414-8ea347b/lib /

```

内核和模块就位后，系统可以安全地重启，使用新内核及其模块。

# 总结

本章介绍了各种引导加载程序和内核，并简要解释了它们之间的区别。然后展示了如何将预编译的内核安装到 microSD 卡上，并将其用作引导设备。

下一章将讲解如何使用 sunxi-bsp 或 sunxi 板从头开始编译引导加载程序或内核的步骤。
