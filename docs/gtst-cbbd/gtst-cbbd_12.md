# 附录 D. 解决常见问题

在进行新尝试时，很多事情可能会出错。本附录简要涵盖了其中一些常见的陷阱。尽管预见所有可能出错的情况几乎不可能，但本附录的目的是提供最常见问题的概览。

一些常见的问题，往往比人们想象的更容易发生，比如输入命令时的阅读和输入。打字错误很容易发生，或者有些东西被忽视并读错。这些情况是不可避免的，都是在处理令人兴奋和新奇的事物时的一部分。所以，第一个建议是始终检查你的输入。尽管本书中所有页面都经过多人的审阅，但仍然有可能出现错误，如果即使完全按照书中的步骤操作，问题依然存在，可以查阅勘误表。

# 稳定性问题

很多时候，用户会在这些设备的众多社区中抱怨遇到奇怪的崩溃、系统不稳定或随机重启的情况。虽然设备本身确实有可能出现损坏，但往往是电源不稳定或者功率不足导致的。

测试电源的强度或稳定性没有额外设备是非常困难的。如果电源无法提供足够的电流，通常会导致电压下降。这个可以用标准万用表来测量。

如果电压低于 4.8 伏特，可能会出问题。一个非常嘈杂的电源更难以测试，通常需要示波器。最好是选择一个知名且优质的电源。例如，手机充电器有不同的功率。有些便宜的手机电源最大输出电流只有 500 毫安，而当设备处于高负载状态时，这个电流是不足够的。显然，配备高端智能手机的充电器能提供高达 2000 毫安的电流，但即便如此，与硬盘或固态硬盘一起使用时，电力需求仍可能过高。因此，建议尽可能断开其他设备。不要连接 USB 设备和 SATA 存储，因为它们的电源来自主板。不要连接可能直接从主板获得电力的其他组件。理想情况下，应该只连接电源和串口，并使用万用表或其他电源测量设备，检查电压是否不会降得过低。

如果在进行以上检查后，电路板仍然不稳定，而其他使用相同电路板、相同引导加载程序，并且理想情况下使用相同根文件系统的用户没有问题，那么电路板可能是有缺陷的。最好还是联系购买商请求更换。但请务必先确认其他所有问题，因为更换电路板对所有相关方来说都不是什么愉快的事情。

# 从 SD 卡启动时的启动失败

没有什么比花费数小时编译和准备 SD 卡以启动板子，但最终却无法启动更令人沮丧了。在此阶段，拥有串行控制台以查看调试输出至关重要，但有时由于 SD 卡或二进制文件错误，根本不会生成任何输出。进行引导加载程序实验时，最重要的一点是始终备有一个已知的工作副本。这是为了确保对 u-boot 的修改不是问题的根源。

来自 linux-sunxi 的 nightlies 是一个替代方案，因为这些应该始终能够工作。查看[`dl.linux-sunxi.org/nightly/u-boot-sunxi/u-boot-sunxi/u-boot-sunxi-latest/`](http://dl.linux-sunxi.org/nightly/u-boot-sunxi/u-boot-sunxi/u-boot-sunxi-latest/)以获取可用引导加载程序的列表。

有时，microSD 卡可能根本不兼容，甚至可能损坏。应该使用不同的 microSD 卡来确保问题不在卡本身上。如果卡上的前几个字节损坏到无法修复的程度并不罕见。对于简单的存储介质使用来说，这通常不是问题。但由于引导加载程序是从 SD 卡的开始处进行写入和读取的，因此这可能导致系统无法启动。

现在，使用 nightlies 或自编译的引导加载程序时，用户往往容易选择错误的文件。对此不大惊讶，因为互联网上有许多文件和各种指南，有时它们会过时并不再准确。一个常见的例子是，许多较旧的指南建议使用各种`seek`偏移量写入`u-boot.bin`或`sunxi-spl.bin`。使用正确的文件和参数时，这仍然有效，而使用错误的参数或设置则会导致失败。推荐的方式，如第四章《手动安装替代操作系统》中所述，是使用`u-boot-sunxi-with-spl.bin`，使用`blocksize (bs)`为`1024`和`seek`为`8`。例如，将此应用于`sdb`时，应使用以下命令：

```
packt@packt:~# dd if=u-boot-sunxi-with-spl.bin of=/dev/sdb bs=1024 seek=8

```

这是因为前面提到的文件都被合并成一个大文件，因此出错的机会较少。最后，在写入引导加载程序之后，目的是格式化第一个分区以存储内核。分区号被省略，格式化的不是`/dev/sdb1`，而是`/dev/sdb`。这样做是完全合法的；在存储介质上有分区是可选的，尽管通常是有用的。然而，格式化整个磁盘，而不是仅格式化分区，会导致一个副作用，即先前写入的引导加载程序被覆盖并丢失。当板子启动时，引导加载程序已不存在，因此不会生成任何输出。

# 无法通过连接的显示器输出显示

很多时候，当通过 HDMI 或 VGA 连接显示器时，没有显示输出。可以理解，这非常令人沮丧。更糟的是，可能在预装的 Android 系统下工作正常，但现在从 SD 卡启动 Linux 时，什么都没有发生。导致显示器没有图像的原因当然有很多，比如电缆可能没有正确连接，显示器可能设置为错误的输入等。尽管这些问题看起来非常明显且常见，但它们确实会发生，而且有一些情况并不容易检查。

Allwinner 的 SoC 在显示输出方面实际上并不智能。它需要被告知连接了什么设备，以及使用什么作为输出。为此，显示器和电视（实际上只是一些高级显示器）在电缆中有一个称为**显示数据通道**（**DDC**）的通信通道。DDC 的目的是让显示器告诉任何询问者它的功能和分辨率。而这就是问题所在。

对于 VGA，曾经有一个共识，插头有两种颜色：如果端口不关心 DDC 并忽略它，则为黑色；如果端口读取 DDC 信息并能够作出相应响应，则为蓝色。不幸的是，许多开发板的创作者只是使用蓝色连接器，认为那就是标准的 VGA 连接器，但却没有实现 DDC。没有 DDC，板子根本不知道连接了什么设备，也不知道如何向其发送信号。而且，由于对蓝色和黑色 VGA 插头的误用，现在已经没有简单的规则可以遵循，比如说如果你的连接器是黑色的，你必须手动设置 VGA 端口。

对于 HDMI，问题非常相似。Allwinner 的 HDMI 显示控制器在大多数情况下是为电视而设计的。因此，在连接 HDMI 显示器或使用 DVI 到 HDMI 适配器时，会有一些小问题。例如，Android 在连接到 DVI 显示器时，图像可能会呈现紫色，这个问题是由驱动程序与显示控制器的设计结合引起的；通常运行 linux-sunxi 内核可以解决这个问题。

第一个可以检查和更改的文件是`uEnv.txt`，它位于引导加载器分区中，可能是在使用 USB 适配器时的`/dev/sdb1`。在这里，应该有一个类似于`disp.screen0_output_mode=EDID:1280x720p60`这样的设置，用于底部的`extraargs`参数。

这意味着，对于输出，首先尝试通过 EDID 探测显示器，EDID 是 DDC 的扩展形式，如果失败，则回退到以 60Hz 刷新率运行的 1280×720 逐行扫描分辨率。一些显示器可能无法正确宣布其 EDID 信息，因此首先要尝试的是从`output_mode`中移除 EDID 位，从而强制输出为`1280x720p60`。此外，可能在 EDID 失败后，提供的固定分辨率是显示器无法接受的。有关有效分辨率和设置，请检查下一个章节中表格的第二列。需要注意的是，当我们使用 VGA 显示器时，必须移除 EDID，因为在这种情况下，驱动程序将忽略整个`output_mode`。此外，需要将期望的视频输出类型附加到`extraargs`中，VGA 为`disp.screen0_output_type=4`，HDMI 为`disp.screen0_output_type=3`。

通过`uEnv.txt`文件覆盖内核参数可能不足以使系统正常工作，可能会导致某些功能无法运行。相同的设置也应该通过 FEX 文件提供。理论上，驱动程序应该检查内核命令行和 FEX 文件，但一个可能会覆盖另一个，因此，在遇到问题时，应考虑这两种可能性。

要强制设置视频输出模式，需要修改 FEX 文件。控制显示控制器的部分在 FEX 文件中是`[disp_init]`部分。有关 linux-sunxi wiki 上的所有显示控制器参数，[`linux-sunxi.org/Fex_Guide`](http://linux-sunxi.org/Fex_Guide)，需要查看一些内容。首次设置时，`disp_mode`最好设置为`0`，表示`screen0`上的一个帧缓冲区。根据显示器的连接方式，`screen0_output_type`应设置为`3`（HDMI 显示）或`4`（VGA 显示）。最好通过将`screen1_output_type`设置为`0`来禁用`screen1_output_type`对象。对于`screen0_output_mode`，应使用下表，任何应用于`screen1_output_mode`的设置将被忽略：

| `output_mode` | 用于电视/HDMI 输出 | 用于 VGA 输出 |
| --- | --- | --- |
| 0 | 480i | 1680 * 1050 |
| 1 | 576i | 1440 * 900 |
| 2 | 480p | 1360 * 768 |
| 3 | 576p | 1280 * 1024 |
| 4 | 720p50 | 1024 * 768 |
| 5 | 720p60 | 800 * 600 |
| 6 | 1080i50 | 640 * 480 |
| 7 | 1080i60 |   |
| 8 | 1080p24 |   |
| 9 | 1080p50 |   |
| 10 | 1080p60 | 1920 * 1080 |
| 11 | pal | 1280 * 720 |
| 14 | ntsc |   |

其他设置对于显示输出应该没有太大影响。现在，显示器应该能够在启动时输出数据，例如 Fedora 安装镜像，这在第三章中有使用，*安装操作系统*。

# 概述

本附录介绍了三种最常见的问题，这些问题通常出现在开始使用各种开发板时。本附录所涵盖的内容并不包括所有可能的情况，但应该能为你提供一种解决这些早期问题的有效策略。
