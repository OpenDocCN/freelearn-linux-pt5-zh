# 前言

欢迎阅读 *即时 Varnish Cache 操作指南*。

**Varnish Cache** 是一个 HTTP 加速器，位于你的客户和应用服务器之间，作为网站的前端缓存解决方案。Varnish Cache 不是一个完整的解决方案，它不会单独提供应用内容；而是将客户请求代理到你的 Web 服务器，并存储响应以供以后使用，从而避免不必要（重复的）工作负载。

将你的网站放在 Varnish Cache 后面既快速又简单。在本书中，你将学习如何以最小的努力充分利用你的基础设施。

本书是关于可扩展性问题和缓存的积累资料的结果，经过一年时间的研究，最终实现了在拉丁美洲一大型电商平台上部署 Varnish Cache。

# 本书内容

*安装 Varnish Cache（必须了解）*，介绍了如何使用官方仓库安装 Varnish Cache，并确保在开始配置 Varnish 守护进程之前一切就绪。

*Varnish Cache 守护进程选项（必须了解）*，解释了所有的守护进程选项，这些选项使你的 Varnish Cache 服务器按照预期运行，并调整内存和 CPU 使用情况。

*连接到后端服务器（应了解）*，定义了 Varnish 将从哪些后端服务器获取数据，并创建机制确保 Varnish 不会将请求代理到任何离线的后端。

*负载均衡请求（应了解）*，探索了通过应用服务器负载均衡请求的所有可能性，并为应用系统的关键部分创建一个专用服务器池。

*Varnish 配置语言（应了解）*，帮助你开始编写 VCL 代码来管理所有缓存策略，并操作请求和响应。

*处理 HTTP 请求 vcl_recv（应了解）*，解释了如何根据客户端请求选择后端服务器，阻止限制内容，并避免在不该执行缓存查找时进行查找。

*处理 HTTP 请求 vcl_hash（应了解）*，解释了 Varnish 如何生成用于存储对象的哈希，并如何自定义它以节省内存空间。

*处理 HTTP 请求 vcl_pipe 和 vcl_pass（应了解）*，介绍了如何处理那些不应该被缓存的请求，使数据直接流向客户端。

*处理 HTTP 响应 vcl_fetch（应了解）*，提供了重写原始响应的部分内容以满足需求并拼接 ESI 部分的机会。

*处理 HTTP 响应 vcl_deliver（应了解）*，解释了如何清理多余的头部信息以进行服务器混淆，并为响应添加调试头信息。

*处理 HTTP 响应 vcl_error（应了解）*，介绍了如何在计划的或意外的停机期间提供维护页面或重定向用户。

*缓存静态内容（应了解）*，解释了如何识别你网站中可以利用缓存服务器的部分内容，并如何缓存它们。

*Cookies、会话和授权（成为专家）*，讲解了如何识别唯一用户以及哪些网站部分永远不应缓存。

*HTTP 缓存头（应该了解）*，披露了哪些头部对缓存服务器至关重要，以及如何处理缺少这些头部的情况。

*使缓存内容失效（应该了解）*，讲解了如何使不再需要提供的内容失效以及如何避免此类情况。

*压缩响应（成为专家）*，讲解了如何通过压缩数据来节省带宽并提高整体速度。

*监控命中率（成为专家）*，披露了缓存性能的表现以及 Varnish 如何连接到你的后端服务器。

# 你需要的本书内容

为了有效地使用本书，你需要以下软件和操作系统：

+   Linux CentOS

+   Varnish 缓存

+   Oracle VirtualBox

# 本书适合谁

本书面向具有 HTTP 协议基础知识的系统管理员和网页开发人员，帮助他们在不投入大量昂贵基础设施的情况下扩展网站。

# 规范

在本书中，你将看到多种文本风格，区分不同类型的信息。以下是这些风格的示例及其含义解释。

文本中的代码词汇如下所示：“我们将在 Linux CentOS 系统上使用 `varnish-cache.org` 仓库安装 Varnish 缓存。”

一段代码块如下所示：

```
set obj.http.Content-Type = "text/html; charset=utf-8";
set obj.http.Retry-After = "5";
synthetic {"
```

任何命令行输入或输出均以如下方式书写：

```
# sudo yum install varnish
```

**新术语**和**重要词汇**以粗体显示。你在屏幕上看到的、菜单或对话框中出现的词汇，通常以如下方式出现在文本中：“如果发生意外故障，你可以将客户重定向到一个**哎呀！抱歉**的友好页面。”

### 注意

警告或重要说明会以类似这样的小框展示。

### 提示

提示和技巧以这样的方式展示。

# 读者反馈

我们始终欢迎读者反馈。让我们知道你对本书的看法——喜欢的地方或不喜欢的地方。读者反馈对我们开发出真正对你有帮助的书籍至关重要。

如需向我们提供一般反馈，只需发送电子邮件至 `<feedback@packtpub.com>`，并在邮件主题中提及书名。

如果你在某个领域有专业知识并且有兴趣写书或为书籍做贡献，请参见我们的作者指南，网址为 [www.packtpub.com/authors](http://www.packtpub.com/authors)。

# 客户支持

现在，既然你已经是一本 Packt 书籍的骄傲拥有者，我们有许多资源帮助你充分利用你的购买。

## 勘误表

尽管我们已尽最大努力确保内容的准确性，但错误仍然会发生。如果您在我们的书籍中发现错误——可能是文本或代码上的错误——我们将非常感激您向我们报告。通过这样做，您可以避免其他读者的困扰，并帮助我们改进后续版本的书籍。如果您发现任何勘误，请访问 [`www.packtpub.com/support`](http://www.packtpub.com/support) 报告，选择您的书籍，点击**勘误提交表格**链接，并填写您的勘误详情。一旦勘误被确认，您的提交将被接受，勘误将会上传到我们的网站，或加入到该书籍的现有勘误列表中，出现在该书籍的勘误部分。任何现有的勘误都可以通过访问 [`www.packtpub.com/support`](http://www.packtpub.com/support) 查看。

## 盗版

网络上的版权盗版问题在各类媒体中持续存在。我们在 Packt 非常重视版权和许可的保护。如果您在互联网上发现任何非法复制的我们的作品，无论形式如何，请立即提供其网址或网站名称，以便我们采取相应措施。

如有盗版内容，请通过`<copyright@packtpub.com>`与我们联系，提供涉嫌盗版的链接。

我们感谢您帮助保护我们的作者，以及我们提供有价值内容的能力。

## 问题

如果您在书中的任何部分遇到问题，可以通过`<questions@packtpub.com>`与我们联系，我们将尽力解决问题。
