- en: Chapter 8. Cloning and Snapshots
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In a test environment, it is often necessary to deploy virtual machines rapidly
    and to revert to a previous state in an easy way. VMware Workstation provides
    all the tools that are required for this purpose. In this chapter, you'll learn
    to work with cloning and snapshot tools that enable you to perform these tasks.
  prefs: []
  type: TYPE_NORMAL
- en: Understanding when to apply which tools
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A **snapshot** is a photo of a state of a virtual machine. As a virtual machine
    often requires a lot of work before a desired state of the machine is reached,
    it is a good idea to take a picture of that exact state. If something goes wrong
    at a later stage, having a snapshot makes it possible to easily revert to the
    previous state of the virtual machine. So the base concept of working with snapshots
    is to make it easier to revert to a previous state.
  prefs: []
  type: TYPE_NORMAL
- en: A **clone** is a copy of a virtual machine. Using clones is convenient if several
    virtual machines are needed, with more or less the same configuration on each
    virtual machine. By cloning a virtual machine, you'll make a copy of the actual
    state of a machine. After making the clone, you'll just have to modify the properties
    of the virtual machine that need to be unique on that machine.
  prefs: []
  type: TYPE_NORMAL
- en: In some ways, clones and snapshots are closely related. This is because you
    can create a clone of a snapshot of a virtual machine, but you can also clone
    the current state of a virtual machine, which in fact creates a snapshot of the
    virtual machine. To understand this, you need to understand the difference between
    a linked clone and a full clone.
  prefs: []
  type: TYPE_NORMAL
- en: In a **linked clone**, only modifications are stored. This means that if something
    happens to the original state of the virtual machine (for example, the VM files
    get corrupted), the linked clone gets corrupted as well. It is, however, an approach
    that is very efficient with regard to available disk space. As only modifications
    are stored in a linked clone, the disk space requirement is minimal. Creating
    a linked clone is also a very fast process.
  prefs: []
  type: TYPE_NORMAL
- en: A **full clone** is like a complete copy of a virtual machine. Creating a full
    clone is a much longer process as the entire virtual machine disk has to be copied
    over. It requires more disk space as well, but the benefit is that a full clone
    creates an independent virtual machine. Therefore, you're better off with full
    clones if you need a maximum amount of flexibility. In the following sections,
    you'll learn how to work with snapshots and clones.
  prefs: []
  type: TYPE_NORMAL
- en: Working with snapshots
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this section, you'll learn how to create snapshots of virtual machines. You'll
    also learn how to use the Snapshot Manager to manage a setup where different snapshots
    are used.
  prefs: []
  type: TYPE_NORMAL
- en: Creating snapshots
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: To create a snapshot, you don't have to do anything with the virtual machine.
    You can create a snapshot irrespective of the actual state of the virtual machine,
    so it doesn't matter if it is currently active or not. If the machine is powered
    on, the current state of the virtual machine memory is included in the snapshot
    as well. This is a useful feature as it allows you to return to the exact state
    the machine was in while taking the snapshot.
  prefs: []
  type: TYPE_NORMAL
- en: To create a snapshot of a virtual machine, select the virtual machine first.
    Then from the VM menu, navigate to **Snapshot** | **Take snapshot**. Here you
    are presented with a small dialog box where you can enter a short description
    of the snapshot. You should always enter some description as it may be clear now
    what the snapshot is being used for, but you probably won't know it anymore if
    you have a look at the virtual machine a few months later. Also, having a clear
    description for a snapshot makes it easier to identify the right snapshot in the
    Snapshot Manager.
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating snapshots](img/9182EN_08_01.jpg)'
  prefs: []
  type: TYPE_IMG
- en: To make identifying the snapshot easier at a later stage, enter a clear description
    of what it is being used for
  prefs: []
  type: TYPE_NORMAL
- en: Once the snapshot process has started, it will take a while to complete. You
    will see a progress bar in the lower-left part of the virtual machine window if
    it has been activated. In theory, you can just continue working in the virtual
    machine; in practice, you'll notice that it is slow and sometimes even very unresponsive.
    It's better to wait a while and give the snapshot process a few minutes to complete.
  prefs: []
  type: TYPE_NORMAL
- en: The actual files of the snapshots will be created in the directory where the
    VMDK files of the virtual machine are stored. For each VMDK file, you'll find
    a snapshot file as well. You'll notice that the snapshot file is smaller as it
    only contains the modifications that were made since the last snapshot was taken;
    or if this is the first snapshot you have taken, it will contain the differences
    from the original virtual machine.
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating snapshots](img/9182EN_08_02.jpg)'
  prefs: []
  type: TYPE_IMG
- en: For each VMDK file, a corresponding snapshot file is created
  prefs: []
  type: TYPE_NORMAL
- en: Reverting a snapshot
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The goal of creating a snapshot is that at any moment you can easily revert
    to the previous state of a virtual machine. The easiest way to do this is using
    the **Revert to snapshot state** option that you can find at **VM** | **Snapshot**.
    This option allows you to easily get back to the last snapshot that you have created
    on a virtual machine. Reverting to a previous snapshot resets the virtual machine
    to its previous state, and you'll know for sure that all changes that have been
    made since have been lost. Also, while reverting to the state prior to the snapshot,
    you will be unable to use the virtual machine and hence lose connection. A much
    more sophisticated method to revert to a previous state is using the Snapshot
    Manager.
  prefs: []
  type: TYPE_NORMAL
- en: Using autoprotect snapshots
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: A special kind of snapshot is the **autoprotect snapshot**. This is a snapshot
    that is created automatically every day. If you want to use autoprotect snapshots,
    you'll have to enable them for each virtual machine that you want to use them
    on. This doesn't happen automatically because you need disk space to store the
    autoprotect snapshots. Using autoprotect costs a minimum of 3 GB for every virtual
    machine.
  prefs: []
  type: TYPE_NORMAL
- en: 'To enable autoprotect, apply the following procedure:'
  prefs: []
  type: TYPE_NORMAL
- en: Select the virtual machine that you want to use autoprotect for.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: From the VM menu, open the **Settings** item and click on the **Options** tab.
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: On the **Options** tab, select **Enable AutoProtect** and specify how you want
    to use it.![Using autoprotect snapshots](img/9182EN_08_03.jpg)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: With autoprotect, you'll enable a sort of automatic backup schedule
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: 'When using autoprotect snapshots, it is important to realize that autoprotect
    doesn''t just create one snapshot everyday and keep that around for a couple of
    days. By default, autoprotect creates a snapshot everyday, and it keeps three
    different autoprotect snapshots: one that allows you to go back one day, another
    one that allows you to go back one week, and a third that allows you to go back
    one month. It is possible to have autoprotect create more than just three backups,
    but you''ll need to make sure that you have the required amount of disk space
    to store all these snapshots.'
  prefs: []
  type: TYPE_NORMAL
- en: Snapshots and powering off
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Using autoprotect snapshots helps you create an automated backup solution for
    your virtual machine. Another way of creating snapshots automatically is using
    the option to create a snapshot when a virtual machine is powered down. On the
    **Options** tab of the **Virtual Machine Settings** window, you can find the **Snapshot**
    option. This option allows you to use the following options:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Just power off**: This option will do nothing and just power off the virtual
    machine.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Take a new snapshot**: Use this option if you automatically want to take
    a snapshot of a virtual machine every time you power it off.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Revert to snapshot**: Use this option if you never want to keep the modifications
    that have been applied to a virtual machine. Using this option is very useful
    in educational environments where you want a virtual machine to be started in
    a clean state at the start of each class.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Ask me**: This option asks the user if a snapshot must be taken or if a reversion
    to the last state of the virtual machine has to be done.![Snapshots and powering
    off](img/9182EN_08_04.jpg)'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: When powering off the virtual machine, you can automatically either revert to
    a previous snapshot or take a new snapshot
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
- en: Working with the Snapshot Manager
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The Snapshot Manager allows you to work with snapshots in the most flexible
    way. You can use it to revert to any virtual machine state, start from there,
    and build a completely different configuration so that you can create two development
    branches based on a specific snapshot state and decide which solution fits you
    best.
  prefs: []
  type: TYPE_NORMAL
- en: You can find the Snapshot Manager by opening the virtual machine you want to
    manage and navigating to **VM** | **Snapshot** | **Snapshot Manager**. You'll
    now see the Snapshot Manager with all the snapshots that have been created for
    this virtual machine.
  prefs: []
  type: TYPE_NORMAL
- en: '![Working with the Snapshot Manager](img/9182EN_08_05.jpg)'
  prefs: []
  type: TYPE_IMG
- en: The Snapshot Manager allows you to revert to any state of a virtual machine
  prefs: []
  type: TYPE_NORMAL
- en: Working with snapshots from the Snapshot Manager is not hard to do at all. You'll
    just select the snapshot that you want to start from and restore it (irrespective
    of whether there are snapshots that have already been created based on the selected
    snapshot). Once restored, you can continue working on the virtual machine from
    the selected snapshot state.
  prefs: []
  type: TYPE_NORMAL
- en: By default, in the Snapshot Manager you don't see autoprotect snapshots. Even
    if the Snapshot Manager shows an option that displays autoprotect snapshots as
    well, it is probably not a good idea to do that. You'll typically use the snapshots
    in Snapshot Manager to walk back a clearly defined path in the snapshots on your
    system. In autoprotect, there isn't really a plan, and even more importantly,
    the snapshots are removed automatically. Therefore, you should make sure to never
    create a snapshot that is based on an autoprotect snapshot.
  prefs: []
  type: TYPE_NORMAL
- en: Creating clones
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: A snapshot is a virtual machine that is in a specific state. When working with
    snapshots, there will still be one virtual machine that can easily be restored
    to a specific state. The major difference between a clone and a snapshot is that
    a clone is a new virtual machine that is independent of the original virtual machine.
    Even if there is some relation between a snapshot and a clone (for instance, you
    can create a clone based on a snapshot), a clone basically is a new virtual machine.
    This means that once you have created a clone of a virtual machine, you can even
    start creating new snapshots of that virtual machine.
  prefs: []
  type: TYPE_NORMAL
- en: When creating clones, you really need to think well about what you want to use
    them for. If you just want to use them for your own convenience, a linked clone
    is the best solution. It can be created very fast, and it takes the least possible
    amount of disk space while it still offers full functionality. The major difference
    though is that you'll never be able to copy it as an independent virtual machine
    to another computer. If you need to do that, you'll need a full clone.
  prefs: []
  type: TYPE_NORMAL
- en: There are different ways to create clones. No matter which method you use, you
    will have to make sure that the virtual machine is shut down before you can make
    the clone. This requirement exists because the virtual machine files cannot be
    modified while the cloning is in process. The most important reason for this is
    that VMware Workstation is used on a Linux host or Windows platform where filesystems
    are used that do not allow virtual machine files to be modified by different processes
    at the same time. You'll need a VMFS filesystem in a VMware ESXi environment if
    you want to be able to clone a virtual machine without shutting it down first.
  prefs: []
  type: TYPE_NORMAL
- en: The most direct way of creating a clone is by using the **Manage** option in
    the VM menu. From this menu, select the **Clone** option to start the Clone wizard.
    The first step of the clone wizard asks where you want to create the clone from.
    This can either be from the actual state of the virtual machine or from a snapshot,
    if it has been created. If no fit snapshot exists, the wizard will show an error,
    indicating that it's not possible to create a clone based on a snapshot for the
    selected virtual machine.
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating clones](img/9182EN_08_06.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Selecting on the basis of what you want to clone
  prefs: []
  type: TYPE_NORMAL
- en: After selecting what you want to create the clone on, you'll need to select
    between either a linked clone or a full clone. You have to realize that a full
    clone is a complete copy of a virtual machine, so you'll need the same amount
    of disk space that is used by the virtual machine as available disk space on the
    host computer. So if the virtual machine uses 60 gigabytes of disk space, you'll
    need at least 60 gigabytes of disk space on the host as well!
  prefs: []
  type: TYPE_NORMAL
- en: After verifying that you have the required amount of free disk space, you can
    start the cloning process. In the last step of the wizard, specify the name that
    you want to assign to the clone as well as the location on the host operating
    system where the clone has to be stored. Once created, the clone will show in
    the VMware console as a new virtual machine, and that is also how it is to be
    considered.
  prefs: []
  type: TYPE_NORMAL
- en: '![Creating clones](img/9182EN_08_07.jpg)'
  prefs: []
  type: TYPE_IMG
- en: A cloned virtual machine appears as a completely new virtual machine in the
    VMware Workstation library
  prefs: []
  type: TYPE_NORMAL
- en: Another way of creating clones is using the Snapshot Manager. The advantage
    is that using Snapshot Manager, you can easily select a snapshot that you want
    to create a clone of. Just select the snapshot state you want to use and click
    on the **Clone** button.
  prefs: []
  type: TYPE_NORMAL
- en: Preparing virtual machines before cloning
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'If you''re creating clones of Linux virtual machines, the procedure is rather
    easy. You just have to start the cloning process; once the process has been completed,
    there are a few items that need to be changed. You can just change these one by
    one. Typically, on a Linux virtual machine you need to be sure to change the following
    to create a new identity for the cloned virtual machine:'
  prefs: []
  type: TYPE_NORMAL
- en: The hostname
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The IP address
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: The entry for this host in `/etc/hosts`
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: After changing these, you will need to restart the virtual machine to make sure
    it picks up on the new identity.
  prefs: []
  type: TYPE_NORMAL
- en: On Windows, changing the identity of a virtual machine is more complicated.
    The main reason for this is that the Windows license is bound to the identity
    of a Windows virtual machine. To make sure that you'll be compliant with the Windows
    license that you've purchased, you should generate a new identity and enter a
    new license code for it. The most versatile way to do this is to use **Sysprep**;
    it resets Windows to the state it was in when it was started for the first time.
    In the following section, you can read how to use Sysprep on Windows to create
    a template of your Windows virtual machine.
  prefs: []
  type: TYPE_NORMAL
- en: Using Sysprep on Windows to create a template
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: On Windows, the procedure is much more complicated as the identity of a Windows
    machine is not just in a few configuration files; it is all over the Windows virtual
    machine. That is why Microsoft has created Sysprep, a tool that allows you to
    create a base image of a virtual machine. You'll typically find this tool in any
    Windows installation under the location, `c:\Windows\System32\sysprep`.
  prefs: []
  type: TYPE_NORMAL
- en: You generally don't want to run Sysprep on a virtual machine that already has
    lots of things installed. The aim of Sysprep is to create a template of a new
    virtual machine; this makes it easier to deploy new virtual machines based on
    the Sysprep template.
  prefs: []
  type: TYPE_NORMAL
- en: After installing the Windows virtual machine that has a basic configuration,
    start the Sysprep tool and make sure you select the **Enter System Out of Box
    Experience** option. This puts your Windows installation in a mode where all personalized
    information is removed, and Windows behaves as if it has been started for the
    first time. Also make sure to select **Shutdown** as the shutdown mode (you want
    the virtual machine to be shut down after the completion of the Sysprep procedure)
    and select the **Generalize** option.
  prefs: []
  type: TYPE_NORMAL
- en: Tip
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: Make sure to select **Shutdown** as the default shutdown mode. By default, **Restart**
    is selected. Using this mode, you can restart the virtual machine, and once it
    restarts, the reconfiguration will be started automatically. This is not what
    you need, because the purpose of sysprepping a virtual machine is to remove all
    the specific configuration from it.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Sysprep on Windows to create a template](img/9182EN_08_08.jpg)'
  prefs: []
  type: TYPE_IMG
- en: Before cloning Windows, you should run the Sysprep tool
  prefs: []
  type: TYPE_NORMAL
- en: Once the virtual machine has been sysprepped, open the **Settings** window for
    the virtual machine from the VM menu, click on the **Options** tab, and on that
    tab, click on **Advanced**. From here, navigate to **Settings** | **Enable Template**
    and click on **OK**.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Sysprep on Windows to create a template](img/9182EN_08_09.jpg)'
  prefs: []
  type: TYPE_IMG
- en: On a sysprepped virtual machine, you should enable the template mode
  prefs: []
  type: TYPE_NORMAL
- en: After setting the template mode, you'll first have to create a snapshot of the
    virtual machine. Once you've done that, you can clone the virtual machine. In
    the clone wizard, make sure to select the option to create a clone based on a
    snapshot—you'll notice that this is the only available option anyway because the
    virtual machine is in the template mode.
  prefs: []
  type: TYPE_NORMAL
- en: '![Using Sysprep on Windows to create a template](img/9182EN_08_10.jpg)'
  prefs: []
  type: TYPE_IMG
- en: In the template mode, you can only clone a snapshot and not the current state
  prefs: []
  type: TYPE_NORMAL
- en: In the remainder of the process, you can choose whichever option you want to
    use—they are not really important for the cloning process to complete. When you
    start the virtual machine again, it will start in the same way a Windows instance
    starts on a new computer. This means that you'll need to enter the license information
    first and then provide all the other details required to configure the virtual
    machine.
  prefs: []
  type: TYPE_NORMAL
- en: Backups in a virtual environment
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'In this chapter, you''ve learned how to use snapshots and clones. Because of
    these features, you don''t really need backups in a traditional way (in which
    a backup program is scheduled to copy files from a filesystem to an offline medium)
    anymore. If you enable a feature such as autoprotect snapshots, a backup is created
    automatically every day. There are a few things to consider however, before thinking
    that you''re completely secure when using features such as clones and backups.
    The most important considerations are listed as follows:'
  prefs: []
  type: TYPE_NORMAL
- en: No matter how good your cloning and snapshot strategy is, as long as they are
    on the same disk as the original virtual machine files, you can hardly consider
    these virtual machines fully protected. In a good backup scheme, files need to
    be copied to another medium, and if possible, even to another site.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A clone is just a copy of a virtual machine. The longer back that the clone
    was created, the less you can consider it a decent backup of a virtual machine.
    Clones are useful to make working with virtual machines easier, but you should
    not consider them backups.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: An autoprotect snapshot is what comes closest to a real backup. It at least
    protects you from errors within the virtual machine. But still, you need access
    to the original virtual machine files.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Summary
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this chapter, you learned how to work with snapshots and clones in a versatile
    test environment. Using these techniques makes it possible to easily deploy new
    virtual machines and save the current state of virtual machines. You have also
    read about how to change the identity of virtual machines after cloning, and how
    to handle the cloning process in the case of Windows where the actual state of
    the virtual machine is closely related to the license that you have acquired for
    Windows.
  prefs: []
  type: TYPE_NORMAL
- en: In the next and last chapter of this book, you'll learn how to use VMware Workstation
    as a tool to enable the sharing of virtual machines with others in a cloud environment.
  prefs: []
  type: TYPE_NORMAL
