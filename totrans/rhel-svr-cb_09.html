<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09" class="calibre1"/>Chapter 9. Securing RHEL 7</h1></div></div></div><p class="calibre7">In this chapter, you will learn all about:</p><div><ul class="itemizedlist"><li class="listitem">Installing and configuring IPA</li><li class="listitem">Securing the system login</li><li class="listitem">Configuring privilege escalation with sudo</li><li class="listitem">Securing the network with <code class="email">firewalld</code></li><li class="listitem">Using kdump and SysRq</li><li class="listitem">Using ABRT</li><li class="listitem">Auditing the system</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch09lvl1sec67" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">Security<a id="id429" class="calibre1"/> is an important aspect of your environment. The recipes provided in this chapter are not a definitive set of how-tos; rather, they are a start to addressing security in an environment as every environment is different. This chapter is meant to give you an idea of what you can do with a simple set of tools included in Red Hat Enterprise Server 7.</p><p class="calibre7">In this chapter, I will not attempt explaining where the system stores syslog messages and what they mean as this can be quite an exhaustive topic. The most important security-related syslog messages can be found in <code class="email">/var/log/secure</code> and <code class="email">/var/log/audit/audit.log</code>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec68" class="calibre1"/>Installing and configuring IPA</h1></div></div></div><p class="calibre7">The <strong class="calibre8">IPA</strong> (<strong class="calibre8">Identity Policy Audit</strong>) server <a id="id430" class="calibre1"/>allows you to manage your kerberos, DNS, hosts, users, sudo <a id="id431" class="calibre1"/>rules, password policies, and automounts in a central location. IPA is a combination of packages, including—but not limited to—<code class="email">bind</code>, <code class="email">ldap</code>, <code class="email">pam</code>, and so on. It combines all of these to provide identity management for your environment.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec186" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">In this recipe, I will<a id="id432" class="calibre1"/> opt for an integrated DNS setup, although it is possible to use your existing DNS<a id="id433" class="calibre1"/> infrastructure.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec187" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">First, we'll install the server component, followed by what needs to be done on an IPA client.</p><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec62" class="calibre1"/>Installing the IPA server</h3></div></div></div><p class="calibre7">Follow these instructions to install an <a id="id434" class="calibre1"/>IPA server:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the necessary packages via the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y ipa-server bind bind-dyndb-ldap</strong>
</pre></div></li><li class="listitem" value="2">When the packages are installed, invoke the <code class="email">ipa</code> installer, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# ipa-server-install</strong>
</pre></div></li></ol><div></div><p class="calibre7">At this stage, you will be asked a couple of questions on how to set up your IPA server.</p><div><ol class="orderedlist"><li class="listitem" value="1">Configure integrated DNS as follows:<div><pre class="programlisting">
<strong class="calibre8">Do you want to configure integrated DNS (BIND)? [no]: yes</strong>
</pre></div></li><li class="listitem" value="2">Overwrite existing <code class="email">/etc/resolv.conf</code> as follows:<div><pre class="programlisting">
<strong class="calibre8">Existing BIND configuration detected, overwrite? [no]: yes</strong>
</pre></div></li><li class="listitem" value="3">Provide the IPA server's hostname, as follows:<div><pre class="programlisting">
<strong class="calibre8">Server host name [localhost.localdomain]: master.example.com</strong>
</pre></div></li><li class="listitem" value="4">Now, confirm the DNS domain name for the IPA server as follows:<div><pre class="programlisting">
<strong class="calibre8">Please confirm the domain name [example.com]:</strong>
</pre></div></li><li class="listitem" value="5">Provide an IP address for the IPA server as follows:<div><pre class="programlisting">
<strong class="calibre8">Please provide the IP address to be used for this host name: 192.168.0.1</strong>
</pre></div></li><li class="listitem" value="6">Next, provide a Kerberos <code class="email">realm</code> name, as follows:<div><pre class="programlisting">
<strong class="calibre8">Please provide a realm name [EXAMPLE.COM]:</strong>
</pre></div></li><li class="listitem" value="7">Create the directory manager's password and confirm it as follows:<div><pre class="programlisting">
<strong class="calibre8">Directory Manager password:</strong>
</pre></div></li><li class="listitem" value="8">Create the IPA manager's password and confirm it as follows:<div><pre class="programlisting">
<strong class="calibre8">IPA admin password:</strong>
</pre></div></li><li class="listitem" value="9">Now, configure the DNS forwarders as follows:<div><pre class="programlisting">
<strong class="calibre8">Do you want to configure DNS forwarders? [yes]: no</strong>
</pre></div></li><li class="listitem" value="10">Finally, configure the reverse DNS zones as follows:<div><pre class="programlisting">
<strong class="calibre8">Do you want to configure the reverse zone? [yes]:</strong>
<strong class="calibre8">Please specify the reverse zone name [0.168.192.in-addr.arpa.]:</strong>
</pre></div><p class="calibre13">The installer will<a id="id435" class="calibre1"/> now provide an overview similar to the following:</p><div><pre class="programlisting">
<strong class="calibre8">The IPA Master Server will be configured with:</strong>
<strong class="calibre8">Hostname:      master.example.com</strong>
<strong class="calibre8">IP address:    192.168.0.1</strong>
<strong class="calibre8">Domain name:   example.com</strong>
<strong class="calibre8">Realm name:    EXAMPLE.COM</strong>

<strong class="calibre8">BIND DNS server will be configured to serve IPA domain with:</strong>
<strong class="calibre8">Forwarders:    No forwarders</strong>
<strong class="calibre8">Reverse zone:  0.168.192.in-addr.arpa.</strong>
</pre></div></li><li class="listitem" value="11">Now, confirm the information by typing "yes", as follows:<div><pre class="programlisting">
<strong class="calibre8">Continue to configure the system with these values? [no]: yes</strong>
</pre></div></li></ol><div></div><p class="calibre7">At this point, you will see a lot of information scrolling on your screen, indicating what the installer is doing: installing or configuring NTP, LDAP, BIND, Kerberos, HTTP, the certificate server, and IPA-related modifications to the preceding examples.</p><p class="calibre7">The installation and configuration process can take a while, so be patient.</p></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec63" class="calibre1"/>Installing the IPA client</h3></div></div></div><p class="calibre7">Perform these steps to install and <a id="id436" class="calibre1"/>configure the IPA client on your system:</p><div><h3 class="title2"><a id="tip12" class="calibre1"/>Tip</h3><p class="calibre7">Ensure that the hostname of your system is different from <code class="email">localhost.localdomain</code>. If it is not, the client configuration will fail.</p></div><div><ol class="orderedlist"><li class="listitem" value="1">Install the necessary packages via the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y ipa-client</strong>
</pre></div></li><li class="listitem" value="2">Ensure that the IPA server is used as a DNS server through the following:<div><pre class="programlisting">
<strong class="calibre8">~]# cat /etc/resolv.conf</strong>
<strong class="calibre8">search example.com</strong>
<strong class="calibre8">nameserver 192.168.0.1</strong>
</pre></div></li><li class="listitem" value="3">Invoke the IPA client configuration by running this command line:<div><pre class="programlisting">
<strong class="calibre8">~]# ipa-client-install --enable-dns-updates</strong>
</pre></div></li></ol><div></div><p class="calibre7">The installer will now <a id="id437" class="calibre1"/>show an overview of the detected IPA server and ask for a user (the IPA manager) and password to register your system, as shown in the following screenshot:</p><div><img src="img/00060.jpeg" alt="Installing the IPA client" class="calibre10"/></div><p class="calibre11"> </p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec188" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">Once installed, you can manage your IPA environment using the command line tool IPA or the web interface, which can be accessed by pointing your browser to your IPA master server over HTTPS. In this case, the URL is <code class="email">https://master.example.com</code>.</p><p class="calibre7">By default, the IPA client doesn't create <code class="email">homedirs</code> for new users at first login. If you want to enable this, use the <code class="email">--mkhomedir</code> argument with <code class="email">ipa-client-install</code>. If you happen to have forgotten about this, there's no need to reinstall the IPA client. You can just reconfigure this by executing the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --enablemkhomedir --update</strong>
</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch09lvl2sec189" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more in-depth information about installing and configuring your <a id="id438" class="calibre1"/>IPA server, go to <a class="calibre1" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Linux_Domain_Identity_Authentication_and_Policy_Guide/installing-ipa.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Linux_Domain_Identity_Authentication_and_Policy_Guide/installing-ipa.html</a>.</p><p class="calibre7">For more information about managing your IPA environment through the command line, read the <em class="calibre9">ipa (1)</em> man pages.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec69" class="calibre1"/>Securing the system login</h1></div></div></div><p class="calibre7">The default settings applied to system login are based on what Red Hat deems basic security. If, for some reason, you want to change this, this recipe will show you a couple of examples. Authconfig <a id="id439" class="calibre1"/>has two tools that you can use to configure authentication: <code class="email">authconfig</code> and <code class="email">authconfig-tui</code>.</p><p class="calibre7">These two tools configure <code class="email">pam</code> for you in such a way that the changes are consistent throughout rpm updates.</p><p class="calibre7">The <code class="email">authconfig-tui</code> tool is <a id="id440" class="calibre1"/>not as feature-rich as the plan <code class="email">authconfig</code> tool, which <a id="id441" class="calibre1"/>I personally recommend you to use as it allows you to do more.</p><p class="calibre7">You can manually edit the files located in <code class="email">/etc/pam.d</code> if and when you know what you're doing, but this is not recommended.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec190" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Perform the following steps:</p><p class="calibre7">First, change the hash encryption of the passwords stored in <code class="email">/etc/shadow</code> to <code class="email">sha512</code>, as follows:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --passalgo=sha512 --update</strong>
</pre></div><p class="calibre7">Enable NIS authentication through the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --enablenis –nisdomain=NISDOMAIN --nisserver=nisserver.example.com --update</strong>
</pre></div><p class="calibre7">Now, set the minimum length requirement for passwords to <code class="email">16</code> via the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --passminlen=16 --update</strong>
</pre></div><p class="calibre7">The user requires at least one lowercase letter in the password; you can set this requirement by running the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --enablereqlower --update</strong>
</pre></div><p class="calibre7">Also, the user requires at least one uppercase letter in the password, for which you can run the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --enablerequpper --update</strong>
</pre></div><p class="calibre7">Now, the user requires at least one number in the password. Execute the following command for this:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --enablereqdigit --update</strong>
</pre></div><p class="calibre7">Finally, the user requires at least one nonalphanumeric character in the password, which you can set using the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --enablereqother --update</strong>
</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec191" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">
<code class="email">authconfig</code> and <code class="email">authconfig-tui</code> are wrapper scripts that modify a variety of files, including, but<a id="id442" class="calibre1"/> not <a id="id443" class="calibre1"/>limited to, <code class="email">/etc/nsswitch.conf</code>, <code class="email">/etc/pam.d/*</code>, <code class="email">/etc/sssd.conf</code>, <code class="email">/etc/openldap/ldap.conf</code>, and <code class="email">/etc/sysconfig/network</code>.</p><p class="calibre7">The advantage of the <a id="id444" class="calibre1"/>tool is that it uses the correct syntax, which can sometimes be a little tricky, especially for the files in <code class="email">/etc/pam.d</code>.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec192" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">One of the interesting features of this tool is the backup and restore functions. In case you do not use any centralized identification and authentication infrastructure, such as IPA, you can use this to make a backup of a correctly configured machine and distribute this through whichever means you wish to use.</p><p class="calibre7">To back up your <code class="email">authconf</code> configuration, execute the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig --savebackup=/tmp/auth.conf</strong>
</pre></div><p class="calibre7">This will create a <code class="email">/tmp/auth.conf</code> directory, which contains all the files modified by <code class="email">authconfig</code>.</p><p class="calibre7">Copy this directory over to another server and restore the configuration by executing the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# authconfig –-restorebackup=/tmp/auth.conf</strong>
</pre></div><p class="calibre7">All of the security changes you apply through <code class="email">authconfig</code> can also be managed through IPA.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch09lvl2sec193" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For information about and more configuration options, take a look at the <em class="calibre9">authconfig (8)</em> man pages.</p><p class="calibre7">You can also find more information on Red Hat's page on authentication<a id="id445" class="calibre1"/> at <a class="calibre1" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System-Level_Authentication_Guide/Configuring_Authentication.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System-Level_Authentication_Guide/Configuring_Authentication.html</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec70" class="calibre1"/>Configuring privilege escalation with sudo</h1></div></div></div><p class="calibre7">Sudo allows users to run<a id="id446" class="calibre1"/> applications and scripts with the security <a id="id447" class="calibre1"/>privileges of another user.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec194" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Before allowing someone to elevate their security context for a specific application or script, you need to figure out which user or group you wish to elevate from and to, which applications/scripts you use, and on which systems to run them.</p><p class="calibre7">The default syntax for a sudo entry is the following:</p><div><pre class="programlisting">
<strong class="calibre8">who where = (as_whom) what</strong>
</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec195" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">These simple five steps will guide you through setting up privilege escalation:</p><div><ol class="orderedlist"><li class="listitem" value="1">Create a new <code class="email">sudoers</code> definition file in <code class="email">/etc/sudoers.d/</code> called clustering through the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# visudo -f /etc/sudoers.d/clustering</strong>
</pre></div></li><li class="listitem" value="2">Create a command alias for the most-used clustering tools called <code class="email">CLUSTERING</code> by executing the following:<div><pre class="programlisting">Cmnd_Alias CLUSTERING = /sbin/ccs, /sbin/clustat, /sbin/clusvcadm</pre></div></li><li class="listitem" value="3">Now, create a host alias group for all the clusters called <code class="email">CLUSTERS</code>, as follows:<div><pre class="programlisting">Host_Alias CLUSTERS = cluster1, cluster2</pre></div></li><li class="listitem" value="4">Next, create a user alias for all cluster admins called <code class="email">CLUSTERADMINS</code> by executing the following:<div><pre class="programlisting">User_Alias CLUSTERADMINS = spalpatine, dvader, okenobi, qjinn</pre></div></li><li class="listitem" value="5">Now, let's create a sudo rule that allows the users from <code class="email">CLUSTERADMINS</code> to execute commands from <code class="email">CLUSTERING</code> on all servers within the <code class="email">CLUSTERS</code> group, as follows:<div><pre class="programlisting">CLUSTERADMINS CLUSTERS = (root) CLUSTERING</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec196" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">To edit the <code class="email">sudoers</code> file, you can either use a text editor and edit <code class="email">/etc/sudoers</code>, the <code class="email">visudo</code> tool, which <a id="id448" class="calibre1"/>automatically checks your syntax<a id="id449" class="calibre1"/> when exiting.</p><p class="calibre7">It's always a good idea to leave the original <code class="email">/etc/sudoers</code> file alone and modify the files located in <code class="email">/etc/sudoers.d/</code>. This allows the sudo rpm to update the <code class="email">sudoers</code> file should it be necessary.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch09lvl2sec197" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more information about sudo, take a look at the <em class="calibre9">sudoers (5)</em> man page.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec71" class="calibre1"/>Secure the network with firewalld</h1></div></div></div><p class="calibre7">
<code class="email">firewalld</code> is a <a id="id450" class="calibre1"/>set of scripts and a daemon that manage <code class="email">netfilter</code> on your RHEL system. It aims at creating a simple command-line interface to manage the <a id="id451" class="calibre1"/>firewall <a id="id452" class="calibre1"/>on your systems.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec198" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">By default, <code class="email">firewalld</code> is included in the "core" rpm group, but it may not be installed for some reason (that you left it out of your kickstart would be one!). Perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install <code class="email">firewalld</code> via the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y firewalld</strong>
</pre></div></li><li class="listitem" value="2">Now, enable <code class="email">firewalld</code> through the following:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl enable firewalld</strong>
</pre></div></li><li class="listitem" value="3">Finally, ensure that <code class="email">firewalld</code> is started by executing the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl restart firewalld</strong>
</pre></div></li></ol><div></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec64" class="calibre1"/>Showing the currently allowed services and ports on your system</h3></div></div></div><p class="calibre7">List all the allowed<a id="id453" class="calibre1"/> services<a id="id454" class="calibre1"/> using the<a id="id455" class="calibre1"/> following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd –list-services</strong>
</pre></div><p class="calibre7">You can see the output <a id="id456" class="calibre1"/>as follows, where all the allowed services are listed:</p><div><img src="img/00061.jpeg" alt="Showing the currently allowed services and ports on your system" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Now, show the <code class="email">tcp</code>/<code class="email">udp</code> ports that are allowed by your firewall using the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd --list-ports</strong>
</pre></div><p class="calibre7">Here's what the output should look like:</p><div><img src="img/00062.jpeg" alt="Showing the currently allowed services and ports on your system" class="calibre10"/></div><p class="calibre11"> </p></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec65" class="calibre1"/>Allowing incoming requests for NFS (v4)</h3></div></div></div><p class="calibre7">Perform the following <a id="id457" class="calibre1"/>steps to allow NFSv4 traffic on your<a id="id458" class="calibre1"/> system:</p><div><ol class="orderedlist"><li class="listitem" value="1">First, allow <code class="email">nfs</code> traffic via this command:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd --add-service nfs –-permanent</strong>
<strong class="calibre8">success</strong>
<strong class="calibre8">~]#</strong>
</pre></div></li><li class="listitem" value="2">Then, reload the configuration as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd --reload</strong>
<strong class="calibre8">success</strong>
<strong class="calibre8">~]#</strong>
</pre></div></li><li class="listitem" value="3">Now, check the newly applied rule by executing the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd –-list-services</strong>
<strong class="calibre8">nfs</strong>
<strong class="calibre8">~]#</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec66" class="calibre1"/>Allowing incoming requests on an arbitrary port</h3></div></div></div><p class="calibre7">Perform the following <a id="id459" class="calibre1"/>steps to allow incoming traffic<a id="id460" class="calibre1"/> on port <code class="email">1234</code> over both <code class="email">tcp</code> and <code class="email">udp</code>:</p><div><ol class="orderedlist"><li class="listitem" value="1">First, allow traffic on port <code class="email">1234</code> over <code class="email">tcp</code> and <code class="email">udp</code> by running the following:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd --add-port 1234/tcp --permanent</strong>
<strong class="calibre8">success</strong>
<strong class="calibre8">~]# firewall-cmd --add-port 1234/udp --permanent</strong>
<strong class="calibre8">success</strong>
<strong class="calibre8">~]#</strong>
</pre></div></li><li class="listitem" value="2">Reload the configuration by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd –-reload</strong>
<strong class="calibre8">success</strong>
<strong class="calibre8">~]#</strong>
</pre></div></li><li class="listitem" value="3">Check the newly applied rule via the following:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd –-list-ports</strong>
<strong class="calibre8">1234/tcp 1234/udp</strong>
<strong class="calibre8">~]#</strong>
</pre></div></li></ol><div></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec199" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">
<code class="email">firewalld</code> comes with a set of<a id="id461" class="calibre1"/> predefined port configurations, such as HTTP and HTTPS. You can find all such definitions in <code class="email">/lib/firewalld/services</code>. When creating your own port definitions or modifying the existing ones, you should create new port definition files in <code class="email">/etc/firewalld/services</code>.</p><p class="calibre7">When creating new "rules" by adding ports, services, and so on, you need to add the <code class="email">--permanent</code> option, or your changes would be lost upon the rebooting of the system or the reloading of the <code class="email">firewalld</code> policy.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec200" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more information on configuring your firewall, check the man pages for <em class="calibre9">firewall-cmd(1)</em>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec72" class="calibre1"/>Using kdump and SysRq</h1></div></div></div><p class="calibre7">The kdump <a id="id462" class="calibre1"/>mechanism is a Linux kernel feature, which allows you to create dumps if your kernel crashes. It produces an exact copy of the memory, which can be analyzed for the root cause of the crash.</p><p class="calibre7">SysRq is a<a id="id463" class="calibre1"/> feature supported by the Linux kernel, which allows you to send key combinations to it even when your system becomes unresponsive.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec201" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">First, we'll set up kdump and SysRq, and afterwards, I'll show you how to use it to debug a dump.</p><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec67" class="calibre1"/>Installing and configuring kdump and SysRq</h3></div></div></div><p class="calibre7">Let's<a id="id464" class="calibre1"/> take a look<a id="id465" class="calibre1"/> at how<a id="id466" class="calibre1"/> this is<a id="id467" class="calibre1"/> installed and configured:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the necessary packages for kdump by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y kexec-tools</strong>
</pre></div></li><li class="listitem" value="2">Ensure that <code class="email">crashkernel=auto</code> is present in the <code class="email">GRUB_CMDLINE_LINUX</code> variable declaration in the <code class="email">/etc/sysconfig/grub</code> file using this command:<div><pre class="programlisting">GRUB_CMDLINE_LINUX="rd.lvm.lv=system/usr rd.lvm.lv=system/swap vconsole.keymap=us rd.lvm.lv=system/root vconsole.font=latarcyrheb-sun16 crashkernel=auto"</pre></div></li><li class="listitem" value="3">Start <code class="email">kdump</code> by running the following:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl start kdump</strong>
</pre></div></li><li class="listitem" value="4">Now, enable <code class="email">kdump</code> to start at boot, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# sysctl enable kdump</strong>
</pre></div></li><li class="listitem" value="5">Configure <a id="id468" class="calibre1"/>SysRq to<a id="id469" class="calibre1"/> accept all commands via the following commands:<div><pre class="programlisting">
<strong class="calibre8">~]# echo "kernel.sysrq = 1" &gt;&gt; /etc/sysctl.d/sysrq.conf</strong>
<strong class="calibre8">~]# systemctl -q -p /etc/sysctl.d/sysrq.conf</strong>
</pre></div></li><li class="listitem" value="6">Regenerate <a id="id470" class="calibre1"/>your <strong class="calibre8">intramfs</strong> (<strong class="calibre8">initial RAM file system</strong>)<a id="id471" class="calibre1"/> to contain the necessary information <a id="id472" class="calibre1"/>for kdump by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# dracut --force</strong>
</pre></div></li><li class="listitem" value="7">Finally, reboot through the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# reboot</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec68" class="calibre1"/>Using kdump tools to analyze the dump</h3></div></div></div><p class="calibre7">Although you'll find most of<a id="id473" class="calibre1"/> the information you're looking for<a id="id474" class="calibre1"/> in the <code class="email">vmcode-dmesg.txt</code> file, it can be useful sometimes to look into the bits and bytes of the <code class="email">vmcore</code> dump, even if it is just to know what the people at Red Hat do when they ask you to send you a <code class="email">vmcore</code> dump. Perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the necessary tools to debug the <code class="email">vmcore</code> dump via the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y --enablerepo=\*debuginfo crash kernel-debuginfo</strong>
</pre></div></li><li class="listitem" value="2">Locate your <code class="email">vmcore</code> by executing the following:<div><pre class="programlisting">
<strong class="calibre8">~]# find /var/crash -name 'vmcore'</strong>
<strong class="calibre8">/var/crash/127.0.0.1-2015.10.31-12:03:06/vmcore</strong>
</pre></div><div><h3 class="title2"><a id="note04" class="calibre1"/>Note</h3><p class="calibre7">If you don't have a core dump, you can trigger this yourself by executing the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# echo c &gt; /proc/sysrq-trigger</strong>
</pre></div></div></li><li class="listitem" value="3">Use <code class="email">crash</code> to analyze the contents, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# crash /var/crash/127.0.0.1-2015.10.31-12:03:06/vmcore /usr/lib/debug/lib/modules/&lt;kernel&gt;/vmlinux</strong>
</pre></div><p class="calibre13">Here, <code class="email">&lt;kernel&gt;</code> must be the same kernel as the one that the dump was created for:</p><div><img src="img/00063.jpeg" alt="Using kdump tools to analyze the dump" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="4">Display the<a id="id475" class="calibre1"/> kernel message buffer (this can <a id="id476" class="calibre1"/>also be found in the <code class="email">vmcore-dmesg.txt</code> dump file) by running the following command:<div><pre class="programlisting">
<strong class="calibre8">crash&gt; log</strong>
</pre></div><p class="calibre13">Here's what the output should look like:</p><div><img src="img/00064.jpeg" alt="Using kdump tools to analyze the dump" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="5">Display the <a id="id477" class="calibre1"/>kernel stack trace through the<a id="id478" class="calibre1"/> following:<div><pre class="programlisting">
<strong class="calibre8">crash&gt; bt</strong>
</pre></div><p class="calibre13">Here's what the output should look like:</p><div><img src="img/00065.jpeg" alt="Using kdump tools to analyze the dump" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="6">Now, show the processes at the time of the core dump, as follows:<div><pre class="programlisting">
<strong class="calibre8">crash&gt; ps</strong>
</pre></div><p class="calibre13">Here's what the output should look like:</p><div><img src="img/00066.jpeg" alt="Using kdump tools to analyze the dump" class="calibre10"/></div><p class="calibre15"> </p></li></ol><div></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec202" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">The default kdump<a id="id479" class="calibre1"/> configuration uses <code class="email">/var/crash</code> to dump<a id="id480" class="calibre1"/> its memory on. This MUST be on the root filesystem. Some systems are configured with a separate filesystem for <code class="email">/var</code>, so you need to change the location in <code class="email">/etc/kdump.conf</code> or use a different target type, such as <code class="email">raw</code>, <code class="email">nfs</code>, and so on. If your crash directory is located on a nonroot filesystem, the kdump service will fail!</p><p class="calibre7">Although the crash utility can provide a lot of details about the crash, usually you're set with the contents of the <code class="email">vmcore-dmesg.txt</code> file, which resides in the same directory as the <code class="email">vmcore</code> file. So, I suggest that you parse this file before digging into the bits and bytes of the memory dump.</p><p class="calibre7">SysRq, as stated before, allows you to control your system even if it is in a state that doesn't allow you to do anything at all. However, it does require you to have access to the system's console.</p><p class="calibre7">By default, kdump creates a dump and reboots your system. In the event that this doesn't happen and you don't want to push the power button on your (virtual) system, SysRq allows you to send commands through the console to your kernel.</p><p class="calibre7">The key combination needed to send the information differs a little from architecture to architecture. Take a look at the following table for reference:</p><div><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Architecture</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Key combination</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">x86</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">&lt;Alt&gt;&lt;SysRq&gt;&lt;command key&gt;</code>
</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Sparc</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">&lt;Alt&gt;&lt;Stop&gt;&lt;command key&gt;</code>
</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">Serial console (PC style only)</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This sends a <code class="literal">BREAK</code> and, within 5 seconds, the command key.</p>
<p class="calibre22">Sending <code class="literal">BREAK</code> twice is interpreted as a normal <code class="literal">BREAK</code>.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">PowerPC</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">&lt;Alt&gt;&lt;Print Screen&gt;</code>(or <code class="literal">&lt;F13&gt;</code>)<code class="literal">&lt;command key&gt;</code>
</p>
</td></tr></tbody></table></div><p class="calibre7">So, on an x86 system, you would attempt to sync your disks before rebooting it by executing the following commands:</p><div><pre class="programlisting">
<strong class="calibre8">&lt;Alt&gt;&lt;SysRq&gt;&lt;s&gt;</strong>
<strong class="calibre8">&lt;Alt&gt;&lt;SysRq&gt;&lt;b&gt;</strong>
</pre></div><p class="calibre7">Alternatively, if you still have access to your terminal, you can do the same by sending characters to <code class="email">/proc/sysrq-trigger</code>, as follows:</p><div><pre class="programlisting">
<strong class="calibre8">~]# echo s &gt; /proc/sysrq-trigger</strong>
<strong class="calibre8">~]# echo b &gt; /proc/sysrq-trigger</strong>
</pre></div><p class="calibre7">The following key commands are available:</p><div><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Command key</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Function</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">b</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This immediately reboots your system. It does not sync or unmount disks. This can result in data corruption!</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">c</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This performs a system crash by a <code class="literal">NULL</code> pointer dereference. A crashdump is taken if kdump is configured.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">d</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This shows all the locks held.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">e</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This sends a <code class="literal">SIGTERM</code> signal to all your processes, except for <code class="literal">init</code>.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">f</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This calls <code class="literal">oom_kill</code> to kill any process hogging the memory.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">g</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is used by the <a id="id481" class="indexterm"/>
<strong class="calibre26">kernel debugger</strong> (<strong class="calibre26">kgdb</strong>).</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">h</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This shows help. (Memorize this option!)</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">i</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This sends a <code class="literal">SIGKILL</code> signal to all your processes, except for <code class="literal">init</code>.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">j</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This freezes your filesystems with the <code class="literal">FIFREEZE</code> ioctl.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">k</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This kills all the programs on the current virtual console.</p>
<p class="calibre22">It enables a secure login from the console as this kills all malware attempting to grab your keyboard input, for example.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">l</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This shows a stack trace for all active CPUs.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">m</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This dumps the current memory info to your console.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">n</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">You can use this to make real-time tasks niceable.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">o</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This shuts down your system and turns it off (if configured and supported).</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">p</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This dumps the current registers and flags to your console</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">q</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This will dump a list of all armed <code class="literal">hrtimers</code> (except for <code class="literal">timer_list</code> timers) per CPU together with detailed information about all clockevent devices.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">r</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This turns off your keyboard's raw mode and sets it to <code class="literal">XLATE</code>.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">s</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This attempts to sync all your mounted filesystems, committing unwritten data to them.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">t</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This dumps a list of current tasks and their information to your console.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">u</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This attempts to remount all your filesystems as read-only volumes.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">v</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This causes the ETM buffer to dump (this is ARM-specific).</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">w</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This dumps all the tasks that are in an uninterruptable (blocked) state.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">x</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is used by xmon on ppc/powerpc platforms. This shows the global PMU registers on SPARC64.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">y</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This shows global CPU registers (this is SPARC64-specific).</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">z</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This dumps the <code class="literal">ftrace</code> buffer.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">0</code> - <code class="literal">9</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This sets the console's log level, controlling which messages will be printed. The higher the number, the more the output.</p>
</td></tr></tbody></table></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec203" class="calibre1"/>See also…</h2></div></div></div><p class="calibre7">For more information about SysRq<a id="id482" class="calibre1"/> and<a id="id483" class="calibre1"/> systemd, refer to the following page: <a class="calibre1" href="https://github.com/systemdaemon/systemd/blob/master/src/linux/Documentation/sysrq.txt">https://github.com/systemdaemon/systemd/blob/master/src/linux/Documentation/sysrq.txt</a>
</p><p class="calibre7">Red Hat<a id="id484" class="calibre1"/> has a complete crash dump guide at <a class="calibre1" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Kernel_Crash_Dump_Guide/index.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Kernel_Crash_Dump_Guide/index.html</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec73" class="calibre1"/>Using ABRT</h1></div></div></div><p class="calibre7">
<strong class="calibre8">ABRT</strong> (<strong class="calibre8">Automatic Bug Reporting Tool</strong>), is a set<a id="id485" class="calibre1"/> of tools that help users detect and analyze application crashes.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec204" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">First, we'll install the necessary packages and then take a look at how to use these tools.</p><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec69" class="calibre1"/>Installing and configuring abrtd</h3></div></div></div><p class="calibre7">Let's install <code class="email">abrt</code> and<a id="id486" class="calibre1"/> get it <a id="id487" class="calibre1"/>running:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the <code class="email">abrt</code> daemon and tools via the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y abrt-cli</strong>
</pre></div></li><li class="listitem" value="2">Now, enable and start the <code class="email">abrt</code> daemon through these commands:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl enable abrtd</strong>
<strong class="calibre8">~]# systemctl restart abrtdThere's more...</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec70" class="calibre1"/>Using abrt-cli</h3></div></div></div><p class="calibre7">List all detected segmentation<a id="id488" class="calibre1"/> faults by executing the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# abtr-cli list</strong>
</pre></div><p class="calibre7">Here's what the output should look like:</p><div><img src="img/00067.jpeg" alt="Using abrt-cli" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The displayed location contains all the information about the segmentation fault. You can use this to analyze what went wrong, and if you need help from Red Hat, you can use <code class="email">abrt-cli report</code> to report to Red Hat Support.</p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec205" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">When your RHEL 7 system is registered with a satellite, all bugs will automatically be reported to the satellite system.</p><p class="calibre7">You can install additional plugins to automatically report bugs in the following ways:</p><div><ul class="itemizedlist"><li class="listitem">to Bugzilla (<code class="email">libreport-plugin-bugzilla</code>)</li><li class="listitem">via ftp upload (<code class="email">libreport-plugin-reportuploader</code>)</li><li class="listitem">to Red Hat Support (<code class="email">libreport-plugin-rhtsupport</code>)</li><li class="listitem">to an <code class="email">abrt</code> server (<code class="email">libreport-plugin-ureport</code>)</li></ul></div><p class="calibre7">Besides the basic bug reporting, you can also create automatic bug reports for Java by installing the <code class="email">abrt-java-connector</code> package.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch09lvl2sec206" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more information on how to use the <a id="id489" class="calibre1"/>abrt tool, refer to <a class="calibre1" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-abrt.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/ch-abrt.html</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch09lvl1sec74" class="calibre1"/>Auditing the system</h1></div></div></div><p class="calibre7">The Linux audit system<a id="id490" class="calibre1"/> allows you to track security-related information about your systems. It allows you to watch security events, filesystem access, network access, commands run by users, and system calls.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch09lvl2sec207" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">By default, audit is installed as part of the core packages. So, there's no need to install this.</p><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec71" class="calibre1"/>Configuring a centralized syslog server to accept audit logs</h3></div></div></div><p class="calibre7">Perform these steps to<a id="id491" class="calibre1"/> set up the <code class="email">syslog</code> server:</p><div><ol class="orderedlist"><li class="listitem" value="1">On the <code class="email">syslog</code> server, create a <code class="email">/etc/rsyslog.d/audit_server.conf</code> file containing the following:<div><pre class="programlisting"># Receive syslog audit messages via TCP over port 65514
$ModLoad imtcp
$InputTCPServerRun 65514
$AllowedSender TCP, 127.0.0.1, 192.168.1.0/24
$template HostAudit, "/var/log/audit/%$YEAR%%$MONTH%%$DAY%-%HOSTNAME%/audit.log"
$template auditFormat, "%msg%\n" local6.*  ?HostAudit;auditFormat</pre></div></li><li class="listitem" value="2">On the <code class="email">syslog</code> server, restart <code class="email">rsyslog</code>, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl restart rsyslog</strong>
</pre></div></li><li class="listitem" value="3">On the client, create a <code class="email">/etc/rsyslog.d/audit_client.conf</code> file containing the following:<div><pre class="programlisting">$ModLoad imfile
$InputFileName /var/log/audit/audit.log
$InputFileTag tag_audit_log:
$InputFileStateFile audit_log
$InputFileFacility local6
$InputFileSeverity info
$InputRunFileMonitor local6.* @@logserver.example.com:65514</pre></div></li><li class="listitem" value="4">Next, on the <a id="id492" class="calibre1"/>client, restart <code class="email">rsyslog</code>, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl restart syslog</strong>
</pre></div></li></ol><div></div></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec72" class="calibre1"/>Some audit rules</h3></div></div></div><p class="calibre7">You can use the following<a id="id493" class="calibre1"/> command to log activity on <code class="email">/etc/resolv.conf</code>:</p><div><pre class="programlisting">
<strong class="calibre8">~]# auditctl -w /etc/resolv.conf -p w -k resolv_changes</strong>
</pre></div><p class="calibre7">You can execute the following commands to log all the commands executed by root:</p><div><pre class="programlisting">
<strong class="calibre8">~]# echo "session   required pam_tty_audit.so disable=* enable=root" &gt;&gt; /etc/pam.d/system-auth-ac</strong>
<strong class="calibre8">~]# echo "session   required pam_tty_audit.so disable=* enable=root" &gt;&gt; /etc/pam.d/password-auth-ac</strong>
</pre></div></div><div><div><div><div><h3 class="title2"><a id="ch09lvl3sec73" class="calibre1"/>Showing audit logs for the preceding rules</h3></div></div></div><p class="calibre7">You can search for<a id="id494" class="calibre1"/> the audit events that have changed <code class="email">/etc/resolv.conf</code> using the preceding rule by executing the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# ausearch -k resolv_changes</strong>
</pre></div><p class="calibre7">Here's what the output should look like:</p><div><img src="img/00068.jpeg" alt="Showing audit logs for the preceding rules" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">To check all the <a id="id495" class="calibre1"/>commands executed by root today, you can run the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# aureport --tty -ts today</strong>
</pre></div><p class="calibre7">Here's what the output should look like:</p><div><img src="img/00069.jpeg" alt="Showing audit logs for the preceding rules" class="calibre10"/></div><p class="calibre11"> </p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch09lvl2sec208" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more in-depth information about<a id="id496" class="calibre1"/> audit, refer to <a class="calibre1" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/chap-system_auditing.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Security_Guide/chap-system_auditing.html</a>.</p></div></div></body></html>