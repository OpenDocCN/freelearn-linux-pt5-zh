<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Configuring a Secure and Optimized Kernel</h1>
                </header>
            
            <article>
                
<p>The kernel is the core of any operating system, be it Windows or Linux. Linux is technically the kernel and not the complete operating system. Being the core of any operating system, the kernel is installed first and usually requires no manual configuration. Even if there are some kernel level updates to be installed, on a Linux system, it can be installed as a regular application. However, in some situations, compiling the kernel from source with some specific changes might be needed.</p>
<p class="mce-root">However, there might be a few situations where you need to compile the kernel yourself, from the source. These situations include:</p>
<ul>
<li class="mce-root">Enabling experimental features in the kernel</li>
<li class="mce-root">Enabling new hardware support</li>
<li class="mce-root">Debugging the kernel</li>
<li>Exploring the kernel source code</li>
</ul>
<p>Before you can start building the Linux kernel, you must ensure that a working boot media exists for the Linux system. This can be used to boot into the Linux system, if the boot loader is not configured properly. You will learn how to create USB boot media, kernel source retrieving, configure and build a kernel, and installing and booting from a kernel.</p>
<p class="chapter-content">In this chapter, we will cover the following recipes:</p>
<ul>
<li>Creating USB boot media</li>
<li>Retrieving the kernel source</li>
<li>Configuring and building the kernel</li>
<li>Installing and booting from a kernel</li>
<li>Kernel testing and debugging</li>
<li>Configuring the console for debugging using Netconsole</li>
<li>Debugging kernel boot</li>
<li>Kernel errors</li>
<li>Checking kernel parameters using Lynis</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Creating USB boot media</h1>
                </header>
            
            <article>
                
<p class="mce-root">A USB boot media can be created on any USB media device that is formatted as ext2, ext3, or VFAT format. Also, ensure that enough free space is available on the device, varying from 4 GB for transferring a distribution DVD image, 700 MB in case of a distribution CD image, or just 10 MB to transfer a minimal boot media image. Learning how to create a boot media will be beneficial for readers who are not very experienced with Linux.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">Before starting the steps, you need to have an image file of a Linux installation disk, which you can name as <kbd>boot.iso</kbd>, and a USB storage device, as specified before.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="mce-root">To start the procedure of creating the USB boot media, you need to perform the following commands as root:</p>
<ol>
<li class="mce-root"><span>To install Syslinux on your system, simply execute the following command:</span></li>
</ol>
<pre style="color: black"><strong>sudo apt-get install syslinux</strong></pre>
<ol start="2">
<li>You need to install the Syslinux boot loader by executing the following command on the USB storage device:</li>
</ol>
<pre>    <strong>   syslinux /dev/sdb1</strong></pre>
<ol start="3">
<li>Now create mount points each for the <kbd>boot.iso</kbd> file and the USB storage device by executing this command:</li>
</ol>
<pre>    <strong>mkdir /mnt/isoboot /mnt/diskboot</strong></pre>
<ol start="4">
<li>Next, mount the <kbd>boot.iso</kbd> file on the mount point created for it:</li>
</ol>
<pre>    <strong>mount -o loop boot.iso /mnt/isoboot</strong></pre>
<p class="mce-root" style="padding-left: 60px">In the previous command, <kbd>-o loop</kbd> option is used for creating a pseudo device that acts as a block-based device. It treats a file as a block device.</p>
<ol start="5">
<li>Next, mount the USB storage device on the mount point created for it:</li>
</ol>
<pre>    <strong>mount /dev/sdb1 /mnt/diskboot</strong></pre>
<ol start="6">
<li>Once both <kbd>boot.iso</kbd> and USB storage device are mounted, copy the Isolinux files from <kbd>boot.iso</kbd> to the USB storage device:</li>
</ol>
<pre>    <strong>cp /mnt/isoboot/isolinux/* /mnt/diskboot</strong></pre>
<ol start="7">
<li>Next, run the command to use the <kbd>isolinux.cfg</kbd> file from <kbd>boot.iso</kbd> as the <kbd>syslinux.cfg</kbd> file for the USB storage device:</li>
</ol>
<pre>    <strong>grep -v local /mnt/isoboot/isolinux/isolinux.cfg &gt; /mnt/diskboot/syslinux.cfg</strong></pre>
<ol start="8">
<li>Once done with the previous command, unmount <kbd>boot.iso</kbd> and the USB storage device:</li>
</ol>
<pre>    <strong>unmount /mnt/isoboot /mnt/diskboot</strong></pre>
<ol start="9">
<li>Now reboot the system and then try to boot with the USB boot media to verify that you are able to boot with it.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="mce-root">When you copy the required files from the <kbd>boot.iso</kbd> file to the USB storage media and use the <kbd>isolinux.cfg</kbd> file from <kbd>boot.iso</kbd> in the USB storage media as the <kbd>syslinux.cfg</kbd> file, it converts the USB storage media into a bootable media device that can be used to boot into the Linux system.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Retrieving the kernel source</h1>
                </header>
            
            <article>
                
<p class="mce-root">Most of the Linux distributions include the kernel sources in them. However, these sources may tend to be a bit out of date. Because of this, you may need to get the latest sources when building or customizing the kernel.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">Most of the Linux kernel developer community uses the <strong>Git</strong> tool for source code management. Even Ubuntu has integrated Git for its own Linux kernel source code, hence enabling the kernel developers to interact better with the community. You can install the Git package using the following command:</p>
<pre><strong>sudo apt-get install git</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="mce-root">The Linux kernel source code can be downloaded from various sources, and here we will talk about the methods used to download from these sources:</p>
<ol>
<li>We can find the Linux source code as a complete tarball and also as an incremental patch at the official webpage of the Linux kernel:</li>
</ol>
<p style="padding-left: 60px"><a href="http://www.kernel.org/">http://www.kernel.org</a></p>
<p style="padding-left: 60px">It is always recommended you use the latest version, unless you have a specific reason to work with an older version.</p>
<ol start="2">
<li>Ubuntu's kernel source can be found under Git. Each release code of the kernel is separately maintained on <kbd>kernel.ubuntu.com</kbd> in its own Git repository, which is located at:</li>
</ol>
<p style="padding-left: 60px"><kbd>git://kernel.ubuntu.com/ubuntu/ubuntu-&lt;release&gt;.git</kbd></p>
<p style="padding-left: 60px">It's located here:</p>
<p style="padding-left: 60px"><kbd>http://kernel.ubuntu.com/git-repos/ubuntu/</kbd></p>
<ol start="3">
<li>You can clone the repository, using Git, to get a local copy. The command will get modified as per the Ubuntu release you are interested in.</li>
<li>To obtain the precise tree, insert the following command:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/c8d530ca-60e3-40cf-961b-bc07dfe1bfe4.png" style="width:40.00em;height:8.42em;"/></div>
<p style="padding-left: 60px">To download any other tree, the syntax of the command will be as follows:</p>
<pre style="padding-left: 60px">    <strong>git clone git://kernel.ubuntu.com/ubuntu/ubuntu-&lt;release&gt;.git</strong></pre>
<ol start="5">
<li>The downloaded file will be in either GNU ZIP (<kbd>gzip</kbd>) format or <kbd>bzip2</kbd> format. After downloading the source file, you need to uncompress it. If the tarball is in <kbd>bzip2</kbd>, use the following command:</li>
</ol>
<pre class="mce-root" style="padding-left: 60px"><strong>tar xvjf linux-x.y.z.tar.bz2</strong></pre>
<p class="mce-root" style="padding-left: 60px">If it is compressed GNU ZIP format, use this command:</p>
<pre class="mce-root" style="padding-left: 60px"><strong>tar xvzf linux-x.y.z.tar.gz</strong></pre>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="mce-root">Using the different methods mentioned here, you are able to download the source code of Linux kernel. Using any option depends on the user's choice and preference.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring and building kernel</h1>
                </header>
            
            <article>
                
<p class="mce-root">The need to configure the kernel could arise for many reasons. You may want to resize the kernel to run only the necessary services or you may have to patch it to support new hardware not supported earlier by the kernel. It could be a daunting task for any system administrator and in this section, you will see how you can configure and build the kernel.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">It is always recommended you have ample space for kernels in the boot partition in any system. You should either choose the whole disk install option or set aside a minimum of 3 GB disk space for boot partition. Once you are done with the installation of your Linux distribution and have configured the required development packages, enable sudo for your user account. Now update the system, before you start with installing any packages:</p>
<pre>    <strong>sudo apt-get update &amp;&amp; sudo apt-get upgrade</strong></pre>
<p class="mce-root">After this, you need to install a few packages before getting started. This includes the packages mentioned here:</p>
<ul>
<li>Latest version of <kbd>gcc</kbd></li>
<li>ncurses development package</li>
<li>Packages needed for cross-compiling Linux kernels</li>
<li>Package to run make menuconfig</li>
</ul>
<p class="mce-root">To do so, use the command given here:</p>
<pre><strong>sudo apt-get install build-essential gcc libncurses5-dev ncurses-dev binutils-multiarch alien bc libelf-dev</strong></pre>
<p class="mce-root">These packages are used while configuring and compiling the Linux kernel on an <kbd>x86_64</kbd> system.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="mce-root">Once you are done with the steps in the <em>Getting ready</em> section, you can move on to the process of configuring and building the kernel. This process will take a lot of time, so be prepared:</p>
<ol>
<li>Download the Linux kernel by visiting<a href="http://www.kernel.org"> http://www.kernel.org</a> as shown in the screenshot here:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/9777a2d3-8ff1-4bd2-b024-1e9fa1f90d4c.png" style="width:40.75em;height:30.33em;"/></div>
<ol start="2">
<li>Or you can use the following command:</li>
</ol>
<pre style="padding-left: 60px"><strong>wget https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.14.47.tar.xz</strong></pre>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/9864d311-835c-49f0-974d-ea46271f55c6.png" style="width:63.08em;height:24.42em;"/></div>
<ol start="3">
<li><span class="IconPACKT">When the download is completed, move to the folder where the download has been saved. The command to do this will be:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><strong><img src="assets/1151a91e-8c8d-4cea-b134-0774a069b4be.png" style="width:35.08em;height:6.25em;"/></strong></div>
<ol start="4">
<li><span class="IconPACKT">Now extract the downloaded tar file to <kbd>/usr/src/</kbd> using the following command:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/284325cd-e7c7-4e2a-a933-e49453ef86f4.png" style="width:49.58em;height:22.25em;"/></div>
<ol start="5">
<li><span class="IconPACKT">Next, change to the folder where the files have been extracted.:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/8f80d916-2e50-4992-adfe-b8a0a39ae3da.png" style="width:53.75em;height:7.92em;"/></div>
<ol start="6">
<li><span class="IconPACKT">Now run the command to configure the Linux kernel for compiling and installing on the system:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/0628c2cd-007e-406e-bf4b-f850af828070.png" style="width:31.17em;height:16.33em;"/></div>
<div class="packt_infobox"><span class="IconPACKT">You may have to use <kbd>sudo</kbd> before the command if your account doesn't have admin privileges.</span></div>
<ol start="7">
<li><span class="IconPACKT">Once the previous command is executed, a pop-up window will appear containing lots of menus, as shown here. Select the items of the new configuration:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/2a73f181-5f9b-4084-9ad2-3046ea5f6611.png" style="width:56.08em;height:26.33em;"/></div>
<ol start="8">
<li><span class="IconPACKT">You need to check for the filesystems menu, as shown here:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/c1d33636-aa1c-4ace-9d9e-5058649cdb2d.png" style="width:50.58em;height:23.83em;"/></div>
<ol start="9">
<li><span class="IconPACKT">Under the menu, check whether <kbd>ext4</kbd> has been chosen or not, as shown in the screenshot. If it is not selected, you need to select it now:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/23002b47-a21f-439a-82c2-0bd4ff72da3e.png" style="width:57.83em;height:27.17em;"/></div>
<ol start="10">
<li><span class="IconPACKT">And then provide a name and save the configuration:</span></li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/86d05651-8a37-4e5f-bc5e-9e4c605b4c15.png" style="width:52.42em;height:23.17em;"/></div>
<ol start="11">
<li>Now compile the Linux kernel. The compile process will take around 40 to 50 minutes to complete, depending on the system configuration. Run the command as shown here:</li>
</ol>
<pre>    <strong>make -j 5<br/></strong></pre>
<p style="padding-left: 60px">The output for the preceding command is as shown in the following screenshot:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/5070db44-4f22-466b-859f-4bc8de0e608a.png" style="font-size: 1em;width:42.17em;height:18.92em;"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="mce-root">You first download the Linux kernel source and then, after extracting it to a particular location, you configure the kernel for the compilation process.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Installing and booting from a kernel</h1>
                </header>
            
            <article>
                
<p class="mce-root">After having spent a lot of time configuring and compiling the kernel, you can now start the process of installing the kernel to the local system.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">Before starting with the installation of the kernel, make sure you back up all your important data on the system. Also make a copy of <kbd>/boot/</kbd> onto external, storage which is formatted in the FAT32 filesystem. This will help repair the system if the installation process fails for any reason.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="mce-root">Once the kernel is compiled, you can start following the commands here to proceed with installing the kernel:</p>
<ol>
<li>Install the drivers by running the command, if activated as modules. <span>The command will copy the modules to a sub-directory of <kbd>/lib/modules</kbd></span>:</li>
</ol>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/4317fad9-bc0b-4bc0-a3ee-48bb623fb200.png" style="width:32.08em;height:17.83em;"/></div>
<ol start="2">
<li>Now run the following command to install the actual kernel:</li>
</ol>
<pre>    <strong>make install<br/></strong></pre>
<p style="padding-left: 60px">The preceding command will show the following output:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/9ea1de45-8e6f-46c8-851a-5eb2af16b026.png" style="width:40.58em;height:22.33em;"/></div>
<p class="mce-root CDPAlignLeft CDPAlign">This command executes <kbd>/sbin/installkernel</kbd>. The new kernel will be installed into <kbd>/boot/vmlinuz-{version}</kbd>. If a symbolic link already exists for <kbd>/boot/vmlinuz</kbd>, it will be refreshed by linking <kbd>/boot/vmlinuz</kbd> to the new kernel. The previously installed kernel will be available as <kbd>/boot/vmlinuz.old.</kbd> The same will happen for the config and <kbd>System.map</kbd> files.</p>
<ol start="3">
<li>Next, copy the kernel to <kbd>/boot</kbd> directory by running the following command:</li>
</ol>
<pre>    <strong>cp -v arch/x86/boot/bzImage /boot/vmlinuz-4.1.6</strong></pre>
<p style="padding-left: 60px"><span>The preceding command will show the following output:</span></p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/deca58cc-a89d-44b4-b703-28f49ef2fef3.png" style="width:42.67em;height:3.33em;"/></div>
<ol start="4">
<li>Now make an initial RAM disk:
<div class="CDPAlignCenter CDPAlign"><img class="gr-progress" src="assets/2ed5305c-9d31-4a41-b031-f2f1f5819135.png"/></div>
</li>
</ol>
<ol start="5">
<li>Next, we need to copy <kbd>System.map</kbd>, which contains the list of kernel symbols and their corresponding address. Run the given command to do this appending the kernel's name in the destination file:
<div class="CDPAlignCenter CDPAlign"><img src="assets/57756179-2cb7-45d8-9be4-123c6a0612ab.png" style="width:43.92em;height:2.67em;"/></div>
</li>
</ol>
<ol start="6">
<li>Next, create a <kbd>symlink /boot/System.map</kbd> file, which will point to <kbd>/boot/System.map-YourKernelName</kbd>, if <kbd>/boot</kbd> is on a filesystem that supports <kbd>symlinks</kbd>:
<div class="CDPAlignCenter CDPAlign"><img src="assets/40c27f8a-0fcd-4836-9b4a-72be98718abe.png"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 60px">If <kbd>/boot</kbd> is on a filesystem that does not support symlinks, just run <kbd>cp /boot/System.map-YourKernelName /boot/System.map</kbd></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="mce-root">Once the kernel is configured and compiled, it can be installed on the system. The first command will copy the modules to a sub-directory of <kbd>/lib/modules</kbd>. The second command executes <kbd>/sbin/installkernel</kbd>. Also, the new kernel will be installed into <kbd>/boot/vmlinuz-{version}</kbd>. While doing this, if a symbolic link already exists for <kbd>/boot/vmlinuz</kbd>, it will get refreshed by linking <kbd>/boot/vmlinuz</kbd> to the new kernel. And the previously installed kernel will be available as <kbd>/boot/vmlinuz.old</kbd>. The same will happen for the config and <kbd>System.map</kbd> files. Once everything is done, we can reboot the system to boot from the new kernel:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/8e74b13e-2b3f-4eb5-ae30-49d2ca3c6184.png" style="font-size: 1em;width:41.25em;height:11.33em;"/></div>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Kernel testing and debugging</h1>
                </header>
            
            <article>
                
<p class="mce-root">An important part of any open or closed software development cycle is testing and debugging. And the same applies to the Linux kernel. The end goal of testing and debugging is to ensure that the kernel is working in the same way as earlier, even after installing a new kernel source code<span class="MsoCommentReference">.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Configuring console for debugging using netconsole</h1>
                </header>
            
            <article>
                
<p class="mce-root">One of the biggest issues with the Linux kernel is kernel panic. It is similar to the <em>Blue Screen of Death</em> for Microsoft Windows operating systems. If the kernel panics, it will dump a lot of information on the screen and just stay there. It is very difficult to trace a kernel panic if the system is rebooted as no logs are created for it. To solve this issue, we can use Netconsole. It is a kernel module that helps by logging kernel <kbd>printk</kbd> messages over UDP. This is helpful with debugging problems when logging on disk fails.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">Before starting with the configuration of Netconsole, you need to know the MAC address of the system, where the UDP packets will be sent. This system can be called the receiver and it may be in the same subnet or a different one. These two cases are described here. Let's look at the first case, when receiver is in the same subnet:</p>
<ol>
<li>The IP address of the receiver in this example is <kbd>192.168.1.4</kbd>. We will send the UDP packets to this IP address using this command:
<div class="CDPAlignCenter CDPAlign"><img src="assets/e58fe079-3eec-4960-8007-f1a224a30f46.png" style="width:31.67em;height:7.92em;"/></div>
</li>
</ol>
<ol start="2">
<li>Now let's find the MAC address of the receiver system by executing the following command. Here, the IP address is of the receiver system:
<div class="CDPAlignCenter CDPAlign"><img src="assets/30f22507-aac8-4fc3-8696-295ec4590484.png" style="width:44.67em;height:15.00em;"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 60px">As you can see in the previous example, <kbd>90:00:4e:2f:ac:ef</kbd> is the MAC address we need. Let's look at the second case, when receiver is not in the same subnet.</p>
<ol start="3">
<li>In this case, we need to first find the default gateway. To do so, run the command shown here:
<div class="CDPAlignCenter CDPAlign"><img src="assets/d6d1bcfc-a459-4073-9cf5-f56a0f53e67e.png"/></div>
</li>
</ol>
<p style="padding-left: 60px">In this case, the default gateway is <kbd>192.168.1.1</kbd>.</p>
<ol start="4">
<li>We need to find the MAC address of the default gateway. First, send a packet to the default gateway:
<div class="CDPAlignCenter CDPAlign"/>
</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign"><img src="assets/40ad101a-e4b0-482a-bf4d-8fe00df53d0d.png" style="text-align: center;color: black;font-size: 1em;width:30.33em;height:7.58em;"/></p>
<ol start="5">
<li>Now let's find the MAC address:
<div class="CDPAlignCenter CDPAlign"><img src="assets/345dffb0-ced9-42e1-89dd-a97ffd388cdc.png" style="width:41.00em;height:12.42em;"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 60px">Here, <kbd>c0:3f:0e:10:c6:be</kbd> is the MAC address of the default gateway that we need. Now that we have the MAC address of the receiver, we can start with the configuration process of Netconsole.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p class="mce-root">To begin with, you need to change the kernel options at the boot time. If you are using GRUB as the bootloader, it will by default boot the kernel with the <strong>quiet splash</strong> option. However, you don't want that to happen, so you need to change the kernel options:</p>
<ol>
<li>First, create a backup of <kbd>/etc/default/grub</kbd>:
<div class="CDPAlignCenter CDPAlign"><img src="assets/5566afb3-6e7a-48dc-9ffd-7dc05e7d4e41.png" style="width:35.00em;height:10.25em;"/></div>
</li>
</ol>
<ol start="2">
<li>Now, open any editor of your choice to edit <kbd>/etc/default/grub</kbd>:
<div class="CDPAlignCenter CDPAlign"><img src="assets/5c483e39-1732-4a8d-bc64-881b0fc9a18a.png" style="width:34.50em;height:9.17em;"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 60px">Find the line <kbd>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash</kbd> and replace it with <kbd>GRUB_CMDLINE_LINUX_DEFAULT="debug ignore_loglevel"</kbd>:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/7acfcab7-3b60-4f79-932c-d606086f70fb.png" style="font-size: 1em;width:37.75em;height:11.50em;"/></div>
<ol start="3">
<li>Now run the command to update GRUB accordingly:
<div class="CDPAlignCenter CDPAlign"><img src="assets/a68f99fe-9625-4ee6-9c1d-feb2241a1f6e.png" style="width:45.83em;height:14.50em;"/></div>
</li>
</ol>
<ol start="4">
<li>Once you are done with these commands, you need to initialize Netconsole at boot time. For this, we first need to know the IP address and the interface of the <em>sender</em> system. This can be done by using the following command:
<div class="CDPAlignCenter CDPAlign"/>
</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign"><img src="assets/bd1732a0-7104-4683-9428-80bce6e8925a.png" style="text-align: center;color: black;font-size: 1em;width:41.58em;height:12.08em;"/></p>
<p class="mce-root" style="padding-left: 60px">You also need the IP address and MAC address of the receiver system, which we have already got in the <em>Getting ready</em> section.</p>
<ol start="5">
<li>Now let's start initializing Netconsole. First, let's get Net­con­sole to load on boot by adding the mod­ule to <kbd>/etc/modules</kbd>:
<div class="CDPAlignCenter CDPAlign"><img src="assets/e6d3648c-b7ad-4054-b4c0-3dc4821d2170.png" style="width:38.25em;height:11.92em;"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 60px">Next, make sure that it has the proper options configured as well. For this, add the module options to the <kbd>/etc/modprobe.d/netconsole.conf</kbd> file and run the following command:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/c5735fb3-d161-4e38-a35e-038bde21e7b9.png" style="width:43.42em;height:11.67em;"/></div>
<p class="mce-root" style="padding-left: 60px">In the previous command, the part that starts with <kbd>netconsole</kbd> has the following syntax:</p>
<pre class="mce-root" style="padding-left: 60px"><strong>netconsole=&lt;LOCAL_PORT&gt;@&lt;SENDER_IP_ADDRESS&gt;/&lt;SENDER_INTERFACE&gt;,&lt;REMOTE_PORT&gt;@&lt;RECEIVER_IP_ADDRESS&gt;/&lt;STEP_1_MAC_ADDRESS&gt;</strong></pre>
<p class="mce-root" style="padding-left: 60px">We have used <kbd>6666</kbd> for both the <kbd>&lt;LOCAL_PORT&gt;</kbd> and <kbd>&lt;REMOTE_PORT&gt;</kbd>.</p>
<ol start="6">
<li>Next, we need to set up the <em>receiver.</em></li>
</ol>
<p class="mce-root" style="padding-left: 60px">Depending on which version of Linux is being used as receiver, the command to set up the receiver may vary:</p>
<pre class="mce-root" style="padding-left: 60px"><strong>netcat -l -u 192.168.1.4 6666 | tee ~/netconsole.log</strong></pre>
<p class="mce-root" style="padding-left: 60px">Or try it without the IP address, if the previous command doesn't work:</p>
<pre class="mce-root" style="padding-left: 60px"><strong>netcat -l -u 6666 | tee ~/netconsole.log</strong></pre>
<ol start="7">
<li>If you are using a different variant of Linux that has a different version of Netcat, the following error message will be printed when you try the previous commands:
<div class="CDPAlignCenter CDPAlign"><img src="assets/dd9ea211-32b0-49bd-8832-87a4db9cf93c.png" style="width:40.75em;height:12.42em;"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 90px">If you get the error message, you can try this command:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/5831298f-33eb-4113-8055-efc90227018f.png" style="font-size: 1em;width:37.00em;height:9.50em;"/></div>
<ol start="8">
<li>Now let the previous command keep running.</li>
<li>Next, you need to check whether everything is working properly. Reboot the sender system and then execute the following command:</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign"><img src="assets/47bcf300-b319-485c-926a-04435d1047ed.png" style="text-align: center;color: black;font-size: 1em;width:45.08em;height:11.08em;"/></p>
<ol start="10">
<li>Now you need to check the receiver system to see whether the kernel messages have been received or not.</li>
<li>Once everything is done, press <em><span class="KeyPACKT">Ctrl</span></em> + <em><span class="KeyPACKT">C.</span></em> Then you can check for the messages in <kbd>~/netconsole.log</kbd>.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p class="mce-root">To capture kernel panic messages, we configure Netconsole, which logs the messages over the network. To do this, we need one more system on the network, which serves as receiver. Firstly, we try to find the MAC address of the receiver system. Then we change the kernel boot options. After updating GRUB, we start initializing Netconsole on the sender system that we want to debug. Finally, we set up the receiver system to start receiving the kernel messages.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p class="mce-root"><span class="NormalPACKTChar">If you are using a Windows system as receiver, then we can use Netcat for Windows as well, which is available at </span><kbd><span class="URLPACKT">http://joncraton.org/files/nc111nt.zip</span></kbd>.</p>
<p class="mce-root">Download the file from the given link and extract it somewhere like <kbd>C:\Users\Tajinder\Downloads\nc</kbd>.</p>
<p class="mce-root">Now open Command Prompt (<span class="packt_screen">Start</span> | <kbd>Run</kbd> | <kbd>cmd</kbd>). Then move to the folder where you have extracted Netcat:</p>
<div class="mce-root CDPAlignCenter CDPAlign"><img src="assets/324cadb2-8bae-45d8-8650-5931b0f8cef0.png" style="font-size: 1em;border: 1em solid black;text-align: center;width:35.83em;height:10.17em;"/></div>
<p class="mce-root">Next, run the following command:</p>
<div class="CDPAlignCenter CDPAlign"><img src="assets/b9deec73-612a-46ec-ac0e-0b5973b0fc1f.png" style="font-size: 1em;width:42.42em;height:10.42em;"/></div>
<p class="mce-root">Here, <kbd>192.168.1.3</kbd> is the same as <kbd>&lt;RECEIVER_IP_ADDRESS&gt;</kbd>. Let t<span>he previous command run and continue with the commands in step 9. Once it's done, press</span> <em><span class="KeyPACKT">Ctrl</span></em> + <em><span class="KeyPACKT">C</span></em><span>. You will find the messages in <kbd>netconsole.txt.</kbd></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Debugging kernel boot</h1>
                </header>
            
            <article>
                
<p class="mce-root">Sometimes your system might fail to boot due to changes within the kernel. Hence it is important that when creating reports about these failures, all the appropriate information about debugging is included. This will be useful for the kernel team in resolving the issue.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>If you are trying to capture error messages that appear during boot, then it is better to boot the kernel with the <kbd>quiet</kbd> and <kbd>splash</kbd> options removed. This helps you see the messages, if any, that appear on the screen.</p>
<p>To edit boot option parameters, do the following:</p>
<ol>
<li>Boot the machine.</li>
<li>During the BIOS screen, press the <em>Shift </em>key and hold it down. You should see the <span class="packt_screen">GRUB</span> menu after the BIOS loads:
<div class="CDPAlignCenter CDPAlign"><img src="assets/ed56ecff-eea0-4099-aedf-026449a44811.png" style="width:39.75em;height:10.92em;"/></div>
</li>
</ol>
<ol start="3">
<li>Navigate to the kernel entry you want to boot and press <em>e</em>.</li>
<li class="mce-root">Then remove the <kbd>quiet</kbd><strong> </strong>and <kbd>splash</kbd><strong> </strong>keywords (found in the line starting with <kbd>linux</kbd>).
<div class="CDPAlignCenter CDPAlign"><img src="assets/2e712f2b-4c42-48ef-a0df-2e59b3e94867.png" style="font-family: Merriweather, serif;font-size: 1em;width:41.50em;height:21.00em;"/></div>
</li>
<li>Press <em><span class="KeyPACKT">Ctrl + X</span></em> to boot.</li>
</ol>
<p class="mce-root">You can see the error messages, if any, on the screen. Depending on the type of error messages you encounter, there are other boot options you could try. For example, if you notice ACPI errors, try booting with the <kbd>acpi=off</kbd><strong> </strong>boot option.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Kernel errors</h1>
                </header>
            
            <article>
                
<p class="mce-root">Kernel panic or kernel error is a term used when a Linux system has come to halt and seems unresponsive. When the kernel detects an abnormal situation, it voluntarily halts the system activity. When the Linux system detects an internal fatal error from which it cannot recover safely, it generates a kernel panic.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Causes of kernel errors</h1>
                </header>
            
            <article>
                
<p>In Linux, a kernel error can be caused due to various reasons. Here we will discuss a few of the reasons:</p>
<ul>
<li><strong>Hardware – Machine Check Exceptions</strong>: This type of kernel error is caused when a component failure is detected and reported by the hardware through an exception. This typically looks like this:</li>
</ul>
<pre style="padding-left: 60px"><strong>System hangs or kernel panics with MCE (Machine Check Exception) in /var/log/messages file.</strong><br/><strong>System was not responding. Checked the messages in netdump server. Found the following messages ..."Kernel panic - not syncing: Machine check".</strong><br/><strong>System crashes under load.</strong><br/><strong>System crashed and rebooted.</strong><br/><strong>Machine Check Exception panic</strong></pre>
<ul>
<li><strong>Error Detection and Correction (EDAC):</strong> If any memory chip and PCI transfer error is detected, the hardware mechanism reports it causing EDA errors. This error gets reported in <kbd>/sys/devices/system/edac/{mc/,pci}</kbd> and typically looks like this:</li>
</ul>
<pre style="padding-left: 60px"><strong>Northbridge Error, node 1, core: -1</strong><br/><strong>K8 ECC error.</strong><br/><strong>EDAC amd64 MC1: CE ERROR_ADDRESS= 0x101a793400</strong><br/><strong>EDAC MC1: INTERNAL ERROR: row out of range (-22 &gt;= 8)</strong><br/><strong>EDAC MC1: CE - no information available: INTERNAL ERROR</strong><br/><strong>EDAC MC1: CE - no information available: amd64_edacError Overflow</strong></pre>
<ul>
<li><strong>Non-Maskable Interrupts (NMIs)</strong>: When a standard operating system mechanism is unable to ignore or mask out an interrupt, it is called a <strong>Non-Maskable Interrupt</strong> (<strong>NMI</strong>). It is generally used for critical hardware errors. A sample NMI error appearing in <kbd>/var/log/messages</kbd> would look like this:</li>
</ul>
<pre style="padding-left: 60px"><strong>kernel: Dazed and confused, but trying to continue</strong><br/><strong>kernel: Do you have a strange power saving mode enabled?</strong><br/><strong>kernel: Uhhuh. NMI received for unknown reason 21 on CPU 0</strong><br/><strong>kernel: Dazed and confused, but trying to continue</strong><br/><strong>kernel: Do you have a strange power saving mode enabled?</strong><br/><strong>kernel: Uhhuh. NMI received for unknown reason 31 on CPU 0.</strong></pre>
<ul>
<li><strong>Software – The BUG() macro</strong>: When any abnormal situation is seen indicating a programming error, kernel code causes this kind of kernel error. It typically looks like this:</li>
</ul>
<pre class="mce-root" style="padding-left: 60px"><strong>NFS client kernel crash because async task already queued hitting BUG_ON(RPC_IS_QUEUED(task)); in __rpc_executekernel BUG at net/sunrpc/sched.c:616!invalid opcode: 0000 [#1] SMPlast sysfs file: /sys/devices/system/cpu/cpu15/cache/index2/shared_cpu_mapCPU 8Modules linked in: nfs lockd fscache nfs_acl auth_rpcgss pcc_cpufreq sunrpc power_meter hpilohpwdt igb mlx4_ib(U) mlx4_en(U) raid0 mlx4_core(U) sg microcode serio_raw iTCO_wdtiTCO_vendor_support ioatdma dca shpchp ext4 mbcache jbd2 raid1 sd_mod crc_t10dif mpt2sasscsi_transport_sas raid_class ahci dm_mirror dm_region_hash dm_log dm_mod[last unloaded: scsi_wait_scan]</strong></pre>
<ul>
<li><strong>Software – Pseudo-hangs</strong>: These type of errors are commonly encountered, when the system appears to be hung, and could have several reasons for this kind of behavior such as:
<ul>
<li><strong>Livelock</strong>: When running a real-time kernel, if application load is too high, it could lead the system to a situation where it becomes unresponsive. The system is not completely hung, but appears to be as it is moving so slowly.</li>
</ul>
</li>
</ul>
<p>A sample error message getting logged in <kbd>/var/log/messages</kbd>, when the system is frequently hung, looks like this:</p>
<pre><strong>INFO: task cmaperfd:5628 blocked for more than 120 seconds.</strong><br/><strong>"echo 0 &gt; /proc/sys/kernel/hung_task_timeout_secs" disables this message.</strong><br/><strong>cmaperfd D ffff810009025e20 0 5628 1 5655 5577 (NOTLB)</strong><br/><strong>ffff81081bdc9d18 0000000000000082 0000000000000000 0000000000000000</strong><br/><strong>0000000000000000 0000000000000007 ffff81082250f040 ffff81043e100040</strong><br/><strong>0000d75ba65246a4 0000000001f4db40 ffff81082250f228 0000000828e5ac68</strong><br/><strong>Call Trace:</strong><br/><strong>[&lt;ffffffff8803bccc&gt;]</strong><br/><strong>:jbd2:start_this_handle+0x2ed/0x3b7</strong><br/><strong>[&lt;ffffffff800a3c28&gt;] autoremove_wake_function+0x0/0x2e</strong><br/><strong>[&lt;ffffffff8002d0f4&gt;] mntput_no_expire+0x19/0x89</strong><br/><strong>[&lt;ffffffff8803be39&gt;]</strong><br/><strong>:jbd2:jbd2_journal_start+0xa3/0xda</strong><br/><strong>[&lt;ffffffff8805e7b0&gt;]</strong><br/><strong>:ext4:ext4_dirty_inode+0x1a/0x46</strong><br/><strong>[&lt;ffffffff80013deb&gt;] __mark_inode_dirty+0x29/0x16e</strong><br/><strong>[&lt;ffffffff80041bf5&gt;] inode_setattr+0xfd/0x104</strong><br/><strong>[&lt;ffffffff8805e70c&gt;] :ext4:ext4_setattr+0x2db/0x365</strong><br/><strong>[&lt;ffffffff88055abc&gt;] :ext4:ext4_file_open+0x0/0xf5</strong><br/><strong>[&lt;ffffffff8002cf2b&gt;] notify_change+0x145/0x2f5</strong><br/><strong>[&lt;ffffffff800e45fe&gt;] sys_fchmod+0xb3/0xd7</strong></pre>
<ul>
<li><strong>Software – Out-of-Memory killer</strong>: This type of error or panic is triggered when some memory needs to be released by killing a few processes, when a case of memory starvation occurs. This error typically looks like this:</li>
</ul>
<pre style="padding-left: 60px"><strong>Kernel panic - not syncing: Out of memory and no killable processes...</strong></pre>
<p class="mce-root">Whenever a kernel panic or error occurs, you may have to analyze these errors to diagnose and troubleshoot them. This can be done using the Kdump utility. Kdump can be configured using the following steps:</p>
<ol>
<li class="mce-root">Install <kbd>kexec-tools</kbd>.</li>
<li class="mce-root">Edit the <kbd>/etc/grub.conf</kbd> file, and insert <kbd>crashkernel=&lt;reservered-memory-setting&gt;</kbd> at the end of kernel line.</li>
<li class="mce-root">Edit <kbd>/etc/kdump.conf</kbd> and specify the destination for sending the output of <kbd>kexec</kbd>, that is <kbd>vmcore</kbd>.</li>
<li class="mce-root">Discard unnecessary memory pages and compress only the ones that are needed by configuring the Core collector.</li>
</ol>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Checking kernel parameters using Lynis</h1>
                </header>
            
            <article>
                
<p class="mce-root">Any operating system is as strong as its weakest link. In the case of Linux, any weakness in its kernel would imply a total compromise of the system. Hence it is necessary to check the security configuration of the Linux kernel.</p>
<p class="mce-root">In this topic, we will see how to use Lynis to check for kernel parameters automatically. Lynis has several predefined key pairs to look for in kernel configuration and accordingly provide advice.</p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p class="mce-root">To view or edit any security related parameter of Linux kernel, there is the <kbd>/etc/sysctl.conf</kbd> file. All the parameters are stored in this file and this is read during boot time. If you wish to see the available kernel parameters in this file, you can do so by running the <kbd>command:sysctl -a</kbd>. This command will display an extensiv<span>e list of configuration settings. The kernel security parameters are also in this list</span>. Lynis <span>helps check the kernel security parameters in this file automatically, thus avoiding the hassle of checking each parameter manually</span>. To <span>use Lynis, write access to <kbd>/tmp</kbd> is needed by the user account running the tool.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p>Lynis is an open source security tool that helps with audits of systems running UNIX derivatives such as Linux, macOS, BSD, Solaris, AIX, and others.</p>
<p>Here is the list of following steps:</p>
<ol>
<li>The first step to using Lynis is to download its package. This can be done from this link:</li>
</ol>
<p style="padding-left: 90px"><a href="https://cisofy.com/downloads/lynis/">https://cisofy.com/downloads/lynis/</a></p>
<div class="CDPAlignCenter CDPAlign" style="padding-left: 60px"><img src="assets/0018eb17-54da-4764-9e45-3aae1f9de4b2.png" style="font-size: 1em;"/></div>
<ol start="2">
<li>Once you click on download, you will get a tarball file to save. Save it in any folder on your system:
<div class="CDPAlignCenter CDPAlign"><img src="assets/d11f2c79-6fdf-4952-b8f2-3601b41dfd8e.png" style="width:19.75em;height:2.08em;"/></div>
</li>
</ol>
<ol start="3">
<li>The next step is to extract the content from the tar file. You do this by running this command:
<div class="CDPAlignCenter CDPAlign"><img src="assets/8781ba0c-d30c-430b-a75f-eb54292914d6.png" style="width:32.92em;height:2.08em;"/></div>
</li>
</ol>
<p class="mce-root" style="padding-left: 90px"><span>Once the extraction is complete, you will get a directory named <kbd>lynis</kbd> in the same directory.</span></p>
<ol start="4">
<li>Move inside the <kbd>lynis</kbd> directory and list the files present inside it:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/52b1e1c5-4731-468c-8444-4ca5e3684091.png" style="font-size: 1em;"/></p>
<ol start="5">
<li>Inside the <kbd>lynis</kbd> directory, among other files, you see an executable file again named <kbd>lynis</kbd>. Once you run this file, you will be able to see all the options available for using the lynis tool. So you run the tool as shown:
<div class="CDPAlignCenter CDPAlign"><img src="assets/d219f67e-c7f2-417a-9f91-85e1b48ceecc.png" style="width:58.92em;height:39.08em;"/></div>
</li>
</ol>
<ol start="5">
<li>
<div class="CDPAlignLeft CDPAlign">To audit the kernel parameters you use the <kbd>audit system</kbd> parameter. Once you run Lynis using this parameter, it will start auditing the system:</div>
</li>
</ol>
<p class="mce-root CDPAlignCenter CDPAlign" style="padding-left: 60px"><img src="assets/643312f5-24d3-4016-a60e-1925bc5bff8b.png" style="color: black;font-size: 1em;width:36.08em;height:23.25em;"/></p>
<p class="mce-root" style="padding-left: 60px"><span>Among the results, you will also get the list of kernel parameters:</span></p>
<div class="mce-root CDPAlignCenter CDPAlign" style="padding-left: 60px"><img src="assets/ba9b0b36-87b9-4504-a586-0a1e644efa3d.png" style="color: black;font-size: 1em;width:37.33em;height:26.08em;"/></div>
<ol start="7">
<li>The kernel parameters will be displayed in the results, as shown here:</li>
</ol>
<div class="CDPAlignCenter CDPAlign"><img src="assets/84f24478-2d19-4430-b4a3-3e31704e657d.png" style="width:43.33em;height:16.25em;"/></div>
<ol start="8">
<li>Based on the OS and kernel version, the number of parameters may change. If any parameter is incorrectly configured, Lynis will inform you and provide suggestions. </li>
</ol>


            </article>

            
        </section>
    </body></html>