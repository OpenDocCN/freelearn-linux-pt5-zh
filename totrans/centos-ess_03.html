<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Getting Started with systemd and fleet" id="aid-NQU21"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Getting Started with systemd and fleet</h1></div></div></div><p>In this chapter, we will cover the basics of systemd and <code class="literal">fleet</code>, which includes system unit files. We will demonstrate how to use a <code class="literal">fleet</code> to launch Docker containers.</p><p>We will cover the following topics in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Getting started with <code class="literal">systemd</code></li><li class="listitem">Getting started with <code class="literal">fleet</code></li></ul></div><div class="section" title="Getting started with systemd"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Getting started with systemd</h1></div></div></div><p>You are going to<a id="id34" class="indexterm"/> learn what <code class="literal">systemd</code> is about and how to use <code class="literal">systemctl</code> to control <code class="literal">systemd</code> units.</p><div class="section" title="An overview of systemd"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec12"/>An overview of systemd</h2></div></div></div><p>The <code class="literal">systemd</code> is an<a id="id35" class="indexterm"/> init system used by CoreOS for starting, stopping, and managing processes.</p><p>Basically, it is a system and service manager for CoreOS. On CoreOS, <code class="literal">systemd</code> will be used almost exclusively to manage the life cycle of Docker containers. The <code class="literal">systemd</code> records initialization instructions for each process in the unit file, which has many types, but we will mainly be covering the "service" unit file, as covering all of them is beyond the scope for this book.</p></div><div class="section" title="The systemd unit files"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec13"/>The systemd unit files</h2></div></div></div><p>The <code class="literal">systemd</code> records initialization<a id="id36" class="indexterm"/> instructions/properties for each process in the "service" unit file we want to run. On CoreOS, unit files installed by the user manually or via <a id="id37" class="indexterm"/>cloud-init are placed at <code class="literal">/etc/systemd/system</code>, which is a read-write filesystem, as a large part of CoreOS has only read-only access. Units curated by the CoreOS team are placed in <code class="literal">/usr/lib64/system/system</code>, and ephemeral units, which exist for the runtime of a single boot, are located at <code class="literal">/run/system/system</code>. This is really good to know<a id="id38" class="indexterm"/> for debugging <code class="literal">fleet</code> services.</p><p>Okay, let's create a unit file to test <code class="literal">systemd</code>:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Boot your CoreOS VM installed in the first chapter and log in to the host via <code class="literal">ssh</code>.</li><li class="listitem">Let's create a<a id="id39" class="indexterm"/> simple unit file, <code class="literal">hello.service</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo vi /etc/systemd/system/hello.service</strong></span>
</pre></div><p>Press <span class="emphasis"><em>I</em></span> and copy and paste the following text (or use the provided example file, <code class="literal">hello.service</code>):</p><div class="informalexample"><pre class="programlisting">[Unit]
Description=HelloWorld
# this unit will only start after docker.service
After=docker.service
Requires=docker.service

[Service]
TimeoutStartSec=0
# busybox image will be pulled from docker public registry
ExecStartPre=/usr/bin/docker pull busybox
# we use rm just in case the container with the name "busybox1" is left 
ExecStartPre=-/usr/bin/docker rm busybox1
# we start docker container
ExecStart=/usr/bin/docker run --rm --name busybox1 busybox /bin/sh -c "while true; do echo Hello World; sleep 1; done"
# we stop docker container when systemctl stop is used
ExecStop=/usr/bin/docker stop busybox1

[Install]
WantedBy=multi-user.target</pre></div></li><li class="listitem">Press <span class="emphasis"><em>Esc</em></span> and then type :<code class="literal">wq</code> to save the file.</li><li class="listitem">To start the new unit, run this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl enable /etc/systemd/system/hello.service</strong></span>
</pre></div><p>Created a symlink from <code class="literal">/etc/systemd/system/multi-user.target.wants/hello.service</code> to <code class="literal">/etc/systemd/system/hello.service</code>.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl start hello.service</strong></span>
</pre></div></li><li class="listitem">Let's verify<a id="id40" class="indexterm"/> that the <code class="literal">hello.service</code> unit got started:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ journalctl -f -u hello.service</strong></span>
</pre></div><p>
<code class="literal">#</code> You should <a id="id41" class="indexterm"/>see the unit's output similar to this:</p><div class="mediaobject"><img src="../Images/image00112.jpeg" alt="The systemd unit files"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Also, you can check out the list of containers running with <code class="literal">docker ps</code>.</p><p>In the previous steps, we created the <code class="literal">hello.service</code> system unit, enabled and started it, and checked that unit's log file with <code class="literal">journalctl</code>.</p><div class="note" title="Note"><h3 class="title"><a id="note04"/>Note</h3><p>To read about more<a id="id42" class="indexterm"/> advanced use of the <code class="literal">systemd</code> unit files, go to <a class="ulink" href="https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd">https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd</a>.</p></div></div><div class="section" title="An overview of systemctl"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec14"/>An overview of systemctl</h2></div></div></div><p>The <code class="literal">systemctl</code> is used to<a id="id43" class="indexterm"/> control and provide an introspection of the state of the <code class="literal">systemd</code> system and its units.</p><p>It is like your<a id="id44" class="indexterm"/> interface to a system (similar to <code class="literal">supervisord</code>/<code class="literal">supervisordctl</code> from other Linux distribution), as all processes on a single machine are started and managed by <code class="literal">systemd</code>, which includes <code class="literal">docker</code> containers too.</p><p>We have already used it in the preceding example to enable and start the <code class="literal">hello.service</code> unit.</p><p>The following are some useful <code class="literal">systemctl</code> commands, with their purposes:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Checking the status of the unit:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl status hello.service</strong></span>
</pre></div><p>You should see a similar output as follows:</p><div class="mediaobject"><img src="../Images/image00113.jpeg" alt="An overview of systemctl"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">Stopping<a id="id45" class="indexterm"/> the service:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl stop hello.service</strong></span>
</pre></div></li><li class="listitem">You might need to kill the service, but that will not stop the <code class="literal">docker</code> container:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl kill hello.service</strong></span>
<span class="strong"><strong>$ docker ps</strong></span>
</pre></div><p>You should see a similar output as follows:</p><div class="mediaobject"><img src="../Images/image00114.jpeg" alt="An overview of systemctl"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">As you can see, the <code class="literal">docker</code> container is still running. Hence, we need to stop it with the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ docker stop busybox1</strong></span>
</pre></div></li><li class="listitem">Restarting the service:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl restart hello.service</strong></span>
</pre></div></li><li class="listitem">If you have changed <code class="literal">hello.service</code>, then before restarting, you need to reload all the service files:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl daemon-reload</strong></span>
</pre></div></li><li class="listitem">Disabling the service:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo systemctl disable hello.service</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>The <code class="literal">systemd</code> service units can only run and be controlled on a single machine, and they should better be<a id="id46" class="indexterm"/> used for simpler tasks, for example, to download some files on reboot and so on.</p><p>You will continue learning about <code class="literal">systemd</code> in the next topic and in later chapters.</p></div></div></div>
<div class="section" title="Getting started with fleet"><div class="titlepage" id="aid-OPEK2"><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Getting started with fleet</h1></div></div></div><p>We use <code class="literal">fleet</code> to take advantage of <code class="literal">systemd</code> at the higher level. The <code class="literal">fleet</code> is a cluster manager that controls <code class="literal">systemd</code> at the cluster level. You can even use it on a single machine and get <a id="id47" class="indexterm"/>all the advantages of <code class="literal">fleet</code> there too.</p><p>It encourages users to write applications as small, ephemeral units that can be easily migrated around a cluster of self-updating CoreOS machines.</p><div class="section" title="The fleet unit files"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec15"/>The fleet unit files</h2></div></div></div><p>The <code class="literal">fleet</code> unit<a id="id48" class="indexterm"/> files are regular <code class="literal">systemd</code> units combined with specific<a id="id49" class="indexterm"/> <code class="literal">fleet</code> properties.</p><div class="mediaobject"><img src="../Images/image00115.jpeg" alt="The fleet unit files"/></div><p style="clear:both; height: 1em;"> </p><p>They are the primary interaction with <code class="literal">fleet</code>. As in the <code class="literal">systemd</code> units, the <code class="literal">fleet</code> units define what you want to do and how <code class="literal">fleet</code> should do it. The <code class="literal">fleet</code> will schedule a valid unit file to the single machine or a machine in a cluster, taking in mind the <code class="literal">fleet</code> special properties from the <code class="literal">[X-Fleet]</code> section, which replaces the <code class="literal">systemd</code> unit's <code class="literal">[Install]</code> section. The rest of <code class="literal">systemd</code> sections are same in <code class="literal">fleet</code> units.</p><p>Let's overview the specific options of <code class="literal">fleet</code> for the <code class="literal">[X-Fleet]</code> section:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><code class="literal">MachineID</code>: This unit <a id="id50" class="indexterm"/>will be scheduled on the machine identified by a given string.</li><li class="listitem"><code class="literal">MachineOf</code>: This limits<a id="id51" class="indexterm"/> eligible machines to the one that hosts a specific unit.</li><li class="listitem"><code class="literal">MachineMetadata</code>: This limits eligible<a id="id52" class="indexterm"/> machines to those hosts with this specific metadata.</li><li class="listitem"><code class="literal">Conflicts</code>: This prevents <a id="id53" class="indexterm"/>a unit from being collocated with other <a id="id54" class="indexterm"/>units using glob-matching on other unit names.</li><li class="listitem"><code class="literal">Global</code>: Schedule this unit on all machines in the cluster. A unit is considered invalid if options <a id="id55" class="indexterm"/>other than MachineMetadata are provided alongside <code class="literal">Global=true</code>.</li></ul></div><p>An example of how a <code class="literal">fleet</code> unit file can be written with the [X-Fleet] section is as follows:</p><div class="informalexample"><pre class="programlisting">[Unit]
Description=Ping google

[Service]
ExecStart=/usr/bin/ping google.com

[X-Fleet]
MachineMetadata=role=check
Conflicts=ping.*</pre></div><p>So, let's see how <code class="literal">Conflicts=ping*</code> works. For instance, we have two identical <code class="literal">ping.1.service</code> and <code class="literal">ping.2.service</code> files, and we run on our cluster using the following code:</p><div class="informalexample"><pre class="programlisting">fleetctl start ping.* </pre></div><p>This will schedule two <code class="literal">fleet</code> units on two separate cluster machines. So, let's convert the <code class="literal">systemd</code> unit called <code class="literal">hello.service</code> that we previously used to <code class="literal">fleet</code> unit.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">As usual, you need to log in to the host via <code class="literal">ssh</code> with <code class="literal">vagrant ssh</code>.</li><li class="listitem">Now let's create a simple unit file with the new name <code class="literal">hello1.service</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo vi hello1.service</strong></span>
</pre></div><p>Press <span class="emphasis"><em>I</em></span> and copy and paste the text as follows:</p><div class="informalexample"><pre class="programlisting">[Unit]
Description=HelloWorld
# this unit will only start after docker.service
After=docker.service
Requires=docker.service

[Service]
TimeoutStartSec=0
# busybox image will be pulled from docker public registry
ExecStartPre=/usr/bin/docker pull busybox
# we use rm just in case the container with the name "busybox2" is left 
ExecStartPre=-/usr/bin/docker rm busybox2
# we start docker container
ExecStart=/usr/bin/docker run --rm --name busybox2 busybox /bin/sh -c "while true; do echo Hello World; sleep 1; done"
# we stop docker container when systemctl stop is used
ExecStop=/usr/bin/docker stop busybox1

[X-Fleet]</pre></div></li><li class="listitem">Press <span class="emphasis"><em>Esc</em></span> and<a id="id56" class="indexterm"/> then type :<code class="literal">wq</code> to save the file.<p>As you can see, we have the <code class="literal">[X-Fleet]</code> section empty for now because we have nothing to use there yet. We will cover that part in more detail in the upcoming chapters.</p></li><li class="listitem">First, we need to submit our <code class="literal">fleet</code> unit :<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl submit hello1.service</strong></span>
</pre></div></li><li class="listitem">Let's verify that our <code class="literal">fleet</code> unit files:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl list-unit-files</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00116.jpeg" alt="The fleet unit files"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">To start the new unit, run this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl start hello1.service</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00117.jpeg" alt="The fleet unit files"/></div><p style="clear:both; height: 1em;"> </p><p>The preceding commands have submitted and started <code class="literal">hello1.service</code>.</p><p>Let's verify that our new <code class="literal">fleet</code> unit is running:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl list-units</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00118.jpeg" alt="The fleet unit files"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Okay, it's now<a id="id57" class="indexterm"/> time to overview the <code class="literal">fleetctl</code> commands.</p></div><div class="section" title="An overview of fleetctl"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec16"/>An overview of fleetctl</h2></div></div></div><p>The <code class="literal">fleetctl</code> commands are <a id="id58" class="indexterm"/>very similar to <code class="literal">systemctl</code> commands— you can see this as follows—and we do not have to use <code class="literal">sudo</code> with <code class="literal">fleetctl</code>. Here are <a id="id59" class="indexterm"/>some tasks you can perform, listed with the required commands:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Checking the status of the unit:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl status hello1.service</strong></span>
</pre></div></li><li class="listitem">Stopping the service:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl stop hello1.service</strong></span>
</pre></div></li><li class="listitem">Viewing the service file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl cat hello1.service</strong></span>
</pre></div></li><li class="listitem">If you want to just upload the unit file:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl submit hello1.service</strong></span>
</pre></div></li><li class="listitem">Listing all running fleet units:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl list-units</strong></span>
</pre></div></li><li class="listitem">Listing fleet cluster machines:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl list-machines</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00119.jpeg" alt="An overview of fleetctl"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>We see just one machine, as in our case, as we have only one machine running there.</p><p>Of course, if we want to see the <code class="literal">hello1.service</code> log output, we still use the same systemd <code class="literal">journalctl</code> command, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ journalctl -f -u hello1.service</strong></span>
</pre></div><p>You should see the unit's output similar to this:</p><div class="mediaobject"><img src="../Images/image00120.jpeg" alt="An overview of fleetctl"/></div><p style="clear:both; height: 1em;"> </p></div></div>
<div class="section" title="References" id="aid-PNV61"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec21"/>References</h1></div></div></div><p>You can read<a id="id60" class="indexterm"/> more about these<a id="id61" class="indexterm"/> topics at the given URLs:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong>systemd unit files</strong></span>: <a class="ulink" href="https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd/">https://coreos.com/docs/launching-containers/launching/getting-started-with-systemd/</a></li><li class="listitem"><span class="strong"><strong>fleet unit files</strong></span>: <a class="ulink" href="https://coreos.com/docs/launching-containers/launching/fleet-unit-files/">https://coreos.com/docs/launching-containers/launching/fleet-unit-files/</a></li></ul></div></div>
<div class="section" title="Summary" id="aid-QMFO1"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Summary</h1></div></div></div><p>In this chapter, you learned about CoreOS's <code class="literal">systemd</code> init system. You also learned how to create and control system and <code class="literal">fleet</code> service units with <code class="literal">systemctl</code> and <code class="literal">fleetctl</code>.</p><p>In the next chapter, you will learn how to set up and manage CoreOS clusters.</p></div></body></html>