<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Securing Your System"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Securing Your System</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up a Linux firewall</li><li class="listitem" style="list-style-type: disc">Allowing access to a service through the firewall</li><li class="listitem" style="list-style-type: disc">Verifying your firewall by port scanning</li><li class="listitem" style="list-style-type: disc">Turning off unnecessary services</li><li class="listitem" style="list-style-type: disc">Verifying the strength of passwords</li><li class="listitem" style="list-style-type: disc">Disabling root login over SSH</li><li class="listitem" style="list-style-type: disc">Restricting Webmin access to a specific IP</li><li class="listitem" style="list-style-type: disc">Connecting to Webmin securely over an SSH tunnel</li><li class="listitem" style="list-style-type: disc">Closing inactive Webmin sessions automatically</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec35"/>Introduction</h1></div></div></div><p>Some people say that the only secure machine is one that is switched off. This may be true, but that machine is not very useful. If you want to make your server more functional, you'll have to turn it on and most likely expose it to the curious eyes of the Internet.</p><p>Online computer security<a id="id151" class="indexterm"/> is a topic large enough to deserve its own book. In fact, a whole shelf of such books is readily available. In this chapter, we will learn basic techniques, which will allow you to secure your server before putting it up online. If your server is exposed to the Internet, it will be a good idea to follow up by doing more in-depth security research and monitor what's happening to your machine on a day-to-day basis. Because this is a book on Webmin, we will only address topics in which Webmin can assist you.</p><p>This chapter is divided into three parts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We'll begin by running through a basic checklist of security issues that every system administrator should keep in mind. We'll point to the recipes in this book if Webmin can assist you with these topics.</li><li class="listitem" style="list-style-type: disc">The first six recipes in this chapter cover topics related to general system security.</li><li class="listitem" style="list-style-type: disc">The remaining recipes refer to securing Webmin itself.</li></ul></div><div class="section" title="Server security checklist"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec93"/>Server security checklist</h2></div></div></div><p>There are a number of <a id="id152" class="indexterm"/>basic security precautions that you should undertake on any computer system exposed on the Internet. This list is not comprehensive; there are other things you might probably want to do, but it's a good starting point and you shouldn't be ignoring these areas.</p><div class="section" title="Keeping your system up-to-date"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec18"/>Keeping your system up-to-date</h3></div></div></div><p>Software is never perfect and mistakes are discovered every day. Some of these mistakes are merely inconvenient, but others have the potential to be exploited by nefarious people to break into your machine. It's a critical part of an online system's maintenance to be up-to-date with security patches and system updates. Refer to the <span class="emphasis"><em>Updating the installed packages to the latest versions</em></span> and <span class="emphasis"><em>Getting an e-mail when new versions of packages become available</em></span> recipes from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1,</a> <span class="emphasis"><em>Setting Up Your System</em></span>, for information about keeping yourself updated.</p></div><div class="section" title="Turning off unnecessary services"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec19"/>Turning off unnecessary services</h3></div></div></div><p>A security flaw<a id="id153" class="indexterm"/> in your<a id="id154" class="indexterm"/> FTP server software will not be very dangerous if this service is not running. It's a good idea to switch off all the unessential services to minimize your system's exposure. Refer to the <span class="emphasis"><em>Turning off unnecessary services</em></span> and <span class="emphasis"><em>Verifying your firewall by port scanning</em></span> recipes in this chapter for more information on this topic.</p></div><div class="section" title="Building a firewall around your system"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec20"/>Building a firewall around your system</h3></div></div></div><p>You can use<a id="id155" class="indexterm"/> packet-filtering<a id="id156" class="indexterm"/> software to restrict access to your system. You can decide whether you want to allow only people from certain parts of the Internet to connect, which ports should accept connections, or whether some services will be available only locally. Refer to the <span class="emphasis"><em>Setting up a Linux firewall</em></span> and <span class="emphasis"><em>Allowing access to a service through the firewall</em></span> recipes in this chapter for more information.</p></div><div class="section" title="Performing backups"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec21"/>Performing backups</h3></div></div></div><p>In case something does go <a id="id157" class="indexterm"/>wrong, it's important to keep a backup copy of all your essential data, preferably on another system in another location. Refer to <a class="link" href="ch07.html" title="Chapter 7. Backing Up Your System">Chapter 7</a>, <span class="emphasis"><em>Backing Up Your System</em></span>, for more information.</p></div><div class="section" title="Monitoring your system"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec22"/>Monitoring your system</h3></div></div></div><p>If something goes wrong <a id="id158" class="indexterm"/>on your server, it's important that you are the first one to know about it. Keep an eye on your system's logs and set up your system to send you automated e-mails with log updates. If someone breaks into your system, they may tamper with the logs. So, it's a good idea to keep logs on a separate dedicated logging server. For more information, look at <a class="link" href="ch05.html" title="Chapter 5. Monitoring Your System">Chapter 5</a>, <span class="emphasis"><em>Monitoring Your System</em></span>.</p></div><div class="section" title="Verifying the strength of your passwords"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec23"/>Verifying the strength of your passwords</h3></div></div></div><p>No matter how tight your security is <a id="id159" class="indexterm"/>otherwise, if you leave your root password set to <code class="literal">root</code> or <code class="literal">admin</code>, your server is sure to get hacked. Likewise, the strength of your users' passwords should be periodically verified. See the <span class="emphasis"><em>Verifying the strength of passwords</em></span> recipe in this chapter. It's actually a good idea to disable root's login over SSH altogether. For this, take a look at the <span class="emphasis"><em>Disabling root login over SSH</em></span> recipe.</p></div><div class="section" title="Verifying the system security and setting up intrusion detection and prevention software"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec24"/>Verifying the system security and setting up intrusion detection and prevention software</h3></div></div></div><p>The following topics go <a id="id160" class="indexterm"/>beyond the scope of this book. However, if you want to make sure that your server is as secure as possible, you should implement the following processes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Perform regular <a id="id161" class="indexterm"/>security audits (using tools such as Nessus).</li><li class="listitem" style="list-style-type: disc">Set up intrusion detection and prevention systems (OSSEC, Bro Network Security Monitor, or Snort).</li><li class="listitem" style="list-style-type: disc">Scan for viruses and malware (ClamAV and Linux Malware Detect).</li><li class="listitem" style="list-style-type: disc">Check for rootkits (chkrootkit and rkhunter).<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note15"/>Note</h3><p>More<a id="id162" class="indexterm"/> information about the following systems can be found on their web pages:</p><p>
<span class="strong"><strong>Nessus</strong></span>: <a class="ulink" href="http://www.tenable.com/products/Nessus">http://www.tenable.com/products/Nessus</a>.</p><p>
<span class="strong"><strong>OSSEC</strong></span>
<a id="id163" class="indexterm"/>: <a class="ulink" href="http://www.ossec.net">http://www.ossec.net</a>.</p><p>
<span class="strong"><strong>Bro</strong></span>
<a id="id164" class="indexterm"/>: <a class="ulink" href="http://www.bro.org">http://www.bro.org</a>.</p><p>
<span class="strong"><strong>Snort</strong></span>
<a id="id165" class="indexterm"/>: <a class="ulink" href="http://www.snort.org">http://www.snort.org</a>.</p><p>
<span class="strong"><strong>ClamAV</strong></span>
<a id="id166" class="indexterm"/>: <a class="ulink" href="http://www.clamav.net">http://www.clamav.net</a>.</p><p>
<span class="strong"><strong>Linux Malware Detect</strong></span>
<a id="id167" class="indexterm"/>: <a class="ulink" href="https://www.rfxn.com/projects/linux-malware-detect/">https://www.rfxn.com/projects/linux-malware-detect/</a>.</p><p>
<span class="strong"><strong>chkrootkit</strong></span>
<a id="id168" class="indexterm"/>: <a class="ulink" href="http://www.chkrootkit.org">http://www.chkrootkit.org</a>.</p><p>
<span class="strong"><strong>rkhunter</strong></span>
<a id="id169" class="indexterm"/>: <a class="ulink" href="http://rkhunter.sourceforge.net">http://rkhunter.sourceforge.net</a>.</p></div></div><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip29"/>Tip</h3><p>Backtrack<a id="id170" class="indexterm"/> is a Linux distribution that comes with a wide range of preinstalled security tools. It's a good starting point for security testing and auditing your servers. More<a id="id171" class="indexterm"/> information is available online at <a class="ulink" href="http://www.backtrack-linux.org">http://www.backtrack-linux.org</a>.</p></div></div></li></ul></div></div></div></div></div>
<div class="section" title="Setting up a Linux firewall"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec36"/>Setting up a Linux firewall</h1></div></div></div><p>Linux systems have a firewall software built right into the kernel. This packet-filtering framework is called <span class="strong"><strong>netfilter</strong></span>
<a id="id172" class="indexterm"/> (since Linux 2.4). It is controlled by a tool called<a id="id173" class="indexterm"/> <code class="literal">iptables</code>, which instructs the kernel what to do with incoming and outgoing network packets.</p><p>In this recipe, we will begin with an empty <code class="literal">iptables</code> configuration (firewall disabled) and configure it to drop any incoming packets except those we specifically allow. Before we set up a firewall, we should review some basic concepts related to network communication and the organization of <code class="literal">iptables</code>.</p><p>The following are some basic packet-filtering concepts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Packets</strong></span>: The <a id="id174" class="indexterm"/>Internet is a <a id="id175" class="indexterm"/>packet-switched<a id="id176" class="indexterm"/> network. This means that all communication is facilitated by breaking up the content into small blocks called packets, which are routed from one computer on the network to another.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>IP address</strong></span>: The <a id="id177" class="indexterm"/>adresses of machines on the Internet are specified by <a id="id178" class="indexterm"/>numerical IP addresses, such as <code class="literal">93.184.216.119</code> (IPv4) or <code class="literal">2606:2800:220:6d:26bf:1447:1097:aa7</code> (IPv6).</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Port number</strong></span>: Most<a id="id179" class="indexterm"/> common applications use the TCP or <a id="id180" class="indexterm"/>UDP transport protocols that require a specific port number to distinguish between different services running on the same machine.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Packet header</strong></span>: Each <a id="id181" class="indexterm"/>packet passing through the network contains a <a id="id182" class="indexterm"/>header, which specifies where it is coming from and where it's travelling. This allows routers on the Internet to guide the packets in the right direction or send error messages back to the sender.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Packet filtering</strong></span>: The<a id="id183" class="indexterm"/> firewall software is able to inspect packet headers and decide whether a particular packet should be allowed to proceed on its way or should be dropped.</li></ul></div><div class="section" title="Some iptables terminology"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec94"/>Some iptables terminology</h2></div></div></div><p>The <code class="literal">iptables</code> tool<a id="id184" class="indexterm"/> is capable of performing quite a complex set of operations on packets. The rules used to make decisions about a packet's fate are grouped into several levels of organization, which are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Table</strong></span>: This <a id="id185" class="indexterm"/>is the <a id="id186" class="indexterm"/>highest level of organization. The <code class="literal">iptables</code> tool allows you to filter network packets (using the <code class="literal">filter</code> table), set up a network address translation system (using the <code class="literal">nat</code> table), or modify the packets (using the <code class="literal">mangle</code> table). We will focus only on the packet filtering functionality (<code class="literal">filter</code>) to create a firewall.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Chain</strong></span>: Each <a id="id187" class="indexterm"/>table<a id="id188" class="indexterm"/> contains a number <a id="id189" class="indexterm"/>of chains of rules, which are applied in specific situations. The chains that are built into the <code class="literal">filter</code> table are called <code class="literal">INPUT</code> (applied to the packets coming into our system), <code class="literal">OUTPUT</code> (applied to the packets originating on our system), and <code class="literal">FORWARD</code> (applied to the packets coming into our system, but which are destined for another system). In this recipe, we will focus on incoming traffic and the <code class="literal">INPUT</code> chain.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Rule</strong></span>: Any<a id="id190" class="indexterm"/> packet that passes through the firewall is compared to the<a id="id191" class="indexterm"/> rules in the appropriate chain. The rules may be configured to match a specific source or destination IP addresses or port numbers. They may also match packets on a specific network interface, protocol, or connection state. Rules are tried in a specific order and the first rule that matches the packet can decide if the packet is accepted or dropped.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Default policy</strong></span>: If the <a id="id192" class="indexterm"/>packet doesn't match any rules, its fate will be decided<a id="id193" class="indexterm"/> by the chain's default policy.</li></ul></div></div><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec95"/>Getting ready</h2></div></div></div><p>In this recipe, we will set up a firewall configuration from scratch and reset any configuration that your system may have come with. This is not necessary, and if you know how <code class="literal">iptables</code> work, you may build on your system's default firewall configuration. In this case, you may wish to skip ahead to the recipe <span class="emphasis"><em>Allowing access to a service through the firewall</em></span>.</p><p>Webmin also provides a series of predefined configurations that you may use to initialize your firewall. These configurations will become available after enabling the firewall or by navigating to <span class="strong"><strong>Networking</strong></span> | <span class="strong"><strong>Linux Firewall</strong></span> and clicking <span class="strong"><strong>Reset Firewall</strong></span>. Webmin's predefined firewall configuration choices are shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/5849OS_03_06.jpg" alt="Getting ready"/></div><p>The following table describes what Webmin's <a id="id194" class="indexterm"/>predefined firewall configurations do:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Option</p>
</th><th style="text-align: left" valign="bottom">
<p>Description</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Allow all traffic</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This is a configuration without any rules, which allows all traffic by default.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Block all incoming connections on external interface</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This prevents connections to your server from the network and allows only established connections and basic DNS and ICMP packets through.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Block all except SSH and IDENT on external interface</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the same as <span class="emphasis"><em>Block all incoming connections on external interface</em></span>, but allows incoming SSH connections and, unfortunately, requests of the <a id="id195" class="indexterm"/>
<span class="strong"><strong>Identification Protocol</strong></span> (<span class="strong"><strong>IDENT</strong></span>). Permitting the latter is not recommended.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Block all except SSH, IDENT, ping and high ports on interface</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This is the same as <span class="emphasis"><em>Block all except SSH and IDENT on external interface</em></span>, but also allows your server to respond to the ping command and allows requests to most ports in the range 1024 to 65535. These high ports may be used to accept connections by processes started by non-root users. This configuration should not be used on the open Internet.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Block all except ports used for virtual hosting, on interface</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This allows <a id="id196" class="indexterm"/>incoming connections to most commonly used services, such as SSH, HTTP, mail, FTP, and DNS. This also allows connections to Webmin, Usermin, and unfortunately IDENT.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Do network address translation on external interface</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>This sets the Masquerade rule on the POSTROUTING chain. This allows your server to act as a network gateway for other computers on your network.</p>
</td></tr></tbody></table></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec96"/>How to do it...</h2></div></div></div><p>Perform the following <a id="id197" class="indexterm"/>steps to set up a firewall:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Check if your system already has an <code class="literal">iptables</code> firewall set up. This can be done by navigating to <span class="strong"><strong>Networking</strong></span> | <span class="strong"><strong>Linux Firewall</strong></span>.</li><li class="listitem">If your firewall is set up, you will see a list of rules in the chains of the filter table. Create a new firewall configuration by clicking <span class="strong"><strong>Reset Firewall</strong></span>.</li><li class="listitem">Select the option <span class="strong"><strong>Allow all traffic</strong></span>, check the <span class="strong"><strong>Enable firewall at boot time?</strong></span> box, and click <span class="strong"><strong>Setup Firewall</strong></span>.</li><li class="listitem">Make sure that Webmin is showing the table for <span class="strong"><strong>Packet filtering (filter)</strong></span> and that no rules are set up yet. Your screen should resemble the following screenshot:<div class="mediaobject"><img src="graphics/5849OS_03_01.jpg" alt="How to do it..."/></div></li><li class="listitem">We will now <a id="id198" class="indexterm"/>create the basic set of rules that will allow your firewall to function properly. The first rule will allow incoming packets that are part of an already established connection. Add the first rule to the <code class="literal">INPUT</code> chain by clicking <span class="strong"><strong>Add Rule</strong></span> in the <span class="strong"><strong>Incoming Packets</strong></span> section.<p>Set the following options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set <span class="strong"><strong>Action to take</strong></span> to <span class="strong"><strong>Accept</strong></span></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Connection states</strong></span>, select <span class="strong"><strong>Equals</strong></span> and both <span class="strong"><strong>ESTABLISHED</strong></span> and <span class="strong"><strong>RELATED</strong></span></li></ul></div><p>Then, click the <span class="strong"><strong>Create</strong></span> button.</p></li><li class="listitem">The second rule will allow incoming network diagnostics (ICMP) packets (<code class="literal">ping</code>, <code class="literal">traceroute</code>, and so on). Click <span class="strong"><strong>Add Rule</strong></span> again and set the following options before clicking <span class="strong"><strong>Create</strong></span>:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set <span class="strong"><strong>Action to take</strong></span> to <span class="strong"><strong>Accept</strong></span></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Network protocol</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>ICMP</strong></span></li></ul></div></li><li class="listitem">The third rule will allow any connection originating from our own machine via the local loopback interface. Create the rule as described in the preceding step:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set <span class="strong"><strong>Action to take</strong></span> to <span class="strong"><strong>Accept</strong></span></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Incoming interface</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>lo</strong></span></li></ul></div></li><li class="listitem">The preceding <a id="id199" class="indexterm"/>rules are sufficient to make your network interface behave properly in most cases. We can now add rules that are specific to our particular needs. Let's make a rule to allow incoming SSH connections. Create a rule with the following options:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set <span class="strong"><strong>Action to take</strong></span> to <span class="strong"><strong>Accept</strong></span></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Network protocol</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>TCP</strong></span></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Destination TCP or UDP port</strong></span>, select <span class="strong"><strong>Equals</strong></span> and set <span class="strong"><strong>Port(s)</strong></span> to <code class="literal">22</code></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Connection states</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>NEW</strong></span></li></ul></div></li><li class="listitem">Our final rules will allow incoming Webmin connections. Create a rule with the same options as for SSH. However, instead of 22 select port 10000.<div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip30"/>Tip</h3><p>Webmin also uses UDP port 10000 to discover other servers that are running Webmin on your network. If you plan to use Webmin's clustering functions, you should also add a rule for port 10000 and <span class="strong"><strong>Network protocol</strong></span> <span class="strong"><strong>UDP</strong></span>.</p></div></div></li><li class="listitem">Finally, let's set the chain's default policy to drop packets that don't match any of our rules. Select the default action to <span class="strong"><strong>Drop</strong></span> and click the <span class="strong"><strong>Set Default Action To</strong></span> button.<div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note16"/>Note</h3><p>You may choose to <span class="emphasis"><em>drop</em></span> or <span class="emphasis"><em>reject</em></span> packets. When packets are dropped, your server sends no response, and when they are rejected, it sends a friendly <span class="emphasis"><em>port closed</em></span> response.</p></div></div></li><li class="listitem">At this stage, your firewall configuration should resemble the following screenshot. Verify that you haven't made any mistakes.<div class="mediaobject"><img src="graphics/5849OS_03_02.jpg" alt="How to do it..."/><div class="caption"><p>A firewall configuration that allows incoming SSH and Webmin connections, but drops all others.</p></div></div></li><li class="listitem">To activate <a id="id200" class="indexterm"/>your new firewall, click the <span class="strong"><strong>Apply Configuration</strong></span> button.<div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip31"/>Tip</h3><p>Modifying the firewall configuration using a network tool such as Webmin is a little tricky; if you make a mistake, you could potentially lock yourself out. In case of emergency, you can disable the firewall temporarily by logging in through the system console and issuing the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo iptables -F INPUT</strong></span>
<span class="strong"><strong>$ sudo iptables -P INPUT ACCEPT</strong></span>
</pre></div><p>The first command flushes (removes) all rules from the <code class="literal">INPUT</code> chain and the second sets its default policy to <code class="literal">ACCEPT</code> incoming packets. These changes will be temporary and the default configuration will be reset after a system reboot.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec97"/>How it works...</h2></div></div></div><p>Webmin really helps us out here, especially if your system doesn't come with a default firewall configuration. Webmin issues a long series of commands to create an empty but valid <code class="literal">iptables</code> configuration. It then saves this configuration to a file and allows us to add rules to it. When we ask Webmin to enable the firewall at boot time, it also adds the appropriate commands to the system's network configuration scripts.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec98"/>There's more...</h2></div></div></div><p>There is quite a bit more that <code class="literal">iptables</code> can do for you. For instance, it would be a good idea to limit access to Webmin only to yourself and perhaps some of your administrator colleagues. Other people on the Internet don't even need to know that you are running Webmin. In order to achieve this, you can restrict access to a list of IP addresses or Internet subnets.</p><p>Go back to the rule you created for Webmin access and add another condition. Set source address or network to the IP of the machine you're connecting from. If you'd like to grant access to the whole network segment, also specify the subnet mask after a slash character (/). For instance, if you would like to restrict the access to requests coming from IPs in the range 10.10.10.0 to 10.10.10.255, use the following address and mask: <code class="literal">10.10.10.0/255.255.255.0</code>
</p><div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip33"/>Tip</h3><p>In this recipe, we only set up rules that filter incoming network traffic. Firewalls can also control outgoing traffic from your server to the Internet. It may be a good idea to block outgoing connections on machines that could potentially be compromised by user-installed malware.</p></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec99"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can verify that your firewall works as expected by scanning the ports. Refer to the <span class="emphasis"><em>Verifying your firewall by port scanning</em></span> recipe for more information.</li><li class="listitem" style="list-style-type: disc">If you're interested in learning more about what <code class="literal">iptables</code> can do, check out its documentation at <a class="ulink" href="http://www.netfilter.org/documentation/">http://www.netfilter.org/documentation/</a>.</li><li class="listitem" style="list-style-type: disc">For more information about Webmin's firewall module functions, take a look at its Wiki page at <a class="ulink" href="http://doxfer.com/Webmin/LinuxFirewall">http://doxfer.com/Webmin/LinuxFirewall</a>.</li></ul></div></div></div>
<div class="section" title="Allowing access to a service through the firewall"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec37"/>Allowing access to a service through the firewall</h1></div></div></div><p>Once your firewall is<a id="id201" class="indexterm"/> set up, all unauthorized traffic coming into your server will be<a id="id202" class="indexterm"/> dropped. If you decide to add a service to your server, you'll need to add another firewall rule to allow the incoming traffic to reach the service. Otherwise, external users will not be able to access the new service. In fact, they will not even be able to see that the service is running and their connections will simply time out.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec100"/>Getting ready</h2></div></div></div><p>Make sure that your firewall is set up. Refer to the <span class="emphasis"><em>Setting up a Linux firewall</em></span> recipe for more information. Make sure you know which port numbers and protocols are used by the service to which you want to allow access. Common port numbers such as 80 and 443 for a web server and 20 and 21 for FTP are listed in the file <code class="literal">/etc/services</code>. Usermin uses the port 20000 by default.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec101"/>How to do it...</h2></div></div></div><p>Perform the following steps for <a id="id203" class="indexterm"/>accessing a service<a id="id204" class="indexterm"/> through firewall:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Networking</strong></span> | <span class="strong"><strong>Linux Firewall</strong></span>.</li><li class="listitem">Click the <span class="strong"><strong>Add rule</strong></span> button in the <span class="strong"><strong>Incoming packets (INPUT)</strong></span> section.</li><li class="listitem">Set the following options:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Set <span class="strong"><strong>Action to take</strong></span> to <span class="strong"><strong>Accept</strong></span></li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Network protocol</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>TCP</strong></span> (or <span class="strong"><strong>UDP</strong></span> if your service requires it)</li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Destination TCP or UDP port</strong></span>, select <span class="strong"><strong>Equals</strong></span> and set <span class="strong"><strong>Port(s)</strong></span> to the port number required</li><li class="listitem" style="list-style-type: disc">For <span class="strong"><strong>Connection states</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>NEW</strong></span></li></ul></div></li><li class="listitem">Click <span class="strong"><strong>Create</strong></span>.<div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip34"/>Tip</h3><p>The <code class="literal">iptables</code> rules are applied in a specific order. This is the order in which the rules are listed in Webmin from top to bottom. If a rule to accept or drop matches a packet, other rules further down the list will have no effect. When you make a rule to accept a certain type of packet, make sure it's placed before a more general rule that would cause this packet to be dropped or rejected. Use the grey upward arrows to move rules up the chain.</p></div></div></li><li class="listitem">Click the <span class="strong"><strong>Apply Configuration</strong></span> button to activate the changes.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec102"/>How it works...</h2></div></div></div><p>We created a new firewall rule that allows packets to come in if, and only if, they are using the protocol we specified (TCP or UDP), the port number we selected, and they are packets initiating the connection (NEW state).</p><p>Webmin adds our rule to the <code class="literal">iptables</code> configuration file and loads the new firewall configuration. From now on, packets with the specified port will be allowed a safe passage into your system.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec103"/>There's more...</h2></div></div></div><p>You may wish to run services on your system that will only be accessible internally from the same machine. A database server for your web application may be a good example of such a case. If you wish to allow access to a service only locally, you can create a firewall rule that will allow incoming request only if they are coming in over the local loopback interface.</p><div class="section" title="Creating a service accessible only from the internal network"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec25"/>Creating a service accessible only from the internal network</h3></div></div></div><p>In order to create a local-only <a id="id205" class="indexterm"/>service, follow the same steps as described in this recipe, but add another condition to the rule. Under <span class="strong"><strong>Incoming interface</strong></span>, select <span class="strong"><strong>Equals</strong></span> and <span class="strong"><strong>lo</strong></span> (the name of the local loopback interface).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note17"/>Note</h3><p>Our default firewall configuration, which is described in the <span class="emphasis"><em>Setting up a Linux firewall</em></span> recipe, allows all locally initiated requests to come in. You may disable this behavior by removing its rule and allow local access to specific services only.</p></div></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec104"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For more information about how the <code class="literal">iptables</code> firewall works, refer to the <span class="emphasis"><em>Setting up a Linux firewall</em></span> recipe of this chapter</li></ul></div></div></div>
<div class="section" title="Verifying your firewall by port scanning"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec38"/>Verifying your firewall by port scanning</h1></div></div></div><p>After your firewall is <a id="id206" class="indexterm"/>configured, you may wish to check that you haven't <a id="id207" class="indexterm"/>unintentionally left any unnecessary open doors. A good way to do this is to initiate a scan from another machine that will tell you what open ports it discovered on your server. Only ports associated with services that you want to make publicly accessible should be found.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec105"/>Getting ready</h2></div></div></div><p>We will be using two machines in this recipe. One will be the scanner machine and the other will be the server we want to scan.</p><p>Nmap<a id="id208" class="indexterm"/> is a great and widely available port scanner. Let's start by installing it on the scanner machine. You can install it from the repositories of most Linux distributions, from ports on BSD and from Homebrew on OS X. You can also download an installer for <a id="id209" class="indexterm"/>Windows from <a class="ulink" href="http://nmap.org/download.html">http://nmap.org/download.html</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec106"/>How to do it...</h2></div></div></div><p>Perform the following<a id="id210" class="indexterm"/> steps to verify your firewall by port <a id="id211" class="indexterm"/>scanning:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On your scanner machine, open up a terminal window and type the following command (here, <code class="literal">webmin.host</code> is the IP address or domain name of the server you wish to scan):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ nmap -sT webmin.host</strong></span>
</pre></div><p>You should see the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Starting Nmap 6.25 ( http://nmap.org ) at 2013-08-13 21:42 CEST</strong></span>
<span class="strong"><strong>Nmap scan report for 37.139.1.192</strong></span>
<span class="strong"><strong>Host is up (0.039s latency).</strong></span>
<span class="strong"><strong>Not shown: 998 filtered ports</strong></span>
<span class="strong"><strong>PORT      STATE SERVICE</strong></span>
<span class="strong"><strong>22/tcp    open  ssh</strong></span>
<span class="strong"><strong>10000/tcp open  snet-sensor-mgmt</strong></span>

<span class="strong"><strong>Nmap done: 1 IP address (1 host up) scanned in 17.65 seconds</strong></span>
</pre></div></li><li class="listitem">The output lists the open ports discovered on your server. Among them, you will find port 22 for SSH connections and port 10000 for Webmin. If you find ports that you didn't expect in the scan, you may need to go back to the firewall configuration to close them down.<div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip35"/>Tip</h3><p>Some ISPs may block outgoing scan packets before they reach the server that you're testing. For instance, packets addressed to port 25 are quite commonly blocked to fight against spam e-mail.</p><p>You can verify that the scan you're performing is actually working by running it against the server with its firewall temporarily disabled. When the server has no active firewall, your remote scan should give results similar to executing the following command on the server itself. This <code class="literal">netstat</code> command enumerates the open ports on the server.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ netstat –ltn</strong></span>
</pre></div><p>Take a look at the <span class="emphasis"><em>Turning off unnecessary services</em></span> recipe in this chapter for more information about using <code class="literal">netstat</code>.</p></div></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec107"/>How it works...</h2></div></div></div><p>With its default <a id="id212" class="indexterm"/>options, Nmap<a id="id213" class="indexterm"/> scans will <a id="id214" class="indexterm"/>send a SYN packet (the first part of an initial connection handshake) to the 1,000 most commonly used ports on the machine you specify. If the machine is accepting connections on any port, it will send an SYN/ACK packet back, acknowledging that it is ready to open a connection. From this, Nmap can determine that the port is open.</p><p>Connections to those ports that your firewall is set to drop will be marked as <code class="literal">filtered</code> because they don't return any information at all. Ports that your firewall is set to reject will return a port unreachable message and will be marked as <code class="literal">closed</code> in your scan.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec108"/>There's more...</h2></div></div></div><p>Nmap has a wide variety of options. It can be used to perform a scan of the whole network, scan every port of a machine, or perform a scan that doesn't require administrative privileges on the scanning machine.</p><div class="section" title="Host discovery with Nmap"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec26"/>Host discovery with Nmap</h3></div></div></div><p>If you want to know what <a id="id215" class="indexterm"/>computers are active on your segment of the network, type in <a id="id216" class="indexterm"/>the following command, specifying the range of IP addresses that you want to scan:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ nmap -sn 10.10.10.0-255</strong></span>
</pre></div></div><div class="section" title="Scanning all ports"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec27"/>Scanning all ports</h3></div></div></div><p>By default, Nmap<a id="id217" class="indexterm"/> scans only the 1,000 most commonly used port numbers. If you want to be more thorough and scan every single port, use the following command (with the <code class="literal">-p-</code> argument). Note that such a scan may take a few minutes.</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ sudo nmap -sT -p- webmin.host</strong></span>
</pre></div></div><div class="section" title="Scanning without administrative privileges"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec28"/>Scanning without administrative privileges</h3></div></div></div><p>Nmap's standard port <a id="id218" class="indexterm"/>scanning technique requires administrative access on the scanning computer, because it uses raw sockets to perform only the first part of a connection (sending the SYN packet). If you don't have administrative privileges, you can perform a different type of scan that initiates a normal connection by issuing the following command (with the <code class="literal">-sP</code> argument):</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ nmap -sP webmin.host</strong></span>
</pre></div></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec109"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For more information, take a look at the Nmap Reference Guide<a id="id219" class="indexterm"/> on <a class="ulink" href="http://nmap.org/book/man.html">http://nmap.org/book/man.html</a></li></ul></div></div></div>
<div class="section" title="Turning off unnecessary services"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec39"/>Turning off unnecessary services</h1></div></div></div><p>The best way to avoid potential security issues with services you're not actively using is to disable them. This recipe will list the steps to identify the running system services that have open network ports and disable them.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec110"/>How to do it...</h2></div></div></div><p>Let's start by identifying the<a id="id220" class="indexterm"/> processes that open network ports on your systems. This can be done with the help of the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Others</strong></span> | <span class="strong"><strong>Command Shell</strong></span>.</li><li class="listitem">Type in the command <code class="literal">netstat -tulpen</code> and click <span class="strong"><strong>Execute command</strong></span>.</li></ol></div><p>You will see a list of server processes with active network connections.</p><p>In the <code class="literal">Local Address</code> column, you will see entries such as <code class="literal">0.0.0.0:22</code>. This means that a process is listening on port 22. The <code class="literal">PID/Program name</code> column will tell you which process is responsible for opening this port.</p><p>If you identify a process that you are not using and you know that it isn't essential to your system, you can disable it with the help of the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Bootup and Shutdown</strong></span>.</li><li class="listitem">Find the startup entry associated with the process and check the box next to its name.</li><li class="listitem">Click the <span class="strong"><strong>Disable Now and On Boot</strong></span> button.</li><li class="listitem">Go back to <span class="strong"><strong>Others</strong></span> | <span class="strong"><strong>Command Shell</strong></span>.</li><li class="listitem">Execute the <code class="literal">netstat -tulpen</code> command again and check that the process no longer appears on the list.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec111"/>How it works...</h2></div></div></div><p>The <code class="literal">netstat</code> command<a id="id221" class="indexterm"/> allows you to display information about the network connections. The arguments <a id="id222" class="indexterm"/>written as <code class="literal">-tulpen</code> are a mnemonic (<span class="emphasis"><em>tulpen</em></span> means tulips in German) for the options that you need to verbosely list the servers with open ports listening for connections. The parameters serve the following functions:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-t</code> lists TCP connections</li><li class="listitem" style="list-style-type: disc"><code class="literal">-u</code> lists UDP connections</li><li class="listitem" style="list-style-type: disc"><code class="literal">-l</code> lists only connections that are listening (servers)</li><li class="listitem" style="list-style-type: disc"><code class="literal">-p</code> will display the process ID and program name</li><li class="listitem" style="list-style-type: disc"><code class="literal">-e</code> will give you extended information</li><li class="listitem" style="list-style-type: disc"><code class="literal">-n</code> will display data as numbers instead of resolving it to names</li></ul></div></div></div>
<div class="section" title="Verifying the strength of passwords"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec40"/>Verifying the strength of passwords</h1></div></div></div><p>If you allow administrative users <a id="id223" class="indexterm"/>to log into your system using their username and password, your system is only as secure as the passwords used by those users. It's a good idea to periodically attempt to crack all the passwords on your system. If you find passwords that are easy to guess or crack through brute force, you should ask users to change them.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec112"/>Getting ready</h2></div></div></div><p>For this recipe, we will be using the password-cracking program called <a id="id224" class="indexterm"/>John the Ripper. Start by installing the package named <code class="literal">john</code>. Refer to the<span class="emphasis"><em> Installing software packages</em></span> recipe from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <span class="emphasis"><em>Setting Up Your System</em></span>, for more details.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec113"/>How to do it...</h2></div></div></div><p>John the Ripper tries to crack passwords by brute force, which means it will try every word and combination of characters. If any user on your system has a strong password (long and complex), John will not be able to crack it in a reasonable amount of time. You should let the cracking run for a couple of days and then decide that the remaining passwords are strong enough.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note18"/>Note</h3><p>John the Ripper tries to be a good system citizen and uses only spare CPU cycles that would otherwise go unused. It may nevertheless reduce the responsiveness of your system. So, if your system is under heavy load or its speed is mission critical, you may choose to crack passwords on a different machine.</p></div></div><p>Perform the following steps to identify<a id="id225" class="indexterm"/> weak passwords:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Scheduled Commands</strong></span> and create a new command to run as root 5 minutes <a id="id226" class="indexterm"/>from now in the <code class="literal">/root</code> directory. Set the <code class="literal">john /etc/shadow</code><span class="strong"><strong> </strong></span>command for execution. Refer to the <span class="emphasis"><em>Setting a command to be executed in the future</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Controlling Your System">Chapter 4</a>, <span class="emphasis"><em>Controlling Your System</em></span>, for more information.</li><li class="listitem">After a couple of hours, you can check how many passwords were cracked. Navigate to <span class="strong"><strong>Others</strong></span> | <span class="strong"><strong>Command Shell</strong></span> and execute the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong> john -show /etc/shadow</strong></span>
</pre></div></li><li class="listitem">This command will show you any passwords that are already cracked and the information about how many John the Ripper is still trying to guess. You can go back to  the second step at any time to check the progress in cracking.</li><li class="listitem">You should reset the passwords for users whose passwords were cracked and inform them about the situation. Refer to the <span class="emphasis"><em>Changing a user's password</em></span> recipe in <a class="link" href="ch02.html" title="Chapter 2. User Management">Chapter 2</a>, <span class="emphasis"><em>User Management</em></span>, for details.</li></ol></div><p>If some passwords remain uncracked after a couple of days, you may decide that they are strong enough and stop John the Ripper with the help of following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>System</strong></span> | <span class="strong"><strong>Running Processes</strong></span>.</li><li class="listitem">Click the <span class="strong"><strong>CPU</strong></span> option to <span class="strong"><strong>Display</strong></span> processes ordered by processor usage.</li><li class="listitem">On the top of the list, you will see <code class="literal">john</code>. Click its PID.</li><li class="listitem">On the <span class="strong"><strong>Process information</strong></span> screen, click the <span class="strong"><strong>Terminate</strong></span> button to stop this cracking session.<div class="tip" title="Tip" style=""><div class="inner"><h3 class="title"><a id="tip37"/>Tip</h3><p>You may resume the stopped cracking session by issuing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>john –restore</strong></span>
</pre></div><p>Use the same procedure as in the first step to schedule its execution in the background.</p></div></div></li><li class="listitem">When you decide to finish password cracking, you should remove files created by John the Ripper. They will be stored in the <code class="literal">/root/.john</code> directory. It's especially important to remove the <code class="literal">john.pot</code> file as it contains all the passwords that were cracked and can be read by all users who have administrative privileges.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec114"/>How it works...</h2></div></div></div><p>You provide John the <a id="id227" class="indexterm"/>Ripper with password hashes of your system users. The <code class="literal">john</code> program first determines which hashing techniques and salts your system uses. It then proceeds to apply the same hashing algorithm to every word in a wordlist file. If a hash it generates is identical to a password hash stored for one of your users, then this particular word was used as the password—the password is cracked. After trying every word in the wordlist, John the Ripper proceeds to try every letter combination possible. This part of the process takes a long time and uses a lot of CPU power. If you find that John is taking a very long time (more then a few days) to crack your passwords, you may decide that they are strong enough and stop.</p></div></div>
<div class="section" title="Disabling root login over SSH"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec41"/>Disabling root login over SSH</h1></div></div></div><p>Allowing the root user<a id="id228" class="indexterm"/> to log in over SSH is a potential security <a id="id229" class="indexterm"/>vulnerability. An attacker may try to break into your system by trying every password for the root user. It's recommended to disallow the root user's access over SSH and to log in as another user with the <code class="literal">sudo</code> privileges to perform administrative tasks.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec115"/>How to do it...</h2></div></div></div><p>Perform the following steps to disable root login:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Servers</strong></span> | <span class="strong"><strong>SSH Server</strong></span> | <span class="strong"><strong>Authentication</strong></span>.</li><li class="listitem">Answer <span class="strong"><strong>No</strong></span> to the <span class="strong"><strong>Allow login by root?</strong></span> question.</li><li class="listitem">Click <span class="strong"><strong>Save</strong></span>.</li><li class="listitem">Back on the <span class="strong"><strong>SSH Server</strong></span> module screen, click <span class="strong"><strong>Apply Changes</strong></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec116"/>How it works...</h2></div></div></div><p>Webmin updates the SSH <a id="id230" class="indexterm"/>configuration file (<code class="literal">/etc/ssh/sshd_config</code>) by <a id="id231" class="indexterm"/>setting <code class="literal">PermitRootLogin</code> to <code class="literal">no</code>. From now on, SSH will treat every password entered for the root user as incorrect.</p></div></div>
<div class="section" title="Restricting Webmin access to a specific IP"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec42"/>Restricting Webmin access to a specific IP</h1></div></div></div><p>The firewall is your first <a id="id232" class="indexterm"/>line of defense, but you should take <a id="id233" class="indexterm"/>additional precautions while running Webmin on an Internet-connected server. Webmin allows you to restrict access to a list of specific IP addresses and networks. It's a good idea to protect Webmin this way; otherwise, an attacker can try to guess your password and take over your system.</p><p>In this recipe, we will configure Webmin to accept connections only from your IP address.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec117"/>Getting ready</h2></div></div></div><p>Before you start, you should determine the IP address you are currently using to connect to Webmin. In order to do this, log into Webmin and navigate to <span class="strong"><strong>Webmin</strong></span> | <span class="strong"><strong>Webmin Users</strong></span> | <span class="strong"><strong>View Login Sessions</strong></span>. Your active login session will be marked in bold and your address will be listed in the <span class="strong"><strong>IP address</strong></span> column.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec118"/>How to do it...</h2></div></div></div><p>For restricting Webmin access, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Webmin</strong></span> | <span class="strong"><strong>Webmin Configuration</strong></span> | <span class="strong"><strong>IP Access Control</strong></span>.</li><li class="listitem">Set <span class="strong"><strong>Allowed IP addresses</strong></span> to <span class="strong"><strong>Only allow from listed addresses</strong></span>.</li><li class="listitem">Enter your IP address in the text area below.</li><li class="listitem">Click <span class="strong"><strong>Save</strong></span>. Webmin will save changes and restart.</li></ol></div><p>From now on, you will be able to connect from the specified IP. However, users trying to connect to Webmin from other computers will receive an <span class="strong"><strong>HTTP 403 error (Access denied)</strong></span>.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec119"/>How it works...</h2></div></div></div><p>Webmin stores information about which hosts are allowed to connect in its server configuration file (<code class="literal">/etc/webmin/miniserv.conf</code> by default). The line that allows host access starts with the keyword <code class="literal">allow</code>, and specifies a list of IP addresses and ranges separated with a space character. For instance, it may look like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>allow=93.184.216.119 192.0.2.0/24</strong></span>
</pre></div><p>Whenever a client <a id="id234" class="indexterm"/>tries to connect, Webmin consults this configuration to <a id="id235" class="indexterm"/>determine whether to allow the incoming connection or not.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec120"/>There's more...</h2></div></div></div><p>Webmin's IP access control module is quite flexible and allows you to specify sets of IP addresses in a number of ways.</p><div class="section" title="Allowing access from multiple IP addresses"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec29"/>Allowing access from multiple IP addresses</h3></div></div></div><p>The simplest way to allow <a id="id236" class="indexterm"/>access to Webmin from multiple locations is to add<a id="id237" class="indexterm"/> multiple IP addresses to the text area in the <span class="strong"><strong>IP Access Control</strong></span> module. You can add as many IP addresses as needed, just place each one on a separate line.</p></div><div class="section" title="Allowing access from a dynamically allocated IP"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec30"/>Allowing access from a dynamically allocated IP</h3></div></div></div><p>Many Internet providers<a id="id238" class="indexterm"/> allocate IP addresses dynamically. This<a id="id239" class="indexterm"/> type of address may change at some point in the future, which could leave you unable to connect to Webmin. If you're using a dynamic IP, you may consider signing up for dynamic DNS. A dynamic DNS service will provide you with a hostname that automatically updates to match your changing IP. Keeping this information up-to-date requires the setting up of a daemon process on your computer or network router.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note19"/>Note</h3><p>There <a id="id240" class="indexterm"/>are<a id="id241" class="indexterm"/> many <a id="id242" class="indexterm"/>providers of <a id="id243" class="indexterm"/>dynamic DNS; some<a id="id244" class="indexterm"/> also offer a basic free service. Take a look at the <a id="id245" class="indexterm"/>following or search for Dynamic DNS Providers:</p><p>
<span class="strong"><strong>DynamicDNS</strong></span>: <a class="ulink" href="http://dyn.com">http://dyn.com</a>.</p><p>
<span class="strong"><strong>NoIP</strong></span>: <a class="ulink" href="http://noip.com">http://noip.com</a>.</p><p>
<span class="strong"><strong>FreeDNS</strong></span>: <a class="ulink" href="http://freedns.afraid.org">http://freedns.afraid.org</a>.</p></div></div><p>For Webmin to grant access to your dynamically allocated IP address, go to the <span class="strong"><strong>IP Access Control</strong></span> module and enter the hostname provided by your dynamic DNS provider.</p></div><div class="section" title="Allowing access from an IP range"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec31"/>Allowing access from an IP range</h3></div></div></div><p>If all your Webmin users<a id="id246" class="indexterm"/> use the same Internet provider, they are probably using<a id="id247" class="indexterm"/> a shared network. If you know the range of IP addresses shared by this subnet, you can specify the range by using the subnet address/mask or address/mask bits format:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>192.0.2.0/24</strong></span>
<span class="strong"><strong>192.0.2.0/255.255.255.0</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note20"/>Note</h3><p>Both of the preceding lines are equivalent and specify all IP addresses between <code class="literal">192.0.2.0</code> and <code class="literal">192.0.2.255</code>. Don't be overly broad while specifying the IP range. Using the entire range of public IPs that is used by your Internet provider would not be a very good idea, because a potential attacker may have control of a computer connected to the Internet from the same provider.</p></div></div></div><div class="section" title="Allowing access from the local network"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec32"/>Allowing access from the local network</h3></div></div></div><p>If your server is available via your <a id="id248" class="indexterm"/>local network, you can tell Webmin to<a id="id249" class="indexterm"/> allow all the connections coming from within the LAN. In order to do this, follow the steps in this recipe, but also check the box marked as <span class="strong"><strong>Include local network in list</strong></span>.</p></div></div></div>
<div class="section" title="Connecting to Webmin securely over an SSH tunnel"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec43"/>Connecting to Webmin securely over an SSH tunnel</h1></div></div></div><p>If your server is <a id="id250" class="indexterm"/>connected to the Internet and you use<a id="id251" class="indexterm"/> SSH to connect to it, you can secure it by disallowing Webmin from accepting any remote connections. You can then use an SSH tunnel to connect to Webmin. This lowers the potential attack surface of your machine and protects you against possible security vulnerabilities in Webmin itself. Any attacker would have to break into your SSH account or otherwise gain local access to your system to connect to Webmin.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec121"/>Getting ready</h2></div></div></div><p>Before you begin, you should follow the <span class="emphasis"><em>Restricting Webmin access to a specific IP</em></span> recipe of this chapter and add the IP address <code class="literal">127.0.0.1</code> to the list of hosts allowed to connect to Webmin.</p><p>In this recipe, we'll be using the command line version of SSH that is available on most systems, but it is not available on Windows. Look in the <span class="emphasis"><em>There's more...</em></span> section of this recipe for instructions specific to Windows.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec122"/>How to do it...</h2></div></div></div><p>Perform the following steps to securely connect to Webmin:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">On the client machine, open a terminal window and issue the following command. However, substitute <code class="literal">username</code> with your username and <code class="literal">webmin.host</code> with the IP address or host name of your server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ssh -L 15000:localhost:10000 username@webmin.host</strong></span>
</pre></div></li><li class="listitem">Enter your SSH username and password to establish the connection.</li><li class="listitem">On the client machine, open a browser and navigate to the URL <code class="literal">https://localhost:15000</code>.</li></ol></div><p>You should now be <a id="id252" class="indexterm"/>able to use Webmin through an SSH tunnel.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec123"/>How it works...</h2></div></div></div><p>You can open an SSH<a id="id253" class="indexterm"/> tunnel by issuing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ssh -L client_port:remote_host:remote_port username@ssh_host</strong></span>
</pre></div><p>An SSH tunnel connects machines as listed in the following diagram:</p><div class="mediaobject"><img src="graphics/5849OS_03_03.jpg" alt="How it works..."/></div><p>When you open a tunnel, the SSH client opens a network port on the machine on which it is running (<code class="literal">client_port</code>). This port will now accept connections and all incoming packets will be intercepted by the SSH client program. The SSH client will encrypt them and send them using the SSH protocol to the SSH server machine. The SSH server will decrypt the packets and forward them to the remote machine (<code class="literal">remote_host:remote_port</code>). Responses sent by the remote machine will also be encrypted and traverse the tunnel in the opposite direction.</p><p>The tunnel we use<a id="id254" class="indexterm"/> to connect to Webmin is simpler because only <a id="id255" class="indexterm"/>two machines are involved. The local machine is also the SSH client machine, while the remote machine is also the SSH server.</p><p>When we issue the command </p><p>
<code class="literal">$ ssh -L 15000:localhost:10000 username@webmin.host</code>, </p><p>we are opening port 15000 on our computer and the SSH server on <code class="literal">webmin.host</code> will forward all the packets to its own machine's Webmin port (<code class="literal">localhost:10000</code>). In effect, by connecting to our own computer's port 15000, we will have access to the remote Webmin interface as if we were connecting to that machine directly.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec124"/>There's more...</h2></div></div></div><p>We will cover two more things in this recipe: giving access to the SSH tunnel to other machines and creating an SSH tunnel on Windows using Putty.</p><div class="section" title="Sharing the SSH tunnel with other machines"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec33"/>Sharing the SSH tunnel with other machines</h3></div></div></div><p>By default, the SSH client will only allow <a id="id256" class="indexterm"/>tunneling of connections originating on the same machine. You can override this by using the <code class="literal">-g</code> option:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ssh -g -L 15000:localhost:10000 username@webmin.host</strong></span>
</pre></div><p>This command will allow all the computers that can connect to the SSH client machine on port 15000 access to Webmin on the remote machine.</p></div><div class="section" title="Creating a tunnel on Windows using Putty"><div class="titlepage"><div><div><h3 class="title"><a id="ch03lvl3sec34"/>Creating a tunnel on Windows using Putty</h3></div></div></div><p>If you're running <a id="id257" class="indexterm"/>Windows, <a id="id258" class="indexterm"/>download the <a id="id259" class="indexterm"/>Putty SSH client from <a class="ulink" href="http://www.chiark.greenend.org.uk/~sgtatham/putty/">http://www.chiark.greenend.org.uk/~sgtatham/putty/</a>.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In order to create an SSH tunnel on Windows, start Putty.</li><li class="listitem">In the <span class="strong"><strong>Session</strong></span> section, provide the hostname or IP address of your Webmin host machine in the <span class="strong"><strong>Host Name (or IP address)</strong></span> field as shown in the following screenshot:<div class="mediaobject"><img src="graphics/5849OS_03_04.jpg" alt="Creating a tunnel on Windows using Putty"/></div></li><li class="listitem">Open the<a id="id260" class="indexterm"/> configuration section by navigating to<a id="id261" class="indexterm"/> <span class="strong"><strong>Connection</strong></span> | <span class="strong"><strong>SSH</strong></span> | <span class="strong"><strong>Tunnels</strong></span>.</li><li class="listitem">Specify<a id="id262" class="indexterm"/> port <code class="literal">15000</code> as <span class="strong"><strong>Source port</strong></span>.</li><li class="listitem">Specify <code class="literal">localhost:10000</code> as <span class="strong"><strong>Destination</strong></span>.</li><li class="listitem">Select the radio button labelled as <span class="strong"><strong>Local</strong></span> as shown in the following screenshot:<div class="mediaobject"><img src="graphics/5849OS_03_05.jpg" alt="Creating a tunnel on Windows using Putty"/></div></li><li class="listitem">Click <a id="id263" class="indexterm"/><span class="strong"><strong>Add</strong></span>.</li><li class="listitem">Click <a id="id264" class="indexterm"/><span class="strong"><strong>Open</strong></span> to open the connection.</li><li class="listitem">Provide your <a id="id265" class="indexterm"/>SSH username and password.</li><li class="listitem">On the client machine, open a browser and navigate to <code class="literal">https://localhost:15000</code>.</li></ol></div><p>You should now be able to use Webmin through an SSH tunnel.</p></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec125"/>See also</h2></div></div></div><p>Once you are able to establish tunneled connections to Webmin, you will no longer need to provide remote access to it. You can remove Webmin's entry from the firewall configuration and instruct Webmin to listen for connections only on the local IP 127.0.0.1.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to the <span class="emphasis"><em>Setting up a Linux firewall</em></span> recipe of this chapter</li><li class="listitem" style="list-style-type: disc">Refer to the <span class="emphasis"><em>Specifying the IP address on which Webmin listens</em></span> section of the <span class="emphasis"><em>Connecting to Webmin</em></span> recipe from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <span class="emphasis"><em>Setting Up Your System</em></span></li></ul></div></div></div>
<div class="section" title="Closing inactive Webmin sessions automatically"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec44"/>Closing inactive Webmin sessions automatically</h1></div></div></div><p>Webmin's login <a id="id266" class="indexterm"/>sessions are not set to expire by default. This causes a potential security risk. If a user leaves his or her computer unattended while logged into Webmin, an attacker could potentially use the situation to harm your system or disable its security. Fortunately, this situation is easily remedied by changing a Webmin setting.</p><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec126"/>How to do it...</h2></div></div></div><p>Perform the following steps to close inactive Webmin sessions automatically:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to <span class="strong"><strong>Webmin</strong></span> | <span class="strong"><strong>Webmin Configuration</strong></span> | <span class="strong"><strong>Authentication</strong></span>.</li><li class="listitem">Tick the checkbox marked as <span class="strong"><strong>Auto-logout</strong></span> and set the automatic logout to happen after 10 minutes of inactivity.</li><li class="listitem">Click <span class="strong"><strong>Save</strong></span>.</li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec127"/>How it works...</h2></div></div></div><p>Webmin stores authentication options in its server configuration file (<code class="literal">/etc/webmin/miniserv.conf</code> by default). The line defining inactivity time after which users will be automatically logged out starts with the keyword <code class="literal">logouttime</code> and specifies the time in minutes. For instance, it may look like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>logouttime=10</strong></span>
</pre></div><p>Whenever a client tries to connect, Webmin checks in the session database when this user was last connected. Webmin consults its configuration to determine whether the time elapsed is not higher then allowed. If the user wants to perform an action after the allowed inactivity time elapses, he or she is asked to log in again.</p></div></div></body></html>