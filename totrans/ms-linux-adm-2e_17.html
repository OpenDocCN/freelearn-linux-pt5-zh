<html><head></head><body>
<div id="_idContainer639">
<h1 class="chapter-number" id="_idParaDest-341"><a id="_idTextAnchor359"/><span class="koboSpan" id="kobo.1.1">17</span></h1>
<h1 id="_idParaDest-342"><a id="_idTextAnchor360"/><span class="koboSpan" id="kobo.2.1">Infrastructure and Automation with Ansible</span></h1>
<p><span class="koboSpan" id="kobo.3.1">If your day-to-day system administration or development work involves tedious and repetitive operations, </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">Ansible</span></strong><span class="koboSpan" id="kobo.5.1"> could help you run your tasks while saving you precious time. </span><span class="koboSpan" id="kobo.5.2">Ansible is a tool for automating </span><strong class="bold"><span class="koboSpan" id="kobo.6.1">software provisioning</span></strong><span class="koboSpan" id="kobo.7.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.8.1">configuration management</span></strong><span class="koboSpan" id="kobo.9.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.10.1">application deployment workflows</span></strong><span class="koboSpan" id="kobo.11.1">. </span><span class="koboSpan" id="kobo.11.2">Initially developed by Michael DeHaan in 2012, Ansible was acquired by Red Hat in 2015 and is now maintained as an open </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">source project.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">In this chapter, you’ll learn about the fundamental concepts of Ansible, along with a variety of hands-on examples. </span><span class="koboSpan" id="kobo.13.2">In particular, we’ll explore the </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">following topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1">Introducing Ansible architecture and </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">configuration management</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.17.1">Installing Ansible</span></span></li>
<li><span class="koboSpan" id="kobo.18.1">Working </span><span class="No-Break"><span class="koboSpan" id="kobo.19.1">with Ansible</span></span></li>
</ul>
<h1 id="_idParaDest-343"><a id="_idTextAnchor361"/><span class="koboSpan" id="kobo.20.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.21.1">First, you should be familiar with the Linux command-line Terminal in general. </span><span class="koboSpan" id="kobo.21.2">Intermediate knowledge of Linux will help you understand some of the intricacies of the practical illustrations used throughout this chapter. </span><span class="koboSpan" id="kobo.21.3">You should also be proficient in using a Linux-based </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">text editor.</span></span></p>
<p><span class="koboSpan" id="kobo.23.1">For the hands-on examples, we recommend setting up a lab environment similar to the one we’re using. </span><span class="koboSpan" id="kobo.23.2">To replicate this environment, your CPU will need to have at least 6 physical cores and 6 virtual cores (12 in total). </span><span class="koboSpan" id="kobo.23.3">A quad-core CPU with hyper-threading is not enough. </span><span class="koboSpan" id="kobo.23.4">Also, OpenSSH should be installed on all the hosts. </span><span class="koboSpan" id="kobo.23.5">You’ll find related instructions in the </span><em class="italic"><span class="koboSpan" id="kobo.24.1">Setting up the lab environment</span></em><span class="koboSpan" id="kobo.25.1"> section of this chapter. </span><span class="koboSpan" id="kobo.25.2">If you don’t configure a lab environment, you will still benefit from the detailed explanations associated with the practical examples in </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.27.1">Now, let’s start our journey by covering introductory concepts </span><span class="No-Break"><span class="koboSpan" id="kobo.28.1">surrounding Ansible.</span></span></p>
<h1 id="_idParaDest-344"><a id="_idTextAnchor362"/><span class="koboSpan" id="kobo.29.1">Introducing Ansible architecture and configuration management</span></h1>
<p><span class="koboSpan" id="kobo.30.1">In the introduction </span><a id="_idIndexMarker2490"/><span class="koboSpan" id="kobo.31.1">to this chapter, we captured one of the essential aspects of Ansible – it’s a tool for automating workflows. </span><span class="koboSpan" id="kobo.31.2">Almost any Linux system administration task can be automated using Ansible. </span><span class="koboSpan" id="kobo.31.3">Using the Ansible CLI, we can invoke simple commands to change the </span><strong class="bold"><span class="koboSpan" id="kobo.32.1">desired state</span></strong><span class="koboSpan" id="kobo.33.1"> of a system. </span><span class="koboSpan" id="kobo.33.2">Usually, with Ansible, we execute tasks on a remote host or a group </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">of hosts.</span></span></p>
<p><span class="koboSpan" id="kobo.35.1">Let’s use the classic illustration of </span><strong class="bold"><span class="koboSpan" id="kobo.36.1">package management</span></strong><span class="koboSpan" id="kobo.37.1">. </span><span class="koboSpan" id="kobo.37.2">Suppose you’re managing an infrastructure that includes a </span><a id="_idIndexMarker2491"/><span class="koboSpan" id="kobo.38.1">group of web servers, and you plan to install the latest version of a web server application (Nginx or Apache) on all of them. </span><span class="koboSpan" id="kobo.38.2">One way to accomplish this task is to SSH into each host and run the related shell commands to install the latest web server package. </span><span class="koboSpan" id="kobo.38.3">If you have a lot of machines, this will be a big task. </span><span class="koboSpan" id="kobo.38.4">You could argue that you can write a script to automate this job. </span><span class="koboSpan" id="kobo.38.5">This is possible, but then you’d have yet another job on your hands; that is, maintaining the script, fixing possible bugs, and, with your infrastructure growing, adding </span><span class="No-Break"><span class="koboSpan" id="kobo.39.1">new features.</span></span></p>
<p><span class="koboSpan" id="kobo.40.1">At some point, you may want to manage users or databases or configure network settings on multiple hosts. </span><span class="koboSpan" id="kobo.40.2">Soon, you’ll be looking at a Swiss Army knife tool, with capabilities that you’d rather get for free instead of writing them yourself. </span><span class="koboSpan" id="kobo.40.3">Here’s where Ansible comes in handy. </span><span class="koboSpan" id="kobo.40.4">With its myriad of modules – for almost any system administration task you can imagine – Ansible can remotely configure, run, or deploy your management jobs of choice, with minimal effort and in a very secure and </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">efficient way.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">We’ll consolidate these preliminary thoughts with a brief look at the </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">Ansible architecture.</span></span></p>
<h2 id="_idParaDest-345"><a id="_idTextAnchor363"/><span class="koboSpan" id="kobo.44.1">Understanding the Ansible architecture</span></h2>
<p><span class="koboSpan" id="kobo.45.1">The core </span><a id="_idIndexMarker2492"/><span class="koboSpan" id="kobo.46.1">Ansible framework is written in Python. </span><span class="koboSpan" id="kobo.46.2">Let’s mention upfront that Ansible has an </span><strong class="bold"><span class="koboSpan" id="kobo.47.1">agentless</span></strong><span class="koboSpan" id="kobo.48.1"> architecture. </span><span class="koboSpan" id="kobo.48.2">In </span><a id="_idIndexMarker2493"/><span class="koboSpan" id="kobo.49.1">other words, it runs on a </span><strong class="bold"><span class="koboSpan" id="kobo.50.1">control node</span></strong><span class="koboSpan" id="kobo.51.1"> that</span><a id="_idIndexMarker2494"/><span class="koboSpan" id="kobo.52.1"> executes commands against remote hosts, without the need for a remote endpoint or service to be installed on the managed host to communicate with the control node. </span><span class="koboSpan" id="kobo.52.2">At a minimum, the only requirement for Ansible communication is SSH connectivity to the managed host. </span><span class="koboSpan" id="kobo.52.3">Yet, the number of Ansible operations would be relatively limited to only running scripts and raw SSH commands if the host didn’t have a Python framework installed. </span><span class="koboSpan" id="kobo.52.4">The vast majority of server OS platforms </span><a id="_idIndexMarker2495"/><span class="koboSpan" id="kobo.53.1">already have Python installed </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">by default.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">Ansible can manage a fleet of remote hosts from a single control node using secure SSH connections. </span><span class="koboSpan" id="kobo.55.2">The following diagram shows the logical layout of a managed infrastructure </span><span class="No-Break"><span class="koboSpan" id="kobo.56.1">using Ansible:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer568">
<span class="koboSpan" id="kobo.57.1"><img alt="Figure 17.1 – The logical layout of a managed infrastructure using Ansible" src="image/B19682_17_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.58.1">Figure 17.1 – The logical layout of a managed infrastructure using Ansible</span></p>
<p><span class="koboSpan" id="kobo.59.1">Production-grade enterprise environments</span><a id="_idIndexMarker2496"/><span class="koboSpan" id="kobo.60.1"> usually include a </span><strong class="bold"><span class="koboSpan" id="kobo.61.1">configuration management database</span></strong><span class="koboSpan" id="kobo.62.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.63.1">CMDB</span></strong><span class="koboSpan" id="kobo.64.1">) for organizing their IT infrastructure</span><a id="_idIndexMarker2497"/><span class="koboSpan" id="kobo.65.1"> assets. </span><span class="koboSpan" id="kobo.65.2">Examples of IT infrastructure assets are servers, networks, services, and users. </span><span class="koboSpan" id="kobo.65.3">Although not directly part of the Ansible architecture, the CMDB describes the assets and their relationship within a managed infrastructure</span><a id="_idIndexMarker2498"/><span class="koboSpan" id="kobo.66.1"> and can be leveraged to build an </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.67.1">Ansible inventory</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.69.1">The inventory is</span><a id="_idIndexMarker2499"/><span class="koboSpan" id="kobo.70.1"> local storage on the Ansible control node – typically an </span><strong class="bold"><span class="koboSpan" id="kobo.71.1">INI</span></strong><span class="koboSpan" id="kobo.72.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.73.1">YAML</span></strong><span class="koboSpan" id="kobo.74.1"> file – that describes managed </span><strong class="bold"><span class="koboSpan" id="kobo.75.1">hosts</span></strong><span class="koboSpan" id="kobo.76.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.77.1">groups</span></strong><span class="koboSpan" id="kobo.78.1"> of hosts. </span><span class="koboSpan" id="kobo.78.2">The inventory is either</span><a id="_idIndexMarker2500"/><span class="koboSpan" id="kobo.79.1"> inferred from the CMDB or</span><a id="_idIndexMarker2501"/><span class="koboSpan" id="kobo.80.1"> manually created by the </span><span class="No-Break"><span class="koboSpan" id="kobo.81.1">system administrator.</span></span></p>
<p><span class="koboSpan" id="kobo.82.1">Now, let’s have a closer look at the high-level Ansible architecture shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.83.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer569">
<span class="koboSpan" id="kobo.84.1"><img alt="Figure 17.2 – The Ansible architecture" src="image/B19682_17_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.85.1">Figure 17.2 – The Ansible architecture</span></p>
<p><span class="koboSpan" id="kobo.86.1">The preceding diagram shows the </span><a id="_idIndexMarker2502"/><span class="koboSpan" id="kobo.87.1">Ansible control node interacting with managed hosts in a private or public cloud infrastructure. </span><span class="koboSpan" id="kobo.87.2">Here are some brief descriptions of the blocks featured in the </span><span class="No-Break"><span class="koboSpan" id="kobo.88.1">architectural view:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.89.1">API and core framework</span></strong><span class="koboSpan" id="kobo.90.1">: The main libraries encapsulating Ansible’s core functionality; the Ansible core</span><a id="_idIndexMarker2503"/><span class="koboSpan" id="kobo.91.1"> framework is written </span><span class="No-Break"><span class="koboSpan" id="kobo.92.1">in Python</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.93.1">Plugins</span></strong><span class="koboSpan" id="kobo.94.1">: Additional libraries </span><a id="_idIndexMarker2504"/><span class="koboSpan" id="kobo.95.1">extending the core framework’s </span><a id="_idIndexMarker2505"/><span class="koboSpan" id="kobo.96.1">functionality – for instance, </span><span class="No-Break"><span class="koboSpan" id="kobo.97.1">the</span></span><span class="No-Break"><a id="_idIndexMarker2506"/></span><span class="No-Break"><span class="koboSpan" id="kobo.98.1"> following:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.99.1">Connection plugins</span></strong><span class="koboSpan" id="kobo.100.1">, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.101.1">cloud connectors</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.102.1">Test plugins</span></strong><span class="koboSpan" id="kobo.103.1">, verifying specific </span><span class="No-Break"><span class="koboSpan" id="kobo.104.1">response data</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.105.1">Callback plugins</span></strong><span class="koboSpan" id="kobo.106.1"> for responding </span><span class="No-Break"><span class="koboSpan" id="kobo.107.1">to events</span></span></li></ul></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.108.1">Modules</span></strong><span class="koboSpan" id="kobo.109.1">: These encapsulate </span><a id="_idIndexMarker2507"/><span class="koboSpan" id="kobo.110.1">specific functions running on </span><a id="_idIndexMarker2508"/><span class="koboSpan" id="kobo.111.1">managed hosts, such</span><a id="_idIndexMarker2509"/><span class="koboSpan" id="kobo.112.1"> as </span><span class="No-Break"><span class="koboSpan" id="kobo.113.1">the following:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.114.1">user</span></strong><span class="koboSpan" id="kobo.115.1"> module for </span><span class="No-Break"><span class="koboSpan" id="kobo.116.1">managing users</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.117.1">package</span></strong><span class="koboSpan" id="kobo.118.1"> module for managing </span><span class="No-Break"><span class="koboSpan" id="kobo.119.1">software packages</span></span></li></ul></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.120.1">Inventory</span></strong><span class="koboSpan" id="kobo.121.1">: The INI or YAML file describing the hosts and groups of</span><a id="_idIndexMarker2510"/><span class="koboSpan" id="kobo.122.1"> hosts targeted by Ansible commands </span><span class="No-Break"><span class="koboSpan" id="kobo.123.1">and playbooks</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.124.1">Playbooks</span></strong><span class="koboSpan" id="kobo.125.1">: The Ansible execution files describing a set of tasks </span><a id="_idIndexMarker2511"/><span class="koboSpan" id="kobo.126.1">that target </span><span class="No-Break"><span class="koboSpan" id="kobo.127.1">managed hosts</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.128.1">Private or public clouds</span></strong><span class="koboSpan" id="kobo.129.1">: The managed infrastructure, hosted</span><a id="_idIndexMarker2512"/><span class="koboSpan" id="kobo.130.1"> on-premises or in various cloud environments (for example, VMware, </span><strong class="bold"><span class="koboSpan" id="kobo.131.1">Amazon Web Services</span></strong><span class="koboSpan" id="kobo.132.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.133.1">AWS</span></strong><span class="koboSpan" id="kobo.134.1">), </span><span class="No-Break"><span class="koboSpan" id="kobo.135.1">and Azure)</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.136.1">Managed hosts</span></strong><span class="koboSpan" id="kobo.137.1">: The servers</span><a id="_idIndexMarker2513"/><span class="koboSpan" id="kobo.138.1"> targeted by Ansible</span><a id="_idIndexMarker2514"/><span class="koboSpan" id="kobo.139.1"> commands </span><span class="No-Break"><span class="koboSpan" id="kobo.140.1">and playbooks</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.141.1">CLI</span></strong><span class="koboSpan" id="kobo.142.1">: The </span><a id="_idIndexMarker2515"/><span class="koboSpan" id="kobo.143.1">Ansible CLI tools, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.144.1">ansible</span></strong><span class="koboSpan" id="kobo.145.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">ansible-playbook</span></strong><span class="koboSpan" id="kobo.147.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.148.1">ansible-doc</span></strong><span class="koboSpan" id="kobo.149.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.150.1">so on</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.151.1">Users</span></strong><span class="koboSpan" id="kobo.152.1">: The administrators, power users, and automated user processes running </span><a id="_idIndexMarker2516"/><span class="koboSpan" id="kobo.153.1">Ansible commands </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">or playbooks</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.155.1">Now that we have a basic understanding of the Ansible architecture, let’s look at what makes Ansible a great tool for automating management workflows. </span><span class="koboSpan" id="kobo.155.2">We’ll introduce the concept of </span><strong class="bold"><span class="koboSpan" id="kobo.156.1">configuration </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.157.1">management</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.158.1"> next.</span></span></p>
<h2 id="_idParaDest-346"><a id="_idTextAnchor364"/><span class="koboSpan" id="kobo.159.1">Introducing configuration management</span></h2>
<p><span class="koboSpan" id="kobo.160.1">If we look back at the old days, system administrators usually managed</span><a id="_idIndexMarker2517"/><span class="koboSpan" id="kobo.161.1"> a relatively low number of servers, running everyday administrative tasks by using a remote shell on each host. </span><span class="koboSpan" id="kobo.161.2">Relatively simple operations, such as copying files, updating software packages, and managing users, could easily be scripted and reused regularly. </span><span class="koboSpan" id="kobo.161.3">With the recent surge in apps and services, driven by the vast expansion of the internet, modern-day on-premises and cloud-based IT infrastructures – sustaining the related platforms – have grown significantly. </span><span class="koboSpan" id="kobo.161.4">The sheer amount of configuration changes involved would by far exceed the capacity of a single admin running and maintaining a handful of scripts. </span><span class="koboSpan" id="kobo.161.5">Here’s where configuration management comes to </span><span class="No-Break"><span class="koboSpan" id="kobo.162.1">the rescue.</span></span></p>
<p><span class="koboSpan" id="kobo.163.1">With configuration management, managed hosts and assets are grouped into logical categories, based on specific criteria, as suggested in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.164.1">Figure 17</span></em></span><em class="italic"><span class="koboSpan" id="kobo.165.1">.1</span></em><span class="koboSpan" id="kobo.166.1">. </span><span class="koboSpan" id="kobo.166.2">Managing assets other than hosts ultimately comes down to performing specific tasks on the servers hosting those assets. </span><span class="koboSpan" id="kobo.166.3">The </span><strong class="bold"><span class="koboSpan" id="kobo.167.1">configuration management manifest</span></strong><span class="koboSpan" id="kobo.168.1"> is the Ansible inventory file that manages</span><a id="_idIndexMarker2518"/><span class="koboSpan" id="kobo.169.1"> these hosts and assets. </span><span class="koboSpan" id="kobo.169.2">Thus, Ansible becomes the configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">management endpoint.</span></span></p>
<p><span class="koboSpan" id="kobo.171.1">With Ansible, we can run single one-off commands to carry out specific tasks, but a far more efficient configuration management workflow can be achieved via </span><strong class="bold"><span class="koboSpan" id="kobo.172.1">playbooks</span></strong><span class="koboSpan" id="kobo.173.1">. </span><span class="koboSpan" id="kobo.173.2">With Ansible playbooks, we can run multiple tasks that target various subsystems of a target platform against any number</span><a id="_idIndexMarker2519"/><span class="koboSpan" id="kobo.174.1"> of hosts. </span><span class="koboSpan" id="kobo.174.2">Scheduling </span><strong class="source-inline"><span class="koboSpan" id="kobo.175.1">ansible-playbook</span></strong><span class="koboSpan" id="kobo.176.1"> runs for regular maintenance and configuration management tasks is a common practice in IT infrastructure automation. </span><span class="koboSpan" id="kobo.176.2">We will discuss Ansible playbooks later in </span><span class="No-Break"><span class="koboSpan" id="kobo.177.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.178.1">Running Ansible tasks repeatedly (or on a scheduled basis) against a specific target raises the concern of unwanted changes in the desired state due to repetitive operations. </span><span class="koboSpan" id="kobo.178.2">This issue brings us to one of the essential aspects of configuration management – the </span><strong class="bold"><span class="koboSpan" id="kobo.179.1">idempotency</span></strong><span class="koboSpan" id="kobo.180.1"> of configuration changes. </span><span class="koboSpan" id="kobo.180.2">We’ll look at what idempotent changes </span><span class="No-Break"><span class="koboSpan" id="kobo.181.1">are next.</span></span></p>
<p><span class="koboSpan" id="kobo.182.1">Explaining </span><span class="No-Break"><span class="koboSpan" id="kobo.183.1">idempotent operations</span></span></p>
<p><span class="koboSpan" id="kobo.184.1">In configuration management, an operation is </span><strong class="bold"><span class="koboSpan" id="kobo.185.1">idempotent</span></strong><span class="koboSpan" id="kobo.186.1"> when running it </span><a id="_idIndexMarker2520"/><span class="koboSpan" id="kobo.187.1">multiple times yields the same result as running it once. </span><span class="koboSpan" id="kobo.187.2">In this sense, Ansible is an idempotent configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.188.1">management tool.</span></span></p>
<p><span class="koboSpan" id="kobo.189.1">Let us explain how an idempotent operation works. </span><span class="koboSpan" id="kobo.189.2">Let us suppose we have an Ansible task creating a user. </span><span class="koboSpan" id="kobo.189.3">When the task runs for the first time, it creates the user. </span><span class="koboSpan" id="kobo.189.4">Running it for a second time – when the user has already been</span><a id="_idIndexMarker2521"/><span class="koboSpan" id="kobo.190.1"> created – would result in a </span><strong class="bold"><span class="koboSpan" id="kobo.191.1">no-operation</span></strong><span class="koboSpan" id="kobo.192.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.193.1">no-op</span></strong><span class="koboSpan" id="kobo.194.1">). </span><em class="italic"><span class="koboSpan" id="kobo.195.1">Without</span></em><span class="koboSpan" id="kobo.196.1"> idempotency, subsequent runs of the same task would produce errors due to attempting to create a user that </span><span class="No-Break"><span class="koboSpan" id="kobo.197.1">already exists.</span></span></p>
<p><span class="koboSpan" id="kobo.198.1">We should note that Ansible is not the only configuration management tool on the market. </span><span class="koboSpan" id="kobo.198.2">We have </span><strong class="bold"><span class="koboSpan" id="kobo.199.1">Chef</span></strong><span class="koboSpan" id="kobo.200.1">, </span><strong class="bold"><span class="koboSpan" id="kobo.201.1">Puppet</span></strong><span class="koboSpan" id="kobo.202.1">, and </span><strong class="bold"><span class="koboSpan" id="kobo.203.1">SaltStack</span></strong><span class="koboSpan" id="kobo.204.1">, to name a few. </span><span class="koboSpan" id="kobo.204.2">Most of these platforms have been acquired by larger enterprises, such as SaltStack, being owned by VMware, and some may </span><a id="_idIndexMarker2522"/><span class="koboSpan" id="kobo.205.1">argue that Ansible’s success could be attributed to Red Hat’s open sourcing of the project. </span><span class="koboSpan" id="kobo.205.2">Ansible appears to be the most successful configuration management platform of our day. </span><span class="koboSpan" id="kobo.205.3">The industry consensus is that Ansible provides a user-friendly experience, high scalability, and affordable licensing tiers in </span><span class="No-Break"><span class="koboSpan" id="kobo.206.1">enterprise-grade deployments.</span></span></p>
<p><span class="koboSpan" id="kobo.207.1">With the introductory concepts covered, let’s roll up our sleeves and install Ansible on a Linux platform </span><span class="No-Break"><span class="koboSpan" id="kobo.208.1">of choice.</span></span></p>
<h1 id="_idParaDest-347"><a id="_idTextAnchor365"/><span class="koboSpan" id="kobo.209.1">Installing Ansible</span></h1>
<p><span class="koboSpan" id="kobo.210.1">In this section, we’ll show you</span><a id="_idIndexMarker2523"/><span class="koboSpan" id="kobo.211.1"> how to install Ansible on a </span><strong class="bold"><span class="koboSpan" id="kobo.212.1">control node</span></strong><span class="koboSpan" id="kobo.213.1">. </span><span class="koboSpan" id="kobo.213.2">On Linux, we</span><a id="_idIndexMarker2524"/><span class="koboSpan" id="kobo.214.1"> can install Ansible in a couple </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">of ways:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.216.1">Using the platform-specific package manager (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.217.1">apt</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.218.1">on Ubuntu/Debian)</span></span></li>
<li><span class="koboSpan" id="kobo.219.1">Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.220.1">pip</span></strong><span class="koboSpan" id="kobo.221.1">, the Python </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">package manager</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.223.1">The Ansible community recommends </span><strong class="source-inline"><span class="koboSpan" id="kobo.224.1">pip</span></strong><span class="koboSpan" id="kobo.225.1"> for installing Ansible since it provides the most recent stable version of Ansible. </span><span class="koboSpan" id="kobo.225.2">In this section, we’ll use Ubuntu as our distribution of choice. </span><span class="koboSpan" id="kobo.225.3">For a complete Ansible installation</span><a id="_idIndexMarker2525"/><span class="koboSpan" id="kobo.226.1"> guide for all major OS platforms, please follow the online documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">at </span></span><a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html"><span class="No-Break"><span class="koboSpan" id="kobo.228.1">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.229.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.230.1">On the control node, Ansible requires Python, so before installing Ansible, we need to make sure we have Python installed on </span><span class="No-Break"><span class="koboSpan" id="kobo.231.1">our system.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.232.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.233.1">Python 2 is no longer supported as of January 1, 2020. </span><span class="koboSpan" id="kobo.233.2">Please use Python 3.8 (or </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">newer) instead.</span></span></p>
<p><span class="koboSpan" id="kobo.235.1">Let’s start by installing Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.236.1">on Ubuntu.</span></span></p>
<h2 id="_idParaDest-348"><a id="_idTextAnchor366"/><span class="koboSpan" id="kobo.237.1">Installing Ansible on Ubuntu</span></h2>
<p><span class="koboSpan" id="kobo.238.1">With Ubuntu 22.04 LTS, we </span><a id="_idIndexMarker2526"/><span class="koboSpan" id="kobo.239.1">have Python 3 installed by default. </span><span class="koboSpan" id="kobo.239.2">We can</span><a id="_idIndexMarker2527"/><span class="koboSpan" id="kobo.240.1"> proceed with installing Ansible by following </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.242.1">Let’s first check the Python 3 version we have by using the </span><span class="No-Break"><span class="koboSpan" id="kobo.243.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.244.1">python3 --version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.245.1">On our Ubuntu 20.04 machine, the Python version is </span><span class="No-Break"><span class="koboSpan" id="kobo.246.1">as follows:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.247.1">Python 3.10.12</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.248.1">If you don’t have Python 3 installed, you can install it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">following command:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.250.1">sudo apt install -y python3</span></strong></pre></li> <li><span class="koboSpan" id="kobo.251.1">With Python 3 installed, we </span><a id="_idIndexMarker2528"/><span class="koboSpan" id="kobo.252.1">can proceed with installing Ansible. </span><span class="koboSpan" id="kobo.252.2">To get the most up-to-date Ansible packages using </span><strong class="source-inline"><span class="koboSpan" id="kobo.253.1">apt</span></strong><span class="koboSpan" id="kobo.254.1">, we need to add the Ansible </span><strong class="bold"><span class="koboSpan" id="kobo.255.1">Personal Package Archives</span></strong><span class="koboSpan" id="kobo.256.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.257.1">PPA</span></strong><span class="koboSpan" id="kobo.258.1">) repository to our </span><a id="_idIndexMarker2529"/><span class="koboSpan" id="kobo.259.1">system. </span><span class="koboSpan" id="kobo.259.2">Let’s start by updating the current </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">apt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.261.1"> repository:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.262.1">sudo apt update</span></strong></pre></li> <li><span class="koboSpan" id="kobo.263.1">Next, we must add the </span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">Ansible PPA:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.265.1">sudo apt install -y software-properties-common</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.266.1">sudo apt-add-repository --update ppa:ansible/ansible -y</span></strong></pre></li> <li><span class="koboSpan" id="kobo.267.1">Now, we can install the Ansible package with the </span><span class="No-Break"><span class="koboSpan" id="kobo.268.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.269.1">sudo apt install ansible -y</span></strong></pre></li> <li><span class="koboSpan" id="kobo.270.1">With Ansible installed, we can check its </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">current version:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.272.1">ansible --version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.273.1">In our case, the relevant excerpt in the output of the previous command is </span><span class="No-Break"><span class="koboSpan" id="kobo.274.1">as follows:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.275.1">ansible [core 2.15.4]</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.276.1">Next, we’ll look at how to install Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.277.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.278.1">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.279.1">.</span></span></p>
<h2 id="_idParaDest-349"><a id="_idTextAnchor367"/><span class="koboSpan" id="kobo.280.1">Installing Ansible using pip</span></h2>
<p><span class="koboSpan" id="kobo.281.1">Before we install Ansible </span><a id="_idIndexMarker2530"/><span class="koboSpan" id="kobo.282.1">with </span><strong class="source-inline"><span class="koboSpan" id="kobo.283.1">pip</span></strong><span class="koboSpan" id="kobo.284.1">, we need to make sure Python is installed on the system. </span><span class="koboSpan" id="kobo.284.2">We assume Python 3 is</span><a id="_idIndexMarker2531"/><span class="koboSpan" id="kobo.285.1"> installed based on the steps presented in the previous section. </span><span class="koboSpan" id="kobo.285.2">When installing Ansible using </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">pip</span></strong><span class="koboSpan" id="kobo.287.1">, it is a safe practice to previously uninstall any version of Ansible that was installed using the local package manager (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.288.1">apt</span></strong><span class="koboSpan" id="kobo.289.1">). </span><span class="koboSpan" id="kobo.289.2">This will ensure that </span><strong class="source-inline"><span class="koboSpan" id="kobo.290.1">pip</span></strong><span class="koboSpan" id="kobo.291.1"> will install the latest version of Ansible successfully. </span><span class="koboSpan" id="kobo.291.2">To proceed with the installation, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.292.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.293.1">We should remove any existing version of Ansible that’s been installed with the platform-specific package manager (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">apt</span></strong><span class="koboSpan" id="kobo.295.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.296.1">yum</span></strong><span class="koboSpan" id="kobo.297.1">). </span><span class="koboSpan" id="kobo.297.2">To uninstall Ansible on Ubuntu, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.298.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.299.1">sudo apt remove -y ansible</span></strong></pre></li> <li><span class="koboSpan" id="kobo.300.1">Next, we must make sure </span><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">pip</span></strong><span class="koboSpan" id="kobo.302.1"> is installed. </span><span class="koboSpan" id="kobo.302.2">The following command should provide the current version </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.306.1">python3 -m pip --version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.307.1">If </span><strong class="source-inline"><span class="koboSpan" id="kobo.308.1">pip</span></strong><span class="koboSpan" id="kobo.309.1"> is not installed, the </span><a id="_idIndexMarker2532"/><span class="koboSpan" id="kobo.310.1">following output </span><span class="No-Break"><span class="koboSpan" id="kobo.311.1">will show:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.312.1">/usr/bin/python3: No module named pip</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.313.1">We must then </span><a id="_idIndexMarker2533"/><span class="koboSpan" id="kobo.314.1">download the </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">pip</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.316.1">installer first:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.317.1">curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py</span></strong></pre></li> <li><span class="koboSpan" id="kobo.318.1">We’re now ready to install </span><strong class="source-inline"><span class="koboSpan" id="kobo.319.1">pip</span></strong><span class="koboSpan" id="kobo.320.1"> and Ansible with the </span><span class="No-Break"><span class="koboSpan" id="kobo.321.1">following commands:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.322.1">python3 get-pip.py --user</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.323.1">python3 -m pip install --user ansible</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.324.1">Please note that, with the previous commands, we only installed </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">pip</span></strong><span class="koboSpan" id="kobo.326.1"> and Ansible for the current user (hence the </span><strong class="source-inline"><span class="koboSpan" id="kobo.327.1">--user</span></strong><span class="koboSpan" id="kobo.328.1"> option </span><span class="No-Break"><span class="koboSpan" id="kobo.329.1">we used).</span></span></p></li> <li><span class="koboSpan" id="kobo.330.1">If you wish to install Ansible </span><em class="italic"><span class="koboSpan" id="kobo.331.1">globally</span></em><span class="koboSpan" id="kobo.332.1"> on the system, the equivalent commands are </span><span class="No-Break"><span class="koboSpan" id="kobo.333.1">as follows:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.334.1">sudo python3 get-pip.py</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.335.1">sudo python3 -m pip install ansible</span></strong></pre></li> <li><span class="koboSpan" id="kobo.336.1">After the installation completes, you may have to log out and log back in to your Terminal again before using Ansible. </span><span class="koboSpan" id="kobo.336.2">You can check the Ansible version you have installed with the </span><span class="No-Break"><span class="koboSpan" id="kobo.337.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.338.1">ansible --version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.339.1">In our case, the output shows </span><span class="No-Break"><span class="koboSpan" id="kobo.340.1">the following:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.341.1">ansible [core 2.15.4]</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.342.1">As you can see, you can get the most recent version (as of writing) of Ansible by</span><a id="_idIndexMarker2534"/><span class="koboSpan" id="kobo.343.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.344.1">pip</span></strong><span class="koboSpan" id="kobo.345.1">. </span><span class="koboSpan" id="kobo.345.2">Therefore, it is the recommended </span><a id="_idIndexMarker2535"/><span class="koboSpan" id="kobo.346.1">method of </span><span class="No-Break"><span class="koboSpan" id="kobo.347.1">installing Ansible.</span></span></p>
<p><span class="koboSpan" id="kobo.348.1">With Ansible installed on our control node, let’s look at some practical examples of </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">using Ansible.</span></span></p>
<h1 id="_idParaDest-350"><a id="_idTextAnchor368"/><span class="koboSpan" id="kobo.350.1">Working with Ansible</span></h1>
<p><span class="koboSpan" id="kobo.351.1">In this section, we’ll use the Ansible CLI tools extensively to perform various configuration</span><a id="_idIndexMarker2536"/><span class="koboSpan" id="kobo.352.1"> management tasks. </span><span class="koboSpan" id="kobo.352.2">To showcase our practical examples, we’ll work with a custom lab environment, and we highly encourage you to reproduce it for a complete configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.353.1">management experience.</span></span></p>
<p><span class="koboSpan" id="kobo.354.1">Here’s a high-level outline of </span><span class="No-Break"><span class="koboSpan" id="kobo.355.1">this section:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.356.1">Setting up the </span><span class="No-Break"><span class="koboSpan" id="kobo.357.1">lab environment</span></span></li>
<li><span class="No-Break"><span class="koboSpan" id="kobo.358.1">Configuring Ansible</span></span></li>
<li><span class="koboSpan" id="kobo.359.1">Using Ansible ad </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">hoc commands</span></span></li>
<li><span class="koboSpan" id="kobo.361.1">Using </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">Ansible playbooks</span></span></li>
<li><span class="koboSpan" id="kobo.363.1">Using templates </span><span class="No-Break"><span class="koboSpan" id="kobo.364.1">with Jinja2</span></span></li>
<li><span class="koboSpan" id="kobo.365.1">Using </span><span class="No-Break"><span class="koboSpan" id="kobo.366.1">Ansible roles</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.367.1">Let’s start with an overview of the </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">lab environment.</span></span></p>
<h2 id="_idParaDest-351"><a id="_idTextAnchor369"/><span class="koboSpan" id="kobo.369.1">Setting up the lab environment</span></h2>
<p><span class="koboSpan" id="kobo.370.1">Our lab uses </span><strong class="bold"><span class="koboSpan" id="kobo.371.1">Kernel-based Virtual Machine</span></strong><span class="koboSpan" id="kobo.372.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.373.1">KVM</span></strong><span class="koboSpan" id="kobo.374.1">) as a hypervisor for the virtual environment, but any other </span><a id="_idIndexMarker2537"/><span class="koboSpan" id="kobo.375.1">hypervisor will do. </span><a href="B19682_11.xhtml#_idTextAnchor231"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.376.1">Chapter 11</span></em></span></a><span class="koboSpan" id="kobo.377.1">, </span><em class="italic"><span class="koboSpan" id="kobo.378.1">Working with Virtual Machines</span></em><span class="koboSpan" id="kobo.379.1">, describes the process of</span><a id="_idIndexMarker2538"/><span class="koboSpan" id="kobo.380.1"> creating Linux </span><strong class="bold"><span class="koboSpan" id="kobo.381.1">virtual machines</span></strong><span class="koboSpan" id="kobo.382.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.383.1">VMs</span></strong><span class="koboSpan" id="kobo.384.1">) in detail. </span><span class="koboSpan" id="kobo.384.2">We deployed the following VMs using Ubuntu Server LTS to mimic a real-world configuration </span><a id="_idIndexMarker2539"/><span class="No-Break"><span class="koboSpan" id="kobo.385.1">management infrastructure:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.386.1">neptune</span></strong><span class="koboSpan" id="kobo.387.1">: The Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.388.1">control node</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.389.1">ans-web1</span></strong><span class="koboSpan" id="kobo.390.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.391.1">Web server</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.392.1">ans-web2</span></strong><span class="koboSpan" id="kobo.393.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.394.1">Web server</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.395.1">ans-db1</span></strong><span class="koboSpan" id="kobo.396.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.397.1">Database server</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.398.1">ans-db2</span></strong><span class="koboSpan" id="kobo.399.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.400.1">Database server</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.401.1">All VMs have the default server components installed. </span><span class="koboSpan" id="kobo.401.2">On each host, we created a default admin user called </span><strong class="source-inline"><span class="koboSpan" id="kobo.402.1">packt</span></strong><span class="koboSpan" id="kobo.403.1"> with</span><a id="_idIndexMarker2540"/><span class="koboSpan" id="kobo.404.1"> SSH access enabled. </span><span class="koboSpan" id="kobo.404.2">Each VM will have 2 vCPUs, 2 GB of RAM, and 20 </span><span class="No-Break"><span class="koboSpan" id="kobo.405.1">GB minimum.</span></span></p>
<p><span class="koboSpan" id="kobo.406.1">Now, let’s briefly describe the setup for these VMs, starting with </span><span class="No-Break"><span class="koboSpan" id="kobo.407.1">managed hosts.</span></span></p>
<h3><span class="koboSpan" id="kobo.408.1">Setting up managed hosts</span></h3>
<p><span class="koboSpan" id="kobo.409.1">There are a couple of key requirements for managed hosts to fully enable</span><a id="_idIndexMarker2541"/><span class="koboSpan" id="kobo.410.1"> configuration management access from the Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.411.1">control node:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.412.1">They must have an OpenSSH server installed </span><span class="No-Break"><span class="koboSpan" id="kobo.413.1">and running</span></span></li>
<li><span class="koboSpan" id="kobo.414.1">They must have </span><span class="No-Break"><span class="koboSpan" id="kobo.415.1">Python installed</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.416.1">As specified in the </span><em class="italic"><span class="koboSpan" id="kobo.417.1">Technical requirements</span></em><span class="koboSpan" id="kobo.418.1"> section, we assume you have OpenSSH enabled on your hosts. </span><span class="koboSpan" id="kobo.418.2">For installing Python, you may follow the related steps described in the </span><em class="italic"><span class="koboSpan" id="kobo.419.1">Installing </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.420.1">Ansible</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.421.1"> section.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.422.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.423.1">Managed hosts don’t require Ansible to be installed on </span><span class="No-Break"><span class="koboSpan" id="kobo.424.1">the system.</span></span></p>
<p><span class="koboSpan" id="kobo.425.1">To set the hostname on each VM, you may run the following command (for example, for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">ans-web1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.427.1"> hostname):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.428.1">
sudo hostnamectl set-hostname ans-web1</span></pre> <p><span class="koboSpan" id="kobo.429.1">We also want to disable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.430.1">sudo</span></strong><span class="koboSpan" id="kobo.431.1"> login password on our managed hosts to facilitate unattended privilege escalation when running automated scripts. </span><span class="koboSpan" id="kobo.431.2">If we don’t make this change, remotely executing Ansible commands will require </span><span class="No-Break"><span class="koboSpan" id="kobo.432.1">a password.</span></span></p>
<p><span class="koboSpan" id="kobo.433.1">To disable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.434.1">sudo</span></strong><span class="koboSpan" id="kobo.435.1"> login password, edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.436.1">sudo</span></strong><span class="koboSpan" id="kobo.437.1"> configuration with the </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.439.1">
sudo visudo</span></pre> <p><span class="koboSpan" id="kobo.440.1">Add the following line and save </span><a id="_idIndexMarker2542"/><span class="koboSpan" id="kobo.441.1">the configuration file. </span><span class="koboSpan" id="kobo.441.2">Replace </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">packt</span></strong><span class="koboSpan" id="kobo.443.1"> with your username if </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">it’s different:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.445.1">
packt ALL=(ALL) NOPASSWD:ALL</span></pre> <p><span class="koboSpan" id="kobo.446.1">You’ll have to </span><a id="_idIndexMarker2543"/><span class="koboSpan" id="kobo.447.1">make this change on all </span><span class="No-Break"><span class="koboSpan" id="kobo.448.1">managed hosts.</span></span></p>
<p><span class="koboSpan" id="kobo.449.1">Next, we’ll look at the initial setup for the Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.450.1">control node.</span></span></p>
<h3><span class="koboSpan" id="kobo.451.1">Setting up the Ansible control node</span></h3>
<p><span class="koboSpan" id="kobo.452.1">The Ansible </span><strong class="bold"><span class="koboSpan" id="kobo.453.1">control node</span></strong><span class="koboSpan" id="kobo.454.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.455.1">neptune</span></strong><span class="koboSpan" id="kobo.456.1">) interacts with </span><strong class="bold"><span class="koboSpan" id="kobo.457.1">managed hosts</span></strong><span class="koboSpan" id="kobo.458.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.459.1">ans-web1</span></strong><span class="koboSpan" id="kobo.460.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">ans-web2</span></strong><span class="koboSpan" id="kobo.462.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">ans-db1</span></strong><span class="koboSpan" id="kobo.464.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.465.1">ans-db2</span></strong><span class="koboSpan" id="kobo.466.1">) using Ansible commands and playbooks. </span><span class="koboSpan" id="kobo.466.2">For </span><a id="_idIndexMarker2544"/><span class="koboSpan" id="kobo.467.1">convenience, our examples will reference the managed hosts by their hostnames instead of their IP addresses. </span><span class="koboSpan" id="kobo.467.2">To easily accomplish this, we added the following entries to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.468.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.469.1"> file on the Ansible control </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">node (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.471.1">neptune</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.472.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.473.1">
127.0.0.1 neptune localhost
192.168.122.70 ans-web1
192.168.122.147 ans-web2
192.168.122.254 ans-db1
192.168.122.25 ans-db2</span></pre> <p><span class="koboSpan" id="kobo.474.1">You’ll have to match the</span><a id="_idIndexMarker2545"/><span class="koboSpan" id="kobo.475.1"> hostnames and IP addresses according to your </span><span class="No-Break"><span class="koboSpan" id="kobo.476.1">VM environment.</span></span></p>
<p><span class="koboSpan" id="kobo.477.1">Next, we must install Ansible on our managed hosts too. </span><span class="koboSpan" id="kobo.477.2">Use the related procedure described in the </span><em class="italic"><span class="koboSpan" id="kobo.478.1">Installing Ansible</span></em><span class="koboSpan" id="kobo.479.1"> section earlier in this chapter, when we showed you how to install Ansible on the control node. </span><span class="koboSpan" id="kobo.479.2">In our case, we followed the steps in the </span><em class="italic"><span class="koboSpan" id="kobo.480.1">Installing Ansible using pip</span></em><span class="koboSpan" id="kobo.481.1"> section to benefit from the latest Ansible release at the time </span><span class="No-Break"><span class="koboSpan" id="kobo.482.1">of writing.</span></span></p>
<p><span class="koboSpan" id="kobo.483.1">Finally, we’ll set up SSH key-based authentication between the Ansible control node and the </span><span class="No-Break"><span class="koboSpan" id="kobo.484.1">managed hosts.</span></span></p>
<h3><span class="koboSpan" id="kobo.485.1">Setting up SSH key-based authentication</span></h3>
<p><span class="koboSpan" id="kobo.486.1">Ansible uses SSH communication with managed hosts. </span><span class="koboSpan" id="kobo.486.2">The SSH key authentication</span><a id="_idIndexMarker2546"/><span class="koboSpan" id="kobo.487.1"> mechanism enables remote SSH access without the need to enter user passwords. </span><span class="koboSpan" id="kobo.487.2">To enable SSH key-based authentication, run the following commands on the Ansible control </span><span class="No-Break"><span class="koboSpan" id="kobo.488.1">host (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">neptune</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.491.1">Use the following command to generate a secure key pair and follow the </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">default prompts:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.493.1">
ssh-keygen</span></pre> <p><span class="koboSpan" id="kobo.494.1">With the key pair generated, copy the related public key to each managed host. </span><span class="koboSpan" id="kobo.494.2">You’ll have to target one host at a time and authenticate with the remote </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">packt</span></strong><span class="koboSpan" id="kobo.496.1"> user’s password. </span><span class="koboSpan" id="kobo.496.2">Accept the SSH key exchange </span><span class="No-Break"><span class="koboSpan" id="kobo.497.1">when prompted:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.498.1">
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-web1
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-web2
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-db1
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-db2</span></pre> <p><span class="koboSpan" id="kobo.499.1">Now, you should be able to SSH into any of the managed hosts from the Ansible control node (</span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">neptune</span></strong><span class="koboSpan" id="kobo.501.1">) without being prompted for a password. </span><span class="koboSpan" id="kobo.501.2">For example, to access </span><strong class="source-inline"><span class="koboSpan" id="kobo.502.1">ans-web1</span></strong><span class="koboSpan" id="kobo.503.1">, you can test it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.504.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.505.1">
ssh packt@ans-web1</span></pre> <p><span class="koboSpan" id="kobo.506.1">The command will take you to the remote server’s (</span><strong class="source-inline"><span class="koboSpan" id="kobo.507.1">ans-web1</span></strong><span class="koboSpan" id="kobo.508.1">) Terminal. </span><span class="koboSpan" id="kobo.508.2">Make sure you go back to the Ansible control node’s Terminal (on </span><strong class="source-inline"><span class="koboSpan" id="kobo.509.1">neptune</span></strong><span class="koboSpan" id="kobo.510.1">) before following the </span><span class="No-Break"><span class="koboSpan" id="kobo.511.1">next steps.</span></span></p>
<p><span class="koboSpan" id="kobo.512.1">We’re now ready to configure Ansible on the </span><span class="No-Break"><span class="koboSpan" id="kobo.513.1">control node.</span></span></p>
<h2 id="_idParaDest-352"><a id="_idTextAnchor370"/><span class="koboSpan" id="kobo.514.1">Configuring Ansible</span></h2>
<p><span class="koboSpan" id="kobo.515.1">This section explores some of the basic configuration concepts of Ansible that are</span><a id="_idIndexMarker2547"/><span class="koboSpan" id="kobo.516.1"> related to the Ansible </span><strong class="bold"><span class="koboSpan" id="kobo.517.1">configuration file</span></strong><span class="koboSpan" id="kobo.518.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.519.1">inventory</span></strong><span class="koboSpan" id="kobo.520.1">. </span><span class="koboSpan" id="kobo.520.2">Using a configuration file and the parameters within, we can change the </span><em class="italic"><span class="koboSpan" id="kobo.521.1">behavior</span></em><span class="koboSpan" id="kobo.522.1"> of Ansible, such as privilege escalation, connection timeout, and default inventory file path. </span><span class="koboSpan" id="kobo.522.2">The inventory defines managed hosts, acting as the CMDB </span><span class="No-Break"><span class="koboSpan" id="kobo.523.1">of Ansible.</span></span></p>
<p><span class="koboSpan" id="kobo.524.1">Let’s look at the Ansible configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.525.1">file first.</span></span></p>
<h3><span class="koboSpan" id="kobo.526.1">Creating an Ansible configuration file</span></h3>
<p><span class="koboSpan" id="kobo.527.1">The following command provides some helpful information about our Ansible </span><a id="_idIndexMarker2548"/><span class="koboSpan" id="kobo.528.1">environment, including the current </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">configuration file:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.530.1">
ansible --version</span></pre> <p><span class="koboSpan" id="kobo.531.1">Here’s the complete output of the </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">preceding command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer570">
<span class="koboSpan" id="kobo.533.1"><img alt="Figure 17.3 – The default Ansible configuration settings" src="image/B19682_17_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.534.1">Figure 17.3 – The default Ansible configuration settings</span></p>
<p><span class="koboSpan" id="kobo.535.1">A default Ansible installation will set the configuration file path to </span><strong class="source-inline"><span class="koboSpan" id="kobo.536.1">/etc/ansible/ansible.cfg</span></strong><span class="koboSpan" id="kobo.537.1">. </span><span class="koboSpan" id="kobo.537.2">As you can probably guess, the default configuration file has a </span><em class="italic"><span class="koboSpan" id="kobo.538.1">global scope</span></em><span class="koboSpan" id="kobo.539.1">, which means that it’s used by default when we run </span><span class="No-Break"><span class="koboSpan" id="kobo.540.1">Ansible tasks.</span></span></p>
<p><span class="koboSpan" id="kobo.541.1">Now, let’s look at some different scenarios and how they can </span><span class="No-Break"><span class="koboSpan" id="kobo.542.1">be addressed:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.543.1">What if there are multiple users on the same control host running Ansible tasks? </span><span class="koboSpan" id="kobo.543.2">Our instinct suggests that each user may have their own set of configuration parameters. </span><span class="koboSpan" id="kobo.543.3">Ansible resolves this problem by looking into the user’s home directory for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.544.1">~/.ansible.cfg</span></strong><span class="koboSpan" id="kobo.545.1"> file. </span><span class="koboSpan" id="kobo.545.2">Let’s verify this behavior by creating a dummy configuration file in our user’s (</span><strong class="source-inline"><span class="koboSpan" id="kobo.546.1">packt</span></strong><span class="koboSpan" id="kobo.547.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.548.1">home directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.549.1">touch ~/.ansible.cfg</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.550.1">A new invocation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.551.1">ansible --version</span></strong><span class="koboSpan" id="kobo.552.1"> command now yields the following </span><strong class="source-inline"><span class="koboSpan" id="kobo.553.1">config </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.554.1">file</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.555.1"> path:</span></span></p></li> </ul>
<div>
<div class="IMG---Figure" id="_idContainer571">
<span class="koboSpan" id="kobo.556.1"><img alt="Figure 17.4 – Changing the default configuration file" src="image/B19682_17_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.557.1">Figure 17.4 – Changing the default configuration file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.558.1">In other words, </span><strong class="source-inline"><span class="koboSpan" id="kobo.559.1">~/.ansible.cfg</span></strong><span class="koboSpan" id="kobo.560.1"> takes precedence over the global </span><strong class="source-inline"><span class="koboSpan" id="kobo.561.1">/etc/ansible/ansible.cfg</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.562.1">configuration file.</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.563.1">Now, suppose our user (</span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">packt</span></strong><span class="koboSpan" id="kobo.565.1">) creates multiple Ansible projects, some managing on-premises hosts </span><a id="_idIndexMarker2549"/><span class="koboSpan" id="kobo.566.1">and others interacting with public cloud resources. </span><span class="koboSpan" id="kobo.566.2">Again, we may need a different set of Ansible configuration parameters (such as a connection timeout and inventory file). </span><span class="koboSpan" id="kobo.566.3">Ansible accommodates this scenario by looking for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">./ansible.cfg</span></strong><span class="koboSpan" id="kobo.568.1"> file in the </span><span class="No-Break"><span class="koboSpan" id="kobo.569.1">current folder.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.570.1">Let’s create a dummy </span><strong class="source-inline"><span class="koboSpan" id="kobo.571.1">ansible.cfg</span></strong><span class="koboSpan" id="kobo.572.1"> file in a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">~/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.574.1">ansible/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.575.1"> directory:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.576.1">mkdir ~/ansible</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.577.1">touch ~/ansible/ansible.cfg</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.578.1">Switching to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.579.1">~/ansible</span></strong><span class="koboSpan" id="kobo.580.1"> directory and invoking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.581.1">ansible --version</span></strong><span class="koboSpan" id="kobo.582.1"> command shows the following </span><span class="No-Break"><span class="koboSpan" id="kobo.583.1">config file:</span></span></p></li> </ul>
<div>
<div class="IMG---Figure" id="_idContainer572">
<span class="koboSpan" id="kobo.584.1"><img alt="Figure 17.5 – Changing the current directory and configuration file" src="image/B19682_17_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.585.1">Figure 17.5 – Changing the current directory and configuration file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.586.1">We could have named our project directory anything, not necessarily </span><strong class="source-inline"><span class="koboSpan" id="kobo.587.1">/home/packt/ansible</span></strong><span class="koboSpan" id="kobo.588.1">. </span><span class="koboSpan" id="kobo.588.2">Ansible prioritizes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.589.1">./ansible.cfg</span></strong><span class="koboSpan" id="kobo.590.1"> file over the </span><strong class="source-inline"><span class="koboSpan" id="kobo.591.1">~/.ansible.cfg</span></strong><span class="koboSpan" id="kobo.592.1"> configuration</span><a id="_idIndexMarker2550"/><span class="koboSpan" id="kobo.593.1"> file in the user’s </span><span class="No-Break"><span class="koboSpan" id="kobo.594.1">home directory.</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.595.1">Finally, we may want the ultimate flexibility of a configuration file that doesn’t depend on the directory or location originating from our Ansible commands. </span><span class="koboSpan" id="kobo.595.2">Such a feature could be helpful while testing ad hoc configurations without altering the main configuration file. </span><span class="koboSpan" id="kobo.595.3">For this purpose, Ansible reads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.596.1">ANSIBLE_CONFIG</span></strong><span class="koboSpan" id="kobo.597.1"> environment variable for the path of the </span><span class="No-Break"><span class="koboSpan" id="kobo.598.1">configuration file.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.599.1">Assuming we are in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">~/ansible</span></strong><span class="koboSpan" id="kobo.601.1"> project folder, where we already have our local </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">ansible.cfg</span></strong><span class="koboSpan" id="kobo.603.1"> file defined, let’s create a dummy test configuration file </span><span class="No-Break"><span class="koboSpan" id="kobo.604.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.605.1">test.cfg</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.606.1">:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.607.1">cd ~/ansible</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.608.1">touch test.cfg</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.609.1">Now, let’s verify that Ansible will read the configuration from </span><strong class="source-inline"><span class="koboSpan" id="kobo.610.1">test.cfg</span></strong><span class="koboSpan" id="kobo.611.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.612.1">ansible.cfg</span></strong><span class="koboSpan" id="kobo.613.1"> when the </span><strong class="source-inline"><span class="koboSpan" id="kobo.614.1">ANSIBLE_CONFIG</span></strong><span class="koboSpan" id="kobo.615.1"> environment variable </span><span class="No-Break"><span class="koboSpan" id="kobo.616.1">is set:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.617.1">ANSIBLE_CONFIG=test.cfg ansible --version</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.618.1">The output shows </span><span class="No-Break"><span class="koboSpan" id="kobo.619.1">the following:</span></span></p></li> </ul>
<div>
<div class="IMG---Figure" id="_idContainer573">
<span class="koboSpan" id="kobo.620.1"><img alt="Figure 17.6 – Verifying reading of the new configuration file" src="image/B19682_17_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.621.1">Figure 17.6 – Verifying reading of the new configuration file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.622.1">We should note that the configuration file should always have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.623.1">.cfg</span></strong><span class="koboSpan" id="kobo.624.1"> extension. </span><span class="koboSpan" id="kobo.624.2">Otherwise, Ansible will </span><span class="No-Break"><span class="koboSpan" id="kobo.625.1">discard it.</span></span></p>
<p><span class="koboSpan" id="kobo.626.1">Here’s a list summarizing the order</span><a id="_idIndexMarker2551"/><span class="koboSpan" id="kobo.627.1"> of precedence in descending order for Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.628.1">configuration files:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.629.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.630.1">ANSIBLE_CONFIG</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.631.1">environment variable</span></span></li>
<li><span class="koboSpan" id="kobo.632.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">./ansible.cfg</span></strong><span class="koboSpan" id="kobo.634.1"> file in the </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">local directory</span></span></li>
<li><span class="koboSpan" id="kobo.636.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.637.1">~/.ansible.cfg</span></strong><span class="koboSpan" id="kobo.638.1"> file in the user’s </span><span class="No-Break"><span class="koboSpan" id="kobo.639.1">home directory</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.640.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">etc/ansible/ansible.cfg</span></strong></span></li>
</ol>
<p><span class="koboSpan" id="kobo.642.1">In our examples, we’ll rely on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.643.1">ansible.cfg</span></strong><span class="koboSpan" id="kobo.644.1"> configuration file in a local project directory (</span><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">~/ansible</span></strong><span class="koboSpan" id="kobo.646.1">). </span><span class="koboSpan" id="kobo.646.2">Let’s create this configuration file and leave it empty </span><span class="No-Break"><span class="koboSpan" id="kobo.647.1">for now:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.648.1">
mkdir ~/ansible
cd ~/ansible
touch ansible.cfg</span></pre> <p><span class="koboSpan" id="kobo.649.1">For the rest of this chapter, we’ll run our Ansible commands from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.650.1">~/ansible</span></strong><span class="koboSpan" id="kobo.651.1"> folder unless we </span><span class="No-Break"><span class="koboSpan" id="kobo.652.1">specify otherwise.</span></span></p>
<p><span class="koboSpan" id="kobo.653.1">Unless we specifically </span><a id="_idIndexMarker2552"/><span class="koboSpan" id="kobo.654.1">define (override) configuration parameters in our configuration file, Ansible will assume the system defaults. </span><span class="koboSpan" id="kobo.654.2">One of the attributes that we’ll add to the config file is the inventory file path. </span><span class="koboSpan" id="kobo.654.3">But first, we’ll need to create an inventory. </span><span class="koboSpan" id="kobo.654.4">The following section will show </span><span class="No-Break"><span class="koboSpan" id="kobo.655.1">you how.</span></span></p>
<h3><span class="koboSpan" id="kobo.656.1">Creating an Ansible inventory</span></h3>
<p><span class="koboSpan" id="kobo.657.1">An Ansible inventory is a regular </span><strong class="bold"><span class="koboSpan" id="kobo.658.1">INI</span></strong><span class="koboSpan" id="kobo.659.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.660.1">YAML</span></strong><span class="koboSpan" id="kobo.661.1"> file describing the managed</span><a id="_idIndexMarker2553"/><span class="koboSpan" id="kobo.662.1"> hosts. </span><span class="koboSpan" id="kobo.662.2">In its simplest form, the inventory could be a flat list of hostnames or IP addresses, but Ansible can also organize the hosts into </span><strong class="bold"><span class="koboSpan" id="kobo.663.1">groups</span></strong><span class="koboSpan" id="kobo.664.1">. </span><span class="koboSpan" id="kobo.664.2">Ansible</span><a id="_idIndexMarker2554"/><span class="koboSpan" id="kobo.665.1"> inventory files are either </span><strong class="bold"><span class="koboSpan" id="kobo.666.1">static</span></strong><span class="koboSpan" id="kobo.667.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.668.1">dynamic</span></strong><span class="koboSpan" id="kobo.669.1">, depending on whether they are created and updated manually or dynamically. </span><span class="koboSpan" id="kobo.669.2">For now, we’ll use a </span><span class="No-Break"><span class="koboSpan" id="kobo.670.1">static inventory.</span></span></p>
<p><span class="koboSpan" id="kobo.671.1">In our demo environment with two web servers (</span><strong class="source-inline"><span class="koboSpan" id="kobo.672.1">ans-web1</span></strong><span class="koboSpan" id="kobo.673.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.674.1">ans-web2</span></strong><span class="koboSpan" id="kobo.675.1">) and two database servers (</span><strong class="source-inline"><span class="koboSpan" id="kobo.676.1">ans-db1</span></strong><span class="koboSpan" id="kobo.677.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.678.1">ans-db2</span></strong><span class="koboSpan" id="kobo.679.1">), we can define the following inventory (in INI format) in a file named </span><strong class="source-inline"><span class="koboSpan" id="kobo.680.1">hosts</span></strong><span class="koboSpan" id="kobo.681.1"> (located inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.682.1">~/ansible</span></strong><span class="koboSpan" id="kobo.683.1">) that we will create later on, as shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.684.1">Figure 17</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.685.1">.7</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.687.1">
[webservers]
ans-web1
ans-web2
[databases]
ans-db1
ans-db2</span></pre> <p><span class="koboSpan" id="kobo.688.1">We classified our hosts into a couple of groups, featured in bracketed names; that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">[webservers]</span></strong><span class="koboSpan" id="kobo.690.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.691.1">[databases]</span></strong><span class="koboSpan" id="kobo.692.1">. </span><span class="koboSpan" id="kobo.692.2">As discussed earlier, groups are logical arrangements of hosts based on specific criteria. </span><span class="koboSpan" id="kobo.692.3">Hosts can be part of multiple groups. </span><span class="koboSpan" id="kobo.692.4">Group names are case-sensitive, should always start with a letter, and should not contain hyphens (</span><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">-</span></strong><span class="koboSpan" id="kobo.694.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.695.1">or spaces.</span></span></p>
<p><span class="koboSpan" id="kobo.696.1">Ansible has two </span><span class="No-Break"><span class="koboSpan" id="kobo.697.1">default groups:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.698.1">all</span></strong><span class="koboSpan" id="kobo.699.1">: Every host in </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">the inventory</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.701.1">ungrouped</span></strong><span class="koboSpan" id="kobo.702.1">: Every host in </span><strong class="source-inline"><span class="koboSpan" id="kobo.703.1">all</span></strong><span class="koboSpan" id="kobo.704.1"> that is not a member of </span><span class="No-Break"><span class="koboSpan" id="kobo.705.1">another group</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.706.1">We can also define groups based on specific patterns. </span><span class="koboSpan" id="kobo.706.2">For example, the following group includes a range of hostnames starting with </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">ans-web</span></strong><span class="koboSpan" id="kobo.708.1"> and ending with a number in the range </span><span class="No-Break"><span class="koboSpan" id="kobo.709.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.710.1">1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.711.1">-</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.712.1">2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.713.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.714.1">
[webservers]
ans-web[1:2]</span></pre> <p><span class="koboSpan" id="kobo.715.1">Patterns are helpful when we’re </span><a id="_idIndexMarker2555"/><span class="koboSpan" id="kobo.716.1">managing a large number of hosts. </span><span class="koboSpan" id="kobo.716.2">For example, the following pattern includes all the hosts within a range of </span><span class="No-Break"><span class="koboSpan" id="kobo.717.1">IP addresses:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.718.1">
[all_servers]
172.16.191.[11:15]</span></pre> <p><span class="koboSpan" id="kobo.719.1">Ranges are defined as </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">[START:END]</span></strong><span class="koboSpan" id="kobo.721.1"> and include all values from </span><strong class="source-inline"><span class="koboSpan" id="kobo.722.1">START</span></strong><span class="koboSpan" id="kobo.723.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.724.1">END</span></strong><span class="koboSpan" id="kobo.725.1">. </span><span class="koboSpan" id="kobo.725.2">Examples of ranges are </span><strong class="source-inline"><span class="koboSpan" id="kobo.726.1">[1:10]</span></strong><span class="koboSpan" id="kobo.727.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.728.1">[01:10]</span></strong><span class="koboSpan" id="kobo.729.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.731.1">[a-g]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.732.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.733.1">Groups can also be nested. </span><span class="koboSpan" id="kobo.733.2">In other words, a group may contain other groups. </span><span class="koboSpan" id="kobo.733.3">This nesting is described with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.734.1">:children</span></strong><span class="koboSpan" id="kobo.735.1"> suffix. </span><span class="koboSpan" id="kobo.735.2">For example, we can define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.736.1">[platforms]</span></strong><span class="koboSpan" id="kobo.737.1"> group that includes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.738.1">[ubuntu]</span></strong><span class="koboSpan" id="kobo.739.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.740.1">[debian]</span></strong><span class="koboSpan" id="kobo.741.1"> groups (all our VMs are running on Ubuntu, so this is only for </span><span class="No-Break"><span class="koboSpan" id="kobo.742.1">explaining purposes):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.743.1">
[platforms:children]
ubuntu
debian</span></pre> <p><span class="koboSpan" id="kobo.744.1">Let’s name our inventory file </span><strong class="source-inline"><span class="koboSpan" id="kobo.745.1">hosts</span></strong><span class="koboSpan" id="kobo.746.1">. </span><span class="koboSpan" id="kobo.746.2">Please note that we are in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.747.1">~/ansible</span></strong><span class="koboSpan" id="kobo.748.1"> directory. </span><span class="koboSpan" id="kobo.748.2">Using a Linux editor of your choice, add the following content to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.749.1">hosts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.750.1"> file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer574">
<span class="koboSpan" id="kobo.751.1"><img alt="Figure 17.7 – The inventory file in INI format" src="image/B19682_17_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.752.1">Figure 17.7 – The inventory file in INI format</span></p>
<p><span class="koboSpan" id="kobo.753.1">After saving the inventory file, we can validate it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.754.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.755.1">
ansible-inventory -i ./hosts –-list --yaml</span></pre> <p><span class="koboSpan" id="kobo.756.1">Here’s a brief explanation </span><a id="_idIndexMarker2556"/><span class="koboSpan" id="kobo.757.1">of the </span><span class="No-Break"><span class="koboSpan" id="kobo.758.1">command’s parameters:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">-i (--inventory)</span></strong><span class="koboSpan" id="kobo.760.1">: Specifies the inventory file; that </span><span class="No-Break"><span class="koboSpan" id="kobo.761.1">is, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">./hosts</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">--list</span></strong><span class="koboSpan" id="kobo.764.1">: Lists the current inventory, as read </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">by Ansible</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.766.1">--yaml</span></strong><span class="koboSpan" id="kobo.767.1">: Specifies the output format </span><span class="No-Break"><span class="koboSpan" id="kobo.768.1">as YAML</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.769.1">Upon successfully validating the inventory, the command will show the equivalent YAML output (the default output format of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.770.1">ansible-inventory</span></strong><span class="koboSpan" id="kobo.771.1"> utility </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">is JSON).</span></span></p>
<p><span class="koboSpan" id="kobo.773.1">So far, we’ve</span><a id="_idIndexMarker2557"/><span class="koboSpan" id="kobo.774.1"> expressed the Ansible inventory in INI format, but we may as well use a YAML file instead. </span><span class="koboSpan" id="kobo.774.2">The following screenshot shows the output of the preceding command in </span><span class="No-Break"><span class="koboSpan" id="kobo.775.1">YAML format:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer575">
<span class="koboSpan" id="kobo.776.1"><img alt="Figure 17.8 – The output in YAML inventory format" src="image/B19682_17_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.777.1">Figure 17.8 – The output in YAML inventory format</span></p>
<p><span class="koboSpan" id="kobo.778.1">The YAML representation could be somewhat challenging, especially with large configurations, due to the strict indentation and formatting requirements. </span><span class="koboSpan" id="kobo.778.2">We’ll continue to use the INI inventory format throughout the rest of </span><span class="No-Break"><span class="koboSpan" id="kobo.779.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.780.1">Next, we’ll point Ansible to </span><a id="_idIndexMarker2558"/><span class="koboSpan" id="kobo.781.1">our inventory. </span><span class="koboSpan" id="kobo.781.2">Edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">./ansible.cfg</span></strong><span class="koboSpan" id="kobo.783.1"> configuration file and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.784.1">following lines:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer576">
<span class="koboSpan" id="kobo.785.1"><img alt="Figure 17.9 – Pointing to our inventory file" src="image/B19682_17_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.786.1">Figure 17.9 – Pointing to our inventory file</span></p>
<p><span class="koboSpan" id="kobo.787.1">After saving the file, we’re ready to run Ansible commands or tasks that target our managed hosts. </span><span class="koboSpan" id="kobo.787.2">There are two ways we can perform Ansible configuration management tasks: using one-off </span><strong class="bold"><span class="koboSpan" id="kobo.788.1">ad hoc commands</span></strong><span class="koboSpan" id="kobo.789.1"> and via </span><strong class="bold"><span class="koboSpan" id="kobo.790.1">Ansible playbooks</span></strong><span class="koboSpan" id="kobo.791.1">. </span><span class="koboSpan" id="kobo.791.2">We’ll look at ad hoc </span><span class="No-Break"><span class="koboSpan" id="kobo.792.1">commands next.</span></span></p>
<h2 id="_idParaDest-353"><a id="_idTextAnchor371"/><span class="koboSpan" id="kobo.793.1">Using Ansible ad hoc commands</span></h2>
<p><span class="koboSpan" id="kobo.794.1">Ad hoc commands execute a single Ansible task and provide a quick way to</span><a id="_idIndexMarker2559"/><span class="koboSpan" id="kobo.795.1"> interact with our managed hosts. </span><span class="koboSpan" id="kobo.795.2">These simple operations are helpful when we’re making simple changes and </span><span class="No-Break"><span class="koboSpan" id="kobo.796.1">performing testing.</span></span></p>
<p><span class="koboSpan" id="kobo.797.1">The general syntax of an Ansible ad hoc command is </span><span class="No-Break"><span class="koboSpan" id="kobo.798.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.799.1">
ansible [OPTIONS] -m MODULE -a ARGS PATTERN</span></pre> <p><span class="koboSpan" id="kobo.800.1">The preceding command uses an Ansible </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">MODULE</span></strong><span class="koboSpan" id="kobo.802.1"> to perform a particular task on select hosts based on a </span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">PATTERN</span></strong><span class="koboSpan" id="kobo.804.1">. </span><span class="koboSpan" id="kobo.804.2">The task is described via arguments (</span><strong class="source-inline"><span class="koboSpan" id="kobo.805.1">ARGS</span></strong><span class="koboSpan" id="kobo.806.1">). </span><span class="koboSpan" id="kobo.806.2">You may recall that modules encapsulate a specific functionality, such as managing users, packages, and services. </span><span class="koboSpan" id="kobo.806.3">To demonstrate the use of ad hoc commands, we’ll use some of the most common Ansible modules for our configuration management tasks. </span><span class="koboSpan" id="kobo.806.4">Let’s start with the Ansible </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">ping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.808.1"> module.</span></span></p>
<h3><span class="koboSpan" id="kobo.809.1">Working with the ping module</span></h3>
<p><span class="koboSpan" id="kobo.810.1">One of the simplest ad hoc </span><a id="_idIndexMarker2560"/><span class="koboSpan" id="kobo.811.1">commands is the Ansible </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">ping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.813.1"> test:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.814.1">
ansible -m ping all</span></pre> <p><span class="koboSpan" id="kobo.815.1">The command performs a quick test on all </span><a id="_idIndexMarker2561"/><span class="koboSpan" id="kobo.816.1">managed hosts to check their SSH connectivity and ensure the required Python modules are present. </span><span class="koboSpan" id="kobo.816.2">Here’s an excerpt from </span><span class="No-Break"><span class="koboSpan" id="kobo.817.1">the output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer577">
<span class="koboSpan" id="kobo.818.1"><img alt="Figure 17.10 – A successful ping test with a managed host" src="image/B19682_17_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.819.1">Figure 17.10 – A successful ping test with a managed host</span></p>
<p><span class="koboSpan" id="kobo.820.1">The output suggests that the command was successful (</span><strong class="source-inline"><span class="koboSpan" id="kobo.821.1">| SUCCESS</span></strong><span class="koboSpan" id="kobo.822.1">) and that the remote servers responded with </span><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">"pong"</span></strong><span class="koboSpan" id="kobo.824.1"> to our ping request (</span><strong class="source-inline"><span class="koboSpan" id="kobo.825.1">"ping": "pong"</span></strong><span class="koboSpan" id="kobo.826.1">). </span><span class="koboSpan" id="kobo.826.2">Please note that the Ansible </span><strong class="source-inline"><span class="koboSpan" id="kobo.827.1">ping</span></strong><span class="koboSpan" id="kobo.828.1"> module doesn’t use </span><strong class="bold"><span class="koboSpan" id="kobo.829.1">Internet Control Message Protocol</span></strong><span class="koboSpan" id="kobo.830.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.831.1">ICMP</span></strong><span class="koboSpan" id="kobo.832.1">) to test the remote </span><a id="_idIndexMarker2562"/><span class="koboSpan" id="kobo.833.1">connection with managed hosts. </span><span class="koboSpan" id="kobo.833.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.834.1">ping</span></strong><span class="koboSpan" id="kobo.835.1"> module inside Ansible is just a test module that requires Python; it does not rely on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.836.1">ping</span></strong><span class="koboSpan" id="kobo.837.1"> command we use when</span><a id="_idIndexMarker2563"/><span class="koboSpan" id="kobo.838.1"> troubleshooting </span><span class="No-Break"><span class="koboSpan" id="kobo.839.1">network issues.</span></span></p>
<p><span class="koboSpan" id="kobo.840.1">Next, we’ll look at ad hoc</span><a id="_idIndexMarker2564"/><span class="koboSpan" id="kobo.841.1"> commands while using the Ansible </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.842.1">user</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.843.1"> module.</span></span></p>
<h3><span class="koboSpan" id="kobo.844.1">Working with the user module</span></h3>
<p><span class="koboSpan" id="kobo.845.1">Here’s another example </span><a id="_idIndexMarker2565"/><span class="koboSpan" id="kobo.846.1">of an ad hoc command. </span><span class="koboSpan" id="kobo.846.2">This one is</span><a id="_idIndexMarker2566"/><span class="koboSpan" id="kobo.847.1"> checking if a particular user (</span><strong class="source-inline"><span class="koboSpan" id="kobo.848.1">packt</span></strong><span class="koboSpan" id="kobo.849.1">) exists on all </span><span class="No-Break"><span class="koboSpan" id="kobo.850.1">the hosts:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.851.1">
ansible -m user -a "name=packt state=present" all</span></pre> <p><span class="koboSpan" id="kobo.852.1">The following is an excerpt of the output yielded by a </span><span class="No-Break"><span class="koboSpan" id="kobo.853.1">successful check:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer578">
<span class="koboSpan" id="kobo.854.1"><img alt="Figure 17.11 – Checking if a user account exists" src="image/B19682_17_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.855.1">Figure 17.11 – Checking if a user account exists</span></p>
<p><span class="koboSpan" id="kobo.856.1">The preceding output also suggests that we could be even more specific when checking for a user account by also making sure they have a particular user and </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">group ID:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.858.1">
ansible -m user -a "name=packt state=present uid=1000 group=1000" all</span></pre> <p><span class="koboSpan" id="kobo.859.1">We can target ad hoc </span><a id="_idIndexMarker2567"/><span class="koboSpan" id="kobo.860.1">commands against a limited subset of our inventory. </span><span class="koboSpan" id="kobo.860.2">The following</span><a id="_idIndexMarker2568"/><span class="koboSpan" id="kobo.861.1"> command, for example, would only ping the </span><strong class="source-inline"><span class="koboSpan" id="kobo.862.1">web1</span></strong><span class="koboSpan" id="kobo.863.1"> host for </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">Ansible connectivity:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.865.1">
ansible -m ping ans-web1</span></pre> <p><span class="koboSpan" id="kobo.866.1">Host patterns can also include wildcards or group names. </span><span class="koboSpan" id="kobo.866.2">Here are a </span><span class="No-Break"><span class="koboSpan" id="kobo.867.1">few examples:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.868.1">
ansible -m ping ans-web*
ansible -m ping webservers</span></pre> <p><span class="koboSpan" id="kobo.869.1">Let’s look at the available Ansible modules next. </span><span class="koboSpan" id="kobo.869.2">Before we do that, you may want to add the following line to </span><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">./ansible.cfg</span></strong><span class="koboSpan" id="kobo.871.1">, under the </span><strong class="source-inline"><span class="koboSpan" id="kobo.872.1">[defaults]</span></strong><span class="koboSpan" id="kobo.873.1"> section, to keep the noise down about </span><span class="No-Break"><span class="koboSpan" id="kobo.874.1">deprecated modules:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.875.1">
deprecation_warnings = False</span></pre> <p><span class="koboSpan" id="kobo.876.1">To list all the modules available in Ansible, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.877.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.878.1">
ansible-doc --list</span></pre> <p><span class="koboSpan" id="kobo.879.1">You may search or </span><strong class="source-inline"><span class="koboSpan" id="kobo.880.1">grep</span></strong><span class="koboSpan" id="kobo.881.1"> the output for a particular module. </span><span class="koboSpan" id="kobo.881.2">For detailed information about a specific module (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.882.1">user</span></strong><span class="koboSpan" id="kobo.883.1">), you can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.884.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.885.1">
ansible-doc user</span></pre> <p><span class="koboSpan" id="kobo.886.1">Make sure you check out the </span><strong class="source-inline"><span class="koboSpan" id="kobo.887.1">EXAMPLES</span></strong><span class="koboSpan" id="kobo.888.1"> section in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.889.1">ansible-doc</span></strong><span class="koboSpan" id="kobo.890.1"> output for a specific module. </span><span class="koboSpan" id="kobo.890.2">You will find hands-on examples of using the module with ad hoc commands and </span><span class="No-Break"><span class="koboSpan" id="kobo.891.1">playbook tasks.</span></span></p>
<p><span class="koboSpan" id="kobo.892.1">Furthermore, we can create new users for different use cases on our Ansible hosts. </span><span class="koboSpan" id="kobo.892.2">Next, we will show you how to create a </span><span class="No-Break"><span class="koboSpan" id="kobo.893.1">new user.</span></span></p>
<h4><span class="koboSpan" id="kobo.894.1">Creating a new user</span></h4>
<p><span class="koboSpan" id="kobo.895.1">If we want to create a</span><a id="_idIndexMarker2569"/><span class="koboSpan" id="kobo.896.1"> new user (</span><strong class="source-inline"><span class="koboSpan" id="kobo.897.1">webuser</span></strong><span class="koboSpan" id="kobo.898.1">) on all our web servers, we </span><a id="_idTextAnchor372"/><a id="_idTextAnchor373"/><span class="koboSpan" id="kobo.899.1">can perform the related operation with the following ad </span><span class="No-Break"><span class="koboSpan" id="kobo.900.1">hoc command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.901.1">
ansible -bK -m user -a "name=webuser state=present" webservers</span></pre> <p><span class="koboSpan" id="kobo.902.1">Let’s explain the </span><span class="No-Break"><span class="koboSpan" id="kobo.903.1">command’s parameters:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.904.1">-b</span></strong><span class="koboSpan" id="kobo.905.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.906.1">--become</span></strong><span class="koboSpan" id="kobo.907.1">): Changes the execution context to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">sudo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.909.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.910.1">root</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.911.1">)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">-K</span></strong><span class="koboSpan" id="kobo.913.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.914.1">--ask-become-pass</span></strong><span class="koboSpan" id="kobo.915.1">): Prompts for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.916.1">sudo</span></strong><span class="koboSpan" id="kobo.917.1"> password on the remote hosts; the same password is used on all </span><span class="No-Break"><span class="koboSpan" id="kobo.918.1">managed hosts</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.919.1">-m</span></strong><span class="koboSpan" id="kobo.920.1">: Specifies the Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.921.1">module (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.922.1">user</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.923.1">-a</span></strong><span class="koboSpan" id="kobo.924.1">: Specifies the </span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">user</span></strong><span class="koboSpan" id="kobo.926.1"> module </span><a id="_idIndexMarker2570"/><span class="koboSpan" id="kobo.927.1">arguments as key-value pairs; </span><strong class="source-inline"><span class="koboSpan" id="kobo.928.1">name=webuser</span></strong><span class="koboSpan" id="kobo.929.1"> represents the username, while </span><strong class="source-inline"><span class="koboSpan" id="kobo.930.1">state=present</span></strong><span class="koboSpan" id="kobo.931.1"> checks whether the user account exists before attempting to </span><span class="No-Break"><span class="koboSpan" id="kobo.932.1">create it</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">webservers</span></strong><span class="koboSpan" id="kobo.934.1">: The group of managed hosts targeted by </span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">the operation</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.936.1">Creating a user account requires administrative (</span><strong class="source-inline"><span class="koboSpan" id="kobo.937.1">sudo</span></strong><span class="koboSpan" id="kobo.938.1">) privileges on the remote hosts. </span><span class="koboSpan" id="kobo.938.2">Using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.939.1">-b</span></strong><span class="koboSpan" id="kobo.940.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.941.1">--become</span></strong><span class="koboSpan" id="kobo.942.1">) option</span><a id="_idIndexMarker2571"/><span class="koboSpan" id="kobo.943.1"> invokes the related </span><strong class="bold"><span class="koboSpan" id="kobo.944.1">privilege escalation</span></strong><span class="koboSpan" id="kobo.945.1"> for the Ansible command to act as a </span><em class="italic"><span class="koboSpan" id="kobo.946.1">sudoer</span></em><span class="koboSpan" id="kobo.947.1"> on the </span><span class="No-Break"><span class="koboSpan" id="kobo.948.1">remote system.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.949.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.950.1">By default, Ansible does not enable </span><strong class="bold"><span class="koboSpan" id="kobo.951.1">unattended privilege escalation</span></strong><span class="koboSpan" id="kobo.952.1">. </span><span class="koboSpan" id="kobo.952.2">For tasks requiring </span><strong class="source-inline"><span class="koboSpan" id="kobo.953.1">sudo</span></strong><span class="koboSpan" id="kobo.954.1"> privileges, you must</span><a id="_idIndexMarker2572"/><span class="koboSpan" id="kobo.955.1"> explicitly set the </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">-b</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.957.1">(--become</span></strong><span class="koboSpan" id="kobo.958.1">) flag. </span><span class="koboSpan" id="kobo.958.2">You can override this behavior in the Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.959.1">configuration file.</span></span></p>
<p><span class="koboSpan" id="kobo.960.1">To enable unattended privilege escalation by default, add the following lines to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.961.1">ansible.cfg</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.962.1"> file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer579">
<span class="koboSpan" id="kobo.963.1"><img alt="Figure 17.12 – Adding privilege escalation rules" src="image/B19682_17_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.964.1">Figure 17.12 – Adding privilege escalation rules</span></p>
<p><span class="koboSpan" id="kobo.965.1">Now, you don’t have to specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.966.1">--b</span></strong><span class="koboSpan" id="kobo.967.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.968.1">--become</span></strong><span class="koboSpan" id="kobo.969.1">) flag anymore with your ad </span><span class="No-Break"><span class="koboSpan" id="kobo.970.1">hoc commands.</span></span></p>
<p><span class="koboSpan" id="kobo.971.1">If the sudoer account on the managed hosts has the </span><strong class="source-inline"><span class="koboSpan" id="kobo.972.1">sudo</span></strong><span class="koboSpan" id="kobo.973.1"> login password enabled, we’ll have to provide it to our ad</span><a id="_idIndexMarker2573"/><span class="koboSpan" id="kobo.974.1"> hoc command. </span><span class="koboSpan" id="kobo.974.2">Here is where the </span><strong class="source-inline"><span class="koboSpan" id="kobo.975.1">-K</span></strong><span class="koboSpan" id="kobo.976.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.977.1">--ask-become-pass</span></strong><span class="koboSpan" id="kobo.978.1">) option comes in handy. </span><span class="koboSpan" id="kobo.978.2">Consequently, we’re asked for a password with the </span><span class="No-Break"><span class="koboSpan" id="kobo.979.1">following message:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.980.1">
BECOME password:</span></pre> <p><span class="koboSpan" id="kobo.981.1">This password is used across all managed hosts targeted by </span><span class="No-Break"><span class="koboSpan" id="kobo.982.1">the command.</span></span></p>
<p><span class="koboSpan" id="kobo.983.1">As you may recall, we disabled the </span><strong class="source-inline"><span class="koboSpan" id="kobo.984.1">sudo</span></strong><span class="koboSpan" id="kobo.985.1"> login password on our managed hosts (see the </span><em class="italic"><span class="koboSpan" id="kobo.986.1">Setting up the lab environment</span></em><span class="koboSpan" id="kobo.987.1"> section earlier in this chapter). </span><span class="koboSpan" id="kobo.987.2">Therefore, we can rewrite the previous ad hoc command without explicitly asking for privilege escalation and the </span><span class="No-Break"><span class="koboSpan" id="kobo.988.1">related password:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.989.1">
ansible -m user -a "name=webuser state=present" webservers</span></pre> <p><span class="koboSpan" id="kobo.990.1">There are some security concerns regarding privilege escalation, and Ansible has the mechanisms to mitigate the related risks. </span><span class="koboSpan" id="kobo.990.2">For more information on this topic, you may refer </span><span class="No-Break"><span class="koboSpan" id="kobo.991.1">to </span></span><a href="https://docs.ansible.com/ansible/latest/user_guide/become.html"><span class="No-Break"><span class="koboSpan" id="kobo.992.1">https://docs.ansible.com/ansible/latest/user_guide/become.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.993.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.994.1">The preceding command produces the </span><span class="No-Break"><span class="koboSpan" id="kobo.995.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer580">
<span class="koboSpan" id="kobo.996.1"><img alt="Figure 17.13 – Creating a new user using an ad hoc command" src="image/B19682_17_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.997.1">Figure 17.13 – Creating a new user using an ad hoc command</span></p>
<p><span class="koboSpan" id="kobo.998.1">You may have noticed that the output text here is highlighted, as it was with our previous ad hoc commands. </span><span class="koboSpan" id="kobo.998.2">Ansible highlights the output if it corresponds to a change in the </span><em class="italic"><span class="koboSpan" id="kobo.999.1">desired state</span></em><span class="koboSpan" id="kobo.1000.1"> of the managed host. </span><span class="koboSpan" id="kobo.1000.2">If you run the same command a second time, the output will not be highlighted, suggesting</span><a id="_idIndexMarker2574"/><span class="koboSpan" id="kobo.1001.1"> that there’s been no change since the user account has been already created. </span><span class="koboSpan" id="kobo.1001.2">Here, we can see Ansible’s </span><em class="italic"><span class="koboSpan" id="kobo.1002.1">idempotent operation</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.1003.1">at work.</span></span></p>
<p><span class="koboSpan" id="kobo.1004.1">With the previous command, we created a user without a password for demo purposes only. </span><span class="koboSpan" id="kobo.1004.2">What if we want to add or modify the password? </span><span class="koboSpan" id="kobo.1004.3">Next, we will show you how to </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">do that.</span></span></p>
<h4><span class="koboSpan" id="kobo.1006.1">Adding or modifying a password</span></h4>
<p><span class="koboSpan" id="kobo.1007.1">Glossing through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1008.1">user</span></strong><span class="koboSpan" id="kobo.1009.1"> module’s documentation with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1010.1">ansible-doc user</span></strong><span class="koboSpan" id="kobo.1011.1">, we can use the password field inside the module</span><a id="_idIndexMarker2575"/><span class="koboSpan" id="kobo.1012.1"> arguments, but Ansible</span><a id="_idIndexMarker2576"/><span class="koboSpan" id="kobo.1013.1"> will only accept </span><strong class="bold"><span class="koboSpan" id="kobo.1014.1">password hashes</span></strong><span class="koboSpan" id="kobo.1015.1"> as input. </span><span class="koboSpan" id="kobo.1015.2">For hashing passwords, we’ll use a helper Python module called </span><strong class="source-inline"><span class="koboSpan" id="kobo.1016.1">passlib</span></strong><span class="koboSpan" id="kobo.1017.1">. </span><span class="koboSpan" id="kobo.1017.2">Let’s install it on the Ansible control node with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1018.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1019.1">
pip install passlib</span></pre> <p><span class="koboSpan" id="kobo.1020.1">You’ll need the Python package manager (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1021.1">pip</span></strong><span class="koboSpan" id="kobo.1022.1">) to run the previous command. </span><span class="koboSpan" id="kobo.1022.2">If you installed Ansible using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1023.1">pip</span></strong><span class="koboSpan" id="kobo.1024.1">, you should be fine. </span><span class="koboSpan" id="kobo.1024.2">Otherwise, follow the instructions in the </span><em class="italic"><span class="koboSpan" id="kobo.1025.1">Installing Ansible using pip</span></em><span class="koboSpan" id="kobo.1026.1"> section to download and </span><span class="No-Break"><span class="koboSpan" id="kobo.1027.1">install </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1028.1">pip</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1029.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1030.1">With </span><strong class="source-inline"><span class="koboSpan" id="kobo.1031.1">passlib</span></strong><span class="koboSpan" id="kobo.1032.1"> installed, we can use the following ad hoc command to create or modify the </span><span class="No-Break"><span class="koboSpan" id="kobo.1033.1">user password:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1034.1">
ansible webservers -m user \
    -e "password=changeit!" </span><span class="koboSpan" id="kobo.1034.2">\
    -a "name=webuser \
        update_password=always \
        password={{ password | password_hash('sha512') }}"</span></pre> <p><span class="koboSpan" id="kobo.1035.1">Here are the</span><a id="_idIndexMarker2577"/><span class="koboSpan" id="kobo.1036.1"> additional parameters helping with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1037.1">user password:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1038.1">-e</span></strong><span class="koboSpan" id="kobo.1039.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1040.1">--extra-vars</span></strong><span class="koboSpan" id="kobo.1041.1">): Specifies custom variables as key-value pairs; we set the value of a custom variable </span><span class="No-Break"><span class="koboSpan" id="kobo.1042.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1043.1">password=changeit!</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1044.1">update_password=always</span></strong><span class="koboSpan" id="kobo.1045.1">: Updates the password if it’s different from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1046.1">previous one</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1047.1">password={{...}}</span></strong><span class="koboSpan" id="kobo.1048.1">: Sets the password to the value of the expression enclosed within </span><span class="No-Break"><span class="koboSpan" id="kobo.1049.1">double braces</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">password | password_hash('sha512')</span></strong><span class="koboSpan" id="kobo.1051.1">: Pipes the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">password</span></strong><span class="koboSpan" id="kobo.1053.1"> variable (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">changeit!</span></strong><span class="koboSpan" id="kobo.1055.1">) to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1056.1">password_hash()</span></strong><span class="koboSpan" id="kobo.1057.1"> function, thus generating an SHA-512 hash; </span><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">password_hash()</span></strong><span class="koboSpan" id="kobo.1059.1"> is part of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1">passlib</span></strong><span class="koboSpan" id="kobo.1061.1"> module we </span><span class="No-Break"><span class="koboSpan" id="kobo.1062.1">installed earlier</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1063.1">The command sets the password of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1064.1">webuser</span></strong><span class="koboSpan" id="kobo.1065.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1066.1">changeit!</span></strong><span class="koboSpan" id="kobo.1067.1">, and is an example of using variables (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">password</span></strong><span class="koboSpan" id="kobo.1069.1">) in ad </span><a id="_idIndexMarker2578"/><span class="koboSpan" id="kobo.1070.1">hoc commands. </span><span class="koboSpan" id="kobo.1070.2">Here’s the </span><span class="No-Break"><span class="koboSpan" id="kobo.1071.1">related output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer581">
<span class="koboSpan" id="kobo.1072.1"><img alt="Figure 17.14 – Changing the user’s password using an ad hoc command" src="image/B19682_17_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1073.1">Figure 17.14 – Changing the user’s password using an ad hoc command</span></p>
<p><span class="koboSpan" id="kobo.1074.1">Ansible won’t show the actual password for obvious </span><span class="No-Break"><span class="koboSpan" id="kobo.1075.1">security reasons.</span></span></p>
<p><span class="koboSpan" id="kobo.1076.1">Now, you can try to SSH into any of the web servers (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1077.1">web1</span></strong><span class="koboSpan" id="kobo.1078.1"> or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1079.1">web2</span></strong><span class="koboSpan" id="kobo.1080.1">) using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1081.1">webuser</span></strong><span class="koboSpan" id="kobo.1082.1"> account, and you should be able to authenticate successfully with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1083.1">changeit!</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1084.1"> password.</span></span></p>
<h4><span class="koboSpan" id="kobo.1085.1">Deleting a user</span></h4>
<p><span class="koboSpan" id="kobo.1086.1">To delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1087.1">webuser</span></strong><span class="koboSpan" id="kobo.1088.1"> account on all </span><a id="_idIndexMarker2579"/><span class="koboSpan" id="kobo.1089.1">web servers, we can run the following ad </span><span class="No-Break"><span class="koboSpan" id="kobo.1090.1">hoc command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1091.1">
ansible -m user -a "name=webuser state=absent remove=yes force=yes" webservers</span></pre> <p><span class="koboSpan" id="kobo.1092.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1093.1">state=absent</span></strong><span class="koboSpan" id="kobo.1094.1"> module parameter invokes the deletion of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1095.1">webuser</span></strong><span class="koboSpan" id="kobo.1096.1"> account. </span><span class="koboSpan" id="kobo.1096.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1097.1">remove</span></strong><span class="koboSpan" id="kobo.1098.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">force</span></strong><span class="koboSpan" id="kobo.1100.1"> parameters are equivalent to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1101.1">userdel -rf</span></strong><span class="koboSpan" id="kobo.1102.1"> command, deleting the user’s home directory and any files within, even if they’re not owned by </span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1">the user.</span></span></p>
<p><span class="koboSpan" id="kobo.1104.1">The related output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1105.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer582">
<span class="koboSpan" id="kobo.1106.1"><img alt="Figure 17.15 – Deleting a user account using an ad hoc command" src="image/B19682_17_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1107.1">Figure 17.15 – Deleting a user account using an ad hoc command</span></p>
<p><span class="koboSpan" id="kobo.1108.1">You may safely ignore </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">stderr</span></strong><span class="koboSpan" id="kobo.1110.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">stderr_lines</span></strong><span class="koboSpan" id="kobo.1112.1">, which were captured in the output. </span><span class="koboSpan" id="kobo.1112.2">The message is benign since the user didn’t create a mail </span><span class="No-Break"><span class="koboSpan" id="kobo.1113.1">spool previously.</span></span></p>
<p><span class="koboSpan" id="kobo.1114.1">We’ll look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1115.1">package</span></strong><span class="koboSpan" id="kobo.1116.1"> module next and run a few related ad </span><span class="No-Break"><span class="koboSpan" id="kobo.1117.1">hoc commands.</span></span></p>
<h3><span class="koboSpan" id="kobo.1118.1">Working with the package module</span></h3>
<p><span class="koboSpan" id="kobo.1119.1">The following command</span><a id="_idIndexMarker2580"/><span class="koboSpan" id="kobo.1120.1"> installs the </span><strong class="bold"><span class="koboSpan" id="kobo.1121.1">Nginx</span></strong><span class="koboSpan" id="kobo.1122.1"> web server on all hosts</span><a id="_idIndexMarker2581"/><span class="koboSpan" id="kobo.1123.1"> within the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1124.1">webserver</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1125.1"> group:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1126.1">
ansible -m package -a "name=nginx state=present" webservers</span></pre> <p><span class="koboSpan" id="kobo.1127.1">Here’s an excerpt from </span><span class="No-Break"><span class="koboSpan" id="kobo.1128.1">the output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer583">
<span class="koboSpan" id="kobo.1129.1"><img alt="Figure 17.16 – Installing the nginx package on the web servers" src="image/B19682_17_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1130.1">Figure 17.16 – Installing the nginx package on the web servers</span></p>
<p><span class="koboSpan" id="kobo.1131.1">We use a similar ad hoc command to install the </span><strong class="bold"><span class="koboSpan" id="kobo.1132.1">MySQL</span></strong><span class="koboSpan" id="kobo.1133.1"> database server on all hosts within the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1134.1">databases</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1135.1"> group:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1136.1">
ansible -m package -a "name=mysql-server state=present" databases</span></pre> <p><span class="koboSpan" id="kobo.1137.1">Here’s an excerpt from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">command’s output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer584">
<span class="koboSpan" id="kobo.1139.1"><img alt="Figure 17.17 – Installing the mysql-server package on the database servers" src="image/B19682_17_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1140.1">Figure 17.17 – Installing the mysql-server package on the database servers</span></p>
<p><span class="koboSpan" id="kobo.1141.1">If we wanted to remove a package, the ad hoc command would be similar but would feature </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1142.1">state=absent</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1143.1"> instead.</span></span></p>
<p><span class="koboSpan" id="kobo.1144.1">Although the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">package</span></strong><span class="koboSpan" id="kobo.1146.1"> module provides a good OS-level abstraction across various platforms, certain package management </span><a id="_idIndexMarker2582"/><span class="koboSpan" id="kobo.1147.1">tasks are best handled with platfor</span><a id="_idTextAnchor374"/><a id="_idTextAnchor375"/><span class="koboSpan" id="kobo.1148.1">m-specific package managers. </span><span class="koboSpan" id="kobo.1148.2">We’ll show you </span><a id="_idIndexMarker2583"/><span class="koboSpan" id="kobo.1149.1">how to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1150.1">apt</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1151.1">module next.</span></span></p>
<h3><span class="koboSpan" id="kobo.1152.1">Working with platform-specific package managers</span></h3>
<p><span class="koboSpan" id="kobo.1153.1">The following </span><a id="_idIndexMarker2584"/><span class="koboSpan" id="kobo.1154.1">ad hoc command installs the latest updates on all Ubuntu machines in</span><a id="_idIndexMarker2585"/><span class="koboSpan" id="kobo.1155.1"> our managed environment. </span><span class="koboSpan" id="kobo.1155.2">As all of our VMs are running Ubuntu, we will choose to run the commands only on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1156.1">webservers</span></strong><span class="koboSpan" id="kobo.1157.1"> group. </span><span class="koboSpan" id="kobo.1157.2">The command wi</span><a id="_idTextAnchor376"/><a id="_idTextAnchor377"/><span class="koboSpan" id="kobo.1158.1">ll be </span><span class="No-Break"><span class="koboSpan" id="kobo.1159.1">the following:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1160.1">
ansible -m apt -a "upgrade=dist update_cache=yes" ubuntu</span></pre> <p><span class="koboSpan" id="kobo.1161.1">If we wanted, we could create one more group inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1162.1">hosts</span></strong><span class="koboSpan" id="kobo.1163.1"> file, named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">[ubuntu]</span></strong><span class="koboSpan" id="kobo.1165.1"> for example, and add all the VMs in there. </span><span class="koboSpan" id="kobo.1165.2">This would be easier if we had different operating systems running, but that is not the case </span><span class="No-Break"><span class="koboSpan" id="kobo.1166.1">for us.</span></span></p>
<p><span class="koboSpan" id="kobo.1167.1">Thee platform-specific package management modules (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1168.1">apt</span></strong><span class="koboSpan" id="kobo.1169.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">yum</span></strong><span class="koboSpan" id="kobo.1171.1">, and so on) match all the capabilities of the </span><a id="_idIndexMarker2586"/><span class="koboSpan" id="kobo.1172.1">system-agnostic </span><strong class="source-inline"><span class="koboSpan" id="kobo.1173.1">package</span></strong><span class="koboSpan" id="kobo.1174.1"> module, featuring additional </span><span class="No-Break"><span class="koboSpan" id="kobo.1175.1">OS-exclusive functionality.</span></span></p>
<p><span class="koboSpan" id="kobo.1176.1">Let’s look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">service</span></strong><span class="koboSpan" id="kobo.1178.1"> module next and a couple of related ad </span><span class="No-Break"><span class="koboSpan" id="kobo.1179.1">hoc commands.</span></span></p>
<h3><span class="koboSpan" id="kobo.1180.1">Working with the service module</span></h3>
<p><span class="koboSpan" id="kobo.1181.1">The following</span><a id="_idIndexMarker2587"/><span class="koboSpan" id="kobo.1182.1"> command </span><a id="_idIndexMarker2588"/><span class="koboSpan" id="kobo.1183.1">restarts the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1184.1">nginx</span></strong><span class="koboSpan" id="kobo.1185.1"> service on all hosts in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1186.1">webservers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1187.1"> group:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1188.1">
ansible -m service -a "name=nginx state=restarted" webservers</span></pre> <p><span class="koboSpan" id="kobo.1189.1">Here’s a relevant excerpt from </span><span class="No-Break"><span class="koboSpan" id="kobo.1190.1">the output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer585">
<span class="koboSpan" id="kobo.1191.1"><img alt="Figure 17.18 – Restarting the nginx service on the web servers" src="image/B19682_17_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1192.1">Figure 17.18 – Restarting the nginx service on the web servers</span></p>
<p><span class="koboSpan" id="kobo.1193.1">In the same way, we can restart the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1194.1">mysql</span></strong><span class="koboSpan" id="kobo.1195.1"> service on all database servers, but there’s a trick to it! </span><span class="koboSpan" id="kobo.1195.2">On Ubuntu, the MySQL service is named </span><strong class="source-inline"><span class="koboSpan" id="kobo.1196.1">mysql</span></strong><span class="koboSpan" id="kobo.1197.1">. </span><span class="koboSpan" id="kobo.1197.2">We could, of course, target each host with the appropriate service name, but if you had many database servers, it would be a laborious task. </span><span class="koboSpan" id="kobo.1197.3">Alternatively, we can use the </span><em class="italic"><span class="koboSpan" id="kobo.1198.1">exclusion pattern</span></em><span class="koboSpan" id="kobo.1199.1"> (written as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1200.1">!</span></strong><span class="koboSpan" id="kobo.1201.1">) when targeting multiple hosts </span><span class="No-Break"><span class="koboSpan" id="kobo.1202.1">or </span></span><span class="No-Break"><a id="_idIndexMarker2589"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">groups.</span></span></p>
<p><span class="koboSpan" id="kobo.1204.1">The following command will restart the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1205.1">mysql</span></strong><span class="koboSpan" id="kobo.1206.1"> service on all hosts in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1207.1">databases</span></strong><span class="koboSpan" id="kobo.1208.1"> group, except</span><a id="_idIndexMarker2590"/><span class="koboSpan" id="kobo.1209.1"> those that are members of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">debian</span></strong><span class="koboSpan" id="kobo.1211.1"> group (if we were to have a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1212.1">debian</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1213.1"> group):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1214.1">
ansible -m service -a "name=mysql state=restarted" 'databases:!debian'</span></pre> <p><span class="koboSpan" id="kobo.1215.1">Similarly, we can restart the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1216.1">mysqld</span></strong><span class="koboSpan" id="kobo.1217.1"> service on all hosts in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1218.1">databases</span></strong><span class="koboSpan" id="kobo.1219.1"> group, except for those that are members of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1220.1">ubuntu</span></strong><span class="koboSpan" id="kobo.1221.1"> group (if we were to have one), with the following ad </span><span class="No-Break"><span class="koboSpan" id="kobo.1222.1">hoc command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1223.1">
ansible -m service -a "name=mysqld state=restarted" 'databases:!ubuntu'</span></pre> <p><span class="koboSpan" id="kobo.1224.1">Always use single quotes (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1225.1">''</span></strong><span class="koboSpan" id="kobo.1226.1">) when you’re targeting multiple hosts or groups with an exclusion pattern; otherwise, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1227.1">ansible</span></strong><span class="koboSpan" id="kobo.1228.1"> command </span><span class="No-Break"><span class="koboSpan" id="kobo.1229.1">will fail.</span></span></p>
<p><span class="koboSpan" id="kobo.1230.1">Let’s look at one last Ansible module and the related ad hoc command, which is frequently used in </span><span class="No-Break"><span class="koboSpan" id="kobo.1231.1">upgrade scenarios.</span></span></p>
<h3><span class="koboSpan" id="kobo.1232.1">Working with the reboot module</span></h3>
<p><span class="koboSpan" id="kobo.1233.1">The following ad</span><a id="_idIndexMarker2591"/><span class="koboSpan" id="kobo.1234.1"> hoc command reboots all hosts in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1235.1">webservers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1236.1"> group:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1237.1">
ansible -m reboot -a "reboot_timeout=3600" webservers</span></pre> <p><span class="koboSpan" id="kobo.1238.1">Slower hosts may take</span><a id="_idIndexMarker2592"/><span class="koboSpan" id="kobo.1239.1"> longer to reboot, especially during substantial upgrades, hence the increased reboot timeout of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1240.1">3600</span></strong><span class="koboSpan" id="kobo.1241.1"> seconds. </span><span class="koboSpan" id="kobo.1241.2">(The default timeout is </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1242.1">600</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1243.1"> seconds.)</span></span></p>
<p><span class="koboSpan" id="kobo.1244.1">In our case, the reboot only took a few seconds. </span><span class="koboSpan" id="kobo.1244.2">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1245.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer586">
<span class="koboSpan" id="kobo.1246.1"><img alt="Figure 17.19 – Rebooting the webservers group" src="image/B19682_17_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1247.1">Figure 17.19 – Rebooting the webservers group</span></p>
<p><span class="koboSpan" id="kobo.1248.1">In this section, we showed a few examples of ad hoc commands using different modules. </span><span class="koboSpan" id="kobo.1248.2">The next section will give you a brief overview of some of the most common Ansible modules and how to </span><span class="No-Break"><span class="koboSpan" id="kobo.1249.1">explore more.</span></span></p>
<h2 id="_idParaDest-354"><a id="_idTextAnchor378"/><span class="koboSpan" id="kobo.1250.1">Exploring Ansible modules</span></h2>
<p><span class="koboSpan" id="kobo.1251.1">Ansible has a vast library of modules. </span><span class="koboSpan" id="kobo.1251.2">As we noted previously, you </span><a id="_idIndexMarker2593"/><span class="koboSpan" id="kobo.1252.1">may use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1253.1">ansible-doc --list</span></strong><span class="koboSpan" id="kobo.1254.1"> command to browse the available Ansible modules on the command-line Terminal. </span><span class="koboSpan" id="kobo.1254.2">You can also access the same information online, on the</span><a id="_idIndexMarker2594"/><span class="koboSpan" id="kobo.1255.1"> Ansible modules index page, </span><span class="No-Break"><span class="koboSpan" id="kobo.1256.1">at </span></span><a href="https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html"><span class="No-Break"><span class="koboSpan" id="kobo.1257.1">https://docs.ansible.com/ansible/2.9/modules/modules_by_category.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1258.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1259.1">The online catalog provides module-by-category indexing to help you quickly locate a particular module you’re looking for. </span><span class="koboSpan" id="kobo.1259.2">Here are some of the most typical modules used in everyday system administration and configuration management tasks </span><span class="No-Break"><span class="koboSpan" id="kobo.1260.1">with Ansible:</span></span></p>
<ul>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1261.1">Packaging modules</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1262.1">:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1263.1">apt</span></strong><span class="koboSpan" id="kobo.1264.1">: Performs </span><a id="_idIndexMarker2595"/><span class="koboSpan" id="kobo.1265.1">APT </span><span class="No-Break"><span class="koboSpan" id="kobo.1266.1">package management</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1267.1">yum</span></strong><span class="koboSpan" id="kobo.1268.1">: Performs YUM </span><span class="No-Break"><span class="koboSpan" id="kobo.1269.1">package management</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1270.1">dnf</span></strong><span class="koboSpan" id="kobo.1271.1">: Performs DNF </span><span class="No-Break"><span class="koboSpan" id="kobo.1272.1">package management</span></span></li></ul></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1273.1">System modules</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1275.1">users</span></strong><span class="koboSpan" id="kobo.1276.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.1277.1">Manages </span></span><span class="No-Break"><a id="_idIndexMarker2596"/></span><span class="No-Break"><span class="koboSpan" id="kobo.1278.1">users</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1279.1">services</span></strong><span class="koboSpan" id="kobo.1280.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.1281.1">Controls services</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1282.1">reboot</span></strong><span class="koboSpan" id="kobo.1283.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.1284.1">Restarts machines</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">firewalld</span></strong><span class="koboSpan" id="kobo.1286.1">: Performs </span><span class="No-Break"><span class="koboSpan" id="kobo.1287.1">firewall management</span></span></li></ul></li>
<li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1288.1">File modules</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1289.1">:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1290.1">copy</span></strong><span class="koboSpan" id="kobo.1291.1">: Copies local</span><a id="_idIndexMarker2597"/><span class="koboSpan" id="kobo.1292.1"> files to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1293.1">managed hosts</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">synchronize</span></strong><span class="koboSpan" id="kobo.1295.1">: Synchronizes files and directories </span><span class="No-Break"><span class="koboSpan" id="kobo.1296.1">using </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1297.1">rsync</span></strong></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1298.1">file</span></strong><span class="koboSpan" id="kobo.1299.1">: Controls file permissions </span><span class="No-Break"><span class="koboSpan" id="kobo.1300.1">and attributes</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1301.1">lineinfile</span></strong><span class="koboSpan" id="kobo.1302.1">: Manipulates lines in </span><span class="No-Break"><span class="koboSpan" id="kobo.1303.1">text files</span></span></li></ul></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1304.1">Net </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1305.1">Tools modules</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1306.1">:</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1307.1">nmcli</span></strong><span class="koboSpan" id="kobo.1308.1">: Controls </span><a id="_idIndexMarker2598"/><span class="No-Break"><span class="koboSpan" id="kobo.1309.1">network settings</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1310.1">get_url</span></strong><span class="koboSpan" id="kobo.1311.1">: Downloads files over HTTP, HTTPS, </span><span class="No-Break"><span class="koboSpan" id="kobo.1312.1">and FTP</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">uri</span></strong><span class="koboSpan" id="kobo.1314.1">: Interacts with web services and </span><span class="No-Break"><span class="koboSpan" id="kobo.1315.1">API endpoints</span></span></li></ul></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1316.1">Commands modules</span></strong><span class="koboSpan" id="kobo.1317.1"> (</span><span class="No-Break"><span class="koboSpan" id="kobo.1318.1">not idempotent):</span></span><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.1319.1">raw</span></strong><span class="koboSpan" id="kobo.1320.1">: Simply runs a</span><a id="_idIndexMarker2599"/><span class="koboSpan" id="kobo.1321.1"> remote command via SSH (which is an unsafe practice); doesn’t need Python installed on the </span><span class="No-Break"><span class="koboSpan" id="kobo.1322.1">remote host</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1323.1">command</span></strong><span class="koboSpan" id="kobo.1324.1">: Runs commands securely using Python’s remote </span><span class="No-Break"><span class="koboSpan" id="kobo.1325.1">execution context</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.1326.1">shell</span></strong><span class="koboSpan" id="kobo.1327.1">: Executes shell commands on </span><span class="No-Break"><span class="koboSpan" id="kobo.1328.1">managed hosts</span></span></li></ul></li>
</ul>
<p><span class="koboSpan" id="kobo.1329.1">We should note that ad hoc commands always execute a </span><em class="italic"><span class="koboSpan" id="kobo.1330.1">single operation</span></em><span class="koboSpan" id="kobo.1331.1"> using a </span><em class="italic"><span class="koboSpan" id="kobo.1332.1">single module</span></em><span class="koboSpan" id="kobo.1333.1">. </span><span class="koboSpan" id="kobo.1333.2">This feature is an advantage (for quick changes) but also a limitation. </span><span class="koboSpan" id="kobo.1333.3">For more complex configuration management tasks, we use Ansible playbooks. </span><span class="koboSpan" id="kobo.1333.4">The following section will take you through the process of authoring and running </span><span class="No-Break"><span class="koboSpan" id="kobo.1334.1">Ansible playbooks.</span></span></p>
<h2 id="_idParaDest-355"><a id="_idTextAnchor379"/><span class="koboSpan" id="kobo.1335.1">Using Ansible playbooks</span></h2>
<p><span class="koboSpan" id="kobo.1336.1">An </span><strong class="bold"><span class="koboSpan" id="kobo.1337.1">Ansible playbook</span></strong> <a id="_idIndexMarker2600"/><span class="koboSpan" id="kobo.1338.1">is essentially a list of tasks that are executed automatically. </span><span class="koboSpan" id="kobo.1338.2">Ansible configuration management workflows are primarily driven by playbooks. </span><span class="koboSpan" id="kobo.1338.3">More precisely, a playbook is</span><a id="_idIndexMarker2601"/><span class="koboSpan" id="kobo.1339.1"> a YAML file containing one or more </span><strong class="bold"><span class="koboSpan" id="kobo.1340.1">plays</span></strong><span class="koboSpan" id="kobo.1341.1">, each with a list of </span><strong class="bold"><span class="koboSpan" id="kobo.1342.1">tasks</span></strong><span class="koboSpan" id="kobo.1343.1"> executed in the order they are listed. </span><span class="koboSpan" id="kobo.1343.2">Plays are execution units that run the associated tasks against a set of hosts, and they are selected via a group identifier or a pattern. </span><span class="koboSpan" id="kobo.1343.3">Each task uses a single module that executes a specific action targeted at the remote host. </span><span class="koboSpan" id="kobo.1343.4">You may think of a task as a simple Ansible ad hoc command. </span><span class="koboSpan" id="kobo.1343.5">As the majority of Ansible modules comply with idempotent execution contexts, playbooks are also idempotent. </span><span class="koboSpan" id="kobo.1343.6">Running a playbook multiple times always yields the </span><span class="No-Break"><span class="koboSpan" id="kobo.1344.1">same result.</span></span></p>
<p><span class="koboSpan" id="kobo.1345.1">Well-written playbooks can replace laborious administrative tasks and complex scripts with relatively simple and maintainable manifests, running easily repeatable and </span><span class="No-Break"><span class="koboSpan" id="kobo.1346.1">predictable routines.</span></span></p>
<p><span class="koboSpan" id="kobo.1347.1">We’ll create our first Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.1348.1">playbook next.</span></span></p>
<h3><span class="koboSpan" id="kobo.1349.1">Creating a simple playbook</span></h3>
<p><span class="koboSpan" id="kobo.1350.1">We’ll build our</span><a id="_idIndexMarker2602"/><span class="koboSpan" id="kobo.1351.1"> playbook based on the ad hoc command we used for creating a user (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1352.1">webuser</span></strong><span class="koboSpan" id="kobo.1353.1">). </span><span class="koboSpan" id="kobo.1353.2">As a quick refresher, the command was </span><span class="No-Break"><span class="koboSpan" id="kobo.1354.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1355.1">
ansible -m user -a "name=webuser state=present" webservers</span></pre> <p><span class="koboSpan" id="kobo.1356.1">As we write the equivalent playbook, you may notice some resemblance to the ad hoc </span><span class="No-Break"><span class="koboSpan" id="kobo.1357.1">command parameters.</span></span></p>
<p><span class="koboSpan" id="kobo.1358.1">While editing the playbook YAML file, please be aware of the YAML </span><span class="No-Break"><span class="koboSpan" id="kobo.1359.1">formatting rules:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1360.1">Use only space characters for indentation (</span><span class="No-Break"><span class="koboSpan" id="kobo.1361.1">no tabs)</span></span></li>
<li><span class="koboSpan" id="kobo.1362.1">Keep the indentation length consistent (for example, </span><span class="No-Break"><span class="koboSpan" id="kobo.1363.1">two spaces)</span></span></li>
<li><span class="koboSpan" id="kobo.1364.1">Items at the same level in the hierarchy (for example, list items) must have the </span><span class="No-Break"><span class="koboSpan" id="kobo.1365.1">same indentation</span></span></li>
<li><span class="koboSpan" id="kobo.1366.1">A child item’s indentation is one indentation more than </span><span class="No-Break"><span class="koboSpan" id="kobo.1367.1">its parent</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1368.1">Now, using a Linux editor of </span><a id="_idIndexMarker2603"/><span class="koboSpan" id="kobo.1369.1">your choice, add the following lines to a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1370.1">create-user.yml</span></strong><span class="koboSpan" id="kobo.1371.1"> file. </span><span class="koboSpan" id="kobo.1371.2">Make sure you create the playbook in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1372.1">~/ansible</span></strong><span class="koboSpan" id="kobo.1373.1"> project directory, which is where we have our current inventory (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1374.1">hosts</span></strong><span class="koboSpan" id="kobo.1375.1">) and Ansible configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.1376.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1377.1">ansible.cfg</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1378.1">):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer587">
<span class="koboSpan" id="kobo.1379.1"><img alt="Figure 17.20 – A simple playbook for creating a user" src="image/B19682_17_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1380.1">Figure 17.20 – A simple playbook for creating a user</span></p>
<p><span class="koboSpan" id="kobo.1381.1">Let’s look at each line in our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1382.1">create-user.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1383.1"> playbook:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1384.1">---</span></strong><span class="koboSpan" id="kobo.1385.1">: Marks the beginning of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1386.1">playbook file</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1387.1">- name</span></strong><span class="koboSpan" id="kobo.1388.1">: Describes the name of the play; we can have one or more plays in </span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1">a playbook</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1390.1">hosts: webservers</span></strong><span class="koboSpan" id="kobo.1391.1">: Targets the hosts in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1392.1">webservers</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1393.1"> group</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1">become: yes</span></strong><span class="koboSpan" id="kobo.1395.1">: Enables privilege escalation for the current task; you can leave this line out if you enabled unattended privilege escalation in your Ansible configuration file (with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1396.1">become = True</span></strong><span class="koboSpan" id="kobo.1397.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1398.1">[</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1399.1">privileged_escalation]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1400.1"> section)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1401.1">tasks</span></strong><span class="koboSpan" id="kobo.1402.1">: The list of tasks in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1">current play</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1404.1">- name</span></strong><span class="koboSpan" id="kobo.1405.1">: The name of the current task; we can have multiple tasks in </span><span class="No-Break"><span class="koboSpan" id="kobo.1406.1">a play</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">user</span></strong><span class="koboSpan" id="kobo.1408.1">: The module being used by the </span><span class="No-Break"><span class="koboSpan" id="kobo.1409.1">current task</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1410.1">name: webuser</span></strong><span class="koboSpan" id="kobo.1411.1">: The name of the user account </span><span class="No-Break"><span class="koboSpan" id="kobo.1412.1">to create</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1413.1">state: present</span></strong><span class="koboSpan" id="kobo.1414.1">: The desired state upon creating the user – we want the user </span><a id="_idIndexMarker2604"/><span class="koboSpan" id="kobo.1415.1">account to be present on </span><span class="No-Break"><span class="koboSpan" id="kobo.1416.1">the system</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1417.1">Let’s run our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1418.1">create-user.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1419.1"> playbook:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1420.1">
ansible-playbook create-user.yml</span></pre> <p><span class="koboSpan" id="kobo.1421.1">Here’s the output we get after a successful </span><span class="No-Break"><span class="koboSpan" id="kobo.1422.1">playbook run:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer588">
<span class="koboSpan" id="kobo.1423.1"><img alt="Figure 17.21 – Running the create-user.yml playbook" src="image/B19682_17_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1424.1">Figure 17.21 – Running the create-user.yml playbook</span></p>
<p><span class="koboSpan" id="kobo.1425.1">Most of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1426.1">ansible-playbook</span></strong><span class="koboSpan" id="kobo.1427.1"> command-line options are similar to the ones</span><a id="_idIndexMarker2605"/><span class="koboSpan" id="kobo.1428.1"> for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1429.1">ansible</span></strong><span class="koboSpan" id="kobo.1430.1"> command. </span><span class="koboSpan" id="kobo.1430.2">Let’s look at some of </span><span class="No-Break"><span class="koboSpan" id="kobo.1431.1">these parameters:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1432.1">-i</span></strong><span class="koboSpan" id="kobo.1433.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1434.1">--inventory</span></strong><span class="koboSpan" id="kobo.1435.1">): Specifies an inventory </span><span class="No-Break"><span class="koboSpan" id="kobo.1436.1">file path</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1437.1">-b</span></strong><span class="koboSpan" id="kobo.1438.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1439.1">--become</span></strong><span class="koboSpan" id="kobo.1440.1">): Enables privilege escalation to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1441.1">sudo</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1442.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1443.1">root</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1444.1">)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1445.1">-C</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1446.1">(--check</span></strong><span class="koboSpan" id="kobo.1447.1">): Produces a dry run without making any changes and anticipating the end results – a useful option for </span><span class="No-Break"><span class="koboSpan" id="kobo.1448.1">validating playbooks</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">-l</span></strong><span class="koboSpan" id="kobo.1450.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1451.1">--limit</span></strong><span class="koboSpan" id="kobo.1452.1">): Limits the</span><a id="_idIndexMarker2606"/><span class="koboSpan" id="kobo.1453.1"> action of the command or playbook to a subset of </span><span class="No-Break"><span class="koboSpan" id="kobo.1454.1">managed hosts</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1455.1">--syntax-check</span></strong><span class="koboSpan" id="kobo.1456.1">: Validates the playbook’s syntax without making any changes; this option is only available for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1457.1">ansible-playbook</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1458.1"> command</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1459.1">Let’s experiment with a second playbook, this time for deleting a user. </span><span class="koboSpan" id="kobo.1459.2">We’ll name the playbook </span><strong class="source-inline"><span class="koboSpan" id="kobo.1460.1">delete-user.yml</span></strong><span class="koboSpan" id="kobo.1461.1"> and add the </span><span class="No-Break"><span class="koboSpan" id="kobo.1462.1">following content:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer589">
<span class="koboSpan" id="kobo.1463.1"><img alt="Figure 17.22 – A simple playbook for deleting a user" src="image/B19682_17_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1464.1">Figure 17.22 – A simple playbook for deleting a user</span></p>
<p><span class="koboSpan" id="kobo.1465.1">Now, let’s run </span><span class="No-Break"><span class="koboSpan" id="kobo.1466.1">this playbook:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1467.1">
ansible-playbook delete-user.yml</span></pre> <p><span class="koboSpan" id="kobo.1468.1">The output of the preceding command is </span><span class="No-Break"><span class="koboSpan" id="kobo.1469.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer590">
<span class="koboSpan" id="kobo.1470.1"><img alt="Figure 17.23 – Limiting the delete-user.yml playbook to the Ubuntu host group" src="image/B19682_17_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1471.1">Figure 17.23 – Limiting the delete-user.yml playbook to the Ubuntu host group</span></p>
<p><span class="koboSpan" id="kobo.1472.1">Next, we’ll look at ways to</span><a id="_idIndexMarker2607"/><span class="koboSpan" id="kobo.1473.1"> further streamline our configuration management workflows, starting with the use of variables </span><span class="No-Break"><span class="koboSpan" id="kobo.1474.1">in playbooks.</span></span></p>
<h3><span class="koboSpan" id="kobo.1475.1">Using variables in playbooks</span></h3>
<p><span class="koboSpan" id="kobo.1476.1">Ansible provides a </span><a id="_idIndexMarker2608"/><span class="koboSpan" id="kobo.1477.1">flexible and versatile model for working with variables in both playbooks and </span><a id="_idIndexMarker2609"/><span class="koboSpan" id="kobo.1478.1">ad hoc commands. </span><span class="koboSpan" id="kobo.1478.2">Through variables, we are essentially </span><em class="italic"><span class="koboSpan" id="kobo.1479.1">parameterizing</span></em><span class="koboSpan" id="kobo.1480.1"> a playbook, making it reusable </span><span class="No-Break"><span class="koboSpan" id="kobo.1481.1">or dynamic.</span></span></p>
<p><span class="koboSpan" id="kobo.1482.1">Take our previous playbook, for example, to create a user. </span><span class="koboSpan" id="kobo.1482.2">We hardcoded the username (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1483.1">webuser</span></strong><span class="koboSpan" id="kobo.1484.1">) in the playbook. </span><span class="koboSpan" id="kobo.1484.2">We can’t really reuse the playbook to create another user (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1485.1">webadmin</span></strong><span class="koboSpan" id="kobo.1486.1">) unless we add the related task to it. </span><span class="koboSpan" id="kobo.1486.2">But then, if we had many users, our playbook would grow proportionally, making it harder to maintain. </span><span class="koboSpan" id="kobo.1486.3">And what if we wanted to specify a password for each user as well? </span><span class="koboSpan" id="kobo.1486.4">The complexity of the playbook would grow </span><span class="No-Break"><span class="koboSpan" id="kobo.1487.1">even more.</span></span></p>
<p><span class="koboSpan" id="kobo.1488.1">Here’s where </span><strong class="bold"><span class="koboSpan" id="kobo.1489.1">variables</span></strong><span class="koboSpan" id="kobo.1490.1"> come into play. </span><span class="koboSpan" id="kobo.1490.2">Let’s first look at what variables are and how they </span><span class="No-Break"><span class="koboSpan" id="kobo.1491.1">are written.</span></span></p>
<h4><span class="koboSpan" id="kobo.1492.1">Introducing variables</span></h4>
<p><span class="koboSpan" id="kobo.1493.1">We can substitute the hardcoded</span><a id="_idIndexMarker2610"/><span class="koboSpan" id="kobo.1494.1"> values with variables, making the playbook dynamic. </span><span class="koboSpan" id="kobo.1494.2">In terms of pseudocode, our example of using a playbook to create a user with specific </span><strong class="source-inline"><span class="koboSpan" id="kobo.1495.1">username</span></strong><span class="koboSpan" id="kobo.1496.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1497.1">password</span></strong><span class="koboSpan" id="kobo.1498.1"> variables would look </span><span class="No-Break"><span class="koboSpan" id="kobo.1499.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1500.1">
User = Playbook(username, password)</span></pre> <p><span class="koboSpan" id="kobo.1501.1">Variables in Ansible are enclosed in double braces; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1502.1">{{ username }}</span></strong><span class="koboSpan" id="kobo.1503.1">. </span><span class="koboSpan" id="kobo.1503.2">Let’s see how we can leverage </span><a id="_idIndexMarker2611"/><span class="koboSpan" id="kobo.1504.1">variables in our playbooks. </span><span class="koboSpan" id="kobo.1504.2">Edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1505.1">create-user.yml</span></strong><span class="koboSpan" id="kobo.1506.1"> playbook we worked on in the previous section and adjust it </span><span class="No-Break"><span class="koboSpan" id="kobo.1507.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer591">
<span class="koboSpan" id="kobo.1508.1"><img alt="Figure 17.24 – Using the “username” variable in a playbook" src="image/B19682_17_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1509.1">Figure 17.24 – Using the “username” variable in a playbook</span></p>
<p><span class="koboSpan" id="kobo.1510.1">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1511.1">{{ username }}</span></strong><span class="koboSpan" id="kobo.1512.1"> variable substituting our previously hardcoded value (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1513.1">webuser</span></strong><span class="koboSpan" id="kobo.1514.1">). </span><span class="koboSpan" id="kobo.1514.2">Then, we surrounded the double braces with quotes to avoid syntax interference with the YAML dictionary notation. </span><span class="koboSpan" id="kobo.1514.3">Variable names in Ansible must begin with a letter and only contain alphanumerical characters </span><span class="No-Break"><span class="koboSpan" id="kobo.1515.1">and underscores.</span></span></p>
<h4><span class="koboSpan" id="kobo.1516.1">Setting values for variables</span></h4>
<p><span class="koboSpan" id="kobo.1517.1">Next, we’ll explain </span><em class="italic"><span class="koboSpan" id="kobo.1518.1">how</span></em><span class="koboSpan" id="kobo.1519.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.1520.1">where</span></em><span class="koboSpan" id="kobo.1521.1"> to set</span><a id="_idIndexMarker2612"/><span class="koboSpan" id="kobo.1522.1"> values for variables. </span><span class="koboSpan" id="kobo.1522.2">Ansible implements a hierarchical model for assigning values </span><span class="No-Break"><span class="koboSpan" id="kobo.1523.1">to variables:</span></span></p>
<ol>
<li><strong class="bold"><span class="koboSpan" id="kobo.1524.1">Global variables</span></strong><span class="koboSpan" id="kobo.1525.1">: Values are set for all the hosts, either via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1526.1">–extra-vars ansible-playbook</span></strong><span class="koboSpan" id="kobo.1527.1"> command-line </span><a id="_idIndexMarker2613"/><span class="koboSpan" id="kobo.1528.1">parameter or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1529.1">./</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1530.1">group_vars/all</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1531.1"> file.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1532.1">Group variables</span></strong><span class="koboSpan" id="kobo.1533.1">: Values are set for the </span><a id="_idIndexMarker2614"/><span class="koboSpan" id="kobo.1534.1">hosts in a specific group, either in the inventory file or the local </span><strong class="source-inline"><span class="koboSpan" id="kobo.1535.1">./group_vars</span></strong><span class="koboSpan" id="kobo.1536.1"> directory in files named after </span><span class="No-Break"><span class="koboSpan" id="kobo.1537.1">each group.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1538.1">Host variables</span></strong><span class="koboSpan" id="kobo.1539.1">: Values are </span><a id="_idIndexMarker2615"/><span class="koboSpan" id="kobo.1540.1">set for a particular host, either in</span><a id="_idIndexMarker2616"/><span class="koboSpan" id="kobo.1541.1"> the inventory file or the local </span><strong class="source-inline"><span class="koboSpan" id="kobo.1542.1">./host_vars</span></strong><span class="koboSpan" id="kobo.1543.1"> directory in files named after each host. </span><span class="koboSpan" id="kobo.1543.2">Host-specific variables are also available from </span><strong class="bold"><span class="koboSpan" id="kobo.1544.1">Ansible facts</span></strong><span class="koboSpan" id="kobo.1545.1"> via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1546.1">gather_facts</span></strong><span class="koboSpan" id="kobo.1547.1"> directive. </span><span class="koboSpan" id="kobo.1547.2">You can learn more about Ansible facts </span><span class="No-Break"><span class="koboSpan" id="kobo.1548.1">at </span></span><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html#ansible-facts"><span class="No-Break"><span class="koboSpan" id="kobo.1549.1">https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html#ansible-facts</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1550.1">.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1551.1">Play variables</span></strong><span class="koboSpan" id="kobo.1552.1">: Values are set in </span><a id="_idIndexMarker2617"/><span class="koboSpan" id="kobo.1553.1">the context of the current play for the hosts targeted by the play; examples are the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1554.1">vars</span></strong><span class="koboSpan" id="kobo.1555.1"> directive in a play or </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1556.1">include_vars</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1557.1"> tasks.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1558.1">In the preceding numbered list, the order of precedence for a variable’s value increases with each number. </span><span class="koboSpan" id="kobo.1558.2">In other words, a variable value defined in a play will overwrite the same variable value specified at the host, group, or </span><span class="No-Break"><span class="koboSpan" id="kobo.1559.1">global level.</span></span></p>
<p><span class="koboSpan" id="kobo.1560.1">As an example, you may recall the peculiarity related to the MySQL service name on Ubuntu and RHEL/Fedora platforms. </span><span class="koboSpan" id="kobo.1560.2">On Ubuntu, the service is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">mysql</span></strong><span class="koboSpan" id="kobo.1562.1">, while on Fedora, the service is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1563.1">mysqld</span></strong><span class="koboSpan" id="kobo.1564.1">. </span><span class="koboSpan" id="kobo.1564.2">Suppose we want to restart the MySQL service on all hosts in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">databases</span></strong><span class="koboSpan" id="kobo.1566.1"> group. </span><span class="koboSpan" id="kobo.1566.2">Assuming most of our database servers run Ubuntu, we can define a group-level </span><strong class="source-inline"><span class="koboSpan" id="kobo.1567.1">service</span></strong><span class="koboSpan" id="kobo.1568.1"> variable as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1569.1">service: mysql</span></strong><span class="koboSpan" id="kobo.1570.1">. </span><span class="koboSpan" id="kobo.1570.2">We set this variable in the local project’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1571.1">./group_vars/databases</span></strong><span class="koboSpan" id="kobo.1572.1"> file. </span><span class="koboSpan" id="kobo.1572.2">Then, in the play where we control the service status, we can override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1573.1">service</span></strong><span class="koboSpan" id="kobo.1574.1"> variable value with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1575.1">mysqld</span></strong><span class="koboSpan" id="kobo.1576.1"> when the remote host’s OS platform </span><span class="No-Break"><span class="koboSpan" id="kobo.1577.1">is Fedora.</span></span></p>
<p><span class="koboSpan" id="kobo.1578.1">Let’s look at a few examples to illustrate what we’ve learned so far about placing variables and setting their values. </span><span class="koboSpan" id="kobo.1578.2">Back in our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1579.1">create-user.yml</span></strong><span class="koboSpan" id="kobo.1580.1"> playbook, we can define the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">username</span></strong><span class="koboSpan" id="kobo.1582.1"> variable at the play level with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1583.1">following directive:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1584.1">
  vars:
    username: webuser</span></pre> <p><span class="koboSpan" id="kobo.1585.1">Here’s what it looks like in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1586.1">overall playbook:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer592">
<span class="koboSpan" id="kobo.1587.1"><img alt="Figure 17.25 – Defining a variable at the play level" src="image/B19682_17_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1588.1">Figure 17.25 – Defining a variable at the play level</span></p>
<p><span class="koboSpan" id="kobo.1589.1">Let’s run our playbook with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1590.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1591.1">
ansible-playbook create-user.yml</span></pre> <p><span class="koboSpan" id="kobo.1592.1">A relevant excerpt from</span><a id="_idIndexMarker2618"/><span class="koboSpan" id="kobo.1593.1"> the output is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1594.1">next screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer593">
<span class="koboSpan" id="kobo.1595.1"><img alt="Figure 17.26 – Creating a user with a playbook using variables" src="image/B19682_17_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1596.1">Figure 17.26 – Creating a user with a playbook using variables</span></p>
<h4><span class="koboSpan" id="kobo.1597.1">Deleting user accounts</span></h4>
<p><span class="koboSpan" id="kobo.1598.1">To delete user accounts, we </span><a id="_idIndexMarker2619"/><span class="koboSpan" id="kobo.1599.1">can readjust our previous </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">delete-user.yml</span></strong><span class="koboSpan" id="kobo.1601.1"> file so that it looks </span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer594">
<span class="koboSpan" id="kobo.1603.1"><img alt="Figure 17.27 – Deleting a user with a playbook using variables" src="image/B19682_17_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1604.1">Figure 17.27 – Deleting a user with a playbook using variables</span></p>
<p><span class="koboSpan" id="kobo.1605.1">After saving the file, run the following command to delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1606.1">webuser</span></strong><span class="koboSpan" id="kobo.1607.1"> account on all </span><span class="No-Break"><span class="koboSpan" id="kobo.1608.1">web servers:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1609.1">
ansible-playbook delete-user.yml</span></pre> <p><span class="koboSpan" id="kobo.1610.1">The relevant output from the preceding command run is </span><span class="No-Break"><span class="koboSpan" id="kobo.1611.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer595">
<span class="koboSpan" id="kobo.1612.1"><img alt="Figure 17.28 – Deleting a user with a playbook using variables" src="image/B19682_17_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1613.1">Figure 17.28 – Deleting a user with a playbook using variables</span></p>
<h4><span class="koboSpan" id="kobo.1614.1">Enhancing our playbooks</span></h4>
<p><span class="koboSpan" id="kobo.1615.1">We can improve our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1616.1">create-user</span></strong><span class="koboSpan" id="kobo.1617.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1618.1">delete-user</span></strong><span class="koboSpan" id="kobo.1619.1"> playbooks even further. </span><span class="koboSpan" id="kobo.1619.2">You can follow </span><span class="No-Break"><span class="koboSpan" id="kobo.1620.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1621.1">Since the play </span><a id="_idIndexMarker2620"/><span class="koboSpan" id="kobo.1622.1">exclusively targets the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1623.1">webservers</span></strong><span class="koboSpan" id="kobo.1624.1"> group, we can define a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">username</span></strong><span class="koboSpan" id="kobo.1626.1"> variable in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1627.1">./group_vars/webservers</span></strong><span class="koboSpan" id="kobo.1628.1"> file instead. </span><span class="koboSpan" id="kobo.1628.2">This way, we can keep the playbooks more compact. </span><span class="koboSpan" id="kobo.1628.3">Let’s remove the variable definition from </span><span class="No-Break"><span class="koboSpan" id="kobo.1629.1">both files.</span></span></li>
<li><span class="koboSpan" id="kobo.1630.1">Next, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1631.1">./group_vars</span></strong><span class="koboSpan" id="kobo.1632.1"> folder in the local directory (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1633.1">~/ansible</span></strong><span class="koboSpan" id="kobo.1634.1">) and add the following lines to a file </span><span class="No-Break"><span class="koboSpan" id="kobo.1635.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1636.1">webservers.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1637.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1638.1">username: webuser</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1639.1">We could also just call the file </span><strong class="source-inline"><span class="koboSpan" id="kobo.1640.1">webservers</span></strong><span class="koboSpan" id="kobo.1641.1"> so that it matches the group we’re targeting. </span><span class="koboSpan" id="kobo.1641.2">However, we should prefer to use the .</span><strong class="source-inline"><span class="koboSpan" id="kobo.1642.1">yml</span></strong><span class="koboSpan" id="kobo.1643.1"> extension so that we’re consistent with the file’s YAML format. </span><span class="koboSpan" id="kobo.1643.2">Ansible accepts both naming conventions. </span><span class="koboSpan" id="kobo.1643.3">Here’s the current tree structure of our </span><span class="No-Break"><span class="koboSpan" id="kobo.1644.1">project directory:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer596">
<span class="koboSpan" id="kobo.1645.1"><img alt="Figure 17.29 – The directory tree, including the group_vars folder" src="image/B19682_17_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1646.1">Figure 17.29 – The directory tree, including the group_vars folder</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1647.1">If we run our playbooks, the </span><a id="_idIndexMarker2621"/><span class="koboSpan" id="kobo.1648.1">results should be identical to our </span><span class="No-Break"><span class="koboSpan" id="kobo.1649.1">previous runs:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1650.1">ansible-playbook create-user.yml</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1651.1">ansible-playbook delete-user.yml</span></strong></pre> <ol>
<li value="3"><span class="koboSpan" id="kobo.1652.1">Now, let’s add one more variable to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1653.1">create-user</span></strong><span class="koboSpan" id="kobo.1654.1"> playbook: the user’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.1655.1">password</span></strong><span class="koboSpan" id="kobo.1656.1"> variable. </span><span class="koboSpan" id="kobo.1656.2">You may recall the ad hoc command we created for the same purpose. </span><span class="koboSpan" id="kobo.1656.3">See the </span><em class="italic"><span class="koboSpan" id="kobo.1657.1">Using Ansible ad hoc commands</span></em><span class="koboSpan" id="kobo.1658.1"> section earlier in this chapter for </span><span class="No-Break"><span class="koboSpan" id="kobo.1659.1">more information.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1660.1">Add the following lines to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1661.1">create-user.yml</span></strong><span class="koboSpan" id="kobo.1662.1"> file of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1663.1">user</span></strong><span class="koboSpan" id="kobo.1664.1"> task, at the same level </span><span class="No-Break"><span class="koboSpan" id="kobo.1665.1">as </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1666.1">name</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1667.1">:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1668.1">password: "{{ password | password_hash('sha512') }}"</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.1669.1">update_password: always</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1670.1">You may notice how these changes are similar to the</span><a id="_idIndexMarker2622"/><span class="koboSpan" id="kobo.1671.1"> related ad hoc command. </span><span class="koboSpan" id="kobo.1671.2">The updated playbook contains the </span><span class="No-Break"><span class="koboSpan" id="kobo.1672.1">following content:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer597">
<span class="koboSpan" id="kobo.1673.1"><img alt="Figure 17.30 – The playbook with username and password variables" src="image/B19682_17_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1674.1">Figure 17.30 – The playbook with username and password variables</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1675.1">Next, edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1676.1">./group_vars/webservers.yml</span></strong><span class="koboSpan" id="kobo.1677.1"> file and add the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1678.1">password</span></strong><span class="koboSpan" id="kobo.1679.1"> variable with </span><a id="_idIndexMarker2623"/><span class="koboSpan" id="kobo.1680.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1681.1">changeit!</span></strong><span class="koboSpan" id="kobo.1682.1"> value. </span><span class="koboSpan" id="kobo.1682.2">Your updated file should have the </span><span class="No-Break"><span class="koboSpan" id="kobo.1683.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer598">
<span class="koboSpan" id="kobo.1684.1"><img alt="Figure 17.31 – Adding the new variable value inside the webservers.yml file" src="image/B19682_17_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1685.1">Figure 17.31 – Adding the new variable value inside the webservers.yml file</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1686.1">Let’s run </span><span class="No-Break"><span class="koboSpan" id="kobo.1687.1">the playbook:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1688.1">ansible-playbook create-user.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1689.1">The command’s output is identical to our similar </span><span class="No-Break"><span class="koboSpan" id="kobo.1690.1">previous commands.</span></span></p></li> <li><span class="koboSpan" id="kobo.1691.1">You may test the new username (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1692.1">webuser</span></strong><span class="koboSpan" id="kobo.1693.1">) and password (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1694.1">changeit!</span></strong><span class="koboSpan" id="kobo.1695.1">) by trying to SSH into one of the web servers (for </span><span class="No-Break"><span class="koboSpan" id="kobo.1696.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1697.1">ans-web1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1698.1">):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1699.1">ssh webuser@ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1700.1">The SSH authentication should succeed. </span><span class="koboSpan" id="kobo.1700.2">Make sure to exit the remote Terminal before proceeding with the</span><a id="_idIndexMarker2624"/> <span class="No-Break"><span class="koboSpan" id="kobo.1701.1">next steps.</span></span></p></li> <li><span class="koboSpan" id="kobo.1702.1">Let’s remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1703.1">webuser</span></strong><span class="koboSpan" id="kobo.1704.1"> account on the web servers with the following command, to get back to our </span><span class="No-Break"><span class="koboSpan" id="kobo.1705.1">initial state:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1706.1">ansible-playbook delete-user.yml</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1707.1">Suppose we want to reuse the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1708.1">create-user</span></strong><span class="koboSpan" id="kobo.1709.1"> playbook to create a different user with a different password. </span><span class="koboSpan" id="kobo.1709.2">Let’s name this user </span><strong class="source-inline"><span class="koboSpan" id="kobo.1710.1">webadmin</span></strong><span class="koboSpan" id="kobo.1711.1">; we’ll set the password to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1712.1">changeme!</span></strong><span class="koboSpan" id="kobo.1713.1">. </span><span class="koboSpan" id="kobo.1713.2">One way to accomplish this task is to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1714.1">-e</span></strong> <strong class="source-inline"><span class="koboSpan" id="kobo.1715.1">(--extra-vars</span></strong><span class="koboSpan" id="kobo.1716.1">) option parameter </span><span class="No-Break"><span class="koboSpan" id="kobo.1717.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1718.1">ansible-playbook</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1719.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1720.1">ansible-playbook -e '{"username": "webadmin", "password": "changeme!"}' create-user.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1721.1">The preceding command will create a new user (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1722.1">webadmin</span></strong><span class="koboSpan" id="kobo.1723.1">) with the related password. </span><span class="koboSpan" id="kobo.1723.2">You can test the credentials with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1724.1">following command:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1725.1">ssh webadmin@ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1726.1">The SSH authentication should succeed. </span><span class="koboSpan" id="kobo.1726.2">Make sure you exit the remote Terminal </span><span class="No-Break"><span class="koboSpan" id="kobo.1727.1">before continuing.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.1728.1">As you can see, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1729.1">-e</span></strong><span class="koboSpan" id="kobo.1730.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1731.1">--extra-vars</span></strong><span class="koboSpan" id="kobo.1732.1">) option parameter takes a JSON string featuring the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1733.1">username</span></strong><span class="koboSpan" id="kobo.1734.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1735.1">password</span></strong><span class="koboSpan" id="kobo.1736.1"> fields, along with the corresponding values. </span><span class="koboSpan" id="kobo.1736.2">These values will </span><em class="italic"><span class="koboSpan" id="kobo.1737.1">override</span></em><span class="koboSpan" id="kobo.1738.1"> the values of the same variables defined at the group level in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1739.1">./</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1740.1">group_vars/webservers.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1741.1"> file.</span></span></p></li> <li><span class="koboSpan" id="kobo.1742.1">Let’s remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1743.1">webuser</span></strong><span class="koboSpan" id="kobo.1744.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1745.1">webadmin</span></strong><span class="koboSpan" id="kobo.1746.1"> accounts before we proceed with the next steps. </span><span class="koboSpan" id="kobo.1746.2">Let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1747.1">delete-user</span></strong><span class="koboSpan" id="kobo.1748.1"> playbook, first without </span><span class="No-Break"><span class="koboSpan" id="kobo.1749.1">any parameters:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1750.1">ansible-playbook delete-user.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1751.1">The preceding command removes the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1752.1">webuser</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1753.1"> account.</span></span></p></li> <li><span class="koboSpan" id="kobo.1754.1">Next, we’ll use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1755.1">-e</span></strong><span class="koboSpan" id="kobo.1756.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1757.1">--extra-vars</span></strong><span class="koboSpan" id="kobo.1758.1">) option parameter to delete the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1759.1">webadmin</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1"> user:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1761.1">ansible-playbook -e '{"username": "webadmin"}' delete-user.yml</span></strong></pre></li> </ol>
<p><span class="koboSpan" id="kobo.1762.1">Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1763.1">–extra-vars</span></strong><span class="koboSpan" id="kobo.1764.1"> with our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1765.1">create-user</span></strong><span class="koboSpan" id="kobo.1766.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1767.1">delete-user</span></strong><span class="koboSpan" id="kobo.1768.1"> playbooks, we can act on multiple user accounts by running the playbooks manually or in a loop and feeding the JSON blob with the required variables. </span><span class="koboSpan" id="kobo.1768.2">While this method could easily be scripted, Ansible provides even more ways</span><a id="_idIndexMarker2625"/><span class="koboSpan" id="kobo.1769.1"> to improve our playbooks by using task iteration with loops. </span><span class="koboSpan" id="kobo.1769.2">We’ll look at loops later in this chapter, but first, let’s handle our passwords more securely with Ansible’s encryption and decryption facilities for </span><span class="No-Break"><span class="koboSpan" id="kobo.1770.1">managing secrets.</span></span></p>
<h3><span class="koboSpan" id="kobo.1771.1">Working with secrets</span></h3>
<p><span class="koboSpan" id="kobo.1772.1">Ansible has a dedicated module for managing secrets called </span><strong class="bold"><span class="koboSpan" id="kobo.1773.1">Ansible Vault</span></strong><span class="koboSpan" id="kobo.1774.1">. </span><span class="koboSpan" id="kobo.1774.2">With Ansible Vault, we can encrypt and store sensitive data such as variables and files that are referenced in playbooks. </span><span class="koboSpan" id="kobo.1774.3">Ansible Vault is essentially a</span><a id="_idIndexMarker2626"/><span class="koboSpan" id="kobo.1775.1"> password-protected secure</span><a id="_idIndexMarker2627"/><span class="koboSpan" id="kobo.1776.1"> key-value </span><span class="No-Break"><span class="koboSpan" id="kobo.1777.1">data store.</span></span></p>
<p><span class="koboSpan" id="kobo.1778.1">To manage our secrets, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1779.1">ansible-vault</span></strong><span class="koboSpan" id="kobo.1780.1"> command-line utility. </span><span class="koboSpan" id="kobo.1780.2">Regarding our playbook, where we’re creating a user with a password, we want to avoid storing the password in clear text. </span><span class="koboSpan" id="kobo.1780.3">It is currently in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1781.1">./group_vars/webservers.yml</span></strong><span class="koboSpan" id="kobo.1782.1"> file. </span><span class="koboSpan" id="kobo.1782.2">As a reminder, our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1783.1">webservers.yml</span></strong><span class="koboSpan" id="kobo.1784.1"> file has the </span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">following content:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer599">
<span class="koboSpan" id="kobo.1786.1"><img alt="Figure 17.32 – Sensitive data stored in the password variable" src="image/B19682_17_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1787.1">Figure 17.32 – Sensitive data stored in the password variable</span></p>
<p><span class="koboSpan" id="kobo.1788.1">The last line contains sensitive data; the password is shown in plain text. </span><span class="koboSpan" id="kobo.1788.2">We have a few options here to protect </span><span class="No-Break"><span class="koboSpan" id="kobo.1789.1">our data:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1790.1">Encrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1791.1">webservers.yml</span></strong><span class="koboSpan" id="kobo.1792.1"> file. </span><span class="koboSpan" id="kobo.1792.2">If we choose to encrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1793.1">webservers.yml</span></strong><span class="koboSpan" id="kobo.1794.1"> file, we could possibly incur the overhead of encrypting non-sensitive data, such as the username or other general-purpose information. </span><span class="koboSpan" id="kobo.1794.2">If we have many users, encrypting and decrypting non-sensitive data would be </span><span class="No-Break"><span class="koboSpan" id="kobo.1795.1">highly redundant.</span></span></li>
<li><span class="koboSpan" id="kobo.1796.1">Encrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1797.1">password</span></strong><span class="koboSpan" id="kobo.1798.1"> variable only. </span><span class="koboSpan" id="kobo.1798.2">This would work fine for a single user. </span><span class="koboSpan" id="kobo.1798.3">But with a growing number of users, we’ll have multiple password variables to deal with, each with its own</span><a id="_idIndexMarker2628"/><span class="koboSpan" id="kobo.1799.1"> encryption and decryption. </span><span class="koboSpan" id="kobo.1799.2">Performance will once again be an issue if we have a large</span><a id="_idIndexMarker2629"/><span class="koboSpan" id="kobo.1800.1"> number </span><span class="No-Break"><span class="koboSpan" id="kobo.1801.1">of users.</span></span></li>
<li><span class="koboSpan" id="kobo.1802.1">Store the password in a separate protected file. </span><span class="koboSpan" id="kobo.1802.2">Ideally, we should have a separate file for storing all sensitive data. </span><span class="koboSpan" id="kobo.1802.3">This file would be decrypted only once during the playbook run, even with multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.1803.1">passwords stored.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1804.1">We will pursue the third option and create a separate file to keep our user </span><span class="No-Break"><span class="koboSpan" id="kobo.1805.1">passwords in.</span></span></p>
<h4><span class="koboSpan" id="kobo.1806.1">Protecting our data</span></h4>
<p><span class="koboSpan" id="kobo.1807.1">Let’s look at the steps that </span><a id="_idIndexMarker2630"/><span class="koboSpan" id="kobo.1808.1">need to be followed to ensure that our data </span><span class="No-Break"><span class="koboSpan" id="kobo.1809.1">is secure:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1810.1">We’ll name the file </span><strong class="source-inline"><span class="koboSpan" id="kobo.1811.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.1812.1"> (we create it inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1813.1">~/ansible/</span></strong><span class="koboSpan" id="kobo.1814.1"> directory) and add the following content </span><span class="No-Break"><span class="koboSpan" id="kobo.1815.1">to it:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer600">
<span class="koboSpan" id="kobo.1816.1"><img alt="Figure 17.33 – The passwords.yml file storing sensitive data" src="image/B19682_17_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1817.1">Figure 17.33 – The passwords.yml file storing sensitive data</span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.1818.1">We added a YAML dictionary (or hash) item matching the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1819.1">webuser</span></strong><span class="koboSpan" id="kobo.1820.1"> username related to the password. </span><span class="koboSpan" id="kobo.1820.2">This item contains another dictionary as a key-value pair: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1821.1">password: changeit!</span></strong><span class="koboSpan" id="kobo.1822.1">. </span><span class="koboSpan" id="kobo.1822.2">The equivalent YAML representation is </span><span class="No-Break"><span class="koboSpan" id="kobo.1823.1">as follows:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1824.1">
webuser: { password: changeit! </span><span class="koboSpan" id="kobo.1824.2">}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1825.1">This approach will allow us</span><a id="_idIndexMarker2631"/><span class="koboSpan" id="kobo.1826.1"> to add passwords that correspond to different users, </span><span class="No-Break"><span class="koboSpan" id="kobo.1827.1">like so:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1828.1">webuser: { password: changeit! </span><span class="koboSpan" id="kobo.1828.2">}
webadmin: { password: changeme! </span><span class="koboSpan" id="kobo.1828.3">}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1829.1">We’ll explain the concept behind this data structure and its use when we consume the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1830.1">password</span></strong><span class="koboSpan" id="kobo.1831.1"> variable in the playbook, later in </span><span class="No-Break"><span class="koboSpan" id="kobo.1832.1">this section.</span></span></p></li> <li><span class="koboSpan" id="kobo.1833.1">Now, since we keep our password in a different file, we’ll remove the corresponding entry from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1834.1">webusers.yml</span></strong><span class="koboSpan" id="kobo.1835.1">. </span><span class="koboSpan" id="kobo.1835.2">Let’s add some other user-related information using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1836.1">comment</span></strong><span class="koboSpan" id="kobo.1837.1"> variable. </span><span class="koboSpan" id="kobo.1837.2">Here’s what our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1838.1">webusers.yml</span></strong><span class="koboSpan" id="kobo.1839.1"> file </span><span class="No-Break"><span class="koboSpan" id="kobo.1840.1">looks like:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer601">
<span class="koboSpan" id="kobo.1841.1"><img alt="Figure 17.34 – The webusers.yml file storing non-sensitive user data" src="image/B19682_17_34.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1842.1">Figure 17.34 – The webusers.yml file storing non-sensitive user data</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.1843.1">Next, let’s protect our secrets by encrypting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1844.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.1845.1"> file using </span><span class="No-Break"><span class="koboSpan" id="kobo.1846.1">Ansible Vault:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1847.1">ansible-vault encrypt passwords.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1848.1">You’ll be prompted to create a vault password to protect the file. </span><span class="koboSpan" id="kobo.1848.2">Remember the password, as we’ll be using it throughout </span><span class="No-Break"><span class="koboSpan" id="kobo.1849.1">this section.</span></span></p></li> <li><span class="koboSpan" id="kobo.1850.1">Once you’re done, check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1851.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.1852.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1853.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1854.1">cat passwords.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1855.1">The output for the preceding </span><a id="_idIndexMarker2632"/><span class="koboSpan" id="kobo.1856.1">command shows </span><span class="No-Break"><span class="koboSpan" id="kobo.1857.1">the following:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer602">
<span class="koboSpan" id="kobo.1858.1"><img alt="Figure 17.35 – The encrypted passwords.yml file" src="image/B19682_17_35.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1859.1">Figure 17.35 – The encrypted passwords.yml file</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.1860.1">We can view the content of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1861.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.1862.1"> file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1863.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1864.1">ansible-vault view passwords.yml</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1865.1">You’ll be prompted for the vault password we created previously. </span><span class="koboSpan" id="kobo.1865.2">The output shows the streamlined YAML content corresponding to our </span><span class="No-Break"><span class="koboSpan" id="kobo.1866.1">protected file:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer603">
<span class="koboSpan" id="kobo.1867.1"><img alt="Figure 17.36 – Viewing the content of the protected file" src="image/B19682_17_36.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1868.1">Figure 17.36 – Viewing the content of the protected file</span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.1869.1">If you need to make changes, you can edit the encrypted file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1870.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1871.1">ansible-vault edit passwords.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1872.1">After authenticating with the vault password, the command will open a local editor (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1873.1">vi</span></strong><span class="koboSpan" id="kobo.1874.1">) to edit your changes. </span><span class="koboSpan" id="kobo.1874.2">If you want to re-encrypt your protected file with a different password, you can </span><a id="_idIndexMarker2633"/><span class="koboSpan" id="kobo.1875.1">run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1876.1">following command:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.1877.1">ansible-vault rekey passwords.yml</span></strong></pre></li> <li><span class="koboSpan" id="kobo.1878.1">You’ll be prompted</span><a id="_idIndexMarker2634"/><span class="koboSpan" id="kobo.1879.1"> for the current vault password, followed by the </span><span class="No-Break"><span class="koboSpan" id="kobo.1880.1">new password.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.1881.1">Now, let’s learn how to reference secrets in </span><span class="No-Break"><span class="koboSpan" id="kobo.1882.1">our playbook.</span></span></p>
<h4><span class="koboSpan" id="kobo.1883.1">Referencing secrets in playbooks</span></h4>
<p><span class="koboSpan" id="kobo.1884.1">To reference secrets, follow</span><a id="_idIndexMarker2635"/> <span class="No-Break"><span class="koboSpan" id="kobo.1885.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.1886.1">First, let’s make sure we can read our password from the vault. </span><span class="koboSpan" id="kobo.1886.2">Let’s make a new file with the following lines in it. </span><span class="koboSpan" id="kobo.1886.3">We will call </span><span class="No-Break"><span class="koboSpan" id="kobo.1887.1">it </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1888.1">create-user-new.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1889.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer604">
<span class="koboSpan" id="kobo.1890.1"><img alt="Figure 17.37 – Debugging vault access with new create-user-new.yml file" src="image/B19682_17_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1891.1">Figure 17.37 – Debugging vault access with new create-user-new.yml file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1892.1">We’ve added a couple </span><span class="No-Break"><span class="koboSpan" id="kobo.1893.1">of tasks:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1894.1">include_vars</span></strong><span class="koboSpan" id="kobo.1895.1"> (</span><em class="italic"><span class="koboSpan" id="kobo.1896.1">lines 6</span></em><span class="koboSpan" id="kobo.1897.1">-</span><em class="italic"><span class="koboSpan" id="kobo.1898.1">8</span></em><span class="koboSpan" id="kobo.1899.1">): Reading variables from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1900.1">passwords.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1901.1"> file</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1902.1">debug</span></strong><span class="koboSpan" id="kobo.1903.1"> (</span><em class="italic"><span class="koboSpan" id="kobo.1904.1">lines 10</span></em><span class="koboSpan" id="kobo.1905.1">-</span><em class="italic"><span class="koboSpan" id="kobo.1906.1">12</span></em><span class="koboSpan" id="kobo.1907.1">): Debugging the playbook and logging the password that was read from </span><span class="No-Break"><span class="koboSpan" id="kobo.1908.1">the vault</span></span></li>
</ul>
<p class="list-inset"><span class="koboSpan" id="kobo.1909.1">None of these tasks are </span><em class="italic"><span class="koboSpan" id="kobo.1910.1">aware</span></em><span class="koboSpan" id="kobo.1911.1"> that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1912.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.1913.1"> file is protected. </span><em class="italic"><span class="koboSpan" id="kobo.1914.1">Line 12</span></em><span class="koboSpan" id="kobo.1915.1"> is where the </span><span class="No-Break"><span class="koboSpan" id="kobo.1916.1">magic happens:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1917.1">
msg: "{{ vars[username]['password'] }}"</span></pre> <ol>
<li value="2"><span class="koboSpan" id="kobo.1918.1">We use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1919.1">vars[]</span></strong><span class="koboSpan" id="kobo.1920.1"> dictionary to query a specific variable in the playbook. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1921.1">vars[]</span></strong><span class="koboSpan" id="kobo.1922.1"> is a </span><em class="italic"><span class="koboSpan" id="kobo.1923.1">reserved</span></em><span class="koboSpan" id="kobo.1924.1"> data structure for storing all the variables that were created via </span><strong class="source-inline"><span class="koboSpan" id="kobo.1925.1">vars</span></strong><span class="koboSpan" id="kobo.1926.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1927.1">include_vars</span></strong><span class="koboSpan" id="kobo.1928.1"> in an Ansible playbook. </span><span class="koboSpan" id="kobo.1928.2">We can query the dictionary based on a key </span><a id="_idIndexMarker2636"/><span class="koboSpan" id="kobo.1929.1">appointed </span><span class="No-Break"><span class="koboSpan" id="kobo.1930.1">by </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1931.1">username</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1932.1">:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1933.1">
{{ vars[username] }}</span></pre><p class="list-inset"><span class="koboSpan" id="kobo.1934.1">Our playbook </span><a id="_idIndexMarker2637"/><span class="koboSpan" id="kobo.1935.1">gets </span><strong class="source-inline"><span class="koboSpan" id="kobo.1936.1">username</span></strong><span class="koboSpan" id="kobo.1937.1"> from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1938.1">./group_vars/webservers.yml</span></strong><span class="koboSpan" id="kobo.1939.1"> file, and its value is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1940.1">webuser</span></strong><span class="koboSpan" id="kobo.1941.1">. </span><span class="koboSpan" id="kobo.1941.2">Consequently, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1942.1">vars[webuser]</span></strong><span class="koboSpan" id="kobo.1943.1"> dictionary item reads the corresponding entry from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1944.1">passwords.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1945.1"> file:</span></span></p><pre class="source-code"><span class="koboSpan" id="kobo.1946.1">webuser: { password: changeit! </span><span class="koboSpan" id="kobo.1946.2">}</span></pre></li> <li><span class="koboSpan" id="kobo.1947.1">To get the password value from the corresponding key-value pair, we specify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1948.1">'password'</span></strong><span class="koboSpan" id="kobo.1949.1"> key in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1950.1">vars[username]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1951.1"> dictionary:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.1952.1">
{{ vars[username]['password'] }}</span></pre></li> <li><span class="koboSpan" id="kobo.1953.1">Let’s run this playbook with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1954.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.1955.1">ansible-playbook --ask-vault-pass create-user-new.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.1956.1">We invoked the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1957.1">--ask-vault-pass</span></strong><span class="koboSpan" id="kobo.1958.1"> option</span><a id="_idIndexMarker2638"/><span class="koboSpan" id="kobo.1959.1"> to let Ansible know that our playbook needs vault access. </span><span class="koboSpan" id="kobo.1959.2">Without this option, we’ll get an error when running the playbook. </span><span class="koboSpan" id="kobo.1959.3">Here’s the relevant output for our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1960.1">debug</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1961.1"> task:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer605">
<span class="koboSpan" id="kobo.1962.1"><img alt="Figure 17.38 – The playbook successfully reading secrets from the vault" src="image/B19682_17_38.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1963.1">Figure 17.38 – The playbook successfully reading secrets from the vault</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1964.1">Here, we can see that the</span><a id="_idIndexMarker2639"/><span class="koboSpan" id="kobo.1965.1"> playbook successfully retrieves the password from </span><span class="No-Break"><span class="koboSpan" id="kobo.1966.1">the vault.</span></span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.1967.1">Let’s wrap up our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1968.1">create-user-new.yml</span></strong><span class="koboSpan" id="kobo.1969.1"> playbook by adding the </span><span class="No-Break"><span class="koboSpan" id="kobo.1970.1">following code:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer606">
<span class="koboSpan" id="kobo.1971.1"><img alt="Figure 17.39 – The playbook creating a user with a password retrieved from the vault" src="image/B19682_17_39.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1972.1">Figure 17.39 – The playbook creating a user with a password retrieved from the vault</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.1973.1">Here are a few highlights </span><a id="_idIndexMarker2640"/><span class="koboSpan" id="kobo.1974.1">of the </span><span class="No-Break"><span class="koboSpan" id="kobo.1975.1">current implementation:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1976.1">We’ve added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1977.1">vars</span></strong><span class="koboSpan" id="kobo.1978.1"> block (</span><strong class="bold"><span class="koboSpan" id="kobo.1979.1">1</span></strong><span class="koboSpan" id="kobo.1980.1"> in </span><em class="italic"><span class="koboSpan" id="kobo.1981.1">Figure 17.39</span></em><span class="koboSpan" id="kobo.1982.1">) to define a local </span><strong class="source-inline"><span class="koboSpan" id="kobo.1983.1">password</span></strong><span class="koboSpan" id="kobo.1984.1"> variable (at the play scope) for reading the password from the vault; we are reusing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1985.1">password</span></strong><span class="koboSpan" id="kobo.1986.1"> variable in </span><span class="No-Break"><span class="koboSpan" id="kobo.1987.1">multiple tasks.</span></span></li>
<li><span class="koboSpan" id="kobo.1988.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1989.1">include_vars</span></strong><span class="koboSpan" id="kobo.1990.1"> task (</span><strong class="bold"><span class="koboSpan" id="kobo.1991.1">2</span></strong><span class="koboSpan" id="kobo.1992.1"> in the preceding screenshot) adds an external reference to the variables defined in the protected </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1993.1">passwords.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1994.1"> file.</span></span></li>
<li><span class="koboSpan" id="kobo.1995.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1996.1">debug</span></strong><span class="koboSpan" id="kobo.1997.1"> task (</span><strong class="bold"><span class="koboSpan" id="kobo.1998.1">3</span></strong><span class="koboSpan" id="kobo.1999.1"> in the preceding screenshot) helped with the initial debugging effort to make sure we could read the password from the vault. </span><span class="koboSpan" id="kobo.1999.2">You may choose to remove this task or leave it in place for future use. </span><span class="koboSpan" id="kobo.1999.3">If you keep the task, make sure you have </span><strong class="source-inline"><span class="koboSpan" id="kobo.2000.1">no_log: true</span></strong><span class="koboSpan" id="kobo.2001.1"> enabled (</span><em class="italic"><span class="koboSpan" id="kobo.2002.1">line 15</span></em><span class="koboSpan" id="kobo.2003.1">) to avoid logging sensitive information in the output. </span><span class="koboSpan" id="kobo.2003.2">When debugging, you can temporarily set </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2004.1">no_log: false</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2005.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2006.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2007.1">user</span></strong><span class="koboSpan" id="kobo.2008.1"> task (</span><strong class="bold"><span class="koboSpan" id="kobo.2009.1">4</span></strong><span class="koboSpan" id="kobo.2010.1"> in the </span><a id="_idIndexMarker2641"/><span class="koboSpan" id="kobo.2011.1">preceding screenshot) reads the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2012.1">password</span></strong><span class="koboSpan" id="kobo.2013.1"> variable and hashes the corresponding value. </span><span class="koboSpan" id="kobo.2013.2">This hashing is required by the Ansible </span><strong class="source-inline"><span class="koboSpan" id="kobo.2014.1">user</span></strong><span class="koboSpan" id="kobo.2015.1"> module for security reasons. </span><span class="koboSpan" id="kobo.2015.2">We also added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2016.1">comment</span></strong><span class="koboSpan" id="kobo.2017.1"> field with additional user information. </span><span class="koboSpan" id="kobo.2017.2">This field maps to the </span><strong class="bold"><span class="koboSpan" id="kobo.2018.1">Linux General Electric Comprehensive Operating System</span></strong><span class="koboSpan" id="kobo.2019.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2020.1">GECOS</span></strong><span class="koboSpan" id="kobo.2021.1">) record </span><a id="_idIndexMarker2642"/><span class="koboSpan" id="kobo.2022.1">of the user. </span><span class="koboSpan" id="kobo.2022.2">See the </span><em class="italic"><span class="koboSpan" id="kobo.2023.1">Managing users</span></em><span class="koboSpan" id="kobo.2024.1"> section of </span><a href="B19682_04.xhtml#_idTextAnchor090"><em class="italic"><span class="koboSpan" id="kobo.2025.1">Chapter 4</span></em></a><span class="koboSpan" id="kobo.2026.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2027.1">Managing Users and Groups</span></em><span class="koboSpan" id="kobo.2028.1">, for </span><span class="No-Break"><span class="koboSpan" id="kobo.2029.1">related information.</span></span></li>
</ul>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2030.1">Let’s run the playbook with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2031.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2032.1">ansible-playbook --ask-vault-pass create-user-new.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2033.1">After the command completes successfully, you can verify the new user account in a couple </span><span class="No-Break"><span class="koboSpan" id="kobo.2034.1">of ways:</span></span></p><ul><li><span class="koboSpan" id="kobo.2035.1">Use SSH to connect to any of the web servers using the related username and password, </span><span class="No-Break"><span class="koboSpan" id="kobo.2036.1">like so:</span></span><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.2037.1">ssh webuser@ans-web1</span></strong></pre></li><li><span class="koboSpan" id="kobo.2038.1">Look for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2039.1">webuser</span></strong><span class="koboSpan" id="kobo.2040.1"> record in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2041.1">/etc/passwd</span></strong><span class="koboSpan" id="kobo.2042.1"> on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2043.1">ans-web1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2044.1"> machine:</span></span><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.2045.1">tail -n 10 /etc/passwd</span></strong></pre></li><li><span class="koboSpan" id="kobo.2046.1">You should see the following line in the output (you’ll notice the GECOS </span><span class="No-Break"><span class="koboSpan" id="kobo.2047.1">field also):</span></span><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.2048.1">webuser:x:1001:1001:Regular web user:/home/webuser:/bin/sh</span></strong></pre></li></ul></li> </ol>
<p><span class="koboSpan" id="kobo.2049.1">You may want to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2050.1">ansible-playbook</span></strong><span class="koboSpan" id="kobo.2051.1"> command without supplying a vault password, as required by </span><strong class="source-inline"><span class="koboSpan" id="kobo.2052.1">--ask-vault-pass</span></strong><span class="koboSpan" id="kobo.2053.1">. </span><span class="koboSpan" id="kobo.2053.2">Such functionality is essential in scripted or automated workflows when using Ansible Vault. </span><span class="koboSpan" id="kobo.2053.3">To make your vault password automatically available when you’re running a playbook using sensitive data, start by creating a regular text file, preferably in your home directory; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2054.1">~/vault.pass</span></strong><span class="koboSpan" id="kobo.2055.1">. </span><span class="koboSpan" id="kobo.2055.2">Add the vault password to this file in a single line. </span><span class="koboSpan" id="kobo.2055.3">Then, you can choose </span><em class="italic"><span class="koboSpan" id="kobo.2056.1">either</span></em><span class="koboSpan" id="kobo.2057.1"> of the following options</span><a id="_idIndexMarker2643"/><span class="koboSpan" id="kobo.2058.1"> to use the vault </span><span class="No-Break"><span class="koboSpan" id="kobo.2059.1">password file:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2060.1">Create the following </span><span class="No-Break"><span class="koboSpan" id="kobo.2061.1">environment variable:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2062.1">export ANSIBLE_VAULT_PASSWORD_FILE=~/vault.pass</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2063.1">Add the following line to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2064.1">ansible.cfg</span></strong><span class="koboSpan" id="kobo.2065.1"> file’s </span><strong class="source-inline"><span class="koboSpan" id="kobo.2066.1">[</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2067.1">defaults]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2068.1"> section:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2069.1">vault_password_file = ~/vault.pass</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.2070.1">Now, you can run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2071.1">create-user-new</span></strong><span class="koboSpan" id="kobo.2072.1"> playbook without the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2073.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2074.1">ask-vault-pass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2075.1"> option:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2076.1">
ansible-playbook create-user.yml</span></pre> <p><span class="koboSpan" id="kobo.2077.1">Sometimes, protecting multiple secrets with a single vault password raises security concerns. </span><span class="koboSpan" id="kobo.2077.2">Ansible supports multiple vault passwords through </span><span class="No-Break"><span class="koboSpan" id="kobo.2078.1">vault IDs.</span></span></p>
<h4><span class="koboSpan" id="kobo.2079.1">Using vault IDs</span></h4>
<p><span class="koboSpan" id="kobo.2080.1">A </span><strong class="bold"><span class="koboSpan" id="kobo.2081.1">vault ID</span></strong><span class="koboSpan" id="kobo.2082.1"> is an identifier, or a label, associated with one or more vault secrets. </span><span class="koboSpan" id="kobo.2082.2">Each vault ID has a unique password to unlock the encryption and decryption of the corresponding secrets. </span><span class="koboSpan" id="kobo.2082.3">To</span><a id="_idIndexMarker2644"/><span class="koboSpan" id="kobo.2083.1"> illustrate the use of vault IDs, let’s look at our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2084.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.2085.1"> file. </span><span class="koboSpan" id="kobo.2085.2">Suppose we want to secure this file using a vault ID. </span><span class="koboSpan" id="kobo.2085.3">The following command creates a vault ID labeled </span><strong class="source-inline"><span class="koboSpan" id="kobo.2086.1">passwords</span></strong><span class="koboSpan" id="kobo.2087.1"> and prompts us to create </span><span class="No-Break"><span class="koboSpan" id="kobo.2088.1">a password:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2089.1">
ansible-vault create --vault-id passwords@prompt passwords.yml</span></pre> <p><span class="koboSpan" id="kobo.2090.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2091.1">passwords</span></strong><span class="koboSpan" id="kobo.2092.1"> vault ID protects the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2093.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.2094.1"> file. </span><span class="koboSpan" id="kobo.2094.2">Now, let’s assume we also want to secure some API keys associated with users. </span><span class="koboSpan" id="kobo.2094.3">If we stored these secrets in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2095.1">apikeys.yml</span></strong><span class="koboSpan" id="kobo.2096.1"> file, the following command would create a corresponding vault ID </span><span class="No-Break"><span class="koboSpan" id="kobo.2097.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2098.1">apikeys</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2099.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2100.1">
ansible-vault create --vault-id apikeys@prompt apikeys.yml</span></pre> <p><span class="koboSpan" id="kobo.2101.1">Here, we created two vault IDs, each with its own password and protecting </span><span class="No-Break"><span class="koboSpan" id="kobo.2102.1">different resources.</span></span></p>
<p><span class="koboSpan" id="kobo.2103.1">The benefits of vault IDs are </span><span class="No-Break"><span class="koboSpan" id="kobo.2104.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2105.1">They provide an</span><a id="_idIndexMarker2645"/><span class="koboSpan" id="kobo.2106.1"> improved security context when managing secrets. </span><span class="koboSpan" id="kobo.2106.2">If one of the vault ID passwords becomes compromised, resources that have been secured by the other vault IDs are </span><span class="No-Break"><span class="koboSpan" id="kobo.2107.1">still protected.</span></span></li>
<li><span class="koboSpan" id="kobo.2108.1">With vault IDs, we can also leverage different access levels to vault secrets. </span><span class="koboSpan" id="kobo.2108.2">For example, we can define </span><strong class="source-inline"><span class="koboSpan" id="kobo.2109.1">admin</span></strong><span class="koboSpan" id="kobo.2110.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2111.1">dev</span></strong><span class="koboSpan" id="kobo.2112.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2113.1">test</span></strong><span class="koboSpan" id="kobo.2114.1"> vault IDs for related groups of users. </span><span class="koboSpan" id="kobo.2114.2">Alternatively, we can have multiple configuration management projects, each with its own dedicated vault IDs and secrets; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2115.1">user-config</span></strong><span class="koboSpan" id="kobo.2116.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2117.1">web-config</span></strong><span class="koboSpan" id="kobo.2118.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.2119.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2120.1">db-config</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2121.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.2122.1">You can associate a vault ID with multiple secrets. </span><span class="koboSpan" id="kobo.2122.2">For example, the following command creates a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2123.1">user-config</span></strong><span class="koboSpan" id="kobo.2124.1"> vault ID that secures the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2125.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.2126.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2127.1">api-keys.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2128.1"> files:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2129.1">ansible-vault create --vault-id user-config@prompt passwords.yml apikeys.yml</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2130.1">When using vault IDs, we can also specify a password file to supply the related vault password. </span><span class="koboSpan" id="kobo.2130.2">The following command encrypts the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2131.1">apikeys.yml</span></strong><span class="koboSpan" id="kobo.2132.1"> file, which reads the corresponding vault ID password from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2133.1">apikeys.pass</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2134.1"> file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2135.1">ansible-vault encrypt --vault-id apikeys@apikeys.pass apikeys.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2136.1">You can </span><a id="_idIndexMarker2646"/><span class="koboSpan" id="kobo.2137.1">name your vault password files anything you want, but keeping a consistent naming convention, possibly one that matches the related vault ID, will make your life easier when you’re managing multiple </span><span class="No-Break"><span class="koboSpan" id="kobo.2138.1">vault secrets.</span></span></p></li> <li><span class="koboSpan" id="kobo.2139.1">Similarly, you can pass a vault ID (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2140.1">passwords</span></strong><span class="koboSpan" id="kobo.2141.1">) to a playbook (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2142.1">create-users-new.yml</span></strong><span class="koboSpan" id="kobo.2143.1">) with the </span><a id="_idIndexMarker2647"/><span class="No-Break"><span class="koboSpan" id="kobo.2144.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2145.1">ansible-playbook --vault-id passwords@passwords.pass create-users-new.yml</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.2146.1">For more information about</span><a id="_idIndexMarker2648"/><span class="koboSpan" id="kobo.2147.1"> Ansible Vault, you may refer to the related online documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.2148.1">at </span></span><a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html"><span class="No-Break"><span class="koboSpan" id="kobo.2149.1">https://docs.ansible.com/ansible/latest/user_guide/vault.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2150.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2151.1">So far, we have created a single user account with a password. </span><span class="koboSpan" id="kobo.2151.2">What if we want to onboard multiple users, each with their own password? </span><span class="koboSpan" id="kobo.2151.3">As we noted previously, we could call the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2152.1">create-user</span></strong><span class="koboSpan" id="kobo.2153.1"> playbook and override the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2154.1">username</span></strong><span class="koboSpan" id="kobo.2155.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2156.1">password</span></strong><span class="koboSpan" id="kobo.2157.1"> variables using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2158.1">--extra-vars</span></strong><span class="koboSpan" id="kobo.2159.1"> option parameter. </span><span class="koboSpan" id="kobo.2159.2">But this method is not a very efficient one, not to mention the difficulty of maintaining it. </span><span class="koboSpan" id="kobo.2159.3">In the next section, we’ll show you how to use task iteration in </span><span class="No-Break"><span class="koboSpan" id="kobo.2160.1">Ansible playbooks.</span></span></p>
<h3><span class="koboSpan" id="kobo.2161.1">Working with loops</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.2162.1">Loops</span></strong><span class="koboSpan" id="kobo.2163.1"> provide an efficient way of running a task repeatedly in Ansible playbooks. </span><span class="koboSpan" id="kobo.2163.2">There</span><a id="_idIndexMarker2649"/><span class="koboSpan" id="kobo.2164.1"> are several loop implementations in Ansible, and we can classify them</span><a id="_idIndexMarker2650"/><span class="koboSpan" id="kobo.2165.1"> into the following categories based on their keyword </span><span class="No-Break"><span class="koboSpan" id="kobo.2166.1">or syntax:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2167.1">loop</span></strong><span class="koboSpan" id="kobo.2168.1">: The recommended way of iterating through </span><span class="No-Break"><span class="koboSpan" id="kobo.2169.1">a collection</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2170.1">with_&lt;lookup&gt;</span></strong><span class="koboSpan" id="kobo.2171.1">: Collection-specific implementations of loops; examples include </span><strong class="source-inline"><span class="koboSpan" id="kobo.2172.1">with_list</span></strong><span class="koboSpan" id="kobo.2173.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2174.1">with_items</span></strong><span class="koboSpan" id="kobo.2175.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2176.1">with_dict</span></strong><span class="koboSpan" id="kobo.2177.1">, to name </span><span class="No-Break"><span class="koboSpan" id="kobo.2178.1">a few</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2179.1">In this section, we’ll</span><a id="_idIndexMarker2651"/><span class="koboSpan" id="kobo.2180.1"> keep our focus on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2181.1">loop</span></strong><span class="koboSpan" id="kobo.2182.1"> iteration (equivalent to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2183.1">with_list</span></strong><span class="koboSpan" id="kobo.2184.1">), which is best suited for simple loops. </span><span class="koboSpan" id="kobo.2184.2">Let’s expand our previous use case and adapt it to create multiple users. </span><span class="koboSpan" id="kobo.2184.3">We’ll start by making a quick comparison between running repeated tasks </span><em class="italic"><span class="koboSpan" id="kobo.2185.1">with</span></em><span class="koboSpan" id="kobo.2186.1"> and </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2187.1">without</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2188.1"> loops:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2189.1">As a preparatory step, make sure </span><strong class="source-inline"><span class="koboSpan" id="kobo.2190.1">~/ansible</span></strong><span class="koboSpan" id="kobo.2191.1"> is your current working directory. </span><span class="koboSpan" id="kobo.2191.2">Also, you can delete the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2192.1">./group_vars</span></strong><span class="koboSpan" id="kobo.2193.1"> folder, as we’re not using it anymore. </span><span class="koboSpan" id="kobo.2193.2">Now, let’s create a couple of playbooks, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2194.1">create-users1.yml</span></strong><span class="koboSpan" id="kobo.2195.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2196.1">create-users2.yml</span></strong><span class="koboSpan" id="kobo.2197.1">, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2198.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer607">
<span class="koboSpan" id="kobo.2199.1"><img alt="Figure 17.40 – Playbooks with multiple versus iterative tasks" src="image/B19682_17_40.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2200.1">Figure 17.40 – Playbooks with multiple versus iterative tasks</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2201.1">Both playbooks create three users: </span><strong class="source-inline"><span class="koboSpan" id="kobo.2202.1">webuser</span></strong><span class="koboSpan" id="kobo.2203.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2204.1">webadmin</span></strong><span class="koboSpan" id="kobo.2205.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2206.1">webdev</span></strong><span class="koboSpan" id="kobo.2207.1">. </span><span class="koboSpan" id="kobo.2207.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2208.1">create-users1</span></strong><span class="koboSpan" id="kobo.2209.1"> playbook</span><a id="_idIndexMarker2652"/><span class="koboSpan" id="kobo.2210.1"> has three distinct tasks, one for creating each user. </span><span class="koboSpan" id="kobo.2210.2">On the </span><a id="_idIndexMarker2653"/><span class="koboSpan" id="kobo.2211.1">other hand, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2212.1">create-users2</span></strong><span class="koboSpan" id="kobo.2213.1"> implements a single task iteration using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2214.1">loop</span></strong><span class="koboSpan" id="kobo.2215.1"> directive (in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2216.1">line 15</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2217.1">):</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2218.1">
loop: "{{ users }}"</span></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2219.1">The loop iterates through the items of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2220.1">users</span></strong><span class="koboSpan" id="kobo.2221.1"> list, defined as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2222.1">play</span></strong><span class="koboSpan" id="kobo.2223.1"> variable in </span><em class="italic"><span class="koboSpan" id="kobo.2224.1">lines 6-9</span></em><span class="koboSpan" id="kobo.2225.1">. </span><span class="koboSpan" id="kobo.2225.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2226.1">user</span></strong><span class="koboSpan" id="kobo.2227.1"> task uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2228.1">{{ item }}</span></strong><span class="koboSpan" id="kobo.2229.1"> variable, referencing each user while iterating through </span><span class="No-Break"><span class="koboSpan" id="kobo.2230.1">the list.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2231.1">Before running any of these playbooks, let’s also create one for deleting the users. </span><span class="koboSpan" id="kobo.2231.2">We’ll name this playbook </span><strong class="source-inline"><span class="koboSpan" id="kobo.2232.1">delete-users2.yml,</span></strong><span class="koboSpan" id="kobo.2233.1"> and it will have a similar implementation </span><span class="No-Break"><span class="koboSpan" id="kobo.2234.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2235.1">create-users2.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2236.1">:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer608">
<span class="koboSpan" id="kobo.2237.1"><img alt="Figure 17.41 – A playbook using a loop for deleting users" src="image/B19682_17_41.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2238.1">Figure 17.41 – A playbook using a loop for deleting users</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2239.1">Now, let’s run </span><a id="_idIndexMarker2654"/><span class="koboSpan" id="kobo.2240.1">the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2241.1">create-users1</span></strong><span class="koboSpan" id="kobo.2242.1"> playbook </span><a id="_idIndexMarker2655"/><span class="koboSpan" id="kobo.2243.1">while targeting only the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2244.1">ans-web1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2245.1">web server:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2246.1">ansible-playbook create-users1.yml --limit ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2247.1">In the output, we can see that three tasks have been executed, one for </span><span class="No-Break"><span class="koboSpan" id="kobo.2248.1">each user:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer609">
<span class="koboSpan" id="kobo.2249.1"><img alt="Figure 17.42 – The output of the create-users1 playbook, with multiple tasks" src="image/B19682_17_42.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2250.1">Figure 17.42 – The output of the create-users1 playbook, with multiple tasks</span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2251.1">Let’s delete the </span><a id="_idIndexMarker2656"/><span class="koboSpan" id="kobo.2252.1">users by running the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2253.1">delete-users2.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2254.1"> playbook:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2255.1">ansible-playbook delete-users2.yml --limit ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2256.1">The output is as</span><a id="_idIndexMarker2657"/><span class="koboSpan" id="kobo.2257.1"> shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2258.1">following screenshot:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer610">
<span class="koboSpan" id="kobo.2259.1"><img alt="Figure 17.43 – Deleting users using the playbook" src="image/B19682_17_43.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2260.1">Figure 17.43 – Deleting users using the playbook</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2261.1">Now, let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2262.1">create-users2</span></strong><span class="koboSpan" id="kobo.2263.1"> playbook, again targeting only the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2264.1">web1</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2265.1">web server:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2266.1">ansible-playbook create-users2.yml --limit ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2267.1">This time, the output shows a single task iterating through all </span><span class="No-Break"><span class="koboSpan" id="kobo.2268.1">the users:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer611">
<span class="koboSpan" id="kobo.2269.1"><img alt="Figure 17.44 – The output of the create-users2 playbook, with a single task iteration" src="image/B19682_17_44.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2270.1">Figure 17.44 – The output of the create-users2 playbook, with a single task iteration</span></p>
<p><span class="koboSpan" id="kobo.2271.1">The difference between the two</span><a id="_idIndexMarker2658"/><span class="koboSpan" id="kobo.2272.1"> playbook runs </span><span class="No-Break"><span class="koboSpan" id="kobo.2273.1">is significant:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2274.1">The first playbook executes a task for each user. </span><span class="koboSpan" id="kobo.2274.2">While forking a task is not an expensive operation, you can </span><a id="_idIndexMarker2659"/><span class="koboSpan" id="kobo.2275.1">imagine that creating hundreds of users would incur a significant load on the </span><span class="No-Break"><span class="koboSpan" id="kobo.2276.1">Ansible runtime.</span></span></li>
<li><span class="koboSpan" id="kobo.2277.1">On the other hand, the second playbook runs a single task, loading the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2278.1">user</span></strong><span class="koboSpan" id="kobo.2279.1"> module three times, to create each user. </span><span class="koboSpan" id="kobo.2279.2">Loading a module takes significantly fewer resources than running </span><span class="No-Break"><span class="koboSpan" id="kobo.2280.1">a task.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2281.1">For more information </span><a id="_idIndexMarker2660"/><span class="koboSpan" id="kobo.2282.1">about loops, you may refer to the related online documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.2283.1">at </span></span><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html"><span class="No-Break"><span class="koboSpan" id="kobo.2284.1">https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2285.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2286.1">Now that we </span><a id="_idIndexMarker2661"/><span class="koboSpan" id="kobo.2287.1">know how to implement a simple loop, we’ll make our playbook more compact </span><span class="No-Break"><span class="koboSpan" id="kobo.2288.1">and maintainable.</span></span></p>
<h3><span class="koboSpan" id="kobo.2289.1">Configuring our playbooks</span></h3>
<p><span class="koboSpan" id="kobo.2290.1">Apart from enhancing our </span><a id="_idIndexMarker2662"/><span class="koboSpan" id="kobo.2291.1">playbooks, we’ll also try to come closer to a real-world scenario by storing the users and their related passwords in a reusable and </span><span class="No-Break"><span class="koboSpan" id="kobo.2292.1">secure fashion.</span></span></p>
<p><span class="koboSpan" id="kobo.2293.1">We will keep the web users’ information in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2294.1">users.yml</span></strong><span class="koboSpan" id="kobo.2295.1"> file. </span><span class="koboSpan" id="kobo.2295.2">The related passwords are in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2296.1">users_passwords.yml</span></strong><span class="koboSpan" id="kobo.2297.1"> file. </span><span class="koboSpan" id="kobo.2297.2">Here are the two files, along with some example </span><span class="No-Break"><span class="koboSpan" id="kobo.2298.1">user data:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer612">
<span class="koboSpan" id="kobo.2299.1"><img alt="Figure 17.45 – The users.yml and users_passwords.yml files" src="image/B19682_17_45.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2300.1">Figure 17.45 – The users.yml and users_passwords.yml files</span></p>
<p><span class="koboSpan" id="kobo.2301.1">Let’s take a closer look at</span><a id="_idIndexMarker2663"/> <span class="No-Break"><span class="koboSpan" id="kobo.2302.1">these files:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2303.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2304.1">users.yml</span></strong><span class="koboSpan" id="kobo.2305.1"> file contains a dictionary with a single </span><span class="No-Break"><span class="koboSpan" id="kobo.2306.1">key-value pair:</span></span><ul><li><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.2307.1">Key</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2308.1">: </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2309.1">webusers</span></strong></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.2310.1">Value</span></strong><span class="koboSpan" id="kobo.2311.1">: A list of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2312.1">username</span></strong><span class="koboSpan" id="kobo.2313.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2314.1">comment</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2315.1"> tuples</span></span></li></ul></li>
<li><span class="koboSpan" id="kobo.2316.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2317.1">users_passwords.yml</span></strong><span class="koboSpan" id="kobo.2318.1"> file contains a nested dictionary with multiple key-value pairs, </span><span class="No-Break"><span class="koboSpan" id="kobo.2319.1">as follows:</span></span><ul><li><strong class="bold"><span class="koboSpan" id="kobo.2320.1">Key</span></strong><span class="koboSpan" id="kobo.2321.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.2322.1">&lt;username&gt;</span></strong><span class="koboSpan" id="kobo.2323.1"> (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2324.1">webuser</span></strong><span class="koboSpan" id="kobo.2325.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2326.1">webadmin</span></strong><span class="koboSpan" id="kobo.2327.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2328.1">so on)</span></span></li><li><strong class="bold"><span class="koboSpan" id="kobo.2329.1">Value</span></strong><span class="koboSpan" id="kobo.2330.1">: A nested dictionary with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2331.1">password: &lt;value&gt;</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2332.1">key-value pair</span></span></li></ul></li>
</ul>
<p><span class="koboSpan" id="kobo.2333.1">You may use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2334.1">ansible-vault edit</span></strong><span class="koboSpan" id="kobo.2335.1"> command to update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2336.1">users_passwords.yml</span></strong><span class="koboSpan" id="kobo.2337.1"> file, or you can create a new one, as we did. </span><span class="koboSpan" id="kobo.2337.2">Alternatively, after you create a file from scratch, you will then have to encrypt it, following the steps previously described in the </span><em class="italic"><span class="koboSpan" id="kobo.2338.1">Working with </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2339.1">secrets</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2340.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.2341.1">The new </span><strong class="source-inline"><span class="koboSpan" id="kobo.2342.1">create-users.yml</span></strong><span class="koboSpan" id="kobo.2343.1"> playbook file has the </span><span class="No-Break"><span class="koboSpan" id="kobo.2344.1">following implementation:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer613">
<span class="koboSpan" id="kobo.2345.1"><img alt="Figure 17.46 – The create-users.yml playbook" src="image/B19682_17_46.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2346.1">Figure 17.46 – The create-users.yml playbook</span></p>
<p><span class="koboSpan" id="kobo.2347.1">These files are also available in the GitHub repository for this book, in the related chapter folder. </span><span class="koboSpan" id="kobo.2347.2">Let’s </span><a id="_idIndexMarker2664"/><span class="koboSpan" id="kobo.2348.1">quickly go over the playbook’s implementation. </span><span class="koboSpan" id="kobo.2348.2">We have </span><span class="No-Break"><span class="koboSpan" id="kobo.2349.1">three tasks:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2350.1">Load users</span></strong><span class="koboSpan" id="kobo.2351.1">: Reads the web user information from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2352.1">users.yml</span></strong><span class="koboSpan" id="kobo.2353.1"> file and stores the related values in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2354.1">users</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2355.1"> dictionary</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2356.1">Load passwords</span></strong><span class="koboSpan" id="kobo.2357.1">: Reads the passwords from the encrypted </span><strong class="source-inline"><span class="koboSpan" id="kobo.2358.1">passwords.yml</span></strong><span class="koboSpan" id="kobo.2359.1"> file and stores the corresponding values in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2360.1">passwords</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2361.1"> dictionary</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2362.1">Create user accounts</span></strong><span class="koboSpan" id="kobo.2363.1">: Iterates through the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2364.1">users.webusers</span></strong><span class="koboSpan" id="kobo.2365.1"> list and, for each item, creates a user account with the related parameters; the task performs a password lookup in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2366.1">passwords</span></strong><span class="koboSpan" id="kobo.2367.1"> dictionary based </span><span class="No-Break"><span class="koboSpan" id="kobo.2368.1">on </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2369.1">item.username</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2370.1">Before running the playbook, let us encrypt the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2371.1">users_passwords.yml</span></strong><span class="koboSpan" id="kobo.2372.1"> file using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2373.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2374.1">
ansible-vault encrypt users_passwords.yml</span></pre> <p><span class="koboSpan" id="kobo.2375.1">Now, run the</span><a id="_idIndexMarker2665"/><span class="koboSpan" id="kobo.2376.1"> playbook with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2377.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2378.1">
ansible-playbook -–ask-vault-pass create-users.yml</span></pre> <p><span class="koboSpan" id="kobo.2379.1">Here’s </span><span class="No-Break"><span class="koboSpan" id="kobo.2380.1">the output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer614">
<span class="koboSpan" id="kobo.2381.1"><img alt="Figure 17.47 – Running the create-users.yml playbook" src="image/B19682_17_47.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2382.1">Figure 17.47 – Running the create-users.yml playbook</span></p>
<p><span class="koboSpan" id="kobo.2383.1">We can see the following</span><a id="_idIndexMarker2666"/><span class="koboSpan" id="kobo.2384.1"> playbook tasks </span><span class="No-Break"><span class="koboSpan" id="kobo.2385.1">at work:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2386.1">Gathering Facts</span></strong><span class="koboSpan" id="kobo.2387.1">: Discovering managed hosts and related system variables (facts); we’ll introduce Ansible facts later in </span><span class="No-Break"><span class="koboSpan" id="kobo.2388.1">this chapter</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2389.1">Load users</span></strong><span class="koboSpan" id="kobo.2390.1">: Reading the users from the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2391.1">users.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2392.1"> file</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2393.1">Load passwords</span></strong><span class="koboSpan" id="kobo.2394.1">: Reading the passwords from the encrypted </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2395.1">passwords.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2396.1"> file</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2397.1">Create user accounts</span></strong><span class="koboSpan" id="kobo.2398.1">: The task iteration loop </span><span class="No-Break"><span class="koboSpan" id="kobo.2399.1">creates users</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2400.1">You may verify the new user accounts using the methods presented earlier in the </span><em class="italic"><span class="koboSpan" id="kobo.2401.1">Working with secrets</span></em><span class="koboSpan" id="kobo.2402.1"> section. </span><span class="koboSpan" id="kobo.2402.2">As an exercise, create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2403.1">delete-users.yml</span></strong><span class="koboSpan" id="kobo.2404.1"> playbook using a similar implementation to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2405.1">create-users</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2406.1"> playbook.</span></span></p>
<p><span class="koboSpan" id="kobo.2407.1">Now, let’s look at how we </span><a id="_idIndexMarker2667"/><span class="koboSpan" id="kobo.2408.1">can improve our playbook and reuse it to seamlessly create users across all hosts in the inventory, web servers, and databases alike. </span><span class="koboSpan" id="kobo.2408.2">We’ll use conditional tasks to accomplish </span><span class="No-Break"><span class="koboSpan" id="kobo.2409.1">this functionality.</span></span></p>
<h3><span class="koboSpan" id="kobo.2410.1">Running conditional tasks</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.2411.1">Conditionals</span></strong><span class="koboSpan" id="kobo.2412.1"> in Ansible </span><a id="_idIndexMarker2668"/><span class="koboSpan" id="kobo.2413.1">playbooks decide when to run a task, depending on a</span><a id="_idIndexMarker2669"/><span class="koboSpan" id="kobo.2414.1"> condition (or a state). </span><span class="koboSpan" id="kobo.2414.2">This condition can be the value of a </span><strong class="bold"><span class="koboSpan" id="kobo.2415.1">variable</span></strong><span class="koboSpan" id="kobo.2416.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.2417.1">fact</span></strong><span class="koboSpan" id="kobo.2418.1"> or the </span><strong class="bold"><span class="koboSpan" id="kobo.2419.1">result</span></strong><span class="koboSpan" id="kobo.2420.1"> of a previous task. </span><span class="koboSpan" id="kobo.2420.2">Ansible uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2421.1">when</span></strong><span class="koboSpan" id="kobo.2422.1"> task-level directive to define </span><span class="No-Break"><span class="koboSpan" id="kobo.2423.1">a condition.</span></span></p>
<p><span class="koboSpan" id="kobo.2424.1">We learned about variables and how to use them in playbooks. </span><span class="koboSpan" id="kobo.2424.2">Facts and results are essentially variables of a specific type and use. </span><span class="koboSpan" id="kobo.2424.3">We’ll look at each of these variables in the context of conditional tasks. </span><span class="koboSpan" id="kobo.2424.4">Let’s start </span><span class="No-Break"><span class="koboSpan" id="kobo.2425.1">with facts.</span></span></p>
<h4><span class="koboSpan" id="kobo.2426.1">Using Ansible facts</span></h4>
<p><strong class="bold"><span class="koboSpan" id="kobo.2427.1">Facts</span></strong><span class="koboSpan" id="kobo.2428.1"> are</span><a id="_idIndexMarker2670"/><span class="koboSpan" id="kobo.2429.1"> variables </span><a id="_idIndexMarker2671"/><span class="koboSpan" id="kobo.2430.1">that provide specific information about </span><em class="italic"><span class="koboSpan" id="kobo.2431.1">remote</span></em><span class="koboSpan" id="kobo.2432.1"> managed hosts. </span><span class="koboSpan" id="kobo.2432.2">Fact variable names start with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2433.1">ansible_</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2434.1"> prefix.</span></span></p>
<p><span class="koboSpan" id="kobo.2435.1">Here are a few examples of </span><span class="No-Break"><span class="koboSpan" id="kobo.2436.1">Ansible facts:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2437.1">ansible_distribution</span></strong><span class="koboSpan" id="kobo.2438.1">: The OS distribution (for </span><span class="No-Break"><span class="koboSpan" id="kobo.2439.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2440.1">Ubuntu</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2441.1">)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2442.1">ansible_all_ipv4_addresses</span></strong><span class="koboSpan" id="kobo.2443.1">: The </span><span class="No-Break"><span class="koboSpan" id="kobo.2444.1">IPv4 addresses</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2445.1">ansible_architecture</span></strong><span class="koboSpan" id="kobo.2446.1">: The platform architecture (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2447.1">x86_64</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2448.1">or </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2449.1">i386</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2450.1">)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2451.1">ansible_processor_cores</span></strong><span class="koboSpan" id="kobo.2452.1">: The number of </span><span class="No-Break"><span class="koboSpan" id="kobo.2453.1">CPU cores</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2454.1">ansible_memfree_mb</span></strong><span class="koboSpan" id="kobo.2455.1">: The available memory (</span><span class="No-Break"><span class="koboSpan" id="kobo.2456.1">in MB)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2457.1">Now, what if we didn’t have groups explicitly created for classifying our hosts in Ubuntu and Debian systems, for example (or any other distribution, for that matter)? </span><span class="koboSpan" id="kobo.2457.2">In this case, we could gather facts about our managed hosts, detect their OS type, and perform the conditional update task, depending on the underlying platform. </span><span class="koboSpan" id="kobo.2457.3">Let’s implement this</span><a id="_idIndexMarker2672"/><span class="koboSpan" id="kobo.2458.1"> functionality in a playbook using </span><span class="No-Break"><span class="koboSpan" id="kobo.2459.1">Ansible facts.</span></span></p>
<p><span class="koboSpan" id="kobo.2460.1">We’ll name our playbook </span><strong class="source-inline"><span class="koboSpan" id="kobo.2461.1">install-updates.yml</span></strong><span class="koboSpan" id="kobo.2462.1"> and add the following content </span><span class="No-Break"><span class="koboSpan" id="kobo.2463.1">to it:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer615">
<span class="koboSpan" id="kobo.2464.1"><img alt="Figure 17.48 – The install-updates.yml playbook" src="image/B19682_17_48.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2465.1">Figure 17.48 – The install-updates.yml playbook</span></p>
<p><span class="koboSpan" id="kobo.2466.1">The playbook targets all hosts and has two conditional tasks, based on the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2467.1">ansible_distribution</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2468.1"> fact:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2469.1">Install Ubuntu system updates</span></strong><span class="koboSpan" id="kobo.2470.1">: Runs exclusively on Ubuntu hosts based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2471.1">ansible_distribution == "Ubuntu"</span></strong><span class="koboSpan" id="kobo.2472.1"> condition (</span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2473.1">line 9</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2474.1">)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2475.1">Install Debian system updates</span></strong><span class="koboSpan" id="kobo.2476.1">: Runs exclusively on Debian hosts based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2477.1">ansible_distribution == "Debian"</span></strong><span class="koboSpan" id="kobo.2478.1"> condition (</span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2479.1">line 13</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2480.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2481.1">Let’s run </span><span class="No-Break"><span class="koboSpan" id="kobo.2482.1">our playbook:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2483.1">
ansible-playbook install-updates.yml</span></pre> <p><span class="koboSpan" id="kobo.2484.1">The commands will take a significant time to run if there are any updates to install on the hosts. </span><span class="koboSpan" id="kobo.2484.2">Here’s the </span><span class="No-Break"><span class="koboSpan" id="kobo.2485.1">corresponding output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer616">
<span class="koboSpan" id="kobo.2486.1"><img alt="Figure 17.49 – Running conditional tasks" src="image/B19682_17_49.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2487.1">Figure 17.49 – Running conditional tasks</span></p>
<p><span class="koboSpan" id="kobo.2488.1">There are three tasks </span><a id="_idIndexMarker2673"/><span class="koboSpan" id="kobo.2489.1">illustrated in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2490.1">preceding output:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2491.1">Gathering Facts</span></strong><span class="koboSpan" id="kobo.2492.1">: The default discovery task that’s executed by the playbook to gather facts about </span><span class="No-Break"><span class="koboSpan" id="kobo.2493.1">remote hosts</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2494.1">Install Ubuntu system updates</span></strong><span class="koboSpan" id="kobo.2495.1">: The conditional task for running all </span><span class="No-Break"><span class="koboSpan" id="kobo.2496.1">Ubuntu hosts</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2497.1">Install Debian system updates</span></strong><span class="koboSpan" id="kobo.2498.1">: The conditional task for skipping all Ubuntu-based hosts, as we don’t currently run any </span><span class="No-Break"><span class="koboSpan" id="kobo.2499.1">Debian ones</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2500.1">Next, we’ll look at how to use Ansible’s environment-specific variables in </span><span class="No-Break"><span class="koboSpan" id="kobo.2501.1">conditional tasks.</span></span></p>
<h4><span class="koboSpan" id="kobo.2502.1">Using magic variables</span></h4>
<p><strong class="bold"><span class="koboSpan" id="kobo.2503.1">Magic variables</span></strong><span class="koboSpan" id="kobo.2504.1"> describe </span><a id="_idIndexMarker2674"/><span class="koboSpan" id="kobo.2505.1">the local Ansible environment and its related configuration data. </span><span class="koboSpan" id="kobo.2505.2">Here are a few examples of </span><span class="No-Break"><span class="koboSpan" id="kobo.2506.1">magic variables:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2507.1">ansible_playhosts</span></strong><span class="koboSpan" id="kobo.2508.1">: A list of active hosts in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2509.1">current play</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2510.1">group_names</span></strong><span class="koboSpan" id="kobo.2511.1">: A list of all groups the current host is a </span><span class="No-Break"><span class="koboSpan" id="kobo.2512.1">member of</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2513.1">vars</span></strong><span class="koboSpan" id="kobo.2514.1">: A dictionary with all variables in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2515.1">current play</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2516.1">ansible_version</span></strong><span class="koboSpan" id="kobo.2517.1">: The version </span><span class="No-Break"><span class="koboSpan" id="kobo.2518.1">of Ansible</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2519.1">To see magic variables in action while using conditional tasks, we’ll improve our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2520.1">create-users</span></strong><span class="koboSpan" id="kobo.2521.1"> playbook even further and create specific groups of users on different host groups. </span><span class="koboSpan" id="kobo.2521.2">So far, the playbook only creates users on hosts that belong to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2522.1">webservers</span></strong><span class="koboSpan" id="kobo.2523.1"> group (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2524.1">web1</span></strong><span class="koboSpan" id="kobo.2525.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2526.1">web2</span></strong><span class="koboSpan" id="kobo.2527.1">). </span><span class="koboSpan" id="kobo.2527.2">The playbook creates </span><strong class="source-inline"><span class="koboSpan" id="kobo.2528.1">webuser</span></strong><span class="koboSpan" id="kobo.2529.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2530.1">webadmin</span></strong><span class="koboSpan" id="kobo.2531.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2532.1">webdev</span></strong><span class="koboSpan" id="kobo.2533.1"> user accounts on all web servers. </span><span class="koboSpan" id="kobo.2533.2">What if we want to create a similar group of users – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2534.1">dbuser</span></strong><span class="koboSpan" id="kobo.2535.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2536.1">dbadmin</span></strong><span class="koboSpan" id="kobo.2537.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2538.1">dbdev</span></strong><span class="koboSpan" id="kobo.2539.1"> – on all our database servers? </span><span class="koboSpan" id="kobo.2539.2">To achieve this, you can follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2540.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2541.1">Start by adding the new user accounts and passwords to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2542.1">users.yml</span></strong><span class="koboSpan" id="kobo.2543.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2544.1">users_passwords.yml</span></strong><span class="koboSpan" id="kobo.2545.1"> files, respectively. </span><span class="koboSpan" id="kobo.2545.2">Here’s what we have after adding the database’s user accounts </span><span class="No-Break"><span class="koboSpan" id="kobo.2546.1">and passwords:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer617">
<span class="koboSpan" id="kobo.2547.1"><img alt="Figure 17.50 – The users.yml and passwords.yml files" src="image/B19682_17_50.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2548.1">Figure 17.50 – The users.yml and passwords.yml files</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2549.1">Note that you can edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2550.1">users_passwords.yml</span></strong><span class="koboSpan" id="kobo.2551.1"> file using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2552.1">ansible-vault edit</span></strong><span class="koboSpan" id="kobo.2553.1"> command. </span><span class="koboSpan" id="kobo.2553.2">Alternatively, you can decrypt the file, edit it, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2554.1">re-encrypt it.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2555.1">Now, let’s create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2556.1">create-users3</span></strong><span class="koboSpan" id="kobo.2557.1"> playbook with the required conditional tasks to handle</span><a id="_idIndexMarker2675"/><span class="koboSpan" id="kobo.2558.1"> both groups – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2559.1">webusers</span></strong><span class="koboSpan" id="kobo.2560.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2561.1">databases</span></strong><span class="koboSpan" id="kobo.2562.1"> – selectively. </span><span class="koboSpan" id="kobo.2562.2">Let us create a new file called </span><strong class="source-inline"><span class="koboSpan" id="kobo.2563.1">create-users3.yml</span></strong><span class="koboSpan" id="kobo.2564.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2565.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer618">
<span class="koboSpan" id="kobo.2566.1"><img alt="Figure 17.51 – The create-users.yml playbook with conditional tasks" src="image/B19682_17_51.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2567.1">Figure 17.51 – The create-users.yml playbook with conditional tasks</span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2568.1">Let’s run </span><span class="No-Break"><span class="koboSpan" id="kobo.2569.1">the playbook:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2570.1">ansible-playbook -–ask-vault-pass create-users3.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2571.1">The following is an excerpt of the output that shows the web user task</span><a id="_idIndexMarker2676"/><span class="koboSpan" id="kobo.2572.1"> skipping the database servers and the database user task skipping the web servers, suggesting that the web and database users have been </span><span class="No-Break"><span class="koboSpan" id="kobo.2573.1">created successfully:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer619">
<span class="koboSpan" id="kobo.2574.1"><img alt="Figure 17.52 – The web and database user tasks running selectively" src="image/B19682_17_52.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2575.1">Figure 17.52 – The web and database user tasks running selectively</span></p>
<p><span class="koboSpan" id="kobo.2576.1">For a complete list of </span><a id="_idIndexMarker2677"/><span class="koboSpan" id="kobo.2577.1">Ansible special variables, including</span><a id="_idIndexMarker2678"/><span class="koboSpan" id="kobo.2578.1"> magic variables, please visit </span><a href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html"><span class="koboSpan" id="kobo.2579.1">https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html</span></a><span class="koboSpan" id="kobo.2580.1">. </span><span class="koboSpan" id="kobo.2580.2">For more information about facts</span><a id="_idIndexMarker2679"/><span class="koboSpan" id="kobo.2581.1"> and magic variables, check out the online documentation </span><span class="No-Break"><span class="koboSpan" id="kobo.2582.1">at </span></span><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html"><span class="No-Break"><span class="koboSpan" id="kobo.2583.1">https://docs.ansible.com/ansible/latest/user_guide/playbooks_vars_facts.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2584.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2585.1">Next, we’ll look at variables for tracking task results, also known as </span><span class="No-Break"><span class="koboSpan" id="kobo.2586.1">register variables.</span></span></p>
<h4><span class="koboSpan" id="kobo.2587.1">Using register variables</span></h4>
<p><strong class="bold"><span class="koboSpan" id="kobo.2588.1">Ansible registers</span></strong><span class="koboSpan" id="kobo.2589.1"> capture the output of a task in a variable called a </span><strong class="bold"><span class="koboSpan" id="kobo.2590.1">register variable</span></strong><span class="koboSpan" id="kobo.2591.1">. </span><span class="koboSpan" id="kobo.2591.2">Ansible </span><a id="_idIndexMarker2680"/><span class="koboSpan" id="kobo.2592.1">uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2593.1">register</span></strong><span class="koboSpan" id="kobo.2594.1"> directive to capture the task’s output in a variable. </span><span class="koboSpan" id="kobo.2594.2">A typical example of using register variables is collecting the result of a task for debugging purposes. </span><span class="koboSpan" id="kobo.2594.3">In more complex workflows, a particular task may or may not run, depending on a previous </span><span class="No-Break"><span class="koboSpan" id="kobo.2595.1">task’s result.</span></span></p>
<p><span class="koboSpan" id="kobo.2596.1">Let’s consider a hypothetical use case. </span><span class="koboSpan" id="kobo.2596.2">As we onboard new users and create different accounts on all our servers, we want to make sure the number of users doesn’t exceed the maximum number allowed. </span><span class="koboSpan" id="kobo.2596.3">If the limit is reached, we may choose to launch a new server, redistribute the users, and so on. </span><span class="koboSpan" id="kobo.2596.4">You can follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2597.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2598.1">Let’s start by creating a playbook named </span><strong class="source-inline"><span class="koboSpan" id="kobo.2599.1">count-users.yml</span></strong><span class="koboSpan" id="kobo.2600.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2601.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer620">
<span class="koboSpan" id="kobo.2602.1"><img alt="Figure 17.53 – The count-users.yml playbook" src="image/B19682_17_53.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2603.1">Figure 17.53 – The count-users.yml playbook</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2604.1">We created the following tasks in </span><span class="No-Break"><span class="koboSpan" id="kobo.2605.1">the playbook:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2606.1">Count all users</span></strong><span class="koboSpan" id="kobo.2607.1">: A task that uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2608.1">shell</span></strong><span class="koboSpan" id="kobo.2609.1"> module to count all users; we register the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2610.1">count</span></strong><span class="koboSpan" id="kobo.2611.1"> variable by capturing the </span><span class="No-Break"><span class="koboSpan" id="kobo.2612.1">task output</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2613.1">Debug number of users</span></strong><span class="koboSpan" id="kobo.2614.1">: A simple task for debugging purposes that logs the number of users and the maximum </span><span class="No-Break"><span class="koboSpan" id="kobo.2615.1">limit allowed</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2616.1">Detect limit</span></strong><span class="koboSpan" id="kobo.2617.1">: A conditional task that’s run when the limit has been reached; the task checks the value of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2618.1">count</span></strong><span class="koboSpan" id="kobo.2619.1"> register variable and compares it with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2620.1">max_allowed</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2621.1"> variable</span></span></li>
</ul>
<p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.2622.1">Line 17</span></em><span class="koboSpan" id="kobo.2623.1"> in our playbook needs some further explanation. </span><span class="koboSpan" id="kobo.2623.2">Here, we take the </span><a id="_idIndexMarker2681"/><span class="koboSpan" id="kobo.2624.1">actual standard output of the register variable; that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2625.1">count.stdout</span></strong><span class="koboSpan" id="kobo.2626.1">. </span><span class="koboSpan" id="kobo.2626.2">As is, the value would be a string, and we need to cast it to an integer; that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2627.1">count.stdout | int</span></strong><span class="koboSpan" id="kobo.2628.1">. </span><span class="koboSpan" id="kobo.2628.2">Then, we compare the resulting number </span><span class="No-Break"><span class="koboSpan" id="kobo.2629.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2630.1">max_allowed</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2631.1">.</span></span></p>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2632.1">Let’s run the playbook while targeting only the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2633.1">ans-web1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2634.1"> host:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2635.1">ansible-playbook count-users.yml --limit ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2636.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.2637.1">as follows:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer621">
<span class="koboSpan" id="kobo.2638.1"><img alt="Figure 17.54 – The conditional task (Detect limit) is executed" src="image/B19682_17_54.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2639.1">Figure 17.54 – The conditional task (Detect limit) is executed</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2640.1">Here, we can see that the number of users is 36, thus exceeding the maximum limit of 30. </span><span class="koboSpan" id="kobo.2640.2">In other words, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2641.1">Detect limit</span></strong><span class="koboSpan" id="kobo.2642.1"> task ran as it was </span><span class="No-Break"><span class="koboSpan" id="kobo.2643.1">supposed to.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2644.1">Now, let’s edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2645.1">count-users.yml</span></strong><span class="koboSpan" id="kobo.2646.1"> playbook and change </span><span class="No-Break"><span class="koboSpan" id="kobo.2647.1">the following:</span></span><pre class="source-code"><span class="koboSpan" id="kobo.2648.1">
max_allowed: 50</span></pre></li> <li><span class="koboSpan" id="kobo.2649.1">Save and rerun the </span><a id="_idIndexMarker2682"/><span class="koboSpan" id="kobo.2650.1">playbook. </span><span class="koboSpan" id="kobo.2650.2">This time, the output shows that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2651.1">Detect limit</span></strong><span class="koboSpan" id="kobo.2652.1"> task </span><span class="No-Break"><span class="koboSpan" id="kobo.2653.1">was skipped:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer622">
<span class="koboSpan" id="kobo.2654.1"><img alt="Figure 17.55 – The conditional task (Detect limit) is skipped" src="image/B19682_17_55.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2655.1">Figure 17.55 – The conditional task (Detect limit) is skipped</span></p>
<p><span class="koboSpan" id="kobo.2656.1">To learn more about conditional tasks</span><a id="_idIndexMarker2683"/><span class="koboSpan" id="kobo.2657.1"> in Ansible playbooks, please visit </span><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html"><span class="koboSpan" id="kobo.2658.1">https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html</span></a><span class="koboSpan" id="kobo.2659.1">. </span><span class="koboSpan" id="kobo.2659.2">By combining conditional tasks with Ansible’s all-encompassing facts and special variables, we can write extremely powerful playbooks and automate a wide range of system </span><span class="No-Break"><span class="koboSpan" id="kobo.2660.1">administration operations.</span></span></p>
<p><span class="koboSpan" id="kobo.2661.1">In the following sections, we’ll explore additional ways to make our playbooks more reusable and versatile. </span><span class="koboSpan" id="kobo.2661.2">We’ll look at dynamic configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.2662.1">templates next.</span></span></p>
<h2 id="_idParaDest-356"><a id="_idTextAnchor380"/><span class="koboSpan" id="kobo.2663.1">Using templates with Jinja2</span></h2>
<p><span class="koboSpan" id="kobo.2664.1">One of the most common</span><a id="_idIndexMarker2684"/><span class="koboSpan" id="kobo.2665.1"> configuration management tasks is </span><a id="_idIndexMarker2685"/><span class="koboSpan" id="kobo.2666.1">copying files to managed hosts. </span><span class="koboSpan" id="kobo.2666.2">Ansible provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2667.1">copy</span></strong><span class="koboSpan" id="kobo.2668.1"> module for serving such tasks. </span><span class="koboSpan" id="kobo.2668.2">A typical file copy operation has the following syntax in </span><span class="No-Break"><span class="koboSpan" id="kobo.2669.1">Ansible playbooks:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2670.1">
- copy:
    src: motd
    dest: /etc/motd</span></pre> <p><span class="koboSpan" id="kobo.2671.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2672.1">copy</span></strong><span class="koboSpan" id="kobo.2673.1"> task takes a source file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2674.1">motd</span></strong><span class="koboSpan" id="kobo.2675.1">) and copies it to a destination (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2676.1">/etc/motd</span></strong><span class="koboSpan" id="kobo.2677.1">) on the remote host. </span><span class="koboSpan" id="kobo.2677.2">While this model would work for copying static files to multiple hosts, it won’t handle host-specific customizations in these files on </span><span class="No-Break"><span class="koboSpan" id="kobo.2678.1">the fly.</span></span></p>
<p><span class="koboSpan" id="kobo.2679.1">Take, for example, a network configuration file featuring the IP address of a host. </span><span class="koboSpan" id="kobo.2679.2">Attempting to copy this file on all hosts to configure the related network settings could render all but one host unreachable. </span><span class="koboSpan" id="kobo.2679.3">Ideally, the network configuration file should have a </span><em class="italic"><span class="koboSpan" id="kobo.2680.1">placeholder</span></em><span class="koboSpan" id="kobo.2681.1"> for the dynamic content (for example, IP address) and adapt the file accordingly, depending on the </span><span class="No-Break"><span class="koboSpan" id="kobo.2682.1">target host.</span></span></p>
<p><span class="koboSpan" id="kobo.2683.1">To address this functionality, Ansible provides the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2684.1">template</span></strong><span class="koboSpan" id="kobo.2685.1"> module with the </span><strong class="bold"><span class="koboSpan" id="kobo.2686.1">Jinja2</span></strong><span class="koboSpan" id="kobo.2687.1"> templating engine. </span><span class="koboSpan" id="kobo.2687.2">Jinja2 uses Python-like language constructs for variables and expressions in a template. </span><span class="koboSpan" id="kobo.2687.3">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2688.1">template</span></strong><span class="koboSpan" id="kobo.2689.1"> syntax is very similar </span><span class="No-Break"><span class="koboSpan" id="kobo.2690.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2691.1">copy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2692.1">:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2693.1">
- template:
    src: motd.j2
    dest: /etc/motd</span></pre> <p><span class="koboSpan" id="kobo.2694.1">The source, in this case, is</span><a id="_idIndexMarker2686"/><span class="koboSpan" id="kobo.2695.1"> a Jinja2 template file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2696.1">motd.j2</span></strong><span class="koboSpan" id="kobo.2697.1">) with host-specific customizations. </span><span class="koboSpan" id="kobo.2697.2">Before copying the</span><a id="_idIndexMarker2687"/><span class="koboSpan" id="kobo.2698.1"> file to the remote host, Ansible reads the Jinja2 template and replaces the dynamic content with the host-specific data. </span><span class="koboSpan" id="kobo.2698.2">This processing happens on the Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.2699.1">control node.</span></span></p>
<p><span class="koboSpan" id="kobo.2700.1">To illustrate some of the benefits and internal workings of Ansible templates, we’ll work with a couple of use cases and create a Jinja2 template for each. </span><span class="koboSpan" id="kobo.2700.2">Then, we’ll create and run the related playbooks to show the templates </span><span class="No-Break"><span class="koboSpan" id="kobo.2701.1">in action.</span></span></p>
<p><span class="koboSpan" id="kobo.2702.1">Here are the two templates we’ll be creating in </span><span class="No-Break"><span class="koboSpan" id="kobo.2703.1">this section:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.2704.1">Message-of-the-day template</span></strong><span class="koboSpan" id="kobo.2705.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2706.1">motd</span></strong><span class="koboSpan" id="kobo.2707.1">): For displaying a customized message to users about scheduled </span><span class="No-Break"><span class="koboSpan" id="kobo.2708.1">system maintenance</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.2709.1">Host file template</span></strong><span class="koboSpan" id="kobo.2710.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2711.1">hosts</span></strong><span class="koboSpan" id="kobo.2712.1">): For generating a custom </span><strong class="source-inline"><span class="koboSpan" id="kobo.2713.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.2714.1"> file on each system with the hostname records of the other </span><span class="No-Break"><span class="koboSpan" id="kobo.2715.1">managed hosts</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2716.1">Let’s start with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2717.1">message-of-the-day template.</span></span></p>
<h3><span class="koboSpan" id="kobo.2718.1">Creating a message-of-the-day template</span></h3>
<p><span class="koboSpan" id="kobo.2719.1">In our introductory </span><a id="_idIndexMarker2688"/><span class="koboSpan" id="kobo.2720.1">notes, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2721.1">/etc/motd</span></strong><span class="koboSpan" id="kobo.2722.1"> file as an example. </span><span class="koboSpan" id="kobo.2722.2">On a Linux system, the content of this file is displayed when a user logs in to the Terminal. </span><span class="koboSpan" id="kobo.2722.3">Suppose you plan to upgrade your web servers on Thursday night and would like to give your users a friendly reminder about the upcoming outage. </span><span class="koboSpan" id="kobo.2722.4">Your </span><strong class="source-inline"><span class="koboSpan" id="kobo.2723.1">motd</span></strong><span class="koboSpan" id="kobo.2724.1"> message could be something </span><span class="No-Break"><span class="koboSpan" id="kobo.2725.1">like this:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2726.1">
This server will be down for maintenance on Thursday night.</span></pre> <p><span class="koboSpan" id="kobo.2727.1">There’s nothing special about this message, and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2728.1">motd</span></strong><span class="koboSpan" id="kobo.2729.1"> file could be easily deployed with a simple </span><strong class="source-inline"><span class="koboSpan" id="kobo.2730.1">copy</span></strong><span class="koboSpan" id="kobo.2731.1"> task. </span><span class="koboSpan" id="kobo.2731.2">In most cases, such a message would probably do just fine, apart from the rare occasion when users may get confused about which exactly is “</span><strong class="source-inline"><span class="koboSpan" id="kobo.2732.1">this server</span></strong><span class="koboSpan" id="kobo.2733.1">”. </span><span class="koboSpan" id="kobo.2733.2">You may also consider that Thursday night in the US could be Friday afternoon on the other side of the world, and it would be nice if the announcement were </span><span class="No-Break"><span class="koboSpan" id="kobo.2734.1">more specific.</span></span></p>
<p><span class="koboSpan" id="kobo.2735.1">Perhaps a better message would state, on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2736.1">ans-web1</span></strong><span class="koboSpan" id="kobo.2737.1"> web server, </span><span class="No-Break"><span class="koboSpan" id="kobo.2738.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.2739.1">
ans-web1 (172.16.191.12) will be down for maintenance on Thursday, April 8, 2021, between 2 - 3 AM (UTC-08:00).</span></pre> <p><span class="koboSpan" id="kobo.2740.1">On the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2741.1">ans-web2</span></strong><span class="koboSpan" id="kobo.2742.1"> web server, the message would reflect the corresponding hostname and IP address. </span><span class="koboSpan" id="kobo.2742.2">Ideally, the template should be reusable across multiple time zones, with playbooks running on globally distributed Ansible control nodes. </span><span class="koboSpan" id="kobo.2742.3">Let’s see how we can implement such a template (we’ll assume your current working directory </span><span class="No-Break"><span class="koboSpan" id="kobo.2743.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2744.1">~/ansible</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2745.1">):</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2746.1">First, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2747.1">templates</span></strong><span class="koboSpan" id="kobo.2748.1"> folder in your local Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.2749.1">project directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2750.1">mkdir -p ~/ansible/templates</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2751.1">Ansible will look for template files in the local directory, which is where we’ll create our playbook, or in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2752.1">./</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2753.1">templates</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2754.1"> folder.</span></span></p></li> <li><span class="koboSpan" id="kobo.2755.1">Using a Linux editor of your choice, create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2756.1">motd.j2</span></strong><span class="koboSpan" id="kobo.2757.1"> file in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2758.1">./templates</span></strong><span class="koboSpan" id="kobo.2759.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2760.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer623">
<span class="koboSpan" id="kobo.2761.1"><img alt="Figure 17.56 – The motd.j2 template file" src="image/B19682_17_56.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2762.1">Figure 17.56 – The motd.j2 template file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2763.1">Note some of the particularities of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2764.1">Jinja2 syntax:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2765.1">Comments are enclosed in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2766.1">{# ... </span><span class="koboSpan" id="kobo.2766.2">#}</span></strong></li>
<li><span class="koboSpan" id="kobo.2767.1">Expressions are surrounded by </span><strong class="source-inline"><span class="koboSpan" id="kobo.2768.1">{% ... </span><span class="koboSpan" id="kobo.2768.2">%}</span></strong></li>
<li><span class="koboSpan" id="kobo.2769.1">External variables are referenced with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2770.1">{{ ... </span><span class="koboSpan" id="kobo.2770.2">}}</span></strong></li>
</ul>
<p class="list-inset"><span class="koboSpan" id="kobo.2771.1">Here’s what the </span><a id="_idIndexMarker2689"/><span class="No-Break"><span class="koboSpan" id="kobo.2772.1">script does:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.2773.1">Lines 1</span></em><span class="koboSpan" id="kobo.2774.1">-</span><em class="italic"><span class="koboSpan" id="kobo.2775.1">4</span></em><span class="koboSpan" id="kobo.2776.1"> define an initial set of local variables for storing time boundaries for the outage: the day of the outage (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2777.1">date</span></strong><span class="koboSpan" id="kobo.2778.1">), the starting time (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2779.1">start_time</span></strong><span class="koboSpan" id="kobo.2780.1">), and the ending </span><span class="No-Break"><span class="koboSpan" id="kobo.2781.1">time (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2782.1">end_time</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2783.1">).</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2784.1">Line 6</span></em><span class="koboSpan" id="kobo.2785.1"> defines the input date-time format (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2786.1">fmt</span></strong><span class="koboSpan" id="kobo.2787.1">) for our starting and ending </span><span class="No-Break"><span class="koboSpan" id="kobo.2788.1">time variables.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2789.1">Lines 7</span></em><span class="koboSpan" id="kobo.2790.1">-</span><em class="italic"><span class="koboSpan" id="kobo.2791.1">8</span></em><span class="koboSpan" id="kobo.2792.1"> build </span><strong class="source-inline"><span class="koboSpan" id="kobo.2793.1">datetime</span></strong><span class="koboSpan" id="kobo.2794.1"> objects that correspond to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2795.1">start_time</span></strong><span class="koboSpan" id="kobo.2796.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2797.1">end_time</span></strong><span class="koboSpan" id="kobo.2798.1">. </span><span class="koboSpan" id="kobo.2798.2">These Python </span><strong class="source-inline"><span class="koboSpan" id="kobo.2799.1">datetime</span></strong><span class="koboSpan" id="kobo.2800.1"> objects are formatted according to our needs in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2801.1">custom message.</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.2802.1">Line 11</span></em><span class="koboSpan" id="kobo.2803.1"> prints the custom message, featuring user-friendly time outputs and a couple of </span><a id="_idIndexMarker2690"/><span class="koboSpan" id="kobo.2804.1">Ansible facts, namely the </span><strong class="bold"><span class="koboSpan" id="kobo.2805.1">fully qualified domain name</span></strong><span class="koboSpan" id="kobo.2806.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2807.1">FQDN</span></strong><span class="koboSpan" id="kobo.2808.1">) (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2809.1">ansible_facts.fqdn</span></strong><span class="koboSpan" id="kobo.2810.1">) and IPv4 address (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2811.1">ansible_facts.default_ipv4.address</span></strong><span class="koboSpan" id="kobo.2812.1">) of the host where the message </span><span class="No-Break"><span class="koboSpan" id="kobo.2813.1">is displayed.</span></span></li>
</ul>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2814.1">Now, let’s create a playbook running the template. </span><span class="koboSpan" id="kobo.2814.2">We will name the playbook </span><strong class="source-inline"><span class="koboSpan" id="kobo.2815.1">update-motd.yml</span></strong><span class="koboSpan" id="kobo.2816.1"> and add</span><a id="_idIndexMarker2691"/><span class="koboSpan" id="kobo.2817.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.2818.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer624">
<span class="koboSpan" id="kobo.2819.1"><img alt="Figure 17.57 – The update-motd.yml playbook" src="image/B19682_17_57.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2820.1">Figure 17.57 – The update-motd.yml playbook</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2821.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2822.1">template</span></strong><span class="koboSpan" id="kobo.2823.1"> module reads and processes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2824.1">motd.j2</span></strong><span class="koboSpan" id="kobo.2825.1"> file, generating related dynamic content, then copies the file to the remote host in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2826.1">/etc/motd</span></strong><span class="koboSpan" id="kobo.2827.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2828.1">required permissions.</span></span></p>
<ol>
<li value="4"><span class="koboSpan" id="kobo.2829.1">Now, we’re ready to run </span><span class="No-Break"><span class="koboSpan" id="kobo.2830.1">our playbook:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2831.1">ansible-playbook update-motd.yml</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2832.1">The command should complete successfully. </span><span class="koboSpan" id="kobo.2832.2">Here is a screenshot of </span><span class="No-Break"><span class="koboSpan" id="kobo.2833.1">our output:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer625">
<span class="koboSpan" id="kobo.2834.1"><img alt="Figure 17.58 – Running the update-motd.yml playbook" src="image/B19682_17_58.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2835.1">Figure 17.58 – Running the update-motd.yml playbook</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2836.1">You can immediately verify the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2837.1">motd</span></strong><span class="koboSpan" id="kobo.2838.1"> message on any of the hosts (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2839.1">ans-web1</span></strong><span class="koboSpan" id="kobo.2840.1">) with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2841.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2842.1">ansible ans-web1 -a "cat /etc/motd"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2843.1">The preceding command runs remotely on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2844.1">ans-web1</span></strong><span class="koboSpan" id="kobo.2845.1"> host and </span><a id="_idIndexMarker2692"/><span class="koboSpan" id="kobo.2846.1">displays the content of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2847.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2848.1">etc/motd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2849.1"> file:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer626">
<span class="koboSpan" id="kobo.2850.1"><img alt="Figure 17.59 – The content of the remote /etc/motd file" src="image/B19682_17_59.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2851.1">Figure 17.59 – The content of the remote /etc/motd file</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.2852.1">We can also SSH into any of the hosts to verify the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2853.1">motd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2854.1"> prompt:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2855.1">ssh packt@ans-web1</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2856.1">The Terminal shows the </span><span class="No-Break"><span class="koboSpan" id="kobo.2857.1">following output:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer627">
<span class="koboSpan" id="kobo.2858.1"><img alt="Figure 17.60 – The motd prompt on the remote host" src="image/B19682_17_60.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2859.1">Figure 17.60 – The motd prompt on the remote host</span></p>
<ol>
<li value="7"><span class="koboSpan" id="kobo.2860.1">Now that we know how to write and handle Ansible templates, let’s improve </span><strong class="source-inline"><span class="koboSpan" id="kobo.2861.1">motd.j2</span></strong><span class="koboSpan" id="kobo.2862.1"> to make it a bit more reusable. </span><span class="koboSpan" id="kobo.2862.2">We’ll </span><em class="italic"><span class="koboSpan" id="kobo.2863.1">parameterize</span></em><span class="koboSpan" id="kobo.2864.1"> the template by replacing the hardcoded local </span><a id="_idIndexMarker2693"/><span class="koboSpan" id="kobo.2865.1">variables for date and time with input variables that are passed from the playbook. </span><span class="koboSpan" id="kobo.2865.2">This way, we’ll make our template reusable across multiple playbooks and different input times for maintenance. </span><span class="koboSpan" id="kobo.2865.3">Here’s the updated template </span><span class="No-Break"><span class="koboSpan" id="kobo.2866.1">file (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2867.1">motd.j2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2868.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer628">
<span class="koboSpan" id="kobo.2869.1"><img alt="Figure 17.61 – The modified motd.j2 template with input variables" src="image/B19682_17_61.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2870.1">Figure 17.61 – The modified motd.j2 template with input variables</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2871.1">Relevant changes are in </span><em class="italic"><span class="koboSpan" id="kobo.2872.1">lines 1</span></em><span class="koboSpan" id="kobo.2873.1">-</span><em class="italic"><span class="koboSpan" id="kobo.2874.1">2</span></em><span class="koboSpan" id="kobo.2875.1">, where we build </span><strong class="source-inline"><span class="koboSpan" id="kobo.2876.1">datetime</span></strong><span class="koboSpan" id="kobo.2877.1"> objects </span><a id="_idIndexMarker2694"/><span class="koboSpan" id="kobo.2878.1">using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2879.1">date</span></strong><span class="koboSpan" id="kobo.2880.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2881.1">start_time</span></strong><span class="koboSpan" id="kobo.2882.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2883.1">end_time</span></strong><span class="koboSpan" id="kobo.2884.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2885.1">utc</span></strong><span class="koboSpan" id="kobo.2886.1"> input variables. </span><span class="koboSpan" id="kobo.2886.2">Notice the difference between the </span><em class="italic"><span class="koboSpan" id="kobo.2887.1">local variables</span></em><span class="koboSpan" id="kobo.2888.1"> – </span><strong class="source-inline"><span class="koboSpan" id="kobo.2889.1">start_time_</span></strong><span class="koboSpan" id="kobo.2890.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2891.1">end_time_</span></strong><span class="koboSpan" id="kobo.2892.1"> (suffixed with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2893.1">_</span></strong><span class="koboSpan" id="kobo.2894.1">) – and the corresponding </span><em class="italic"><span class="koboSpan" id="kobo.2895.1">input variables</span></em><span class="koboSpan" id="kobo.2896.1">; that is, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2897.1">start_time</span></strong><span class="koboSpan" id="kobo.2898.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2899.1">end_time</span></strong><span class="koboSpan" id="kobo.2900.1">. </span><span class="koboSpan" id="kobo.2900.2">You may choose any naming convention for the variables, assuming it </span><span class="No-Break"><span class="koboSpan" id="kobo.2901.1">is Ansible-compliant.</span></span></p>
<ol>
<li value="8"><span class="koboSpan" id="kobo.2902.1">Now, let’s look at our modified </span><span class="No-Break"><span class="koboSpan" id="kobo.2903.1">playbook (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2904.1">update-motd.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2905.1">):</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer629">
<span class="koboSpan" id="kobo.2906.1"><img alt="Figure 17.62 – The modified update-motd.yml playbook with variables" src="image/B19682_17_62.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2907.1">Figure 17.62 – The modified update-motd.yml playbook with variables</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2908.1">Relevant changes are </span><a id="_idIndexMarker2695"/><span class="koboSpan" id="kobo.2909.1">highlighted in the preceding screenshot, where we added variables serving the input for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2910.1">motd.j2</span></strong><span class="koboSpan" id="kobo.2911.1"> template. </span><span class="koboSpan" id="kobo.2911.2">Running the modified playbook should yield the same result as the previous implementation. </span><span class="koboSpan" id="kobo.2911.3">We’ll leave the related exercise </span><span class="No-Break"><span class="koboSpan" id="kobo.2912.1">to you.</span></span></p>
<p><span class="koboSpan" id="kobo.2913.1">Next, we’ll look </span><a id="_idIndexMarker2696"/><span class="koboSpan" id="kobo.2914.1">at another use case featuring template-based deployments: updating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2915.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.2916.1"> file on managed hosts with the host records of all the other servers in </span><span class="No-Break"><span class="koboSpan" id="kobo.2917.1">the group.</span></span></p>
<h3><span class="koboSpan" id="kobo.2918.1">Creating a hosts file template</span></h3>
<p><span class="koboSpan" id="kobo.2919.1">Another example of using an Ansible template is to automatically update the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2920.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.2921.1"> files on every</span><a id="_idIndexMarker2697"/><span class="koboSpan" id="kobo.2922.1"> machine by using Jinja2 templating. </span><span class="koboSpan" id="kobo.2922.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2923.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.2924.1"> file contains numerical IP addresses and the names of all hosts on the network, and updating it regularly is a useful task for a system administrator. </span><span class="koboSpan" id="kobo.2924.2">We will create a new template for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2925.1">hosts</span></strong><span class="koboSpan" id="kobo.2926.1"> file and then update the specific YAML file to access the new template file. </span><span class="koboSpan" id="kobo.2926.2">To create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2927.1">hosts</span></strong><span class="koboSpan" id="kobo.2928.1"> file template, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.2929.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2930.1">Let’s start by creating a new template file, named </span><strong class="source-inline"><span class="koboSpan" id="kobo.2931.1">hosts.j2</span></strong><span class="koboSpan" id="kobo.2932.1">, in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2933.1">~/ansible/templates</span></strong><span class="koboSpan" id="kobo.2934.1"> directory. </span><span class="koboSpan" id="kobo.2934.2">Add the </span><span class="No-Break"><span class="koboSpan" id="kobo.2935.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer630">
<span class="koboSpan" id="kobo.2936.1"><img alt="Figure 17.63 – The hosts.j2 template file" src="image/B19682_17_63.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2937.1">Figure 17.63 – The hosts.j2 template file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2938.1">Here’s how the template </span><span class="No-Break"><span class="koboSpan" id="kobo.2939.1">script works:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2940.1">Adds a </span><strong class="source-inline"><span class="koboSpan" id="kobo.2941.1">localhost</span></strong><span class="koboSpan" id="kobo.2942.1"> record corresponding to the current host referenced by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2943.1">inventory_hostname</span></strong><span class="koboSpan" id="kobo.2944.1"> Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.2945.1">special variable</span></span></li>
<li><span class="koboSpan" id="kobo.2946.1">Executes a loop through all hosts in the inventory referenced by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2947.1">groups['all']</span></strong><span class="koboSpan" id="kobo.2948.1"> list (</span><span class="No-Break"><span class="koboSpan" id="kobo.2949.1">special variable)</span></span></li>
<li><span class="koboSpan" id="kobo.2950.1">Checks if the current host in the loop matches the target host, and it will only execute next if the hosts </span><span class="No-Break"><span class="koboSpan" id="kobo.2951.1">are </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2952.1">different</span></em></span></li>
<li><span class="koboSpan" id="kobo.2953.1">Adds a new host record by </span><a id="_idIndexMarker2698"/><span class="koboSpan" id="kobo.2954.1">reading the default IPv4 address (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2955.1">default_ipv4.address</span></strong><span class="koboSpan" id="kobo.2956.1">) of the current host from the related Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.2957.1">facts (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2958.1">hostvars[host].ansible_facts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2959.1">)</span></span></li>
</ul>
<ol>
<li value="2"><span class="koboSpan" id="kobo.2960.1">Now, let’s create an </span><strong class="source-inline"><span class="koboSpan" id="kobo.2961.1">update-hosts.yml</span></strong><span class="koboSpan" id="kobo.2962.1"> playbook file referencing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2963.1">hosts.j2</span></strong><span class="koboSpan" id="kobo.2964.1"> template. </span><span class="koboSpan" id="kobo.2964.2">Add the </span><span class="No-Break"><span class="koboSpan" id="kobo.2965.1">following content:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer631">
<span class="koboSpan" id="kobo.2966.1"><img alt="Figure 17.64 – The update-hosts.yml playbook file" src="image/B19682_17_64.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2967.1">Figure 17.64 – The update-hosts.yml playbook file</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2968.1">This playbook is very similar to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2969.1">update-motd.yml</span></strong><span class="koboSpan" id="kobo.2970.1">. </span><span class="koboSpan" id="kobo.2970.2">It targets</span><a id="_idIndexMarker2699"/><span class="koboSpan" id="kobo.2971.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2972.1">/</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2973.1">etc/hosts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2974.1"> file.</span></span></p>
<ol>
<li value="3"><span class="koboSpan" id="kobo.2975.1">With the playbook and template files ready, let’s run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2976.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2977.1">ansible-playbook update-hosts.yml</span></strong></pre></li> <li><span class="koboSpan" id="kobo.2978.1">After the command completes, we can check the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2979.1">/etc/hosts</span></strong><span class="koboSpan" id="kobo.2980.1"> file on any of the hosts (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2981.1">ans-web1</span></strong><span class="koboSpan" id="kobo.2982.1">) by using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2983.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2984.1">ansible ans-web1 -a "cat /etc/hosts"</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2985.1">The output shows the expected </span><span class="No-Break"><span class="koboSpan" id="kobo.2986.1">host records:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer632">
<span class="koboSpan" id="kobo.2987.1"><img alt="Figure 17.65 – The autogenerated /etc/hosts file on web1" src="image/B19682_17_65.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2988.1">Figure 17.65 – The autogenerated /etc/hosts file on web1</span></p>
<ol>
<li value="5"><span class="koboSpan" id="kobo.2989.1">You can also SSH into</span><a id="_idIndexMarker2700"/><span class="koboSpan" id="kobo.2990.1"> one of the hosts (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2991.1">ans-web1</span></strong><span class="koboSpan" id="kobo.2992.1">) and ping any of the other hosts by name (for </span><span class="No-Break"><span class="koboSpan" id="kobo.2993.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2994.1">ans-db2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2995.1">):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2996.1">ssh packt@ans-web1</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2997.1">ping ans-db2</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2998.1">You should get a successful </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2999.1">ping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3000.1"> response:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer633">
<span class="koboSpan" id="kobo.3001.1"><img alt="Figure 17.66 – Successful ping by hostname from one host to another" src="image/B19682_17_66.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3002.1">Figure 17.66 – Successful ping by hostname from one host to another</span></p>
<p><span class="koboSpan" id="kobo.3003.1">This concludes our study of Ansible templates. </span><span class="koboSpan" id="kobo.3003.2">However, the topics we covered in this section barely scratch the surface of the powerful features and versatility of Jinja2 templates. </span><span class="koboSpan" id="kobo.3003.3">We strongly encourage you to explore the related online help resources at </span><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html"><span class="koboSpan" id="kobo.3004.1">https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html</span></a><span class="koboSpan" id="kobo.3005.1">, as well as the titles mentioned in the </span><em class="italic"><span class="koboSpan" id="kobo.3006.1">Further reading</span></em><span class="koboSpan" id="kobo.3007.1"> section at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.3008.1">this chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.3009.1">Now, we will turn our attention to another essential feature of modern configuration management platforms: sharing reusable and flexible modules for a variety of system administration tasks. </span><span class="koboSpan" id="kobo.3009.2">Ansible </span><a id="_idIndexMarker2701"/><span class="koboSpan" id="kobo.3010.1">provides a highly accessible and extensible framework to accommodate this functionality – </span><strong class="bold"><span class="koboSpan" id="kobo.3011.1">Ansible roles</span></strong><span class="koboSpan" id="kobo.3012.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.3013.1">Ansible Galaxy</span></strong><span class="koboSpan" id="kobo.3014.1">. </span><span class="koboSpan" id="kobo.3014.2">In the next section, we’ll look at roles for </span><span class="No-Break"><span class="koboSpan" id="kobo.3015.1">automation reuse.</span></span></p>
<h2 id="_idParaDest-357"><a id="_idTextAnchor381"/><span class="koboSpan" id="kobo.3016.1">Creating Ansible roles</span></h2>
<p><span class="koboSpan" id="kobo.3017.1">With Ansible roles, you can bundle your automated workflows into reusable units. </span><span class="koboSpan" id="kobo.3017.2">A role is essentially a package containing </span><a id="_idIndexMarker2702"/><span class="koboSpan" id="kobo.3018.1">playbooks and other resources that have been adapted to a specific configuration using variables. </span><span class="koboSpan" id="kobo.3018.2">An arbitrary playbook would invoke a role by providing the required parameters and running it just like any other task. </span><span class="koboSpan" id="kobo.3018.3">Functionally speaking, roles encapsulate a generic configuration management behavior, making them reusable across multiple projects and even shareable </span><span class="No-Break"><span class="koboSpan" id="kobo.3019.1">with others.</span></span></p>
<p><span class="koboSpan" id="kobo.3020.1">Here are the key benefits of </span><span class="No-Break"><span class="koboSpan" id="kobo.3021.1">using roles:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.3022.1">Encapsulation functionality provides standalone packaging that can easily be shared with others. </span><span class="koboSpan" id="kobo.3022.2">Encapsulation also enables </span><strong class="bold"><span class="koboSpan" id="kobo.3023.1">separation of concerns</span></strong><span class="koboSpan" id="kobo.3024.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.3025.1">SoC</span></strong><span class="koboSpan" id="kobo.3026.1">): multiple DevOps and system </span><a id="_idIndexMarker2703"/><span class="koboSpan" id="kobo.3027.1">administrators can develop roles </span><span class="No-Break"><span class="koboSpan" id="kobo.3028.1">in parallel.</span></span></li>
<li><span class="koboSpan" id="kobo.3029.1">Roles can make larger automation projects </span><span class="No-Break"><span class="koboSpan" id="kobo.3030.1">more manageable.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.3031.1">In this section, we will describe the process of creating a role and how to use it in a sample playbook. </span><span class="koboSpan" id="kobo.3031.2">When authoring roles, we usually follow these steps </span><span class="No-Break"><span class="koboSpan" id="kobo.3032.1">and practices:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.3033.1">Create or initialize the role directory’s structure. </span><span class="koboSpan" id="kobo.3033.2">The directory contains all resources required by the role in a </span><span class="No-Break"><span class="koboSpan" id="kobo.3034.1">well-organized fashion.</span></span></li>
<li><span class="koboSpan" id="kobo.3035.1">Implement the role’s content. </span><span class="koboSpan" id="kobo.3035.2">Create related playbooks, files, templates, and </span><span class="No-Break"><span class="koboSpan" id="kobo.3036.1">so on.</span></span></li>
<li><span class="koboSpan" id="kobo.3037.1">Always start from simple to more advanced functionality. </span><span class="koboSpan" id="kobo.3037.2">Test your playbooks as you add </span><span class="No-Break"><span class="koboSpan" id="kobo.3038.1">more content.</span></span></li>
<li><span class="koboSpan" id="kobo.3039.1">Make your implementation as generic as possible. </span><span class="koboSpan" id="kobo.3039.2">Use variables to expose </span><span class="No-Break"><span class="koboSpan" id="kobo.3040.1">related customizations.</span></span></li>
<li><span class="koboSpan" id="kobo.3041.1">Don’t store secrets in your playbooks or related files. </span><span class="koboSpan" id="kobo.3041.2">Provide input parameters </span><span class="No-Break"><span class="koboSpan" id="kobo.3042.1">for them.</span></span></li>
<li><span class="koboSpan" id="kobo.3043.1">Create a dummy playbook with a simple play running your role. </span><span class="koboSpan" id="kobo.3043.2">Use this dummy playbook to test </span><span class="No-Break"><span class="koboSpan" id="kobo.3044.1">your role.</span></span></li>
<li><span class="koboSpan" id="kobo.3045.1">Design your role with user</span><a id="_idIndexMarker2704"/><span class="koboSpan" id="kobo.3046.1"> experience in mind. </span><span class="koboSpan" id="kobo.3046.2">Make it easy to use and share it with others if you think it would bring value to </span><span class="No-Break"><span class="koboSpan" id="kobo.3047.1">the community.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.3048.1">At a high level, creating a role involves the </span><span class="No-Break"><span class="koboSpan" id="kobo.3049.1">following steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3050.1">Initializing the role </span><span class="No-Break"><span class="koboSpan" id="kobo.3051.1">directory structure</span></span></li>
<li><span class="koboSpan" id="kobo.3052.1">Authoring the </span><span class="No-Break"><span class="koboSpan" id="kobo.3053.1">role’s content</span></span></li>
<li><span class="koboSpan" id="kobo.3054.1">Testing </span><span class="No-Break"><span class="koboSpan" id="kobo.3055.1">the role</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.3056.1">We’ll use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3057.1">create-users3.yml</span></strong><span class="koboSpan" id="kobo.3058.1"> playbook we created earlier in the </span><em class="italic"><span class="koboSpan" id="kobo.3059.1">Using Ansible playbooks</span></em><span class="koboSpan" id="kobo.3060.1"> section as our example for creating a role. </span><span class="koboSpan" id="kobo.3060.2">We will copy this file with a new name; </span><strong class="source-inline"><span class="koboSpan" id="kobo.3061.1">create-users-role.yml</span></strong><span class="koboSpan" id="kobo.3062.1">, for example. </span><span class="koboSpan" id="kobo.3062.2">Before proceeding with the next steps, let’s add the following line to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.3063.1">ansible.cfg</span></strong><span class="koboSpan" id="kobo.3064.1"> file (which is located inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3065.1">~/ansible</span></strong><span class="koboSpan" id="kobo.3066.1"> directory) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3067.1">[</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3068.1">defaults]</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3069.1"> section:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.3070.1">
roles_path = ~/ansible</span></pre> <p><span class="koboSpan" id="kobo.3071.1">This configuration parameter sets the default location for </span><span class="No-Break"><span class="koboSpan" id="kobo.3072.1">our roles.</span></span></p>
<p><span class="koboSpan" id="kobo.3073.1">Now, let’s start by initializing the </span><span class="No-Break"><span class="koboSpan" id="kobo.3074.1">role directory.</span></span></p>
<h4><span class="koboSpan" id="kobo.3075.1">Initializing the role directory’s structure</span></h4>
<p><span class="koboSpan" id="kobo.3076.1">Ansible has a strict requirement regarding the folder structure of the role directory. </span><span class="koboSpan" id="kobo.3076.2">The directory</span><a id="_idIndexMarker2705"/><span class="koboSpan" id="kobo.3077.1"> must have the same name as the role; for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.3078.1">create-users-role</span></strong><span class="koboSpan" id="kobo.3079.1">. </span><span class="koboSpan" id="kobo.3079.2">We can create this directory manually or by using a specialized command-line utility for managing roles, </span><span class="No-Break"><span class="koboSpan" id="kobo.3080.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3081.1">ansible-galaxy</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3082.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.3083.1">To create the skeleton of our role directory, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.3084.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.3085.1">
ansible-galaxy init create-users</span></pre> <p><span class="koboSpan" id="kobo.3086.1">The command completes with the </span><span class="No-Break"><span class="koboSpan" id="kobo.3087.1">following message:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.3088.1">
- Role create-users was created successfully</span></pre> <p><span class="koboSpan" id="kobo.3089.1">You can display the directory</span><a id="_idIndexMarker2706"/><span class="koboSpan" id="kobo.3090.1"> structure using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3091.1">tree</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3092.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.3093.1">
tree</span></pre> <p><span class="koboSpan" id="kobo.3094.1">You’ll have to manually install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3095.1">tree</span></strong><span class="koboSpan" id="kobo.3096.1"> command-line utility using your local package manager. </span><span class="koboSpan" id="kobo.3096.2">The output shows the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3097.1">create-users-role</span></strong><span class="koboSpan" id="kobo.3098.1"> directory structure of </span><span class="No-Break"><span class="koboSpan" id="kobo.3099.1">our role:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer634">
<span class="koboSpan" id="kobo.3100.1"><img alt="Figure 17.67 – The create-users-role role directory" src="image/B19682_17_67.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3101.1">Figure 17.67 – The create-users-role role directory</span></p>
<p><span class="koboSpan" id="kobo.3102.1">Here’s a brief explanation of each folder and the corresponding YAML file in </span><a id="_idIndexMarker2707"/><span class="koboSpan" id="kobo.3103.1">the </span><span class="No-Break"><span class="koboSpan" id="kobo.3104.1">role directory:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3105.1">defaults/main.yml</span></strong><span class="koboSpan" id="kobo.3106.1">: The default variables for the role. </span><span class="koboSpan" id="kobo.3106.2">They have the lowest priority among all available variables and can be overwritten by any </span><span class="No-Break"><span class="koboSpan" id="kobo.3107.1">other variable.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3108.1">files</span></strong><span class="koboSpan" id="kobo.3109.1">: The static files referenced in the </span><span class="No-Break"><span class="koboSpan" id="kobo.3110.1">role tasks.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3111.1">handlers/main.yml</span></strong><span class="koboSpan" id="kobo.3112.1">: The handlers used by the role. </span><span class="koboSpan" id="kobo.3112.2">Handlers are tasks that are triggered by other tasks. </span><span class="koboSpan" id="kobo.3112.3">You can read more about handlers </span><span class="No-Break"><span class="koboSpan" id="kobo.3113.1">at </span></span><a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_handlers.html"><span class="No-Break"><span class="koboSpan" id="kobo.3114.1">https://docs.ansible.com/ansible/latest/user_guide/playbooks_handlers.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3115.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3116.1">README.md</span></strong><span class="koboSpan" id="kobo.3117.1">: Explains the intended purpose of the role and how to </span><span class="No-Break"><span class="koboSpan" id="kobo.3118.1">use it.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3119.1">meta/main.yml</span></strong><span class="koboSpan" id="kobo.3120.1">: Additional information about the role, such as the author, licensing model, platforms, and dependencies on </span><span class="No-Break"><span class="koboSpan" id="kobo.3121.1">other roles.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3122.1">tasks/main.yml</span></strong><span class="koboSpan" id="kobo.3123.1">: The tasks played by </span><span class="No-Break"><span class="koboSpan" id="kobo.3124.1">the role.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3125.1">Templates</span></strong><span class="koboSpan" id="kobo.3126.1">: The template files</span><a id="_idIndexMarker2708"/><span class="koboSpan" id="kobo.3127.1"> referenced by </span><span class="No-Break"><span class="koboSpan" id="kobo.3128.1">the role.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3129.1">tests/test.yml</span></strong><span class="koboSpan" id="kobo.3130.1">: The playbook for testing the role. </span><span class="koboSpan" id="kobo.3130.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.3131.1">tests</span></strong><span class="koboSpan" id="kobo.3132.1"> folder may also contain a sample </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3133.1">inventory</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3134.1"> file.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.3135.1">vars/main.yml</span></strong><span class="koboSpan" id="kobo.3136.1">: The variables used internally by the role. </span><span class="koboSpan" id="kobo.3136.2">These variables have high precedence and are not meant to be changed </span><span class="No-Break"><span class="koboSpan" id="kobo.3137.1">or overwritten.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.3138.1">Now that we are familiar with the role directory and the related resource files, let’s create our </span><span class="No-Break"><span class="koboSpan" id="kobo.3139.1">first role.</span></span></p>
<h4><span class="koboSpan" id="kobo.3140.1">Authoring the role’s content</span></h4>
<p><span class="koboSpan" id="kobo.3141.1">It is a common practice to start from a previously created playbook and evolve</span><a id="_idIndexMarker2709"/><span class="koboSpan" id="kobo.3142.1"> it into a role. </span><span class="koboSpan" id="kobo.3142.2">We’ll take the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3143.1">create-users-role.yml</span></strong><span class="koboSpan" id="kobo.3144.1"> playbook. </span><span class="koboSpan" id="kobo.3144.2">Let’s refactor these files to make them </span><span class="No-Break"><span class="koboSpan" id="kobo.3145.1">more generic.</span></span></p>
<p><span class="koboSpan" id="kobo.3146.1">We will create two new files for the users and passwords, called </span><strong class="source-inline"><span class="koboSpan" id="kobo.3147.1">users-role.yml</span></strong><span class="koboSpan" id="kobo.3148.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3149.1">users_passwords-role.yml</span></strong><span class="koboSpan" id="kobo.3150.1">, inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3151.1">./create-users-role</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.3152.1">directory files:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer635">
<span class="koboSpan" id="kobo.3153.1"><img alt="Figure 17.68 – The users-role.yml and users_passwords-role.yml files" src="image/B19682_17_68.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3154.1">Figure 17.68 – The users-role.yml and users_passwords-role.yml files</span></p>
<p><span class="koboSpan" id="kobo.3155.1">As you may have noticed, we renamed the example user accounts and gave them more generic names. </span><span class="koboSpan" id="kobo.3155.2">We also changed the </span><a id="_idIndexMarker2710"/><span class="koboSpan" id="kobo.3156.1">user dictionary key name from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3157.1">webusers</span></strong><span class="koboSpan" id="kobo.3158.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.3159.1">list</span></strong><span class="koboSpan" id="kobo.3160.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3161.1">users-role.yml</span></strong><span class="koboSpan" id="kobo.3162.1"> file. </span><span class="koboSpan" id="kobo.3162.2">Remember that Ansible requires root-level dictionary entries (key-value pairs) in YAML files that </span><span class="No-Break"><span class="koboSpan" id="kobo.3163.1">provide variables.</span></span></p>
<p><span class="koboSpan" id="kobo.3164.1">Let’s look at the updated </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3165.1">create-users-role.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3166.1"> playbook:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer636">
<span class="koboSpan" id="kobo.3167.1"><img alt="Figure 17.69 – The modified create-users-role.yml file" src="image/B19682_17_69.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3168.1">Figure 17.69 – The modified create-users-role.yml file</span></p>
<p><span class="koboSpan" id="kobo.3169.1">We made the </span><span class="No-Break"><span class="koboSpan" id="kobo.3170.1">following modifications:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.3171.1">We readjusted the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3172.1">loop</span></strong><span class="koboSpan" id="kobo.3173.1"> directive to read </span><strong class="source-inline"><span class="koboSpan" id="kobo.3174.1">users.list</span></strong><span class="koboSpan" id="kobo.3175.1"> instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3176.1">users.webusers</span></strong><span class="koboSpan" id="kobo.3177.1"> due to the</span><a id="_idIndexMarker2711"/><span class="koboSpan" id="kobo.3178.1"> name change of the related dictionary key in the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3179.1">users.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3180.1"> file</span></span></li>
<li><span class="koboSpan" id="kobo.3181.1">We refactored the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3182.1">include_vars</span></strong><span class="koboSpan" id="kobo.3183.1"> file references to use variables instead of </span><span class="No-Break"><span class="koboSpan" id="kobo.3184.1">hardcoded filenames</span></span></li>
<li><span class="koboSpan" id="kobo.3185.1">We added a </span><strong class="source-inline"><span class="koboSpan" id="kobo.3186.1">vars</span></strong><span class="koboSpan" id="kobo.3187.1"> section, with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3188.1">users_file</span></strong><span class="koboSpan" id="kobo.3189.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3190.1">passwords_file</span></strong><span class="koboSpan" id="kobo.3191.1"> variables pointing to the corresponding </span><span class="No-Break"><span class="koboSpan" id="kobo.3192.1">YAML files</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.3193.1">With these changes in the playbook, we’re now ready to implement our role. </span><span class="koboSpan" id="kobo.3193.2">Looking at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3194.1">create-users-role</span></strong><span class="koboSpan" id="kobo.3195.1"> role directory, we’ll do </span><span class="No-Break"><span class="koboSpan" id="kobo.3196.1">the following:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3197.1">Copy/paste the variables in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3198.1">vars</span></strong><span class="koboSpan" id="kobo.3199.1"> section of </span><strong class="source-inline"><span class="koboSpan" id="kobo.3200.1">create-users-role.yml</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.3201.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3202.1">defaults/main.yml</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3203.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.3204.1">Copy/paste the tasks from </span><strong class="source-inline"><span class="koboSpan" id="kobo.3205.1">create-users-role.yml</span></strong><span class="koboSpan" id="kobo.3206.1"> into </span><strong class="source-inline"><span class="koboSpan" id="kobo.3207.1">tasks/main.yml</span></strong><span class="koboSpan" id="kobo.3208.1">. </span><span class="koboSpan" id="kobo.3208.2">Make sure you keep the </span><span class="No-Break"><span class="koboSpan" id="kobo.3209.1">relative indentations.</span></span></li>
<li><span class="koboSpan" id="kobo.3210.1">Create a simple playbook using the role. </span><span class="koboSpan" id="kobo.3210.2">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3211.1">tests/test.yml</span></strong><span class="koboSpan" id="kobo.3212.1"> file for your test playbook. </span><span class="koboSpan" id="kobo.3212.2">Copy/move </span><strong class="source-inline"><span class="koboSpan" id="kobo.3213.1">users-role.yml</span></strong><span class="koboSpan" id="kobo.3214.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3215.1">users_passwords-role.yml</span></strong><span class="koboSpan" id="kobo.3216.1"> to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3217.1">tests/</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3218.1"> folder.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.3219.1">The following screenshot captures all </span><span class="No-Break"><span class="koboSpan" id="kobo.3220.1">these changes:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer637">
<span class="koboSpan" id="kobo.3221.1"><img alt="Figure 17.70 – The files that we changed in the create-users role directory" src="image/B19682_17_70.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3222.1">Figure 17.70 – The files that we changed in the create-users role directory</span></p>
<p><span class="koboSpan" id="kobo.3223.1">We also recommend updating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3224.1">README.md</span></strong><span class="koboSpan" id="kobo.3225.1"> file in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3226.1">create-users-role</span></strong><span class="koboSpan" id="kobo.3227.1"> directory with notes about the purpose and usage of the role. </span><span class="koboSpan" id="kobo.3227.2">You should also mention the requirement of having</span><a id="_idIndexMarker2712"/><span class="koboSpan" id="kobo.3228.1"> the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3229.1">users-role.yml</span></strong><span class="koboSpan" id="kobo.3230.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3231.1">users_passwords-role.yml</span></strong><span class="koboSpan" id="kobo.3232.1"> files with the related data structures. </span><span class="koboSpan" id="kobo.3232.2">The names of these files can be changed via the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3233.1">users_file</span></strong><span class="koboSpan" id="kobo.3234.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.3235.1">passwords_file</span></strong><span class="koboSpan" id="kobo.3236.1"> variables in </span><strong class="source-inline"><span class="koboSpan" id="kobo.3237.1">defaults/main.yml</span></strong><span class="koboSpan" id="kobo.3238.1">. </span><span class="koboSpan" id="kobo.3238.2">You can also provide some examples of how to use the</span><a id="_idIndexMarker2713"/><span class="koboSpan" id="kobo.3239.1"> role. </span><span class="koboSpan" id="kobo.3239.2">We also created an additional </span><strong class="source-inline"><span class="koboSpan" id="kobo.3240.1">test2.yml</span></strong><span class="koboSpan" id="kobo.3241.1"> playbook using a task to run </span><span class="No-Break"><span class="koboSpan" id="kobo.3242.1">the role:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer638">
<span class="koboSpan" id="kobo.3243.1"><img alt="Figure 17.71 – Running a role using a task" src="image/B19682_17_71.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.3244.1">Figure 17.71 – Running a role using a task</span></p>
<p><span class="koboSpan" id="kobo.3245.1">At this point, we’ve finished </span><a id="_idIndexMarker2714"/><span class="koboSpan" id="kobo.3246.1">making the required changes for implementing the role. </span><span class="koboSpan" id="kobo.3246.2">You may choose to remove all empty or unused folders in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3247.1">create-users-role</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.3248.1">role directory.</span></span></p>
<p><span class="koboSpan" id="kobo.3249.1">Now, let’s test </span><span class="No-Break"><span class="koboSpan" id="kobo.3250.1">our role.</span></span></p>
<h4><span class="koboSpan" id="kobo.3251.1">Testing the role</span></h4>
<p><span class="koboSpan" id="kobo.3252.1">To test our role, we will use the playbooks in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3253.1">tests/</span></strong><span class="koboSpan" id="kobo.3254.1"> folder and run them with the </span><span class="No-Break"><span class="koboSpan" id="kobo.3255.1">following </span></span><span class="No-Break"><a id="_idIndexMarker2715"/></span><span class="No-Break"><span class="koboSpan" id="kobo.3256.1">commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.3257.1">
ansible-playbook create-users/tests/test.yml
ansible-playbook create-users/tests/test2.yml</span></pre> <p><span class="koboSpan" id="kobo.3258.1">Both commands should </span><span class="No-Break"><span class="koboSpan" id="kobo.3259.1">complete successfully.</span></span></p>
<p><span class="koboSpan" id="kobo.3260.1">With that, we’ve </span><a id="_idIndexMarker2716"/><span class="koboSpan" id="kobo.3261.1">provided an exploratory view of Ansible roles, as they are a powerful feature of Ansible, and they enable modern system administrators and DevOps to move quickly from concept to implementation, accelerating the deployment of everyday configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.3262.1">management workflows.</span></span></p>
<h1 id="_idParaDest-358"><a id="_idTextAnchor382"/><span class="koboSpan" id="kobo.3263.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.3264.1">In this chapter, we covered significant ground in terms of Ansible. </span><span class="koboSpan" id="kobo.3264.2">Due to this chapter’s limited scope, we couldn’t capture all of Ansible’s vast number of features. </span><span class="koboSpan" id="kobo.3264.3">However, we tried to provide an overarching view of the platform, from Ansible’s architectural principles to configuring and working with ad hoc commands and playbooks. </span><span class="koboSpan" id="kobo.3264.4">You learned how to set up an Ansible environment, with several managed hosts and a control node, thereby emulating a real-world deployment at a high level. </span><span class="koboSpan" id="kobo.3264.5">You also became familiar with writing Ansible commands and scripts for typical configuration management tasks. </span><span class="koboSpan" id="kobo.3264.6">Most of the commands and playbooks presented throughout this chapter closely resemble everyday </span><span class="No-Break"><span class="koboSpan" id="kobo.3265.1">administrative operations.</span></span></p>
<p><span class="koboSpan" id="kobo.3266.1">Whether you are a systems administrator or a DevOps engineer, a seasoned professional, or on the way to becoming one, we hope this chapter brought new insights to your everyday Linux administration tasks and automation workflows. </span><span class="koboSpan" id="kobo.3266.2">The tools and techniques you’ve learned here will give you a good start for scripting and automating larger portions of your daily </span><span class="No-Break"><span class="koboSpan" id="kobo.3267.1">administrative routines.</span></span></p>
<p><span class="koboSpan" id="kobo.3268.1">The same closing thoughts also apply to this book in general. </span><span class="koboSpan" id="kobo.3268.2">You have come a long way in terms of learning and mastering some of the most typical Linux administration tasks in on-premises and cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.3269.1">environments alike.</span></span></p>
<p><span class="koboSpan" id="kobo.3270.1">We hope that you have enjoyed our </span><span class="No-Break"><span class="koboSpan" id="kobo.3271.1">journey together.</span></span></p>
<h1 id="_idParaDest-359"><a id="_idTextAnchor383"/><span class="koboSpan" id="kobo.3272.1">Questions</span></h1>
<p><span class="koboSpan" id="kobo.3273.1">Let’s try to wrap up some of the essential concepts we learned about in this chapter by completing the </span><span class="No-Break"><span class="koboSpan" id="kobo.3274.1">following quiz:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.3275.1">What are idempotent operations or commands </span><span class="No-Break"><span class="koboSpan" id="kobo.3276.1">in Ansible?</span></span></li>
<li><span class="koboSpan" id="kobo.3277.1">You want to set up passwordless authentication with your managed hosts. </span><span class="koboSpan" id="kobo.3277.2">What steps should </span><span class="No-Break"><span class="koboSpan" id="kobo.3278.1">you follow?</span></span></li>
<li><span class="koboSpan" id="kobo.3279.1">What is the ad hoc command for checking communication with all your </span><span class="No-Break"><span class="koboSpan" id="kobo.3280.1">managed hosts?</span></span></li>
<li><span class="koboSpan" id="kobo.3281.1">Enumerate a few Ansible modules. </span><span class="koboSpan" id="kobo.3281.2">Try to think of a configuration management scenario where you could use </span><span class="No-Break"><span class="koboSpan" id="kobo.3282.1">each module.</span></span></li>
<li><span class="koboSpan" id="kobo.3283.1">Think of a simple playbook that monitors the memory that’s available on your hosts and will notify you if that memory is above a </span><span class="No-Break"><span class="koboSpan" id="kobo.3284.1">given threshold.</span></span></li>
</ol>
<h1 id="_idParaDest-360"><a id="_idTextAnchor384"/><span class="koboSpan" id="kobo.3285.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.3286.1">Here are a few resources we found helpful for learning more about </span><span class="No-Break"><span class="koboSpan" id="kobo.3287.1">Ansible internals:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.3288.1">Ansible </span><span class="No-Break"><span class="koboSpan" id="kobo.3289.1">documentation: </span></span><a href="https://docs.ansible.com/"><span class="No-Break"><span class="koboSpan" id="kobo.3290.1">https://docs.ansible.com/</span></span></a></li>
<li><span class="koboSpan" id="kobo.3291.1">Ansible use cases, by Red </span><span class="No-Break"><span class="koboSpan" id="kobo.3292.1">Hat: </span></span><a href="https://www.ansible.com/use-cases"><span class="No-Break"><span class="koboSpan" id="kobo.3293.1">https://www.ansible.com/use-cases</span></span></a></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3294.1">Dive into Ansible – From Beginner to Expert in Ansible</span></em><span class="koboSpan" id="kobo.3295.1"> [Video], by James Spurin, Packt </span><span class="No-Break"><span class="koboSpan" id="kobo.3296.1">Publishing (</span></span><a href="https://www.packtpub.com/product/dive-into-ansible-from-beginner-to-expert-in-ansible-video/9781801076937"><span class="No-Break"><span class="koboSpan" id="kobo.3297.1">https://www.packtpub.com/product/dive-into-ansible-from-beginner-to-expert-in-ansible-video/9781801076937</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3298.1">)</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3299.1">Practical Ansible 2</span></em><span class="koboSpan" id="kobo.3300.1">, by Daniel Oh, James Freeman, Fabio Alessandro Locati, Packt </span><span class="No-Break"><span class="koboSpan" id="kobo.3301.1">Publishing (</span></span><a href="https://www.packtpub.com/product/practical-ansible-2/9781789807462"><span class="No-Break"><span class="koboSpan" id="kobo.3302.1">https://www.packtpub.com/product/practical-ansible-2/9781789807462</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.3303.1">)</span></span></li>
</ul>
</div>
</body></html>