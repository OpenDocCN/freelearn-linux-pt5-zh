<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch04" class="calibre1"/>Chapter 4. Zones</h1></div></div></div><p class="calibre7">In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Creating, administering, and using a virtual network in a zone</li><li class="listitem">Managing a zone using the resource manager</li><li class="listitem">Implementing a flow control</li><li class="listitem">Working with migrations from physical Oracle Solaris 10 hosts to Oracle Solaris 11 Zones</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch04lvl1sec56" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">Oracle Solaris 11 Zones is a great framework that virtualizes and consolidates a system environment where there are many applications and physical machines running Oracle Solaris. Using a rough <a id="id603" class="calibre1"/>comparison, Oracle Solaris 11 zone is similar to other virtualization options offered by VMware ESX, Linux LXC, and FreeBSD Jails but presents some important differences such as not allowing either to perform a hardware emulation or run any other kind of operating system except Oracle Solaris 11 or prior Oracle Solaris versions.</p><p class="calibre7">In Oracle Solaris<a id="id604" class="calibre1"/> Zones, the fundamental idea is to create different small operating system installations (children) inside the main operating system (parent) by sharing or dividing (using the resource manager) the existing resources between these children installations. Each installation will have its own init files and processes, although it shares the kernel with the parent operating system, resulting in a lesser overhead than previously quoted solutions. Using the Oracle Solaris 11 terms, the parent is the global zone and children are non-global zones, as we'll see later.</p><p class="calibre7">Oracle Solaris zone offers application isolation, additional tiers of security, and reduced power requirements. This concern with security is necessary in order to prevent an application running inside a zone from crashing other applications in other zones. This is the reason why a non-global zone does not view other non-global zones, can contain additional software packages, and has a different product database that controls its own installed software.</p><p class="calibre7">Going into details of the<a id="id605" class="calibre1"/> previously mentioned features, zones make it possible for many applications to share host resources, therefore decreasing the cost of a deployment. This resource management allows us to assign specific resources to a non-global zone in order to create a limit of resource consumption (for example, CPU and memory) and to control how many resources will be used by a process, task, or project. Moreover, this resource control takes advantage of an available Oracle Solaris scheduler class <strong class="calibre8">fair share scheduler</strong> (<strong class="calibre8">FSS</strong>) in<a id="id606" class="calibre1"/> order to impose control over the CPU (using shares) and memory (using the <code class="email">rcapd</code> daemon that limits the amount of physical memory) in a non-global zone.</p><p class="calibre7">Zone was introduced in Oracle Solaris Version 10, and it can be classified as the global zone (the physical machine installation that was presented as a parent previously) and non-global zone (informally named as <em class="calibre11">local zone</em> or just <em class="calibre11">zone</em>, which was presented as a child) where any application can be installed and administered and the right resource configuration can be performed.</p><p class="calibre7">The global<a id="id607" class="calibre1"/> zone (the parent zone) is a bootable<a id="id608" class="calibre1"/> zone that comes directly from the physical hardware, and it makes it possible to configure, install, administer, and remove <a id="id609" class="calibre1"/>non-global<a id="id610" class="calibre1"/> zones (children zones), given that it is also the only zone that is aware of all of the existing zones. Usually, non-global zones run the same operating system as the global zone, but Oracle Solaris 11 provides another zone type, named <a id="id611" class="calibre1"/>
<strong class="calibre8">branded zone</strong>, which makes<a id="id612" class="calibre1"/> it feasible to create and install a non-global zone that runs Oracle Solaris 10, for example.</p><p class="calibre7">Briefly, during a non-global zone installation, it's requested to provide as input the directory where the zone will be installed, the network interface, and network information such as IP address and network mask. Additionally, it is also requested to provide the IP-type to be used with the network interface in the non-global zone. There are two <a id="id613" class="calibre1"/>options: shared-IP (used when the network interface is shared with the global zone) and<a id="id614" class="calibre1"/> exclusive-IP (used when the network interface is dedicated to the non-global zone).</p><p class="calibre7">Once the zone configuration is complete, the next step is to install the zone and administer it. It is advisable to know that non-global zones can have the following zone states:</p><div><ul class="itemizedlist"><li class="listitem"><strong class="calibre8">undefined</strong>: This denotes whether<a id="id615" class="calibre1"/> the zone configuration<a id="id616" class="calibre1"/> is incomplete or deleted</li><li class="listitem"><strong class="calibre8">incomplete</strong>: This denotes that the <a id="id617" class="calibre1"/>zone installation <a id="id618" class="calibre1"/>was aborted in between</li><li class="listitem"><strong class="calibre8">configured</strong>: This denotes<a id="id619" class="calibre1"/> whether the zone<a id="id620" class="calibre1"/> configuration is complete</li><li class="listitem"><strong class="calibre8">installed</strong>: This denotes that the <a id="id621" class="calibre1"/>zone packages and<a id="id622" class="calibre1"/> operating system were installed</li><li class="listitem"><strong class="calibre8">ready</strong>: This denotes the almost-running<a id="id623" class="calibre1"/> zone with an<a id="id624" class="calibre1"/> associated zone ID</li><li class="listitem"><strong class="calibre8">running</strong>: This denotes that<a id="id625" class="calibre1"/> everything is <a id="id626" class="calibre1"/>working and getting executed</li><li class="listitem"><strong class="calibre8">down</strong>: This denotes that<a id="id627" class="calibre1"/> the zone is<a id="id628" class="calibre1"/> halted</li></ul></div><p class="calibre7">Honestly, on a daily basis, the more typical states are <code class="email">configured</code>, <code class="email">installed</code>, <code class="email">running</code>, and <code class="email">down</code>. The remaining states are transient states and we rarely have to be concerned about them.</p><p class="calibre7">Therefore, the sequence of states is <code class="email">undefined</code> | <code class="email">configured</code> | <code class="email">incomplete</code> | <code class="email">installed</code> | <code class="email">ready</code> | <code class="email">running</code> | <code class="email">down</code>.</p><p class="calibre7">There are professionals who usually ask me, "What are the differences between Oracle Solaris 11 and Oracle Solaris 10?" Truly, there are some relevant differences. Now, the <code class="email">var</code> directory is a<a id="id629" class="calibre1"/> separated filesystem, the default zone brand is Solaris (previously, it was native), there is no concept of sparse zones anymore, and the default filesystem is ZFS and uses IPS as package manager. However, the most important zone difference in Oracle Solaris 11 is the introduction of network virtualization, which allows us to control the network zone resources using at least a network interface—<strong class="calibre8">virtual network interfaces</strong> (<strong class="calibre8">VNICs</strong>)—and <a id="id630" class="calibre1"/>virtual switch concepts. For example, a physical machine could have Oracle Solaris 11 running in a global zone and five non-global zones (z1, z2, z3, z4, and z5), each of them with a dedicated VNIC connected to a virtual switch (<code class="email">etherstub</code>) with the last one connected to the real network interface card. Additionally, the network flow control can be enforced and specific link properties can be configured to increase the bandwidth control and efficiency as well, which makes it possible to share a network resource across different VNICs.</p><p class="calibre7">The possible network flow can be created on a per-VNIC basis with specific attributes, isolating and classifying similar packets and with associated bound resources. Possible flow attributes include <code class="email">maxbw</code> (which defines the bandwidth of the flow) and priority (which defines the packet priority in a flow as low, medium, and high).</p><p class="calibre7">All resource controls<a id="id631" class="calibre1"/> mentioned so far (CPU, memory, and network) are disabled by default, and they are controlled by two resource services: the default resource pool service (<code class="email">svc:/system/pools:default</code>) and dynamic resource pool service (<code class="email">svc:/system/pools/dynamic:default</code>). A configuration file named <code class="email">pooladm.conf</code> under <code class="email">etc</code> helps us define the pool creation and the resource management behavior, as it is used by a daemon named <code class="email">poold</code> that controls the entire allocation controls and limits after associating the created pool with a non-global zone.</p><p class="calibre7">Now, we are ready to learn about the next recipes on Oracle Solaris 11 Zones.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec57" class="calibre1"/>Creating, administering, and using a virtual network in a zone</h1></div></div></div><p class="calibre7">I love this recipe because <a id="id632" class="calibre1"/>here, we are going to use the main <a id="id633" class="calibre1"/>feature of zones in Oracle Solaris 11 virtual networks. Concisely, we are going to create and<a id="id634" class="calibre1"/> configure the<a id="id635" class="calibre1"/> following scenario:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">zone1</code> | <code class="email">vnic1</code> (<code class="email">192.168.1.51</code>) | <code class="email">vswitch1</code> (<code class="email">etherstub</code>) | <code class="email">net0</code> (<code class="email">192.168.1.144</code>)</li><li class="listitem"><code class="email">zone2</code> | <code class="email">vnic2</code> (<code class="email">192.168.1.52</code>) | <code class="email">vswitch1</code> (<code class="email">etherstub</code>) | <code class="email">net0</code> (<code class="email">192.168.1.144</code>)</li></ul></div><p class="calibre7">Each zone connects to its<a id="id636" class="calibre1"/> respective <strong class="calibre8">virtual network interface</strong> (<strong class="calibre8">VNIC</strong>), and both VNICs go to the same <code class="email">etherstub</code> (a kind of a virtual switch). Because<a id="id637" class="calibre1"/> of this, <code class="email">etherstub</code> requires a virtual interface (<code class="email">vnic0</code>). Finally, <code class="email">etherstub</code> connects to a real interface (<code class="email">net0</code>). The zonepath<a id="id638" class="calibre1"/> property for each zone and other properties are as follows:</p><div><ul class="itemizedlist"><li class="listitem">zonepath zone1: <code class="email">/myzones/zone1</code></li><li class="listitem">zonepath zone2: <code class="email">/myzones/zone2</code></li><li class="listitem">IP type: exclusive-IP</li></ul></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec88" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual machine (VirtualBox or VMware) that runs Oracle Solaris 11, with 4 GB (minimum) or 8 GB RAM (recommended), an extra disk with 80 GB, and a processor with two or more cores configured for this virtual machine, as shown in the following screenshot that was extracted from my VirtualBox environment:</p><div><img src="img/00022.jpeg" alt="Getting ready" class="calibre12"/></div><p class="calibre13"> </p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec89" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">To<a id="id639" class="calibre1"/> start the procedure, we <a id="id640" class="calibre1"/>have to gather all current and relevant<a id="id641" class="calibre1"/> information <a id="id642" class="calibre1"/>about the system by <a id="id643" class="calibre1"/>running the following <a id="id644" class="calibre1"/>command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dladm show-link</strong>
LINK                CLASS     MTU    STATE    OVER
net1                phys      1500   up       --
net0                phys      1500   up       --
root@solaris11-1:~# <strong class="calibre8">ipadm show-if</strong>
IFNAME     CLASS    STATE    ACTIVE OVER
lo0        loopback ok       yes    --
net0       ip       ok       yes    --
net1       ip       ok       yes    --
root@solaris11-1:~# <strong class="calibre8">ipadm show-addr</strong>
ADDROBJ           TYPE     STATE        ADDR
lo0/v4            static   ok           127.0.0.1/8
net0/v4           static   ok           192.168.1.144/24
net1/v4           static   ok           192.168.5.77/24
lo0/v6            static   ok           ::1/128
root@solaris11-1:~# <strong class="calibre8">zpool list</strong>
NAME      SIZE  ALLOC   FREE  CAP  DEDUP  HEALTH  ALTROOT
myzones  79.5G   544K  79.5G   0%  1.00x  ONLINE  -
rpool    79.5G  21.2G  58.3G  26%  1.00x  ONLINE  -
root@solaris11-1:~# <strong class="calibre8">zfs list | grep myzones</strong>
myzones                  494K  78.3G    31K  /myzones
root@solaris11-1:~# </pre></div><p class="calibre7">The system has two<a id="id645" class="calibre1"/> network interfaces (<code class="email">net0</code> and <code class="email">net1</code>), but only <code class="email">net0</code> will be considered. Additionally, the pool (<code class="email">myzones</code>) has almost 80 GB free space (you can create the myzones pool using <code class="email">zpool create myzones &lt;disk&gt;</code>), and there is no filesystem<a id="id646" class="calibre1"/> under it. Then, the<a id="id647" class="calibre1"/> first step is to<a id="id648" class="calibre1"/> create the pool and one<a id="id649" class="calibre1"/> filesystem for each zone (<code class="email">zone1</code> and <code class="email">zone2</code>) by running the<a id="id650" class="calibre1"/> following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zpool create myzones c7t2d0</strong>
root@solaris11-1:~# <strong class="calibre8">zfs create myzones/zone1</strong>
root@solaris11-1:~# <strong class="calibre8">zfs list myzones/zone1</strong>
root@solaris11-1:/myzones# <strong class="calibre8">zfs create myzones/zone1</strong>
root@solaris11-1:/myzones# <strong class="calibre8">zfs create myzones/zone2</strong>
root@solaris11-1:/myzones# <strong class="calibre8">zfs list | grep zone</strong>
myzones                  314K  78.3G    33K  /myzones
myzones/zone1             31K  78.3G    31K  /myzones/zone1
myzones/zone2             31K  78.3G    31K  /myzones/zone2</pre></div><p class="calibre7">The storage requirements have been met and now, the next important part of this recipe is to prepare all network infrastructures. To accomplish this task, it will be necessary to create <code class="email">etherstub</code> (<code class="email">vswitch1</code>) and three VNICs: <code class="email">vnic0</code> (<code class="email">etherstub</code>), <code class="email">vnic1</code> (<code class="email">zone1</code>), and <code class="email">vnic2</code> (<code class="email">zone2</code>). Moreover, we have to connect all VNICs into <code class="email">etherstub</code> (<code class="email">vswitch1</code>). All these tasks are accomplished by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dladm create-etherstub vswitch1</strong>
root@solaris11-1:~# <strong class="calibre8">dladm show-link</strong>
LINK                CLASS     MTU    STATE    OVER
net1                phys      1500   up       --
net0                phys      1500   up       --
vswitch1            etherstub 9000   unknown  --
root@solaris11-1:~# <strong class="calibre8">dladm create-vnic -l vswitch1 vnic0</strong>
root@solaris11-1:~# <strong class="calibre8">dladm create-vnic -l vswitch1 vnic1</strong>
root@solaris11-1:~# <strong class="calibre8">dladm create-vnic -l vswitch1 vnic2</strong>
root@solaris11-1:~# <strong class="calibre8">dladm show-link</strong>
LINK                CLASS     MTU    STATE    OVER
net1                phys      1500   up       --
net0                phys      1500   up       --
vswitch1            etherstub 9000   unknown  --
vnic0               vnic      9000   up       vswitch1
vnic1               vnic      9000   up       vswitch1
vnic2               vnic      9000   up       vswitch1
root@solaris11-1:~# <strong class="calibre8">dladm show-vnic</strong>
LINK          OVER         SPEED  MACADDRESS        MACADDRTYPE   VID
vnic0         vswitch1     40000  2:8:20:d:b:3b     random        0
vnic1         vswitch1     40000  2:8:20:ef:b6:63   random        0
vnic2         vswitch1     40000  2:8:20:ce:b0:da   random        0</pre></div><p class="calibre7">Now, it's time<a id="id651" class="calibre1"/> to<a id="id652" class="calibre1"/> create the<a id="id653" class="calibre1"/> first zone (<code class="email">zone1</code>) using <code class="email">ip-type=exclusive</code> (this is the default value) and <code class="email">vnic1</code> as<a id="id654" class="calibre1"/> a physical<a id="id655" class="calibre1"/> network<a id="id656" class="calibre1"/> interface:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
Use 'create' to begin configuring a new zone.
zonecfg:zone1&gt; <strong class="calibre8">create</strong>
create: Using system default template 'SYSdefault'
zonecfg:zone1&gt; <strong class="calibre8">set autoboot=true</strong>
zonecfg:zone1&gt; <strong class="calibre8">set zonepath=/myzones/zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">add net</strong>
zonecfg:zone1:net&gt; <strong class="calibre8">set physical=vnic1</strong>
zonecfg:zone1:net&gt; <strong class="calibre8">end</strong>
zonecfg:zone1&gt; <strong class="calibre8">info</strong>
zonename: zone1
zonepath: /myzones/zone1
brand: solaris
autoboot: true
bootargs: 
file-mac-profile: 
pool: 
limitpriv: 
scheduling-class: 
<strong class="calibre8">ip-type: exclusive</strong>
hostid: 
fs-allowed: 
net:
  address not specified
  allowed-address not specified
  configure-allowed-address: true
  physical: vnic1
  defrouter not specified
anet:
  linkname: net0
  lower-link: auto
 allowed-address not specified
  configure-allowed-address: true
  defrouter not specified
  allowed-dhcp-cids not specified
  link-protection: mac-nospoof
  mac-address: random
  mac-prefix not specified
  mac-slot not specified
  vlan-id not specified
  priority not specified
  rxrings not specified
  txrings not specified
  mtu not specified
  maxbw not specified
  rxfanout not specified
  vsi-typeid not specified
  vsi-vers not specified
  vsi-mgrid not specified
  etsbw-lcl not specified
  cos not specified
  pkey not specified
  linkmode not specified
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~#</pre></div><p class="calibre7">To<a id="id657" class="calibre1"/> configure <code class="email">zone2</code>, almost the<a id="id658" class="calibre1"/> same steps (the zone info details were <a id="id659" class="calibre1"/>omitted) need<a id="id660" class="calibre1"/> to be followed by<a id="id661" class="calibre1"/> running the following<a id="id662" class="calibre1"/> command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone2</strong>
Use 'create' to begin configuring a new zone.
zonecfg:zone2&gt; <strong class="calibre8">create</strong>
create: Using system default template 'SYSdefault'
zonecfg:zone2&gt; <strong class="calibre8">set autoboot=true</strong>
zonecfg:zone2&gt; <strong class="calibre8">set zonepath=/myzones/zone2</strong>
zonecfg:zone2&gt; <strong class="calibre8">add net</strong>
zonecfg:zone2:net&gt; <strong class="calibre8">set physical=vnic2</strong>
zonecfg:zone2:net&gt; <strong class="calibre8">end</strong>
zonecfg:zone2&gt; <strong class="calibre8">verify</strong>
zonecfg:zone2&gt; <strong class="calibre8">commit</strong>
zonecfg:zone2&gt; <strong class="calibre8">exit</strong>
</pre></div><p class="calibre7">To list the<a id="id663" class="calibre1"/> recently configured zones, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm list -cv</strong>
ID NAME           STATUS     PATH                     BRAND    IP    
 0 global         running    /                        solaris  shared
 - zone1          configured /myzones/zone1           solaris  excl  
 - zone2          configured /myzones/zone2           solaris  excl  </pre></div><p class="calibre7">According to<a id="id664" class="calibre1"/> the previous recipe, during the first login that happens soon after installing the zone, it is required to provide interactively the system configuration information<a id="id665" class="calibre1"/> through eleven screens. To<a id="id666" class="calibre1"/> automate and make this simpler, it is feasible to create a system configuration file for each zone and provide it during each zone installation. To accomplish<a id="id667" class="calibre1"/> this task, some<a id="id668" class="calibre1"/> information will be asked from it:</p><p class="calibre7">For <code class="email">zone1</code>, the information is as follows:</p><div><ul class="itemizedlist"><li class="listitem">Computer name: <code class="email">zone1</code></li><li class="listitem">Ethernet network configuration: <code class="email">Manually</code></li><li class="listitem">Network interface: <code class="email">vnic1</code></li><li class="listitem">IP address: <code class="email">192.168.1.51</code></li><li class="listitem">DNS: <code class="email">Do not configure DNS</code></li><li class="listitem">Alternate name server: <code class="email">None</code></li><li class="listitem">Time zone: <code class="email">(your time zone)</code></li><li class="listitem">Date and time: <code class="email">(your current date and time)</code></li><li class="listitem">Root password: <code class="email">(your choice)</code></li><li class="listitem">Your real name: <code class="email">Alexandre Borges</code></li><li class="listitem">Username: <code class="email">aborges1</code></li><li class="listitem">Password: <code class="email">hacker123!</code></li><li class="listitem">E-mail: <code class="email">anonymous@oracle.com</code></li><li class="listitem">Internet access method: <code class="email">No proxy</code></li></ul></div><p class="calibre7">For <code class="email">zone2</code>, the information is as follows:</p><div><ul class="itemizedlist"><li class="listitem">Computer name: <code class="email">zone2</code></li><li class="listitem">Ethernet network configuration: <code class="email">Manually</code></li><li class="listitem">Network interface: <code class="email">vnic2</code></li><li class="listitem">IP address: <code class="email">192.168.1.52</code></li><li class="listitem">DNS: <code class="email">Do not configure DNS</code></li><li class="listitem">Alternate name server: <code class="email">None</code></li><li class="listitem">Time zone: <code class="email">(your time zone)</code></li><li class="listitem">Date and time: <code class="email">(your current date and time)</code></li><li class="listitem">Root password: <code class="email">(your choice)</code></li><li class="listitem">Your real name: <code class="email">Alexandre Borges</code></li><li class="listitem">Username: <code class="email">aborges2</code></li><li class="listitem">Password: <code class="email">hacker123!</code></li><li class="listitem">E-mail: <code class="email">anonymous@oracle.com</code></li><li class="listitem">Internet access method: <code class="email">No proxy</code></li></ul></div><p class="calibre7">Create<a id="id669" class="calibre1"/> a directory<a id="id670" class="calibre1"/> that will hold<a id="id671" class="calibre1"/> the zone profiles as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">mkdir /zone_profiles</strong>
</pre></div><p class="calibre7">Create a<a id="id672" class="calibre1"/> profile to <code class="email">zone1</code> by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">sysconfig create-profile -o /zone_profiles/zone1.xml</strong>
</pre></div><p class="calibre7">By using the almost the same command, create a<a id="id673" class="calibre1"/> profile to <code class="email">zone2</code> by<a id="id674" class="calibre1"/> running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">sysconfig create-profile -o /zone_profiles/zone2.xml</strong>
</pre></div><p class="calibre7">To visualize the system configuration content, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">more /zone_profiles/zone1.xml</strong> 
&lt;!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1"&gt;
&lt;service_bundle type="profile" name="sysconfig"&gt;
  &lt;service version="1" type="service" name="system/config-user"&gt;
    &lt;instance enabled="true" name="default"&gt;
      &lt;property_group type="application" name="root_account"&gt;
        &lt;propval type="astring" name="login" value="root"/&gt;
        &lt;propval type="astring" name="password" value="$5$Iabvrv4s$wAqPBNvP7QBZ12ocIdDp/TzNP8Gyv5PBvkTk1QTUEeA"/&gt;
        &lt;propval type="astring" name="type" value="role"/&gt;
      &lt;/property_group&gt;
      &lt;property_group type="application" name="user_account"&gt;
        &lt;propval type="astring" name="login" value="aborges1"/&gt;
        &lt;propval type="astring" name="password" value="$5$XfpOXWq9$1roklDSW7LW1Iq0pdpxq5Js16/d4DszHHlZB2AvYRL7"/&gt;
        &lt;propval type="astring" name="type" value="normal"/&gt;
        &lt;propval type="astring" name="description" value="Alexandre Borges"/&gt;
        &lt;propval type="count" name="gid" value="10"/&gt;
        &lt;propval type="astring" name="shell" value="/usr/bin/bash"/&gt;
        &lt;propval type="astring" name="roles" value="root"/&gt;
        &lt;propval type="astring" name="profiles" value="System Administrator"/&gt;
        &lt;propval type="astring" name="sudoers" value="ALL=(ALL) ALL"/&gt;
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">Now, it is time to install <code class="email">zone1</code> and <code class="email">zone2</code> using their respective system configuration files, as configured <a id="id675" class="calibre1"/>previously. Therefore, to perform<a id="id676" class="calibre1"/> this task, we'll be using<a id="id677" class="calibre1"/> our local repository (as learned in <a class="calibre1" title="Chapter 1. IPS and Boot Environments" href="part0015_split_000.html#page">Chapter 1</a>, <em class="calibre11">IPS and Boot Environments</em>) and <a id="id678" class="calibre1"/>executing the<a id="id679" class="calibre1"/> following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pkg publisher</strong>
PUBLISHER           TYPE     STATUS P LOCATION
solaris             origin   online F http://solaris11-1.example.com/
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 install -c /zone_profiles/zone1.xml</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone2 install -c /zone_profiles/zone2.xml</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm list -iv</strong>
  ID NAME        STATUS     PATH                      BRAND    IP    
   0 global      running    /                         solaris  shared
   - zone1       installed  /myzones/zone1            solaris  excl  
   - zone2       installed  /myzones/zone2            solaris  excl  
root@solaris11-1:~#</pre></div><p class="calibre7">Initiate both zones by<a id="id680" class="calibre1"/> running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm list -iv</strong>
ID NAME         STATUS     PATH                       BRAND    IP    
 0 global       running    /                          solaris  shared
 - zone1        installed  /myzones/zone1             solaris  excl  
 - zone2        installed  /myzones/zone2             solaris  excl  
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 boot</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone2 boot</strong>
</pre></div><p class="calibre7">It is<a id="id681" class="calibre1"/> appropriate to check the network information before logging into zones by executing the following<a id="id682" class="calibre1"/> command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dladm show-link</strong>
LINK                CLASS     MTU    STATE    OVER
net1                phys      1500   up       --
net0                phys      1500   up       --
vswitch1            etherstub 9000   unknown  --
vnic0               vnic      9000   up       vswitch1
vnic1               vnic      9000   up       vswitch1
zone1/vnic1         vnic      9000   up       vswitch1
vnic2               vnic      9000   up       vswitch1
zone2/vnic2         vnic      9000   up       vswitch1
zone1/net0          vnic      1500   up       net0
zone2/net0          vnic      1500   up       net0
root@solaris11-1:~# <strong class="calibre8">dladm show-vnic</strong>
LINK          OVER        SPEED  MACADDRESS        MACADDRTYPE    VID
vnic0         vswitch1    40000  2:8:20:d:b:3b     rand           0
vnic1         vswitch1    40000  2:8:20:ef:b6:63   random         0
zone1/vnic1   vswitch1    40000  2:8:20:ef:b6:63   random         0
vnic2         vswitch1    40000  2:8:20:ce:b0:da   random         0
zone2/vnic2   vswitch1    40000  2:8:20:ce:b0:da   random         0
zone1/net0    net0        1000   2:8:20:ac:7d:b1   random         0
zone2/net0    net0        1000   2:8:20:f3:29:68   random         0
root@solaris11-1:~# <strong class="calibre8">ipadm show-addr</strong>
ADDROBJ           TYPE     STATE        ADDR
lo0/v4            static   ok           127.0.0.1/8
net0/v4           static   ok           192.168.1.144/24
net1/v4           static   ok           192.168.5.77/24
lo0/v6            static   ok           ::1/128</pre></div><p class="calibre7">Now, we can<a id="id683" class="calibre1"/> log into the<a id="id684" class="calibre1"/> zones and test<a id="id685" class="calibre1"/> them by running the<a id="id686" class="calibre1"/> following<a id="id687" class="calibre1"/> command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zlogin zone1</strong>
[Connected to zone 'zone1' pts/5]
Oracle Corporation  SunOS 5.11  11.1  September 2012
root@zone1:~# <strong class="calibre8">ping 192.168.1.52</strong>
192.168.1.52 is alive
root@zone1:~# <strong class="calibre8">exit</strong>
logout
[Connection to zone 'zone1' pts/5 closed]

root@solaris11-1:~# <strong class="calibre8">zlogin zone2</strong>
[Connected to zone 'zone2' pts/5]
Oracle Corporation  SunOS 5.11  11.1  September 2012
root@zone2:~# <strong class="calibre8">ping 192.168.1.51</strong>
192.168.1.51 is alive
root@zone2:~# <strong class="calibre8">exit</strong>
logout
[Connection to zone 'zone2' pts/5 closed]
root@solaris11-1:~#</pre></div><p class="calibre7">Everything is <a id="id688" class="calibre1"/>working. Zones<a id="id689" class="calibre1"/> are simply<a id="id690" class="calibre1"/> amazing!</p><div><div><div><div><h3 class="title2"><a id="ch04lvl3sec43" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">The great<a id="id691" class="calibre1"/> news from this recipe was<a id="id692" class="calibre1"/> that we configured a virtual switch (<code class="email">etherstub</code>) and three virtual network interfaces. Afterwards, we used these objects to create two zones using the virtual network concept.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec58" class="calibre1"/>Managing a zone using the resource manager</h1></div></div></div><p class="calibre7">Installing and configuring <a id="id693" class="calibre1"/>Oracle Solaris 11 non-global zones is great, and as we have mentioned previously, it is a great technique that isolates and runs applications without disturbing other applications if anything goes wrong. Nonetheless, there's still a problem. Each non-global zone runs in a global zone as it were running alone, but<a id="id694" class="calibre1"/> an inconvenient effect comes up if one of these zones takes all resources (the processor and memory) for itself, leaving little or nothing for the other zones. Based on this situation, a solution named resource manager can be deployed to control how many resources are consumed for each zone.</p><p class="calibre7">Focusing on the resource manager (without thinking about zones), there are many forms that enforce resource control in Oracle Solaris 11. For example, we can use a project (<code class="email">/etc/project</code>), which is composed by tasks and each one of these tasks contains one or more processes. A new project is created using the <code class="email">projadd</code> command, and a new task can be created using the <code class="email">newtask</code> command through a <a id="id695" class="calibre1"/>
<strong class="calibre8">Service Management Facility</strong> (<strong class="calibre8">SMF</strong>) or even when a session is opened. Enabling the Resource Manager service and associating resources such as processors and memory to this project helps to create an upper limit of about how much of the resources (processors and memory) the processes bound to this project can use for themselves. Anyway, the existing project on Oracle Solaris 11 can be listed by running the <code class="email">projects -l</code> command.</p><p class="calibre7">There are some methods that are<a id="id696" class="calibre1"/> available to associate resources with a project. The first way uses resource controls (the <code class="email">rctladm</code> and <code class="email">prctl</code> commands) to administer and view assigned controls to projects. The disadvantage of this method is that this approach restricts used resources by processes and prevents them from taking more processors or memory, if required. The<a id="id697" class="calibre1"/> other associated and possible problem is that the administrator has to know exactly how many resources are used by the application to make a good resource project, because if insufficient resources are assigned to a project or application, it can stop working.</p><p class="calibre7">The second good way to control how many resources can be taken by an application is to use the <strong class="calibre8">fair share scheduler</strong> (<strong class="calibre8">FSS</strong>) class<a id="id698" class="calibre1"/> that helps us moderate the resource allocation (the processor time) according to the resource requirement. A real advantage is that if an application is not using all assigned resources (the processor time), other applications can use the free resources from the first application. Therefore, this sharing of resources works like a dynamic resource control that spreads resources according to a plan (shares are assigned to applications) and changes its distribution based on demands. For example, when I personally use FSS, I normalize the available shares to 100 points in order to make a comparison with percentage easy. For project A, I grant 30 shares; for project B, I assign 50 shares; and for project C, I assign 20 shares. In the end, the distribution of the time processor is that app A gets 30 percent, app B gets 50 percent, and app C gets 20 percent. This is simple, isn't it?</p><p class="calibre7">The third way to deploy a resource manager is<a id="id699" class="calibre1"/> by using resource pools. Fundamentally, the idea is to assign resources to a resource group (or pool) and afterwards, to associate this pool with a project or application. Similar to what we have explained for FSS, the processor sets (group of processors) are normally assigned to resource pools and the latter is assigned to a project. Resource pools present a better flexibility because they permit us to set a minimum and maximum number of processors to be used by the application based on the demand. For example, it would be possible to assign a range from one to eight cores (or processors) to a project, and according to the resource demand, fewer or more processors would be used. Moreover, a specific processor (or core) could be dedicated to a processor set, if required. A small disadvantage of<a id="id700" class="calibre1"/> using the resource pool is that the processor is restricted to the pool, and even if there is a free resource (the processor), it cannot be used by another application. Personally, I prefer to manage and work with FSS because its flexibility and reusability offers you the opportunity to free up resources that can be used by other applications or projects. Nonetheless, it is feasible to mix resource pools with FSS and projects and have an advantage by implementing the controlled environment.</p><p class="calibre7">In the end, all of these techniques that control resources can be deployed in the zone context to limit the used resources by running applications, as we are going to learn in this recipe.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec90" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual <a id="id701" class="calibre1"/>machine (VirtualBox or VMware) running <a id="id702" class="calibre1"/>on a processor with two or more cores, with 8 GB RAM and an 80 GB hard disk. To make the following procedure easier, we will take zones that were used in the previous recipe, and then the reader can assume that this recipe is a simple continuation.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec91" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Basically, this recipe is composed of two parts. In the first part, the resource pools are configured, and in the second part, the existing resource pools are bound to zones.</p><p class="calibre7">To begin, we have to gather information about the existing zones by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm list -iv</strong>
ID NAME          STATUS     PATH                      BRAND    IP    
 0 global        running    /                         solaris  shared
 1 zone2         running    /myzones/zone2            solaris  excl  
 2 zone1         running    /myzones/zone1            solaris  excl  
root@solaris11-1:~#</pre></div><p class="calibre7">The resource pool services have probably been stopped. We can verify them by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep pool</strong>
disabled       12:23:27 svc:/system/pools:default
disabled       12:23:35 svc:/system/pools/dynamic:default</pre></div><p class="calibre7">Checking for dependencies from each service is done by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -d svc:/system/pools:default</strong>
STATE          STIME    FMRI
online         12:23:42 svc:/system/filesystem/minimal:default
root@solaris11-1:~# <strong class="calibre8">svcs -d svc:/system/pools/dynamic:default</strong>
STATE          STIME    FMRI
disabled       12:23:27 svc:/system/pools:default
online         12:24:08 svc:/system/filesystem/local:default</pre></div><p class="calibre7">As the <code class="email">svc:/system/pools/dynamic:default</code> service depends on <code class="email">svc:/system/pools:default</code>, it is recommended that you enable both of them by running the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcadm enable -r svc:/system/pools/dynamic:default</strong>
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep pool</strong>
online         14:30:31 svc:/system/pools:default
online         14:30:37 svc:/system/pools/dynamic:default
root@solaris11-1:~# <strong class="calibre8">svcs -p svc:/system/pools/dynamic:default</strong>
STATE          STIME    FMRI
online         14:30:37 svc:/system/pools/dynamic:default
               14:30:37     5443 poold</pre></div><p class="calibre7">When a resource <a id="id703" class="calibre1"/>pool control is enabled, a default pool (<code class="email">pool_default</code>) and a default processor set (<code class="email">default_pset</code>) including all resources from the<a id="id704" class="calibre1"/> system are created, as verified by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pooladm</strong>
system default
  string  system.comment 
  int  system.version 1
  boolean  system.bind-default true
  string  system.poold.objectives wt-load

  pool pool_default
    int  pool.sys_id 0
    boolean  pool.active true
    boolean  pool.default true
    int  pool.importance 1
    string  pool.comment 
    pset  pset_default

  pset pset_default
    int  pset.sys_id -1
    boolean  pset.default true
    uint  pset.min 1
    uint  pset.max 65536
    string  pset.units population
    uint  pset.load 211
    uint  pset.size 4
    string  pset.comment 

    cpu
      int  cpu.sys_id 1
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int  cpu.sys_id 3
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int  cpu.sys_id 0
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int  cpu.sys_id 2
      string  cpu.comment 
      string  cpu.status on-line</pre></div><p class="calibre7">According to this output, there is<a id="id705" class="calibre1"/> a default pool (<code class="email">pool_default</code>); the real processor has four cores (range 0 to 3), and all of them consist of a processor set (<code class="email">pset</code>). However, this resource pool <a id="id706" class="calibre1"/>configuration is in the memory and is not persistent in the disk. Therefore, to save this into a configuration file, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pooladm -s</strong>
root@solaris11-1:~# <strong class="calibre8">more /etc/pooladm.conf</strong> 
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE system PUBLIC "-//Sun Microsystems Inc//DTD Resource Management All//EN" "file:///usr/share/lib/xml/dtd/rm_pool.dtd.1"&gt;
&lt;!--
Configuration for pools facility. Do NOT edit this file by hand - use poolcfg(1) or libpool(3POOL) instead.
--&gt;
&lt;system ref_id="dummy" name="default" comment="" version="1" bind-default="true"&gt;
  &lt;property name="system.poold.objectives" type="string"&gt;wt-load&lt;/property&gt;
  &lt;pool name=<strong class="calibre8">"pool_default</strong>" active="true" default="true" importance="1" comment="" res="pset_-1" ref_id="pool_0"&gt;
    &lt;property name="pool.sys_id" type="int"&gt;0&lt;/property&gt;
  &lt;/pool&gt;
  &lt;res_comp type="pset" sys_id="-1" name="pset_default" default="true" min="1" max="65536" units="population" comment="" ref_id="pset_-1"&gt;
    &lt;property name="pset.load" type="uint"&gt;176&lt;/property&gt;
    &lt;property name="pset.size" type="uint"&gt;4&lt;/property&gt;
    &lt;comp type="cpu" sys_id="1" comment="" ref_id="cpu_1"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
    &lt;comp type="cpu" sys_id="3" comment="" ref_id="cpu_3"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
    &lt;comp type="cpu" sys_id="0" comment="" ref_id="cpu_0"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
    &lt;comp type="cpu" sys_id="2" comment="" ref_id="cpu_2"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
  &lt;/res_comp&gt;
&lt;/system&gt;</pre></div><p class="calibre7">From this point, the<a id="id707" class="calibre1"/> following steps create a processor set (<code class="email">pset</code>) with two cores, create a pool, and associate the processor set with this pool. Later, this<a id="id708" class="calibre1"/> pool will be assigned to the zone configuration, which can be shown as the processor set | pool | zone.</p><p class="calibre7">Thus, to create a processor set (<code class="email">first_pset</code>) with one core at minimum (<code class="email">pset.min=1</code>) and two cores (<code class="email">pset.max=2</code>) at maximum, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">poolcfg -c 'create pset first_pset (uint pset.min = 1; uint pset.max = 2)'</strong>
root@solaris11-1:~# <strong class="calibre8">poolcfg -c 'info pset first_pset'</strong>

<strong class="calibre8">pset first_pset</strong>
  int  pset.sys_id -2
  boolean  pset.default false
  uint  pset.min 1
  uint  pset.max 2
  string  pset.units population
  uint  pset.load 0
  uint  pset.size 0
  string  pset.comment</pre></div><p class="calibre7">Now, we can create a pool named <code class="email">first_pool</code>, which initially has all resources (four core processors) bound to it, by running the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">poolcfg -c 'create pool first_pool'</strong>
root@solaris11-1:~# <strong class="calibre8">poolcfg -c 'info pool first_pool'</strong>

<strong class="calibre8">pool first_pool</strong>
  boolean  pool.active true
  boolean  pool.default false
  int  pool.importance 1
  string  pool.comment 
  pset  pset_default

<strong class="calibre8">  pset pset_default</strong>
    int  pset.sys_id -1
<strong class="calibre8">    boolean  pset.default true</strong>
    uint  pset.min 1
    uint  pset.max 65536
    string  pset.units population
    uint  pset.load 176
    uint  pset.size 4
    string  pset.comment 

    cpu
      int  cpu.sys_id 1
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int  cpu.sys_id 3
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int  cpu.sys_id 0
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int  cpu.sys_id 2
      string  cpu.comment 
      string  cpu.status on-line

root@solaris11-1:~#</pre></div><p class="calibre7">Then, assign<a id="id709" class="calibre1"/> the <code class="email">first_pool</code> pool to the <code class="email">first_pset</code> processor set by<a id="id710" class="calibre1"/> executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">poolcfg -c 'associate pool first_pool (pset first_pset)'</strong>
root@solaris11-1:~# <strong class="calibre8">poolcfg -c 'info pool first_pool'</strong>
pool first_pool
  boolean  pool.active true
  boolean  pool.default false
  int  pool.importance 1
  string  pool.comment 
   pset  first_pset

  pset first_pset
    int  pset.sys_id -2
    boolean  pset.default false
    uint  pset.min 1
    uint  pset.max 2
    string  pset.units population
    uint  pset.load 0
    uint  pset.size 0
    string  pset.comment 

root@solaris11-1:~#</pre></div><p class="calibre7">So far, everything has been working well. Now, we have to check whether this new pool already appears in<a id="id711" class="calibre1"/> the resource memory configuration by<a id="id712" class="calibre1"/> executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">poolcfg -c info</strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool pool_default
    int      pool.sys_id 0
    boolean  pool.active true
    boolean  pool.default true
    int      pool.importance 1
    string   pool.comment 
    pset     pset_default

<strong class="calibre8">  pool first_pool</strong>
<strong class="calibre8">    boolean  pool.active true</strong>
<strong class="calibre8">    boolean  pool.default false</strong>
<strong class="calibre8">    int      pool.importance 1</strong>
<strong class="calibre8">    string   pool.comment </strong>
<strong class="calibre8">    pset     first_pset</strong>

  pset pset_default
    int      pset.sys_id -1
    boolean  pset.default true
    uint     pset.min 1
    uint     pset.max 65536
    string   pset.units population
    uint     pset.load 176
    uint     pset.size 4
    string   pset.comment 

    cpu
      int     cpu.sys_id 1
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 3
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 0
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 2
      string  cpu.comment 
      string  cpu.status on-line

  pset first_pset
    int      pset.sys_id -2
    boolean  pset.default false
    uint     pset.min 1
    uint     pset.max 2
    string   pset.units population
    uint     pset.load 0
    uint     pset.size 0
    string   pset.comment </pre></div><p class="calibre7">We have<a id="id713" class="calibre1"/> realized that<a id="id714" class="calibre1"/> the <code class="email">first_pset</code> configuration is still not persistent in the pool configuration file. To validate (the -<code class="email">n -c</code> option) and commit (the <code class="email">-c</code> option) the new configuration, execute the<a id="id715" class="calibre1"/> following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pooladm -n -c</strong>
root@solaris11-1:~# <strong class="calibre8">pooladm -c</strong>
root@solaris11-1:~# <strong class="calibre8">more /etc/pooladm.conf</strong>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE system PUBLIC "-//Sun Microsystems Inc//DTD Resource Management All//EN" "file:///usr/share/lib/xml/dtd/rm_pool.dtd.1"&gt;
&lt;!--
Configuration for pools facility. Do NOT edit this file by hand - use poolcfg(1) or libpool(3POOL) instead.
--&gt;
&lt;system ref_id="dummy" name="default" comment="" version="1" bind-default="true"&gt;
  &lt;property name="system.poold.objectives" type="string"&gt;wt-load&lt;/property&gt;
  &lt;pool name=<strong class="calibre8">"pool_default</strong>" active="true" default="true" importance="1" comment="" res="pset_-1" ref_id="pool_0"&gt;
    &lt;property name="pool.sys_id" type="int"&gt;0&lt;/property&gt;
  &lt;/pool&gt;
  &lt;res_comp type="pset" sys_id="-1" name=<strong class="calibre8">"pset_default</strong>" default="true" min="1" max="65536" units="population" comment="" ref_id="pset_-1"&gt;
    &lt;property name="pset.load" type="uint"&gt;176&lt;/property&gt;
    &lt;property name="pset.size" type="uint"&gt;4&lt;/property&gt;
    &lt;comp type="cpu" sys_id="1" comment="" ref_id=<strong class="calibre8">"cpu_1</strong>"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
    &lt;comp type="cpu" sys_id="3" comment="" ref_id=<strong class="calibre8">"cpu_3</strong>"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
    &lt;comp type="cpu" sys_id="0" comment="" ref_id=<strong class="calibre8">"cpu_0</strong>"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
    &lt;comp type="cpu" sys_id="2" comment="" ref_id=<strong class="calibre8">"cpu_2</strong>"&gt;
      &lt;property name="cpu.status" type="string"&gt;on-line&lt;/property&gt;
    &lt;/comp&gt;
  &lt;/res_comp&gt;
  <strong class="calibre8">&lt;res_comp ref_id="id_0" sys_id="-2" type="pset" name="first_pset" min="1" max="2" units="population" comment=""&gt;</strong>
    <strong class="calibre8">&lt;property name="pset.load" type="uint"&gt;0&lt;/property&gt;</strong>
    <strong class="calibre8">&lt;property name="pset.size" type="uint"&gt;0&lt;/property&gt;</strong>
  <strong class="calibre8">&lt;/res_comp&gt;</strong>
  <strong class="calibre8">&lt;property name="system._next_id" type="uint"&gt;2&lt;/property&gt;</strong>
  <strong class="calibre8">&lt;pool ref_id="id_1" res="id_0" name="first_pool" active="true" importance="1" comment=""/&gt;</strong>
<strong class="calibre8">&lt;/system&gt;</strong>
root@solaris11-1:~#</pre></div><p class="calibre7">Everything<a id="id716" class="calibre1"/> is ready. Nevertheless, it's easy to verify that the configuration is active only in the memory (the kernel state) using the <code class="email">-dc</code> option, but it isn't saved in<a id="id717" class="calibre1"/> the resource pool <a id="id718" class="calibre1"/>configuration file (option <code class="email">-c</code>) as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">poolcfg -dc info</strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool first_pool
    int      pool.sys_id 1
    boolean  pool.active true
    boolean  pool.default false
    int      pool.importance 1
    string   pool.comment 
<strong class="calibre8">    pset     first_pset</strong>

  pool pool_default
    int      pool.sys_id 0
    boolean  pool.active true
    boolean  pool.default true
    int      pool.importance 1
    string   pool.comment 
    pset     pset_default

<strong class="calibre8">  pset first_pset</strong>
<strong class="calibre8">    int      pset.sys_id 1</strong>
<strong class="calibre8">    boolean  pset.default false</strong>
<strong class="calibre8">    uint     pset.min 1</strong>
<strong class="calibre8">    uint     pset.max 2</strong>
<strong class="calibre8">    string   pset.units population</strong>
<strong class="calibre8">    uint     pset.load 0</strong>
<strong class="calibre8">    uint     pset.size 2</strong>
<strong class="calibre8">    string   pset.comment </strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 1</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int  cpu.sys_id 0</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">  pset pset_default</strong>
<strong class="calibre8">    int      pset.sys_id -1</strong>
<strong class="calibre8">    boolean  pset.default true</strong>
<strong class="calibre8">    uint     pset.min 1</strong>
<strong class="calibre8">    uint     pset.max 65536</strong>
<strong class="calibre8">    string   pset.units population</strong>
<strong class="calibre8">    uint     pset.load 151</strong>
<strong class="calibre8">    uint     pset.size 2</strong>
<strong class="calibre8">    string   pset.comment </strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 3</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 2</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

root@solaris11-1:~# <strong class="calibre8">poolcfg -c info</strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool pool_default
    int  pool.sys_id 0
    boolean  pool.active true
    boolean  pool.default true
    int      pool.importance 1
    string   pool.comment 
    pset     pset_default

  pool first_pool
    boolean  pool.active true
    boolean  pool.default false
    int      pool.importance 1
    string   pool.comment 
<strong class="calibre8">    pset     first_pset</strong>

<strong class="calibre8">  pset pset_default</strong>
    int  pset.sys_id -1
    boolean  pset.default true
    uint     pset.min 1
    uint     pset.max 65536
    string   pset.units population
    uint     pset.load 176
    uint     pset.size 4
    string   pset.comment 

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 1</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 3</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 0</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 2</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">  pset first_pset</strong>
<strong class="calibre8">    int      pset.sys_id -2</strong>
<strong class="calibre8">    boolean  pset.default false</strong>
<strong class="calibre8">    uint     pset.min 1</strong>
<strong class="calibre8">    uint     pset.max 2</strong>
<strong class="calibre8">    string   pset.units population</strong>
<strong class="calibre8">    uint     pset.load 0</strong>
<strong class="calibre8">    uint     pset.size 0</strong>
    string   pset.comment </pre></div><p class="calibre7">To solve the<a id="id719" class="calibre1"/> problem of saving the resource pool configuration from the memory to disk, we can use the <code class="email">-s</code> option by running the<a id="id720" class="calibre1"/> following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pooladm -s</strong>
root@solaris11-1:~# <strong class="calibre8">poolcfg -c info</strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool first_pool
    int      pool.sys_id 1
    boolean  pool.active true
    boolean  pool.default false
    int      pool.importance 1
    string   pool.comment 
    pset     first_pset

  pool pool_default
    int      pool.sys_id 0
    boolean  pool.active true
    boolean  pool.default true
    int      pool.importance 1
    string   pool.comment 
    pset     pset_default

<strong class="calibre8">  pset first_pset</strong>
    int      pset.sys_id 1
    boolean  pset.default false
    uint     pset.min 1
    uint     pset.max 2
    string   pset.units population
    uint     pset.load 0
    uint     pset.size 2
    string   pset.comment 

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 1</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 0</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">  pset pset_default</strong>
    int      pset.sys_id -1
    boolean  pset.default true
    uint     pset.min 1
    uint     pset.max 65536
    string   pset.units population
    uint     pset.load 201
    uint     pset.size 2
    string   pset.comment 

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 3</strong>
<strong class="calibre8">      string  cpu.comment </strong>
<strong class="calibre8">      string  cpu.status on-line</strong>

<strong class="calibre8">    cpu</strong>
<strong class="calibre8">      int     cpu.sys_id 2</strong>
<strong class="calibre8">      string  cpu.comment </strong>
      string  cpu.status on-line</pre></div><p class="calibre7">That is great! Listing the<a id="id721" class="calibre1"/> active resource pools is done by<a id="id722" class="calibre1"/> executing the <code class="email">poolstat</code> command as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">poolstat</strong>
                              pset
 id pool                 size used load
  1 first_pool              2 0.00 0.00
  0 pool_default            2 0.00 0.17
root@solaris11-1:~# <strong class="calibre8">poolstat -r all</strong>
id pool              type rid rset           min  max size used load
  1 first_pool        pset   1 first_pset     1    2    2   0.00 0.00
  0 pool_default      pset  -1 pset_default   1    66K  2   0.00 0.17</pre></div><p class="calibre7">Associating the recently created pool (<code class="email">first_pool</code>) to non-global <code class="email">zone1</code> is done by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1 info | grep pool</strong>
pool: 

root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1 set pool=first_pool</strong>
root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1 info | grep pool</strong>
pool: first_pool</pre></div><p class="calibre7">It is impossible to activate the<a id="id723" class="calibre1"/> bound resource pool without rebooting <code class="email">zone1</code>, so execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm list -iv</strong>
ID NAME          STATUS     PATH                      BRAND    IP    
 0 global        running    /                         solaris  shared
 1 zone2         running    /myzones/zone2            solaris  excl  
 3 zone1         running    /myzones/zone1            solaris  excl  </pre></div><p class="calibre7">Now, it is time to<a id="id724" class="calibre1"/> log in to <code class="email">zone1</code> and check whether the <code class="email">first_pool</code> pool is active by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zlogin zone1</strong>
[Connected to zone 'zone1' pts/3]
Oracle Corporation  SunOS 5.11  11.1  September 2012
root@zone1:~# <strong class="calibre8">poolcfg -dc info</strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool first_pool
    int      pool.sys_id 1
    boolean  pool.active true
    boolean  pool.default false
    int      pool.importance 1
    string   pool.comment 
    pset     first_pset

  pset first_pset
    int      pset.sys_id 1
    boolean  pset.default false
    uint     pset.min 1
    uint     pset.max 2
    string   pset.units population
    uint     pset.load 540
    uint     pset.size 2
    string   pset.comment 

    cpu
      int     cpu.sys_id 1
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 0
      string  cpu.comment 
      string  cpu.status on-line
root@zone1:~# <strong class="calibre8">psrinfo</strong>
0  on-line   since 02/01/2014 12:23:05
1  on-line   since 02/01/2014 12:23:07
root@zone1:~# <strong class="calibre8">psrinfo -v</strong>
Status of virtual processor 0 as of: 02/01/2014 15:52:47
  on-line since 02/01/2014 12:23:05.
  The i386 processor operates at 2470 MHz,
    and has an i387 compatible floating point processor.
Status of virtual processor 1 as of: 02/01/2014 15:52:47
  on-line since 02/01/2014 12:23:07.
  The i386 processor operates at 2470 MHz,
    and has an i387 compatible floating point processor.</pre></div><p class="calibre7">Perfect! Two cores<a id="id725" class="calibre1"/> were associated with <code class="email">zone1</code>, and any application running inside this zone can use these core processors.</p><p class="calibre7">To change the resource<a id="id726" class="calibre1"/> type focus, a very interesting method that limits the used memory is resource capping, which helps us limit the physical, swap, and locked memory.</p><p class="calibre7">For example, using the same <code class="email">zone1</code>, let's change its configuration by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">add capped-memory</strong>
zonecfg:zone1:capped-memory&gt; <strong class="calibre8">set physical=1G</strong>
zonecfg:zone1:capped-memory&gt; <strong class="calibre8">set swap=500M</strong>
zonecfg:zone1:capped-memory&gt; <strong class="calibre8">end</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1 info</strong>
zonename: zone1
zonepath: /myzones/zone1
brand: solaris
autoboot: true
<strong class="calibre8">(truncated)</strong>

capped-memory:
  physical: 1G
  [swap: 500M]
rctl:
  name: zone.max-swap
  value: (priv=privileged,limit=524288000,action=deny)
root@solaris11-1:~#</pre></div><p class="calibre7">According to the previous output, the physical memory from <code class="email">zone1</code> is limited to 1 GB, and the used swap space<a id="id727" class="calibre1"/> is restricted to 500 MB. Furthermore, there is a strange line for maximum swap:</p><div><pre class="programlisting">
<strong class="calibre8">value: (priv=privileged,limit=524288000,action=deny)</strong>
</pre></div><p class="calibre7">The interpretation for<a id="id728" class="calibre1"/> this line is as follows:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">privileged</code>: This can be modified only by privileged users (root). Another possible value is <code class="email">basic</code> (only the owner can modify it).</li><li class="listitem"><code class="email">deny</code>: This can deny any requested resource for an amount above the limit value (500 MB). The other possibilities would be <code class="email">none</code> (no action is taken even if the requested resource is above the limit) and <code class="email">signal</code>, in which a signal is sent when the threshold value is exceeded.</li></ul></div><p class="calibre7">Resource capping is a service implemented by the <code class="email">rcapd</code> daemon, and this service can be enabled by the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep rcap</strong>
disabled       21:56:20 svc:/system/rcap:default

root@solaris11-1:~# <strong class="calibre8">svcs  -d svc:/system/rcap:default</strong>
STATE          STIME    FMRI
online         21:56:31 svc:/system/filesystem/minimal:default
online         21:56:33 svc:/system/resource-mgmt:default
online         21:56:35 svc:/system/manifest-import:default
root@solaris11-1:~# <strong class="calibre8">svcadm enable svc:/system/rcap:default</strong>
root@solaris11-1:~# <strong class="calibre8">svcs -	a | grep rcap</strong>
online         22:52:06 svc:/system/rcap:default
root@solaris11-1:~# <strong class="calibre8">svcs -p svc:/system/rcap:default</strong>
STATE          STIME    FMRI
online         22:52:06 svc:/system/rcap:default
               22:52:06     5849 rcapd</pre></div><p class="calibre7">Reboot <code class="email">zone1</code> for memory capping to take effect. It would be feasible to enable the resource capping daemon <a id="id729" class="calibre1"/>without rebooting and starting the daemon now by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">rcapadm -E -n</strong>
</pre></div><p class="calibre7">To monitor the action of the <code class="email">rcap</code> daemon (<code class="email">rcapd</code>), execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm list -iv</strong>
ID NAME             STATUS     PATH                 BRAND    IP    
 0 global           running    /                    solaris  shared
 1 zone2            running    /myzones/zone2       solaris  excl  
 3 zone1            running    /myzones/zone1       solaris  excl  
root@solaris11-1:~# <strong class="calibre8">rcapstat -z</strong>
id zone            nproc    vm   rss   cap    at avgat    pg avgpg
 3 zone1               -   26M   38M 1024M    0K    0K    0K    0K
 3 zone1               -   31M   44M 1024M    0K    0K    0K    0K
 3 zone1               -   31M   44M 1024M    0K    0K    0K    0K</pre></div><p class="calibre7">The used physical memory (RSS) is below the memory capping limit (1024 MB). If the physical memory is increased, its limit is 1024 MB. Nice!</p><p class="calibre7">To make this example<a id="id730" class="calibre1"/> more attractive, some changes can be made. Let's remove the <code class="email">first_pool</code> resource pool (and any other existing pool) from <code class="email">zone1</code>. Additionally, the <code class="email">first_pool</code> pool will be deleted by the <code class="email">pooladm -x</code> command. Obviously, the new pool configuration must be saved by the <code class="email">pooladm -s</code> command. The following is the sequence:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1 clear pool</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
root@solaris11-1:~# <strong class="calibre8">pooladm -x</strong>
root@solaris11-1:~# <strong class="calibre8">pooladm -s</strong>
root@solaris11-1:~# <strong class="calibre8">pooladm </strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool pool_default
    int      pool.sys_id 0
    boolean  pool.active true
    boolean  pool.default true
    int      pool.importance 1
    string   pool.comment 
    pset     pset_default

  pset pset_default
    int      pset.sys_id -1
    boolean  pset.default true
    uint     pset.min 1
    uint     pset.max 65536
    string   pset.units population
    uint     pset.load 15511
    uint     pset.size 4
    string   pset.comment 

    cpu
      int     cpu.sys_id 1
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 3
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 0
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 2
      string  cpu.comment 
      string  cpu.status on-line</pre></div><p class="calibre7">Everything has returned to the<a id="id731" class="calibre1"/> default status, and from this point, <code class="email">zone1</code> doesn't have a special associated pool. This permits us to focus on FSS from now on.</p><p class="calibre7">The following command checks what the current default kernel scheduling class is:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dispadmin -d</strong>
dispadmin: Default scheduling class is not set</pre></div><p class="calibre7">There is no<a id="id732" class="calibre1"/> default scheduling class. If we want to use FSS, then it would be appropriate to configure it on the global zone because this setting will be inherited by all non-global zones. To configure the FSS as explained, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dispadmin -d FSS</strong>
root@solaris11-1:~# <strong class="calibre8">dispadmin -d</strong>
FSS  (Fair Share)</pre></div><p class="calibre7">This setup only takes effect after a system is rebooted. After the system has been reinitiated, all processes will be classified as FSS. Nonetheless, to enforce it now without a reboot, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">priocntl -s -c FSS</strong>
</pre></div><p class="calibre7">Unfortunately, all current<a id="id733" class="calibre1"/> processes are still running under other scheduling classes and only new processes will take the FSS setting. This can be verified by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">ps -efcZ | more</strong>
  ZONE     UID   PID  PPID  CLS PRI    STIME TTY    TIME CMD
global    root     0     0  SYS  96 00:04:41 ?      0:01 sched
global    root     5     0  SDC  99 00:04:38 ?      0:07 zpool-rpool
global    root     6     0  SDC  99 00:04:42 ?      0:01 kmem_task
global    root     1     0   TS  59 00:04:42 ?      0:00 /usr/sbin/init
global    root     2     0  SYS  98 00:04:42 ?      0:00 pageout
global    root     3     0  SYS  60 00:04:42 ?      0:00 fsflush
global    root     7     0  SYS  60 00:04:42 ?      0:00 intrd
global    root     8     0  SYS  60 00:04:42 ?      0:00 vmtasks
global    root   115     1   TS  59 00:05:09 ?      0:00 /usr/lib/pfexecd
global    root    11     1   TS  59 00:04:48 ?      0:13 /lib/svc/bin/svc.startd
global    root    13     1   TS  59 00:04:48 ?      0:33 /lib/svc/bin/svc.configd
global    root   911     1   TS  59 02:05:55 ?      0:00 
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">Again, it's unnecessary<a id="id734" class="calibre1"/> to wait for the next reboot. Therefore, all processes can be moved from their current scheduling classes to FSS by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">priocntl -s -c FSS -i all</strong>
root@solaris11-1:~# <strong class="calibre8">ps -efcZ | more</strong>
  ZONE      UID   PID  PPID  CLS PRI    STIME TTY    TIME CMD
global     root     0     0  SYS  96 00:04:41 ?      0:01 sched
global     root     5     0  SDC  99 00:04:38 ?      0:12 zpool-rpool
global     root     6     0  SDC  99 00:04:42 ?      0:02 kmem_task
global     root     1     0  FSS  29 00:04:42 ?      0:00 /usr/sbin/init
global     root     2     0  SYS  98 00:04:42 ?      0:00 pageout
global     root     3     0  SYS  60 00:04:42 ?      0:01 fsflush
global     root     7     0  SYS  60 00:04:42 ?      0:00 intrd
global     root     8     0  SYS  60 00:04:42 ?      0:00 vmtasks
global     root   115     1  FSS  29 00:05:09 ?      0:00 /usr/lib/pfexecd
global     root    11     1  FSS  29 00:04:48 ?      0:13 /lib/svc/bin/svc.startd
global     root    13     1  FSS  29 00:04:48 ?      0:33 /lib/svc/bin/svc.configd
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">When FSS is set up as the default scheduling class in the global zone, all non-global zones automatically take this configuration. To verify this, run the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zlogin zone1</strong>
 [Connected to zone 'zone1' pts/4]
Oracle Corporation  SunOS 5.11  11.1  September 2012
root@zone1:~# <strong class="calibre8">ps -efcZ | more</strong>
 ZONE      UID   PID  PPID  CLS PRI    STIME TTY         TIME CMD
zone1     root  3944  2454  FSS  29 02:06:47 ?           0:00 /usr/sbin/init
zone1     root  4284  2454  FSS  29 02:06:58 ?           0:06 /lib/svc/bin/svc.startd
zone1     root  2454  2454  SYS  60 02:06:29 ?           0:00 zsched
zone1     root  5479  2454  FSS  59 02:48:52 pts/4       0:00 /usr/bin/login -z global -f root
zone1     root  4287  2454  FSS  29 02:07:00 ?           0:21 /lib/svc/bin/svc.configd
zone1   netcfg  4448  2454  FSS  29 02:07:27 ?           0:00 /lib/inet/netcfgd
zone1     root  4922  2454  FSS  29 02:08:21 ?           0:00 
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">We can realize that all main <a id="id735" class="calibre1"/>processes from <code class="email">zone1</code> are <a id="id736" class="calibre1"/>under the FSS class. Anyway, it is recommended that the FSS class be explicitly configured in the non-global settings in order to prevent possible mistakes in the future. Therefore, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">set scheduling-class=FSS</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~#
root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone2</strong>
zonecfg:zone2&gt; <strong class="calibre8">set scheduling-class=FSS</strong>
zonecfg:zone2&gt; <strong class="calibre8">verify</strong>
zonecfg:zone2&gt; <strong class="calibre8">commit</strong>
zonecfg:zone2&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~# </pre></div><p class="calibre7">Finally, it is the right moment to use the FSS class to configure some shares for each zone (<code class="email">zone1</code> and <code class="email">zone2</code>). This way, it is possible to share an amount (70 percent) from the CPU processing for <code class="email">zone1</code> and<a id="id737" class="calibre1"/> the other amount (30 percent) from the CPU processing for <code class="email">zone2</code>. The following is the procedure:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">add rctl</strong> 
zonecfg:zone1:rctl&gt; <strong class="calibre8">set name=zone.cpu-shares</strong>
zonecfg:zone1:rctl&gt; <strong class="calibre8">add value (priv=privileged, limit=70,action=none)</strong>
zonecfg:zone1:rctl&gt; <strong class="calibre8">end</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone2</strong>
zonecfg:zone2&gt; <strong class="calibre8">add rctl</strong>
zonecfg:zone2:rctl&gt; <strong class="calibre8">set name=zone.cpu-shares</strong>
zonecfg:zone2:rctl&gt; <strong class="calibre8">add value (priv=privileged,limit=30,action=none)</strong>
zonecfg:zone2:rctl&gt; <strong class="calibre8">end</strong>
zonecfg:zone2&gt; <strong class="calibre8">verify</strong>
zonecfg:zone2&gt; <strong class="calibre8">commit</strong>
zonecfg:zone2&gt; <strong class="calibre8">exit</strong>
</pre></div><p class="calibre7">This is excellent! Shares were <a id="id738" class="calibre1"/>assigned to <code class="email">zone1</code> (70 shares) and <code class="email">zone2</code> (30 shares) using the <code class="email">zonecfg</code> command in a persistent way. For both the zones to take effect, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone2 shutdown -r</strong>
</pre></div><p class="calibre7">The processor time can be followed and monitored using the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">prstat -Z</strong>
  PID USERNAME  SIZE   RSS STATE   PRI NICE      TIME  CPU PROCESS/NLWP      
  4466 root      216M   98M sleep    59    0   0:00:41 0.7% java/25
  4702 root      129M   19M sleep    59    0   0:00:06 0.5% gnome-terminal/2
rcapd/1
     5 root        0K    0K sleep    99  -20   0:00:19 0.2% zpool-rpool/138
   898 root       53M   18M sleep    53    0   0:00:06 0.1% poold/9
  <strong class="calibre8">(omitted output)</strong>
 automountd/2
   198 root     1780K  788K sleep    29    0   0:00:00 0.0% utmpd/1
   945 root     2392K 1552K sleep    59    0   0:00:00 0.0% ttymon/1
ZONEID    NPROC  SWAP   RSS MEMORY      TIME  CPU ZONE      
     0      117 2885M  794M   9.5%   0:03:28 2.5% global    
     2       28  230M   62M   0.7%   0:00:30 0.1% zone1     
     1       28  230M   64M   0.7%   0:00:29 0.1% zone2      </pre></div><p class="calibre7">Surprisingly, it is feasible to change the <code class="email">zone.cpu-shares</code> attribute dynamically without rebooting zones but in <a id="id739" class="calibre1"/>a non-persistent way (all the changes are lost after a reboot) by running the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">prctl -n zone.cpu-shares -v 60 -r -i zone zone1</strong>
root@solaris11-1:~# <strong class="calibre8">prctl -n zone.cpu-shares -P -i zone zone1</strong>
zone: 3: zone1
zone.cpu-shares usage 60 - - -
zone.cpu-shares privileged 60 - none -
zone.cpu-shares system 65535 max none -
root@solaris11-1:~# <strong class="calibre8">prctl -n zone.cpu-shares -v 40 -r -i zone zone2</strong>
root@solaris11-1:~# <strong class="calibre8">prctl -n zone.cpu-shares -P -i zone zone2</strong>
zone: 4: zone2
zone.cpu-shares usage 40 - - -
zone.cpu-shares privileged 40 - none -
zone.cpu-shares system 65535 max none -
root@solaris11-1:~#</pre></div><p class="calibre7">To collect information about<a id="id740" class="calibre1"/> the memory and CPU from both zones in an interval of 5 seconds, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~#  <strong class="calibre8">zonestat -z zone1,zone2 -r physical-memory 5</strong>
Collecting data for first interval...
Interval: 1, Duration: 0:00:05
PHYSICAL-MEMORY              SYSTEM MEMORY
mem_default                          8191M
                                ZONE  USED %USED   CAP  %CAP
                             [total] 1464M 17.8%     -     -
                            [system]  624M 7.62%     -     -
                               zone2 63.9M 0.78%     -     -
                               zone1 3561K 0.04% 1024M 0.33%

Interval: 2, Duration: 0:00:10
PHYSICAL-MEMORY              SYSTEM MEMORY
mem_default                          8191M
                                ZONE  USED %USED   CAP  %CAP
                             [total] 1464M 17.8%     -     -
                            [system]  624M 7.62%     -     -
                               zone2 63.9M 0.78%     -     -
                               zone1 3485K 0.04% 1024M 0.33%
Removing all configured shares is quickly executed by running:
root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1 clear cpu-shares</strong>
root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone2 clear cpu-shares</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone2 shutdown -r</strong>
</pre></div><p class="calibre7">Keeping up with our approach about the resource manager, there's a zone resource, named <code class="email">dedicated-cpu</code>, where it is possible to specify a subset of processors (or cores) to a non-global zone. For example, the following example shows us that <code class="email">zone1</code> can use one to four processors (<code class="email">ncpus=1-4</code>) according to the demand, and this setting has an <code class="email">importance</code> value<a id="id741" class="calibre1"/> equal to <code class="email">8</code> when competing for resources against other zones or configurations. This smart setup creates a temporary pool including any necessary processor inside it. The following is the sequence:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">add dedicated-cpu</strong>
zonecfg:zone1:dedicated-cpu&gt; <strong class="calibre8">set ncpus=1-4</strong>
zonecfg:zone1:dedicated-cpu&gt; <strong class="calibre8">set importance=8</strong>
zonecfg:zone1:dedicated-cpu&gt; <strong class="calibre8">end</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
root@solaris11-1:~# <strong class="calibre8">zlogin zone1</strong>
[Connected to zone 'zone1' pts/2]
Oracle Corporation  SunOS 5.11  11.1  September 2012
root@zone1:~# <strong class="calibre8">pooladm</strong>
system default
  string   system.comment 
  int      system.version 1
  boolean  system.bind-default true
  string   system.poold.objectives wt-load

  pool SUNWtmp_zone1
    int  pool.sys_id 1
    boolean  pool.active true
    boolean  pool.default false
    int      pool.importance 8
    string   pool.comment 
    boolean  pool.temporary true
    pset     SUNWtmp_zone1

  pset SUNWtmp_zone1
    int      pset.sys_id 1
    boolean  pset.default false
    uint     pset.min 1
    uint     pset.max 4
    string   pset.units population
    uint     pset.load 4
    uint     pset.size 2
    string   pset.comment 
    boolean  pset.temporary true

    cpu
      int     cpu.sys_id 1
      string  cpu.comment 
      string  cpu.status on-line

    cpu
      int     cpu.sys_id 0
      string  cpu.comment 
      string  cpu.status on-line</pre></div><p class="calibre7">Amazing! To remove<a id="id742" class="calibre1"/> the <code class="email">dedicated-cpu</code> resource from <code class="email">zone1</code>, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">remove dedicated-cpu</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
</pre></div><p class="calibre7">Before continuing, we must reboot the zone by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
</pre></div><p class="calibre7">Another good technique<a id="id743" class="calibre1"/> to control zone resources is using the <code class="email">capped-cpu</code> resource, which permits us to specify how big a percentage of a CPU the zone can use. The value to be specified means a percentage of CPUs, and this procedure can be performed by executing the following sequence:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">add capped-cpu</strong>
zonecfg:zone1:capped-cpu&gt; <strong class="calibre8">set ncpus=2.5</strong>
zonecfg:zone1:capped-cpu&gt; <strong class="calibre8">end</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
</pre></div><p class="calibre7">According to the previous configuration, the <code class="email">ncpus=2.5</code> attribute means 250 percent of CPUs or 2.5 CPUs. To<a id="id744" class="calibre1"/> remove the recently added resource, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">remove capped-cpu</strong>
zonecfg:zone1:capped-cpu&gt; <strong class="calibre8">end</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
</pre></div><p class="calibre7">After all the changes, we have to reboot the zone by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
</pre></div><p class="calibre7">This is outstanding! We have <a id="id745" class="calibre1"/>executed many trials with resource management, and all of them have worked! As <code class="email">zone1</code> still has a resource capping (memory), it is time to remove it:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z zone1</strong>
zonecfg:zone1&gt; <strong class="calibre8">remove capped-memory</strong>
zonecfg:zone1&gt; <strong class="calibre8">verify</strong>
zonecfg:zone1&gt; <strong class="calibre8">commit</strong>
zonecfg:zone1&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~# <strong class="calibre8">zoneadm -z zone1 shutdown -r</strong>
</pre></div><p class="calibre7">Finally, the resource capping feature can be disabled by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep rcap</strong>
online         18:49:28 svc:/system/rcap:default
root@solaris11-1:~# <strong class="calibre8">rcapadm -D</strong>
                                      state: disabled
           memory cap enforcement threshold: 0%
                    process scan rate (sec): 15
                 reconfiguration rate (sec): 60
                          report rate (sec): 5
                    RSS sampling rate (sec): 5
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep rcap</strong>
disabled       19:28:33 svc:/system/rcap:default</pre></div><p class="calibre7">Another way of disabling the resource capping feature would be to execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcadm disable svc:/system/rcap:default</strong>
</pre></div><p class="calibre7">Perfect! Everything has returned to the initial setup.</p><div><div><div><div><h3 class="title2"><a id="ch04lvl3sec44" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">This section was<a id="id746" class="calibre1"/> very long, and we could learn lots of details <a id="id747" class="calibre1"/>about resource management controls and how to limit processors and the memory. In the next chapter, we are going to handle the network resource control.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec59" class="calibre1"/>Implementing a flow control</h1></div></div></div><p class="calibre7">In the last subsection, we handled resource control on processors and memory. In Oracle Solaris 11, the network control has acquired importance and relevance, allowing us to set a network flow control based on TCP/IP services and ports. Read the next pages to learn a bit more.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec92" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual<a id="id748" class="calibre1"/> machine (VMware or VirtualBox) that runs Oracle Solaris 11 on one processor, with 4 GB RAM and one physical network interface. To make our life simpler, we are going to reuse the same environment as the one in the previous recipes.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec93" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">To be able to follow the steps in this section, you need to check the current environment setup. Therefore, it is possible to gather information about existing virtual interfaces, virtual switches, and network interfaces by running the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dladm show-vnic</strong>
LINK           OVER        SPEED  MACADDRESS        MACADDRTYPE  VID
vnic0          vswitch1    40000  2:8:20:d:b:3b     random       0
vnic1          vswitch1    40000  2:8:20:ef:b6:63   random       0
zone1/vnic1    vswitch1    40000  2:8:20:ef:b6:63   random       0
vnic2          vswitch1    40000  2:8:20:ce:b0:da   random       0
zone2/vnic2    vswitch1    40000  2:8:20:ce:b0:da   random       0
zone2/net0     net0        1000   2:8:20:f3:29:68   random       0
zone1/net0     net0        1000   2:8:20:ac:7d:b1   random       0
root@solaris11-1:~# <strong class="calibre8">dladm show-link</strong>
LINK                CLASS     MTU    STATE    OVER
net1                phys      1500   up       --
net0                phys      1500   up       --
vswitch1            etherstub 9000   unknown  --
vnic0               vnic      9000   up       vswitch1
vnic1               vnic      9000   up       vswitch1
zone1/vnic1         vnic      9000   up       vswitch1
vnic2               vnic      9000   up       vswitch1
zone2/vnic2         vnic      9000   up       vswitch1
zone2/net0          vnic      1500   up       net0
zone1/net0          vnic      1500   up       net0</pre></div><p class="calibre7">As the existing virtual interfaces are currently assigned to non-global zones, create a new <strong class="calibre8">virtual interface</strong> (<strong class="calibre8">VNIC</strong>) and associate<a id="id749" class="calibre1"/> it with the <code class="email">vswitch</code> virtual switch by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">dladm create-vnic -l vswitch1 vnic5</strong>
root@solaris11-1:~# <strong class="calibre8">dladm show-vnic</strong>
LINK          OVER         SPEED  MACADDRESS        MACADDRTYPE   VID
vnic0         vswitch1     40000  2:8:20:d:b:3b     random        0
vnic1         vswitch1     40000  2:8:20:ef:b6:63   random        0
zone1/vnic    vswitch1     40000  2:8:20:ef:b6:63   random        0
vnic2         vswitch1     40000  2:8:20:ce:b0:da   random        0
zone2/vnic2   vswitch1     40000  2:8:20:ce:b0:da   random        0
zone2/net0    net0         1000   2:8:20:f3:29:68   random        0
zone1/net0    net0         1000   2:8:20:ac:7d:b1   random        0
vnic5         vswitch1     40000  2:8:20:c0:9a:f7   random        0</pre></div><p class="calibre7">Create two flow controls on <code class="email">vnic5</code>: the first one controls the TCP flow in the port <code class="email">80</code> and the second one controls UDP in the same port <code class="email">80</code> by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">flowadm show-flow</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm add-flow -l vnic5 -a transport=tcp,local_port=80 http_tcp_1</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm add-flow -l vnic5 -a transport=udp,local_port=80 http_udp_1</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm show-flow</strong>
FLOW        LINK          IPADDR         PROTO  LPORT   RPORT   DSFLD
http_tcp_1  vnic5         --             tcp    80      --      --
http_udp_1  vnic5         --             udp    80      --      --</pre></div><p class="calibre7">According to the previous output, we named the flow controls <code class="email">http_tcp_1</code> and <code class="email">http_udp_1</code>; both control the HTTP data and use TCP and UDP as the transport protocol, respectively. Therefore, it is appropriate to bind a new property to this HTTP flow to control the maximum possible bandwidth and limit it to 50 MBps. Thus, run the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">flowadm set-flowprop -p maxbw=50M http_tcp_1</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm set-flowprop -p maxbw=50M http_udp_1</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm show-flowprop</strong> 
FLOW         PROPERTY        VALUE          DEFAULT        POSSIBLE
http_tcp_1   maxbw              50          --             -- 
http_udp_1   maxbw              50          --             -- 
root@solaris11-1:~#</pre></div><p class="calibre7">We have set the bandwidth limit for port <code class="email">80</code> (TCP and UDP) to 50 MBps at maximum. A specific flow can be monitored in a<a id="id750" class="calibre1"/> two-second interval for the received packages (illustrated in our recipe) by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">flowstat -r http_tcp_1 -i 2</strong>
           FLOW    IPKTS   RBYTES   IDROPS
     http_tcp_1        0        0        0
     http_tcp_1        0        0        0
     http_tcp_1        0        0        0
     http_tcp_1        0        0        0</pre></div><p class="calibre7">Additionally, it is recommended that you analyze a more complete view, including sent and received packets, by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">flowstat -i 2</strong>
           FLOW    IPKTS   RBYTES   IDROPS    OPKTS   OBYTES   ODROPS
     http_tcp_1        0        0        0        0        0        0
     http_udp_1        0        0        0        0        0        0
     http_tcp_1        0        0        0        0        0        0
     http_udp_1        0        0        0        0        0        0
     http_tcp_1        0        0        0        0        0        0
     http_udp_1        0        0        0        0        0        0</pre></div><p class="calibre7">Finally, to remove both flow controls from the system and the <code class="email">vnic5</code> interface, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">flowadm</strong>
FLOW        LINK          IPADDR         PROTO  LPORT   RPORT   DSFLD
http_tcp_1  vnic5         --             tcp    80      --      --
http_udp_1  vnic5         --             udp    80      --      --
root@solaris11-1:~# <strong class="calibre8">flowadm remove-flow http_tcp_1</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm remove-flow http_udp_1</strong>
root@solaris11-1:~# <strong class="calibre8">flowadm show-flow</strong>
root@solaris11-1:~# <strong class="calibre8">dladm delete-vnic vnic5</strong>
root@solaris11-1:~# <strong class="calibre8">dladm show-vnic</strong>
LINK           OVER       SPEED  MACADDRESS        MACADDRTYPE    VID
vnic0          vswitch1   40000  2:8:20:d:b:3b     random         0
vnic1          vswitch1   40000  2:8:20:ef:b6:63   random         0
zone1/vnic1    vswitch1   40000  2:8:20:ef:b6:63   random         0
vnic2          vswitch1   40000  2:8:20:ce:b0:da   random         0
zone2/vnic2    vswitch1   40000  2:8:20:ce:b0:da   random         0
zone2/net0     net0       1000   2:8:20:f3:29:68   random         0
zone1/net0     net0       1000   2:8:20:ac:7d:b1   random         0</pre></div><div><div><div><div><h3 class="title2"><a id="ch04lvl3sec45" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">This recipe showed <a id="id751" class="calibre1"/>you how to implement, monitor, and unconfigure the flow over <strong class="calibre8">virtual network interfaces</strong> (<strong class="calibre8">VNICs</strong>), limiting the bandwidth to 50 MBps in port <code class="email">80</code> for the TCP and UDP protocols.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec60" class="calibre1"/>Working with migrations from physical Oracle Solaris 10 hosts to Oracle Solaris 11 Zones</h1></div></div></div><p class="calibre7">Two common questions<a id="id752" class="calibre1"/> arise when considering how to deploy Oracle Solaris 11. First, what can we do with the previous<a id="id753" class="calibre1"/> Oracle Solaris 10 installation? Second (and worse), what is possible with Oracle Solaris 10 Zones?</p><p class="calibre7">Happily, Oracle Solaris 11 provides an optimal solution for both cases: the <a id="id754" class="calibre1"/>
<strong class="calibre8">physical to virtual</strong> (<strong class="calibre8">P2V</strong>) migration where a physical Oracle Solaris 10 installation is migrated to Oracle Solaris 11 Zone and the<a id="id755" class="calibre1"/> <strong class="calibre8">virtual to virtual</strong> (<strong class="calibre8">V2V</strong>) migration where an Oracle Solaris 10 native zone is migrated to a Solaris 10 branded zone on Oracle Solaris 11.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec94" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires one virtual machine (VirtualBox or VMware) with Oracle Solaris 11 installed, 8 GB RAM, and enough free space on disk (about 10 GB). To make things easier, the pool myzone (from the previous recipe) will be used, and if you have deleted it, you should create it again using the <code class="email">zpool create myzone &lt;disks&gt;</code> command. Furthermore, there must be an Oracle Solaris 10 virtual machine (2 GB RAM and a virtual disk with 15 GB at least) that should be used in this migration example. The installation of this Oracle Solaris 10 virtual machine will not be shown here. The Oracle Solaris 10 DVD<a id="id756" class="calibre1"/> for its installation and deployment can be downloaded from <a class="calibre1" href="http://www.oracle.com/technetwork/server-storage/solaris10/downloads/index.html?ssSourceSiteId=ocomau">http://www.oracle.com/technetwork/server-storage/solaris10/downloads/index.html?ssSourceSiteId=ocomau</a>.</p><p class="calibre7">Our task is to migrate a physical (global zone) Oracle Solaris 10 host (without any non-global zones inside) to an Oracle Solaris 11 zone. The steps to migrate an Oracle Solaris 10 native zone to an Oracle Solaris 11 brand10 zone are very similar, and they will not be shown.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec95" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">To migrate a physical Oracle Solaris 10 (global zone) to Oracle Solaris 11 Solaris 10 branded zone, it's advisable to collect any information (the hostname, host ID, amount of memory, operating system <a id="id757" class="calibre1"/>version, available disks, and so on) about Oracle Solaris 10 before executing the migration steps. From now, every <a id="id758" class="calibre1"/>time we see the <code class="email">bash-3.2#</code> prompt, it will mean that we are working on Oracle Solaris 10. The information can be collected by executing the following simple commands:</p><div><pre class="programlisting">
<strong class="calibre8"># bash</strong>
bash-3.2# <strong class="calibre8">uname -a</strong>
SunOS solaris10 5.10 Generic_147148-26 i86pc i386 i86pc
bash-3.2# <strong class="calibre8">hostname</strong>
solaris10
bash-3.2# <strong class="calibre8">ping 192.168.1.1</strong>
192.168.1.1 is alive
bash-3.2# <strong class="calibre8">hostid</strong>
37e12f92
bash-3.2# <strong class="calibre8">prtconf | grep -i memory</strong>
Memory size: 2048 Megabytes
bash-3.2# <strong class="calibre8">more /etc/release</strong>
                    Oracle Solaris 10 1/13 s10x_u11wos_24a X86
  Copyright (c) 1983, 2013, Oracle and/or its affiliates. All rights reserved.
                            Assembled 17 January 2013
bash-3.2# <strong class="calibre8">ifconfig -a</strong>
lo0: flags=2001000849&lt;UP,LOOPBACK,RUNNING,MULTICAST,IPv4,VIRTUAL&gt; mtu 8232 index 1
        inet 127.0.0.1 netmask ff000000
e1000g0: flags=1004843&lt;UP,BROADCAST,RUNNING,MULTICAST,DHCP,IPv4&gt; mtu 1500 index 2
        inet 192.168.1.108 netmask ffffff00 broadcast 192.168.1.255
        ether 8:0:27:49:c4:39
bash-3.2#
bash-3.2# <strong class="calibre8">zpool list</strong>
no pools available
bash-3.2# <strong class="calibre8">df -h</strong>
Filesystem             size   used  avail capacity  Mounted on
/dev/dsk/c0t0d0s0       37G   4.2G    33G    12%    /
/devices                 0K     0K     0K     0%    /devices
ctfs                     0K     0K     0K     0%    /system/contract
proc                     0K     0K     0K     0%    /proc
mnttab                   0K     0K     0K     0%    /etc/mnttab
swap                   3.1G   992K   3.1G     1%    /etc/svc/volatile
objfs                    0K     0K     0K     0%    /system/object
sharefs                  0K     0K     0K     0%    /etc/dfs/sharetab
/usr/lib/libc/libc_hwcap1.so.1
                        37G   4.2G    33G    12%    /lib/libc.so.1
fd                       0K     0K     0K     0%    /dev/fd
swap                   3.1G    72K   3.1G     1%    /tmp
swap                   3.1G    32K   3.1G     1%    /var/run
bash-3.2# <strong class="calibre8">format</strong>
Searching for disks...done

AVAILABLE DISK SELECTIONS:
       0. c0t0d0 &lt;ATA    -VBOX HARDDISK  -1.0  cyl 5218 alt 2 hd 255 sec 63&gt;
          /pci@0,0/pci8086,2829@d/disk@0,0
Specify disk (enter its number): ^D
bash-3.2#</pre></div><p class="calibre7">Now that we have already<a id="id759" class="calibre1"/> collected all the necessary information from the Oracle Solaris 10 virtual machine, the <code class="email">zonep2vchk</code> command is <a id="id760" class="calibre1"/>executed to verify the P2V migration compatibility and whether this procedure is possible:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">zonep2vchk -b</strong>
--Executing Version: 5.10.1.1

  - Source System: solaris10
      Solaris Version: Oracle Solaris 10 1/13 s10x_u11wos_24a X86
      Solaris Kernel:  5.10 Generic_147148-26
      Platform:        i86pc i86pc

  - Target System:
      Solaris Version: Solaris 10
      Zone Brand:      native (default)
      IP type:         shared

--Executing basic checks

  - The following SMF services will not work in a zone:

        svc:/network/iscsi/initiator:default
        svc:/system/iscsitgt:default

  - The following SMF services require ip-type "exclusive" to work in
    a zone. If they are needed to support communication after migrating
    to a shared-IP zone, configure them in the destination system's global
    zone instead:

        svc:/network/ipsec/ipsecalgs:default
        svc:/network/ipsec/policy:default
        svc:/network/routing-setup:default

  - When migrating to an exclusive-IP zone, the target system must have an
    available physical interface for each of the following source system
    interfaces:

        e1000g0

  - When migrating to an exclusive-IP zone, interface name changes may
    impact the following configuration files:

        /etc/hostname.e1000g0
        /etc/dhcp.e1000g0

  - Dynamically assigned IP addresses are configured on the following
    interfaces. These addresses are not supported with shared-IP zones.
    Use an exclusive-IP zone or replace any dynamically assigned addresses
    with statically assigned addresses. These IP addresses could change
    as a result of MAC address changes. You may need to modify this
    system's address information on the DHCP server and on the DNS,
    LDAP, or NIS name servers:

        DHCP assigned address on: e1000g0

  Basic checks complete. Issue(s) detected: 9

--Total issue(s) detected: 9</pre></div><p class="calibre7">There are no critical issues (it is recommended that you examine this report line by line) so we are able to proceed <a id="id761" class="calibre1"/>with the migration<a id="id762" class="calibre1"/> in order to create a zone configuration file by executing the following sequence of commands:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">mkdir /migration</strong>
bash-3.2# <strong class="calibre8">zonep2vchk -c &gt; /migration/solaris10.cfg</strong>
bash-3.2# <strong class="calibre8">vi /migration/solaris10.cfg</strong>
bash-3.2# <strong class="calibre8">more /migration/solaris10.cfg</strong>
create -b
set zonepath=/zones/solaris10
add attr
        set name="zonep2vchk-info"
        set type=string
        set value="p2v of host solaris10"
        end
set ip-type=shared
# Uncomment the following to retain original host hostid:
# set hostid=37e12f92
# maximum lwps based on max_uproc/v_proc
set max-lwps=57140
add attr
        set name=num-cpus
        set type=string
        set value="original system had 1 cpus"
        end
# Only one of dedicated or capped CPU can be used.
# Uncomment the following to use capped CPU:
# add capped-cpu
#       set ncpus=1.0
#       end
# Uncomment the following to use dedicated CPU:
# add dedicated-cpu
#       set ncpus=1
#       end
# Uncomment the following to use memory caps.
# Values based on physical memory plus swap devices:
# add capped-memory
#       set physical=2048M
#       set swap=6142M
#       end
# Original configuration for interface: e1000g0:
#    Statically defined ip address: 192.168.1.108 (solaris10)
#  * DHCP assigned ip address: 192.168.1.108/24 (solaris10)
#    MAC address: Factory assigned: 8:0:27:49:c4:39
#    Unable to migrate addresses marked with "*".
#    Shared IP zones require statically assigned addresses.
add net
        set address=solaris10
        set physical=change-me
        end
exit
bash-3.2#</pre></div><p class="calibre7">From this previous file, some<a id="id763" class="calibre1"/> changes were made<a id="id764" class="calibre1"/> as shown in the following command lines (in bold and self-explanatory). The new migrating configuration file looks like the following output:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">vi /migration/solaris10.cfg</strong>

<strong class="calibre8">#create -b</strong>
<strong class="calibre8">create -t SYSsolaris10</strong>

#set zonepath=/zones/solaris10
<strong class="calibre8">set zonepath=/myzones/solaris10</strong>
add attr
        set name="zonep2vchk-info"
        set type=string
        set value="p2v of host solaris10"
        end
set ip-type=shared
<strong class="calibre8">remove anet</strong>
# Uncomment the following to retain original host hostid:
<strong class="calibre8">set hostid=37e12f92</strong>
# maximum lwps based on max_uproc/v_proc
set max-lwps=57140
add attr
        set name=num-cpus
        set type=string
        set value="original system had 1 cpus"
        end
# Only one of dedicated or capped CPU can be used.
# Uncomment the following to use capped CPU:
# add capped-cpu
#       set ncpus=1.0
#       end
# Uncomment the following to use dedicated CPU:
# add dedicated-cpu
#       set ncpus=1
#       end
# Uncomment the following to use memory caps.
# Values based on physical memory plus swap devices:
# add capped-memory
#       set physical=2048M
#       set swap=1024M
#       end
# Original configuration for interface: e1000g0:
#    Statically defined ip address: 192.168.1.108 (solaris10)
#  * DHCP assigned ip address: 192.168.1.108/24 (solaris10)
#    MAC address: Factory assigned: 8:0:27:49:c4:39
#    Unable to migrate addresses marked with "*".
#    Shared IP zones require statically assigned addresses.
<strong class="calibre8">add net</strong>
        <strong class="calibre8">set address=192.168.1.124</strong>
        <strong class="calibre8">set physical=net0</strong>
        <strong class="calibre8">end</strong>
exit</pre></div><p class="calibre7">Before continuing the procedure, we have to verify that there is only a global zone (our initial purpose is to migrate an Oracle<a id="id765" class="calibre1"/> Solaris 10 host <a id="id766" class="calibre1"/>without containing inside zones) by running the following command:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">zoneadm list -iv</strong>
ID NAME           STATUS     PATH                     BRAND    IP
 0 global         running    /                        native   shared</pre></div><p class="calibre7">This is great! Now, it is time to create an image (<code class="email">solaris10.flar</code>) from the original Oracle Solaris 10 global zone, excluding the directory where the image will be saved (<code class="email">-x /migration</code>) in order to prevent a recursion effect by executing the following command:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">flarcreate -S -n solaris10 -x /migration /migration/solaris10.flar</strong>
Full Flash
Checking integrity...
Integrity OK.
Running precreation scripts...
Precreation scripts done.
Creating the archive...
8417435 blocks
Archive creation complete.
Running postcreation scripts...
Postcreation scripts done.

Running pre-exit scripts...
Pre-exit scripts done.</pre></div><p class="calibre7">After some time, check the created file by running the following command:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">ls -lh /migration/solaris10.flar</strong>
-rw-r--r--   1 root     root        4.0G Feb 11 17:32 /migration/solaris10.flar</pre></div><p class="calibre7">This FLAR image will be used in the following steps from the Oracle Solaris 11 machine, and it is important to share its directory by running the following commands:</p><div><pre class="programlisting">bash-3.2# <strong class="calibre8">share /migration</strong>
bash-3.2# <strong class="calibre8">share</strong>
-               /migration   rw   ""</pre></div><p class="calibre7">Switching to another<a id="id767" class="calibre1"/> machine (<code class="email">solaris11-1</code>), which is running Oracle Solaris 11, it is necessary to create a ZFS<a id="id768" class="calibre1"/> filesystem to migrate the Oracle Solaris 10 installation into this filesystem as a non-global zone. Therefore, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zfs create myzones/solaris10</strong>
root@solaris11-1:~# <strong class="calibre8">zfs list myzones/solaris10</strong>
NAME               USED  AVAIL  REFER  MOUNTPOINT
myzones/solaris10   31K  77.4G    31K  /myzones/solaris10</pre></div><p class="calibre7">As the <code class="email">solaris10.flar</code> image is going to be accessed in order to transfer the Oracle Solaris 10 content from the Oracle Solaris 10 physical host, the connection to the NFS share (<code class="email">/migration</code>) from the Oracle Solaris 11 host (<code class="email">solaris11-1</code>) has to be verified by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">showmount -e 192.168.1.108</strong>
export list for 192.168.1.108:
/migration (everyone)

root@solaris11-1:~#</pre></div><p class="calibre7">It is time to execute the migration steps. Mount the NFS share in <code class="email">/mnt</code> by running the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">mount -F nfs 192.168.1.108:/migration /mnt</strong>
root@solaris11-1:~# <strong class="calibre8">df -h | grep migration</strong>
192.168.1.108:/migration    37G   8.2G        29G    23%    /mnt</pre></div><p class="calibre7">Create the non-global zone in the Oracle Solaris 11 host (<code class="email">solaris11-1</code>) using the saved Solaris 10<a id="id769" class="calibre1"/> configuration file (<code class="email">solaris10.cfg</code>) created in a previous step by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zonecfg -z solaris10 -f /mnt/solaris10.cfg</strong> 
root@solaris11-1:~# <strong class="calibre8">zonecfg -z solaris10 info</strong>
zonename: solaris10
zonepath: /myzones/solaris10
brand: solaris10
autoboot: false
bootargs: 
pool: 
limitpriv: 
scheduling-class: 
ip-type: shared
hostid: 37e12f92
fs-allowed: 
[max-lwps: 57140]
net:
  address: 192.168.1.124
  allowed-address not specified
  configure-allowed-address: true
  physical: net0
  defrouter not specified
attr:
  name: zonep2vchk-info
  type: string
  value: "p2v of host solaris10"
attr:
  name: num-cpus
  type: string
  value: "original system had 1 cpus"
rctl:
  name: zone.max-lwps
  value: (priv=privileged,limit=57140,action=deny)</pre></div><p class="calibre7">Finally, we install the<a id="id770" class="calibre1"/> zone using the <code class="email">solaris10.flar</code> image by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm -z solaris10 install -a /mnt/solaris10.flar -u</strong>
/myzones/solaris10 must not be group readable.
/myzones/solaris10 must not be group executable.
/myzones/solaris10 must not be world readable.
/myzones/solaris10 must not be world executable.
changing zonepath permissions to 0700.
Progress being logged to /var/log/zones/zoneadm.20140212T033711Z.solaris10.install
    Installing: This may take several minutes...
Postprocessing: This may take a while...
   Postprocess: Updating the image to run within a zone

        Result: Installation completed successfully.
Log saved in non-global zone as /myzones/solaris10/root/var/log/zones/zoneadm.20140212T033711Z.solaris10.install</pre></div><p class="calibre7">After the previous step, it is recommended <a id="id771" class="calibre1"/>that you verify whether the <code class="email">solaris10</code> zone is installed and<a id="id772" class="calibre1"/> configured correctly by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm list -cv</strong>
ID NAME        STATUS     PATH                      BRAND     IP    
 0 global      running    /                         solaris   shared
 1 zone1       running    /myzones/zone1            solaris   excl  
 2 zone2       running    /myzones/zone2            solaris   excl  
 - solaris10   installed  /myzones/solaris10        solaris10 shared
root@solaris11-1:~# <strong class="calibre8">zoneadm -z solaris10 boot</strong>
zone 'solaris10': WARNING: net0: no matching subnet found in netmasks(4): 192.168.1.124; using default of 255.255.255.0.
zone 'solaris10': Warning: "/usr/lib/netsvc/rstat/rpc.rstatd" is not installed in the global zone</pre></div><p class="calibre7">After booting the zone, check its status again by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zoneadm list -cv</strong>
 ID NAME         STATUS     PATH                     BRAND    IP    
 0 global        running    /                        solaris  shared
 1 zone1         running    /myzones/zone1           solaris  excl  
 2 zone2         running    /myzones/zone2           solaris  excl  
 4 solaris10     running    /myzones/solaris10       solaris10 shared</pre></div><p class="calibre7">Log in to the new zone and verify that it is an Oracle Solaris 10 installation, as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">zlogin solaris10</strong>
[Connected to zone 'solaris10' pts/2]
Last login: Tue Feb 11 16:04:11 on console
Oracle Corporation  SunOS 5.10  Generic Patch  January 2005

# <strong class="calibre8">bash</strong>
bash-3.2# <strong class="calibre8">uname -a</strong>
SunOS solaris10 5.10 Generic_Virtual i86pc i386 i86pc

bash-3.2# <strong class="calibre8">more /etc/release</strong>
                    Oracle Solaris 10 1/13 s10x_u11wos_24a X86
  Copyright (c) 1983, 2013, Oracle and/or its affiliates. All rights reserved.
                            Assembled 17 January 2013

bash-3.2# <strong class="calibre8">ping 192.168.1.1</strong>
192.168.1.1 is alive
bash-3.2#</pre></div><p class="calibre7">This is amazing! We have migrated the Oracle Solaris 10 host to a solaris10 branded zone in the Oracle Solaris 11 host.</p><div><div><div><div><h3 class="title2"><a id="ch04lvl3sec46" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">Using no extra or <a id="id773" class="calibre1"/>external tools, we've learned<a id="id774" class="calibre1"/> how to migrate an Oracle Solaris 10 physical host to a Oracle Solaris 11 non-global zone using the <code class="email">zonep2vchk</code>, <code class="email">flarcreate</code>, and <code class="email">zonecfg</code> commands.</p></div></div></div>
<div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec61" class="calibre1"/>References</h1></div></div></div><div><ul class="itemizedlist"><li class="listitem"><em class="calibre11">Oracle Solaris SDN and</em><a id="id775" class="calibre1"/><em class="calibre11"> Network Virtualization</em> at <a class="calibre1" href="http://www.oracle.com/technetwork/server-storage/solaris11/technologies/networkvirtualization-312278.html">http://www.oracle.com/technetwork/server-storage/solaris11/technologies/networkvirtualization-312278.html</a></li><li class="listitem"><em class="calibre11">Oracle Solaris 11.1 Administration: Oracle Solaris Zones, Oracle Solaris 10 Zones, and Resource Management</em> (<a class="calibre1" href="http://docs.oracle.com/cd/E26502_01/html/E29024/toc.html">http://docs.oracle.com/cd/E26502_01/html/E29024/toc.html</a>) at <a class="calibre1" href="http://docs.oracle.com/cd/E26502_01/html/E29024/z.conf.start-2.html#scrolltoc">http://docs.oracle.com/cd/E26502_01/html/E29024/z.conf.start-2.html#scrolltoc</a></li><li class="listitem"><em class="calibre11">Using Virtual Networks in Oracle Solaris 11.1</em> (<a class="calibre1" href="http://docs.oracle.com/cd/E26502_01/html/E28992/toc.html">http://docs.oracle.com/cd/E26502_01/html/E28992/toc.html</a>) at <a class="calibre1" href="http://docs.oracle.com/cd/E26502_01/html/E28992/gdyss.html#scrolltoc">http://docs.oracle.com/cd/E26502_01/html/E28992/gdyss.html#scrolltoc</a></li></ul></div></div></body></html>