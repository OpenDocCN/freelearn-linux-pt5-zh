<html><head></head><body>
        <section>

                            <header>
                    <h1 class="header-title">Remote Authentication</h1>
                </header>
            
            <article>
                
<p>In this chapter, we will discuss the following:</p>
<ul>
<li>Remote server/host access using SSH</li>
<li>SSH root login disable or enable</li>
<li>Key-based login into SSH for restricting remote access</li>
<li>Copying files remotely</li>
<li>Setting up a Kerberos server with Ubuntu</li>
<li>Using LDAP for user authentication and management</li>
</ul>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Remote server/host access using SSH</h1>
                </header>
            
            <article>
                
<p><span class="pln"><strong>Secure Shell</strong> (<strong>SSH</strong>) is a protocol that is used to log onto remote systems securely and is the most commonly used method for accessing remote Linux systems.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p><span class="pln">To see how to use SSH, you need two Ubuntu systems. One will be used as the server and the other as the client.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span class="pln">To use SSH, you can use freely available software called OpenSSH. Once the software is installed, it can be used by the <kbd>ssh</kbd></span> command. We will l<span class="pln">ook at how to use this tool in detail:</span></p>
<ol>
<li>If OpenSSH server is not already installed, it can be installed using the following command:</li>
</ol>
<pre>    <strong>sudo apt-get install openssh-server</strong></pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/a5148806-871d-4b0c-9cd7-2b2217734dd4.png" style="width:48.75em;height:23.50em;"/></span></p>
<ol start="2">
<li><span class="pln">Next, we need to install the client version of the software:</span></li>
</ol>
<pre>    <strong>sudo apt-get install openssh-client</strong></pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/d94f5a00-5f54-443b-8512-c616b38a6346.png" style="width:45.33em;height:19.00em;"/></span></p>
<ol start="3">
<li><span class="pln">For the latest versions, the SSH service starts running as soon as the software is installed. If it is not running by default, we can start the service by using the command:</span></li>
</ol>
<pre>    <strong>sudo service ssh start</strong>  </pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/0d20de2a-32d7-4441-93a2-158cc4dad0ec.png" style="width:31.50em;height:7.08em;"/></span></p>
<ol start="4">
<li>Now, to log in to the server from any other system using SSH, you can use the following command:</li>
</ol>
<pre>    <strong>ssh remote_ip_address</strong></pre>
<p class="CDPAlignLeft CDPAlign" style="padding-left: 90px"><span class="pln">Here, <kbd>remote_ip_address</kbd> refers to the IP address of the server system. Also, this command assumes that the username on the client machine is the same as on the server machine:</span></p>
<p class="CDPAlignCenter CDPAlign" style="padding-left: 30px"><span class="pln"><img src="assets/3f76ed43-360c-415b-9e8b-d8d43bbb84e9.png" style="width:51.50em;height:25.08em;"/></span></p>
<p style="padding-left: 90px"><span class="pln">If we want to log in for a different user, the command will be as follows:</span></p>
<pre>    <strong>ssh username@remote_ip_address</strong></pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/54c76c67-f170-4d43-8d48-1b1c51ac4b27.png" style="width:39.17em;height:19.17em;"/></span></p>
<ol start="5">
<li><span class="pln">N</span>ext, we need to configure SSH to use it as per o<span class="pln">ur requirements. The main configuration file for <kbd>sshd</kbd> in Ubuntu is located at <kbd>/etc/ssh/sshd_config</kbd>. Before making any changes to the original version of this file, create a backup using the following command:</span></li>
</ol>
<pre>    <strong>sudo cp /etc/ssh/sshd_config{,.bak}</strong></pre>
<p style="padding-left: 90px"><span class="pln">The configuration file defines the default settings for SSH on the server system.</span></p>
<ol start="6">
<li><span class="pln">Openin</span>g the file in a text editor, we can see that the default port declaration on which the <kbd>sshd</kbd> <span class="pln">server listens for the incoming connections is <kbd>22</kbd>. We can change this to any non-standard port to secure the server from random port scans, thus making it more secure. Suppose we change the port to <kbd>888</kbd>, then next time the client wants to connect to the SSH server, the command will be as follows:</span></li>
</ol>
<pre>    <strong>ssh -p port_numberremote_ip_address</strong></pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/0b88f5cb-b2b7-4620-86f2-06922c0a7b9d.png" style="width:40.75em;height:23.00em;"/></span></p>
<p><span class="pln">As you can see, when you run the command without specifying the port number, the connection is refused. When you mention the correct port number, the connection is established.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p><span class="pln">SSH is used to connect a client program to an SSH server. On one system we install the openssh-server package to make it the SSH server, and on the other system we will install the openssh-client package to use it as client.</span></p>
<p><span class="pln">Now, keeping the SSH service running on the server system, we try to connect to it through the client.</span></p>
<p><span class="pln">We use the configuration file of SSH to change settings such as the default port for connecting.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Enabling and disabling root login over SSH</h1>
                </header>
            
            <article>
                
<p><span class="pln">Linux systems have a root account that is enabled by default. Unauthorized users gaining root access to the system can be really dangerous.</span></p>
<p><span class="pln">We can disable or enable the root login for SSH as per our requirements to prevent the chances of an attacker getting access to the system.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p><span class="pln">We need two Linux systems to be used as server and client. On the server system, install the openssh-server package, as shown in the previous recipe.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span class="pln">First, we will see how to disable SSH root login and then we will also see how to enable it again:</span></p>
<ol>
<li><span class="pln">First, open the main configuration file of SSH, <kbd>/etc/ssh/sshd_config</kbd>, in any editor:</span></li>
</ol>
<pre>    <strong>sudo nano /etc/ssh/sshd_config</strong></pre>
<ol start="2">
<li><span class="pln">Now look for the line that reads as follows:</span></li>
</ol>
<pre>    <strong>PermitRootLogin yes</strong></pre>
<ol start="3">
<li><span class="pln">Change the value <kbd>yes</kbd> to <kbd>no</kbd>. Then save and close the file:</span></li>
</ol>
<pre>    <strong>PermitRootLogin no</strong></pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/881ddf81-a302-4956-aa44-3343a381d3f0.png" style="width:21.33em;height:5.75em;"/></span></p>
<ol start="4">
<li><span class="pln">Once done, restart the SSH daemon service using the following command:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/7d6bd4af-6b91-41a9-9a24-ba134444eb2e.png" style="width:32.08em;height:8.00em;"/></span></p>
<ol start="5">
<li><span class="pln">Now let's try to log in as root. We should get an error:</span></li>
</ol>
<pre style="padding-left: 60px"><span class="pln">"</span><span class="pln"><strong>Permission Denied</strong></span><span class="pln">" </span></pre>
<p style="padding-left: 90px"><span class="pln">This is because the root login has been disabled:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/3e4859dd-52e4-45e5-81fa-3207d3086e27.png" style="width:28.58em;height:7.17em;"/></span></p>
<ol start="6">
<li><span class="pln">Now whenever we want to log in as root, first we will have to log in as a normal user. And after that, we can use the </span><kbd><span class="pln">su</span></kbd><span class="pln"> command and switch to the root user. So, the user accounts that are not listed in the </span><kbd>/etc/sudoers</kbd> fi<span class="pln">le will not be able to switch to root user and the system will be more secure:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/9825a30e-c951-4512-a736-5c8248a50691.png" style="width:39.58em;height:25.42em;"/></span></p>
<ol start="7">
<li><span class="pln">Now if we want to enable SSH root login<span> again</span>, we just need to edit the <kbd>/etc/ssh/sshd_config</kbd> file again and change the <kbd>no</kbd> <span>option </span>to <kbd>yes</kbd></span><span class="pln">:</span></li>
</ol>
<pre>    <strong>PermitRootLogin yes</strong></pre>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/f8b5ab81-ce1b-4386-97e6-7f6ad3ddbd7b.png" style="width:20.58em;height:5.67em;"/></span></p>
<ol start="8">
<li><span class="pln">Then restart the service again by using the following command:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/1feee614-4e9c-450e-915a-5e0c65191744.png" style="width:29.00em;height:7.17em;"/></span></p>
<ol start="9">
<li><span class="pln">Now if we try to log in as root again, it will work:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/4e241d56-9841-4901-96ab-afb94784ba80.png" style="width:35.33em;height:13.83em;"/></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p><span class="pln">When we try to connect to a remote system using SSH, the remote system checks its configuration file at <kbd>/etc/ssh/sshd_config</kbd> and, according to the details mentioned in this file, it decides whether the connection should be allowed or refused.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">There's more...</h1>
                </header>
            
            <article>
                
<p><span class="pln">Suppose we have many user accounts on the systems. We need to edit the <kbd>/etc/ssh/sshd_config</kbd> file in such a way that remote access is allowed only for few mentioned users:</span></p>
<pre>    <strong>      sudo nano /etc/ssh/sshd_config</strong></pre>
<p><span class="pln">Add the following line:</span></p>
<pre>    <strong>      AllowUsers tajinder user1</strong></pre>
<p><span class="pln">Now restart the SSH service:</span></p>
<pre>    <strong>      sudo service ssh restart</strong></pre>
<p><span class="pln">Now when we try to log in with  <kbd>user1</kbd>, the login is successful. However, when we try to log in with <kbd>user2</kbd>, which has not been added in the <kbd>/etc/ssh/sshd_config</kbd> file, the login fails and we get  <span class="packt_screen">Permission denied</span></span> error, as show<span class="pln">n here:</span></p>
<p class="CDPAlignCenter CDPAlign"><span class="pln"><img src="assets/645f50bd-8e03-474b-8e58-412c17107a6b.png" style="width:36.75em;height:20.67em;"/></span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Key-based login into SSH for restricting remote access</h1>
                </header>
            
            <article>
                
<p><span class="pln">Even though SSH login is protected by using passwords for the user account, we can make it more secure by using key-based authentication into SSH.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p><span class="pln">To see how key-based authentication works, we need two Linux systems (in our example, both are Ubuntu systems). We should have the OpenSSH server package installed on them.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span class="pln">To use key-based authentication, we need to create a pair of keys – a private key and a public key:</span></p>
<ol>
<li><span class="pln">On the client or local system,  execute the following command to generate the SSH key pairs:</span></li>
</ol>
<pre>    <strong>      ssh-keygen -t rsa<br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0b1e4303-998d-4fdb-adcb-55f4fd96c71c.png" style="width:39.50em;height:26.75em;"/></p>
<p style="padding-left: 90px"><span class="pln">While creating the key, we can accept the default values or change them as we wish. It will also ask for a passphrase, for which you can choose anything or leave it blank.</span></p>
<ol start="2">
<li><span class="pln">The key-pair will be created in the location -</span> <kbd>~./ssh/</kbd><span class="pln">. Change to this directory and then use the  <kbd>ls -l</kbd> <span>command </span>to see the details of the key files:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5b50e052-01ea-4cee-91d5-37d752ebc309.png" style="width:29.83em;height:7.83em;"/></p>
<p style="padding-left: 90px"><span class="pln">We can see that the <kbd>id_rsa</kbd> file can be read and written only by the owner. This permission ensures that the file is kept secure.</span></p>
<ol start="3">
<li><span class="pln">Now we need to copy the public key file to the remote SSH server. To do so, we run the following command:</span></li>
</ol>
<pre><strong>      <span class="pln">ssh-copy-id 192.168.1.101</span></strong>  </pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1b169101-55dd-46e0-9625-614630024bc0.png" style="width:44.25em;height:16.75em;"/></p>
<p style="padding-left: 90px"><span class="pln">An SSH session will be started and prompt for entering the password for the user account. Once the correct password has been entered, the key will be copied to the remote server.</span></p>
<ol start="4">
<li><span class="pln">Once the public key has been successfully copied to the remote server, try to log in to the server again using the following command:</span></li>
</ol>
<pre>    <strong>      <span class="pln">ssh 192.168.1.101</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3e99f278-0f7f-490e-b86d-cb86a4ad32e0.png" style="width:40.67em;height:18.33em;"/></p>
<p><span class="pln">We can see that now we are not prompted for the user account's password. Since we had configured the passphrase for the SSH key, it has not been asked for. Otherwise, it would have asked us for the password.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p><span class="pln">When we create the SSH key pair and move the public key to the remote system, it works as an authentication method for connecting to the remote system. If the public key present in the remote system matches the public key generated by the local system, and the local system also has the private key to complete the key-pair, the login happens. Otherwise, if any key file is missing, login is not allowed.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Copying files remotely</h1>
                </header>
            
            <article>
                
<p><span class="pln">Managing a system remotely is great using SSH. However, many do not know that SSH can also help in uploading and downloading files remotely.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting ready</h1>
                </header>
            
            <article>
                
<p><span class="pln">To try the file transfer tools, we need two Linux systems that can ping each other. We also need the  OpenSSH package to be installed on one system and the SSH server should be running.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span class="pln">Linux has a collection of tools that can help in transferring data between networked computers. We will see how a few of them work in this section:</span></p>
<ol>
<li><span class="pln">Suppose we have a <kbd>myfile.txt</kbd> <span>file </span>on the local system that we want to copy to the remote system. The command to do so as follows:</span></li>
</ol>
<pre><strong>      <span class="pln">scp myfile.txt tajinder@sshserver.com:~Desktop/</span></strong>  </pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/fe8a6b50-c38b-4fc5-8a0b-c041088402d5.png" style="width:43.17em;height:6.83em;"/></p>
<p style="padding-left: 90px"><span class="pln">Here, the remote location where the file will be copied is the <kbd>Desktop</kbd> directory of the user account being used to connect.</span></p>
<ol start="2">
<li><span class="pln">When we check on the remote SSH system, we can see that the <kbd>myfile.txt</kbd> <span>file </span>has been copied successfully:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d3f27372-2e74-41f7-b032-339bb3bca82b.png" style="width:30.25em;height:10.83em;"/></p>
<ol start="3">
<li><span class="pln">Now let's suppose we have a directory,  <kbd>mydata</kbd> in the local system, that we want to copy to the remote system. This can be done by using the  <kbd>-r</kbd>  option in the command:</span></li>
</ol>
<pre>    <strong>      <span class="pln">scp -r mydata/ tajinder@sshserver.com:~Desktop/</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/59cb1f9b-a48d-45d2-a9f0-dccb5faf4c78.png" style="width:43.25em;height:12.17em;"/></p>
<ol start="4">
<li><span class="pln">Again, we check on the remote server and see that the <kbd>mydata</kbd> directory has been copied with all its files:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/632e594f-e78c-4d04-9178-78073ce0ec30.png" style="width:33.75em;height:8.75em;"/></p>
<ol start="5">
<li><span class="pln">Now we will see how to copy a file from the remote system back to the local system.</span></li>
</ol>
<p style="padding-left: 90px"><span class="pln">First, create a file on the remote server. Our file is <kbd>newfile.txt</kbd>:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/30f93575-1d63-4da4-bdd1-927ef7691bcf.png" style="width:33.08em;height:5.58em;"/></p>
<ol start="6">
<li><span class="pln">Now, on the local system, move to the directory where you wish to copy the file.</span></li>
</ol>
<p style="padding-left: 90px"><span class="pln">Then run the command as shown to copy the file from the remote system to the local system, in the current directory:</span></p>
<pre>    <strong>      <span class="pln">scp -r tajinder@sshserver.com:/home/tajinder/Desktop/newfile.txt .</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/4a077ce5-eefc-4bde-96a4-ac72fa1f0b85.png" style="width:43.00em;height:14.75em;"/></p>
<ol start="7">
<li><span class="pln">You can also use <kbd>sftp</kbd> to interactively copy the files from the remote system, using <kbd>ftp</kbd> commands.</span></li>
<li><span class="pln">To do this, you first start the connection using the following command:</span></li>
</ol>
<pre>    <strong>      <span class="pln">sftp tajinder@sshserver.com</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a7666d3b-5534-4ca1-91f6-32bcfe1b76ea.png" style="width:32.50em;height:4.83em;"/></p>
<ol start="9">
<li><span class="pln">Next, you can run any <kbd>ftp</kbd> command. In our example, we try to get the file from the remote system using the <kbd>get </kbd>command, as shown:</span></li>
</ol>
<pre>    <strong>      <span class="pln">get sample.txt /home/tajinder/Desktop</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ce4a5bcc-8487-4693-b902-9007e972f84a.png" style="width:44.08em;height:7.75em;"/></p>
<ol start="10">
<li><span class="pln">In the local system, you can now check whether the file has been copied successfully or not:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/ebfa9908-0ad4-4d41-b650-bb42e949cc53.png" style="width:35.83em;height:6.75em;"/></p>
<ol start="11">
<li><span class="pln">SSH also works through Nautilus (the default file manager for GNOME desktop). So, instead of using the command line, we can use the GNOME File Explorer to start an SSH connection with the remote system.</span></li>
<li><span class="pln">In the GNOME File Explorer, go to <span class="packt_screen">File</span></span> | <span class="pln"><span class="packt_screen">Connect to Server.</span></span></li>
<li><span class="pln">In the next window, enter the details as required and click on <span class="packt_screen">Connect</span></span>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/30cd75b4-541f-498b-900f-de78e8089b4a.png" style="width:31.00em;height:23.00em;"/></p>
<ol start="14">
<li><span class="pln">Now we can copy the files graphically from the remote system to the local system, or vice versa:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/994edd3d-0432-424b-969d-d2c08d1a588c.png" style="width:36.50em;height:16.75em;"/></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p><span class="pln">To copy files remotely over SSH, we us</span>e the <kbd>scp</kbd> tool. Th<span class="pln">is helps copy a single file or a complete directory from the client system to a defined location on the server system. To copy a directory with all its content, we use the  <kbd>-r</kbd>  option with the command.</span></p>
<p><span class="pln">We use the same tool to copy files from the remote SSH server to the client machine. However, to do this we need to know the exact location of the file on the server.</span></p>
<p><span class="pln">Like <kbd>scp</kbd>, we also have the <kbd>sftp</kbd> tool, which is used to copy files over ftp from server to client. <strong>Secure File Transfer Protocol</strong> (<strong><span>SFTP</span></strong>) is better than FTP and ensures that data is transferred securely.</span></p>
<p><span class="pln">Lastly, we use the GNOME File Explorer to graphically connect and transfer files from server to client and vice versa.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Setting up a Kerberos server with Ubuntu</h1>
                </header>
            
            <article>
                
<p><span class="pln">Kerberos is an authentication protocol for allowing secure authentication over untrusted networks by using secret-key cryptography and trusted third parties.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting started</h1>
                </header>
            
            <article>
                
<p><span class="pln">To see Kerberos set up and running, we need three Linux systems (in our example we have used Ubuntu). They should be able to communicate with each other, and they should also have accurate system clocks.</span></p>
<p>We have set the hostname for each system is as follows:</p>
<ul>
<li><span class="pln">Kerberos system – <kbd>mykerberos.com</kbd></span></li>
<li><span class="pln">SSH Server system – <kbd>sshserver.com</kbd></span></li>
<li><span class="pln">Client system – <kbd>sshclient.com</kbd></span></li>
</ul>
<p><span class="pln">After doing this, edit the <kbd>/etc/hosts</kbd> file in each system and add the following details:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/91bc5316-eec3-47a8-a4b2-13ada980e1d3.png" style="width:31.50em;height:5.33em;"/></p>
<p><span class="pln">The IP address and the hostname can be different for your systems. Just make sure that after doing these changes they can still ping with each other.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span class="pln">Now let's see how to do the setup of Kerberos server and the other systems for our example:</span></p>
<ol>
<li><span class="pln">The first step is to install the Kerberos server. To do this, we will run the following command on the <kbd>mykerberos.com</kbd> system:</span></li>
</ol>
<pre><strong>      <span class="pln">sudo apt-get install krb5-admin-server krb5-kdc</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e662fc60-e395-4d6f-b1c6-af53f6273a3a.png" style="width:43.92em;height:24.17em;"/></p>
<ol start="2">
<li><span class="pln">During the installation process, a few questions will be asked. Enter the details as mentioned here.</span></li>
<li><span class="pln">For the question</span> <kbd>Default Kerberos version 5 realm</kbd>, <span class="pln">the answer in our case is  </span><kbd>v=spf1 ip6:fd1d:f5c3:ee7c6::/48 -all</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/6571be59-6f32-4c0e-8196-caf6610bd827.png" style="width:43.08em;height:23.25em;"/></p>
<ol start="4">
<li><span class="pln">For the next question,<span class="packt_screen"> </span></span><kbd>Kerberos servers for your realm?</kbd>, <span class="pln">the answer is</span> <kbd>mykerberos.com</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/0726344d-a76f-4f79-aeb6-8cad71da60c4.png" style="width:42.83em;height:17.67em;"/></p>
<ol start="5">
<li><span class="pln">In the next screen, the question is </span><kbd>Administrative server for your realm?</kbd><span class="pln"> and its answer is </span> <kbd>mykerberos.com</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/00b34ddc-adf8-4241-a7c2-33d50ddb7847.png" style="width:43.58em;height:17.25em;"/></p>
<p style="padding-left: 90px"><span class="pln">Once we have answered all the questions, the installation process will proceed.</span></p>
<ol start="6">
<li><span class="pln">The next step is to create a new realm. To do so, we use the following command:<br/></span></li>
</ol>
<pre><strong>      <span class="pln">sudo krb5_realm</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/64669e6b-3ede-4015-9888-413e4ead24a6.png" style="width:41.33em;height:18.83em;"/></p>
<p style="padding-left: 90px"><span class="pln">During this process, we will be asked to create a password for the Kerberos database. We can choose any password we want.</span></p>
<ol start="7">
<li><span class="pln">Next, we need to edit the <kbd>/etc/krb5.conf</kbd></span> file a<span class="pln">nd modify the details as shown here. If any line does not already exist in the file, we need to enter them as well. Go to the <kbd>libdefaults</kbd> section in the file and modify the value as shown:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/80b7cd73-91fa-4b11-96be-d61c8ca59e45.png" style="width:27.58em;height:3.92em;"/></p>
<p style="padding-left: 90px"><span class="pln">Move down to the <kbd>realms</kbd> section and modify the details as shown:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d0acc26c-9878-436b-81e4-03d0fca1037f.png" style="width:29.67em;height:6.50em;"/></p>
<p style="padding-left: 90px"><span class="pln">Next, go to <kbd>domain_realm</kbd> section and enter the lines as shown:</span></p>
<pre><strong>      <span class="pln">            mykerberos.com = MYKERBEROS.COM</span>
</strong><strong>      <span class="pln">            .mykerberos.com = MYKERBEROS.COM</span></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5edec1b8-1d09-450b-8464-183415a85e81.png" style="width:29.17em;height:15.67em;"/></p>
<ol start="8">
<li><span class="pln">Next, we need to add principles or entries into the Kerberos database that would represent users or services on the network, and to do this we will use the <kbd>kadmin.local</kbd> tool. The principle must be defined for every user that participates in Kerberos authentication.</span></li>
</ol>
<p style="padding-left: 90px"><span class="pln">Run the tool by typing the following:</span></p>
<pre><strong> <span class="pln">sudo kadmin.local</span></strong></pre>
<p style="padding-left: 90px">This will start the <kbd>kadmin.local</kbd> prompt, as shown:<strong><br/></strong></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/7ec9b300-674a-45c9-8e97-fdaf0214194f.png" style="width:40.92em;height:12.50em;"/></p>
<p style="padding-left: 90px"><span class="pln">To see the existing principles, we can type the following command:</span></p>
<pre><strong>      <span class="pln">list princs</span><br/></strong></pre>
<ol start="9">
<li><span class="pln">Now to add a principle for a user we use the <kbd>addprinc</kbd> command, as shown:</span></li>
</ol>
<p style="padding-left: 90px"><span class="pln">To add the  <kbd>tajinder </kbd> account we have used the following command:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d70103b1-dc10-42d3-846f-6a89d03382fd.png" style="width:44.75em;height:9.83em;"/></p>
<p style="padding-left: 90px"><span class="pln">To add an admin role to the account being added, the command will be as follows:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/354af7f6-1fe7-4d57-bfe4-09c5470f8d0e.png" style="width:43.58em;height:7.75em;"/></p>
<p style="padding-left: 90px"><span class="pln">If we give an admin role to any user, then uncomment <kbd>*/admin " linein /etc/krb5kdc/kadm.acl file</kbd></span>.</p>
<ol start="10">
<li><span class="pln">To check whether the principle has been applied correctly or not, use the following command:</span></li>
</ol>
<pre><strong>      <span class="pln">kinit</span><br/></strong></pre>
<ol start="11">
<li><span class="pln">Once you're done with the setup of the Kerberos system, we now move to the client system. First, we need to install the client package for Kerberos by using the following command:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/aa759eb3-cc58-4c92-ba40-ea4e356a58fd.png" style="width:41.83em;height:22.50em;"/></p>
<p style="padding-left: 90px"><span class="pln">During the installation process, it will ask the same questions that were asked during the installation of the Kerberos server. Enter the same details here that we entered earlier.</span></p>
<ol start="12">
<li><span class="pln">After completing the installation, check whether we are still able to ping mykerberos.com from the sshclient.com system.</span></li>
<li><span class="pln">Now, to get the ticket for the client machine, depending on the principle that we had created in mykerberos.com, the command to be used will be as follows:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/d1b81a08-b4eb-4e7c-bd7e-b36cd8e07aa2.png" style="width:33.50em;height:5.00em;"/></p>
<p style="padding-left: 90px"><span class="pln">If the command runs perfectly, it means it's working properly.</span></p>
<ol start="14">
<li><span class="pln">Once you're done with the previous command, we move to the third system, which we are using as SSH server. We need to install SSH server and the <kbd>krb5-config</kbd> package on this system. To do so, we run the command as shown:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/667c069c-a23e-4eea-be64-87a52b14df1c.png" style="width:38.25em;height:15.00em;"/></p>
<p style="padding-left: 90px"><span class="pln">Again, we will be asked the same questions that were asked during the installation of the Kerberos server. Enter the same details here as previously.</span></p>
<ol start="15">
<li><span class="pln">Now edit the <kbd>file/etc/ssh/sshd_config</kbd> file to enable the following lines:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/a0fc8df4-0fa7-4b62-a907-329cbace59c4.png" style="width:20.42em;height:5.17em;"/></p>
<p style="padding-left: 90px"><span class="pln">Remove the <kbd>#</kbd> and also change the value to <kbd>yes</kbd> if it is not changed already.</span></p>
<p style="padding-left: 90px"><span class="pln">After making the changes, restart the SSH server, using the following command:</span></p>
<pre><strong>      <span class="pln">sudo service ssh restart</span><br/></strong></pre>
<ol start="16">
<li><span class="pln">Next, we will configure the Kerberos server so that it works with the SSH server. To do so, run the</span> <kbd>kadmin.local</kbd> tool <span class="pln">and then run the commands shown:</span></li>
</ol>
<pre><strong>      <span class="pln">kadmin.local</span><br/></strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1f684d7f-cb56-49e7-abcc-c49d2aec9e3a.png" style="width:44.08em;height:7.75em;"/></p>
<p style="padding-left: 90px"><span class="pln">The previous command in the screenshot adds the principle for the SSH server.</span></p>
<p style="padding-left: 90px"><span class="pln">Next, we run the following command to create the key file:</span></p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e1e60422-bb8f-4c85-8a68-bb7f1394bc47.png" style="width:44.08em;height:13.33em;"/></p>
<ol start="17">
<li><span class="pln">Now we shall copy the key file from the Kerberos server system to the SSH server system, using the following command:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/3b9821ab-3ae7-4535-a675-d6dff63ab1b1.png" style="width:43.50em;height:6.92em;"/></p>
<p style="padding-left: 90px"><span class="pln">We have copied the file to <kbd>/tmp/</kbd> directory of the SSH server system. Once the copy completes, move the file to the <kbd>/etc/</kbd> directory.</span></p>
<ol start="18">
<li><span class="pln">Now on the client system, edit the file  <kbd>/etc/ssh/ssh_config</kbd>, and modify the lines as shown:</span></li>
</ol>
<pre>    <strong>GSSAPIAuthentication yes</strong>
    <strong>GSSAPIDelegateCredentials<span class="pln">yes</span></strong></pre>
<ol start="19">
<li><span class="pln">Now on the client system, get the ticket by running the command:<br/></span></li>
</ol>
<pre><strong>      <span class="pln">kinit tajinder</span><br/></strong></pre>
<ol start="20">
<li><span class="pln">Once this command works fine, try to log in into the SSH server system from the client system, using <kbd>ssh</kbd>.</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e788eb57-705a-431b-9ac7-6ce6fe116e4c.png" style="width:36.33em;height:12.50em;"/></p>
<p><span class="pln">We should get authenticated without being asked for the password.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How it works...</h1>
                </header>
            
            <article>
                
<p><span class="pln">First, we install the required packages on the first system to create a Kerberos server. After installation, a realm is created for the server configuration. To complete the configuration, we do the changes as mentioned in the <kbd>/etc/krb5.conf</kbd> file.</span></p>
<p><span class="pln">Then we add principle in the Kerberos database to add the user account to be used.</span></p>
<p><span class="pln">Once this is done, we move to the next system and install the Kerberos user package to create the client system. Then we get a ticket from the Kerberos server system for the user account to be used on the client.</span></p>
<p><span class="pln">Next, we proceed to the third system where we install the Openssh server package to create an SSH server. Then we edit the configuration file of SSH to enable authentication.</span></p>
<p><span class="pln">We now come back to the Kerberos server system and add a principle for the SSH server. We create a key for the SSH server and then transfer this key file from the Kerberos server to the SSH server using  the <kbd>scp</kbd>  command.</span></p>
<p><span class="pln">Now if we try to log in into the SSH server system from the client system, we get logged in without being asked for the password, as the key we generated earlier is being used for authentication.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Using LDAP for user authentication and management</h1>
                </header>
            
            <article>
                
<p><span class="pln"><strong>Lightweight Directory Access Protocol</strong> (<strong><span>LDAP</span></strong>) helps to keep authentication information in a centralized location. In this topic, we shall discuss the configuration of any client machine for remote authentication with the LDAP server.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">Getting started</h1>
                </header>
            
            <article>
                
<p><span class="pln">To proceed with the configuration of the client machine, we need a Linux machine configured as a LDAP server. This has already been covered in <a href="dd9ad20f-3479-47df-8819-358a6d9354ca.xhtml" target="_blank">Chapter 3</a>, <em>Local Filesystem Security</em>.</span></p>
<p><span class="pln">After configuring the LDAP server, we have to add organizational units, groups and users. Once we log in to the LDAP server, we can use the left menu to create groups and users.</span></p>
<p><span class="pln">After completing the process, we should have an LDAP server set with a few users and groups.</span></p>


            </article>

            
        </section>
    

        <section>

                            <header>
                    <h1 class="header-title">How to do it...</h1>
                </header>
            
            <article>
                
<p><span class="pln">After completing the setup of LDAP server on Ubuntu, and creating a few users and groups, we shall now try to configure our client machines, to remotely authenticate with the server:</span></p>
<ol>
<li><span class="pln">The first step  is to install a few packages on the client machine so that authentication functions properly with the LDAP server. To install the packages, we run the following command:</span></li>
</ol>
<pre><strong>apt-get install libpam-ldap nscd</strong></pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/e9a88ec1-7bc8-42cd-8bdc-854bba938aa8.png" style="width:36.08em;height:11.75em;"/></p>
<ol start="2">
<li><span class="pln">During the installation, various questions will be asked, the same way as they were asked during the installation of the server components.</span></li>
<li><span class="pln">The first information to be asked for will be the LDAP server's Uniform Resource Identifier, as shown here:</span></li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/13178fdc-6312-428c-a6bd-2d75e918c1a5.png" style="width:43.67em;height:22.08em;"/></p>
<p style="padding-left: 90px">Change the string from <kbd>ldapi:///</kbd> to  <kbd>ldap://</kbd> and enter the server's information as entered here:</p>
<p class="CDPAlignCenter CDPAlign"><img src="assets/5d70778b-cb28-4102-9942-1a42bc07ba1d.png" style="width:42.92em;height:17.83em;"/></p>
<ol start="4">
<li>Next enter the recognized name of the LDAP server, the same as the value entered in the LDAP server, when configuring the <kbd>/etc/phpldapadmin/config.php</kbd> file:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/302e3f0b-dd05-49db-bd63-127cbae61ac9.png" style="width:43.92em;height:16.00em;"/></p>
<ol start="5">
<li>Next, select the LDAP version to use as  <kbd>3</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/1dd5f534-de39-4ab4-aa32-2f8f029f3b4b.png" style="width:42.50em;height:15.67em;"/></p>
<ol start="6">
<li>Next, select <kbd>Yes</kbd><span class="packt_screen"> </span>to allow the LDAP admin account to behave as the local root:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/13b7b284-468c-4a27-b79b-619501ec1e22.png" style="width:38.33em;height:15.50em;"/></p>
<ol start="7">
<li>Then select <kbd>No</kbd> for <kbd>Does the LDAP database require login</kbd>:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/aeb56e5e-7751-454f-98ba-c139a1ec6341.png" style="width:39.00em;height:13.08em;"/></p>
<ol start="8">
<li>Next, enter the details of the LDAP account for the root as configured in the<kbd>/etc/phpldapadmin/config.php</kbd> of the LDAP server:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/faffab56-c6f4-4e6b-94c8-8e88debbf933.png" style="width:39.58em;height:14.25em;"/></p>
<ol start="9">
<li>Enter the LDAP root account password:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/23482c0f-a779-4748-9621-642572af6852.png" style="width:41.17em;height:18.83em;"/></p>
<ol start="10">
<li>Once all the questions have been answered, the installation of the packages will complete.</li>
<li>Our next step will be to configure the client so that its authentication files know that they have to look to our LDAP server for the authentication information. To do  this, we edit the <kbd>/etc/nsswitch.conf</kbd> file and update the three lines with the  <kbd>passwd</kbd> , <kbd>group</kbd>, and <kbd>shadow</kbd> definitions, as shown here:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/c64f298c-86c8-4d79-8d07-59d3ba0985e9.png" style="width:44.33em;height:13.08em;"/></p>
<ol start="12">
<li>After this, we add a value in the PAM configuration file, <kbd>etc/pam.d/common-session</kbd>. PAM, or Pluggable Authentication Modules, help connect authentication, providing applications to the application requiring authentication.</li>
</ol>
<ol start="13">
<li>Edit the <kbd>/etc/pam.d/common-session</kbd> file and add a line at the bottom, as shown here:</li>
</ol>
<pre><strong>    session required    pam_mkhomedir.so skel=/etc/skel umask=0022 </strong> </pre>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b03cedc6-a9ab-4d76-8713-d9809b42bc54.png" style="width:40.50em;height:13.58em;"/></p>
<ol start="14">
<li>Now we restart the service for implementing the previous changes:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/cab3516a-6717-4e17-ba36-ac39edc4a1ad.png" style="width:29.92em;height:2.50em;"/></p>
<ol start="15">
<li>We are done with all the configurations on the client machine. Now we shall try to log in with our LDAP user. Use a new terminal window to SSH  into the client machine using the LDAP user's details:</li>
</ol>
<p class="CDPAlignCenter CDPAlign"><img src="assets/b849bf7f-381b-4892-ad95-2d1d20f6b66b.png" style="width:43.75em;height:6.75em;"/></p>
<ol start="16">
<li>We should log in successfully, just like a local user.</li>
</ol>


            </article>

            
        </section>
    </body></html>