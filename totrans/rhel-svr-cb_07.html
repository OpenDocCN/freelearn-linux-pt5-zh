<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07" class="calibre1"/>Chapter 7. Puppet Configuration Management</h1></div></div></div><p class="calibre7">The recipes that are covered in this chapter are:</p><div><ul class="itemizedlist"><li class="listitem">Installing and configuring Puppet Master</li><li class="listitem">Installing and configuring Puppet agent</li><li class="listitem">Defining a simple module to configure time</li><li class="listitem">Defining nodes and node grouping</li><li class="listitem">Deploying modules to single nodes and node groups</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch07lvl1sec54" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">Puppet is an "old school" configuration management tool. It helps you enforce configurations with great ease although it is more complex than Ansible to use. Puppet's declarative language can be compared to a programming language and is difficult to master. However, once you understand how it works, it's fairly easy to use.</p><p class="calibre7">Puppet is very good at maintaining a strict set of configurations, but if you aim at verifying the configurations before applying them, you'll find that Puppet is not the sharpest tool in the shed. Puppet does have the <code class="email">audit</code> metaparameter that you can use in your resources to track changes, but it doesn't let you display where it differs from your manifest. In fact it doesn't allow you to add the <code class="email">audit</code> metaparameter to your "active" module or manifests. It sits in a separate manifest that audits the requested resources.</p><p class="calibre7">The version of Puppet used in these recipes is v3.8 and covers the community edition.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec55" class="calibre1"/>Installing and configuring Puppet Master</h1></div></div></div><p class="calibre7">The people at Puppet Labs <a id="id366" class="calibre1"/>have their<a id="id367" class="calibre1"/> own repository servers for puppet, which is very easy when it comes down to installing and maintaining the server and agent. Although the EPEL repository also provides puppet packages, they tend to be old or not up to date. Hence, I recommend using the Puppet Labs' yum repositories.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec150" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">This recipe covers a <a id="id368" class="calibre1"/>monolithic install. Perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Enable the optional<a id="id369" class="calibre1"/> channel via the following command; you'll need this to install the Puppet Server component:<div><pre class="programlisting">
<strong class="calibre8">~]# subscription-manager repos --enable rhel-6-server-optional-rpms</strong>
</pre></div></li><li class="listitem" value="2">Download the <code class="email">puppetlabs</code> repository installer, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# curl -Lo /tmp/puppetlabs-release-el-7.noarch.rpm https://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="3">Now, install the <code class="email">puppetlabs</code> repository by executing the following:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y /tmp/puppetlabs-release-el-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="4">Install <code class="email">puppet-server</code> by typing out this command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y puppet-server</strong>
</pre></div></li><li class="listitem" value="5">Set up Puppet Master by adding the following to the <code class="email">[main]</code> section of <code class="email">/etc/puppet/puppet.conf</code>:<div><pre class="programlisting">dns_alt_names = puppetmaster.critter.be,rhel7.critter.be
always_cache_features = true</pre></div></li><li class="listitem" value="6">Next, verify the generation of a CA certificate for the <code class="email">puppet</code> environment through this command line:<div><pre class="programlisting">
<strong class="calibre8">~]# puppet master --verbose --no-daemonize</strong>
</pre></div></li><li class="listitem" value="7">Press <em class="calibre9">CTRL</em> + <em class="calibre9">C</em> when it displays the following information:<div><pre class="programlisting">
<strong class="calibre8">Notice: Starting Puppet master version &lt;version number&gt;</strong>
</pre></div></li><li class="listitem" value="8">Now, allow traffic to the Puppet Master port (<code class="email">8140/tcp</code>) via the following commands:<div><pre class="programlisting">
<strong class="calibre8">~]# firewall-cmd --permanent –add-port=8140/tcp</strong>
<strong class="calibre8">~]# firewall-cmd --reload</strong>
</pre></div></li><li class="listitem" value="9">Start Puppet Master by executing the following:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl start puppetmaster</strong>
</pre></div></li><li class="listitem" value="10">Finally, enable Puppet Master at boot, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl enable puppetmaster</strong>
</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec151" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">The basic HTTP daemon <a id="id370" class="calibre1"/>that Puppet Master uses is not made to provide service for <a id="id371" class="calibre1"/>an enterprise. Puppet Labs recommends using Apache with Passenger to provide the same service as Puppet Master for a bigger range of systems (more than 10).</p><p class="calibre7">You can either compile the Passenger module yourself, or you can just use <code class="email">EPEL</code> (for the <code class="email">rubygem(rack)</code> package) and the Passenger repository. I choose the latter. Here are the steps that you need to perform:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the Passenger repository by running the following command:<div><pre class="programlisting">
<strong class="calibre8">curl -Lo /etc/yum.repos.d/passenger.repo https://oss-binaries.phusionpassenger.com/yum/definitions/el-passenger.repo</strong>
</pre></div></li><li class="listitem" value="2">Now, download the EPEL repository installer, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# curl -Lo /tmp/epel-release-latest-7.noarch.rpm https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="3">Install the <code class="email">rpm</code> EPEL repository (with <code class="email">yum</code>) via the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y /tmp/epel-release-latest-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="4">Next, install the necessary packages for the Puppet web interface. For this, you can execute the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y httpd mod_ssl mod_passenger</strong>
</pre></div></li><li class="listitem" value="5">Set up Puppet Master's virtual host directories and ownership, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# mkdir -p /var/www/puppetmaster/{public,tmp} -p &amp;&amp; chown -R apache:apache /var/www/puppetmaster</strong>
</pre></div></li><li class="listitem" value="6">Copy the <code class="email">rack</code> configuration file to Puppet Master's virtual host root using the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# cp /usr/share/puppet/ext/rack/config.ru /var/www/puppetmaster/.</strong>
</pre></div></li><li class="listitem" value="7">Next, change the ownership of the <code class="email">config.ru</code> file. This is very important! You can do this through the following command:<div><pre class="programlisting">
<strong class="calibre8">~#] chown -R puppet:puppet /var/www/puppetmaster/config.ru</strong>
</pre></div></li><li class="listitem" value="8">Then, create an Apache virtual host configuration file at <code class="email">/etc/httpd/conf.d/puppetmaster.conf</code> containing the following:<div><pre class="programlisting"># passenger performance tuning settings:
# Set this to about 1.5 times the number of CPU cores in your master:
PassengerMaxPoolSize 3
# Recycle master processes after they service 1000 requests
PassengerMaxRequests 1000
# Stop processes if they sit idle for 10 minutes
PassengerPoolIdleTime 600

Listen 8140
&lt;VirtualHost *:8140&gt;
    # Make Apache hand off HTTP requests to Puppet earlier, at the cost of
    # interfering with mod_proxy, mod_rewrite, etc. See note below.
    PassengerHighPerformance On

    SSLEngine On

    # Only allow high security cryptography. Alter if needed for compatibility.
    SSLProtocol ALL -SSLv2 -SSLv3
    SSLCipherSuite EDH+CAMELLIA:EDH+aRSA:EECDH+aRSA+AESGCM:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH:+CAMELLIA256:+AES256:+CAMELLIA128:+AES128:+SSLv3:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!DSS:!RC4:!SEED:!IDEA:!ECDSA:kEDH:CAMELLIA256-SHA:AES256-SHA:CAMELLIA128-SHA:AES128-SHA
    SSLHonorCipherOrder     on

    SSLCertificateFile      /var/lib/puppet/ssl/certs/rhel7.critter.be.pem
    SSLCertificateKeyFile   /var/lib/puppet/ssl/private_keys/rhel7.critter.be.pem
    SSLCertificateChainFile /var/lib/puppet/ssl/ca/ca_crt.pem
    SSLCACertificateFile    /var/lib/puppet/ssl/ca/ca_crt.pem
    SSLCARevocationFile     /var/lib/puppet/ssl/ca/ca_crl.pem
    SSLCARevocationCheck   chain
    SSLVerifyClient         optional
    SSLVerifyDepth          1
    SSLOptions              +StdEnvVars +ExportCertData

    # Apache 2.4 introduces the SSLCARevocationCheck directive and sets it to none
    # which effectively disables CRL checking. If you are using Apache 2.4+ you must
    # specify 'SSLCARevocationCheck chain' to actually use the CRL.

    # These request headers are used to pass the client certificate
    # authentication information on to the Puppet master process
    RequestHeader set X-SSL-Subject %{SSL_CLIENT_S_DN}e
    RequestHeader set X-Client-DN %{SSL_CLIENT_S_DN}e
    RequestHeader set X-Client-Verify %{SSL_CLIENT_VERIFY}e

    DocumentRoot /var/www/puppetmaster/public

    &lt;Directory /var/www/puppetmaster/&gt;
      Options None
      AllowOverride None
      # Apply the right behavior depending on Apache version.
      &lt;IfVersion &lt; 2.4&gt;
        Order allow,deny
        Allow from all
      &lt;/IfVersion&gt;
      &lt;IfVersion &gt;= 2.4&gt;
        Require all granted
      &lt;/IfVersion&gt;
    &lt;/Directory&gt;

    ErrorLog /var/log/httpd/puppetmaster_ssl_error.log
    CustomLog /var/log/httpd/puppetmaster_ssl_access.log combined
&lt;/VirtualHost&gt;</pre></div><div><h3 class="title2"><a id="tip10" class="calibre1"/>Tip</h3><p class="calibre7">Make sure that you replace the certificate directives with the certificate file paths of your own system.</p></div></li><li class="listitem" value="9">Disable<a id="id372" class="calibre1"/> the <code class="email">puppetmaster</code> service via the following:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl disable puppetmaster</strong>
</pre></div></li><li class="listitem" value="10">Use the following command <a id="id373" class="calibre1"/>line to stop the <code class="email">puppetmaster</code> service:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl stop puppetmaster</strong>
</pre></div></li><li class="listitem" value="11">Now, start Apache, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl start httpd</strong>
</pre></div></li><li class="listitem" value="12">Enable Apache on boot through the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl enable httpd</strong>
</pre></div></li><li class="listitem" value="13">Check your HTTP daemon's status using the following:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl status httpd</strong>
</pre></div><p class="calibre13">This will result in the following (similar) output:</p><div><img src="img/00051.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre15"> </p></li></ol><div></div><p class="calibre7">Puppet can<a id="id374" class="calibre1"/> also run<a id="id375" class="calibre1"/> in a masterless mode. In this case, you don't install a server but only the clients on all the systems that you wish to manage in this way.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec152" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more in-depth information about installing<a id="id376" class="calibre1"/> Puppet on RHEL, refer to the following page:</p><p class="calibre7">
<a class="calibre1" href="https://docs.puppetlabs.com/guides/install_puppet/install_el.html">https://docs.puppetlabs.com/guides/install_puppet/install_el.html</a>
</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec56" class="calibre1"/>Installing and configuring the Puppet agent</h1></div></div></div><p class="calibre7">Unlike Ansible, Puppet requires an<a id="id377" class="calibre1"/> agent to be able to enforce configurations. This recipe <a id="id378" class="calibre1"/>will teach you how to install and configure the puppet agent on a system. The only way to mass deploy the Puppet agent is through an orchestration tool (such as Ansible).</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec153" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">The Puppet agent can be installed and maintained using the same repository as the Puppet server: the Puppet Labs repository. Perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Download the Puppet Labs repository installer via the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# curl -Lo /tmp/puppetlabs-release-el-7.noarch.rpm https://yum.puppetlabs.com/puppetlabs-release-el-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="2">Install the Puppet Labs repository by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y /tmp/puppetlabs-release-el-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="3">Use the following command to download the EPEL repository installer:<div><pre class="programlisting">
<strong class="calibre8">~]# curl -Lo /tmp/epel-release-latest-7.noarch.rpm https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="4">Now, install the <code class="email">rpm</code> EPEL repository (with <code class="email">yum</code>) through the following command line:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y /tmp/epel-release-latest-7.noarch.rpm</strong>
</pre></div></li><li class="listitem" value="5">Install the Puppet agent; you can run the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y puppet</strong>
</pre></div></li><li class="listitem" value="6">Next, configure the agent so that it will connect to your Puppet Master.</li><li class="listitem" value="7">Add your Puppet Master to the <code class="email">[main]</code> section of <code class="email">/etc/puppet/puppet.conf</code>, as follows:<div><pre class="programlisting">server = rhel7.critter.be</pre></div></li><li class="listitem" value="8">Start the Puppet agent by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl start puppet</strong>
</pre></div></li><li class="listitem" value="9">Then, enable the<a id="id379" class="calibre1"/> Puppet agent by running the following:<div><pre class="programlisting">
<strong class="calibre8">~]# systemctl enable puppet</strong>
</pre></div></li><li class="listitem" value="10">Finally, sign<a id="id380" class="calibre1"/> the new node's certificate on Puppet Master, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# puppet cert sign rhel7-client.critter.be</strong>
</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec154" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">Instead of signing every single certificate individually, you can sign the certificate for all systems that have been registered with Puppet Master by executing the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# puppet cert sign –all</strong>
</pre></div><p class="calibre7">If you start looking for puppet unit files in <code class="email">/lib/systemd/system</code>, you'll also find a <code class="email">puppetagent.service</code> unit file. The <code class="email">puppetagent.service</code> unit file is actually a soft link to the <code class="email">puppet.service</code> unit file.</p><p class="calibre7">If you don't want to set the server property in the <code class="email">/etc/puppet/puppet.conf</code> file, you can do this by defining a <code class="email">puppet</code> DNS entry that points to Puppet Master in all the DNS domain zones.</p><p class="calibre7">The Puppet agent is known to consume memory. In order to mitigate this, the Puppet agent can be run as a cron job. This would release some memory, but you would lose the flexibility of pushing new configurations from Master.</p><p class="calibre7">This will create a cron job that launches the Puppet agent once every <code class="email">30</code> minutes, as follows:</p><div><pre class="programlisting">
<strong class="calibre8">~]# puppet resource cron puppet-agent ensure=present user=root minute=30 command='/usr/bin/puppet agent --onetime --no-daemonize --splay'</strong>
</pre></div><p class="calibre7">The Puppet agent can<a id="id381" class="calibre1"/> also be configured to run in the <code class="email">Masterless</code> mode. This<a id="id382" class="calibre1"/> means that you will take care of distributing your puppet modules and classes yourself instead of Puppet taking care of this. This implies that you will synchronize all modules and classes, even those that are not used by the system, which can be a security risk.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec57" class="calibre1"/>Defining a simple module to configure time</h1></div></div></div><p class="calibre7">Modules are collections of <a id="id383" class="calibre1"/>manifests and files that define how to install and configure various components. Manifests contain the instructions to apply to a system's configuration. In this recipe, we'll create a simple module to install and configure the NTP daemon.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec155" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Puppet has a strict way of organizing modules. Your modules should always be stored in <code class="email">/etc/puppet/modules</code>. Every module is a directory within this directory, containing the necessary directories that in turn contain manifests, files, templates, and so on.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec156" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">In this recipe, we'll create the necessary directory structure, manifests, and files to configure your system's time. Perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Create <code class="email">ntp/manifests</code> in <code class="email">/etc/puppet/modules</code> via the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# mkdir -p /etc/puppet/modules/ntp/manifests</strong>
</pre></div></li><li class="listitem" value="2">Create <code class="email">ntp/templates</code> to house all the templates used by the puppet module through the following:<div><pre class="programlisting">
<strong class="calibre8">~]# mkdir -p /etc/puppet/modules/ntp/templates</strong>
</pre></div></li><li class="listitem" value="3">Now, create the <code class="email">install.pp</code> file in <code class="email">/etc/puppet/modules/ntp/manifests</code> with the following contents:<div><pre class="programlisting">class ntp::install inherits ntp {
  package { 'ntp':
    ensure =&gt; installed,
  }
}</pre></div></li><li class="listitem" value="4">Create the <code class="email">config.pp</code> file in <code class="email">/etc/puppet/modules/ntp/manifests</code> with the following contents:<div><pre class="programlisting">class ntp::config inherits ntp {
  file { '/etc/ntp.conf':
    ensure  =&gt; file,
    owner   =&gt; 'root',
    group   =&gt; 'root',
    mode    =&gt; 0644,
    content =&gt; template("ntp/ntp.conf.erb"),
  }
}</pre></div></li><li class="listitem" value="5">Next, create<a id="id384" class="calibre1"/> the <code class="email">ntp.conf.erb</code> template file in <code class="email">/etc/puppet/modules/ntp/templates</code> with the following contents:<div><pre class="programlisting">driftfile /var/lib/ntp/drift

restrict default nomodify notrap nopeer noquery

restrict 127.0.0.1
restrict ::1

server 0.be.pool.ntp.org iburst
server 1.be.pool.ntp.org iburst
server 2.be.pool.ntp.org iburst
server 3.be.pool.ntp.org iburst

includefile /etc/ntp/crypto/pw

keys /etc/ntp/keys

disable monitor</pre></div></li><li class="listitem" value="6">Create the <code class="email">service.pp</code> file in <code class="email">/etc/puppet/modules/ntp/manifests</code> with the following contents:<div><pre class="programlisting">class ntp::service inherits ntp {
  service { 'ntp':
    ensure     =&gt; running,
    enable     =&gt; true,
    hasstatus  =&gt; true,
    hasrestart =&gt; true,
    require =&gt; Package['ntp'],
  }
}</pre></div></li><li class="listitem" value="7">Finally, create the <code class="email">init.pp</code> file that binds them all together in <code class="email">/etc/puppet/modules/ntp/manifests</code> with the following contents:<div><pre class="programlisting">class ntp {
    include ntp::install
    include ntp::config
    include ntp::service
}</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch07lvl2sec157" class="calibre1"/>How it works...</h2></div></div></div><p class="calibre7">When applying a module to a system, it applies the directives found in the module's <code class="email">init.pp</code> manifest.</p><p class="calibre7">As you can see, we <a id="id385" class="calibre1"/>created a template file that is "automagically" distributed to the clients. Puppet automatically creates a file share for the <code class="email">templates </code>and <code class="email">files </code>directories.</p><p class="calibre7">As you can see in the <code class="email">config.pp</code> file, the template references <code class="email">ntp/ntp.conf.erb</code>. Puppet will automatically resolve this to the correct location (<code class="email">ntp/templates/ntp.conf.erb</code>).</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch07lvl2sec158" class="calibre1"/>There's more...</h2></div></div></div><p class="calibre7">I created four manifests to install and configure Puppet. This could be easily achieved by just creating one monolithic <code class="email">init.pp</code> manifest with the contents of the other three files. When you start creating complex manifests, you'll be happy to have split them up.</p><p class="calibre7">If you want to have a single location for all the assets (templates and files) you use in your modules, you will have to define a separate file share for this location in the <code class="email">/etc/puppet/fileserver.conf</code> file, as follows:</p><div><pre class="programlisting">[mount_point]
    path /path/to/files
    allow *</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_5"><a id="ch07lvl2sec159" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Read up on Puppet Modules <a id="id386" class="calibre1"/>through the link <a class="calibre1" href="https://docs.puppetlabs.com/puppet/3.8/reference/modules_fundamentals.html">https://docs.puppetlabs.com/puppet/3.8/reference/modules_fundamentals.html</a>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec58" class="calibre1"/>Defining nodes and node grouping</h1></div></div></div><p class="calibre7">In order to push a manifest, its<a id="id387" class="calibre1"/> classes, and assets to systems, they need to be known by Puppet<a id="id388" class="calibre1"/> Master. Grouping is practical if you want to push a manifest to a number of hosts without having to modify each configuration node.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec160" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">In contrast to<a id="id389" class="calibre1"/> what the title wants you to believe, you cannot create a group and add<a id="id390" class="calibre1"/> nodes. However, you can group nodes and make them behave in a similar way to groups.</p><p class="calibre7">Nodes and node groups are defined in <code class="email">/etc/puppet/manifests/site.pp</code> or a file at <code class="email">/etc/puppet/manifests/site.pp</code>.</p><div><div><div><div><h3 class="title2"><a id="ch07lvl3sec51" class="calibre1"/>Create the configuration node</h3></div></div></div><p class="calibre7">Create<a id="id391" class="calibre1"/> a <code class="email">/etc/puppet/manifests/site.pp/rhel7-client.pp</code> file with the following contents:</p><div><pre class="programlisting">node 'rhel7-client.critter.be' {
}</pre></div></div><div><div><div><div><h3 class="title2"><a id="ch07lvl3sec52" class="calibre1"/>Create a node group</h3></div></div></div><p class="calibre7">Create a <code class="email">/etc/puppet/manifests/site.pp/rhel7-clientgroup.pp</code> file with the following <a id="id392" class="calibre1"/>contents:</p><div><pre class="programlisting">node 'rhel7-client00.critter.be', 'rhel7-client01.critter.be', 'rhel7-client02.critter.be' {
}</pre></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec161" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">If you have a strict naming convention, you can use <code class="email">regular expressions</code> to define your node group. Run the following commands:</p><div><pre class="programlisting">node /^www[0-9]+\.critter\.be$/ {
}
node /^repo[0-9]+\.critter\.be$/ {
}</pre></div><p class="calibre7">By default, node names are defined by their certificate name, which is <strong class="calibre8">FQDN</strong> (<strong class="calibre8">Fully Qualified Domain Name</strong>) <a id="id393" class="calibre1"/>of the system we used to register with Puppet Master.</p><p class="calibre7">If you don't remember the names of all of your nodes, you can easily find them at <code class="email">/var/lib/puppet/ssl/ca/signed/</code>.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec59" class="calibre1"/>Deploying modules to single nodes and node groups</h1></div></div></div><p class="calibre7">Once you define <a id="id394" class="calibre1"/>modules and nodes, you can start deploying<a id="id395" class="calibre1"/> the modules to your nodes. You can do this <a id="id396" class="calibre1"/>on various levels, which will be<a id="id397" class="calibre1"/> demonstrated in the following recipe.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec162" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">In order to deploy a module (or manifest) to a node, your must configure this in the node's stanza or a group of nodes that the node belongs to, or you can define it on the base level to apply it to every node.</p><div><div><div><div><h3 class="title2"><a id="ch07lvl3sec53" class="calibre1"/>Configure to deploy a module or manifest to a single client</h3></div></div></div><p class="calibre7">Edit the client configuration <a id="id398" class="calibre1"/>node from the previous recipe and add an <a id="id399" class="calibre1"/>include statement referring to manifest you want to be applied to the client block. You can execute the following command for this:</p><div><pre class="programlisting">node 'rhel7-client.critter.be' {
  include ntp
}</pre></div></div><div><div><div><div><h3 class="title2"><a id="ch07lvl3sec54" class="calibre1"/>Configure to deploy a module or manifest to a node group</h3></div></div></div><p class="calibre7">In the same way you <a id="id400" class="calibre1"/>edited the single node file, edit the node group<a id="id401" class="calibre1"/> configuration file and add an include statement to the node group block referring to the manifest you want applied. Take a look at the following command:</p><div><pre class="programlisting">node 'rhel7-client0.critter.be', 'rhel7-client1.critter.be', 'rhel7-client2.critter.be' {
  include ntp
}</pre></div></div><div><div><div><div><h3 class="title2"><a id="ch07lvl3sec55" class="calibre1"/>Configure to deploy to all registered systems</h3></div></div></div><p class="calibre7">One will typically have <a id="id402" class="calibre1"/>a node configuration file within <code class="email">/etc/puppet/manifests/site.pp/</code>, or <code class="email">/etc/puppet/manifests/site.pp</code> itself, if you work with one monolithic site definition, which affects all nodes. Edit <code class="email">/etc/puppet/manifests/site.pp/default.pp</code> and enter the following code:</p><div><pre class="programlisting">include ntp</pre></div></div><div><div><div><div><h3 class="title2"><a id="ch07lvl3sec56" class="calibre1"/>Deploy to a system</h3></div></div></div><p class="calibre7">On the system with the<a id="id403" class="calibre1"/> Puppet Agent installed, execute the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# puppet agent –-test</strong>
</pre></div><p class="calibre7">When executed, the following will appear:</p><div><img src="img/00052.jpeg" alt="Deploy to a system" class="calibre10"/></div><p class="calibre11"> </p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec163" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">For testing purposes, there's an alternative to defining nodes and including modules.</p><p class="calibre7">Copy the manifest(s), files, and templates to your test machine (usually, you will develop elsewhere than the production Puppet Master anyway) and execute them in the following way:</p><div><pre class="programlisting">
<strong class="calibre8">~]# puppet apply /path/to/manifest.pp</strong>
</pre></div><div><h3 class="title2"><a id="tip11" class="calibre1"/>Tip</h3><p class="calibre7">By default, Puppet applies all manifests found in <code class="email">/etc/puppet/manifests/site.pp</code>. As explained in the preceding section, this doesn't need to be a single monolithic file containing all your directives. When using it as a directory, it uses all the manifests found within this directory, or if the name of a subdirectory ends with <code class="email">.pp</code>, it interprets all of its contents as manifests as well. It interprets all files alphanumerically.</p></div></div></div></body></html>