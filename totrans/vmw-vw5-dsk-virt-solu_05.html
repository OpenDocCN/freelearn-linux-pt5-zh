<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch05"/>Chapter 5. The PCoIP Protocol</h1></div></div></div><p>The PCoIP protocol, developed by Teradici and licensed by VMware, is a purpose-built protocol for virtual desktop solutions on both LAN and WAN connections. PCoIP is a content-aware protocol, meaning that it has algorithms to differentiate between text and high-resolution pictures, for example, and then perform delivery optimization depending on real-time network characteristics.<a id="id195" class="indexterm"/>
</p><p>VMware's own testing has shown that PCoIP can reduce display latency by more than 50 percent as compared to<strong> Microsoft's Remote Display Protocol (RDP)</strong> for common operations (VMware View PCoIP Network Sizing Guide).<a id="id196" class="indexterm"/>
</p><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Why lossless quality is important</li><li class="listitem" style="list-style-type: disc">Various PCoIP network fundamentals</li><li class="listitem" style="list-style-type: disc">Multimedia redirection</li><li class="listitem" style="list-style-type: disc">Teradici APEX offload card</li></ul></div><p>PCoIP has many differentiators when compared to other protocols in competing VDI solutions; one such differentiator is the fact that the PCoIP is a host-rendered technology. Host rendering means that all pixels are rendered in the data center and then simply broadcasted to the end device. This means that there are no codecs to install at the end device.</p><p>One of the PCoIP features most often touted is the fact that the protocol can build to a lossless quality.<a id="id197" class="indexterm"/>
</p><p>Consider that an end user is connecting to his/her vDesktop over a latent connection and attempting to render a web page. The web page consists of both high-resolution graphics as well as text. Notice that, initially, the text is crystal clear while the graphics are significantly compressed to conserve bandwidth.</p><p>Assuming that the display isn't changed by the user navigating to a different web page (for example), the visual will build to a perceptually lossless quality. This means that the human eye cannot tell the difference between what's displayed and the original version (with a higher number of pixels) rendered by the VDI. If there is still time before the user changes what they are trying to view, PCoIP will finally build to a fully lossless quality.<a id="id198" class="indexterm"/>
</p><div><div><div><div><h1 class="title"><a id="ch05lvl1sec01"/>Why lossless quality is important</h1></div></div></div><p>To understand why lossless representation is important, let's use an example. Whitney is a security agent tasked with screening packages that are entering a building. Her organization has implemented a VDI solution at her primary workstation. As packages enter the X-ray machine and the contents are displayed on her monitor, she has two seconds, as per the agency's policy, to determine whether it's a threat or not. If Whitney's agency is using a solution that is using a protocol that can't guarantee a lossless image at the end device, the visual representation on her screen may or may not be completely accurate. In this scenario, a lossless image delivered by PCoIP is of much greater value than a solution leveraging a solution and protocol that may have significant compression and may or may not be an exact visual representation of the virtual desktop.<a id="id199" class="indexterm"/>
</p><p>Another example of where a lossless image is of critical importance is in a healthcare environment. For example, if VDI has been implemented at a hospital, where the clinicians are accessing their vDesktops from laptops, Apple iPads, and other end devices, it's important that the image being delivered is lossless. Without a solution capable of lossless rendering, a clinician could be looking at a<strong> positron emission tomography (PET)</strong> scan of a patient and be unable to determine whether the image suggests a particular diagnosis, for example, cancer, or not.<a id="id200" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec02"/>PCoIP network fundamentals</h1></div></div></div><p>In order to understand how to size a network for PCoIP session delivery, it's important to know some of the key configurations and concepts of PCoIP. For example, the PCoIP protocol adds minimal overhead, with just 85 bytes of overhead in a standard 1,500 byte Ethernet packet.<a id="id201" class="indexterm"/>
</p><p>For a PCoIP session to be established, a PCoIP-capable client must reside on the end device and the destination must be a PCoIP-capable host.</p><p>PCoIP-capable clients include:<a id="id202" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">VMware View Client for 64-bit Windows</li><li class="listitem" style="list-style-type: disc">VMware View Client for Linux</li><li class="listitem" style="list-style-type: disc">VMware View Client for Mac</li><li class="listitem" style="list-style-type: disc">VMware View Client for Apple iPad</li><li class="listitem" style="list-style-type: disc">VMware View Client for Android</li></ul></div><p>PCoIP-capable hosts include:<a id="id203" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Windows-based desktop operating system running the VMware View Agent software (physical or virtual)</li><li class="listitem" style="list-style-type: disc">Windows-based desktop operating system with a PCoIP hardware host card (physical)</li></ul></div><p>While it is possible to use PCoIP to connect to a Windows-based server operating system, it is currently not supported by VMware. However, the following URL will provide instructions on how to enable this solution:</p><p>
<a class="ulink" href="http://myvirtualcloud.net/?p=2811">http://myvirtualcloud.net/?p=2811</a>.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec01"/>The two types of PCoIP connections</h2></div></div></div><p>There are two types of PCoIP connections — soft and hard.<a id="id204" class="indexterm"/>
</p><p>Soft PCoIP is used when connecting to VMware View vDesktops. As a vDesktop cannot have a PCoIP host card, it uses a software implementation of PCoIP and is referred to as a<strong> PCoIP software host</strong>. Soft PCoIP can tolerate upto 250 milliseconds of round trip latency and is capable of displaying video at 30<strong> frames per second (FPS)</strong>.<a id="id205" class="indexterm"/>
</p><p>Hard PCoIP is used when connecting to a physical device with a Teradici PCoIP host card. As the connection is terminating at the PCoIP host card device, this is called<strong> hard PCoIP host</strong>. Hard PCoIP can tolerate up to 150 milliseconds of round trip latency. Hard PCoIP is capable of displaying video at 60 FPS.<a id="id206" class="indexterm"/>
</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Type of PCoIP</p>
</th><th style="text-align: left" valign="bottom">
<p>Round trip latency tolerance</p>
</th><th style="text-align: left" valign="bottom">
<p>Maximum frames per second for video</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="bottom">
<p>Soft</p>
</td><td style="text-align: left" valign="top">
<p>250</p>
</td><td style="text-align: left" valign="top">
<p>30</p>
</td></tr><tr><td style="text-align: left" valign="bottom">
<p>Hard</p>
</td><td style="text-align: left" valign="top">
<p>150</p>
</td><td style="text-align: left" valign="top">
<p>60</p>
</td></tr></tbody></table></div><div><h3 class="title"><a id="note16"/>Note</h3><p>To test network latency, use the<code class="literal"> ping l 1400 &lt;destination_ip&gt;</code>, where<code class="literal">&lt;destination_ip&gt;</code> is the IP address of the remote location. The<code class="literal"> l 1400</code> switch forces the ping test to use a packet size of 1400 bytes, which is the Teradici recommendation for testing network latency for PCoIP.</p></div><p>Both soft and hard PCoIP leverage local cursor technology, which ensures that cursor functionality for the end user is still favorable in high latency situations.<a id="id207" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec03"/>Multimedia redirection</h1></div></div></div><p>
<strong>Multimedia redirection (MMR)</strong> is the process of redirecting a media file from the PCoIP host (typically a VMware View vDesktop) to the end device. The more typical approach, known as<strong> host video decoding</strong>, is common practice with VMware View solutions.<a id="id208" class="indexterm"/>
</p><p>MMR is only capable when the end device is an x86 client.</p><p>Additionally, the x86 end device must also have the appropriate codecs installed to support the type of media file being redirected. MMR is a technique that originally came to market years ago to support terminal services. Years ago, thin clients were gaining in popularity, primarily through the efforts of companies such as Wyse. As learned in<a class="link" href="ch04.html" title="Chapter 4. End Devices"> Chapter 4</a>,<em> End Devices</em>, thin clients have a locked down version of an operating system, for example, Windows XPe.</p><p>Media file types supported by MMR with PCoIP include:<a id="id209" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">MPEG-1</li><li class="listitem" style="list-style-type: disc">MPEG-2</li><li class="listitem" style="list-style-type: disc">MPEG-4</li><li class="listitem" style="list-style-type: disc">WMA</li><li class="listitem" style="list-style-type: disc">MP3</li><li class="listitem" style="list-style-type: disc">AC3</li><li class="listitem" style="list-style-type: disc">WMV</li></ul></div><p>PCoIP MMR does not support the redirection of Adobe Flash or Apple QuickTime. MMR does offer advantages by placing less of a demand on the server CPU hosting the vDesktops as the rendering of the media is done by one or more end device's CPUs. In addition, MMR can potentially require less network bandwidth as already-rendered visual data is not sent to the end device, but instead the media file to be rendered.</p><p>There are many disadvantages of MMR. For example, to use MMR an x86 end device must be used. As previously discussed in this book, there are many advantages (for example, price and security) to using PCoIP zero clients in a VMware View solution. By using MMR in a solution, thin or thick clients become the only available options.<a id="id210" class="indexterm"/>
</p><p>For solutions looking to support video editors or video editing software, a hard PCoIP solution is quite likely the best (and only) viable solution. While the PCoIP protocol has made significant improvements since its initial launch years ago, a hardware-based PCoIP solution is the best approach.<a id="id211" class="indexterm"/>
</p><div><h3 class="title"><a id="note17"/>Note</h3><p>PCoIP is a unique desktop delivery protocol in that it is not only available via software (soft). PCoIP has the ability to leverage the advantages of hardware in the form of a host card, for example.</p></div><p>The following table is an excerpt from a Teradici virtual desktop host presentation:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Description</p>
</th><th style="text-align: left" valign="bottom">
<p>MMR</p>
</th><th style="text-align: left" valign="bottom">
<p>Host video decoding</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Server CPU load</p>
</td><td style="text-align: left" valign="top">
<p>Medium</p>
</td><td style="text-align: left" valign="top">
<p>Medium to high</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Support any video codec</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Support PCoIP zero clients</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Requires application and patch management</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Requires codec and patch management</p>
</td><td style="text-align: left" valign="top">
<p>Yes</p>
</td><td style="text-align: left" valign="top">
<p>No</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>WAN performance</p>
</td><td style="text-align: left" valign="top">
<p>Poor</p>
</td><td style="text-align: left" valign="top">
<p>Good</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Operation below the native video bit rate</p>
</td><td style="text-align: left" valign="top">
<p>Video stutter</p>
</td><td style="text-align: left" valign="top">
<p>Smooth playback</p>
</td></tr></tbody></table></div><p>As server CPU power and density increases, host video decoding will only become less concerning as the available horsepower in a given physical server increases with technology advancements.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec02"/>The MMR perfect storm</h2></div></div></div><p>One of the only legitimate reasons to use MMR in a VMware View solution is if there are requirements for frequent video use with a very specific codec. For example, if a public relations company watches videos of their clients frequently and the video is delivered in a specific codec, such as<strong> audio video interleave (AVI)</strong> file using DivX, it is possible that MMR to a thin or thick client with the DivX codec installed will outperform a solution relying solely on PCoIP.<a id="id212" class="indexterm"/>
</p><p>Most organizations rely less on files such as AVI with DivX and more on Adobe Flash and Apple QuickTime, which will perform best with host video decoding.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec04"/>Teradici APEX offload card</h1></div></div></div><p>In 2011, Teradici announced the Teradici APEX 2800 offload card. The APEX card is a PCIe card that is used to offload the PCoIP protocol encoding from the physical server's CPU (abstracted as vCPU within the vDesktop) to the offload card. This offloading is for video only and does not help offload the audio channels of PCoIP. The APEX offload card is an integrated solution with VMware View.</p><p>As mentioned earlier in this book, the fact that VMware View is capable of leveraging hardware solutions (for example, PCoIP zero clients, and PCoIP host card) provides unique capabilities in the market.<a id="id213" class="indexterm"/>
</p><p>In many, if not most, VMware View solutions, the APEX offload card can be used to effectively increase the vDesktops that can be run on a physical server. Increasing this user per core density should measurably reduce overall costs of the VMware View solution, even with the price of the offload card built in.</p><p>There are three components to the Teradici APEX offload card solution:</p><div><ol class="orderedlist"><li class="listitem">The Teradici APEX offload card itself<a id="id214" class="indexterm"/></li><li class="listitem">APEX driver for ESXi</li><li class="listitem">APEX driver for Windows vDesktop</li></ol></div><p>Without all three of the components installed and configured properly, hardware offload is not possible. The following diagram is an illustration showing both the required ESXi driver and Windows driver to support PCoIP offloading:</p><div><img src="img/1124EN_05_03.jpg" alt="Teradici APEX offload card"/></div><p>Hardware-assisted PCoIP protocol encoding is used to increase the number of users per core. Even in VMware View solutions that may be more memory constrained than CPU (for example, an environment heavy in Java applications with poor memory management), there can still be significant benefits realized from using the APEX card. As a general rule of thumb, the benefits are as follows:<a id="id215" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Task workers = 1.15x users per core</li><li class="listitem" style="list-style-type: disc">Knowledge workers = 1.5x users per core</li><li class="listitem" style="list-style-type: disc">Video workers = 1.75x users per core</li></ul></div><p>For example, if a VMware View design that does not utilize the APEX card is capable of 10 knowledge works per CPU core, then using the APEX card will roughly increase the number to 15 knowledge workers per CPU. The following diagram is an illustration showing the encoding of a Windows 7 desktop with PCoIP and no encoding:</p><div><img src="img/1124EN_05_04.jpg" alt="Teradici APEX offload card"/></div><p>In the preceding illustration, the display of the Windows 7 desktop is encoded using the VMware View Agent, for example, and is done completely in software and by the virtual CPU of the vDesktop. The encoded display is then sent securely to the end device in use. With PCoIP, only the encoded display is sent to the device and no actual data of the desktop itself. The following diagram is an illustration showing the encoding of a Windows 7 desktop with PCoIP offload encoding:<a id="id216" class="indexterm"/>
</p><div><img src="img/1124EN_05_05.jpg" alt="Teradici APEX offload card"/></div><p>In the preceding illustration, the display of the Windows 7 desktop is encoded using the APEX offload card. The encoded display is then sent securely to the end device in use. The offload card does not perform rendering, it performs encoding. Rendering is performed by the VMware View virtual graphics driver or virtual GPU.<a id="id217" class="indexterm"/>
</p><p>The current iteration of the APEX offload card can support encoding on up to 64 active displays simultaneously. This does not mean that a physical server cannot have more than 64 displays worth of vDesktops, but that only 64 displays can be offloaded at a given time.</p><div><div><div><div><h2 class="title"><a id="ch05lvl2sec03"/>The offload process</h2></div></div></div><p>APEX 2800 ESXi driver monitors all vDesktops for image activity, whether the vDesktop is using hardware offloading or not. There are several factors that the APEX solution uses to determine if a vDesktop's display should be offloaded. They are as follows:<a id="id218" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Eligibility:</strong> Is the vDesktop eligible to have its display offloaded?</li><li class="listitem" style="list-style-type: disc"><strong>Imaging activity:</strong> Is the vDesktop's imaging activity above the minimum threshold?</li><li class="listitem" style="list-style-type: disc"><strong>Priority:</strong> Does the vDesktop currently have priority among its peers?</li></ul></div><p>The following diagram shows a Teradici PCoIP APEX offload decision tree:<a id="id219" class="indexterm"/>
</p><div><img src="img/1124EN_05_06.jpg" alt="The offload process"/></div><p>The switch between software and hardware encoding is a seamless process. In the current version of the solution, a tiny red dot appears in the upper-left corner of the display (can be disabled) to let the end user know that hardware encoding is being used. This should likely only be used during the test and pilot phase and not during an actual production implementation.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec04"/>Defining the offload tiers</h2></div></div></div><p>The Teradici APEX offload card uses priority as one of the factors in determining if a given vDesktop's display will be offloaded to the hardware card or not. Priority for a given desktop pool is defined within the VMware View Admin console under Policies. The offload priority is listed as PCoIP hardware acceleration priority. There are five priority settings available. They are as follows:<a id="id220" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Lowest</li><li class="listitem" style="list-style-type: disc">Lower</li><li class="listitem" style="list-style-type: disc">Medium (default)</li><li class="listitem" style="list-style-type: disc">Higher</li><li class="listitem" style="list-style-type: disc">Highest</li></ul></div><p>In many designs, only one or two offload priority settings will be used. For example, a design may have an end user population that is separated from the executive team. The executives may receive a "Higher" priority setting while everyone else is configured for "Medium".</p><p>It is best practice to use only "Highest" and "Lowest" if required by the number of priority groups defined for a given solution. By keeping "Highest" as an available option, if the need arises, a desktop pool can immediately be given priority over everyone else in an emergency.</p></div><div><div><div><div><h2 class="title"><a id="ch05lvl2sec05"/>Design considerations</h2></div></div></div><p>The implementation of the APEX offload card is fairly straightforward; the driver installations are well-documented and enabling and configuring offload from the View Admin console is simple. The major consideration to make when using PCoIP hardware offloading is in regard to its capabilities across a cluster supporting a given desktop pool.<a id="id221" class="indexterm"/>
</p><p>If a desktop pool's underlying vCenter cluster has both hosts with and without the APEX card, the vMotion (whether manual or triggered by DRS) could require a disconnect and reconnect to allow the PCoIP to initiate. The following diagram is an illustration showing one cluster without the APEX card and one cluster with the APEX card:</p><div><img src="img/1124EN_05_07.jpg" alt="Design considerations"/></div><p>As vMotion task could prevent PCoIP offload from initiating, it is recommended to use the Teradici APEX offload card across all hosts in a given cluster. That's not to say that all hosts in a given VMware View solution need the Teradici APEX card, but if the card is to be leveraged, it should be leveraged cluster-wide.<a id="id222" class="indexterm"/>
</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch05lvl1sec05"/>Summary</h1></div></div></div><p>As the outlined in this chapter, the Teradici PCoIP protocol is the technology behind the delivery of the desktop to the end device. Whether that end device is an Apple iPad or IBM laptop, PCoIP uses its intelligence to ensure that the best possible user experience is delivered. Understanding how the Teradici PCoIP protocol works is important in understanding the network requirements of a given VDI solution. In the next chapter, sizing the network will be discussed, which includes the discussion of PCoIP considerations. A working knowledge of the Teradici PCoIP protocol is a requirement for anyone designing a VMware View solution, otherwise, the network could become a limiting factor in an otherwise well-designed solution.</p></div></body></html>