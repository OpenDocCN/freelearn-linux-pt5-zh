<html><head></head><body><div class="chapter" title="Chapter&#xA0;3.&#xA0;Testing and Performing a Failover and Failback"><div class="titlepage"><div><div><h1 class="title"><a id="ch03"/>Chapter 3. Testing and Performing a Failover and Failback</h1></div></div></div><p>In the previous chapter, we learned how to create Protection Groups and Recovery Plans. As discussed, Recovery Plans are nothing but a previously created workflow for the recovery of a failed site. In this chapter, we will learn how to test Recovery Plans that are already created, how to use them to perform a Failover, panned migration, reprotect, and Failback.</p><p>The following is a list of topics that will be covered in this chapter:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Testing a Recovery Plan</li><li class="listitem" style="list-style-type: disc">Performing a Planned Migration</li><li class="listitem" style="list-style-type: disc">Performing a disaster recovery (Failover)</li><li class="listitem" style="list-style-type: disc">Reprotecting a site</li><li class="listitem" style="list-style-type: disc">Failback to the protected site</li><li class="listitem" style="list-style-type: disc">Configuring VM recovery properties</li></ul></div><div class="section" title="Testing a Recovery Plan"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec19"/>Testing a Recovery Plan</h1></div></div></div><p>A Recovery<a id="id112" class="indexterm"/> Plan should be tested for its readiness to make sure that it would work as expected in the event of a real disaster. Most organizations periodically review and update their recovery runbook to make sure that they have an optimized, working plan for a recovery.</p><p>With SRM, the testing of a Recovery Plan can now be automated. It is important to understand the workflow involved in testing a Recovery Plan before we delve into details of what really happens in the background.</p><p>The following steps will guide you through the procedure for testing an already-existing Recovery Plan:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> on the left pane.</li><li class="listitem">Click<a id="id113" class="indexterm"/> on the Recovery Plan that you want to test and click on the <span class="strong"><strong>Test</strong></span> toolbar item to bring up the <span class="strong"><strong>Test</strong></span> wizard, as shown in the following screenshot:<div class="mediaobject"><img src="graphics/6442EN_05_01.jpg" alt="Testing a Recovery Plan"/></div></li><li class="listitem">As shown in the following screenshot, the first screen of the wizard will indicate which of the sites have been designated as the protected and recovery sites, the site connection status, and the number of VMs protected:<div class="mediaobject"><img src="graphics/6442EN_05_02.jpg" alt="Testing a Recovery Plan"/></div><p>By <a id="id114" class="indexterm"/>default, the storage option <span class="strong"><strong>Replicate the recent changes to the recovery site</strong></span> is selected. I would recommend not deselecting this option because we replicate the recent changes during a Planned Migration. So, it is important that the ability of the array to respond to a nonscheduled replication request is tested. However, we might not need to do this if the replication is synchronous. Click on <span class="strong"><strong>Next</strong></span> to continue.</p></li><li class="listitem">The next screen will summarize the selected options as shown in the following screenshot. Review them and click on <span class="strong"><strong>Start</strong></span> to initiate the test:<div class="mediaobject"><img src="graphics/6442EN_05_03.jpg" alt="Testing a Recovery Plan"/></div></li><li class="listitem">You <a id="id115" class="indexterm"/>should now see a <span class="strong"><strong>Test Recovery Plan</strong></span> task in the <span class="strong"><strong>Recent Tasks</strong></span> pane. Navigate to the <span class="strong"><strong>Recovery Steps</strong></span> tab to watch the progress of the test as shown in the following screenshot:<div class="mediaobject"><img src="graphics/6442EN_05_04.jpg" alt="Testing a Recovery Plan"/></div></li><li class="listitem">Once the <a id="id116" class="indexterm"/>test completes successfully, you will see the following <span class="strong"><strong>Test Complete</strong></span> banner appear in the <span class="strong"><strong>Summary</strong></span> tab of the Recovery Plan:<div class="mediaobject"><img src="graphics/6442EN_05_05.jpg" alt="Testing a Recovery Plan"/></div></li></ol></div><div class="section" title="How does a test work?"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec20"/>How does a test work?</h2></div></div></div><p>The testing of a Recovery Plan is done in such a way that it doesn't affect the current operations, which include replication schedules and the actual replicas, or the protected virtual machines. In this section of the chapter, we will learn how this is achieved.</p><p>The following figure shows an overview of the steps involved during the testing of a Recovery Plan:</p><div class="mediaobject"><img src="graphics/6442EN_05_06.jpg" alt="How does a test work?"/></div><p>When<a id="id117" class="indexterm"/> you initiate a test, SRM instructs the <span class="strong"><strong>Storage Replication Adapter</strong></span> to execute a replication cycle to replicate the latest changes to the replica LUN at the recovery site. However, this will only happen if you had chosen to leave the default option to replicate recent changes checked. You wouldn't need to replicate the recent change when the replication is synchronous, as the replica would already have the latest change. Refer to your replication vendor documentation for more information.</p><p>Once the replication is complete, it then needs to find a way to present the replica LUN's data to the recovery ESXi hosts so that the virtual machines can be powered on. This is achieved differently by different storage arrays. The most common methodology is to create a writable snapshot of the replica LUN, and then present the snapshot to the recovery ESXi hosts. The hosts will subsequently scan their HBAs to detect the VMFS volumes on the LUN.</p><p>Before the snapshot is presented to the ESXi hosts, SRM needs to make sure that there is enough room (compute capacity) at the recovery site to power on the recovered VMs. To make room for the VMs, SRM could power off the noncritical VMs (<span class="emphasis"><em>if included in the Recovery Plan</em></span>) and <a id="id118" class="indexterm"/>also power up the ESXi hosts that were put into the standby mode (if any) by the <span class="strong"><strong>Distributed Power Management</strong></span> (<span class="strong"><strong>DPM</strong></span>).</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note03"/>Note</h3><p>The noncritical VMs that SRM chooses to suspend are those that were marked as noncritical for the Recovery Plan, using the <span class="strong"><strong>Add Non-Critical VM</strong></span> option.</p></div></div><p>To power on the recovered VMs, they have to be registered to the recovery site's vCenter Server. This is achieved by replacing the shadow VM entries with the entries corresponding to the recovered VMs. Keep in mind that the shadow VMs are mere inventory objects and that they do not have any VMDKs mapped to them.</p><p>The VMs are then configured to connect to the test network. The test network can either be a port group that you created for the test or an auto bubble network created on a new vSphere Standard Switch with no physical uplinks. </p><p>The<a id="id119" class="indexterm"/> following screenshot shows a vSphere <span class="strong"><strong>Standard Switch</strong></span> and a <span class="strong"><strong>Port Group</strong></span> that was automatically created during a test for the auto bubble network:</p><div class="mediaobject"><img src="graphics/6442EN_05_07.jpg" alt="How does a test work?"/></div><p>Once the VMs have been configured to connect to the test network, they are powered on. Keep in mind that the testing of a Recovery Plan does not affect the power state of the protected virtual machines at the protected site.</p></div><div class="section" title="Performing the cleanup after a test"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec21"/>Performing the cleanup after a test</h2></div></div></div><p>We <a id="id120" class="indexterm"/>know from the previous section that during<a id="id121" class="indexterm"/> the course of the testing of a Recovery Plan, SRM executes the creation of certain elements to enact a disaster recovery in a manner that will not affect the running environment. Hence, the changes made and the objects created are temporary and have to be cleaned up after a successful test. Fortunately, this is not a manual process either. SRM provides an automated method to perform a cleanup.</p><p>The following actions will occur during a cleanup:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The ESXi hosts will be put back into the DPM standby mode</li><li class="listitem" style="list-style-type: disc">The Recovery VMs will be powered off</li><li class="listitem" style="list-style-type: disc">The Suspended noncritical VMs will be powered on</li><li class="listitem" style="list-style-type: disc">The inventory entries of the Recovery VMs will be replaced with their corresponding Shadow VM entries</li><li class="listitem" style="list-style-type: disc">The VMFS volume will be unmounted</li><li class="listitem" style="list-style-type: disc">The LUN device will be detached</li><li class="listitem" style="list-style-type: disc">The storage initiators and Refresh Storage System will be rescanned</li><li class="listitem" style="list-style-type: disc">The writable snapshot that was created will be deleted</li><li class="listitem" style="list-style-type: disc">The Port Group and the vSwitch that were created for the bubble network will be removed</li></ul></div><p>The following<a id="id122" class="indexterm"/> procedure will guide you through the<a id="id123" class="indexterm"/> steps required for the cleanup:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> on the left pane.</li><li class="listitem">Select the Recovery Plan with the status <span class="strong"><strong>Test Complete</strong></span>.</li><li class="listitem">Click on the <span class="strong"><strong>Cleanup</strong></span> item in the toolbar, as shown in the following screenshot, to bring up the cleanup wizard:<div class="mediaobject"><img src="graphics/6442EN_05_08.jpg" alt="Performing the cleanup after a test"/></div></li><li class="listitem">In the cleanup wizard, the details regarding the current protected and recovery sites, their connection status, and the number of protected VMs are displayed. Note that the <span class="strong"><strong>Force Cleanup</strong></span> option is grayed out. This option will only be available if the cleanup operation attempt has failed during the previous attempt. Click on <span class="strong"><strong>Next</strong></span> to continue.</li><li class="listitem">The next screen will summarize the cleanup options selected. Click on <span class="strong"><strong>Start</strong></span> to initiate the cleanup.</li><li class="listitem">The <span class="strong"><strong>Recent Tasks</strong></span> pane should show the <span class="strong"><strong>Cleanup Test Recovery</strong></span> task as successfully completed.</li></ol></div></div></div></div>
<div class="section" title="Performing a Planned Migration"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec20"/>Performing a Planned Migration</h1></div></div></div><p>VMware <a id="id124" class="indexterm"/>SRM can be used to migrate your workload from one site to another. A Planned Migration is done when the protected site is available and is running the virtual machine workload.</p><p>There are many use cases, of which the following two are prominent:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">When migrating your infrastructure to a new hardware</li><li class="listitem" style="list-style-type: disc">When migrating your virtual machine storage from one array to another</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>A Planned Migration will replicate the most recent changes with the help of storage replication. This is not optional.</p></div></div><p>The following procedure will guide you through the steps required to perform a Planned Migration:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> on the left pane.</li><li class="listitem">Select the Recovery Plan that was created for the Planned Migration and click on the <span class="strong"><strong>Recovery</strong></span> toolbar item, as shown in the following screenshot, to bring up the recovery wizard:<div class="mediaobject"><img src="graphics/6442EN_05_09.jpg" alt="Performing a Planned Migration"/></div></li><li class="listitem">As shown in the following screenshot, the first screen will seek a <span class="strong"><strong>Recovery Confirmation</strong></span>. The <span class="strong"><strong>Recovery Type</strong></span> will be preselected as <span class="strong"><strong>Planned Migration</strong></span>. You should acknowledge the recovery confirmation to proceed further. Click on <span class="strong"><strong>Next</strong></span> to continue.<div class="mediaobject"><img src="graphics/6442EN_05_10.jpg" alt="Performing a Planned Migration"/></div></li><li class="listitem">The<a id="id125" class="indexterm"/> next screen will summarize the wizard options that were selected. Click on <span class="strong"><strong>Start</strong></span> to initiate the migration.</li><li class="listitem">The <span class="strong"><strong>Recent Tasks</strong></span> pane should now show the <span class="strong"><strong>Failover Recovery Plan</strong></span> task as successfully completed.</li></ol></div><p>The Planned Migration will not proceed further if any of the recovery steps fail. However, when you re-attempt the Planned Migration, it would resume the operation from the step at which it failed. This enables you to fix the problem and resume from where it failed, saving a considerable amount of time.</p><p>The following flowchart shows the logical sequence of events that would occur during the course of a Planned Migration:</p><div class="mediaobject"><img src="graphics/6442EN_05_11.jpg" alt="Performing a Planned Migration"/></div></div>
<div class="section" title="Performing a disaster recovery (Failover)"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec21"/>Performing a disaster recovery (Failover)</h1></div></div></div><p>A Failover<a id="id126" class="indexterm"/> is performed when the protected site becomes fully or partially unavailable. We use a Recovery Plan that is already created and tested to perform the Failover. Keep in mind that SRM does not automatically determine the occurrence of a disaster at the protected site; hence, a recovery is always to be manually initiated.</p><p>The following steps show how to perform a Failover:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> on the left pane.</li><li class="listitem">Select the Recovery Plan that was created for the disaster recovery and click on the <span class="strong"><strong>Recovery</strong></span> toolbar item to bring up the recovery wizard.</li><li class="listitem">In the recovery wizard, as shown in the following screenshot, agree to the <span class="strong"><strong>Recovery Confirmation</strong></span>, set the <span class="strong"><strong>Recovery Type</strong></span> as <span class="strong"><strong>Disaster Recovery</strong></span>, and click on <span class="strong"><strong>Next</strong></span> to continue:<div class="mediaobject"><img src="graphics/6442EN_05_12.jpg" alt="Performing a disaster recovery (Failover)"/></div></li><li class="listitem">The <a id="id127" class="indexterm"/>next screen will summarize the selected wizard options. Click on <span class="strong"><strong>Start</strong></span> to perform the recovery.</li><li class="listitem">The <span class="strong"><strong>Recovery Steps</strong></span> tab of the Recovery Plan will show the progress of each of the steps involved.</li><li class="listitem">Once the Failover is complete, the status of the Recovery Plan should read <span class="strong"><strong>Recovery Complete</strong></span>.</li></ol></div><p>The recovery steps involved in a disaster recovery (Failover) is the same as in that of a Planned Migration, except for the fact that SRM ignores any unsuccessful attempts to pre-synchronize the storage or shut down the protected virtual machines.</p></div>
<div class="section" title="Forced Recovery"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec22"/>Forced Recovery</h1></div></div></div><p>Forced Recovery<a id="id128" class="indexterm"/> is used when the protected site is no longer operational enough to allow SRM to perform its tasks at the protected site before the Failover.</p><p>For instance, there is an unexpected power outage at the protected site causing not just the ESXi hosts but also the storage array to become unavailable. In this scenario, SRM cannot perform any of its tasks, such as shutting down the protected VMs or replicating the most<a id="id129" class="indexterm"/> recent storage changes (if the replication is asynchronous), at the protected site.</p><div class="section" title="Enabling Forced Recovery for a site"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec22"/>Enabling Forced Recovery for a site</h2></div></div></div><p>Forced<a id="id130" class="indexterm"/> Recovery is not enabled by default, but it can<a id="id131" class="indexterm"/> be enabled at the site's advanced settings. To do so, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Sites</strong></span> on the left pane.</li><li class="listitem">Right-click on the site and click on <span class="strong"><strong>Advanced Settings</strong></span>.<div class="mediaobject"><img src="graphics/6442EN_05_15.jpg" alt="Enabling Forced Recovery for a site"/></div></li><li class="listitem">In the <span class="strong"><strong>Advanced Settings</strong></span> windows, select the category <span class="strong"><strong>recovery</strong></span> from the left pane.</li><li class="listitem">Select the checkbox against the <span class="strong"><strong>recovery.forceRecovery</strong></span> setting, as shown in the following screenshot, and click on <span class="strong"><strong>OK</strong></span> to enable Forced Recovery:<div class="mediaobject"><img src="graphics/6442EN_05_16.jpg" alt="Enabling Forced Recovery for a site"/></div></li></ol></div></div><div class="section" title="Running Forced Recovery"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec23"/>Running Forced Recovery</h2></div></div></div><p>Running<a id="id132" class="indexterm"/> Forced Recovery will skip all the steps that otherwise should have been performed against the protected site. You should use Forced Recovery only during circumstances where the protected site is completely down, leaving no connectivity to either the ESXi hosts or the storage array. If Forced Recovery were to be executed while the protected site is still online and available, then it would leave the virtual machines running at both the protected and recovery sites, causing a split-brain condition for SRM. Furthermore, if the array-based replication was asynchronous, then the chances are that the virtual machines that were started at the recovery site are running old data compared to the ones in the protected site. So, it very important that you take caution before you plan to execute Forced Recovery.</p><p>The following steps show how Forced Recovery is executed:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> on the left pane.</li><li class="listitem">Right-click on the Recovery Plan that you want to run and click on <span class="strong"><strong>Recovery</strong></span>.</li><li class="listitem">In the recovery wizard, select the <span class="strong"><strong>I understand that this process will permanently alter the virtual machines and infrastructure of both the protected and recovery datacenters</strong></span> checkbox.</li><li class="listitem">As shown in the following screenshot, select the <span class="strong"><strong>Recovery Type</strong></span> as <span class="strong"><strong>Disaster Recovery</strong></span>, select the checkbox <span class="strong"><strong>Forced Recovery – recovery site operations only</strong></span>, and click on <span class="strong"><strong>Next</strong></span>:<div class="mediaobject"><img src="graphics/6442EN_05_17.jpg" alt="Running Forced Recovery"/></div></li><li class="listitem">You <a id="id133" class="indexterm"/>will be prompted to confirm the <span class="strong"><strong>Forced Recovery</strong></span>. Click on <span class="strong"><strong>Yes</strong></span> to confirm.<div class="mediaobject"><img src="graphics/6442EN_05_18.jpg" alt="Running Forced Recovery"/></div></li><li class="listitem">Review the<a id="id134" class="indexterm"/> operation summary and click on <span class="strong"><strong>Start</strong></span> to initiate the Forced Recovery.</li></ol></div></div></div>
<div class="section" title="Reprotecting a site"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec23"/>Reprotecting a site</h1></div></div></div><p>After<a id="id135" class="indexterm"/> you Failover the workload from a protected site to the recovery site, the recovery site has no protection enabled for the new workload that it has begun hosting. SRM <a id="id136" class="indexterm"/>provides a method to enable protection of the recovery site. This method is called <span class="strong"><strong>Reprotect</strong></span>.</p><p>A Reprotect operation will reverse the direction of the replication, thus designating the recovery site as the new protected site. The Reprotect operation can only be done on a Recovery Plan with the <span class="strong"><strong>Recovery Complete</strong></span> status. Also, keep in mind that a Reprotect operation can only be executed when you have repaired the failed site and made it available to become a recovery site.</p><p>For instance, let's assume that SITE-A and SITE-B are the protected and recovery sites, respectively. If workload at SITE-A were failed over to SITE-B, then to Reprotect SITE-B, SITE-A should be made accessible. This would mean fixing the problems that caused the failure at SITE-A.</p><p>The following <a id="id137" class="indexterm"/>steps show how to perform the Reprotect operation:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> in the left pane.</li><li class="listitem">Select the <span class="strong"><strong>Recovery Plan</strong></span> with the <span class="strong"><strong>Recovery Complete</strong></span> status, as shown in the following screenshot, and click on the toolbar item <span class="strong"><strong>Reprotect</strong></span>:<div class="mediaobject"><img src="graphics/6442EN_05_13.jpg" alt="Reprotecting a site"/></div></li><li class="listitem">In the <span class="strong"><strong>Reprotect</strong></span> wizard screen, agree to the <span class="strong"><strong>Reprotect Confirmation</strong></span> and click on <span class="strong"><strong>Next</strong></span> to continue:<div class="mediaobject"><img src="graphics/6442EN_05_14.jpg" alt="Reprotecting a site"/></div></li><li class="listitem">In <a id="id138" class="indexterm"/>the next screen, click on <span class="strong"><strong>Start</strong></span> to begin the Reprotect operation.</li><li class="listitem">You <a id="id139" class="indexterm"/>should see a progressing <span class="strong"><strong>Reprotect Recovery Plan</strong></span> task in the <span class="strong"><strong>Recent Tasks</strong></span> pane. Also, the <span class="strong"><strong>Recovery Steps</strong></span> tab will show the progress of every step involved in the Reprotect operation.</li><li class="listitem">The status of the Recovery Plan after a successful Reprotect operation should read <span class="strong"><strong>Ready</strong></span>.</li></ol></div></div>
<div class="section" title="Failback to the protected site"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec24"/>Failback to the protected site</h1></div></div></div><p>In a<a id="id140" class="indexterm"/> scenario where, after a Failover, the original protected site is fixed and is made available to host the virtual machine workload, you can use SRM to automate a Failback.</p><p>The Failback, although automated, is a two-step process, which is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Step 1 will be to perform a Reprotect operation. Read the <span class="emphasis"><em>Reprotecting a site</em></span> section in this chapter to learn how to perform a Reprotect operation.</li><li class="listitem" style="list-style-type: disc">Step 2 will be<a id="id141" class="indexterm"/> to perform a Failover. Read the <span class="emphasis"><em>Performing a disaster recovery (Failover)</em></span> section in this chapter to learn how to perform a Failover.</li></ul></div></div>
<div class="section" title="Configuring VM recovery properties"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec25"/>Configuring VM recovery properties</h1></div></div></div><p>The VM <a id="id142" class="indexterm"/>recovery properties help in further customizing the recovery procedure at a per-VM level. Although these properties are only available via a Recovery Plan, the changes made to these properties are retained for the VM, regardless of the Recovery Plan they would be included in.</p><p>The following are the properties that can be set on a protected virtual machine:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>IP Settings</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Priority Group</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>VM Dependencies</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Shutdown Action</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Startup Action</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Pre-power On Steps</strong></span></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Post Power On Steps</strong></span></li></ul></div><p>Here is how you could get to the <span class="strong"><strong>Recovery Properties</strong></span> of a virtual machine:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Navigate to the vCenter Server's inventory home page and click on <span class="strong"><strong>Site Recovery</strong></span>.</li><li class="listitem">Click on <span class="strong"><strong>Recovery Plans</strong></span> on the left pane.</li><li class="listitem">Select a <span class="strong"><strong>Recovery Plan</strong></span> (<span class="strong"><strong>A</strong></span>) and navigate to its <span class="strong"><strong>Virtual Machines</strong></span> tab (<span class="strong"><strong>B</strong></span>), which should list all the virtual machines that are included in the Recovery Plan.</li><li class="listitem">Select a virtual machine from the list (<span class="strong"><strong>C</strong></span>) and click on <span class="strong"><strong>Configure Recovery</strong></span> (<span class="strong"><strong>D</strong></span>) to bring up the VM recovery properties:<div class="mediaobject"><img src="graphics/6442EN_05_19.jpg" alt="Configuring VM recovery properties"/></div></li></ol></div><p>The<a id="id143" class="indexterm"/> VM <span class="strong"><strong>Properties</strong></span> windows will show all the properties available for customization. We will visit each of these properties further in this section.</p><div class="section" title="IP settings"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec24"/>IP settings</h2></div></div></div><p>The<a id="id144" class="indexterm"/> IP settings property is a per-vNIC<a id="id145" class="indexterm"/> property for the virtual machine that is part of the Recovery Plan. It is used to customize the IP configuration of the virtual machine during a Planned Migration/Failover.</p><p>As the settings are per vNIC, you should enable the IP customization for each of the vNIC that you want to supply the IP settings for. It is done by choosing the vNIC from the left pane (<span class="strong"><strong>A</strong></span>) and then selecting the <span class="strong"><strong>Customize IP setting during recovery</strong></span> checkbox (<span class="strong"><strong>B</strong></span>), as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6442EN_05_20.jpg" alt="IP settings"/></div><p>
The IP setting can be separate for both the protected and recovery sites.
</p><p>To configure the IP settings for a Recovery from the original recovery site to the original protected <a id="id146" class="indexterm"/>site, use the <span class="strong"><strong>Configure Protection</strong></span> option (<span class="strong"><strong>P</strong></span>), and to configure the IP settings for a Recovery from the protected site to the<a id="id147" class="indexterm"/> recovery site, use the <span class="strong"><strong>Configure Recovery</strong></span> option (<span class="strong"><strong>R</strong></span>), as shown in the following screenshot:</p><div class="mediaobject"><img src="graphics/6442EN_05_21.jpg" alt="IP settings"/></div><p>When you hit either <span class="strong"><strong>Configure Protection</strong></span> or <span class="strong"><strong>Configure Recovery</strong></span>, a new IP settings window is shown. You can either choose to use DHCP, IPv4, or IPv6. It also has options to supply the DNS Server details. You could also choose to fetch the current IP configuration of the<a id="id148" class="indexterm"/> VM using the <span class="strong"><strong>Retrieve</strong></span> button. For the retrieve operation to work, you need VMware Tools installed and running in the VM:</p><div class="mediaobject"><img src="graphics/6442EN_05_22.jpg" alt="IP settings"/></div><p>Once<a id="id149" class="indexterm"/> the settings have been supplied, click<a id="id150" class="indexterm"/> on <span class="strong"><strong>OK</strong></span> to save the IP customization.</p></div><div class="section" title="Priority Group"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec25"/>Priority Group</h2></div></div></div><p>Priority Groups<a id="id151" class="indexterm"/> are used to set the startup order<a id="id152" class="indexterm"/> of the virtual machines. SRM uses five Priority Groups numbered from 1 to 5. Their priority and startup order are shown in the following table:</p><div class="informaltable"><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Priority Group</p>
</th><th style="text-align: left" valign="bottom">
<p>Priority</p>
</th><th style="text-align: left" valign="bottom">
<p>Startup order</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Priority Group 1</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Highest</p>
</td><td style="text-align: left" valign="top">
<p>First</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Priority Group 2</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Higher than group 3</p>
</td><td style="text-align: left" valign="top">
<p>Before group 3</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Priority Group 3</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Higher than group 4</p>
</td><td style="text-align: left" valign="top">
<p>Before group 4</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Priority Group 4</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Higher than group 5</p>
</td><td style="text-align: left" valign="top">
<p>Before group 5</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<span class="strong"><strong>Priority Group 5</strong></span>
</p>
</td><td style="text-align: left" valign="top">
<p>Lowest</p>
</td><td style="text-align: left" valign="top">
<p>Last</p>
</td></tr></tbody></table></div><p>As <a id="id153" class="indexterm"/>shown in the following screenshot, the VMs <a id="id154" class="indexterm"/>of the lowest numbered Priority Group are started first:</p><div class="mediaobject"><img src="graphics/6442EN_05_23.jpg" alt="Priority Group"/></div><p>By default, every VM is in <span class="strong"><strong>Priority Group 3</strong></span>. During a Failover, SRM will wait for all the VMs in a <span class="strong"><strong>Priority Group</strong></span> to Failover successfully or fail to Failover before it attempts to power on VMs from a group with lower priority. For instance, SRM will wait for all the VMs in <span class="strong"><strong>Priority Group 2</strong></span> to Failover before it can attempt the Failover of the VMs in <span class="strong"><strong>Priority Group 3</strong></span>. This is because <span class="strong"><strong>Priority Group 2</strong></span> has a higher priority than <span class="strong"><strong>Priority Group 3</strong></span>.</p></div><div class="section" title="VM Dependencies"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec26"/>VM Dependencies</h2></div></div></div><p>So, what <a id="id155" class="indexterm"/>happens if all the VMs running the <a id="id156" class="indexterm"/>services of the three-tier application are in the same Priority Group? Can we configure a startup order within a Priority Group? The answer is yes. This is where VM Dependencies come in handy.</p><p>Let's consider a three-tier application, which has a database, a server component, and the user interface component hosted on three different VMs. Now, in this case the server component is dependent on the availability of the database, and the user interface component is dependent on the server component. This means the database VM should start first, then the VM hosting the service component, and finally the VM hosting the user<a id="id157" class="indexterm"/> interface component. Such a startup order <a id="id158" class="indexterm"/>can be achieved using the VM Dependencies Recovery Property.</p><p>The following steps show how a VM Dependency startup order is created:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Get to the Recovery Properties of the virtual machine.</li><li class="listitem">Select <a id="id159" class="indexterm"/>the <span class="strong"><strong>VM Dependencies</strong></span> property from the left pane (<span class="strong"><strong>A</strong></span>).</li><li class="listitem">Click on <span class="strong"><strong>Add</strong></span> to browse and add VMs to the list (<span class="strong"><strong>B</strong></span>). Only the VMs from the Protection Groups that are part of the Recovery Plan can be added as shown in the following screenshot:<div class="mediaobject"><img src="graphics/6442EN_05_24.jpg" alt="VM Dependencies"/></div></li><li class="listitem">Once the virtual machines are added, click on <span class="strong"><strong>OK</strong></span> to save the settings. Keep in mind that the virtual machines are started in the order of their appearance in the list. So make sure that you plan to add the VMs in the order in which you want<a id="id160" class="indexterm"/> them to start. You<a id="id161" class="indexterm"/> can also remove a VM from the list by hitting<a id="id162" class="indexterm"/> the <span class="strong"><strong>Remove</strong></span> button.</li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note05"/>Note</h3><p>Note that the dependencies between VMs of different Priority Groups are ignored by SRM. Also, the dependencies are not mandatory rules; hence, they wouldn't stop the Recovery Plan from continuing. If a VM dependency fails, it throws a warning and proceeds with the execution of the Recovery Plan.</p></div></div></div><div class="section" title="The Shutdown Action"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec27"/>The Shutdown Action</h2></div></div></div><p>The <a id="id163" class="indexterm"/>Shutdown Action VM Recovery <a id="id164" class="indexterm"/>property will let you choose whether a virtual machine at the protected site will be attempted to gracefully shut down or powered off during a Planned Migration or disaster recovery. It also lets you set the amount of time SRM waits on VMware Tools to shut down the virtual machine before it issues a power off. The default timeout value is <span class="strong"><strong>5</strong></span> minutes:</p><div class="mediaobject"><img src="graphics/6442EN_05_25.jpg" alt="The Shutdown Action"/></div><p>A disaster recovery will power off the VM after the timeout, but a Planned Migration will not proceed further if the VM cannot be gracefully shut down.</p></div><div class="section" title="The Startup Action"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec28"/>The Startup Action</h2></div></div></div><p>The Startup Action property will let you choose whether or not to power on a virtual machine <a id="id165" class="indexterm"/>at the recovery site during a test <a id="id166" class="indexterm"/>or a Recovery operation. By default, after a virtual machine is powered on at the recovery site, SRM waits for 5 minutes to determine whether the virtual machine tools have started. If it sees no response from VMware Tools, it marks a failure of that task and proceeds with the Recovery operation. However, the Recovery operation will have an <span class="strong"><strong>Incomplete Recovery</strong></span> status. You can also add further delay before any of the dependent VM are started or before the execution of any <span class="strong"><strong>Post Power On Steps</strong></span>. This is commonly used to give the service running in the VM an additional time to start.</p><div class="mediaobject"><img src="graphics/6442EN_05_26.jpg" alt="The Startup Action"/></div></div><div class="section" title="The Pre-power On Steps and Post Power On Steps properties"><div class="titlepage"><div><div><h2 class="title"><a id="ch03lvl2sec29"/>The Pre-power On Steps and Post Power On Steps properties</h2></div></div></div><p>The <span class="strong"><strong>Pre-power On Steps</strong></span> and <span class="strong"><strong>Post Power On Steps</strong></span> are <span class="strong"><strong>VM Recovery Properties</strong></span> that allow<a id="id167" class="indexterm"/> the insertion of additional steps into the Recovery Plan.</p><p>With <a id="id168" class="indexterm"/>the <span class="strong"><strong>Pre-power On Steps</strong></span> property, you can create the following type of steps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A Windows batch command on the SRM Server</li><li class="listitem" style="list-style-type: disc">A message prompt, which the user/administrator should dismiss before the Recovery Plan can begin its execution</li></ul></div><p>With<a id="id169" class="indexterm"/> the <span class="strong"><strong>Post Power On Steps</strong></span> property, you<a id="id170" class="indexterm"/> can create the following type of steps:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A command on the Recovered virtual machine</li><li class="listitem" style="list-style-type: disc">A Windows batch command on the SRM Server</li></ul></div><p>Creating<a id="id171" class="indexterm"/> a message prompt is straightforward. It is done in the following way:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <span class="strong"><strong>Pre-power On Step</strong></span> / <span class="strong"><strong>Post Power On Step</strong></span> property from the left plane and click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Add Pre-power On Step</strong></span> / <span class="strong"><strong>Add Post Power On Step</strong></span> window, select the <span class="strong"><strong>Type</strong></span> as <span class="strong"><strong>Prompt (requires a user to dismiss before the plan will continue)</strong></span>.</li><li class="listitem">Supply a <span class="strong"><strong>Name</strong></span> and <span class="strong"><strong>Content</strong></span> and click on <span class="strong"><strong>OK</strong></span> to save the setting.</li></ol></div><p>To create<a id="id172" class="indexterm"/> a Windows batch command on the SRM Server, perform the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the <span class="strong"><strong>Pre-power On Step</strong></span> / <span class="strong"><strong>Post Power On Steps</strong></span> property from the left plane and click on <span class="strong"><strong>Add</strong></span>.</li><li class="listitem">In the <span class="strong"><strong>Add Pre-power On Step</strong></span> / <span class="strong"><strong>Add Post Power On Step</strong></span> window, select <span class="strong"><strong>Command on SRM Server</strong></span> as the <span class="strong"><strong>Type</strong></span>.</li><li class="listitem">Supply a <span class="strong"><strong>Name</strong></span> of the script and the command script in the <span class="strong"><strong>Content</strong></span> section. Type the actual command. For instance, to run a batch script in <code class="literal">D:\demoscript.bat</code>, include the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>c:\windows\system32\cmd.exe /c d:\demoscript.bat</strong></span>
</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip05"/>Tip</h3><p>For <code class="literal">cmd.exe</code>, always mention the absolute path <code class="literal">c:\windows\system32\cmd.exe</code>
</p></div></div></li></ol></div><p>The default timeout for a batch command is 5 minutes. If the batch file doesn't finish executing within 5 minutes, then the execution of the Recovery Plan will stop with an error indicating the same.</p></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch03lvl1sec26"/>Summary</h1></div></div></div><p>In this chapter, we learned how to use the SRM to orchestrate the testing of a Recovery Plan, performing Planned Migrations and recovery. We also learned how to Failback to a designated protected site after a Failover.</p></div></body></html>