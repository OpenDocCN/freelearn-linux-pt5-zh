<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02" class="calibre1"/>Chapter 2. Circumventing Censorship with a Tor Bridge</h1></div></div></div><p class="calibre7">In this chapter, you'll configure your <span class="strong"><strong class="calibre8">BeagleBone Black</strong></span> (<span class="strong"><strong class="calibre8">BBB</strong></span>) to <a id="id94" class="calibre1"/>run a bridge in the Tor network. This bridge will allow you and others to access the Internet more anonymously and provide an anti-censorship gateway. We'll add a simple hardware control interface to BBB so that we can see and adjust the bandwidth usage of the bridge in real time. We'll call this project BeagleBridge.</p><p class="calibre7">This chapter will discuss the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">An introduction to Tor</li><li class="listitem">The difference between a Tor relay and bridge</li><li class="listitem">Obfuscated Tor proxies</li><li class="listitem">How to download and install Tor on BBB</li><li class="listitem">How to configure BBB as a Tor bridge running an obfuscated proxy</li><li class="listitem">How to add hardware controls to adjust the bridge from a front panel</li></ul></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch02lvl1sec14" class="calibre1"/>Learning about Tor</h1></div></div></div><p class="calibre7">In this project, you will learn how to use<a id="id95" class="calibre1"/> Tor, a tool and network designed to protect your anonymity online. Tor originally developed from research, sponsored by the U.S. Naval Research Laboratory, on<a id="id96" class="calibre1"/> <span class="strong"><strong class="calibre8">onion routing</strong></span> (Dingledine, Mathewson, and Syverson, 2004). In onion routing, the client builds a circuit of nodes in an overlay network, which is a network built on top of an existing network. The Tor network<a id="id97" class="calibre1"/> is an overlay network that runs on the Internet, although it can run on separate networks. The client sends a message to each node, which is specifically encrypted for that node, asking the node to send it to the next node in the circuit. Each node peels back a layer of encryption and forwards the result to the next hop in the circuit, and hence, the <a id="id98" class="calibre1"/>
<span class="strong"><strong class="calibre8">onion analogy</strong></span>. The last node contains the client's actual message, which is forwarded to the destination server.</p><p class="calibre7">Onion routing <a id="id99" class="calibre1"/>provides anonymity because the destination server does not know the IP address of the client. Typically, when you use your browser to access the Internet, the browser creates a <span class="strong"><strong class="calibre8">Transmission Control Protocol</strong></span> (<span class="strong"><strong class="calibre8">TCP</strong></span>)<a id="id100" class="calibre1"/> connection that originates from your system and terminates at the website you are trying to visit. The address for TCP is provided by the <a id="id101" class="calibre1"/>
<span class="strong"><strong class="calibre8">Internet Protocol</strong></span> (<span class="strong"><strong class="calibre8">IP</strong></span>). Each IP datagram contains a source and destination IP address. As datagrams arrive at the server, the server can read the source IP address. This is generally useful as the server needs this address to return your data. However, this also means that the server knows your IP address, which is where you live on the Internet. Your IP address alone reveals information about you, such as the country in which you live and your<a id="id102" class="calibre1"/> <span class="strong"><strong class="calibre8">Internet Service Provider</strong></span> (<span class="strong"><strong class="calibre8">ISP</strong></span>). Geolocating by an IP address can be accurate to the zip code level, when you use United States as an example.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note08" class="calibre1"/>Note</h3><p class="calibre7">
<span class="strong"><strong class="calibre8">Tor</strong></span>, originally an <a id="id103" class="calibre1"/>acronym for <span class="strong"><strong class="calibre8">The Onion Router</strong></span>, is now simply referred to as <span class="strong"><em class="calibre9">Tor</em></span>, not <span class="strong"><em class="calibre9">TOR</em></span>. When you ask questions on the Tor mailing list or IRC channels, Tor developers will appreciate it if you make note of this subtlety.</p></div><p class="calibre7">The following diagram shows this routing. In this case, Alice is a client who connects to the first node of her circuit, which happens to be running on your BBB. This BBB unwraps a layer and forwards Alice's communication to the middle node. The middle node does the same to the final (exit) node. The exit node sends Alice's original message to the destination server named Bob. The green arrows show internal Tor connections that are encrypted. The connection from the exit node to Bob is shown as an unencrypted connection because this traffic is not part of the Tor network. From Bob's perspective, the IP originator of this connection is the exit node. However, the true originator is Alice whose IP is hidden by the Tor network.</p><div class="mediaobject"><img src="../images/00006.jpeg" alt="Learning about Tor" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The response to this information by many individuals is:</p><div class="blockquote"><blockquote class="blockquote1"><p class="calibre22"><span class="strong"><em class="calibre9">"So what? Why do I care if the website I'm visiting knows my IP address?"</em></span></p></blockquote></div><p class="calibre7">The website, which knows the data you requested, now knows your location. This information could be combined with other public information, for example, to conduct a <span class="strong"><strong class="calibre8">linkage attack</strong></span>. A <a id="id104" class="calibre1"/>linkage attack is an attempt at deanonymization by combining information from multiple sources. For example, let's say you are searching for information on a rare medical condition. You post a question on a forum, under a pseudonym, asking for information. However, the website, and anybody passively monitoring your connection (if it wasn't encrypted), knows your general location as well as your question. Your medical condition is most prevalent in Hispanic females in their seventies. Using your IP address combined with knowledge about your medical condition, one can conduct a linkage attack possibly using public census data to reveal your identity.</p><p class="calibre7">Tor protects against this kind of attacks by encrypting your traffic through the Tor network and masking your IP address. To the remote website, your IP address will be that of the last node in the Tor network, known as an exit relay.</p></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor">
<div class="book" title="Appreciating the various users of Tor"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec18" class="calibre1"/>Appreciating the various users of Tor</h2></div></div></div><p class="calibre7">A wide range of people <a id="id105" class="calibre1"/>use Tor for daily Internet access. Individuals who don't want their <a id="id106" class="calibre1"/>ISP to collect information on the websites they visit, perhaps because they are seeking information on sensitive topics, use Tor. Government agents and the military use Tor. After all, it's difficult to go undercover online if the IP address you are connecting FROM resolves to <code class="email">fbi.gov</code>. Tor is used by whistleblowers, such as Edward Snowden, to disclose information to the press. It is also<a id="id107" class="calibre1"/> used by normal citizens when a government blocks access to the Internet. In late March 2014, when the Turkish government attempted to ban access to Twitter, the number of Tor users in Turkey jumped<a id="id108" class="calibre1"/> from around 25,000 to just under 70,000 in about two weeks.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note09" class="calibre1"/>Note</h3><p class="calibre7">Tor publishes, via a wide range of interactive graphs, numerous metrics on who is using Tor and where they're using it from. The users spike<a id="id109" class="calibre1"/> in Turkey can be seen in the graph available at <a class="calibre1" href="https://metrics.torproject.org/users.html?graph=userstats-relay-country&amp;start=2014-01-04&amp;end=2014-04-04&amp;country=tr&amp;events=off#userstats-relay-country">https://metrics.torproject.org/users.html?graph=userstats-relay-country&amp;start=2014-01-04&amp;end=2014-04-04&amp;country=tr&amp;events=off#userstats-relay-country</a>.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor">
<div class="book" title="Understanding Tor relays"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec19" class="calibre1"/>Understanding Tor relays</h2></div></div></div><p class="calibre7">
<span class="strong"><strong class="calibre8">Tor relays</strong></span>
<a id="id110" class="calibre1"/> are the<a id="id111" class="calibre1"/> individual nodes in the Tor network. A node is some type of computer that is running the Tor software. These relays route messages throughout the network. Exit nodes, which are the last nodes in the circuit, send the clients' messages to the destination service. One of the interesting aspects of Tor is that most of the nodes are run by volunteers. These relay operators volunteer their bandwidth, time, and energy bill to increase the capacity of the Tor network. The Tor Project encourages individuals to run relays in order to add to the diversity of the network. The motivation behind this recommendation is that it is easier to hide in a crowd—it's difficult to hide in a crowd of one person.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor">
<div class="book" title="Understanding Tor bridges"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec20" class="calibre1"/>Understanding Tor bridges</h2></div></div></div><p class="calibre7">In 2006, in response <a id="id112" class="calibre1"/>to an<a id="id113" class="calibre1"/> increased Internet censorship, the Tor project added an anticensorship feature called a bridge relay or simply, a bridge (Dingledine, 2006). A bridge is a special form of a relay—it's not listed in the public relay directory. Strong Internet censors were able to block access to Tor through several methods. One method that was effective was to look up all the public relays, which were only a thousand or so at the time, and deny access to those IP addresses. Therefore, bridge relays were created and distributed by less public means in order to allow users to access the Tor network. If a client could access the bridge, which was already connected to Tor, then the client could access the Internet. In this context, less public means a distribution mechanism that does not work via the public relay list.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor">
<div class="book" title="Using obfuscated proxies and pluggable transports"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec21" class="calibre1"/>Using obfuscated proxies and pluggable transports</h2></div></div></div><p class="calibre7">Censors were still able to<a id="id114" class="calibre1"/> block access to Tor; the technique was to identify the traffic patterns generated by Tor and block the connection. In 2010, Jacob Appelbaum and Nick Mathewson of the Tor Project suggested a method to obfuscate the Tor traffic between the client and the bridge in order to thwart deep packet inspection. As the <a id="id115" class="calibre1"/>obfuscation mechanism might need to change, and has changed in fact, the Tor Project wanted a generic protocol to allow different obfuscated proxies to run. This abstraction was known as <a id="id116" class="calibre1"/>
<span class="strong"><strong class="calibre8">pluggable transport</strong></span>.</p><p class="calibre7">In this chapter, we will set up your BBB to run as a Tor bridge, running an obfuscated proxy, using the obfs3 pluggable transport.</p></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor">
<div class="book" title="Realizing the limitations of Tor"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch02lvl2sec22" class="calibre1"/>Realizing the limitations of Tor</h2></div></div></div><p class="calibre7">Tor is one of the best tools<a id="id117" class="calibre1"/> currently available to protect anonymity. However, like all the <a id="id118" class="calibre1"/>security tools discussed in this book, there are limits to its protection. First of all, Tor's threat model does not hold up to a global passive adversary. Such an adversary can passively monitor the entire Internet. If an adversary can monitor the entire Internet, then it can correlate the traffic entering the Tor network with the traffic leaving the network and can possibly deanonymize Tor clients. One of the trade-offs of this design is that Tor is a low-latency system, meaning that you can access the Internet using normal protocols such as HTTP without experiencing much delay. This is one of the reasons why diversity in the Tor network is important. If all the relays were in a particular country, it might be easier for that country to monitor the traffic. However, currently it is thought to be difficult, in spite of the recent leaks provided by Edward Snowden, for such an adversary to monitor the entire Internet.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note10" class="calibre1"/>Note</h3><p class="calibre7">Roger Dingledine of the Tor Project commented on NSA's exploits of Tor with the following:</p><p class="calibre7">
<span class="strong"><em class="calibre9">"The good news is that they [the NSA] went for a browser exploit, meaning there's no indication that they can break the Tor protocol or do traffic analysis on the Tor network. Infecting the laptop, phone, or desktop is still the easiest way to learn about the human behind the keyboard."</em></span>
</p><p class="calibre7">The full text and additional commentary is available on the Tor<a id="id119" class="calibre1"/> website (<a class="calibre1" href="https://blog.torproject.org/blog/yes-we-know-about-guardian-article">https://blog.torproject.org/blog/yes-we-know-about-guardian-article</a>).</p></div><p class="calibre7">Also, Tor will not automatically encrypt all your traffic. If you request information over unencrypted HTTP, the Tor exit node you use will relay this unencrypted information to its destination. A malicious exit node can monitor or manipulate your traffic; therefore, it's always best to use encrypted sessions, such as HTTPS, over Tor. Tor does not protect all your <a id="id120" class="calibre1"/>traffic just because you are running Tor. Applications generally need to be configured to use Tor. Even if you set up a transparent proxy on your home network and route all of<a id="id121" class="calibre1"/> your traffic through that proxy, the malware or exploits in your browser may leak your identity. This is why the Tor Project recommends that you use the Tor Browser, which essentially is a forked version of Mozilla Firefox that has been patched especially to not leak your identity. Lastly, Tor can't protect your identity if you choose to reveal it. If you decide to log in to Facebook over Tor, you've just told Facebook who you are and that you are using Tor since all the Tor exit nodes are public.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip11" class="calibre1"/>Tip</h3><p class="calibre7">An easy way to use Tor more securely is to use it only from Tails<a id="id122" class="calibre1"/> (<a class="calibre1" href="https://tails.boum.org/">https://tails.boum.org/</a>), which is a <a id="id123" class="calibre1"/>custom Linux distribution that will boot from various media. Tails is a collection of free software and includes numerous correctly configured tools to help protect your confidentiality and anonymity.</p></div></div></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Circumventing Censorship with a Tor Bridge">
<div class="book" title="Learning about Tor">
<div class="book" title="The impact and benefits of running a Tor bridge"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch02lvl2sec23" class="calibre1"/>The impact and benefits of running a Tor bridge</h2></div></div></div><p class="calibre7">So, why run a Tor bridge on BBB? The impact and<a id="id124" class="calibre1"/> benefits of Tor is in the network. The more the Tor servers, the<a id="id125" class="calibre1"/> more the resources in the network. Many users in developed nations have high-speed Internet connections that are orders of magnitude faster than in countries where access to censor-free Internet is restricted. A bridge is likely to receive less traffic than a relay, as there are fewer bridge users than normal Tor users. Most likely, the limiting performance factor for your bridge will be your home network's upload speed. This can be a constraining factor if you are running a relay, but as a bridge, you are most likely helping those in precarious Internet situations and any donated bandwidth is appreciated. Lastly, running a bridge on BBB has the extra advantage of a low impact on your electric bill, as BBB will only draw about 460mA when loading a web page according to the BeagleBone Black System Reference Manual.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Installing Tor on BBB"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec15" class="calibre1"/>Installing Tor on BBB</h1></div></div></div><p class="calibre7">The instructions provided<a id="id126" class="calibre1"/> in the following sections are geared towards the user <a id="id127" class="calibre1"/>running <a id="id128" class="calibre1"/>BeagleBridge on a home network. The bridge will consume some otherwise unused bandwidth and donate it to the Tor network. You should check your ISP's Terms of Service before running a server to see whether it's permitted. Also, you'll need to configure port forwarding from your home router. As there are numerous devices, each with their own configuration mechanism, you should consult your router's manual on how to enable port forwarding.</p></div>

<div class="book" title="Installing Tor on BBB">
<div class="book" title="Installing Tor from the development repository"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec24" class="calibre1"/>Installing Tor from the development repository</h2></div></div></div><p class="calibre7">The Tor images in the <a id="id129" class="calibre1"/>official Debian repository are not <a id="id130" class="calibre1"/>as up to date as those from the <a id="id131" class="calibre1"/>Tor Project. We'll use the Tor Project's development repository to retrieve the latest software. This is especially important when you are running a bridge, as the bridge and the pluggable transport software are updated frequently.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note11" class="calibre1"/>Note</h3><p class="calibre7">The latest instructions as well as the latest GPG fingerprint can be found on the <a id="id132" class="calibre1"/>Tor Project's website (<a class="calibre1" href="https://www.torproject.org/docs/debian">https://www.torproject.org/docs/debian</a>). The following steps explain the installation procedure, but you should cross-reference them with the published instructions.</p></div><p class="calibre7">Edit <code class="email">/etc/apt/sources.list</code> by adding the following lines:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">deb http://deb.torproject.org/torproject.org wheezy main</strong></span>
<span class="strong"><strong class="calibre8">deb http://deb.torproject.org/torproject.org tor-experimental-0.2.5.x-wheezy main</strong></span>
</pre></div><p class="calibre7">Next, add the GPG key used to sign these Tor packages:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">gpg --keyserver keys.gnupg.net --recv 886DDD89</strong></span>
<span class="strong"><strong class="calibre8">gpg --export A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89 | sudo apt-key add -</strong></span>
</pre></div><p class="calibre7">Then, issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get update</strong></span>
</pre></div><p class="calibre7">The Tor Project recommends that you add the GPG key ring with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install deb.torproject.org-keyring</strong></span>
</pre></div><p class="calibre7">Tor needs an up-to-date time as it enforces the time validity on certificates. In a later chapter, we'll show you how to keep time with a dedicated<a id="id133" class="calibre1"/> <span class="strong"><strong class="calibre8">Real Time Clock</strong></span> (<span class="strong"><strong class="calibre8">RTC</strong></span>). For now, update your clock from the <span class="strong"><strong class="calibre8">Network Time Protocol</strong></span> (<span class="strong"><strong class="calibre8">NTP</strong></span>)<a id="id134" class="calibre1"/> as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo ntpdate -b -u pool.ntp.org</strong></span>
</pre></div><p class="calibre7">Install Tor:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install tor</strong></span>
</pre></div><p class="calibre7">Then, install <code class="email">obfsproxy</code>. Obfsproxy<a id="id135" class="calibre1"/> is the software that implements <a id="id136" class="calibre1"/>the obfuscated proxy and allows various<a id="id137" class="calibre1"/> pluggable transports. Obfsproxy<a id="id138" class="calibre1"/> uses Python Twisted library, an event-driven networking engine, which will install around 17 MB of packages in total:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install obfsproxy</strong></span>
</pre></div><p class="calibre7">While we are installing software, let's install the Stem Python package. Stem<a id="id139" class="calibre1"/> is a Python controller library for Tor, and we'll be using it later to interact with our bridge. The easiest method is to install it with <code class="email">pip</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo pip install stem</strong></span>
</pre></div></div></div>

<div class="book" title="Installing Tor on BBB">
<div class="book" title="Configuring Tor for BBB"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec25" class="calibre1"/>Configuring Tor for BBB</h2></div></div></div><p class="calibre7">Under Debian, the<a id="id140" class="calibre1"/> configuration file for Tor is <code class="email">/etc/tor/torrc</code>. Before <a id="id141" class="calibre1"/>editing <code class="email">/etc/tor/torrc</code>, you should first take a backup. This <code class="email">torrc</code> file<a id="id142" class="calibre1"/> is<a id="id143" class="calibre1"/> available for download at <a class="calibre1" href="https://github.com/jbdatko/beagle-bone-for-secret-agents/blob/master/ch2/torrc">https://github.com/jbdatko/beagle-bone-for-secret-agents/blob/master/ch2/torrc</a>. We will <a id="id144" class="calibre1"/>discuss more interesting aspects of this configuration file in the following sections. When you are ready, replace <code class="email">/etc/tor/torrc</code> with the following:</p><div class="informalexample"><pre class="programlisting"># We are running a relay, no need for the SocksPort
SocksPort 0
# Extra logging is nice
Log notice file /var/log/tor/notices.log
# Run in the background
RunAsDaemon 1
# The following two lines are so we can connect with the
## Tor Stem library over the control port
ControlPort 9051
CookieAuthentication 1
# The is the Onion Router (OR) Port for normal relay operation
ORPort 9001
# Your bridge's nickname, change!
Nickname changeme
# Bandwidth settings
RelayBandwidthRate 520 KB # Throttle traffic to 520 KB/s
RelayBandwidthBurst 640 KB # But allow burts up to 640 KB/s
# You put a real email here, but consider making a new account
## or alias address
ContactInfo Random Person &lt;nobody AT example dot com&gt;
# Do not exit traffic
ExitPolicy reject *:* # no exits allowed
# Yes, we want to be a bridge
BridgeRelay 1
# Use the obfs3 pluggable transport
ServerTransportPlugin obfs3 exec /usr/bin/obfsproxy managed
# Enable extra bridge statistics collection
ExtORPort auto
# A nice option for embedded platforms to minimize writes
# to eMMC or SD card
AvoidDiskWrites 1</pre></div><div class="book" title="Adding contact details to the torrc file"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec07" class="calibre1"/>Adding contact details to the torrc file</h3></div></div></div><p class="calibre7">At minimum, you should<a id="id145" class="calibre1"/> change the <code class="email">Nickname</code> field and <code class="email">ContactInfo</code>. The <code class="email">Nickname</code> field is a shorter way to refer to your bridge; however, your <a id="id146" class="calibre1"/>bridge's fingerprint is always the best method as it is unique. The <code class="email">ContactInfo</code> field allows the Tor project to send you an e-mail if there is a problem with your bridge. You can create an e-mail alias if you are concerned about receiving spam. Just be sure to monitor this account for infrequent e-mails from the Tor project.</p></div><div class="book" title="Tuning the bandwidth usage of your bridge"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch02lvl3sec08" class="calibre1"/>Tuning the bandwidth usage of your bridge</h3></div></div></div><p class="calibre7">Tor's man page will <a id="id147" class="calibre1"/>describe most of these <a id="id148" class="calibre1"/>settings in detail, but some warrant extra <a id="id149" class="calibre1"/>explanation. The bandwidth settings, <code class="email">RelayBandwidthRate</code> and <code class="email">RelayBandwidthBurst</code>, are tunable bandwidth settings, and in a later section, we will connect our hardware controls to manipulate these settings. The rate and the burst are in kilobytes per second, not in the more common kilo or <span class="strong"><em class="calibre9">megabits</em></span> per second, so watch your units.</p></div></div></div>
<div class="book" title="Understanding Tor exit policies"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec16" class="calibre1"/>Understanding Tor exit policies</h1></div></div></div><p class="calibre7">A bridge, by definition, is the<a id="id150" class="calibre1"/> entry point to the Tor network. As such, the exit policy, which <a id="id151" class="calibre1"/>will allow traffic to exit the Tor network from the server, should be the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">ExitPolicy reject *:*</strong></span>
</pre></div><p class="calibre7">This prevents your server from running as an exit node. If you do decide to run an exit node, be prepared to receive some complaints from your ISP if you are running it on a home network. This is why the Tor Project and the Electronic Frontier Foundation recommend that you <span class="strong"><em class="calibre9">don't</em></span> run an exit relay on a home network. A thorough, legal FAQ prepared by the Electronic <a id="id152" class="calibre1"/>Frontier Foundation can be found at <a class="calibre1" href="https://www.torproject.org/eff/tor-legal-faq.html.en">https://www.torproject.org/eff/tor-legal-faq.html.en</a>.</p></div>
<div class="book" title="Setting bridge-specific settings"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec17" class="calibre1"/>Setting bridge-specific settings</h1></div></div></div><p class="calibre7">There are three bridge <a id="id153" class="calibre1"/>specific settings: <code class="email">BridgeRelay</code>, <code class="email">ServerTransportPlugin</code>, and <code class="email">ExtORPort</code>. The <code class="email">BridgeRelay</code> setting is the<a id="id154" class="calibre1"/> key setting that defines your relay as a bridge. Your bridge's meta information is published in the bridge database instead of the public directory server, which keeps your bridge's IP less public than a Tor relay's IP address. <code class="email">ServerTransportPlugin</code> defines <a id="id155" class="calibre1"/>which pluggable<a id="id156" class="calibre1"/> transport proxy your bridge supports. Currently, ScrambleSuit is the latest promising pluggable transport technology. However, obfs3, which is the transport enabled in our bridge configuration example, is slightly more mature and it is the more conservative recommendation. Lastly, <code class="email">ExtORPort</code> <a id="id157" class="calibre1"/>allows the<a id="id158" class="calibre1"/> gathering and reporting of bridge statistics to the Tor Project.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note12" class="calibre1"/>Note</h3><p class="calibre7">For those who are interested in running the ScrambleSuit obfsproxy, take a look at the following link on how to<a id="id159" class="calibre1"/> configure your bridge: <a class="calibre1" href="https://lists.torproject.org/pipermail/torrelays/%202014-February/003886.html">https://lists.torproject.org/pipermail/torrelays/
2014-February/003886.html</a>.
</p></div></div>
<div class="book" title="Starting your new Tor bridge"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec18" class="calibre1"/>Starting your new Tor bridge</h1></div></div></div><p class="calibre7">With the time updated and<a id="id160" class="calibre1"/> the configuration set, it's time to turn on the bridge. At the moment, the bridge should be able to make a connection to the Tor network, but it will not be able to accept incoming connections as we have not yet configured port forwarding from your router. However, the <code class="email">obfsproxy</code> port is randomly assigned, so we need to run the bridge first to find the port. Restart the Tor service with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo service tor restart</strong></span>
</pre></div><p class="calibre7">Next, let's check the log to <a id="id161" class="calibre1"/>see whether Tor has started correctly:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">tail -n 20 /var/log/tor/notices.log</strong></span>
</pre></div><p class="calibre7">If you see something like the following, then your Tor client's behavior is working:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Mar 25 21:37:43.000 [notice] Tor has successfully opened a circuit. Looks like client functionality is working.</strong></span>
<span class="strong"><strong class="calibre8">Mar 25 21:37:43.000 [notice] Bootstrapped 100%: Done.</strong></span>
</pre></div></div>
<div class="book" title="Enabling port forwarding"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec19" class="calibre1"/>Enabling port forwarding</h1></div></div></div><p class="calibre7">We know that we need to<a id="id162" class="calibre1"/> forward port <code class="email">9001</code>, as it is the ORPort, but we need to know which port the obfsproxy software runs on. This will be logged in the same file and will be discovered by searching the Tor log with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">grep obfs3 /var/log/tor/notices.log</strong></span>
</pre></div><p class="calibre7">The previous command should yield the following search result:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Mar 05 01:56:04.000 [notice] Registered server transport 'obfs3' at '0.0.0.0:59519'</strong></span>
</pre></div><p class="calibre7">The <code class="email">obfsproxy</code> port for our obfs3 service is on <code class="email">59519</code>. From your home router, configure port forwarding from <code class="email">9001</code>, and configure port forwarding from <code class="email">59519</code> from your external IP to BBB. It will also help if you give your BBB a static internal IP. Consult your router's manual for directions. Alternatively, you can specify the port with the following line in the <code class="email">/etc/tor/torrc</code> file:</p><div class="informalexample"><pre class="programlisting">ServerTransportListenAddr obfs3 0.0.0.0:xxxx</pre></div><p class="calibre7">Replace the x's with the desired port address. However, it's best to let obfsproxy pick a random address; otherwise, the Tor Project might end up with an uneven distribution of bridges running on certain ports, which will make it easier to block access to bridges.</p><p class="calibre7">Once you've forwarded the necessary ports, restart the router again. You should see the following messages, indicating success:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Mar 25 21:37:43.000 [notice] Now checking whether ORPort xxx.xxx.xxx.xxx:9001 is reachable... (this may take up to 20 minutes -- look for log messages indicating success)</strong></span>
<span class="strong"><strong class="calibre8">Mar 25 21:37:44.000 [notice] Self-testing indicates your ORPort is reachable from the outside. Excellent. Publishing server descriptor.</strong></span>
</pre></div><p class="calibre7">Congratulations! You are now<a id="id163" class="calibre1"/> running a Tor bridge on BBB and are helping to improve Internet freedom. You are also enabling agents, both secret and otherwise, to access the unfiltered Internet.</p></div>

<div id="page" style="height:0pt"/><div class="book" title="Adding physical interfaces to the bridge"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec20" class="calibre1"/>Adding physical interfaces to the bridge</h1></div></div></div><p class="calibre7">Now you have a Tor bridge <a id="id164" class="calibre1"/>running and you can stop here. If you do, you'd be missing out on the ability to combine software with custom hardware on BBB. Our BBB Tor bridge currently has no visual feedback, so it's not obvious that it's working. Also, the only means to control the bridge is to log in to BBB over SSH and manipulate the configuration options. The Tor bridge is an appliance and it needs appliance controls. In this section, we'll add a front panel, which will give us an easy method to control the bridge's bandwidth and a quick indicator to know that the software hasn't crashed. In the following section, we'll add the software to interface with our bridge and control the hardware.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note13" class="calibre1"/>Note</h3><p class="calibre7">If you decide to run a Tor relay, there are websites such as <a id="id165" class="calibre1"/>Tor atlas (<a class="calibre1" href="https://atlas.torproject.org/">https://atlas.torproject.org/</a>) that will produce bandwidth graphs and display other information about your relay. Another tool that will also display information about your bridge is<a id="id166" class="calibre1"/> Globe (<a class="calibre1" href="https://globe.torproject.org/">https://globe.torproject.org/</a>).</p></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Gathering the front panel components"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec26" class="calibre1"/>Gathering the front panel components</h2></div></div></div><p class="calibre7">As this is our first project, we<a id="id167" class="calibre1"/> are going to use some basic components: a<a id="id168" class="calibre1"/> <span class="strong"><strong class="calibre8">light-emitting diode</strong></span> (<span class="strong"><strong class="calibre8">LED</strong></span>), a rotary potentiometer, and a <a id="id169" class="calibre1"/>
<span class="strong"><strong class="calibre8">liquid-crystal display</strong></span> (<span class="strong"><strong class="calibre8">LCD</strong></span>), all shown in the following circuit diagram:</p><div class="mediaobject"><img src="../images/00007.jpeg" alt="Gathering the front panel components" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">LCDs can <a id="id170" class="calibre1"/>been a bit tricky to work with, but SparkFun Electronics has combined a 16x2 LCD with a microcontroller so that it can use a serial interface instead of a more complicated parallel one. The serial interface is simpler because it only requires one data line to the device, whereas a parallel interface will require more wiring.</p></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Using an LCD to display status information"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec27" class="calibre1"/>Using an LCD to display status information</h2></div></div></div><p class="calibre7">Our Tor bridge<a id="id171" class="calibre1"/> generates a lot of metadata, such as the bandwidth usage, the number of connections, and some Tor-specific statistics. For a home network, it's useful to know how much bandwidth your bridge is using, and it would be nice to know this without logging in to BBB all the time. In the serial LCDs, we will draw a graphical representation of the bandwidth usage. We'll use ten bars, each representing a tenth of the available bandwidth. If you see five bars, then the bridge is using half of the available bandwidth. The LCD selected for this project was LCD-09067 (SparkFun Electronics).</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note14" class="calibre1"/>Note</h3><p class="calibre7">SparkFun Electronics<a id="id172" class="calibre1"/> is an international distributor that ships products from Boulder, Colorado, in the United States. Some of the more common components recommended in this book can be replaced with equivalent ones in your local electronic store if you are trying to save on shipping. You don't <a id="id173" class="calibre1"/>need to type in each component; they are all listed in one consolidated <span class="strong"><em class="calibre9">wish list</em></span> at <a class="calibre1" href="https://www.sparkfun.com/wish_lists/93119">https://www.sparkfun.com/wish_lists/93119</a>.</p></div></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Controlling the bandwidth with a potentiometer"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec28" class="calibre1"/>Controlling the bandwidth with a potentiometer</h2></div></div></div><p class="calibre7">A potentiometer<a id="id174" class="calibre1"/> is like a variable resistor. If you've ever adjusted the volume of a radio or<a id="id175" class="calibre1"/> speaker with a knob, you've probably used a potentiometer. By adjusting the knob, you adjust the resistance in the potentiometer, which in turns adjusts the voltage sensed at the output. The potentiometer has three leads: one for voltage (in), one for ground, and the final is the output.</p><p class="calibre7">This knob, connected to BeagleBridge, will throttle the bandwidth available to Tor. With the dial turned up to max, the bridge will report that all of your bandwidth is available to route traffic to the Tor network. With the dial at its midpoint, the bridge will report that half of your bandwidth is available for use. If you notice that the bridge is consuming more bandwidth than you'd like, as indicated by the LCD, you can turn down the <span class="strong"><em class="calibre9">volume</em></span> of your bridge. The potentiometer and knob for this project are COM-09939 and COM-10001 (SparkFun Electronics).</p><p class="calibre7">Your bridge will not immediately attract users; it will take some time. Start with your bridge set at the max bandwidth; if you discover that it is consuming more bandwidth than you like, then turn it down. To receive an indication whether the Tor bridge is working, we will use an LED controlled by a BBB's GPIO, which will flash periodically. This way you can look over at the panel and tell whether the software is still running. The LED by SparkFun is COM-10633, and the LED holder is COM-11148.</p></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Designing the BeagleBridge circuit"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec29" class="calibre1"/>Designing the BeagleBridge circuit</h2></div></div></div><p class="calibre7">The following <a id="id176" class="calibre1"/>Fritzing diagram<a id="id177" class="calibre1"/> shows the <a id="id178" class="calibre1"/>schematic for this project.</p><div class="mediaobject"><img src="../images/00008.jpeg" alt="Designing the BeagleBridge circuit" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The<a id="id179" class="calibre1"/> potentiometer is connected via BBB's <span class="strong"><strong class="calibre8">Analog-to-Digital Converter</strong></span> (<span class="strong"><strong class="calibre8">ADC</strong></span>)<a id="id180" class="calibre1"/> pins. BBB's analog<a id="id181" class="calibre1"/> inputs can only tolerate a max of 1.8V; so, it's very <a id="id182" class="calibre1"/>important to use the dedicated analog voltage pin, pin P9_32 (pin number 32 of the connector P9), which provides this voltage. Do <span class="strong"><em class="calibre9">not</em></span> connect the potentiometer to the normal 3.3V or 5V power rails, as this will damage the processor. We'll arbitrarily pick the analog input AIN5 on pin P9_36 as our input pin, and connect that to the middle lead or output of the potentiometer. Lastly, connect the last lead of the potentiometer to the dedicated analog ground pin, P9_34.</p><p class="calibre7">The LED and LCD both use 3.3V and the common ground. We need a serial transmit pin for the LCD, so we'll arbitrarily pick P9_13, which is the transmit for UART4. UART1 transmit on P9_24 or UART2 on P9_21 will also work fine.</p><p class="calibre7">Lastly, we need a GPIO to control the LED. Again, any will do, but I've picked pin P9_15. You'll need a resistor to limit the current to the LED. Sizing a resistor is straightforward using Ohm's Law; we just need to know the forward voltage drop and the max current of the LED. This information is found in the datasheet. If you are using SparkFun's 5mm Green LED, its max current is 20mA and has a forward voltage drop of 2.2V.</p><p class="calibre7">Ohm's Law states <a id="id183" class="calibre1"/>that voltage is equal to the current multiplied by the <a id="id184" class="calibre1"/>resistance, or <span class="strong"><em class="calibre9">V = IR</em></span>. Subtracting 2.2V from 3.3V of our supply voltage, and dividing the resulting value by .020 Amps gives 55 Ohms. 55 Ohms isn't a standard value, but 56 is, so you can use this. But, you can always use a higher resistance value, and the LED will just be less bright. The resistor used in this project had a value of 100 Ohms.</p></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Wiring the hardware with a proto cape"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec30" class="calibre1"/>Wiring the hardware with a proto cape</h2></div></div></div><p class="calibre7">There are some special <a id="id185" class="calibre1"/>considerations when wiring this project as it is meant to go inside an enclosure to provide the front panel. A stranded wire will bend and flex better compared to a solid core. Once settled in the enclosure, we wouldn't expect the wires to strain or move around, but they certainly will when you try to install the panel inside the enclosure! We also have a few options to wire our project to BBB. We could use jumper wires with male pins to insert into the female expansion headers, but these pins can come out easily, especially when you put your project into the enclosure.</p><p class="calibre7">We'll use SparkFun's BeagleBone Black Proto Cape, DEV-12774, to easily combine our circuit with BBB. This board breaks out power, ground, and other pin signals for expansion. It includes an EEPROM, which is not only useful if you want to have persistent data stored on your board but is also required if you are building a BeagleBone Cape, which will be discussed in detail in the next chapter. The advantage of a protoboard, especially the Beagle proto capes, is that we can solder male headers on the board and then use female terminated wires, which tend to connect a little better. Plus, by using the male headers, we can easily reuse the protoboard for a later project. However, these protoboards are not required, and if you are trying to save some money, with some creative wiring, you don't need one.</p><p class="calibre7">If you are using the protoboard approach, you don't have to populate all the headers either. Only the male pins that we need are soldered to the corresponding pads on the protoboard's P9 header. The way these protoboards work is that each pin is duplicated on the pads next to them. Solder the 100 Ohm resistor from P9_15 to the bottom of one of the male pins in the middle of the board. Then, connect a wire from the male pin to the positive terminal of the LED.</p><p class="calibre7">When complete, your project should look something like the following circuit diagram. We don't have the control software running yet, but you can see the LCD displaying the bandwidth usage. The following diagram doesn't have soldered connections to the potentiometer for the ease of testing, but<a id="id186" class="calibre1"/> instead uses <span class="strong"><em class="calibre9">IC Hooks</em></span>. In a finished installation, you will want to solder the wires for a better mechanical and electrical connection.</p><div class="mediaobject"><img src="../images/00009.jpeg" alt="Wiring the hardware with a proto cape" class="calibre10"/></div><p class="calibre11"> </p></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Developing the software using Python libraries"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch02lvl2sec31" class="calibre1"/>Developing the software using Python libraries</h2></div></div></div><p class="calibre7">The software for this project is<a id="id187" class="calibre1"/> freely available for download at <a class="calibre1" href="https://github.com/jbdatko/beagle-bone-for-secret-agents/">https://github.com/jbdatko/beagle-bone-for-secret-agents/</a>. In this section, we'll highlight the finer details of working with the existing libraries and outline the architecture of the project. The code uses many asynchronous callbacks from these libraries since there are several concurrent activities: the Tor bridge, the bandwidth knob, writing to the LCD, and blinking of the LED. To interact with the bridge, we'll use the <a id="id188" class="calibre1"/>Tor <code class="email">Stem</code> library (<a class="calibre1" href="https://stem.torproject.org/">https://stem.torproject.org/</a>), and to interact with the hardware, we'll use Adafruit's BeagleBone Python library<a id="id189" class="calibre1"/> (<a class="calibre1" href="https://github.com/adafruit/adafruit-beaglebone-io-python">https://github.com/adafruit/adafruit-beaglebone-io-python</a>).</p></div></div>

<div class="book" title="Adding physical interfaces to the bridge">
<div class="book" title="Controlling the hardware with pyBBIO"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_7"><a id="ch02lvl2sec32" class="calibre1"/>Controlling the hardware with pyBBIO</h2></div></div></div><p class="calibre7">We installed the <code class="email">Stem</code> library when we<a id="id190" class="calibre1"/> installed Tor; so, now we need to install the <code class="email">Adafruit</code> BBIO library by performing the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install build-essential python-dev python-setuptools python-pip python-smbus -y</strong></span>
<span class="strong"><strong class="calibre8">sudo pip install Adafruit_BBIO</strong></span>
<span class="strong"><strong class="calibre8">sudo pip install pyserial</strong></span>
</pre></div><p class="calibre7">The <code class="email">Adafruit</code> library<a id="id191" class="calibre1"/> conveniently enables the device tree overlays, which are the files that describe the hardware configuration of BBB to the kernel, at runtime. Therefore, there is no need to manipulate the configuration via the <code class="email">sysfs</code> as everything is handled in the Python library. The code models each hardware component as its own Python class. The LED modeled by the <code class="email">TorFreedomLED</code> class is the most straightforward. We need the LED to blink; this is accomplished by toggling the output high, sleeping the executing thread briefly, and then toggling the output low to turn it off. To set up the GPIO, we only need to call <code class="email">GPIO.setup</code>, by passing in the pin and the direction:</p><div class="informalexample"><pre class="programlisting">import Adafruit_BBIO.GPIO as GPIO
class TorFreedomLED(object):
  def __init__(self):
    self.pin = 'P9_15'
    GPIO.setup(self.pin, GPIO.OUT)

  def on(self):
    GPIO.output(self.pin, GPIO.HIGH)

  def off(self):
    GPIO.output(self.pin, GPIO.LOW)

  def blink(self):
    self.on()
    sleep(.5)
    self.off()</pre></div><p class="calibre7">The LCD, controlled by the <code class="email">FrontPanelDisplay</code> class, writes to the serial port, <code class="email">/dev/ttyO4</code>, on BBB's UART 4 at 9600 baud. The LCD only receives information; therefore, we are only using the transmit lines from BBB. Commands are written to the attached microcontroller, which in turn drives the display. The datasheet, available on the SparkFun website, describes all of the commands. In general, the procedure is to move the virtual cursor on the display and then send the text.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note15" class="calibre1"/>Note</h3><p class="calibre7">SparkFun<a id="id192" class="calibre1"/> has a more complete quick start guide on the serial LCD<a id="id193" class="calibre1"/> at <a class="calibre1" href="https://www.sparkfun.com/tutorials/246">https://www.sparkfun.com/tutorials/246</a>. The example code is for an Arduino, but porting it to Python is straightforward if you follow the example of the bridge LCD in this chapter.</p></div><p class="calibre7">Similar to the GPIO <a id="id194" class="calibre1"/>example, the serial port in the <code class="email">Adafruit</code> library can be used as follows:</p><div class="informalexample"><pre class="programlisting">import Adafruit_BBIO.UART as UART
import serial
class FrontPanelDisplay(object):

  def __init__(self):
    self.uart = 'UART4'
    UART.setup(self.uart)
<span class="strong"><strong class="calibre8">    self.port = serial.Serial(port="/dev/ttyO4", baudrate=9600)</strong></span>
    self.port.open()</pre></div><p class="calibre7">The display will automatically wrap lines if the text you are trying to display is longer than sixteen characters. Therefore, you have to manage the LCD to ensure that it displays correctly. For example, let's take a look at the <code class="email">display_graph</code> method that is responsible for producing the bandwidth graph:</p><div class="informalexample"><pre class="programlisting">self.clear_screen()
up_str = '{0:&lt;16}'.format('Up:   ' + self.block_char * up)
dn_str = '{0:&lt;16}'.format('Down: ' + self.block_char * down)

self.port.write(up_str)
self.port.write(dn_str)</pre></div><p class="calibre7">The first line clears the screen and resets the cursor to the top-left corner of the 16x2 display. Next, we format the two lines to display the graph using the special block character on the LCD. This line is left justified and is filled with whitespace up to sixteen characters. Finally, the lines are written to the LCD with the serial <code class="email">write</code> methods. The cursor does not have to be reset between each line because after writing the first, it will be ready in the second line.</p><p class="calibre7">Lastly, the bandwidth adjust knob is modeled in the <code class="email">BandwidthKnob</code> class. This class uses the <code class="email">ADC</code> module and is also implemented as a thread. The analog input will always produce a value when read, and we will ratio this value to the available bandwidth for the bridge. The <code class="email">Adafruit</code> library<a id="id195" class="calibre1"/> normalizes the values from <code class="email">0.0</code> to <code class="email">1.0</code>; so, when the knob is at its midpoint, the call to <code class="email">ADC.read(pin)</code> should return <code class="email">0.5</code>. There is some jitter in the analog signal, and we don't need a fine resolution on the bandwidth. Sampling once every second should suffice since we don't expect the knob to change frequently. We'll round up to the next whole number, which will give the knob ten discrete settings. The <code class="email">run</code> method will report back to the caller, via a message queue, if the <span class="strong"><em class="calibre9">volume</em></span> setting has changed. The calling thread can then update the Tor bridge bandwidth limits accordingly.</p><p class="calibre7">This code sample<a id="id196" class="calibre1"/> shows you how to set up the ADC on BBB with the <code class="email">Adafruit</code> library and how to pass that result to a waiting thread with a message queue:</p><div class="informalexample"><pre class="programlisting">import Adafruit_BBIO.ADC as ADC
import threading
from time import sleep
from math import ceil, floor
import Queue
class BandwidthKnob(threading.Thread):

  def __init__(self, pin, *args, **kwargs):

    threading.Thread.__init__(self, *args, **kwargs)
    self.pin = pin
    self.setup_adc()
    self.kill = False
    self.prev_value = -1
    self.q = Queue.Queue()

  def setup_adc(self):
    'Load the Adafruit device tree fragment for ADC pins'
<span class="strong"><strong class="calibre8">    ADC.setup()</strong></span>

  def read_value(self):
    return ceil(10 * ADC.read(self.pin))

  def stop(self):
    self.kill = True

  def run(self):
    knob = self.prev_value

    while knob != 0 and not self.kill:
      sleep(1)
      knob = self.read_value()
      if knob != self.prev_value:
<span class="strong"><strong class="calibre8">        self.q.put(knob)</strong></span>
        self.prev_value = knob</pre></div></div></div>
<div class="book" title="Determining your bandwidth with speedtest-cli"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec21" class="calibre1"/>Determining your bandwidth with speedtest-cli</h1></div></div></div><p class="calibre7">In order to adjust the<a id="id197" class="calibre1"/> bandwidth rate, we first need to know<a id="id198" class="calibre1"/> how much bandwidth our bridge has. Fortunately, there is a nice script to run a speed test from your command line that is appropriately called <code class="email">speedtest-cli</code>. This is installed with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo pip install git+https://github.com/sivel/speedtest-cli.git</strong></span>
</pre></div><p class="calibre7">Run the test with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">speedtest-cli --simple &gt; speedtest.txt</strong></span>
</pre></div><p class="calibre7">If you inspect the output file, you should see something like the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Ping: 107.686 ms</strong></span>
<span class="strong"><strong class="calibre8">Download: 28.23 Mbit/s</strong></span>
<span class="strong"><strong class="calibre8">Upload: 5.37 Mbit/s</strong></span>
</pre></div><p class="calibre7">We'll use the results in this file as the basis for our bandwidth adjustment. At the moment, we only need to remember its location for later use.</p></div>
<div class="book" title="Controlling the bridge with the Stem library"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec22" class="calibre1"/>Controlling the bridge with the Stem library</h1></div></div></div><p class="calibre7">The bridge is controlled <a id="id199" class="calibre1"/>using the <code class="email">Stem</code> library, which communicates <a id="id200" class="calibre1"/>with the Tor process over the Tor control protocol. The setup is managed in the <code class="email">BeagleBridge</code> class. After establishing a connection with the Tor process, this class registers two event listeners for the <code class="email">Bandwidth</code> and <code class="email">Configuration</code> changed event. The bandwidth event is triggered each second and reports, via the <code class="email">print_bw</code> callback, the bytes used in the last second. This information is used to draw the bandwidth graph. The following callback function shows how the callback interacts with the LCD:</p><div class="informalexample"><pre class="programlisting">def make_bw_callback(test,lcd):
  '''Returns a callback function for the bandwidth event'''
  def print_bw(event):
    '''Obtains the bandwidth used from the last second from the
       bridge, normalizes it to the total bandwidth, and draw 
       that information to the display'''
    up = int(test.get_up_ratio(event.written))
    down = int(test.get_down_ratio(event.read))
    lcd.display_graph(up, down)

  return print_bw</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note16" class="calibre1"/>Note</h3><p class="calibre7">For those who want to dive deeper into the <code class="email">Stem</code> library and the Tor control protocol, the <code class="email">Stem</code> library has thorough online documentation<a id="id201" class="calibre1"/> and examples (<a class="calibre1" href="https://stem.torproject.org/tutorials.html">https://stem.torproject.org/tutorials.html</a>). The control protocol, for those who want an even more in-depth look, is located at <a class="calibre1" href="https://gitweb.torproject.org/torspec.git?a=blob_plain;hb=HEAD;f=control-spec.txt">https://gitweb.torproject.org/torspec.git?a=blob_plain;hb=HEAD;f=control-spec.txt</a>.</p></div><p class="calibre7">The <code class="email">Configuration Changed</code> event<a id="id202" class="calibre1"/> is the callback to inform the<a id="id203" class="calibre1"/> process that the bridge's configuration was<a id="id204" class="calibre1"/> changed. This occurs when the bandwidth knob is adjusted, which causes the <code class="email">update_rate </code>method to be called, that sends a command to the bridge to update the configuration. The end result is that by adjusting the knob, you directly affect the bandwidth limits on your bridge. When the callback occurs, it will display the new bandwidth rates on the LCD so that you know that your limit has changed. This callback is shown as follows:</p><div class="informalexample"><pre class="programlisting">def make_conf_callback(lcd):
  '''Returns a callback function for the configuration changed
     event'''
  def conf_changed(event):
    '''Reads the new bandwidth rates from the bridge and draws
       that information to the display'''
    rate = str(int(event.config['RelayBandwidthRate']) / 1024)
    burst = str(int(event.config['RelayBandwidthBurst']) / 1024)
    lcd.display_rates(rate, burst)

  return conf_changed</pre></div><p class="calibre7">The main section of the Python script performs the class instantiation and also displays a one-time splash screen to the LCD. It will show the total bytes transmitted by the bridge, the number of established circuits, and the last 24 bytes of the bridge's fingerprint. The bridge controller will run forever, while the bandwidth knob is at a nonzero value. When you dial the knob to zero, the program will exit and the LCD will be filled with blocks.</p><p class="calibre7">Finally, to run the bridge controller, execute the following command, with the first parameter being the location of the speed test results:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo python beaglebridge.py ~/speedtest.txt &amp;</strong></span>
</pre></div><p class="calibre7">To avoid running as <a id="id205" class="calibre1"/>root, you'll have to manipulate user groups and<a id="id206" class="calibre1"/> permissions. The Tor process runs as the <code class="email">debian-tor</code> user, and the <code class="email">Adafruit</code> library, which enables device tree overlays on your behalf, needs to run at a user level that has the permission to enable these features. You can create a custom group and a user that is in the <code class="email">debian-tor</code> group and then give that group permission to modify the device tree files to not run as root.</p></div>
<div class="book" title="Connecting to your obfuscated bridge"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec23" class="calibre1"/>Connecting to your obfuscated bridge</h1></div></div></div><p class="calibre7">With BeagleBridge, you have <a id="id207" class="calibre1"/>your own entry point in the Tor network. You can download and install the Tor browser and configure it to use your bridge. This is useful anytime you find yourself on a restricted or hostile network and want to access the Internet more anonymously. However, if you use <span class="strong"><em class="calibre9">your</em></span> BeagleBridge, passive attackers could learn the IP address to which you are connecting, which happens to be your home network. The traffic is obfuscated, but it may look suspicious over time. It might be better to use a random bridge address obtained via Tor. Even if you don't directly connect to your own bridge, your bridge is helping to contribute resources to the Tor network, which helps everybody access a censor-free Internet. To connect to your bridge, launch the Tor browser and click on <span class="strong"><strong class="calibre8">Open Settings</strong></span> as it starts up. Then, answer with a <code class="email">Yes</code> to questions about whether your connection is censored. Select <span class="strong"><strong class="calibre8">Enter Custom Bridges</strong></span> and enter your bridge as follows, but replace the x's with your IP address and the port number of your bridge:</p><p class="calibre7">
<code class="email">bridge obfs3 XXX.XXX.XXX.XXX:59519</code>
</p></div>
<div class="book" title="Continuing with Tor-related projects"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec24" class="calibre1"/>Continuing with Tor-related projects</h1></div></div></div><p class="calibre7">This project is just the <a id="id208" class="calibre1"/>first step in learning Tor. If you want to route more traffic with BBB, you can switch from a bridge to a public relay. Relays receive more traffic but are also more public. Your IP address will be listed as a public bridge, and some websites will refuse to serve you content even if you are running a nonexit relay.</p><p class="calibre7">You can also run a Tor <span class="strong"><strong class="calibre8">hidden service</strong></span>
<a id="id209" class="calibre1"/> on the BeagleBone. Using Tor with a client helps to anonymize your IP address to a server, but a Tor hidden service hides the server's IP address from a client. It would be an interesting project for a BeagleBone if you had a service that you want accessible only through Tor.</p><p class="calibre7">Hardware-wise, consider <a id="id210" class="calibre1"/>placing the BeagleBone and front panel in a dedicated enclosure. See whether there is a local hackerspace around you, and they may be able to help you make a nice laser-cut enclosure! If you don't have a laser cutter, you can use a SparkFun Electronics box like the one in the following screenshot:</p><div class="mediaobject"><img src="../images/00010.jpeg" alt="Continuing with Tor-related projects" class="calibre10"/></div><p class="calibre11"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note17" class="calibre1"/>Note</h3><p class="calibre7">The onion logo<a id="id211" class="calibre1"/> is a registered trademark of the Tor Project, used with permission. The BeagleBridge project described in this chapter is not affiliated to the Tor Project.</p></div></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec25" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">In this chapter, you learned about Tor and how to circumvent Internet censorship by running a Tor bridge on BBB. We've also shown how to add some basic hardware controls to BBB in order to create a front panel interface. Lastly, through some Python code, we were able to tie the hardware controls and the Tor bridge together.</p><p class="calibre7">In the next chapter, we'll take a closer look at specialized cryptographic hardware available for BBB and show you how to use each of these devices.</p></div></body></html>