<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;2.&#xA0;Deploying RHEL &quot;En Masse&quot;" id="NQU21-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02" class="calibre1"/>Chapter 2. Deploying RHEL "En Masse"</h1></div></div></div><p class="calibre7">In this chapter, the following recipes are provided:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Creating a kickstart file</li><li class="listitem">Publishing your kickstart file using <code class="email">httpd</code></li><li class="listitem">Deploying a system using <code class="email">pxe</code></li><li class="listitem">Deploying a system using a custom boot ISO file</li></ul></div></div>

<div class="book" title="Chapter&#xA0;2.&#xA0;Deploying RHEL &quot;En Masse&quot;" id="NQU21-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch02lvl1sec19" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">In this chapter, you will find the answer to deploying multiple systems with the same basic setup. We will first look at creating an answer file, the kickstart file that will drive the unattended installation. Then, we'll take a look at a possible way to make this kickstart file accessible through the Apache web server. Finally, we'll discuss two common ways to install physical and virtual machines.</p><p class="calibre7">This chapter assumes that you have a working knowledge of system network configuration components, such as DNS, DNS search, IP addresses, and so on, and yum repositories.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a kickstart file"><div class="book" id="OPEK2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec20" class="calibre1"/>Creating a kickstart file</h1></div></div></div><p class="calibre7">A kickstart file<a id="id59" class="calibre1"/> is essentially a file containing all the necessary<a id="id60" class="calibre1"/> answers to questions that are asked during a typical install. It was created by Red Hat in response to the need for automated installs. Using kickstart, an admin can create one file or template containing all the instructions.</p><p class="calibre7">There are three ways to create a kickstart file:</p><div class="book"><ul class="itemizedlist"><li class="listitem">By hand</li><li class="listitem">Using the GUI's <code class="email">system-config-kickstart</code> tool</li><li class="listitem">Using the standard Red Hat installation program Anaconda</li></ul></div><p class="calibre7">In this recipe, I will cover a combination of the first two.</p></div>

<div class="book" title="Creating a kickstart file">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec45" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Before we can<a id="id61" class="calibre1"/> get down to the nitty-gritty of generating our base kickstart file or template, we need to install <code class="email">system-config-kickstart</code>. Run the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# yum install -y system-config-kickstart</strong></span>
</pre></div></div></div>

<div class="book" title="Creating a kickstart file">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec46" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">First, let's create a base template for our kickstart file(s) through the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, launch <span class="strong"><strong class="calibre8">Kickstart Configurator</strong></span> from the menu.</li><li class="listitem" value="2">Select your system's basic configuration from the <span class="strong"><strong class="calibre8">Kickstart Configurator</strong></span> GUI.<p class="calibre13">The following screenshot shows the options you can set in the <span class="strong"><strong class="calibre8">Basic Configuration</strong></span> view:</p><div class="mediaobject"><img src="../images/00004.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="3">Now, select the<a id="id62" class="calibre1"/> installation method from the <span class="strong"><strong class="calibre8">Kickstart Configurator</strong></span> GUI.<p class="calibre13">The following screenshot shows the options that you can set in the <span class="strong"><strong class="calibre8">Installation method</strong></span> view:</p><div class="mediaobject"><img src="../images/00005.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="4">Next, substitute<a id="id63" class="calibre1"/> the values for <span class="strong"><strong class="calibre8">HTTP Server</strong></span> and <span class="strong"><strong class="calibre8">HTTP Directory</strong></span> with your own repositories.</li><li class="listitem" value="5">Ensure that the correct settings are applied for <span class="strong"><strong class="calibre8">Boot Loader</strong></span>.<p class="calibre13">The following screenshot shows the options that you can set in the <span class="strong"><strong class="calibre8">Boot Loader options</strong></span> view:</p><div class="mediaobject"><img src="../images/00006.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="6">Configure <a id="id64" class="calibre1"/>your disk and partition information. Simply create a <code class="email">/boot</code> partition and be done with it! We'll edit the file manually for better customization.<p class="calibre13">The following screenshot shows the options you can set in the <span class="strong"><strong class="calibre8">Partition Information</strong></span> view:</p><div class="mediaobject"><img src="../images/00007.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="7">Configure <a id="id65" class="calibre1"/>your network. You need to know the name of your device if you want to correctly configure your network.<p class="calibre13">The following screenshot shows the <span class="strong"><strong class="calibre8">Network Device</strong></span> information that you can edit in the <span class="strong"><strong class="calibre8">Network Configuration</strong></span> view:</p><div class="mediaobject"><img src="../images/00008.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="8">Now, disable <span class="strong"><strong class="calibre8">Installing a graphical environment</strong></span>.<p class="calibre13">We <a id="id66" class="calibre1"/>want as few packages as possible. The following screenshot shows the options that you can set in the <span class="strong"><strong class="calibre8">Display Configuration</strong></span> view:</p><div class="mediaobject"><img src="../images/00009.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="9">Next, perform <a id="id67" class="calibre1"/>any preinstallation and/or postinstallation tasks you deem necessary. I always try to make root accessible through SSH and keys.<p class="calibre13">The following screenshot shows the options that you can set in the <span class="strong"><strong class="calibre8">Post-Installation Script</strong></span> view:</p><div class="mediaobject"><img src="../images/00010.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="10">Save<a id="id68" class="calibre1"/> the kickstart file.</li><li class="listitem" value="11">Open the file using your favorite editor and add the following to your partition section:<div class="informalexample"><pre class="programlisting">part pv.01 --size=1 --ondisk=sda --grow
volgroup vg1 pv.01
logvol / --vgname=vg1 --size=2048 --name=root
logvol /usr --vgname=vg1 --size=2048 --name=usr
logvol /var --vgname=vg1 --size=2048 --name=var
logvol /var/log --vgname=vg1 --size=1024 --name=var
logvol /home --vgname=vg1 --size=512 --name=home
logvol swap --vgname=vg1 --recommended --name=swap –fstype=swap</pre></div></li><li class="listitem" value="12">Now, add the following script to your network line:<div class="informalexample"><pre class="programlisting">--hostname=rhel7</pre></div></li><li class="listitem" value="13">Add the following script before <code class="email">%post</code>:<div class="informalexample"><pre class="programlisting">%packages –nobase
@core --nodefaults
%end</pre></div></li><li class="listitem" value="14">Create a password hash for use in the next step, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# openssl passwd -1 "MySuperSecretRootPassword"</strong></span>
<span class="strong"><strong class="calibre8">$1$mecIlXKN$6VRdaRkevjw9nngcMtRlO.</strong></span>
</pre></div></li><li class="listitem" value="15">Save the<a id="id69" class="calibre1"/> resulting file. You should have something similar to this:<div class="informalexample"><pre class="programlisting">#platform=x86, AMD64, or Intel EM64T
#version=DEVEL
# Install OS instead of upgrade
install
# Keyboard layouts
keyboard 'be-latin1'
# Halt after installation
halt
# Root password
rootpw --iscrypted $1$mecIlXKN$6VRdaRkevjw9nngcMtRlO.
# System timezone
timezone Europe/Brussels
# Use network installation
url –url="http://repo.example.com/rhel/7/os/x86_64/"
# System language
lang en_US
# Firewall configuration
firewall --disabled
# Network information
network  --bootproto=static --device=eno1 --gateway=192.168.0.254 --ip=192.168.0.1 --nameserver=192.168.0.253 --netmask=255.255.255.0 --hostname=rhel7# System authorization information
auth  --useshadow  --passalgo=sha512
# Use text mode install
text
# SELinux configuration
selinux --enforcing
# Do not configure the X Window System
skipx
# System bootloader configuration
bootloader --location=none
# Clear the Master Boot Record
zerombr
# Partition clearing information
clearpart --all --initlabel
# Disk partitioning information
part /boot --fstype="xfs" --ondisk=sda --size=512
part pv.01 --size=1 --ondisk=sda --grow
volgroup vg1 pv.01
logvol / --vgname=vg1 --size=2048 --name=root --fstype=xfs
logvol /usr --vgname=vg1 --size=2048 --name=usr --fstype=xfs
logvol /var --vgname=vg1 --size=2048 --name=var --fstype=xfs
logvol /var/log --vgname=vg1 --size=1024 --name=var --fstype=xfs
logvol /home --vgname=vg1 --size=512 --name=home --fstype=xfs
logvol swap --vgname=vg1 --recommended --name=swap --fstype=swap

%packages --nobase
@core --nodefaults
%end

%post
mkdir -p ~/.ssh
chmod 700 ~/.ssh
# Let's download my authorized keyfile from my key server...
curl -O ~/.ssh/authrorized_keys https://keys.example.com/authorized_keys
chmod 600 ~/.ssh/authrorized_keys
%end</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Creating a kickstart file">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec47" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">The <code class="email">system-config-kickstart</code> is used to generate a minimal install as any addition would be more<a id="id70" class="calibre1"/> complex than the tool can handle and we need to be able to add them manually/dynamically afterwards. The fewer the number of packages the better as you'll need to apply bug and security fixes for every package installed.</p><p class="calibre7">Although the GUI allows us to configure the brunt of the options we need, I prefer tweaking some portions of them manually as they are not as straightforward through the GUI.</p><p class="calibre7">Step 9 adds the necessary information to use the rest of the disk as an LVM physical volume and partitions it so that <span class="strong"><em class="calibre9">big</em></span> filesystems can easily be extended if necessary.</p><p class="calibre7">The <code class="email">--recommended</code> argument for the SWAP partition creates a swap partition as per the swap size recommendations set by Red Hat.</p><p class="calibre7">Step 10 adds a hostname for your host. If you do not specify this, the system will attempt to resolve the IP address and use this hostname. If it cannot determine any hostname, it will use <code class="email">localhost.localdomain</code> as <code class="email">fqdn</code>.</p><p class="calibre7">Step 11<a id="id71" class="calibre1"/> ensures that only the core system is installed and nothing more, so you can build from here.</p><p class="calibre7">If you want to know exactly which packages are installed in the core group, run the following command on an RHEL 7 system:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# yum groupinfo core</strong></span>
</pre></div></div></div>

<div class="book" title="Creating a kickstart file">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec48" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">I didn't cover one option that I mentioned in the <span class="strong"><em class="calibre9">Getting Ready</em></span> section as it is automatically generated when you install a system manually. The file can be found after installation at <code class="email">/root/anaconda-ks.cfg</code>. Instead of using the <code class="email">system-config-kickstart</code> tool to generate a kickstart file, you can use this file to get started.</p><p class="calibre7">Starting with RHEL 7, kickstart deployments support add-ons. These add-ons can expand the standard kickstart installation in many ways. To use kickstart add-ons, just add the <code class="email">%addon addon_name</code> option followed by <code class="email">%end</code>, as with the <code class="email">%pre</code> and <code class="email">%post</code> sections. Anaconda comes with the <code class="email">kdump</code> add-on, which you can use to install and configure <code class="email">kdump</code> during the installation by providing the following section in your kickstart file:</p><div class="informalexample"><pre class="programlisting">%addon com_redhat_kdump --enable --reserve-mb=auto
%end</pre></div></div></div>

<div class="book" title="Creating a kickstart file">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec49" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more <a id="id72" class="calibre1"/>detailed information about kickstart files, refer to the website <a class="calibre1" href="https://github.com/rhinstaller/pykickstart/blob/master/docs/kickstart-docs.rst">https://github.com/rhinstaller/pykickstart/blob/master/docs/kickstart-docs.rst</a>.</p><p class="calibre7">For the consistent network device naming, refer to <a class="calibre1" href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Consistent_Network_Device_Naming.html">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Networking_Guide/ch-Consistent_Network_Device_Naming.html</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Publishing your kickstart file using httpd" id="PNV61-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec21" class="calibre1"/>Publishing your kickstart file using httpd</h1></div></div></div><p class="calibre7">You can <a id="id73" class="calibre1"/>save your kickstart file to a USB stick (or any other medium), but this becomes a bit cumbersome if you need to install multiple <a id="id74" class="calibre1"/>systems in different locations.</p><p class="calibre7">Loading kickstart files over the network from the kernel line during an install only supports NFS, HTTP, and FTP.</p><p class="calibre7">In this recipe, I choose HTTP as it is a common technology within companies and easy to secure.</p></div>

<div class="book" title="Publishing your kickstart file using httpd" id="PNV61-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec50" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Let's start by installing Apache <code class="email">httpd</code>, as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Install <a id="id75" class="calibre1"/>Apache <code class="email">httpd</code> through the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y httpd</strong></span>
</pre></div></li><li class="listitem" value="2">Enable <a id="id76" class="calibre1"/>and start the <code class="email">httpd</code> daemon, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# systemctl enable httpd</strong></span>
<span class="strong"><strong class="calibre8">ln -s '/usr/lib/systemd/system/httpd.service' '/etc/systemd/system/multi-user.target.wants/httpd.service'</strong></span>
<span class="strong"><strong class="calibre8">~]# systemctl start httpd</strong></span>
</pre></div></li><li class="listitem" value="3">Create a directory to contain the kickstart file(s) by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# mkdir -p /var/www/html/kickstart</strong></span>
<span class="strong"><strong class="calibre8">~]# chown apache:apache /var/www/html/kickstart</strong></span>
<span class="strong"><strong class="calibre8">~]# chmod 750 /var/www/html/kickstart</strong></span>
</pre></div></li><li class="listitem" value="4">Copy your kickstart file to this new location:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cp kickstart.ks /var/www/html/kickstart/</strong></span>
</pre></div></li><li class="listitem" value="5">In a browser, browse to the kickstart directory on your web server, as shown in the following screenshot:<div class="mediaobject"><img src="../images/00011.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Publishing your kickstart file using httpd" id="PNV61-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec51" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">In this <a id="id77" class="calibre1"/>way, you can create multiple kickstart files, which <a id="id78" class="calibre1"/>will be available from anywhere in your network.</p><p class="calibre7">Additionally, you could use CGI-BIN, PHP, or any other technology that has an Apache module to dynamically create kickstart files based on the arguments that you specify in the URL.</p><p class="calibre7">An alternative to creating your own solution for dynamic kickstart files is Cobbler.</p></div></div>

<div class="book" title="Publishing your kickstart file using httpd" id="PNV61-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec52" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more info<a id="id79" class="calibre1"/> on Cobbler, go to <a class="calibre1" href="http://cobbler.github.io/">http://cobbler.github.io/</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deploying a system using PXE"><div class="book" id="QMFO2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec22" class="calibre1"/>Deploying a system using PXE</h1></div></div></div><p class="calibre7">PXE, or Preboot eXecution Environment, allows you to instruct computers to boot using network<a id="id80" class="calibre1"/> resources. This<a id="id81" class="calibre1"/> allows you to control a single source to install servers without the need to physically insert cumbersome DVDs or USB sticks.</p></div>

<div class="book" title="Deploying a system using PXE">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec53" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">For this recipe, you will need a fully working RHEL 7 repository.</p></div></div>

<div class="book" title="Deploying a system using PXE">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec54" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">With this recipe, we'll install and configure PXE boots from the RHEL 7 installation media, as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Install the necessary packages using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y dnsmasq syslinux tftp-server</strong></span>
</pre></div></li><li class="listitem" value="2">Configure the DNSMASQ server by editing <code class="email">/etc/dnsmasq.conf</code>, as follows:<div class="informalexample"><pre class="programlisting"># interfaces to bind to
interface=eno1,lo
# the domain for this DNS server
domain=rhel7.lan
# DHCP lease range
dhcp-range= eno1,192.168.0.3,192.168.0.103,255.255.255.0,1h
# PXE – the address of the PXE server
dhcp-boot=pxelinux.0,pxeserver,192.168.0.1
# Gateway
dhcp-option=3,192.168.0.254
# DNS servers for DHCP clients(your internal DNS servers, and one of Google's DNS servers)
dhcp-option=6,192.168.1.1, 8.8.8.8
# DNS server to forward DNS queries to
server=8.8.4.4
# Broadcast Address
dhcp-option=28,192.168.0.255
pxe-prompt="Press F1 for menu.", 60
pxe-service=x86_64PC, "Install RHEL 7 from network", pxelinux
enable-tftp
tftp-root=/var/lib/tftpboot</pre></div></li><li class="listitem" value="3">Enable and start <code class="email">dnsmasq</code> using the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# systemctl enable dnsmasq</strong></span>
<span class="strong"><strong class="calibre8">~]# systemctl start dnsmasq</strong></span>
</pre></div></li><li class="listitem" value="4">Now, enable and start the <code class="email">xinet</code> daemon by running the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# systemctl enable xinetd</strong></span>
<span class="strong"><strong class="calibre8">~]# systemctl start xinetd</strong></span>
</pre></div></li><li class="listitem" value="5">Enable the <code class="email">tftp</code> server's <code class="email">xinet</code> daemon, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# sed -i '/disable/ s/yes/no/' /etc/xinetd.d/tftp</strong></span>
</pre></div></li><li class="listitem" value="6">Copy<a id="id82" class="calibre1"/> the <code class="email">syslinux</code> boot loaders to the <code class="email">tftp</code> server's boot directory by executing the following <a id="id83" class="calibre1"/>command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cp -r /usr/share/syslinux/* /var/lib/tftpboot</strong></span>
</pre></div></li><li class="listitem" value="7">Next, create the PXE configuration directory using this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# mkdir /var/lib/tftpboot/pxelinux.cfg</strong></span>
</pre></div></li><li class="listitem" value="8">Then, create the PXE configuration file, as follows: <code class="email">/var/lib/tftpboot/pxelinux.cfg/default</code>.<div class="informalexample"><pre class="programlisting">default menu.c32
prompt 0
timeout 300
ONTIMEOUT local
menu title PXE Boot Menu
label 1
  menu label ^1 - Install RHEL 7 x64 with Local http Repo
  kernel rhel7/vmlinuz
  append initrd=rhel7/initrd.img method=http://repo.critter.be/rhel/7/os/x86_64/ devfs=nomount ks=http://kickstart.critter.be/kickstart.ks
label 2
  menu label ^2 - Boot from local media</pre></div></li><li class="listitem" value="9">Copy <code class="email">initrd</code> and <code class="email">kernel</code> from the RHEL 7 installation media to <code class="email">/var/lib/tftpboot/rhel7/</code>, and run the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# mkdir /var/lib/tftpboot/rhel7</strong></span>
<span class="strong"><strong class="calibre8">~]# mount -o loop /dev/cdrom /mnt</strong></span>
<span class="strong"><strong class="calibre8">~]# cp /mnt/images/pxeboot/{initrd.img,vmlinuz} /var/lib/tftpboot/rhel7/</strong></span>
<span class="strong"><strong class="calibre8">~]# umount /mnt</strong></span>
</pre></div></li><li class="listitem" value="10">Open the firewall on your server using these commands (however, this may not be necessary):<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# firewall-cmd --add-service=dns --permanent</strong></span>
<span class="strong"><strong class="calibre8">~]# firewall-cmd --add-service=dhcp --permanent</strong></span>
<span class="strong"><strong class="calibre8">~]# firewall-cmd --add-service=tftp --permanent</strong></span>
<span class="strong"><strong class="calibre8">~]# firewall-cmd --reload</strong></span>
</pre></div></li><li class="listitem" value="11">Finally, launch <a id="id84" class="calibre1"/>your client, configure it to boot from the network, and select<a id="id85" class="calibre1"/> the first option shown in the following figure:<div class="mediaobject"><img src="../images/00012.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Deploying a system using PXE">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch02lvl2sec55" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">DNSMASQ takes care of pointing booting systems to the <code class="email">tftp</code> server by providing the <code class="email">enable-tftp</code> option in the <code class="email">dnsmasq</code> configuration file.</p><p class="calibre7">Syslinux is needed to provide the necessary binaries to boot from the network.</p><p class="calibre7">The <code class="email">tftp</code> server itself provides access to the <code class="email">syslinux</code> files, RHEL 7 kernel, and <code class="email">initrd</code> for the system to boot from.</p><p class="calibre7">The PXE configuration file provides the necessary configuration to boot a system, including a kickstart file that automatically installs your system.</p></div></div>

<div class="book" title="Deploying a system using PXE">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch02lvl2sec56" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">This recipe's base premise is that you do not have a DHCP server installed. In most companies, you already have DHCP services available.</p><p class="calibre7">If you<a id="id86" class="calibre1"/> have an ISC-DHCP<a id="id87" class="calibre1"/> server in place, this is what you need to add to the subnet definition(s) you want to allow in PXE:</p><div class="informalexample"><pre class="programlisting">  next-server &lt;ip address of TFTP server&gt;;
  filename "pxelinux.0";</pre></div></div></div>

<div class="book" title="Deploying a system using PXE">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch02lvl2sec57" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Check out <a class="calibre1" title="Chapter 8. Yum and Repositories" href="part0066_split_000.html#1UU541-501a83dd54944cb1bf060a2ce9fab11f">Chapter 8</a>, <span class="strong"><em class="calibre9">Yum and Repositories</em></span> to set up an RHEL 7 repository from the installation media.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Deploying a system using a custom boot ISO file"><div class="book" id="RL0A2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch02lvl1sec23" class="calibre1"/>Deploying a system using a custom boot ISO file</h1></div></div></div><p class="calibre7">PXE is a widely used way to deploy systems, and so are ISO's. PXE may not always be at hand because <a id="id88" class="calibre1"/>of security, hardware <a id="id89" class="calibre1"/>availability, and so on.</p><p class="calibre7">Many hardware manufacturers provide remote access to their systems without an OS installed. HP has iLO, while Dell has RIB. The advantage of these "remote" control solutions is that they also allow you to mount "virtual" media in the form of an ISO.</p></div>

<div class="book" title="Deploying a system using a custom boot ISO file">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch02lvl2sec58" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Red Hat provides boot media as ISO images, which you can use to boot your systems from. We will create a custom ISO image, which will allow us to boot a system in a similar way.</p><p class="calibre7">Let's create an ISO that you can mount as virtual media, write a CD-ROM, or even use <code class="email">dd</code> to write the contents on a USB stick/disk through the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Install the required packages to create ISO9660 images, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y genisoimage</strong></span>
</pre></div></li><li class="listitem" value="2">Mount the RHEL 7 DVD's ISO image by executing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# mount -o loop /path/to/rhel-server-7.0-x86_64-dvd.iso /mnt</strong></span>
</pre></div></li><li class="listitem" value="3">Copy the required files for the custom ISO from the RHEL 7 media via the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# mkdir -p /root/iso</strong></span>
<span class="strong"><strong class="calibre8">~]# cp -r /mnt/isolinux /root/iso</strong></span>
<span class="strong"><strong class="calibre8">~]# umount /mnt</strong></span>
</pre></div></li><li class="listitem" value="4">Now, unmount the RHEL 7 DVD's ISO image by running the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# umount /mnt</strong></span>
</pre></div></li><li class="listitem" value="5">Next, remove<a id="id90" class="calibre1"/> the <code class="email">isolinux.cfg</code> file using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# rm -f /root/iso/isolinux/isolinux.cfg</strong></span>
</pre></div></li><li class="listitem" value="6">Create a <a id="id91" class="calibre1"/>new <code class="email">isolinux.cfg</code> file, as follows:<div class="informalexample"><pre class="programlisting">default vesamenu.c32
timeout 600
display boot.msg
menu clear
menu background splash.png
menu title Red Hat Enterprise Linux 7.0
menu vshift 8
menu rows 18
menu margin 8
menu helpmsgrow 15
menu tabmsgrow 13
menu color sel 0 #ffffffff #00000000 none
menu color title 0 #ffcc000000 #00000000 none
menu color tabmsg 0 #84cc0000 #00000000 none
menu color hotsel 0 #84cc0000 #00000000 none
menu color hotkey 0 #ffffffff #00000000 none
menu color cmdmark 0 #84b8ffff #00000000 none
menu color cmdline 0 #ffffffff #00000000 none
label linux
  menu label ^Install Red Hat Enterprise Linux 7.0
  kernel vmlinuz
  append initrd=initrd.img ks=http://kickstart.critter.be/kickstart.ks text

label local
  menu label Boot from ^local drive
  localboot 0xffff

menu end</pre></div></li><li class="listitem" value="7">Now, create the ISO by executing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cd /root/iso</strong></span>
<span class="strong"><strong class="calibre8">~/iso]# mkisofs -o ../boot.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -J -r .</strong></span>
</pre></div><p class="calibre13">More information on the options used with the <code class="email">mkisofs</code> command can be <a id="id92" class="calibre1"/>found in the man<a id="id93" class="calibre1"/> pages for <span class="strong"><em class="calibre9">mkisofs(1)</em></span>.</p><p class="calibre13">The following image shows the progress on creating a custom ISO:</p><div class="mediaobject"><img src="../images/00013.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="8">Then, use the ISO to install a guest on a KVM server, as shown in the following commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# virsh vol-create-as --pool localfs-vm --name rhel7_guest-da.qcows2 --format qcows2 –capacity 10G</strong></span>
<span class="strong"><strong class="calibre8">~]# virt-install \</strong></span>
<span class="strong"><strong class="calibre8">--hvm \</strong></span>
<span class="strong"><strong class="calibre8">--name rhel7_guest \</strong></span>
<span class="strong"><strong class="calibre8">–-memory 2G,maxmemory=4G \</strong></span>
<span class="strong"><strong class="calibre8">--vcpus 2,max=4 \</strong></span>
<span class="strong"><strong class="calibre8">--os-type linux \</strong></span>
<span class="strong"><strong class="calibre8">--os-variant rhel7 \</strong></span>
<span class="strong"><strong class="calibre8">--boot hd,cdrom,network,menu=on \</strong></span>
<span class="strong"><strong class="calibre8">--controller type=scsi,model=virtio-scsi \</strong></span>
<span class="strong"><strong class="calibre8">--disk device=cdrom,vol=iso/boot.iso,readonly=on,bus=scsi \</strong></span>
<span class="strong"><strong class="calibre8">--disk device=disk,vol=localfs-vm/rhel7_guest-vda.qcow2,cache=none,bus=scsi \</strong></span>
<span class="strong"><strong class="calibre8">--network network=bridge-eth0,model=virtio \</strong></span>
<span class="strong"><strong class="calibre8">--graphics vnc \</strong></span>
<span class="strong"><strong class="calibre8">--graphics spice \</strong></span>
<span class="strong"><strong class="calibre8">--noautoconsole \</strong></span>
<span class="strong"><strong class="calibre8">--memballoon virtio</strong></span>
</pre></div><p class="calibre13">The <a id="id94" class="calibre1"/>following screenshot <a id="id95" class="calibre1"/>shows the console when booted with the custom ISO image:</p><div class="mediaobject"><img src="../images/00014.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Deploying a system using a custom boot ISO file">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch02lvl2sec59" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">Using the<a id="id96" class="calibre1"/> RHEL 7 installation media, we <a id="id97" class="calibre1"/>created a new boot ISO that allows us to install a new system. The ISO can be used to either burn a CD, with the <code class="email">dd</code> tool to be copied on a USB stick, or to mount as virtual media. The way to mount this ISO as virtual media is different on each hardware platform, so this recipe shows you how to install it using KVM.</p></div></div></body></html>