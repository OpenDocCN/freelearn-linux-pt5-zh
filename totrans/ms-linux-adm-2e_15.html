<html><head></head><body>
<div><h1 class="chapter-number" id="_idParaDest-308"><a id="_idTextAnchor326"/>15</h1>
<h1 id="_idParaDest-309"><a id="_idTextAnchor327"/>Deploying to the Cloud with AWS and Azure</h1>
<p>Recent years have seen a significant shift from on-premises computing platforms to private and public clouds. In an ever-changing and accelerating world, deploying and running applications in a highly scalable, efficient, and secure infrastructure is critical for businesses and organizations everywhere. On the other hand, the cost and expertise required to maintain the equivalent level of security and performance with on-premises computing resources become barely justifiable compared to current public cloud offerings. Businesses and teams, small and large, adopt public cloud services in increasing numbers, albeit large enterprises are relatively slow to make a move.</p>
<p>One of the best metaphors for cloud computing is application services <em class="italic">on tap</em>. Do you need more resources for your apps? Just <em class="italic">turn on the tap</em> and provision the virtual machines or instances in any number you require (scale horizontally). Or perhaps, for some instances, you require more CPUs or memory (scale vertically). When you no longer need resources, just <em class="italic">turn off </em><em class="italic">the tap</em>.</p>
<p>Public cloud services provide all these functions at relatively low rates, taking away the operations overhead that you might otherwise have with maintaining the on-premises infrastructure accommodating such features.</p>
<p>This chapter <a id="_idIndexMarker2137"/>will introduce you to <strong class="bold">Amazon Web Service</strong> (<strong class="bold">AWS</strong>) and <strong class="bold">Microsoft Azure</strong> – two major public cloud providers – and offer some practical <a id="_idIndexMarker2138"/>guidance for deploying your applications in the cloud. In particular, we’ll focus on typical cloud management workloads, using both the web administration console and the command-line interface.</p>
<p>By the end of this chapter, you’ll know how to use the AWS web console and the AWS CLI, as well as the Azure web portal and the Azure CLI, to manage your cloud resources with the two most popular cloud providers of our time. You’ll also learn how to make a prudent decision about creating and launching your resources in the cloud, striking a sensible balance between performance and cost.</p>
<p>We hope that Linux administrators – novice and experienced alike – will find the content in this chapter relevant and refreshing. Our focus is purely practical as we explore the AWS and Azure cloud workloads. We will refrain from comparing the two since such an endeavor would go beyond this chapter’s scope. To make the journey less boring, we’ll also steer away from keeping a perfect symmetry between describing AWS and Azure management tasks. We all know AWS blazed the trail into the public cloud realm first. Other major cloud providers followed, adopted, and occasionally improved the underlying paradigms and workflows. Since we’ll be introducing AWS first, we’ll cover more ground on <a id="_idIndexMarker2139"/>some cloud provisioning concepts (such as Regions and <strong class="bold">Availability Zones</strong> (<strong class="bold">AZs</strong>)), which in many ways are very similar to what’s available in Azure.</p>
<p>Finally, we’ll leave the ultimate choice between using AWS or Azure up to you. We’re giving you the map. The road is yours to take.</p>
<p>Here are some of the key topics you’ll learn about:</p>
<ul>
<li>Working with AWS EC2</li>
<li>Working with Microsoft Azure</li>
</ul>
<h1 id="_idParaDest-310"><a id="_idTextAnchor328"/>Technical requirements</h1>
<p>To complete the tasks in this chapter, you will require the following:</p>
<ul>
<li>AWS and Azure accounts if you want to follow along with the practical examples. Both cloud providers provide free subscriptions:<ul><li>AWS free tier: <a href="https://aws.amazon.com/free">https://aws.amazon.com/free</a></li><li>Microsoft Azure free account: <a href="https://azure.microsoft.com/en-us/free/">https://azure.microsoft.com/en-us/free/</a></li></ul></li>
<li>A local machine with a Linux distribution of your choice to install and experiment with the AWS CLI and Azure CLI utilities.</li>
<li>A modern web browser (such as Google Chrome or Mozilla Firefox) for the web-console-driven management tasks for both AWS and Azure. You can access the related portals on any platform.</li>
<li>A Linux command-line terminal and intermediate-level proficiency using the shell to run the AWS and Azure CLI commands.</li>
</ul>
<p class="callout-heading">Important note</p>
<p class="callout">As you proceed, please make sure to shut down your EC2 instances or Azure virtual machines after you finish experimenting with them. Failure to do so may result in relatively high bills being generated for you.</p>
<p>With this, let’s start with our first contender, AWS EC2.</p>
<h1 id="_idParaDest-311"><a id="_idTextAnchor329"/>Working with AWS EC2</h1>
<p>AWS <strong class="bold">Elastic Compute Cloud</strong> (<strong class="bold">EC2</strong>) is a scalable computing infrastructure that allows users to<a id="_idIndexMarker2140"/> lease virtual computing platforms and services to run their cloud applications. AWS EC2 has gained extreme popularity in recent years due to its outstanding performance and scalability combined with relatively cost-effective service plans. This section provides some basic functional knowledge to get you started with deploying and managing AWS EC2 instances running your applications. In particular, we’ll introduce you to EC2 instance types, particularly how you can differentiate between various provisioning and related pricing tiers, how to use SSH to connect and SCP to transfer files to and from your EC2 instances, and how to work with the AWS CLI.</p>
<p>By the end of this section, you’ll have a basic understanding of AWS EC2 and how to choose, deploy, and manage your EC2 instances.</p>
<h2 id="_idParaDest-312"><a id="_idTextAnchor330"/>Introducing and creating AWS EC2 instances</h2>
<p>AWS EC2 provides <a id="_idIndexMarker2141"/>various instance types, each with its provisioning, capacity, pricing, and use case models. Choosing between different EC2 instance types is not always trivial. This section will briefly describe each EC2 instance type, some pros and cons of using them, and how to choose the most cost-effective solution. With each instance type, we’ll show you how to launch one using the AWS console.</p>
<p>We can look at EC2 <a id="_idIndexMarker2142"/>instance types from two perspectives. When you decide on an EC2 instance, you’ll have to consider both these factors. Let’s look at each of these options briefly:</p>
<ul>
<li><strong class="bold">Provisioning</strong>: The capacity and computing power of your EC2 instance. The main differentiating feature<a id="_idIndexMarker2143"/> of each EC2 instance provisioning type is the computing power, which is expressed by vCPU (or CPU), memory (RAM), and storage (disk capacity).<p class="list-inset">Some EC2 <a id="_idIndexMarker2144"/>instance types also provide <strong class="bold">graphical processing unit</strong> (<strong class="bold">GPU</strong>) or <strong class="bold">field programmable gate array</strong> (<strong class="bold">FPGA</strong>) computing <a id="_idIndexMarker2145"/>capabilities. A detailed view of EC2 instance provisioning types is beyond the scope of this chapter. You can explore the related information at <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html</a> or <a href="https://aws.amazon.com/ec2/instance-types/">https://aws.amazon.com/ec2/instance-types/</a>.</p></li>
<li><code>type</code> and <code>region</code></li><li><strong class="bold">Spot instances</strong>: These EC2 instances are available for reuse at a lower price than on-demand instances</li><li><strong class="bold">Dedicated instances</strong>: These EC2 instances run in a <strong class="bold">virtual private cloud</strong> (<strong class="bold">VPC</strong>) assigned to a<a id="_idIndexMarker2147"/> single-payer account</li></ul></li>
</ul>
<p>We’ll cover each of these EC2 instance types in the following sections. For each of these types, we’ll show an example of how to launch a corresponding instance.</p>
<p>However, before creating an instance, we’ll look at another key concept regarding EC2 instances – <strong class="bold">AZs</strong>.</p>
<h3>EC2 AZs</h3>
<p>The<a id="_idIndexMarker2148"/> AWS EC2 service is available in multiple locations around the globe, known as <strong class="bold">Regions</strong>. Here are some examples of Regions:</p>
<ul>
<li><code>us-west-2</code>)</li>
<li><code>ap-south-1</code>)</li>
</ul>
<p>EC2 defines multiple AZs in a Region, which are essentially one or more data centers. Regions are entirely isolated from each other in terms of the underlying infrastructure to provide fault tolerance and high availability. If a Region becomes unavailable, only the EC2 instances within the affected Region are unreachable. Other Regions with their EC2 instances will continue to work uninterrupted.</p>
<p>Similarly, AZs are connected while providing highly available and fault-tolerant EC2 services within a Region. Launching an EC2 instance creates it in the current Region selected in the AWS console. An AWS EC2 administrator may switch between different Regions when managing EC2 instances. Only instances within the selected Region are visible in the EC2 administration console. An EC2 administrator will usually choose a Region based on the geographical location of the users accessing the EC2 instance.</p>
<p>Now that we have preliminary knowledge of various EC2 instance types, let’s look at on-demand instances.</p>
<h3>EC2 on-demand instances</h3>
<p>AWS <a id="_idIndexMarker2149"/>EC2 <strong class="bold">on-demand instances</strong> use a <em class="italic">pay-as-you-go</em> pricing model for resource usage per second, without a long-time contract. On-demand instances are best suited for experimenting with uncertain workloads where the resource usage is not fully known (such as during development). The flexibility of these on-demand instances comes with a higher price than reserved instances, for example.</p>
<p>Let’s launch an on-demand instance:</p>
<ol>
<li>First, we must log into our AWS account console at <a href="https://console.aws.amazon.com">https://console.aws.amazon.com</a>. The following screenshot shows the default console view, where you will have information about the user (<strong class="bold">1</strong>), the Region (<strong class="bold">2</strong>), and the available – or recently visited – services (<strong class="bold">3</strong>):</li>
</ol>
<div><div><img alt="Figure 15.1 – The AWS management console" src="img/B19682_15_01.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.1 – The AWS management console</p>
<ol>
<li value="2">Next, we must select the <a id="_idIndexMarker2150"/>EC2 service from the list on the left-hand side, as shown in the preceding screenshot. This will lead us to the EC2 dashboard interface, as follows:</li>
</ol>
<div><div><img alt="Figure 15.2 – The EC2 dashboard" src="img/B19682_15_02.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.2 – The EC2 dashboard</p>
<p class="list-inset">The <strong class="bold">Launch instance</strong> button, as shown in the preceding screenshot, will begin the step-by-step process of creating our on-demand instance. This will lead us to a new interface where we can provide the main configuration options on our new instance, such as its name, operating system to use, instance type, login key pair, network, and storage settings.</p>
<ol>
<li value="3">Next, we need <a id="_idIndexMarker2151"/>to choose a name and a tag. First, we will choose a name for our instance. In our case, we set the name to <code>aws_packt_testing_1</code>:</li>
</ol>
<div><div><img alt="Figure 15.3 – Giving a name to the new EC2 instance" src="img/B19682_15_03.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.3 – Giving a name to the new EC2 instance</p>
<p class="list-inset">Alternatively, we can add a new tag. To do this, we must click <code>env</code> and a value of <code>packt</code>. We can add multiple tags (key-value pairs) to a given instance if we need to:</p>
<div><div><img alt="Figure 15.4 – Adding tags to an EC2 instance" src="img/B19682_15_04.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.4 – Adding tags to an EC2 instance</p>
<ol>
<li value="4">Next, we must choose an operating system. We’ll select Ubuntu 22.04 LTS as our Linux distribution for the new EC2 instance, as shown in the following screenshot:</li>
</ol>
<div><div><img alt="Figure 15.5 – Choosing the operating system for the EC2 instance" src="img/B19682_15_05.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.5 – Choosing the operating system for the EC2 instance</p>
<p class="list-inset">There are other operating systems to choose from, including macOS, Microsoft Windows, and Linux distributions such as Red Hat Enterprise Linux, SUSE Linux Enterprise, or Debian Linux, alongside Amazon Linux and Ubuntu.</p>
<ol>
<li value="5">Now, we can <a id="_idIndexMarker2153"/>choose an instance type. Here, we’ll select the instance type based on our provisioning needs. In our case, we will select the <strong class="bold">t2.micro</strong> type, with 1 vCPU and 1 GB of memory:</li>
</ol>
<div><div><img alt="Figure 15.6 – Choosing an instance type – the t2.micro" src="img/B19682_15_06.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.6 – Choosing an instance type – the t2.micro</p>
<ol>
<li value="6">Under <strong class="bold">Network settings</strong>, we will leave the default settings unchanged for now:</li>
</ol>
<div><div><img alt="Figure 15.7 – Setting up the network for the new EC2 instance" src="img/B19682_15_07.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.7 – Setting up the network for the new EC2 instance</p>
<ol>
<li value="7">The next <a id="_idIndexMarker2154"/>step is to configure storage. By default, the EC2 instance provides an 8 GB SSD volume, but you can set it up to 30 GB while using the free tier. We will use it with the default 8 GB:</li>
</ol>
<div><div><img alt="Figure 15.8 – Setting up storage for the EC2 instance" src="img/B19682_15_08.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.8 – Setting up storage for the EC2 instance</p>
<ol>
<li value="8">The last step before launching the new EC2 instance is to review the detailed summary <a id="_idIndexMarker2155"/>provided and decide if there are any other changes to be made. Once the new instance has been tailored to our needs, we can create it by clicking on the <strong class="bold">Launch instance</strong> button, as shown in the following screenshot:</li>
</ol>
<div><div><img alt="Figure 15.9 – Summary of the new EC2 instance and the Launch instance button" src="img/B19682_15_09.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.9 – Summary of the new EC2 instance and the Launch instance button</p>
<p class="list-inset">At this point, we are ready to launch our instance by pressing the <strong class="bold">Launch instance</strong> button. Alternatively, we could follow further configuration steps by revisiting the <a id="_idIndexMarker2156"/>previous steps; otherwise, EC2 will assign some default values.</p>
<ol>
<li value="9">When launching the EC2 instance, we will be asked to create or select a certificate key pair for remote SSH access into our instance. This will highlight the key pair section on the screen, where we can click on the <code>packt_aws_key</code>, select the <strong class="bold">RSA</strong> type and the <strong class="bold">.pem</strong> file format, and then click on the <strong class="bold">Create key pair</strong> button in the lower right corner:</li>
</ol>
<div><div><img alt="Figure 15.10 – Selecting or creating a certificate key pair for SSH access" src="img/B19682_15_10.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.10 – Selecting or creating a certificate key pair for SSH access</p>
<p class="list-inset">You will <a id="_idIndexMarker2157"/>be automatically asked to download the new <code>.pem</code> file to a location on your local machine.</p>
<ol>
<li value="10">Download the related file (<code>packt-ec2.pem</code>) to a secure location on your local machine, where you can use it with the <code>ssh</code> command to access your EC2 instance:<pre class="source-code">
<code>env: packt</code> tag, we’ll get a view of the EC2 instance we just created:</li>
</ol>
<div><div><img alt="Figure 15.11 – An EC2 instance in the running state" src="img/B19682_15_11.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.11 – An EC2 instance in the running state</p>
<p>For more information about <a id="_idIndexMarker2159"/>on-demand instances, please visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-on-demand-instances.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-on-demand-instances.html</a>.</p>
<p>Now that we have learned the basics of launching an on-demand instance, let’s look at reserved instances.</p>
<h3>EC2 reserved instances</h3>
<p>With <strong class="bold">reserved instances</strong>, we<a id="_idIndexMarker2160"/> lease the EC2 computing capacity of a specific type for a specific amount of time. This length of time is called a <strong class="bold">term</strong> and can either be a 1-year or a 3-year commitment. Here are the main characteristics that need to be set upfront when purchasing reserved instances, as shown in <em class="italic">Figure 15</em><em class="italic">.12</em>:</p>
<ul>
<li><strong class="bold">Platform</strong>: An example of this is <strong class="bold">Linux</strong>.</li>
<li><strong class="bold">Tenancy</strong>: Running on <strong class="bold">Default</strong> (shared) or <strong class="bold">Dedicated</strong> hardware.</li>
<li><strong class="bold">Offering Class</strong>: These are the types of reserved instances that are available. The options are as follows:<ul><li><strong class="bold">Standard</strong>: A plain reserved instance with a well-defined set of options</li><li><strong class="bold">Convertible</strong>: It allows specific changes, such as modifying the instance type (for example, from <strong class="bold">t2.large</strong> to <strong class="bold">t2.xlarge</strong>)</li></ul></li>
<li><strong class="bold">Instance Type</strong>: An example of this is <strong class="bold">t2.large</strong>.</li>
<li><strong class="bold">Term</strong>: For example, <strong class="bold">1 year.</strong></li>
<li><strong class="bold">Payment option</strong>: <strong class="bold">All upfront</strong>, <strong class="bold">Partial upfront</strong>, <strong class="bold">No upfront</strong>.</li>
</ul>
<p>With each of these options and the different tiers within, your costs depend on the cloud computing resources involved and the duration of the service. For example, if you choose to pay all upfront, you’ll get a better discount than otherwise. Choosing from among the options previously mentioned is ultimately an exercise in cost-saving and flexibility.</p>
<p>A close analogy to purchasing reserved instances is a <em class="italic">mobile telephone plan</em> – you decide on all the options you want, and then you commit a certain amount of time. With reserved instances, you get less flexibility in terms of making changes, but with significant savings in cost – sometimes up to 75%, compared to on-demand instances.</p>
<p>To launch a reserved instance, go to your EC2 dashboard in the AWS console and choose <strong class="bold">Reserved Instances</strong> under <strong class="bold">Instances</strong> in the left panel, then click on the <strong class="bold">Purchase Reserved Instances</strong> button. Here is an example of purchasing a reserved EC2 instance:</p>
<div><div><img alt="Figure 15.12 – Purchasing a reserved EC2 instance" src="img/B19682_15_12.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.12 – Purchasing a reserved EC2 instance</p>
<p>For more information about<a id="_idIndexMarker2161"/> EC2 reserved instances, please visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-reserved-instances.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-reserved-instances.html</a>.</p>
<p>We have learned that reserved instances are a cost-effective alternative to on-demand EC2 instances. Now, let’s take our journey further and look at yet another way to reduce the costs by using spot instances.</p>
<h3>EC2 spot instances</h3>
<p>A <strong class="bold">spot instance</strong> is an unused <a id="_idIndexMarker2162"/>instance waiting to be leased. The amount of <a id="_idIndexMarker2163"/>time a spot instance is vacant and at your disposal depends on the general availability of the requested capacity in EC2, given that the associated costs are not higher than the amount you are willing to pay for your spot instance. AWS advertises spot instances with an up to 90% discount compared to on-demand EC2 pricing.</p>
<p>The major caveat of using spot instances is the potential <em class="italic">no-vacancy</em> situation when the required capacity is no longer available at the initially agreed-upon rate. In such circumstances, the spot instance will shut down (and perhaps be leased elsewhere). AWS EC2 is kind enough to give a 2-minute warning before stopping the spot instance. This time should be used to properly tear down the application workflows running within the instance.</p>
<p>Spot instances are best suited for non-critical tasks, where application processing could be inadvertently interrupted at any moment and resumed later, without considerable damage or data loss. Such jobs may include data analysis, batch processing, and optional tasks.</p>
<p>To launch a spot instance, go to your <strong class="bold">EC2</strong> dashboard and choose <strong class="bold">Spot Requests</strong> in the left-hand menu. Under <strong class="bold">Instances</strong>, click on <strong class="bold">Request Spot Instances</strong> and follow the steps described in the <em class="italic">EC2 on-demand </em><em class="italic">instances</em> section.</p>
<p>A detailed <a id="_idIndexMarker2164"/>explanation of launching a spot instance is beyond the scope of this chapter. The AWS EC2 console does a great job of describing and assisting with the related options. For more <a id="_idIndexMarker2165"/>information about spot instances, please visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-spot-instances.html</a>.</p>
<p>We know that by default, EC2 instances run on shared hardware, meaning that instances owned by multiple AWS customers share the same machine (or virtual machine). But what if you wanted to have a dedicated platform to run your EC2 instances? We’ll look at dedicated instances next.</p>
<h3>EC2 dedicated instances</h3>
<p>Specific businesses<a id="_idIndexMarker2166"/> require applications to run on dedicated hardware without them sharing the platform with anyone. AWS EC2 provides <strong class="bold">dedicated hosts</strong> and <strong class="bold">dedicated instances</strong> to accommodate this use case. As you may expect, dedicated instances would cost more than other instance types. So, why should we care about leasing such instances?</p>
<p>There are businesses – especially among financial, health, and governmental institutions – required by law to meet strict regulatory requirements for processing sensitive data or to acquire hardware-based licenses for running their applications.</p>
<p>With dedicated instances <em class="italic">without</em> a dedicated host, EC2 would guarantee that your applications run on a hypervisor exclusively dedicated to you, yet it would not enforce a fixed set of machines or hardware. In other words, some of your instances may run on different physical hosts. Choosing a dedicated host in addition to dedicated instances would always warrant a fully dedicated environment – hypervisors and hosts – for running your applications exclusively, without sharing the underlying platforms with other AWS customers.</p>
<p>To launch <a id="_idIndexMarker2167"/>a dedicated instance, you can follow these steps:</p>
<ol>
<li>Start with the same steps that you performed for launching an on-demand EC2 instance that were described earlier in this chapter, in the <em class="italic">EC2 on-demand </em><em class="italic">instances</em> section.</li>
<li>You can add another step to the launching process. To do this, you must open the <strong class="bold">Advanced details</strong> drop-down section and scroll to the <strong class="bold">Tenancy</strong> option, where you must choose <strong class="bold">Dedicated – run a dedicated instance</strong>, as shown in the following screenshot:</li>
</ol>
<div><div><img alt="Figure 15.13 – Launching a dedicated EC2 instance" src="img/B19682_15_13.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.13 – Launching a dedicated EC2 instance</p>
<ol>
<li value="3">If you want to run your dedicated instance on a dedicated host, you must create a dedicated host first. To do this, on the <strong class="bold">EC2</strong> dashboard, navigate to <strong class="bold">Instances</strong> | <strong class="bold">Dedicated Hosts</strong>:</li>
</ol>
<div><div><img alt="Figure 15.14 – Creating a dedicated EC2 host" src="img/B19682_15_14.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.14 – Creating a dedicated EC2 host</p>
<ol>
<li value="4">Follow the EC2 wizard to allocate your dedicated host according to your preferences. After <a id="_idIndexMarker2168"/>creating your host, you may launch your dedicated instance as described previously and choose the <strong class="bold">Dedicated host – launch this instance on a dedicated Host</strong> option for <strong class="bold">Tenancy</strong>, as shown in <em class="italic">step 2</em>.</li>
</ol>
<p>For more information on <a id="_idIndexMarker2169"/>dedicated hosts, please visit <a href="https://aws.amazon.com/ec2/dedicated-hosts/">https://aws.amazon.com/ec2/dedicated-hosts/</a>. For dedicated instances, see <a href="https://aws.amazon.com/ec2/pricing/dedicated-instances/">https://aws.amazon.com/ec2/pricing/dedicated-instances/</a>.</p>
<p>We’ll conclude our journey through AWS EC2 instance types<a id="_idIndexMarker2170"/> here. For more information, please visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Instances.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Instances.html</a>.</p>
<p>Next, we’ll look at one of the two essential EC2 deployment features that allow you to be proficient and resourceful when deploying and scaling your EC2 instances – <strong class="bold">Amazon Machine Images</strong> (<strong class="bold">AMIs</strong>) and <strong class="bold">placement groups</strong>. We will only discuss placement groups in this chapter. For more<a id="_idIndexMarker2171"/> information about AMIs, please visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html</a>. Placement groups control how your instances are spread across the EC2 infrastructure for high availability and optimized workloads. We’ll discuss this next.</p>
<h2 id="_idParaDest-313"><a id="_idTextAnchor331"/>Introducing AWS EC2 placement groups</h2>
<p><strong class="bold">Placement groups</strong> allow<a id="_idIndexMarker2172"/> you<a id="_idIndexMarker2173"/> to specify how your EC2 instances are placed across the underlying EC2 hardware or hypervisors, providing strategies to group or separate instances depending on your requirements. Placement groups are offered free of charge.</p>
<p>There are three types of placement groups to choose from. Let’s quickly go through each of these types and look at their use cases:</p>
<ul>
<li><strong class="bold">Cluster placement groups</strong>: With <a id="_idIndexMarker2174"/>cluster placement groups, instances are<a id="_idIndexMarker2175"/> placed within a single AZ (data center). They are best suited for low-latency, high-throughput communication between instances, but not with the outside world. Applications with high-performance computing or data replication would greatly benefit from cluster placement, but web servers, for example, not so much.</li>
<li><strong class="bold">Spread placement groups</strong>: When you launch <a id="_idIndexMarker2176"/>multiple EC2 instances, there’s always a <a id="_idIndexMarker2177"/>possibility that they may end up running on the same physical machine or hypervisor. This may not be desirable when a single point of failure (such as hardware) would be critical for your applications. Spread placement groups provide hardware isolation between instances. In other words, if you launch multiple instances in a spread placement group, there’s a guarantee that they will run on separate physical machines. In the rare case of an EC2 hardware failure, only one of your instances would be affected.</li>
<li><strong class="bold">Partition placement groups</strong>: Partition<a id="_idIndexMarker2178"/> placement groups will group your<a id="_idIndexMarker2179"/> instances in logical formations (partitions) with hardware isolation between the partitions, but not at the instance level. We can view this model as a hybrid between the cluster and spread placement groups. When you launch multiple instances within a partition placement group, EC2 will do its best to distribute the instances between partitions evenly. For example, if you had four partitions and 12 instances, EC2 would <a id="_idIndexMarker2180"/>place three instances in each node (partition). We can look at a partition as a computing unit <a id="_idIndexMarker2181"/>made of multiple instances. In the case of a hardware failure, the isolated partition instances can still communicate with each other but not across partitions. Partition placement groups support up to seven instances in a single logical partition.</li>
</ul>
<p>To create a placement group, navigate to <strong class="bold">Network &amp; Security</strong> | <strong class="bold">Placement Groups</strong> in your <strong class="bold">EC2</strong> dashboard’s left menu and click on the <strong class="bold">Create Placement Group</strong> button. On the next screen, you must specify a name for the <strong class="bold">Placement Group</strong> option, as well as a <strong class="bold">Placement Strategy</strong> value. Optionally, you can add tags (key-value pairs) for organizing or identifying your placement<a id="_idIndexMarker2182"/> group. When you’re done, click<a id="_idIndexMarker2183"/> the <strong class="bold">Create </strong><strong class="bold">group</strong> button:</p>
<div><div><img alt="Figure 15.15 – Creating a placement group" src="img/B19682_15_15.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.15 – Creating a placement group</p>
<p>For more information on <a id="_idIndexMarker2184"/>EC2 placement groups, please visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/placement-groups.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/placement-groups.html</a>.</p>
<p>Now that we are familiar with various EC2 instance types, let’s look at how to use our instances.</p>
<h2 id="_idParaDest-314"><a id="_idTextAnchor332"/>Using AWS EC2 instances</h2>
<p>In this section, we’ll briefly<a id="_idIndexMarker2185"/> go through some essential operations and management concepts regarding your instances. First, we’ll look at the life cycle of an EC2 instance.</p>
<h3>The life cycle of an EC2 instance</h3>
<p>When using or managing <a id="_idIndexMarker2186"/>EC2 instances, it is important to understand the transitional stages, from launch to running to hibernation, shutdown, or termination. Each of these states affects billing and the way we access our instances:</p>
<div><div><img alt="Figure 15.16 – The life cycle of an EC2 instance" src="img/B19682_15_16.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.16 – The life cycle of an EC2 instance</p>
<p>Let’s break this down:</p>
<ul>
<li>The <strong class="bold">PENDING</strong> state corresponds to the boot-up and initialization phase of our instance.</li>
<li>Transitioning from <strong class="bold">PENDING</strong> to <strong class="bold">RUNNING</strong> is not always immediate, and it may take a while for the applications running within the instance to become responsive. EC2 starts billing our instance in the <strong class="bold">RUNNING</strong> state until transitioning to the <strong class="bold">STOPPED</strong> state.</li>
<li>In the <strong class="bold">RUNNING</strong> state, we can reboot our instance if needed. During the <strong class="bold">REBOOTING</strong> state, EC2 always brings back our instance on the same host, whereas stopping and restarting doesn’t always guarantee the same host for the instance.</li>
<li>In the <strong class="bold">STOPPED</strong> state, we’ll no longer be charged for the instance, but there will be costs related to any additional storage (other than the root volume) attached to the instance.</li>
<li>When the instance is no longer required, we may choose between the <strong class="bold">STOPPING</strong> or <strong class="bold">HIBERNATING</strong> states. With <strong class="bold">HIBERNATING</strong>, we avoid the <strong class="bold">PENDING</strong> state’s potential latency upon startup. If we no longer use the instance, we may decide to terminate it. Upon termination, there are no more charges related to the instance. When terminating an<a id="_idIndexMarker2187"/> instance, it may still show up for a little while in the EC2 dashboard before it gets permanently removed.</li>
</ul>
<p>We can connect to an EC2 instance in a running state using SSH. In the next section, we’ll show you how.</p>
<h3>Connecting to AWS EC2 instances</h3>
<p>EC2 instances, in <a id="_idIndexMarker2188"/>general, serve the purpose of running a specific application or a group of applications. The related platform’s administration and maintenance usually require terminal access. The way to access these instances (or any other service) is determined by how AWS differentiates the available services into two different concepts, similar to the ones used in networking – control plane and data plane. These are concepts that represent how EC2 instances can be accessed:</p>
<ul>
<li><strong class="bold">Control plane (or management plane) access</strong>: Using the AWS EC2 console and the SSH terminal, we perform administrative tasks on EC2 instances.</li>
<li><strong class="bold">Data plane access</strong>: Applications running on EC2 instances may also expose their specific endpoints (ports) for communicating with the outside world. EC2 uses security groups to control the related network traffic.</li>
</ul>
<p>In this <a id="_idIndexMarker2189"/>section, we’ll briefly look at both control plane and data plane access. In particular, we’ll discuss how to connect to an EC2 instance using SSH and how to use SCP for file transfer with EC2 instances.</p>
<h4>Connecting via SSH to an EC2 instance</h4>
<p>In control plane access mode, using <a id="_idIndexMarker2190"/>SSH <a id="_idIndexMarker2191"/>with our EC2 instance allows us to manage it like any on-premises machine on a network. The related SSH command is as follows:</p>
<pre class="console">
ssh -i SSH_KEY ec2-user@EC2_INSTANCE</pre> <p>Let’s break this down to understand it better:</p>
<ul>
<li><code>SSH_KEY</code> represents the private key file on our local system that we created and downloaded when launching our instance. See the <em class="italic">EC2 on-demand instances</em> section for more details.</li>
<li><code>ec2-user</code> is the default user assigned by EC2 to our AMI Linux instance. Different AMIs may have different usernames to connect with. You should check with the AMI vendor of your choice about the default username to use with SSH. For example, when using <code>ec2-user</code>, when using <code>ubuntu</code>, and when using <code>admin</code>.</li>
<li><code>EC2_INSTANCE</code> represents the public IP address or DNS name of our EC2 instance. You can find this in the EC2 dashboard for your instance:</li>
</ul>
<div><div><img alt="Figure 15.17 – The public IP address and DNS name of an EC2 instance" src="img/B19682_15_17.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.17 – The public IP address and DNS name of an EC2 instance</p>
<p>In our <a id="_idIndexMarker2192"/>case, the SSH command is as follows:</p>
<pre class="console">
ssh -i packt_aws_key.pem ubuntu@3.68.98.173</pre> <p>However, before <a id="_idIndexMarker2193"/>we connect, we need to set the right permissions for our <code>private key</code> file so that it’s not publicly viewable:</p>
<pre class="console">
chmod 400 packt_aws_key.pem</pre> <p>Failing to do this results in an unprotected key file error while attempting to connect.</p>
<p>A successful SSH connection to our EC2 instance yields the following output:</p>
<div><div><img alt="Figure 15.18 – Connecting with SSH to an EC2 instance" src="img/B19682_15_18.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.18 – Connecting with SSH to an EC2 instance</p>
<p>At this point, we <a id="_idIndexMarker2194"/>can interact with <a id="_idIndexMarker2195"/>our EC2 instance as if it were a standard machine.</p>
<p>Next, let’s look at how to transfer files from an EC2 instance.</p>
<h4>Using SCP for file transfer</h4>
<p>To transfer files to and from an EC2 instance in data plane access mode, we must use the <code>scp</code> utility. <code>scp</code> uses the <strong class="bold">Secure Copy Protocol</strong> (<strong class="bold">SCP</strong>) to securely transfer files between network hosts.</p>
<p>The following <a id="_idIndexMarker2196"/>command copies a local file (<code>README.md</code>) to our <a id="_idIndexMarker2197"/>remote EC2 instance (so it must be run from our machine, not the EC2 instance):</p>
<pre class="console">
scp -i packt_aws_key.pem README.md ubuntu@3.68.98.173:~/</pre> <p>The file <a id="_idIndexMarker2198"/>is copied to the <code>ubuntu</code> user’s home folder (<code>/home/ubuntu</code>) on the EC2 instance. The reverse operation of transferring the <code>README.md</code> file from the remote instance to our local directory is as follows:</p>
<pre class="console">
scp -i packt_aws_key.pem ubuntu@3.68.98.173:~/README.md .</pre> <p>Note that the <code>scp</code> command’s invocation is similar to <code>ssh</code>, where we specify the private key file (<code>aws/packt-ec2.pem</code>) via the <code>-i</code> (identity file) parameter.</p>
<p>Next, we’ll look at yet another critical aspect of managing and scaling EC2 instances – storage volumes.</p>
<h3>Using EC2 storage volumes</h3>
<p><strong class="bold">Storage volumes</strong> are device mounts within <a id="_idIndexMarker2199"/>an EC2 instance that provide additional disk capacity (at extra cost). You may <a id="_idIndexMarker2200"/>need additional storage for large file caches or extensive logging, for example, or you may choose to mount network-attached storage for critical data shared between your EC2 instances. You can think of EC2 storage volumes as <em class="italic">modular hard drives</em>. You mount or unmount them based on your needs.</p>
<p>Two types of storage volumes are provided by EC2:</p>
<ul>
<li><strong class="bold">Instance store</strong></li>
<li><strong class="bold">Elastic Block </strong><strong class="bold">Store</strong> (<strong class="bold">EBS</strong>)</li>
</ul>
<p>Knowing <a id="_idIndexMarker2201"/>how to use storage volumes allows you to make better <a id="_idIndexMarker2202"/>decisions when scaling your applications as they grow. Let’s look at instance store volumes first.</p>
<h4>Introducing instance store volumes</h4>
<p>Instance store volumes<a id="_idIndexMarker2203"/> are disks that are directly (physically) attached to your EC2 instance. Consequently, the maximum size and number of instance store volumes you can connect to your instance are limited by the instance type. For example, a storage-optimized <em class="italic">i3</em> instance can have up to 8 x 1.9 TB SSD disks attached, while a general-purpose <em class="italic">m5d</em> instance may only grow up to four drives of 900 GB each. See <a href="https://aws.amazon.com/ec2/instance-types/">https://aws.amazon.com/ec2/instance-types/</a> for more information on instance capacity.</p>
<p>An instance store volume comes at no additional cost if it’s the root volume – the volume with the operating system platform booting the instance.</p>
<p>Not all EC2 instance types support instance store volumes. For example, the general-purpose <em class="italic">t2</em> instance types only support EBS storage volumes. On the other hand, if you want to grow your storage beyond the maximum capacity allowed by the instance store, you’ll have to use EBS volumes. We’ll look at EBS volumes next.</p>
<h4>Introducing EBS volumes</h4>
<p>The data on instance store volumes only persists with your EC2 instance. If your instance stops or terminates, or there is a failure with it, all of your data is lost. To store and persist critical data with your EC2 instances, you’ll have to choose EBS.</p>
<p>EBS volumes <a id="_idIndexMarker2204"/>are flexible and high-performing network-attached storage devices that serve both the root volume system and additional volume mounts on your EC2 instance. An EBS root volume can only be attached to a single EC2 instance at a time while an EC2 instance can have multiple EBS volumes attached at any time. An EBS volume can also be attached to multiple EC2 instances at a time via <em class="italic">multi-attach</em>. For more information on<a id="_idIndexMarker2205"/> EBS multi-attach, see <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volumes-multi.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-volumes-multi.html</a>.</p>
<p>When you create an EBS volume, it will be automatically replicated within the AZ of your instance to minimize latency and data loss. With EBS, you get live monitoring of drive health and stats via Amazon CloudWatch free of charge. EBS also supports encrypted data storage to meet the latest regulatory standards for data encryption.</p>
<p>EC2 storage <a id="_idIndexMarker2206"/>volumes are backed by Amazon’s <strong class="bold">Simple Storage Service</strong> (<strong class="bold">S3</strong>) or <strong class="bold">Elastic File System</strong> (<strong class="bold">EFS</strong>) infrastructure. For more information <a id="_idIndexMarker2207"/>on the different EC2 storage types, please<a id="_idIndexMarker2208"/> visit <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Storage.html">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/Storage.html</a>.</p>
<p>Now, let’s create and configure an EBS storage volume and attach it to our EC2 instance.</p>
<h4>Configuring an EBS storage volume</h4>
<p>Here <a id="_idIndexMarker2209"/>are the steps we’ll follow, starting with creating the EBS volume:</p>
<ol>
<li>In the <strong class="bold">EC2</strong> dashboard, go to <strong class="bold">Volumes</strong> under <strong class="bold">Elastic Block Store</strong> in the left navigation pane, and click on the <strong class="bold">Create Volume</strong> button at the top:</li>
</ol>
<div><div><img alt="Figure 15.19 – Creating an EBS volume" src="img/B19682_15_19.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.19 – Creating an EBS volume</p>
<ol>
<li value="2">Enter the values of your choice for <strong class="bold">Volume Type</strong>, <strong class="bold">Size</strong>, and <strong class="bold">Availability Zone</strong>. Make sure you <a id="_idIndexMarker2210"/>choose the AZ where your EC2 instances are. You could also include a <strong class="bold">Snapshot ID</strong> value if you want to restore the volume from a previous EC2 instance backup (snapshot). We’ll look at backup/restore using EBS snapshots later in this chapter.</li>
<li>Press the <strong class="bold">Create Volume</strong> button when you’re done. You’ll get a <strong class="bold">Volume created successfully</strong> message that specifies your new EBS volume ID if all goes well.</li>
<li>Click on <strong class="bold">Volume ID</strong> or select the volume from the left navigation pane, under <strong class="bold">Elastic Block Store</strong> and <strong class="bold">Volumes</strong>. Click on the <strong class="bold">Actions</strong> button and choose <strong class="bold">Attach Volume</strong>:</li>
</ol>
<div><div><img alt="Figure 15.20 – Attaching the EBS volume to an EC2 instance" src="img/B19682_15_20.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.20 – Attaching the EBS volume to an EC2 instance</p>
<ol>
<li value="5">On the <a id="_idIndexMarker2211"/>next screen, enter your EC2 instance ID (or name tag to search for it) in the <strong class="bold">Instance</strong> field:</li>
</ol>
<div><div><img alt="Figure 15.21 – Entering the EC2 instance ID to attach the volume" src="img/B19682_15_21.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.21 – Entering the EC2 instance ID to attach the volume</p>
<ol>
<li value="6">Press the <strong class="bold">Attach volume</strong> button when you’re done. After a few moments, EC2 will initialize <a id="_idIndexMarker2212"/>your EBS volume, and <strong class="bold">State</strong> will change to <strong class="bold">in-use</strong>. The volume device is now ready, but we need to format it with a filesystem so that it can be used.</li>
<li>Let’s SSH into the EC2 instance where we attached the volume:<pre class="source-code">
<code>lsblk</code> command-line utility to list the block devices:<pre class="source-code">
<strong class="bold">lsblk</strong></pre><p class="list-inset">The output is as follows:</p></li> </ol>
<div><div><img alt="Figure 15.22 – The local volumes in our EC2 instance" src="img/B19682_15_22.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.22 – The local volumes in our EC2 instance</p>
<p class="list-inset">Looking at <a id="_idIndexMarker2213"/>the size of the volumes, we can immediately tell the one we just added – <code>xvdf</code> with <code>1G</code>. The other volume (<code>xvda</code>) is the original root volume of our <code>t3.micro</code> instance.</p>
<ol>
<li value="9">Now, let’s check if our new EBS volume (<code>xvdf</code>) has a filesystem on it:<pre class="source-code">
<code>/dev/xvdf: data</code>, meaning that the volume doesn’t have a filesystem yet.</p></li> <li>Let’s build a filesystem on our volume using the <code>mkfs</code> (<em class="italic">make filesystem</em>) command-line utility:<pre class="source-code">
<code>-t</code> (<code>--type</code>) parameter with an <code>xfs</code> filesystem type. <code>XFS</code> is a high-performance journaled filesystem that’s supported by most Linux distributions and is installed by default in some of them.</p></li> <li>If we check the filesystem using the following command, we should see the filesystem details displayed instead of empty data:<pre class="source-code">
<strong class="bold">sudo file -s /dev/xvdf</strong></pre><p class="list-inset">The output of all the commands used to check and create a new filesystem is shown in the following screenshot:</p></li> </ol>
<div><div><img alt="Figure 15.23 – Creating a new filesystem" src="img/B19682_15_23.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.23 – Creating a new filesystem</p>
<p class="list-inset">The volume drive is now formatted.</p>
<ol>
<li value="12">Now, let’s make <a id="_idIndexMarker2214"/>it accessible to our local filesystem. We’ll name our mount point <code>packt_drive</code> and create it in the root directory:<pre class="source-code">
<strong class="bold">sudo mkdir /packt_drive</strong>
<code>/packt</code> directory, we’re accessing the EBS volume:</p></li> </ol>
<div><div><img alt="Figure 15.24 – Accessing the EBS volume" src="img/B19682_15_24.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.24 – Accessing the EBS volume</p>
<p>Working with EBS volumes is similar to working with any volumes on Linux, so all the knowledge you’ve received from this chapter will be very useful when you’re working with Amazon EC2 instances. Now, let’s look at how to detach an EBS volume.</p>
<h4>Detaching an EBS volume</h4>
<p>Before detaching any EBS volume, you need to unmount it. In our case, as we are already in the <a id="_idIndexMarker2215"/>terminal and using the volume, we will type the following command to unmount the volume we use:</p>
<pre class="console">
sudo umount -d /dev/xvdf</pre> <p>Now that the volume has been unmounted, we can head to the EC2 dashboard and go to <strong class="bold">Volumes</strong>, select the corresponding <strong class="bold">in-use</strong> volume we want to detach, go to <strong class="bold">Actions</strong> in the top-right corner, and choose <strong class="bold">Detach Volume</strong>. Acknowledge the operation and wait for the volume to be detached.</p>
<p>We’re now at the final step of our backup-restore procedure – that is, attaching the new volume containing the snapshot to our EC2 instance.</p>
<p>We’ll conclude our exploration of the AWS EC2 console and related management operations here. For a comprehensive reference on EC2, please refer to the Amazon EC2 documentation at <a href="https://docs.aws.amazon.com/ec2">https://docs.aws.amazon.com/ec2</a>.</p>
<p>The EC2 management tasks we’ve presented so far exclusively used the AWS web console. If you’re looking to automate your EC2 workloads, you may want to adopt the AWS CLI, which we’ll check out next.</p>
<h2 id="_idParaDest-315"><a id="_idTextAnchor333"/>Working with the AWS CLI</h2>
<p>The AWS CLI is a unified tool for managing AWS resources. This tool was created so that we can manage <a id="_idIndexMarker2216"/>all the AWS services from a terminal session on our local machine. Compared to the AWS web console, which offers visual tools through the web browser, the AWS CLI (as its name states) offers all the functionalities inside your terminal program on your machine. The AWS CLI is available for all major operating systems, such as Linux, macOS, and Windows. In the next section, we will show you how to install it on your Linux local machine.</p>
<h3>Installing the AWS CLI</h3>
<p>To install the<a id="_idIndexMarker2217"/> AWS CLI, please visit <a href="https://aws.amazon.com/cli/">https://aws.amazon.com/cli/</a>. At the time of writing, the latest release of the <a id="_idIndexMarker2218"/>AWS CLI is version 2. For the examples in this chapter, we’ll be using a Debian machine to install the AWS CLI while following the instructions at <a href="https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html#cliv2-linux-install">https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html#cliv2-linux-install</a>. This resource link offers instructions for installing the AWS CLI on all major operating systems, not only Linux.</p>
<p>Follow these steps to install the AWS CLI on Linux:</p>
<ol>
<li>We’ll start by downloading the AWS CLI v2 package (<code>awscliv2.zip</code>):<pre class="source-code">
<strong class="bold">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</strong></pre></li> <li>Next, we’ll unzip and install the AWS CLI:<pre class="source-code">
<strong class="bold">unzip awscliv2.zip</strong>
<code>aws</code> command-line utility installed on our system. Let’s check the version:<pre class="source-code">
<code>help</code>:<pre class="source-code">
<strong class="bold">aws help</strong></pre></li> </ol>
<p>To manage your AWS EC2 resources using the <code>aws</code> utility, first, you need to configure your local environment to establish the required trust with the AWS endpoint. We’ll do that next.</p>
<h3>Configuring the AWS CLI</h3>
<p>To configure <a id="_idIndexMarker2220"/>the local AWS environment on your local machine, you will have to set up your AWS access key. If you already have it, you can skip this part:</p>
<ol>
<li>The AWS CLI configuration asks for your <strong class="bold">AWS Access Key ID</strong> and <strong class="bold">AWS Secret Access Key</strong> values. You can generate or retrieve these keys by logging into your AWS account.</li>
<li>Select the dropdown next to your account name in the top-right corner of the AWS web console and choose <strong class="bold">Security Credentials</strong>. If you haven’t generated your access key yet, go to the <strong class="bold">Access keys</strong> tab and click on the <strong class="bold">Create access key</strong> button. You’ll have to store your AWS key ID and secret in a safe place for later reuse.</li>
<li>Now that you have those keys, you can proceed to setting up AWS on your local machine. To configure the AWS environment, run the following command:<pre class="source-code">
<strong class="bold">aws configure</strong></pre><p class="list-inset">The preceding command will prompt you for a few pieces of information, as suggested by the following output:</p></li> </ol>
<div><div><img alt="Figure 15.25 – Configuring the local AWS CLI environment" src="img/B19682_15_25.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.25 – Configuring the local AWS CLI environment</p>
<ol>
<li value="4">In the AWS CLI <a id="_idIndexMarker2221"/>configuration wizard, set <code>eu-central-1</code> (Frankfurt, in our case). You may want to enter the region of your choice or leave it as the default (<code>None</code>). If you don’t have a default Region specified, you’ll have to enter it every time you invoke the <code>aws</code> command.</li>
</ol>
<p>At this point, we’re ready to use the AWS CLI. Let’s start by listing our EC2 instances.</p>
<h3>Querying EC2 instances</h3>
<p>The following <a id="_idIndexMarker2222"/>command provides detailed information about EC2 instances:</p>
<pre class="console">
aws ec2 describe-instances</pre> <p>The preceding command provides sizeable JSON output (too long to present in a screenshot), with the details of all the EC2 instances we own in our default Region (<code>eu-central-1</code>). Alternatively, we can specify the Region with the <code>--</code><code>region</code> parameter:</p>
<pre class="console">
aws ec2 describe-instances --region eu-central-1</pre> <p>We can get more creative and list only the EC2 instances matching a specific key-value tag, such as <code>env: packt</code>, that we previously tagged our instances with, using the <code>--</code><code>filters</code> parameter:</p>
<pre class="console">
aws ec2 describe-instances \
  --filters "Name=tag-key,Values=env" \
  --filters "Name=tag-value,Values=packt"</pre> <p>The first <code>--filters</code> parameter specifies the key (<code>tag-key=env</code>), while the second points to the value (<code>tag-value=packt</code>).</p>
<p>Combining the <code>aws</code> and <code>jq</code> (<em class="italic">JSON query</em>) commands, we can extract the JSON fields we want. For example, the following <a id="_idIndexMarker2223"/>command lists the <code>InstanceId</code>, <code>ImageId</code>, and <code>BlockDeviceMappings</code> fields of the EC2 instances tagged with <code>env:packt</code>:</p>
<pre class="console">
aws ec2 describe-instances \
  --filters "Name=tag-key,Values=env" \
  --filters "Name=tag-value,Values=packt" | \
  jq '.Reservations[].Instances[] | { InstanceId, ImageId, BlockDeviceMappings }'</pre> <p>If the <code>jq</code> utility is not present on your Linux machine, install it with the following command:</p>
<pre class="console">
sudo apt install -y jq # on Ubuntu/Debian</pre> <p>The output of the preceding <code>aws</code> command is as follows:</p>
<div><div><img alt="Figure 15.26 – Querying EC2 instances" src="img/B19682_15_26.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.26 – Querying EC2 instances</p>
<p>Note the <code>DeviceName</code> properties in the output JSON, which reflect only one block device (this is <code>/dev/sdf</code> since we deleted the EBS volume we attached earlier).</p>
<p>We can filter <a id="_idIndexMarker2224"/>the output of the <code>aws ec2 describe-instances</code> command by any property. For example, the following command filters our EC2 instances by the <code>image-id</code> AMI:</p>
<pre class="console">
aws ec2 describe-instances \
  --filters "Name=<code>image-id</code> versus <code>ImageId</code>. You have to keep this rule in mind when you write your filter queries.</p>
<p>Next, let’s plan to launch a new EC2 instance of the same AMI type with our current machine and the same security group.</p>
<h3>Creating an EC2 instance</h3>
<p>Let’s look at how we can create a new EC2 instance. To do this, we will need some prior information regarding the existing security group inside which we would like to create the new instance. The following<a id="_idIndexMarker2225"/> command retrieves the security groups of the current instance (<code>i-0f8fe6aced634e71c</code>):</p>
<pre class="console">
aws ec2 describe-instances \
  --filters "Name=<strong class="bold">instance-id</strong>,Values=<strong class="bold">i-0f8fe6aced634e71c</strong>" \
  --query "Reservations[].Instances[].SecurityGroups[]"</pre> <p>The output is as follows:</p>
<div><div><img alt="Figure 15.27 – Retrieving the security groups of an EC2 instance" src="img/B19682_15_27.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.27 – Retrieving the security groups of an EC2 instance</p>
<p>To retrieve<a id="_idIndexMarker2226"/> <code>GroupId</code> directly, we could run the following:</p>
<pre class="console">
aws ec2 describe-instances \
  --filters "Name=<strong class="bold">instance-id</strong>,Values=<strong class="bold">i-0f8fe6aced634e71c</strong>" \
  --query "Reservations[].Instances[].SecurityGroups[].GroupId"</pre> <p>In this case, the output would only show <code>GroupId</code>. Here, we used the <code>--query</code> parameter to specify the exact JSON path for the field we’re looking for (<code>GroupId</code>):</p>
<pre class="console">
Reservations[].Instances[].SecurityGroups[].GroupId</pre> <p>The use of the <code>--query</code> parameter somewhat resembles piping the output to the <code>jq</code> command, but it’s less versatile.</p>
<p>We also need the AMI ID. To obtain this, navigate to your AWS EC2 console and then, from the left-hand side pane, go to <code>ami-0faab6bdbac9486fb</code>.</p>
<p>To launch a new instance with the AMI type of our choice and the security group ID, we must use the <code>aws ec2 </code><code>run-instances</code> command:</p>
<pre class="console">
aws ec2 run-instances --image-id ami-0faab6bdbac9486fb --count 1 --instance-type t3.micro --key-name packt_aws_key --security-group-ids sg-0aa7c8ef75503a9aa –placement AvailabilityZone=eu-central-1b</pre> <p>Here’s a brief explanation of the parameters:</p>
<ul>
<li><code>image-id</code>: The AMI image ID (<code>ami-0faab6bdbac9486fb</code>); we’re using the same AMI type (<em class="italic">Ubuntu Linux</em>) as with the previous instance we created in the AWS EC2 web console</li>
<li><code>count</code>: The number of instances to launch (<code>1</code>)</li>
<li><code>instance-type</code>: The EC2 instance type (<code>t3.micro</code>)</li>
<li><code>key-name</code>: The name of the SSH private key file (<code>packt_aws_key</code>) to use when connecting to our new instance; we’re reusing the SSH key file we created with our first EC2 instance in the AWS web console</li>
<li><code>security-group-ids</code>: The security groups attached to our instance; we’re reusing the security group attached to our current instance (<code>sg-0aa7c8ef75503a9aa</code>)</li>
<li><code>--placement</code>: The AZ to place our instance in (<code>AvailabilityZone=eu-central-1b</code>)</li>
</ul>
<p>The command <a id="_idIndexMarker2227"/>should run successfully and you will see the new EC2 instance running in your console. Here’s a screenshot of our EC2 console and the two instances running:</p>
<div><div><img alt="Figure 15.28 – The new EC2 instance shown in the console" src="img/B19682_15_28.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.28 – The new EC2 instance shown in the console</p>
<p>As you can see, our newly created EC2 instance has no name. Let’s add a name and some tags to it using the command line.</p>
<h3>Naming and tagging an EC2 instance</h3>
<p>The<a id="_idIndexMarker2228"/> following <a id="_idIndexMarker2229"/>command names our new instance as <code>aws_packt_testing_2</code>:</p>
<pre class="console">
aws ec2 create-tags --resources i-091e2f515d15c3b0b --tags Key=Name,Value=aws_packt_testing_2</pre> <p>Now, we can add a tag to the new instance. Adding a name and a tag can be done in a single command, but for a better understanding, we’ve decided to use two different commands. Here’s how to add a tag:</p>
<pre class="console">
aws ec2 create-tags \
  --resources <strong class="bold">i-0e1692c9dfdf07a8d</strong> \
  --tags Key=<strong class="bold">env</strong>,Value=<strong class="bold">packt</strong></pre> <p>Now, let’s query the instance with the following command:</p>
<pre class="console">
aws ec2 describe-instances \
  --filters "Name=tag-key,Values=env" \
  --filters "Name=tag-value,Values=packt" \
  --query "Reservations[].Instances[].InstanceId"</pre> <p>The output <a id="_idIndexMarker2230"/>shows that our two EC2 instances have the same tag (<code>packt</code>):</p>
<div><div><img alt="Figure 15.29 – Querying EC2 instance IDs by tag" src="img/B19682_15_29.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.29 – Querying EC2 instance IDs by tag</p>
<p>If you check <a id="_idIndexMarker2231"/>the EC2 console inside your browser, you will see the two instances. Now, the second instance has its new name shown (<code>aws_packt_testing_2</code>) and the <strong class="bold">Instance ID</strong> value for each one:</p>
<div><div><img alt="Figure 15.30 – Showing all instances in the EC2 console" src="img/B19682_15_30.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.30 – Showing all instances in the EC2 console</p>
<p>Next, we’ll show you how to terminate an EC2 instance from the command line.</p>
<h3>Terminating an EC2 instance</h3>
<p>To terminate an <a id="_idIndexMarker2232"/>EC2 instance, we can use the <code>aws ec2 terminate-instance</code> command. Note that terminating an instance results in the instance being deleted. We cannot restart a terminated instance. We could use the <code>aws ec2 stop-instances</code> command to stop our instance until later use.</p>
<p>The following command will terminate the instance with the ID of <code>i-091e2f515d15c3b0b</code>:</p>
<pre class="console">
aws ec2 terminate-instances --instance-ids <code>shutting-down</code> (from a previously <code>running </code>state):</p>
<div><div><img alt="Figure 15.31 – Terminating an instance" src="img/B19682_15_31.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.31 – Terminating an instance</p>
<p>The instance will eventually transition to the <code>terminated</code> state and will no longer be visible in the AWS EC2 console. The AWS CLI will still list it among the instances until EC2 finally disposes of it. According to AWS, terminated instances can still be visible up to an hour after termination. It’s always a good practice to discard the instances in the <code>terminated</code> or <code>shutting-down</code> state when performing queries and management operations via the AWS CLI. The following screenshot of the EC2 console shows that the second EC2 instance is in a <code>terminated</code> state:</p>
<div><div><img alt="Figure 15.32 – Showing the terminated instance in the EC2 console" src="img/B19682_15_32.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.32 – Showing the terminated instance in the EC2 console</p>
<p>This is where we’ll wrap up our journey regarding AWS EC2. Note that we’ve only scratched the surface of cloud management workloads in AWS.</p>
<p>The topics <a id="_idIndexMarker2233"/>that were covered in this section provide a basic understanding of AWS EC2 cloud resources and help system administrators make better decisions when managing the related workloads. Power users may find the AWS CLI examples a good starting point for automating their cloud management workflows in EC2.</p>
<p>Now, let’s turn our focus to our next public cloud services contender, Microsoft Azure.</p>
<h1 id="_idParaDest-316"><a id="_idTextAnchor334"/>Working with Microsoft Azure</h1>
<p><strong class="bold">Microsoft Azure</strong>, also <a id="_idIndexMarker2234"/>known as <strong class="bold">Azure</strong>, is a public cloud service by Microsoft for building and deploying application services in the cloud. Azure provides a full offering of a highly <a id="_idIndexMarker2235"/>scalable <strong class="bold">Infrastructure-as-a-Service</strong> (<strong class="bold">IaaS</strong>) at relatively low costs, accommodating a wide range of users and business requirements, from small teams to large commercial enterprises, including financial, health, and governmental institutions.</p>
<p>In this section, we’ll explore some very basic deployment workflows using Azure, such as the following:</p>
<ul>
<li>Creating a Linux virtual machine</li>
<li>Managing virtual machine sizes</li>
<li>Adding additional storage to a virtual machine</li>
<li>Working with the Azure CLI</li>
</ul>
<p>Once you’ve created your free Azure account, go to <a href="https://portal.azure.com">https://portal.azure.com</a> to access the Azure portal. You may want to enable the docked view of the portal navigation menu on the left for quick and easy access to your resources. Throughout this chapter, we’ll use <a id="_idIndexMarker2236"/>the docked view for our screen captures. Go to the <strong class="bold">Portal settings</strong> cog in the top-right corner and choose <strong class="bold">Docked</strong> for the default mode of the portal menu.</p>
<p>Now, let’s create our first resource in Azure – an Ubuntu virtual machine.</p>
<h2 id="_idParaDest-317"><a id="_idTextAnchor335"/>Creating and deploying a virtual machine</h2>
<p>We’ll follow a <a id="_idIndexMarker2237"/>step-by-step procedure, guided <a id="_idIndexMarker2238"/>by the resource wizard in the Azure portal. Let’s start with the first step, which is creating a compute resource for the virtual machine.</p>
<ol>
<li><strong class="bold">Creating a compute resource</strong>: Start by clicking on the <strong class="bold">Create a resource</strong> option in the left navigation menu or under <strong class="bold">Azure services</strong> in the main window. This will take us to the Azure Marketplace. Here, we can search for our resource of choice. You can either search for a relevant keyword or narrow down your selection based on the resource type you’re looking for. Let’s narrow down our selection by choosing <strong class="bold">Compute</strong>, then selecting <strong class="bold">Ubuntu Server 22.04 LTS</strong> from the available <strong class="bold">Popular Marketplace products</strong> options. You may click on <strong class="bold">Learn more</strong> for a detailed description of the image or click <strong class="bold">Create</strong>.<p class="list-inset">When we select <strong class="bold">Ubuntu Server 22.04 LTS</strong>, we’ll be guided through the process of configuring and creating our new virtual machine. The setup page looks like this:</p></li>
</ol>
<div><div><img alt="Figure 15.33 – Creating a virtual machine in Azure" src="img/B19682_15_33.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.33 – Creating a virtual machine in Azure</p>
<p class="list-inset">In the <strong class="bold">Basics</strong> tab, information such as the subscription type, resource group, region, image, and <a id="_idIndexMarker2239"/>architecture is provided. The other <a id="_idIndexMarker2240"/>tabs include <strong class="bold">Disks</strong>, <strong class="bold">Networking</strong>, <strong class="bold">Management</strong>, <strong class="bold">Monitoring</strong>, <strong class="bold">Advanced</strong>, and <strong class="bold">Tags</strong>.</p>
<ol>
<li value="2"><code>packt-demo</code>. If we <a id="_idIndexMarker2241"/>had a previously created resource group, we could specify it here.</li>
<li><code>packt-ubuntu-demo</code> and place it in the <code>(Europe) France Central</code> Region, the closest to the geographical location where our instance will operate. The size of our machine will directly impact the associated costs. The following screenshot shows the details that have been specified so far regarding the <strong class="bold">Resource group</strong> set up, <strong class="bold">Virtual machine name</strong>, <strong class="bold">Region</strong>, <strong class="bold">Availability options</strong>, <strong class="bold">Security type</strong>, <strong class="bold">Image</strong>, <strong class="bold">VM architecture</strong>, and <strong class="bold">Size</strong>:</li>
</ol>
<div><div><img alt="Figure 15.34 – Setting up the Azure virtual machine" src="img/B19682_15_34.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.34 – Setting up the Azure virtual machine</p>
<p class="list-inset">Alternatively, we <a id="_idIndexMarker2243"/>could browse different options for <strong class="bold">Image</strong> and <strong class="bold">Size</strong> by choosing <strong class="bold">See all images</strong> or <strong class="bold">See all sizes</strong>, respectively. Azure <a id="_idIndexMarker2244"/>also provides a <em class="italic">pricing calculator</em> online tool for various resources at <a href="https://azure.microsoft.com/en-us/pricing/calculator/">https://azure.microsoft.com/en-us/pricing/calculator/</a>.</p>
<ol>
<li value="4"><code>packt</code> and <code>packt-ubuntu-demo_key</code>. Next, we must set <strong class="bold">Inbound port rules</strong> for our instance to allow <a id="_idIndexMarker2245"/>SSH access. If, for example, our machine will <a id="_idIndexMarker2246"/>run a web server application, we can also enable HTTP and HTTPS access:</li>
</ol>
<div><div><img alt="Figure 15.35 – Enabling SSH authentication and access to the virtual machine" src="img/B19682_15_35.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.35 – Enabling SSH authentication and access to the virtual machine</p>
<p class="list-inset">At this <a id="_idIndexMarker2247"/>point, we are ready to create our virtual machine. The <a id="_idIndexMarker2248"/>wizard can take us further to the additional steps of specifying the <em class="italic">disks</em> and <em class="italic">networking</em> configuration associated with our instance. For now, we’ll leave them as-is.</p>
<ol>
<li value="5"><strong class="bold">Validating and deploying the virtual machine</strong>: We can click the <strong class="bold">Review + create</strong> button to initiate the validation process. Next, the deployment wizard will validate our virtual machine configuration. In a few moments, if everything goes well, we’ll get a <strong class="bold">Validation passed</strong> message specifying the product details and our instance’s hourly rate. By clicking <strong class="bold">Create</strong>, we agree to the relevant terms of use, and our virtual machine will be deployed shortly:</li>
</ol>
<div><div><img alt="Figure 15.36 – Creating the virtual machine" src="img/B19682_15_36.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.36 – Creating the virtual machine</p>
<p class="list-inset">In the <a id="_idIndexMarker2249"/>process, we’ll be prompted to download the SSH <a id="_idIndexMarker2250"/>private key for accessing our instance:</p>
<div><div><img alt="Figure 15.37 – Downloading the SSH private key for accessing the virtual machine" src="img/B19682_15_37.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.37 – Downloading the SSH private key for accessing the virtual machine</p>
<ol>
<li value="6"><strong class="bold">Deployment completion</strong>: If the deployment completes <a id="_idIndexMarker2251"/>successfully, we’ll get a brief <a id="_idIndexMarker2252"/>pop-up message stating <strong class="bold">Deployment succeeded</strong> and a <strong class="bold">Go to resource</strong> button that will take us to our new virtual machine:</li>
</ol>
<div><div><img alt="Figure 15.38 – Successfully deploying a virtual machine" src="img/B19682_15_38.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.38 – Successfully deploying a virtual machine</p>
<p class="list-inset">We’ll also get a brief report about the deployment details if we click on the relevant drop-down button:</p>
<div><div><img alt="Figure 15.39 – Deployment details" src="img/B19682_15_39.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.39 – Deployment details</p>
<p>Let’s take <a id="_idIndexMarker2253"/>a quick look at each of the resources that were created with our virtual machine<a id="_idIndexMarker2254"/> deployment:</p>
<ul>
<li><code>packt-ubuntu-demo</code>: The virtual machine host</li>
<li><code>packt-ubuntu-demo348</code>: The network interface (or network interface card) of the virtual machine</li>
<li><code>packt-ubuntu-demo-ip</code>: The IP address of the virtual machine</li>
<li><code>packt-ubuntu-demo-vnet</code>: The virtual network associated with the resource group (<code>packt-demo</code>)</li>
<li><code>packt-ubuntu-demo-nsg</code>: The <strong class="bold">Network Security Group</strong> (<strong class="bold">NSG</strong>) controlling inbound and outbound <a id="_idIndexMarker2255"/>access to and from our instance</li>
</ul>
<p>Azure will create a new set of the resource types mentioned previously with every virtual machine, except the virtual network corresponding to the resource group, when the instance is placed in an existing resource group. Don’t forget that we also created a new resource group (<code>packt-demo</code>), which is not shown in the deployment report.</p>
<p>Let’s try <a id="_idIndexMarker2256"/>to connect to our newly created instance (<code>packt-ubuntu-demo</code>). Go to <code>packt-ubuntu-demo</code>). In the <code>20.19.173.232</code>).</p>
<p>Now that we’ve deployed our virtual machine, we want to make sure we can access it via SSH. We’ll do that next.</p>
<h2 id="_idParaDest-318"><a id="_idTextAnchor336"/>Connecting with SSH to a virtual machine</h2>
<p>Before <a id="_idIndexMarker2258"/>we connect to our virtual machine <a id="_idIndexMarker2259"/>via SSH, we need to set the permissions to our SSH private key file so that it’s not publicly viewable:</p>
<pre class="console">
chmod 400 packt-ubuntu-demo_key.pem</pre> <p>Next, we must connect to our Azure Ubuntu instance with the following command:</p>
<pre class="console">
ssh -i packt-rhel.pem packt@20.19.173.232</pre> <p>We must use the SSH key (<code>packt-ubuntu-demo_key.pem</code>) and administrator account (<code>packt</code>) that were specified when we created the instance. Alternatively, you can click on the <strong class="bold">Connect</strong> button in the virtual machine’s <strong class="bold">Overview</strong> tab and then click <strong class="bold">SSH</strong>. This action will bring up a view where you can see the preceding commands and copy and paste them into your terminal.</p>
<p>A successful <a id="_idIndexMarker2260"/>connection to our <a id="_idIndexMarker2261"/>Ubuntu instance should yield the following output:</p>
<div><div><img alt="Figure 15.40 – Connecting to the Azure virtual machine" src="img/B19682_15_40.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.40 – Connecting to the Azure virtual machine</p>
<p>Now that we’ve created our first virtual machine in Azure, let’s look at some of the most common management operations that are performed during a virtual machine’s lifetime.</p>
<h2 id="_idParaDest-319"><a id="_idTextAnchor337"/>Managing virtual machines</h2>
<p>As our applications<a id="_idIndexMarker2262"/> evolve, so does the computing power and capacity required by the virtual machines hosting the applications. As system administrators, we should know how cloud resources are being utilized. Azure provides the necessary tools for monitoring the health and performance of virtual machines. These tools are available on the <strong class="bold">Monitoring</strong> tab of the virtual machine’s management page.</p>
<p>A small virtual machine with a relatively low number of virtual CPUs and reduced memory may negatively impact application performance. On the other hand, an oversized instance would yield unnecessary costs. Resizing a virtual machine is a common operation in Azure. Let’s see how we can do it.</p>
<h3>Changing the size of a virtual machine</h3>
<p>Azure makes it<a id="_idIndexMarker2263"/> relatively easy to resize virtual machines. In the portal, go to <strong class="bold">Virtual Machines</strong>, select your instance, and click <strong class="bold">Size</strong> under <strong class="bold">Availability + </strong><strong class="bold">Scale</strong>:</p>
<div><div><img alt="Figure 15.41 – Changing the size of a virtual machine" src="img/B19682_15_41.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.41 – Changing the size of a virtual machine</p>
<p>Our virtual machine (<code>packt-ubuntu-demo</code>) is of <em class="italic">B1s</em> size (1 vCPUs, 1 GB RAM). We can choose to size it up or down. For demo purposes, we could resize to the lower <em class="italic">B1ls </em>capacity (1 vCPU, 0.5 GB RAM). We could select the <strong class="bold">B1ls</strong> (1 vCPU, 0.5 GB RAM) option and click the <strong class="bold">Resize</strong> button. Lowering the size of our instance will also result in cost savings. Azure will stop and restart our virtual machine while resizing. It’s always good to stop the machine before changing the size to avoid possible data inconsistencies within the instance.</p>
<p>One of the remarkable features of virtualized workloads in Azure is the ability to scale – including <a id="_idIndexMarker2264"/>the storage capacity – by adding additional data disks to virtual machines. We can add existing data disks or create new ones.</p>
<p>Let’s look at how to add a secondary data disk to our virtual machine.</p>
<h3>Adding additional storage</h3>
<p>Azure can <a id="_idIndexMarker2265"/>add disks to our instance on the fly, without stopping the machine. We can add two types of disks to a virtual machine: <strong class="bold">data disks</strong> and <strong class="bold">managed disks</strong>. In this chapter, we will only provide information on how to add data disks. For more information on disk types on Azure, please visit <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types">https://docs.microsoft.com/en-us/azure/virtual-machines/disks-types</a>.</p>
<p>Let’s learn how to add a data disk:</p>
<ol>
<li>Navigate<a id="_idIndexMarker2266"/> to <strong class="bold">Virtual machines</strong> in the left navigation menu and select your instance, click <strong class="bold">Disks</strong> under <strong class="bold">Settings</strong>, and then click on <strong class="bold">Create and attach a </strong><strong class="bold">new disk</strong>.</li>
<li>In the<a id="_idIndexMarker2267"/> disk properties, leave the <code>packt-disk</code>), <strong class="bold">Storage Type</strong>, and <strong class="bold">Size</strong> (such as <strong class="bold">4 GB</strong>) values. Click <strong class="bold">Apply</strong> when you’re done:</li>
</ol>
<div><div><img alt="Figure 15.42 – Adding a new data disk" src="img/B19682_15_42.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.42 – Adding a new data disk</p>
<p class="list-inset">At this <a id="_idIndexMarker2268"/>point, the new disk is attached to our virtual machine, but the disk hasn’t been initialized with a filesystem yet.</p>
<ol>
<li value="3">Connect to our virtual machine via SSH:<pre class="source-code">
<strong class="bold">ssh -i packt-rhel.pem packt@20.19.173.232</strong></pre></li> <li>List the current block devices:<pre class="source-code">
<code>sdc</code>:</li>
</ol>
<div><div><img alt="Figure 15.43 – Identifying the block device for the new data disk" src="img/B19682_15_43.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.43 – Identifying the block device for the new data disk</p>
<ol>
<li value="6">Verify that the block device is empty:<pre class="source-code">
<code>/dev/sdc: data</code>, meaning that the data disk doesn’t contain a filesystem yet.</p></li> <li>Next, initialize <a id="_idIndexMarker2269"/>the volume with an XFS filesystem:<pre class="source-code">
<code>/packt</code>) and mount the new volume:<pre class="source-code">
<strong class="bold">sudo mkdir /packt</strong>
<strong class="bold">sudo mount /dev/sdc /packt</strong></pre></li> </ol>
<p>Now, we can use the new data disk for regular file storage.</p>
<p>Note that data disks will only be persisted during the lifetime of the virtual machine. When the virtual machine is paused, stopped, or terminated, the data disk becomes unavailable. When the machine is terminated, the data disk is permanently lost. For persistent storage, we need to use <em class="italic">managed disks</em>, similar in behavior to network-attached storage. See the link at the beginning of this section for more details.</p>
<p>So far, we have performed all these management operations in the Azure portal. But what if you want to automate your workloads in the cloud using scripting? This can be done using Azure CLI.</p>
<h2 id="_idParaDest-320"><a id="_idTextAnchor338"/>Working with the Azure CLI</h2>
<p>Azure CLI is a specialized command-line interface for managing your resources in the cloud. First, let’s install<a id="_idIndexMarker2270"/> the Azure CLI on our platform of choice. Follow the instructions at <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">https://docs.microsoft.com/en-us/cli/azure/install-azure-cli</a>. We’ll choose the <a id="_idIndexMarker2271"/>Azure CLI for Linux and, for demo purposes, install it on a Debian machine. The related instructions can be found at <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-linux">https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-linux</a>. From the multiple installation options available, we’ll use the following command:</p>
<pre class="console">
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash</pre> <p>After the installation is complete, we can invoke the Azure CLI with the <code>az</code> command:</p>
<pre class="console">
az help</pre> <p>The preceding command displays detailed help information about using the <code>az</code> utility. However, before performing any management operations, we need to authenticate the CLI with our Azure credentials. The following command will set up the local Azure CLI environment accordingly:</p>
<pre class="console">
az login</pre> <p>We’ll be prompted with a message containing an authentication code and the URL (<a href="https://microsoft.com/devicelogin">https://microsoft.com/devicelogin</a>) to visit and enter the code:</p>
<div><div><img alt="Figure 15.44 – Initializing the Azure CLI environment" src="img/B19682_15_44.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.44 – Initializing the Azure CLI environment</p>
<p>At this point, we are ready to use the Azure CLI for management operations. Let’s create a new resource group called <code>packt-dev</code> in the <code>West </code><code>US</code> Region:</p>
<pre class="console">
az group create --name packt-dev --location francecentral</pre> <p>The preceding command<a id="_idIndexMarker2272"/> yields the following output upon successfully creating the resource group:</p>
<div><div><img alt="Figure 15.45 – Creating a new resource group" src="img/B19682_15_45.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.45 – Creating a new resource group</p>
<p>Next, we must launch an Ubuntu virtual machine named <code>packt-ubuntu-dev</code> in the Region we just created:</p>
<pre class="console">
az vm create --resource-group packt-dev --name packt-ubuntu-dev --image Ubuntu2204 --admin-username packt --generate-ssh-keys</pre> <p>Let’s quickly go through each of the preceding command-line options:</p>
<ul>
<li><code>resource-group</code>: The name of the resource group (<code>packt-dev</code>) where we create our virtual machine</li>
<li><code>name</code>: The name of the virtual machine (<code>packt-ubuntu-dev</code>)</li>
<li><code>image</code>: The Linux distribution to use (<code>Ubuntu2204</code>)</li>
<li><code>admin-username</code>: The username of the machine’s administrator account (<code>packt</code>)</li>
<li><code>generate-ssh-keys</code>: This generates a new SSH key pair to access our virtual machine</li>
</ul>
<p>The preceding code produces the following output:</p>
<div><div><img alt="Figure 15.46 – Creating a new virtual machine" src="img/B19682_15_46.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.46 – Creating a new virtual machine</p>
<p>As the output <a id="_idIndexMarker2273"/>suggests, the SSH key files have been automatically generated and placed in the local machine’s <code>~/.ssh</code> directory to allow SSH access to the newly created virtual machine. The JSON output also provides the public IP address of the machine:</p>
<pre class="console">
"publicIpAddress": "51.103.100.132"</pre> <p>The following command lists all virtual machines:</p>
<pre class="console">
az vm list</pre> <p>You can also check the Azure portal in your browser to see all your virtual machines, including the newly created one:</p>
<div><div><img alt="Figure 15.47 – Viewing the virtual machines in the Azure portal" src="img/B19682_15_47.jpg"/>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 15.47 – Viewing the virtual machines in the Azure portal</p>
<p>To get information about a specific virtual machine (<code>packt-ubuntu-dev</code>), run the following command:</p>
<pre class="console">
az vm show \
  --resource-group <strong class="bold">packt-dev</strong> \
  --name <code>packt-ubuntu-dev</code>), run the following command:</p>
<pre class="console">
az vm redeploy \
  --resource-group <strong class="bold">packt-dev</strong> \
  --name <code>packt-ubuntu-dev</code>):</p>
<pre class="console">
az vm delete \
  --resource-group <strong class="bold">packt-dev</strong> \
  --name <code>az vm</code>), we also need to specify the resource group the machine belongs to.</p>
<p>A <a id="_idIndexMarker2275"/>comprehensive study of the Azure CLI is beyond the scope of this chapter. For detailed information, please visit the Azure CLI’s online documentation portal: <a href="https://docs.microsoft.com/en-us/cli/azure/">https://docs.microsoft.com/en-us/cli/azure/</a>.</p>
<p>This concludes our coverage of public cloud deployments with AWS and Azure. We have covered a vast domain and have merely skimmed the surface of cloud management workloads. We encourage you to build upon this preliminary knowledge and explore more, starting with the AWS and Azure cloud docs. The relevant links are mentioned in the <em class="italic">Further reading</em> section, together with other valuable resources.</p>
<p>Now, let’s summarize what you have learned so far about AWS and Azure.</p>
<h1 id="_idParaDest-321"><a id="_idTextAnchor339"/>Summary</h1>
<p>AWS and Azure provide a roughly similar set of features for flexible compute capacity, storage, and networking, with pay-as-you-go pricing. They share the essential elements of a public cloud – elasticity, autoscaling, provisioning with self-service, security, and identity and access management. This chapter explored both cloud providers strictly from a practical vantage point, focusing on typical deployment and management aspects of everyday cloud administration tasks.</p>
<p>We covered topics such as launching and terminating a new instance or virtual machine. We also looked at resizing an instance to accommodate a higher or lower compute capacity and scaling the storage by creating and attaching additional block devices (volumes). Finally, we used CLI tools for scripting various cloud management workloads.</p>
<p>When working with AWS, we learned a few basic concepts about EC2 resources. Next, we looked at typical cloud management tasks, such as launching and managing instances, adding and configuring additional storage, and using EBS snapshots for disaster recovery. Finally, we explored the AWS CLI with hands-on examples of standard operations, including querying and launching EC2 instances, creating and adding additional storage to an instance, and terminating an instance.</p>
<p>At this point, you should be familiar with the AWS and Azure web administration consoles and CLI tools. You have learned the basics of some typical cloud management tasks and a few essential concepts about provisioning cloud resources. Overall, you’ve enabled a special skillset of modern-day Linux administrators by engaging in cloud-native administration workflows. Combined with the knowledge you’ve built so far, you are assembling a valuable Linux administration toolbelt for on-premises, public, and hybrid cloud systems management.</p>
<p>In the next chapter, we’ll take this further and introduce you to managing application deployments using containerized workflows and services with Kubernetes.</p>
<h1 id="_idParaDest-322"><a id="_idTextAnchor340"/>Questions</h1>
<p>Let’s recap some of the concepts you’ve learned about in this chapter as a quiz:</p>
<ol>
<li>What is an AZ?</li>
<li>Between a <code>t3.small</code> and a <code>t3.micro</code> AWS EC2 instance type, which one yields better performance?</li>
<li>You have launched an AWS EC2 instance in the <code>us-west-1a</code> AZ and plan to attach an EBS volume created in <code>us-west-1b</code>. Would this work?</li>
<li>What is the SSH command to connect to your AWS EC2 instance or Azure virtual machine?</li>
<li>What is the Azure CLI command for listing your virtual machines? How about the equivalent AWS CLI command?</li>
<li>What is the AWS CLI command for launching a new EC2 instance?</li>
<li>What is the Azure CLI command for deleting a virtual machine?</li>
</ol>
<h1 id="_idParaDest-323"><a id="_idTextAnchor341"/>Further reading</h1>
<p>Here are a few resources to further explore AWS and Azure cloud topics:</p>
<ul>
<li>AWS EC2: <a href="https://docs.aws.amazon.com/ec2/index.html">https://docs.aws.amazon.com/ec2/index.html</a></li>
<li>Azure: <a href="https://docs.microsoft.com/en-us/azure">https://docs.microsoft.com/en-us/azure</a></li>
<li><em class="italic">AWS for System Administrators</em>, by Prashant Lakhera, Packt Publishing</li>
<li><em class="italic">Learning AWS – Second Edition</em>, by Aurobindo Sarkar and Amit Shah, Packt Publishing</li>
<li><em class="italic">Learning Microsoft Azure</em>, by Geoff Webber-Cross, Packt Publishing</li>
<li><em class="italic">Learning Microsoft Azure: A Hands-On Training [Video]</em>, by Vijay Saini, Packt Publishing</li>
</ul>
</div>
</body></html>