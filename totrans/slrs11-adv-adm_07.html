<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;7.&#xA0;Configuring and Administering RBAC and Least Privileges"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07" class="calibre1"/>Chapter 7. Configuring and Administering RBAC and Least Privileges</h1></div></div></div><p class="calibre7">In this chapter, we will cover the following topics:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Configuring and using RBAC</li><li class="listitem">Playing with least privileges</li></ul></div></div>

<div class="book" title="Chapter&#xA0;7.&#xA0;Configuring and Administering RBAC and Least Privileges">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch07lvl1sec73" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">
<span class="strong"><strong class="calibre8">Role-based access control</strong></span> (<span class="strong"><strong class="calibre8">RBAC</strong></span>) is an<a id="id913" class="calibre1"/> amazing feature, which also exists on Oracle Solaris 11 (its origin was in Oracle Solaris 8), that primarily makes it possible to restrict the granted privileges to a normal user for executing tasks. Putting this another way, RBAC makes it feasible to delegate only the necessary privileges for a regular user to be able to accomplish administrative tasks in a way similar to that of a sudo program. When compared with a sudo program, the main difference is the fact that RBAC is completely integrated in the operating system, and it is used during the user logon process to Oracle Solaris 11. Moreover, RBAC offers a more granular access to privileges than sudo does, and integration with another great feature from Oracle Solaris 11 named least privilege, which is used to cut out unnecessary privileges from processes and programs, allows you to reduce the attack surface of a hacker.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring and using RBAC"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec74" class="calibre1"/>Configuring and using RBAC</h1></div></div></div><p class="calibre7">Before <a id="id914" class="calibre1"/>explaining and implementing the RBAC feature, it is necessary <a id="id915" class="calibre1"/>to remember why RBAC is necessary and, afterwards, to learn some fundamental concepts.</p><p class="calibre7">According to our previous study on Oracle Solaris 11, it would not be possible for a normal user to reboot an Oracle Solaris 11 system, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">useradd -d /export/home/aborges -m -s /bin/bash aborges</strong></span>
80 blocks
root@solaris11-1:~# <span class="strong"><strong class="calibre8">passwd aborges</strong></span>
New Password: <span class="strong"><strong class="calibre8">hacker123!</strong></span>
Re-enter new Password: <span class="strong"><strong class="calibre8">hacker123!</strong></span>
passwd: password successfully changed for aborges
root@solaris11-1:~# <span class="strong"><strong class="calibre8">su - aborges</strong></span>
Oracle Corporation  <span class="strong"><strong class="calibre8">SunOS </strong></span>5.11  11.1  September 2012
aborges@solaris11-1:~$ <span class="strong"><strong class="calibre8">reboot</strong></span>
reboot: permission denied
aborges@solaris11-1:~$</pre></div><p class="calibre7">A <a id="id916" class="calibre1"/>simple and completely inappropriate solution would be to give a<a id="id917" class="calibre1"/> password from the <code class="email">root</code> account to user <code class="email">aborges</code>. However, this is unimaginable in a professional company. Another and a recommended solution is to use RBAC, which is a security feature that allows regular users to accomplish administrative tasks such as rebooting a system, as we have tried previously.</p><p class="calibre7">The <a id="id918" class="calibre1"/>RBAC framework contains the following objects:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Role</strong></span>: This is a special type of user that is created to execute administrative tasks, although<a id="id919" class="calibre1"/> it isn't possible to log in to a system<a id="id920" class="calibre1"/> and the correct procedure is to log in as a user and to assume the role using the <code class="email">su</code> command. As the role is a kind of user, it is configured in the <code class="email">/etc/passwd</code> file and it has a password defined in the <code class="email">/etc/shadow</code> file. However, different from a user, it isn't possible to log in to Oracle Solaris 11 using a role. The user must log in using a normal account and then they can assume a role using the <code class="email">su</code> command.</li><li class="listitem"><span class="strong"><strong class="calibre8">Profile</strong></span>: This<a id="id921" class="calibre1"/> is a set of commands. Any role <a id="id922" class="calibre1"/>assigned to a profile can execute any command from this profile. All system profiles are defined in the <code class="email">/etc/security/prof_attr.d/core-os</code> file, and local profiles can be defined in the <code class="email">/etc/security/prof_attr</code> file. To list all the profiles, use the following command:<div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">getent prof_attr | more</strong></span>
Software Installation:RO::Add application software to the system:auths=solaris.smf.manage.servicetags;profiles=ZFS File System Management;help=RtSoftwareInst
all.html
NTP Management:RO::Manage the NTP service:auths=solaris.smf.manage.ntp,solaris.smf.value.ntp
Desktop Configuration:RO::Configure graphical desktop software:auths=solaris.smf.manage.dt.login,solaris.smf.manage.x11,solaris.smf.manage.font,solaris.smf.m
anage.opengl
Device Security:RO::Manage devices and Volume Manager:auths=solaris.smf.manage.dt.login,solaris.device.*,solaris.smf.manage.vt,solaris.smf.manage.allocate;he
lp=RtDeviceSecurity.html
Desktop Removable Media User:RO::Access removable media for desktop user:
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div></li></ul></div><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Authorization</strong></span>: This represents a special form of privilege that is set in order to <a id="id923" class="calibre1"/>accomplish specific tasks, such as accessing a CD-ROM <a id="id924" class="calibre1"/>and managing the CUPS printing service, NTP<a id="id925" class="calibre1"/> service, Zones, SMF framework, and<a id="id926" class="calibre1"/> so on. Typically, authorizations are created either from the Oracle Solaris installation or from new installed software. All system authorizations are defined in the <code class="email">/etc/security/auth_attr.d/core-os</code> file, and local authorizations are defined in the <code class="email">/etc/security/auth_attr</code> file. To list all the authorizations, we run the following command:<div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">getent auth_attr | more</strong></span>
solaris.smf.read.ocm:::Read permissions for protected Oracle Configuration Manager Service Properties::
solaris.smf.value.ocm:::Change Oracle Configuration Manager System Repository Service values::
solaris.smf.manage.ocm:::Manage Oracle Configuration Manager System Repository Service states::
solaris.smf.manage.cups:::Manage CUPS service states::help=ManageCUPS.html
solaris.smf.manage.zfs-auto-snapshot:::Manage the ZFS Automatic Snapshot Service::
solaris.smf.value.tcsd:::Change TPM Administation value properties::
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div></li><li class="listitem"><span class="strong"><strong class="calibre8">Privilege</strong></span>: This is<a id="id927" class="calibre1"/> a singular right that can<a id="id928" class="calibre1"/> be assigned to a user, role, command, or even a system.</li><li class="listitem"><span class="strong"><strong class="calibre8">Execution attributes</strong></span>: These are commands<a id="id929" class="calibre1"/> that<a id="id930" class="calibre1"/> are defined in the <code class="email">/etc/security/exec_attr.d/core-os</code> (system execution attributes) or <code class="email">/etc/security/exec_attr</code> files (local definitions), and they are assigned to one or more profiles. To list all the execution attributes, we run the following command:<div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">getent exec_attr | more</strong></span>
DTrace Toolkit:solaris:cmd:::/usr/dtrace/DTT/*/*:privs=dtrace_kernel,dtrace_proc,dtrace_user
Desktop Configuration:solaris:cmd:RO::/usr/bin/scanpci:euid=0;privs=sys_config
Desktop Configuration:solaris:cmd:RO::/usr/X11/bin/scanpci:euid=0;privs=sys_config
OpenLDAP Server Administration:suser:cmd:RO::/usr/sbin/slapd:uid=openldap;gid=openldap;privs=basic,net_privaddr
OpenLDAP Server Administration:suser:cmd:RO::/usr/sbin/slapacl:uid=openldap;gid=openldap
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div></li><li class="listitem"><span class="strong"><strong class="calibre8">Profile shell</strong></span>: This is a special kind of profile (<code class="email">pfbash</code>, <code class="email">pfsh</code>, <code class="email">pfcsh</code>, or <code class="email">pfzsh</code>) assigned <a id="id931" class="calibre1"/>to users during a <code class="email">su</code> command to <a id="id932" class="calibre1"/>assume <a id="id933" class="calibre1"/>a role or a<a id="id934" class="calibre1"/> login shell that allows access to specific privileges. It is necessary to use any one of these profile shells.</li><li class="listitem"><span class="strong"><strong class="calibre8">Security policy</strong></span>: This<a id="id935" class="calibre1"/> defines default <a id="id936" class="calibre1"/>privileges and profiles for users. The related configuration file is <code class="email">/etc/security/policy.conf</code>, as shown in the following command:<div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/security/policy.conf</strong></span>
</pre></div></li></ul></div><p class="calibre7">There are two ways to use RBAC. The first method is simpler and more straightforward; you can create and assign a profile directly to a user account in order to log in as a normal user and use the <code class="email">pfexec</code> command to execute additional commands from the assigned profile.</p><a id="id937" class="calibre1"/><p class="calibre7">The second method is to put all mentioned concepts about RBAC (commands, authorizations, profiles, roles, and users) together following a schema as shown next (from right to left):</p><p class="calibre7">User &lt;-- Role &lt;-- Profile &lt;-- Commands and/or Authorizations</p><p class="calibre7">The second method is more complex, and the required steps to use RBAC, as described in the previous sequence, are as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create <a id="id938" class="calibre1"/>a role using the <code class="email">roleadd</code> command.</li><li class="listitem" value="2">Create a profile, editing the <code class="email">/etc/security/prof_attr</code> file.</li><li class="listitem" value="3">Assign commands to the created profile (step 2) in <code class="email">/etc/security/exec_attr</code> or assign authorizations (<code class="email">/etc/security/auth_attr</code>) to the profile in the <code class="email">/etc/security/prof_attr</code> file.</li><li class="listitem" value="4">Assign <a id="id939" class="calibre1"/>the profile to the role using the <code class="email">rolemod</code> command.</li><li class="listitem" value="5">Create a <a id="id940" class="calibre1"/>password for the role using the <code class="email">passwd</code> command.</li><li class="listitem" value="6">Assign one or <a id="id941" class="calibre1"/>more users to the role using the <code class="email">usermod</code> command.</li><li class="listitem" value="7">When the user needs to use the assigned commands, execute <code class="email">su - &lt;rolename&gt;</code>.</li></ol><div class="calibre17"/></div><p class="calibre7">This is nice! This is a summary of the concepts required to manage RBAC. We will learn how to execute a step-by-step procedure for both methods.</p></div>

<div class="book" title="Configuring and using RBAC">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec108" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual machine (VirtualBox or VMware) running Oracle Solaris 11 and with at least 2 GB RAM.</p></div></div>

<div class="book" title="Configuring and using RBAC">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec109" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">We are<a id="id942" class="calibre1"/> going to learn both the methods to allow a regular user to be<a id="id943" class="calibre1"/> able to reboot a system, that is, using the <code class="email">pfexec</code> command (simpler) and RBAC's role (more complex).</p><p class="calibre7">Using the <code class="email">pfexec</code> command is easy. First, create the <code class="email">aborges</code> regular user with <code class="email">hacker123!</code> as the password, as shown in the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">useradd -d /export/home/aborges -m -s /bin/bash aborges</strong></span>
80 blocks
root@solaris11-1:~# <span class="strong"><strong class="calibre8">passwd aborges</strong></span>
New Password: <span class="strong"><strong class="calibre8">hacker123!</strong></span>
Re-enter new Password: <span class="strong"><strong class="calibre8">hacker123!</strong></span>
passwd: password successfully changed for aborges</pre></div><p class="calibre7">The main idea is to associate a profile (that is, a set of commands) directly to the user (<code class="email">aborges</code>). In this case, the desired profile already exists; if not, we have to create a new one. To avoid creating an unnecessary profile, verify that there is a line in the <code class="email">/etc/security/exec_attr.d/core-os</code> file with the <code class="email">reboot</code> command by executing the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">cat /etc/security/exec_attr.d/core-os | grep reboot</strong></span>
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/reboot:uid=0</pre></div><p class="calibre7">This is excellent! There is one profile named <code class="email">"Maintenance and Repair"</code> that includes the reboot command. For accomplishing our task, associate this profile (using the <code class="email">–P</code> option) with the <code class="email">aborges</code> user, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">usermod -P "Maintenance and Repair" aborges</strong></span>
root@solaris11-1:/# <span class="strong"><strong class="calibre8">more /etc/user_attr.d/local-entries | grep aborges</strong></span>
aborges::::profiles=Maintenance and Repair</pre></div><p class="calibre7">As <a id="id944" class="calibre1"/>we realized, it created an entry for the <code class="email">aborges</code> user in the <code class="email">/etc/ user_attr.d/local-entries</code> file. However, even including this entry, which <a id="id945" class="calibre1"/>associates the <code class="email">aborges</code> user with the <code class="email">"Maintenance and Repair"</code> profile, the user is still not able to reboot the system, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:/# <span class="strong"><strong class="calibre8">su – aborges</strong></span>
Oracle Corporation  <span class="strong"><strong class="calibre8">SunOS 5.11  11.1  September 2012</strong></span>
aborges@solaris11-1:~$ <span class="strong"><strong class="calibre8">reboot</strong></span>
reboot: permission denied</pre></div><p class="calibre7">Nonetheless, if the <code class="email">aborges</code> user wants to execute the same command using <code class="email">pfexec</code>, the result will be different, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">aborges@solaris11-1:~$ <span class="strong"><strong class="calibre8">pfexec reboot</strong></span>
</pre></div><p class="calibre7">It worked! The system will be rebooted as expected.</p><p class="calibre7">The approach using the <code class="email">pfexec</code> command is wonderful, but the mode chosen to configure it (taking a ready profile) can bring about two little side effects:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">"Maintenance and Repair"</code> profile has other commands, and we have also assigned these commands to the <code class="email">aborges</code> user, as shown in the following command:<div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">cat /etc/security/exec_attr.d/core-os | grep -i "Maintenance and Repair"</strong></span>
Maintenance and Repair:solaris:cmd:RO::/usr/bin/mdb:privs=all
Maintenance and Repair:solaris:cmd:RO::/usr/bin/coreadm:euid=0;privs=proc_owner
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/croinfo:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/bin/date:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/bin/ldd:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/bin/vmstat:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/eeprom:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/halt:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/init:uid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/pcitool:privs=all
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/poweroff:uid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/prtconf:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/reboot:uid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/syslogd:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/bootadm:euid=0
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/ucodeadm:privs=all
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/cpustat:privs=basic,cpc_cpu
Maintenance and Repair:solaris:cmd:RO::/usr/bin/pgstat:privs=basic,cpc_cpu
Maintenance and Repair:solaris:cmd:RO::/usr/bin/kstat:privs=basic,cpc_cpu
Maintenance and Repair:solaris:cmd:RO::/usr/sbin/ilomconfig:privs=sys_config,sys_ip_config,sys_dl_config
Maintenance and Repair:solaris:cmd:RO::/usr/lib/ilomconfig.builtin:privs=sys_config,sys_ip_config,sys_dl_config</pre></div><p class="calibre16">To prevent this, it would be better to create a new profile and assign only the reboot command to it.</p></li><li class="listitem">The second side effect is that the procedure using the <code class="email">pfexec</code> command should be done for each user that needs to use the <code class="email">reboot</code> command, but it can take additional time.</li></ul></div><p class="calibre7">The <a id="id946" class="calibre1"/>second<a id="id947" class="calibre1"/> method to reach our goal is using roles, profiles, and/or authorizations together. The advantage in this case is that privileges are not associated with users directly, but they are assigned to roles instead. Then, if a regular user needs to reboot the system (for example), it assumes the role using the <code class="email">su</code> command and executes the appropriate command.</p><p class="calibre7">Create another user (different from the previous one) to be used in this method by running the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">useradd -d /export/home/rbactest -m -s /bin/bash rbactest</strong></span>
80 blocks
root@solaris11-1:~# <span class="strong"><strong class="calibre8">passwd rbactest</strong></span>
New Password: <span class="strong"><strong class="calibre8">oracle123!</strong></span>
Re-enter new Password: <span class="strong"><strong class="calibre8">oracle123!</strong></span>
passwd: password successfully changed for rbactest</pre></div><p class="calibre7">To confirm that the <code class="email">brbactest</code> user can't reboot the system, execute the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">su -</strong></span> <span class="strong"><strong class="calibre8">rbactest</strong></span>
Oracle Corporation	SunOS 5.11  11.1  September 2012

<span class="strong"><strong class="calibre8">rbactest@solaris11-1:~$ reboot</strong></span>
reboot: permission denied</pre></div><p class="calibre7">Create a role that will be configured later by running the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">roleadd -m -d /export/home/r_reboot -s /bin/pfbash r_reboot</strong></span>
80 blocks
root@solaris11-1:~# <span class="strong"><strong class="calibre8">grep r_reboot /etc/passwd</strong></span>
r_reboot:x:103:10::/export/home/r_reboot:/bin/bash
root@solaris11-1:~# <span class="strong"><strong class="calibre8">grep r_reboot /etc/shadow</strong></span>
r_reboot:UP:::::::</pre></div><p class="calibre7">As we <a id="id948" class="calibre1"/>have mentioned previously, profiles are very important <a id="id949" class="calibre1"/>and are used during RBAC configuration. The system already has some defined system profiles that are configured in the <code class="email">/etc/security/prof_attr.d/core-os</code> file, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/security/prof_attr.d/core-os </strong></span>
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
All:RO::\
Execute any command as the user or role:\
help=RtAll.html

Administrator Message Edit:RO::\
Update administrator message files:\
auths=solaris.admin.edit/etc/issue,\
solaris.admin.edit/etc/motd;\
help=RtAdminMsg.html

Audit Configuration:RO::\
Configure Solaris Audit:\
auths=solaris.smf.value.audit;\
help=RtAuditCfg.html

Audit Control:RO::\
Control Solaris Audit:\
auths=solaris.smf.manage.audit;\
help=RtAuditCtrl.html
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><p class="calibre7">Therefore, according to the suggested steps in the introduction of this recipe, create a profile named <code class="email">Reboot</code> at the end of the profile configuration file, as shown in the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">vi /etc/security/prof_attr</strong></span>
#
# The system provided entries are stored in different files
# under "/etc/security/prof_attr.d".  They should not be
# copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
<span class="strong"><strong class="calibre8">Reboot:RO::\</strong></span>
<span class="strong"><strong class="calibre8">For authorized users to reboot the system:\</strong></span>
<span class="strong"><strong class="calibre8">help=RebootByRegularUser.html</strong></span>
</pre></div><p class="calibre7">We know from this file that the profile name is <code class="email">Reboot</code> and the <code class="email">RO</code> (read-only) characters indicate that it isn't modifiable by any tool that changes this database. The lines that follow denote the description and the help file (it is unnecessary to create it). It will be possible to bind authorizations (the <code class="email">auths</code> key), other profiles (the <code class="email">profiles</code> key), and privileges (the <code class="email">priv</code> key) to this <code class="email">Reboot</code> profile.</p><p class="calibre7">Following the profile creation, we have to assign one or more commands to this profile, and local modifications occur by editing the <code class="email">/etc/security/exec_attr</code> file, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">vi /etc/security/exec_attr</strong></span>
#
# The system provided entries are stored in different files
# under "/etc/security/exec_attr.d".  They should not be
# copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
<span class="strong"><strong class="calibre8">Reboot:solaris:cmd:RO::/usr/sbin/reboot:uid=0</strong></span>
</pre></div><p class="calibre7">The <a id="id950" class="calibre1"/>components of the last line of the preceding code snippet can be<a id="id951" class="calibre1"/> explained as follows:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">Reboot</code>: This is the profile name.</li><li class="listitem"><code class="email">solaris</code>: This is the security policy associated with the <code class="email">Reboot</code> profile. This security policy is able to recognize privileges. Oracle Solaris 11 has another possible value for this field named <code class="email">suser</code> (not shown previously), which is very similar to the <code class="email">solaris</code> value, but it is not able to understand and recognize privileges.</li><li class="listitem"><code class="email">cmd</code>: This is a type of object. In this case, it is a command to be executed by a shell.</li><li class="listitem"><code class="email">RO</code>: This indicates that this line isn't modifiable by any tool that changes this file.</li><li class="listitem"><code class="email">/usr/sbin/reboot</code>: This is the command to be executed by a user when they assume the role that contains this <code class="email">Reboot</code> profile.</li><li class="listitem"><code class="email">Uid=0</code>: This command is run with the real ID of the user's root (<code class="email">uid=0</code>). This is the case when a user has to run the command; the command will be executed as run by a root user. Other good and useful possible keys are <code class="email">euid</code> (effective user ID, which is similar to running a command with <code class="email">setuid</code> set as the executable) and <code class="email">privs</code> (privileges).</li></ul></div><p class="calibre7">Again, it is very interesting to check the already existing system execute attributes defined in the <code class="email">/etc/security/exec_attr.d/core-os</code> file, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/security/exec_attr.d/core-os </strong></span>
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
All:solaris:cmd:RO::*:
Audit Control:solaris:cmd:RO::/usr/sbin/audit:privs=proc_owner,sys_audit
Audit Configuration:solaris:cmd:RO::/usr/sbin/auditconfig:privs=sys_audit
Audit Review:solaris:cmd:RO::/usr/sbin/auditreduce:euid=0
Audit Review:solaris:cmd:RO::/usr/sbin/auditstat:privs=proc_audit
Audit Review:solaris:cmd:RO::/usr/sbin/praudit:privs=file_dac_read
Contract Observer:solaris:cmd:RO::/usr/bin/ctwatch:\
  privs=contract_event,contract_observer
Cron Management:solaris:cmd:RO::/usr/bin/crontab:euid=0
Crypto Management:solaris:cmd:RO::/usr/sbin/cryptoadm:euid=0
Crypto Management:solaris:cmd:RO::/usr/bin/kmfcfg:euid=0
Crypto Management:solaris:cmd:RO::/usr/sfw/bin/openssl:euid=0
Crypto Management:solaris:cmd:RO::/usr/sfw/bin/CA.pl:euid=0
DHCP Management:solaris:cmd:RO::/usr/lib/inet/dhcp/svcadm/dhcpconfig:uid=0
DHCP Management:solaris:cmd:RO::/usr/lib/inet/dhcp/svcadm/dhtadm:uid=0
DHCP Management:solaris:cmd:RO::/usr/lib/inet/dhcp/svcadm/pntadm:uid=0
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><p class="calibre7">It's time<a id="id952" class="calibre1"/> to bind the <code class="email">r_reboot</code> role to the <code class="email">Reboot</code> profile (the <code class="email">–P</code> option) by<a id="id953" class="calibre1"/> executing the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">rolemod -P Reboot r_reboot</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/user_attr</strong></span>
#
# The system provided entries are stored in different files
# under "/etc/user_attr.d".  They should not be copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
ale::::lock_after_retries=no;profiles=System Administrator;roles=root
<span class="strong"><strong class="calibre8">r_reboot::::type=role;profiles=Reboot;roleauth=role</strong></span>
</pre></div><p class="calibre7">According to the previous output, <code class="email">r_reboot</code> is of type <code class="email">role</code> and it is associated with the <code class="email">Reboot</code> profile.</p><p class="calibre7">The <code class="email">r_reboot</code> role does not have any password, so we should set a new password for it by<a id="id954" class="calibre1"/> running<a id="id955" class="calibre1"/> the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">passwd r_reboot</strong></span>
New Password: <span class="strong"><strong class="calibre8">hacker321!</strong></span>
Re-enter new Password: <span class="strong"><strong class="calibre8">hacker321!</strong></span>
passwd: password successfully changed for r_reboot
root@solaris11-1:~# <span class="strong"><strong class="calibre8">grep r_reboot /etc/shadow</strong></span>
r_reboot:$5$q75Eiy5/$u9mgnYsvlszbNXkSuH4kZwVVnFOhemnCTMF//cvBWD9:16178::::::19216</pre></div><p class="calibre7">The RBAC configuration is almost complete. To assume this <code class="email">r_reboot</code> role, the <code class="email">rbactest</code> user must be assigned to it by using the <code class="email">-R</code> option from the <code class="email">usermod</code> command, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">usermod -R r_reboot rbactest</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/user_attr</strong></span>
#
# The system provided entries are stored in different files
# under "/etc/user_attr.d".  They should not be copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
ale::::lock_after_retries=no;profiles=System Administrator;roles=root
<span class="strong"><strong class="calibre8">r_reboot::::type=role;profiles=Reboot;roleauth=role</strong></span>
<span class="strong"><strong class="calibre8">rbactest::::roles=r_reboot</strong></span>
</pre></div><p class="calibre7">To confirm every executed task until now, run the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">roles rbactest</strong></span>
<span class="strong"><strong class="calibre8">r_reboot</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">profiles rbactest</strong></span>
rbactest:
          Basic Solaris User
          All
root@solaris11-1:~# <span class="strong"><strong class="calibre8">profiles r_reboot</strong></span>
r_reboot:
          <span class="strong"><strong class="calibre8">Reboot</strong></span>
<span class="strong"><strong class="calibre8">          Basic Solaris User</strong></span>
<span class="strong"><strong class="calibre8">          All</strong></span>
</pre></div><p class="calibre7">It<a id="id956" class="calibre1"/>
<a id="id957" class="calibre1"/> is worth remembering that <code class="email">rbactest</code> is a user while <code class="email">r_reboot</code> is a role, and as explained previously, it is not possible to log in to the system using a role. Additionally, the existing profiles are <code class="email">Basic Solaris User</code>, which enables users to use the system according to the established security limits, and <code class="email">All</code>, which provides access to the commands that do not have any security attributes.</p><p class="calibre7">Continuing the verification, we have to check the authorizations for the <code class="email">r_reboot</code> role and the <code class="email">rbactest</code> user as well as for the assigned profiles to the <code class="email">r_reboot</code> role. These tasks are done by executing the following sequence of commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">auths r_reboot</strong></span>
solaris.admin.wusb.read,solaris.mail.mailq,solaris.network.autoconf.read
root@solaris11-1:~# <span class="strong"><strong class="calibre8">auths rbactest</strong></span>
solaris.admin.wusb.read,solaris.mail.mailq,solaris.network.autoconf.read
root@solaris11-1:~# <span class="strong"><strong class="calibre8">profiles -l r_reboot</strong></span>
r_reboot:
      <span class="strong"><strong class="calibre8">Reboot</strong></span>
          /usr/sbin/reboot           uid=0

      <span class="strong"><strong class="calibre8">Basic Solaris User</strong></span>
      auths=solaris.mail.mailq,solaris.network.autoconf.read,solaris.admin.wusb.read
      profiles=All
              /usr/bin/cdrecord.bin      privs=file_dac_read,sys_devices,proc_lock_memory,proc_priocntl,net_privaddr
          /usr/bin/readcd.bin        privs=file_dac_read,sys_devices,net_privaddr
          /usr/bin/cdda2wav.bin      privs=file_dac_read,sys_devices,proc_priocntl,net_privaddr

      <span class="strong"><strong class="calibre8">All</strong></span>
          *</pre></div><p class="calibre7">There are a few points to be highlighted:</p><div class="book"><ul class="itemizedlist"><li class="listitem">The <code class="email">rbactest</code> user is assigned to the <code class="email">r_reboot</code> role.</li><li class="listitem">There is no authorization assigned either to the <code class="email">rbactest</code> user or to the <code class="email">r_reboot</code> role.</li><li class="listitem">The <code class="email">All</code> profile grants unrestricted access to all unrestricted commands from Oracle Solaris 11. In this case, the <code class="email">r_reboot</code> role is associated with three profiles: <code class="email">Reboot</code>, <code class="email">Basic Solaris User</code>, and <code class="email">All</code>.</li><li class="listitem">The <code class="email">Basic Solaris User</code> profile can execute some related CD-ROM commands using specific privileges.</li></ul></div><p class="calibre7">Finally, we<a id="id958" class="calibre1"/> can verify that the <code class="email">rbactest</code> user is able to reboot<a id="id959" class="calibre1"/> the system by executing the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~#<span class="strong"><strong class="calibre8"> id</strong></span>
uid=0(root) gid=0(root)
root@solaris11-1:~# <span class="strong"><strong class="calibre8">su - rbactest</strong></span>
Oracle Corporation	SunOS 5.11	11.1	September 2012
rbactest@solaris11-1:~$<span class="strong"><strong class="calibre8"> id</strong></span>
uid=102(rbactest) gid=10(staff)
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">profiles</strong></span>
          Basic Solaris User
          All
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">su - r_reboot</strong></span>
Password: hacker321!
Oracle Corporation	SunOS 5.11	11.1	September 2012
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">id</strong></span>
uid=103(r_reboot) gid=10(staff)
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">profiles</strong></span>
          <span class="strong"><strong class="calibre8">Reboot</strong></span>
          Basic Solaris User
          All
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">reboot</strong></span>
</pre></div><p class="calibre7">The system is reinitiated immediately. That's fantastic!</p><p class="calibre7">RBAC allows you to integrate all the concepts that you have learned about (roles, profiles, authorizations, and commands) with privileges; therefore, it offers us a more fine-grained and integrated control than a sudo program does.</p><p class="calibre7">When working with Oracle Solaris 11, we can use RBAC with services from the SMF framework. For example, the DNS client and DHCP server have the following authorizations:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">svcprop -p general/action_authorization dns/client</strong></span>
solaris.smf.manage.name-service.dns.client
root@solaris11-1:~# <span class="strong"><strong class="calibre8">svcprop -p general/action_authorization dhcp/server:ipv4</strong></span>
solaris.smf.manage.dhcp</pre></div><p class="calibre7">Without these appropriate authorizations, the <code class="email">rbactest</code> user isn't able to manage these services, as shown in the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">id</strong></span>
uid=0(root) gid=0(root)
root@solaris11-1:~# <span class="strong"><strong class="calibre8">su - rbactest</strong></span>
Oracle Corporation	SunOS 5.11  11.1  September 2012
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">id</strong></span>
uid=102(rbactest) gid=10(staff)
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">svcadm restart dns/client</strong></span>
svcadm: svc:/network/dns/client:default: Permission denied.
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">svcadm restart dhcp/server:ipv4</strong></span>
svcadm: svc:/network/dhcp/server:ipv4: Permission denied.</pre></div><p class="calibre7">It's easy to solve these problems, assigning the respective authorization to the <code class="email">r_reboot</code> role, by executing the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">rolemod -A solaris.smf.manage.name-service.dns.client,solaris.smf.manage.dhcp r_reboot</strong></span>
</pre></div><p class="calibre7">To verify <a id="id960" class="calibre1"/>that the previous command has worked, check the altered <a id="id961" class="calibre1"/>file:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/user_attr</strong></span>
#
# The system provided entries are stored in different files
# under "/etc/user_attr.d".  They should not be copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
ale::::lock_after_retries=no;profiles=System Administrator;roles=root
<span class="strong"><strong class="calibre8">r_reboot::::type=role;auths=solaris.smf.manage.name-service.dns.client,solaris.smf.manage.dhcp;profiles=Reboot;defaultpriv=basic,file_dac_read;roleauth=role</strong></span>
rbactest::::defaultpriv=basic,file_dac_read;roles=r_reboot</pre></div><p class="calibre7">That's nice! It's time to test whether our modifications have worked by executing the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">su - rbactest</strong></span>
Oracle Corporation  SunOS 5.11  11.1  September 2012
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">su - r_reboot</strong></span>
Password: hacker321!
Oracle Corporation  SunOS 5.11  11.1  September 2012
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">svcadm -v restart dns/client</strong></span>
Action restart set for svc:/network/dns/client:default.
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">svcadm -v restart dhcp/server:ipv4</strong></span>
Action restart set for svc:/network/dhcp/server:ipv4.</pre></div><p class="calibre7">That's excellent! The integration of RBAC with SMF is perfect, and a normal user such as <code class="email">rbactest</code> is able to manage both the services (the DNS client and the DHCP server) as it is the root user.</p><p class="calibre7">If we <a id="id962" class="calibre1"/>want to unbind the <code class="email">r_reboot</code> role from the <code class="email">rbactest</code> user to<a id="id963" class="calibre1"/> prevent them from rebooting, or to perform any other action on the system, execute the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">roles rbactest</strong></span>
r_reboot
root@solaris11-1:~# <span class="strong"><strong class="calibre8">usermod -R "" rbactest</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">roles rbactest</strong></span>
root@solaris11-1:~#</pre></div><p class="calibre7">A final and additional note: it is possible to configure default RBAC authorizations and profiles for every user in the <code class="email">/etc/security/policy.conf</code> file. In the same way, there is the option to configure the default privilege and its limit, as shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/security/policy.conf </strong></span>
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
AUTHS_GRANTED=
PROFS_GRANTED=Basic Solaris User
CONSOLE_USER=Console User
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
#
#PRIV_DEFAULT=basic
#PRIV_LIMIT=all
#
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><div class="book" title="An overview of the recipe"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch07lvl3sec53" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">In this <a id="id964" class="calibre1"/>section, we learned how to use RBAC in order to allow a <a id="id965" class="calibre1"/>regular user to reboot the system. Furthermore, we have tested how to find and grant the necessary authorization to manage services from the SMF framework. The same procedure should be applied for any user and any number of commands.</p></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Playing with least privileges"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec75" class="calibre1"/>Playing with least privileges</h1></div></div></div><p class="calibre7">Oracle Solaris 11, like other good UNIX-like operating systems, has a flaw in its inception; there<a id="id966" class="calibre1"/> is a privileged account called root that has all special privileges on a system and other accounts that have limited permissions such as regular users. Under this model, a process either has all special privileges or none. Therefore, if we grant permission for a regular user to run a program, usually we are granting much more than is needed, and unfortunately, it could be a problem if a hacker is to crack the application or the system.</p><p class="calibre7">In Oracle Solaris 10, developers have introduced a wonderful feature to make the permissions<a id="id967" class="calibre1"/> more flexible; <span class="strong"><strong class="calibre8">least privilege</strong></span>. The base concept is easy; the recommendation is to only grant the necessary privilege for a process, user, or program in order to reduce the damage in case of a serious security breach. For example, when we manage the filesystem's security by applying read, write, and execute rights, we usually grant much more privileges to a file than necessary, and this is a big problem. It would be better if we could grant only a few privileges (such as simple and individual rights) that were enough for a role, user, command, or even a process.</p><p class="calibre7">There are four sets of privileges for a process:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><strong class="calibre8">Effective</strong></span> (<span class="strong"><strong class="calibre8">E</strong></span>): This <a id="id968" class="calibre1"/>represents a set of <a id="id969" class="calibre1"/>privileges that are currently in use.</li><li class="listitem"><span class="strong"><strong class="calibre8">Inherited</strong></span> (<span class="strong"><strong class="calibre8">I</strong></span>): This<a id="id970" class="calibre1"/> is the set of privileges<a id="id971" class="calibre1"/> that can be inherited by a child process after a <code class="email">fork()</code>/<code class="email">exec()</code> call.</li><li class="listitem"><span class="strong"><strong class="calibre8">Permitted</strong></span> (<span class="strong"><strong class="calibre8">P</strong></span>): This <a id="id972" class="calibre1"/>is the set of privileges<a id="id973" class="calibre1"/> that are available to be used.</li><li class="listitem"><span class="strong"><strong class="calibre8">Limited</strong></span> (<span class="strong"><strong class="calibre8">L</strong></span>): This <a id="id974" class="calibre1"/>represents all the available <a id="id975" class="calibre1"/>privileges that can be made available to the permitted set.</li></ul></div><p class="calibre7">Oracle Solaris 11 has several classes of privileges, such as file, sys, net, proc, and ipc. Each one of these privilege classes (some people call categories) have many different privileges, and some of them were chosen as being the basic privileges that are assigned to any user.</p></div>

<div class="book" title="Playing with least privileges">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch07lvl2sec110" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual machine (VirtualBox or VMware) running Oracle Solaris 11 and with at least 2 GB RAM.</p></div></div>

<div class="book" title="Playing with least privileges">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch07lvl2sec111" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">What are<a id="id976" class="calibre1"/> the existing privileges? This question is answered either by reviewing the main pages (the <code class="email">main privileges</code> command) or by running the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">ppriv -vl | more</strong></span>
<span class="strong"><strong class="calibre8">contract_event</strong></span>
  Allows a process to request critical events without limitation.
  Allows a process to request reliable delivery of all events on
  any event queue.
<span class="strong"><strong class="calibre8">contract_identity</strong></span>
  Allows a process to set the service FMRI value of a process
  contract template.
 <span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><p class="calibre7">However, from all existing privileges, only some of them are basic and essential for process operations:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">ppriv -vl basic</strong></span>
<span class="strong"><strong class="calibre8">file_link_any</strong></span>
  Allows a process to create hardlinks to files owned by a uid
  different from the process' effective uid.
<span class="strong"><strong class="calibre8">file_read</strong></span>
  Allows a process to read objects in the filesystem.
<span class="strong"><strong class="calibre8">file_write</strong></span>
  Allows a process to modify objects in the filesystem.
<span class="strong"><strong class="calibre8">net_access</strong></span>
  Allows a process to open a TCP, UDP, SDP or SCTP network endpoint.
<span class="strong"><strong class="calibre8">proc_exec</strong></span>
  Allows a process to call execve().
<span class="strong"><strong class="calibre8">proc_fork</strong></span>
  Allows a process to call fork1()/forkall()/vfork()
<span class="strong"><strong class="calibre8">proc_info</strong></span>
  Allows a process to examine the status of processes other
  than those it can send signals to.  Processes which cannot
  be examined cannot be seen in /proc and appear not to exist.
<span class="strong"><strong class="calibre8">proc_session</strong></span>
  Allows a process to send signals or trace processes outside its
  session.</pre></div><p class="calibre7">When handling process privileges, we can manage them by using the <code class="email">ppriv</code> command. For example, to list privileges from the current shell, run the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">ppriv $$</strong></span>
2590:  bash
<span class="strong"><strong class="calibre8">flags = &lt;none&gt;</strong></span>
  E: all
  I: basic
  P: all
  L: all</pre></div><p class="calibre7">We <a id="id977" class="calibre1"/>could get the same result by executing <code class="email">ppriv 2590</code>, and in both cases, a more comprehensive output could be obtained by using the <code class="email">-v</code> option (<code class="email">ppriv –v 2590</code> or <code class="email">ppriv –v $$</code>). Additionally, there are two common flags that could appear here: <code class="email">PRIV_AWARE</code> (the process is aware of the privileges framework) and <code class="email">PRIV_DEBUG</code> (the process is in the privilege debugging mode).</p><p class="calibre7">We have learned about the possible privileges, so it is time to apply these concepts in real-world cases. For example, if a normal user (the <code class="email">rbactest</code> user from the last section) tries to read the <code class="email">/etc/shadow</code> content, they are not going to see anything, as shown in the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">id</strong></span>
uid=0(root) gid=0(root)
root@solaris11-1:~# <span class="strong"><strong class="calibre8">ls -l /etc/shadow</strong></span>
-r--------   1 root     sys          949 Apr 18 22:57 /etc/shadow
root@solaris11-1:~# <span class="strong"><strong class="calibre8">su – rbactest</strong></span>
Oracle Corporation	SunOS 5.11  11.1  September 2012
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">more /etc/shadow</strong></span>
/etc/shadow: Permission denied</pre></div><p class="calibre7">It could present a serious problem for us if we didn't have a suitable solution, because we don't want to grant any unnecessary rights to the <code class="email">rbactest</code> user, but we need to grant enough rights to accomplish this task of reading the <code class="email">/etc/shadow</code> file. If we grant the read rights (R) to the other right group in the <code class="email">/etc/shadow</code> file, we are allowing other users to read the file. A better situation arises by using the <span class="strong"><strong class="calibre8">Access Control List</strong></span> (<span class="strong"><strong class="calibre8">ACL</strong></span>) because <a id="id978" class="calibre1"/>we can grant read rights (R) on <code class="email">/etc/shadow</code> for only the <code class="email">rbactest</code> user, but it would be an excessive and dangerous right for a valuable file like this.</p><p class="calibre7">The real <a id="id979" class="calibre1"/>solution for this problem is to use least privileges. In other words, it is recommended that you assign only necessary privileges for the <code class="email">rbactest</code> user to be able to see the <code class="email">/etc/shadow</code> content. However, which is the right privilege? It is<a id="id980" class="calibre1"/> found by running the <code class="email">ppriv</code> command with the <code class="email">–De</code> option (debugging and executing), as shown in the following command:</p><div class="informalexample"><pre class="programlisting">rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">ppriv -De more /etc/shadow</strong></span>
more[2615]: missing privilege "file_dac_read" (euid = 102, syscall = 69) for "/etc/shadow" needed at zfs_zaccess+0x245
/etc/shadow: Permission denied</pre></div><p class="calibre7">The privilege missing is <code class="email">file_dac_read</code> and it has the following description:</p><div class="informalexample"><pre class="programlisting">rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">ppriv -vl file_dac_read</strong></span>
file_dac_read
  Allows a process to read a file or directory whose permission
  bits or ACL do not allow the process read permission.</pre></div><p class="calibre7">The system call that fails is shown in the following command:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">grep 69 /etc/name_to_sysnum</strong></span>
openat64    69</pre></div><p class="calibre7">It's feasible to get more information about the <code class="email">mkdirat</code> system call by executing the following command:</p><div class="informalexample"><pre class="programlisting">rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">man openat</strong></span>
System Calls                                              open(2)
NAME
     open, openat - open a file

SYNOPSIS
     #include &lt;sys/types.h&gt;
     #include &lt;sys/stat.h&gt;
     #include &lt;fcntl.h&gt;

     int open(const char *path, int oflag, /* mode_t mode */);

     int openat(int fildes, const char *path, int oflag,
          /* mode_t mode */);

DESCRIPTION
     The open() function establishes  the  connection  between  a
     file and a file descriptor. It creates an open file descrip-
     tion that refers to a file and a file descriptor that refers 
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><p class="calibre7">Now <a id="id981" class="calibre1"/>we know the correct privilege, so there are two options to correct the situation: either the <code class="email">file_dac_read</code> privilege is granted to the <code class="email">rbactest</code> user directly, or it is assigned to a role (for example, <code class="email">r_reboot</code> from the previous section).</p><p class="calibre7">To assign the <code class="email">rbactest</code> user and then to assign the privilege for a role, execute the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">id</strong></span>
uid=0(root) gid=0(root)
root@solaris11-1:~# <span class="strong"><strong class="calibre8">usermod -R r_reboot rbactest</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">rolemod -K defaultpriv=basic,file_dac_read r_reboot</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">cat /etc/user_attr</strong></span>
#
# The system provided entries are stored in different files
# under "/etc/user_attr.d".  They should not be copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
ale::::lock_after_retries=no;profiles=System Administrator;roles=root
r_reboot::::type=role;<span class="strong"><strong class="calibre8">defaultpriv=basic,file_dac_read</strong></span>;profiles=Reboot;roleauth=role
rbactest::::roles=r_reboot </pre></div><p class="calibre7">According to the previous step, we have associated the <code class="email">rbactest</code> user with the <code class="email">r_reboot</code> role (if you have already made it previously) and have kept the existing basic privileges. Furthermore, a new privilege (<code class="email">file_dac_read</code>) was appended. To verify that the configuration is correct, run the following commands:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">su - rbactest</strong></span>
Oracle Corporation  SunOS 5.11  11.1  September 2012

rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">su - r_reboot</strong></span>
Password: <span class="strong"><strong class="calibre8">hacker321!</strong></span>
Oracle Corporation  SunOS 5.11  11.1  September 2012
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">profiles</strong></span>
          <span class="strong"><strong class="calibre8">Reboot</strong></span>
          Basic Solaris User
          All
r_reboot@solaris11-1:~$ <span class="strong"><strong class="calibre8">more /etc/shadow</strong></span>
root:$5$7X5pLA3o$ZTJJeO.MfVLlBGzJI.yzh3vqhvW.xUWBknCCMHRvP79:16179::::::18384
daemon:NP:6445::::::
bin:NP:6445::::::
sys:NP:6445::::::
adm:NP:6445::::::
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><p class="calibre7">It has <a id="id982" class="calibre1"/>worked! Another way to get the same result is to grant the <code class="email">file_dac_read</code> privilege directly to the <code class="email">rbactest</code> user, but this is not the recommend method:</p><div class="informalexample"><pre class="programlisting">root@solaris11-1:~# <span class="strong"><strong class="calibre8">id</strong></span>
uid=0(root) gid=0(root)
root@solaris11-1:~# <span class="strong"><strong class="calibre8">usermod -K defaultpriv=basic,file_dac_read rbactest</strong></span>
root@solaris11-1:~# <span class="strong"><strong class="calibre8">more /etc/user_attr</strong></span>
# The system provided entries are stored in different files
# under "/etc/user_attr.d".  They should not be copied to this file.
#
# Only local changes should be stored in this file.
# This line should be kept in this file or it will be overwritten.
#
ale::::lock_after_retries=no;profiles=System Administrator;roles=root
r_reboot::::type=role;defaultpriv=basic,file_dac_read;profiles=Reboot;roleauth=role
<span class="strong"><strong class="calibre8">rbactest::::defaultpriv=basic,file_dac_read;roles=r_reboot</strong></span>

root@solaris11-1:~# <span class="strong"><strong class="calibre8">su – rbactest</strong></span>
Oracle Corporation	SunOS 5.11  11.1  September 2012
rbactest@solaris11-1:~$ <span class="strong"><strong class="calibre8">more /etc/shadow</strong></span>
root:$5$oXapLA3o$UTJJeO.MfVlTBGzJI.yzhHvqhvW.xUWBknCCKHRvP79:16179::::::18384
daemon:NP:6445::::::
bin:NP:6445::::::
sys:NP:6445::::::
adm:NP:6445::::::
<span class="strong"><strong class="calibre8">(truncated output)</strong></span>
</pre></div><p class="calibre7">This has worked too!</p><div class="book" title="An overview of the recipe"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch07lvl3sec54" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">In this<a id="id983" class="calibre1"/> section, we learned how to use the <code class="email">pfexec</code> command, RBAC concepts, and least privileges concepts. Moreover, we have seen examples<a id="id984" class="calibre1"/> that explain how to apply these techniques in daily administration.</p></div></div></div>
<div class="book" title="References"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch07lvl1sec76" class="calibre1"/>References</h1></div></div></div><div class="book"><ul class="itemizedlist"><li class="listitem"><span class="strong"><em class="calibre11">RBAC Access Control</em></span> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/html/821-1456/rbac-1.html">http://docs.oracle.com/cd/E23824_01/html/821-1456/rbac-1.html</a></li><li class="listitem"><span class="strong"><em class="calibre11">Privileges</em></span> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/html/821-1456/prbac-2.html#scrolltoc">http://docs.oracle.com/cd/E23824_01/html/821-1456/prbac-2.html#scrolltoc</a></li><li class="listitem"><span class="strong"><em class="calibre11">Viewing and Using RBAC Defaults</em></span> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/html/821-1456/rbactask-new-1.html#scrolltoc">http://docs.oracle.com/cd/E23824_01/html/821-1456/rbactask-new-1.html#scrolltoc</a></li><li class="listitem"><span class="strong"><em class="calibre11">Customizing RBAC for Your Site</em></span> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/html/821-1456/rbactask-30.html#scrolltoc">http://docs.oracle.com/cd/E23824_01/html/821-1456/rbactask-30.html#scrolltoc</a></li><li class="listitem"><span class="strong"><em class="calibre11">Managing RBAC</em></span> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/html/821-1456/rbactask-4.html#scrolltoc">http://docs.oracle.com/cd/E23824_01/html/821-1456/rbactask-4.html#scrolltoc</a></li><li class="listitem"><span class="strong"><em class="calibre11">Using Privileges</em></span> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/html/821-1456/privtask-1.html#scrolltoc">http://docs.oracle.com/cd/E23824_01/html/821-1456/privtask-1.html#scrolltoc</a></li></ul></div></div></body></html>