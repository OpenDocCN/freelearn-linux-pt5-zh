<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops" xml:lang="en-US">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="packt"/>
<title>9 Access Control Lists and Shared Directory Management</title>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet1.css"/>
<link rel="stylesheet" type="text/css" href="../styles/stylesheet2.css"/>

</head>
<body>
<section id="access-control-lists-and-shared-directory-management" class="level1 pkt" data-number="10">
<h1 data-number="10">9 Access Control Lists and Shared Directory Management</h1>
<section id="join-our-book-community-on-discord-8" class="level2" data-number="10.1">
<h2 data-number="10.1">Join our book community on Discord</h2>
<p><a href="https://packt.link/SecNet">https://packt.link/SecNet</a></p>
<figure>
<img src="../media/file59.png" style="width:10em" />
</figure>
<p>In the previous chapter, we reviewed the basics of <strong>Discretionary Access Control</strong> (<strong>DAC</strong>). Normal Linux file and directory permissions settings aren't very granular. With an <strong>access control list</strong> (<strong>ACL</strong>), we can fine-tune things to get the exact set of permissions that we really want. We can also use this capability to control access to files in shared directories.</p>
<p>The topics in this chapter include the following:</p>
<ul>
<li>Creating an ACL for either a user or a group</li>
<li>Creating an inherited ACL for a directory</li>
<li>Removing a specific permission by using an ACL mask</li>
<li>Using the <code>tar --acls</code> option to prevent loss of ACLs during a backup</li>
<li>Creating a user group and adding members to it</li>
<li>Creating a shared directory for a group, and setting the proper permissions on it</li>
<li>Setting the SGID bit and the sticky bit on the shared directory</li>
<li>Using ACLs to allow only certain members of the group to access a file in the shared directory</li>
</ul>
</section>
<section id="creating-an-acl-for-either-a-user-or-a-group" class="level2" data-number="10.2">
<h2 data-number="10.2">Creating an ACL for either a user or a group</h2>
<p>The normal Linux file and directory permissions settings are okay, but they're not very granular. With an ACL, we can allow only a certain person to access a file or directory, or we can allow multiple people to access a file or directory with different permissions for each person. If we have a file or a directory that's wide open for everyone, we can use an ACL to allow different levels of access for either a group or an individual. Toward the end of the chapter, we'll put what we've learned all together in order to manage a shared directory for a group.</p>
<p>You would use <code>getfacl</code> to view an ACL for a file or directory. (Note that you can't use them to view all files in a directory at once.) To begin, let's use <code>getfacl</code> to see if we have any ACLs already set on the <code>acl_demo.txt</code> file:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ touch acl_demo.txt
[donnie@localhost ~]$ getfacl acl_demo.txt
# file: acl_demo.txt
# owner: donnie
# group: donnie
user::rw-
group::rw-
other::r--
[donnie@localhost ~]$</code></pre>
</div>
<p>All we see here are just the normal permissions settings, so there's no ACL.</p>
<p>The first step for setting an ACL is to remove all permissions from everyone except for the user of the file. That's because the default permissions settings allow members of the group to have read/write access, and others to have read access. So, setting an ACL without removing those permissions would be rather senseless:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ chmod 600 acl_demo.txt
[donnie@localhost ~]$ ls -l acl_demo.txt
-rw-------. 1 donnie donnie 0 Nov  9 14:37 acl_demo.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>When using <code>setfacl</code> to set an ACL, you can allow a user or a group to have any combination of read, write, or execute privileges. In our case, let's say that I want to let Maggie read the file and to prevent her from having write or execute privileges:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ setfacl -m u:maggie:r acl_demo.txt
[donnie@localhost ~]$ getfacl acl_demo.txt
# file: acl_demo.txt
# owner: donnie
# group: donnie
user::rw-
user:maggie:r--
group::---
mask::r--
other::---
[donnie@localhost ~]$ ls -l acl_demo.txt
-rw-r-----+ 1 donnie donnie 0 Nov  9 14:37 acl_demo.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>The <code>-m</code> option of <code>setfacl</code> means that we're about to modify the ACL. (Well, to <em>create</em> one in this case, but that's okay.) <code>u:</code> means that we're setting an ACL for a user. We then list the user's name, followed by another colon, and the list of permissions that we want to grant to this user. In this case, we're only allowing Maggie read access. We complete the command by listing the file to which we want to apply this ACL. The <code>getfacl</code> output shows that Maggie does indeed have read access. Finally, we see in the <code>ls -l</code> output that the group is listed as having read access, even though we've set the <code>600</code> permissions settings on this file. But, there's also a <code>+</code> sign, which tells us that the file has an ACL. When we set an ACL, the permissions for the ACL show up as group permissions in <code>ls -l</code>.</p>
<p>To take this a step further, let's say that I want Frank to have read/write access to this file:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ setfacl -m u:frank:rw acl_demo.txt
[donnie@localhost ~]$ getfacl acl_demo.txt
# file: acl_demo.txt
# owner: donnie
# group: donnie
user::rw-
user:maggie:r--
user:frank:rw-
group::---
mask::rw-
other::---
[donnie@localhost ~]$ ls -l acl_demo.txt
-rw-rw----+ 1 donnie donnie 0 Nov  9 14:37 acl_demo.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>So, we can have two or more different ACLs assigned to the same file. In the <code>ls -l</code> output, we see that we have <code>rw</code> permissions set for the group, which is really just a summary of permissions that we've set in the two ACLs.</p>
<p>We can set an ACL for group access by replacing <code>u:</code> with a <code>g:</code>:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ getfacl new_file.txt
# file: new_file.txt
# owner: donnie
# group: donnie
user::rw-
group::rw-
other::r--
[donnie@localhost ~]$ chmod 600 new_file.txt
[donnie@localhost ~]$ setfacl -m g:accounting:r new_file.txt
[donnie@localhost ~]$ getfacl new_file.txt
# file: new_file.txt
# owner: donnie
# group: donnie
user::rw-
group::---
group:accounting:r--
mask::r--
other::---
[donnie@localhost ~]$ ls -l new_file.txt
-rw-r-----+ 1 donnie donnie 0 Nov  9 15:06 new_file.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>Members of the <code>accounting</code> group now have read access to this file.</p>
</section>
<section id="creating-an-inherited-acl-for-a-directory" class="level2" data-number="10.3">
<h2 data-number="10.3">Creating an inherited ACL for a directory</h2>
<p>There may be times when you'll want all files that get created in a shared directory to have the same ACL. We can do that by applying an inherited ACL to the directory. Although, understand that even though this sounds like a cool idea, creating files in the normal way will cause files to have the read/write permissions set for the group, and the read permission set for others. So, if you're setting this up for a directory where users just create files normally, the best that you can hope to do is to create an ACL that adds either the write or execute permissions for someone. Either that or ensure that users set the <code>600</code> permissions settings on all files that they create, assuming that users really do need to restrict access to their files.</p>
<p>On the other hand, if you're creating a shell script that creates files in a specific directory, you can include <code>chmod</code> commands to ensure that the files get created with the restrictive permissions that are necessary to make your ACL work as intended.</p>
<p>To demo, let's create the <code>new_perm_dir</code> directory, and set the inherited ACL on it. I want to have read/write access for files that my shell script creates in this directory, and for Frank to have only read access. I don't want anyone else to be able to read any of these files:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ setfacl -m d:u:frank:r new_perm_dir
[donnie@localhost ~]$ ls -ld new_perm_dir
drwxrwxr-x+ 2 donnie donnie 26 Nov 12 13:16 new_perm_dir
[donnie@localhost ~]$ getfacl new_perm_dir
# file: new_perm_dir
# owner: donnie
# group: donnie
user::rwx
group::rwx
other::r-x
default:user::rwx
default:user:frank:r--
default:group::rwx
default:mask::rwx
default:other::r-x
[donnie@localhost ~]$</code></pre>
</div>
<p>All I had to do to make this an inherited ACL was to add <code>d:</code> before <code>u:frank</code>. I left the default permissions settings on the directory, which allows everyone read access to the directory. Next, I'll create the <code>donnie_script.sh</code> shell script, which will create a file within that directory, and that will set read/write permissions for only the user of the new files:</p>
<div class="C0-SHConPACKT">
<pre><code>#!/bin/bash
cd new_perm_dir
touch new_file.txt
chmod 600 new_file.txt
exit</code></pre>
</div>
<p>After making the script executable, I'll run it and view the results:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ ./donnie_script.sh
[donnie@localhost ~]$ cd new_perm_dir
[donnie@localhost new_perm_dir]$ ls -l
total 0
-rw-------+ 1 donnie donnie 0 Nov 12 13:16 new_file.txt
[donnie@localhost new_perm_dir]$ getfacl new_file.txt
# file: new_file.txt
# owner: donnie
# group: donnie
user::rw-
user:frank:r-- #effective:---
group::rwx #effective:---
mask::---
other::---
[donnie@localhost new_perm_dir]$</code></pre>
</div>
<p>So, <code>new_file.txt</code> got created with the correct permissions settings, and with an ACL that allows Frank to read it. (I know that this is a really simplified example, but you get the idea.)</p>
</section>
<section id="removing-a-specific-permission-by-using-an-acl-mask" class="level2" data-number="10.4">
<h2 data-number="10.4">Removing a specific permission by using an ACL mask</h2>
<p>You can remove an ACL from a file or directory with the <code>-x </code>option. Let's go back to the <code>acl_demo.txt</code> file that I created earlier, and remove the ACL for Maggie:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ setfacl -x u:maggie acl_demo.txt
[donnie@localhost ~]$ getfacl acl_demo.txt
# file: acl_demo.txt
# owner: donnie
# group: donnie
user::rw-
user:frank:rw-
group::---
mask::rw-
other::---
[donnie@localhost ~]$</code></pre>
</div>
<p>So, Maggie's ACL is gone. But, the <code>-x</code> option removes the entire ACL, even if that's not what you really want. If you have an ACL with multiple permissions set, you might just want to remove one permission, leaving the others. Here, we see that Frank still has his ACL that grants him read/write access. Let's now say that we want to remove the write permission, while still allowing him the read permission. For that, we'll need to apply a mask:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ setfacl -m m::r acl_demo.txt
[donnie@localhost ~]$ ls -l acl_demo.txt
-rw-r-----+ 1 donnie donnie 0 Nov  9 14:37 acl_demo.txt
[donnie@localhost ~]$ getfacl acl_demo.txt
# file: acl_demo.txt
# owner: donnie
# group: donnie
user::rw-
user:frank:rw-            #effective:r--
group::---
mask::r--
other::---
[donnie@localhost ~]$</code></pre>
</div>
<p><code>m::r</code> sets a read-only mask on the ACL. Running <code>getfacl</code> shows that Frank still has a read/write ACL, but the comment to the side shows his effective permissions to be read-only. So, Frank's write permission for the file is now gone. And, if we had ACLs set for other users, this mask would affect them the same way.</p>
</section>
<section id="using-the-tar---acls-option-to-prevent-the-loss-of-acls-during-a-backup" class="level2" data-number="10.5">
<h2 data-number="10.5">Using the tar --acls option to prevent the loss of ACLs during a backup</h2>
<p>If you ever need to use <code>tar</code> to create a backup of either a file or a last two files:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ cd perm_demo_dir
[donnie@localhost perm_demo_dir]$ ls -l
total 0
-rw-rw-r--. 1 donnie accounting 0 Nov  5 20:17 file1.txt
-rw-rw-r--. 1 donnie accounting 0 Nov  5 20:17 file2.txt
-rw-rw-r--. 1 donnie accounting 0 Nov  5 20:17 file3.txt
-rw-rw-r--. 1 donnie accounting 0 Nov  5 20:17 file4.txt
-rw-rw----+ 1 donnie donnie     0 Nov  9 15:19 frank_file.txt
-rw-rw----+ 1 donnie donnie     0 Nov 12 12:29 new_file.txt
[donnie@localhost perm_demo_dir]$</code></pre>
</div>
<p>Now, I'll do the backup without <code>--acls</code>:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost perm_demo_dir]$ cd
[donnie@localhost ~]$ tar cJvf perm_demo_dir_backup.tar.xz perm_demo_dir/
perm_demo_dir/
perm_demo_dir/file1.txt
perm_demo_dir/file2.txt
perm_demo_dir/file3.txt
perm_demo_dir/file4.txt
perm_demo_dir/frank_file.txt
perm_demo_dir/new_file.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>It looks good, right? Ah, but looks can be deceiving. Watch what happens when I delete the directory, and then restore it from the backup:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ rm -rf perm_demo_dir/
[donnie@localhost ~]$ tar xJvf perm_demo_dir_backup.tar.xz
perm_demo_dir/
. . .
[donnie@localhost ~]$ cd perm_demo_dir/
[donnie@localhost perm_demo_dir]$ ls -l
total 0
-rw-rw-r--. 1 donnie donnie 0 Nov 5 20:17 file1.txt
-rw-rw-r--. 1 donnie donnie 0 Nov 5 20:17 file2.txt
-rw-rw-r--. 1 donnie donnie 0 Nov 5 20:17 file3.txt
-rw-rw-r--. 1 donnie donnie 0 Nov 5 20:17 file4.txt
-rw-rw----. 1 donnie donnie 0 Nov 9 15:19 frank_file.txt
-rw-rw----. 1 donnie donnie 0 Nov 12 12:29 new_file.txt
[donnie@localhost perm_demo_dir]$</code></pre>
</div>
<p>I don't even have to use <code>getfacl</code> to see that the ACLs are gone from the <code>perm_demo_dir</code> directory and all of its files, because the <code>+</code> signs are now gone from them. Now, let's see what happens when I include the <code>--acls</code> option. First, I'll show you that an ACL is set for this directory and its only file:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ ls -ld new_perm_dir
drwxrwxr-x+ 2 donnie donnie 26 Nov 13 14:01 new_perm_dir
[donnie@localhost ~]$ ls -l new_perm_dir
total 0
-rw-------+ 1 donnie donnie 0 Nov 13 14:01 new_file.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>Now, I'll use the <code>tar</code> command with the <code>--acls</code> option:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ tar cJvf new_perm_dir_backup.tar.xz new_perm_dir/ --acls
new_perm_dir/
new_perm_dir/new_file.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>I'll now delete the <code>new_perm_dir</code> directory and restore it from backup. As we did before, we’ll use the <code>--acls</code> option:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ rm -rf new_perm_dir/
[donnie@localhost ~]$ tar xJvf new_perm_dir_backup.tar.xz --acls
new_perm_dir/
new_perm_dir/new_file.txt
[donnie@localhost ~]$ ls -ld new_perm_dir
drwxrwxr-x+ 2 donnie donnie 26 Nov 13 14:01 new_perm_dir
[donnie@localhost ~]$ ls -l new_perm_dir
total 0
-rw-------+ 1 donnie donnie 0 Nov 13 14:01 new_file.txt
[donnie@localhost ~]$</code></pre>
</div>
<p>The presence of the <code>+</code> signs indicates that the ACLs did survive the backup-and-restore procedure. The one slightly tricky part about this is that you must use <code>--acls</code> for both the backup and the restoration. If you omit the option either time, you will lose your ACLs.</p>
</section>
<section id="creating-a-user-group-and-adding-members-to-it" class="level2" data-number="10.6">
<h2 data-number="10.6">Creating a user group and adding members to it</h2>
<p>So far, I've been doing all of the demos inside my own home directory, just for the sake of showing the basic concepts. But the eventual goal is to show you how to use this knowledge to do something more practical, such as controlling file</p>
<p>Let's say that we want to create a <code>marketing</code> group for members of—you guessed it—the marketing department:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ sudo groupadd marketing
[sudo] password for donnie:
[donnie@localhost ~]$</code></pre>
</div>
<p>Let's now add some members. We can do that in three different ways:</p>
<ul>
<li>Add members as we create their user accounts.</li>
<li>Use <code>usermod</code> to add members that already have user accounts.</li>
<li>Edit the <code>/etc/group</code> file.</li>
</ul>
<section id="adding-members-as-we-create-their-user-accounts" class="level3" data-number="10.6.1">
<h3 data-number="10.6.1">Adding members as we create their user accounts</h3>
<p>First, we can add members to the group as we create their user accounts, using the <code>-G </code>option of <code>useradd</code>. On Red Hat, AlmaLinux, or CentOS, the command would look like this:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ sudo useradd -G marketing cleopatra
[sudo] password for donnie:
[donnie@localhost ~]$ groups cleopatra
cleopatra : cleopatra marketing
[donnie@localhost ~]$</code></pre>
</div>
<p>On Debian/Ubuntu, the command would look like this:</p>
<div class="C0-SHConPACKT">
<pre><code>donnie@ubuntu3:~$ sudo useradd -m -d /home/cleopatra -s /bin/bash -G marketing cleopatra
donnie@ubuntu3:~$ groups cleopatra
cleopatra : cleopatra marketing
donnie@ubuntu3:~$</code></pre>
</div>
<p>And, of course, I'll need to assign Cleopatra a password in the normal manner:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ sudo passwd cleopatra</code></pre>
</div>
</section>
<section id="using-usermod-to-add-an-existing-user-to-a-group" class="level3" data-number="10.6.2">
<h3 data-number="10.6.2">Using usermod to add an existing user to a group</h3>
<p>The good news is that this works the same on either Red Hat/CentOS/AlmaLinux or Debian/Ubuntu:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ sudo usermod -a -G marketing maggie
[sudo] password for donnie:
[donnie@localhost ~]$ groups maggie
maggie : maggie marketing
[donnie@localhost ~]$</code></pre>
</div>
<p>In this case, the <code>-a</code> wasn't necessary, because Maggie wasn't a member of any other secondary group. But, if she had already belonged to another group, the <code>-a</code> would have been necessary to keep from overwriting any existing group information, thus removing her from the previous groups.</p>
<p>This method is especially handy for use on Ubuntu systems, where it is necessary to use <code>adduser</code> in order to create encrypted home directories. (As we saw in a previous chapter, <code>adduser</code> doesn't give you the chance to add a user to a group as you create the account.)</p>
</section>
<section id="adding-users-to-a-group-by-editing-the-etcgroup-file" class="level3" data-number="10.6.3">
<h3 data-number="10.6.3">Adding users to a group by editing the /etc/group file</h3>
<p>This final method is a good way to cheat, to speed up the process of adding multiple existing users to a group. First, just open the <code>/etc/group</code> file in your favorite text editor, and look for the line that defines the group to which you want to add members:</p>
<div class="C0-SHConPACKT">
<pre><code>. . .
marketing:x:1005:cleopatra,maggie
. . .</code></pre>
</div>
<p>So, I've already added Cleopatra and Maggie to this group. Let's edit this to add a couple more members:</p>
<div class="C0-SHConPACKT">
<pre><code>. . .
marketing:x:1005:cleopatra,maggie,vicky,charlie
. . .</code></pre>
</div>
<p>When you're done, save the file and exit the editor.</p>
<p>A <code>groups</code> command for each of them will show that our wee bit of cheating works just fine:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost etc]$ sudo vim group
[donnie@localhost etc]$ groups vicky
vicky : vicky marketing
[donnie@localhost etc]$ groups charlie
charlie : charlie marketing
[donnie@localhost etc]$</code></pre>
</div>
<p>This method is extremely handy for whenever you need to add lots of members to a group at the same time.</p>
</section>
</section>
<section id="creating-a-shared-directory" class="level2" data-number="10.7">
<h2 data-number="10.7">Creating a shared directory</h2>
<p>The next act in our scenario involves creating a shared directory that all the members of our marketing department can use. Now, this is another one of those areas that engenders a bit of controversy. Some people like to put shared directories in the root level of the filesystem, while others like to put shared directories in the <code>/home/</code> directory. Some people even have other preferences. But really, it's a matter of personal preference and/or company policy. Other than that, it really doesn't much matter where you put them. For our purposes, to make things simple, I'll just create the directory in the root level of the filesystem:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost ~]$ cd /
[donnie@localhost /]$ sudo mkdir marketing
[sudo] password for donnie:
[donnie@localhost /]$ ls -ld marketing
drwxr-xr-x. 2 root root 6 Nov 13 15:32 marketing
[donnie@localhost /]$</code></pre>
</div>
<p>The new directory belongs to the root user. It has a permissions setting of <code>755</code>, which permits read and execute access to everybody, and write access only to the root user. What we really want is to allow only members of the marketing department to access this directory. We'll first change ownership and group association, and then we'll set the proper permissions:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ sudo chown nobody:marketing marketing
[donnie@localhost /]$ sudo chmod 770 marketing
[donnie@localhost /]$ ls -ld marketing
drwxrwx---. 2 nobody marketing 6 Nov 13 15:32 marketing
[donnie@localhost /]$</code></pre>
</div>
<p>In this case, we don't have any one particular user that we want to own the directory, and we don't really want the root user to own it. So, assigning ownership to the <code>nobody</code> pseudo-user account gives us a way to deal with that. I then assigned the <code>770</code> permissions value to the directory, which allows read/write/execute access to all <code>marketing</code> group members, while keeping everyone else out. Now, let's let one of our group members log in to see if she can create a file in this directory:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ su - vicky
Password:
[vicky@localhost ~]$ cd /marketing
[vicky@localhost marketing]$ touch vicky_file.txt
[vicky@localhost marketing]$ ls -l
total 0
-rw-rw-r--. 1 vicky vicky 0 Nov 13 15:41 vicky_file.txt
[vicky@localhost marketing]$</code></pre>
</div>
<p>Okay, it works, except for one minor problem. The file belongs to Vicky, as it should. But, it's also associated with Vicky's personal group. For the best access control of these shared files, we need them to be associated with the <code>marketing</code> group. Let’s take care of that next.</p>
</section>
<section id="setting-the-sgid-bit-and-the-sticky-bit-on-the-shared-directory" class="level2" data-number="10.8">
<h2 data-number="10.8">Setting the SGID bit and the sticky bit on the shared directory</h2>
<p>I've told you before that it's a bit of a security risk to set either the SUID or SGID permissions on files, especially on executable files. But it is both completely safe and very useful to set SGID on a shared directory.</p>
<p>SGID behavior on a directory is completely different from SGID behavior on a file. On a directory, SGID will cause any files that anybody creates to be associated with the same group with which the directory is associated. So, bearing in mind that the SGID permission value is <code>2000</code>, let's set SGID on our <code>marketing</code> directory:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ sudo chmod 2770 marketing
[sudo] password for donnie:
[donnie@localhost /]$ ls -ld marketing
drwxrws---. 2 nobody marketing 28 Nov 13 15:41 marketing
[donnie@localhost /]$</code></pre>
</div>
<p>The <code>s</code> in the executable position for the group indicates that the command was successful. Let's now let Vicky log back in to create another file:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ su - vicky
Password:
Last login: Mon Nov 13 15:41:19 EST 2017 on pts/0
[vicky@localhost ~]$ cd /marketing
[vicky@localhost marketing]$ touch vicky_file_2.txt
[vicky@localhost marketing]$ ls -l
total 0
-rw-rw-r--. 1 vicky marketing 0 Nov 13 15:57 vicky_file_2.txt
-rw-rw-r--. 1 vicky vicky     0 Nov 13 15:41 vicky_file.txt
[vicky@localhost marketing]$</code></pre>
</div>
<p>Vicky's second file is associated with the <code>marketing</code> group, which is just what we want. Just for fun, let's let Charlie do the same:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ su - charlie
Password:
[charlie@localhost ~]$ cd /marketing
[charlie@localhost marketing]$ touch charlie_file.txt
[charlie@localhost marketing]$ ls -l
total 0
-rw-rw-r--. 1 charlie marketing 0 Nov 13 15:59 charlie_file.txt
-rw-rw-r--. 1 vicky   marketing 0 Nov 13 15:57 vicky_file_2.txt
-rw-rw-r--. 1 vicky   vicky     0 Nov 13 15:41 vicky_file.txt
[charlie@localhost marketing]$</code></pre>
</div>
<p>Again, Charlie's file is associated with the <code>marketing</code> group. But, for some strange reason that nobody understands, Charlie really doesn't like Vicky and decides to delete her files, just out of pure spite:</p>
<div class="C0-SHConPACKT">
<pre><code>[charlie@localhost marketing]$ rm vicky*
rm: remove write-protected regular empty file ‘vicky_file.txt’? y
[charlie@localhost marketing]$ ls -l
total 0
-rw-rw-r--. 1 charlie marketing 0 Nov 13 15:59 charlie_file.txt
[charlie@localhost marketing]$</code></pre>
</div>
<p>The system complains that Vicky's original file is write-protected since it's still associated with her personal group. But the system does still allow Charlie to delete it, even without <code>sudo</code> privileges. And, since Charlie has write access to the second file, due to its association with the <code>marketing</code> group, the system allows him to delete it without question.</p>
<p>Okay. So, Vicky complains about this and tries to get Charlie fired. But our intrepid administrator has a better idea. He'll just set the sticky bit in order to keep this from happening again. Since the SGID bit has a value of <code>2000</code>, and the sticky bit has a value of <code>1000</code>, we can just add the two together to get a value of <code>3000</code>:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ sudo chmod 3770 marketing
[sudo] password for donnie:
[donnie@localhost /]$ ls -ld marketing
drwxrws--T. 2 nobody marketing 30 Nov 13 16:03 marketing
[donnie@localhost /]$</code></pre>
</div>
<p>The <code>T </code>in the executable position for others indicates that the sticky bit has been set. Since the <code>T </code>is uppercase, we know that the executable permission for others has not been set. Having the sticky bit set will prevent group members from deleting anybody else's files. Let's let Vicky show us what happens when she tries to retaliate against Charlie:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ su - vicky
Password:
Last login: Mon Nov 13 15:57:41 EST 2017 on pts/0
[vicky@localhost ~]$ cd /marketing
[vicky@localhost marketing]$ ls -l
total 0
-rw-rw-r--. 1 charlie marketing 0 Nov 13 15:59 charlie_file.txt
[vicky@localhost marketing]$ rm charlie_file.txt
rm: cannot remove ‘charlie_file.txt’: Operation not permitted
[vicky@localhost marketing]$ rm -f charlie_file.txt
rm: cannot remove ‘charlie_file.txt’: Operation not permitted
[vicky@localhost marketing]$ ls -l
total 0
-rw-rw-r--. 1 charlie marketing 0 Nov 13 15:59 charlie_file.txt
[vicky@localhost marketing]$</code></pre>
</div>
<p>Even with the <code>-f</code> option, Vicky still can't delete Charlie's file. Vicky doesn't have <code>sudo</code> privileges on this system, so it would be useless for her to try that.</p>
</section>
<section id="using-acls-to-access-files-in-the-shared-directory" class="level2" data-number="10.9">
<h2 data-number="10.9">Using ACLs to access files in the shared directory</h2>
<p>As things currently stand, all members of the <code>marketing</code> group have read/write access to all other group members' files. Restricting access to a file to only specific group members is the same two-step process that we've already covered.</p>
<section id="setting-the-permissions-and-creating-the-acl" class="level3" data-number="10.9.1">
<h3 data-number="10.9.1">Setting the permissions and creating the ACL</h3>
<p>First, Vicky sets the normal permissions to only allow herself to have read/write permissions on the file. Then, she’ll create an ACL that will allow Cleopatra to read the file:</p>
<div class="C0-SHConPACKT">
<pre><code>[vicky@localhost marketing]$ echo &quot;This file is only for my good friend, Cleopatra.&quot; &gt; vicky_file.txt
[vicky@localhost marketing]$ chmod 600 vicky_file.txt
[vicky@localhost marketing]$ setfacl -m u:cleopatra:r vicky_file.txt
[vicky@localhost marketing]$ ls -l
total 4
-rw-rw-r--. 1 charlie marketing 0 Nov 13 15:59 charlie_file.txt
-rw-r-----+ 1 vicky marketing 49 Nov 13 16:24 vicky_file.txt
[vicky@localhost marketing]$ getfacl vicky_file.txt
# file: vicky_file.txt
# owner: vicky
# group: marketing
user::rw-
user:cleopatra:r--
group::---
mask::r--
other::---
[vicky@localhost marketing]$</code></pre>
</div>
<p>There's nothing here that you haven't already seen. Vicky just removed all permissions from the group and from others and set an ACL that only allows Cleopatra to read the file. Let's see if Cleopatra actually can read it:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ su - cleopatra
Password:
[cleopatra@localhost ~]$ cd /marketing
[cleopatra@localhost marketing]$ ls -l
total 4
-rw-rw-r--. 1 charlie marketing 0 Nov 13 15:59 charlie_file.txt
-rw-r-----+ 1 vicky marketing 49 Nov 13 16:24 vicky_file.txt
[cleopatra@localhost marketing]$ cat vicky_file.txt
This file is only for my good friend, Cleopatra.
[cleopatra@localhost marketing]$</code></pre>
</div>
<p>So far, so good. But, can Cleopatra write to it? Let's take a look:</p>
<div class="C0-SHConPACKT">
<pre><code>[cleopatra@localhost marketing]$ echo &quot;You are my friend too, Vicky.&quot; &gt;&gt; vicky_file.txt
-bash: vicky_file.txt: Permission denied
[cleopatra@localhost marketing]$</code></pre>
</div>
<p>Cleopatra can't do that, since Vicky only allowed her the read privilege in the ACL.</p>
<p>Now though, what about that sneaky Charlie, who wants to go snooping in other users' files? Let's see if Charlie can do it:</p>
<div class="C0-SHConPACKT">
<pre><code>[donnie@localhost /]$ su - charlie
Password:
Last login: Mon Nov 13 15:58:56 EST 2017 on pts/0
[charlie@localhost ~]$ cd /marketing
[charlie@localhost marketing]$ cat vicky_file.txt
cat: vicky_file.txt: Permission denied
[charlie@localhost marketing]$</code></pre>
</div>
<p>So yes, it's really true that only Cleopatra can access Vicky's file, and even then only for reading.</p>
<section id="hands-on-lab-creating-a-shared-group-directory" class="level4" data-number="10.9.1.1">
<h4 data-number="10.9.1.1">Hands-on lab – creating a shared group directory</h4>
<p>For this lab, you'll just put together everything that you've learned in this chapter to create a shared directory for a group. You can do this on any of your virtual machines:</p>
<ol>
<li>On any virtual machine, create the <code>sales</code> group:</li>
</ol>
<div class="C1-SHConPACKT">
<pre><code>sudo groupadd sales</code></pre>
</div>
<ol>
<li>Create the users <code>mimi</code>, <code>mrgray</code>, and <code>mommy</code>, adding them to the <code>sales</code> group as you create the accounts.</li>
</ol>
<p>On CentOS or AlamaLinux, do this:</p>
<div class="C1-SHConPACKT">
<pre><code>sudo useradd -G sales mimi
sudo useradd -G sales mrgray
sudo useradd -G sales mommy</code></pre>
</div>
<p>On Ubuntu, do this:</p>
<div class="C1-SHConPACKT">
<pre><code>sudo useradd -m -d /home/mimi -s /bin/bash -G sales mimi
sudo useradd -m -d /home/mrgray -s /bin/bash -G sales mrgray
sudo useradd -m -d /home/mommy -s /bin/bash -G sales mommy</code></pre>
</div>
<ol>
<li>Assign each user a password.</li>
<li>Create the <code>sales</code> directory in the root level of the filesystem. Set proper ownership and permissions, including the SGID and sticky bits:</li>
</ol>
<div class="C1-SHConPACKT">
<pre><code>sudo mkdir /sales
sudo chown nobody:sales /sales
sudo chmod 3770 /sales
ls -ld /sales</code></pre>
</div>
<ol>
<li>Log in as Mimi, and have her create a file:</li>
</ol>
<div class="C1-SHConPACKT">
<pre><code>su - mimi
cd /sales
echo &quot;This file belongs to Mimi.&quot; &gt; mimi_file.txt
ls -l</code></pre>
</div>
<ol>
<li>Have Mimi set an ACL on her file, allowing only Mr. Gray to read it. Then, have Mimi log back out:</li>
</ol>
<div class="C1-SHConPACKT">
<pre><code>chmod 600 mimi_file.txt
setfacl -m u:mrgray:r mimi_file.txt
getfacl mimi_file.txt
ls -l
exit</code></pre>
</div>
<ol>
<li>Have Mr. Gray log in to see what he can do with Mimi's file. Then, have Mr. Gray create his own file and log back out:</li>
</ol>
<div class="C1-SHConPACKT">
<pre><code>su - mrgray
cd /sales
cat mimi_file.txt
echo &quot;I want to add something to this file.&quot; &gt;&gt; mimi_file.txt    
echo &quot;Mr. Gray will now create his own file.&quot; &gt; mr_gray_file.txt        
ls -l
exit</code></pre>
</div>
<ol>
<li>Mommy will now log in and try to wreak havoc by snooping in other users' files and by trying to delete them:</li>
</ol>
<div class="C1-SHConPACKT">
<pre><code>su - mommy
cat mimi_file.txt
cat mr_gray_file.txt
rm -f mimi_file.txt
rm -f mr_gray_file.txt
exit</code></pre>
</div>
<ol>
<li>End of lab.</li>
</ol>
</section>
</section>
</section>
<section id="summary-8" class="level2" data-number="10.10">
<h2 data-number="10.10">Summary</h2>
<p>In this chapter, we saw how to take DAC to the proverbial next level. We first saw how to create and manage ACLs to provide more fine-grained access control over files and directories. We then saw how to create a user group for a specific purpose, and how to add members to it. Then, we saw how we can use the SGID bit, the sticky bit, and ACLs to manage a shared group directory.</p>
<p>But sometimes, DAC might not be enough to do the job. For those times, we also have mandatory access control, which we'll cover in the next chapter. I'll see you there.</p>
</section>
<section id="questions-8" class="level2" data-number="10.11">
<h2 data-number="10.11">Questions</h2>
<ol>
<li>When creating an ACL for a file in a shared directory, what must you first do to make the ACL effective?</li>
</ol>
<p>A. Remove all normal permissions from the file for everyone except for the user.</p>
<p>B. Ensure that the file has the permissions value of <code>644</code> set.</p>
<p>C. Ensure that everyone in the group has read/write permissions for the file.</p>
<p>D. Ensure that the SUID permission is set for the file.</p>
<ol>
<li>What is the benefit of setting the SGID permission on a shared group directory?</li>
</ol>
<p>A. None. It's a security risk and should never be done.</p>
<p>B. It prevents members of the group from deleting each others' files.</p>
<p>C. It makes it so that each file that gets created within the directory will be associated with the group that's also associated with the directory.</p>
<p>D. It gives anyone who accesses the directory the same privileges as the user of the directory.</p>
<ol>
<li>Which of the following commands would set the proper permissions for the <code>marketing</code> shared group directory, with the SGID and sticky bit set?</li>
</ol>
<p>A. <strong>sudo chmod 6770 marketing</strong></p>
<p>B. <strong>sudo chmod 3770 marketing</strong></p>
<p>C. <strong>sudo chmod 2770 marketing</strong></p>
<p>D. <strong>sudo chmod 1770 marketing</strong></p>
<ol>
<li>Which of the following <code>setfacl</code> options would you use to just remove one specific permission from an ACL?</li>
</ol>
<p>A. <code>-xB. -r</code></p>
<p>C. <code>-w</code></p>
<p>D. <code>m: :</code></p>
<p>E. <code>-m</code></p>
<p>F. <code>x: :</code></p>
<ol>
<li>Which of the following statements is true?</li>
</ol>
<p>A. When using <code>tar</code>, you must use the <code>--acls</code> option for both archive creation and extraction, in order to preserve the ACLs on the archived files.</p>
<p>B. When using <code>tar</code>, you need to use the <code>--acls</code> option only for archive creation in order to preserve the ACLs on the archived files.</p>
<p>C. When using <code>tar</code>, ACLs are automatically preserved on archived files.</p>
<p>D. When using <code>tar</code>, it's not possible to preserve ACLs on archived files.</p>
<ol>
<li>Which two of the following are <em>not</em> a valid method for adding the user Lionel to the <code>sales</code> group?</li>
</ol>
<p>A. <strong>sudo useradd -g sales lionel</strong></p>
<p>B. <strong>sudo useradd -G sales lionel</strong></p>
<p>C. <strong>sudo usermod -g sales lionel</strong></p>
<p>D. <strong>sudo usermod -G sales lionel</strong></p>
<p>E. By hand-editing the <code>/etc/group</code> file.</p>
<ol>
<li>What happens when you create an inherited ACL?</li>
</ol>
<p>A. Every file that gets created in the directory with that inherited ACL will be associated with the group that's associated with that directory.</p>
<p>B. Every file that gets created in the directory with that inherited ACL will inherit that ACL.</p>
<p>C. Every file that gets created in that directory with that inherited ACL will have the same permissions settings as the directory.</p>
<p>D. Every file that gets created in that directory will have the sticky bit set.</p>
<ol>
<li>Which of the following commands would you use to grant read-only privilege on a file to the user Frank?</li>
</ol>
<p>A. <strong>chattr -m u:frank:r somefile.txt</strong></p>
<p>B. <strong>aclmod -m u:frank:r somefile.txt</strong></p>
<p>C. <strong>getfacl -m u:frank:r somefile.txt</strong></p>
<p>D. <strong>setfacl -m u:frank:r somefile.txt</strong></p>
<ol>
<li>You've just done an <code>ls -l</code> command in a shared group directory. How can you tell from that whether an ACL has been set for any of the files?</li>
</ol>
<p>A. Files with an ACL set will have <code>+</code> at the beginning of the permissions settings.</p>
<p>B. Files with an ACL set will have <code>-</code> at the beginning of the permissions settings.</p>
<p>C. Files with an ACL set will have <code>+</code> at the end of the permissions settings.</p>
<p>D. Files with an ACL set will have <code>-</code> at the end of the permissions settings.</p>
<p>E. The <code>ls -l</code> command will show the ACL for that file.</p>
<ol>
<li>Which of the following would you use to view the ACL on the <code>somefile.txt</code> file?</li>
</ol>
<p>A. <strong>getfacl somefile.txt</strong></p>
<p>B. <strong>ls -l somefile.txt</strong></p>
<p>C. <strong>ls -a somefile.txt</strong></p>
<p>D. <strong>viewacl somefile.txt</strong></p>
</section>
<section id="further-reading-8" class="level2" data-number="10.12">
<h2 data-number="10.12">Further reading</h2>
<ul>
<li>How to create users and groups from the Linux command line: <a href="https://www.techrepublic.com/article/how-to-create-users-and-groups-in-linux-from-the-command-line/">https://www.techrepublic.com/article/how-to-create-users-and-groups-in-linux-from-the-command-line/</a></li>
<li>Add a user to a group: <a href="https://www.howtogeek.com/50787/add-a-user-to-a-group-or-second-group-on-linux/">https://www.howtogeek.com/50787/add-a-user-to-a-group-or-second-group-on-linux/</a></li>
<li>SGID on directories: <a href="https://www.toptip.ca/2010/03/linux-setgid-on-directory.html">https://www.toptip.ca/2010/03/linux-setgid-on-directory.html</a></li>
<li>What a sticky bit is and how to set it in Linux: <a href="https://www.linuxnix.com/sticky-bit-set-linux/">https://www.linuxnix.com/sticky-bit-set-linux/</a></li>
</ul>
</section>
<section id="answers-6" class="level2" data-number="10.13">
<h2 data-number="10.13">Answers</h2>
<ol>
<li>A</li>
<li>C</li>
<li>B</li>
<li>D</li>
<li>A</li>
<li>A, C</li>
<li>B</li>
<li>D</li>
<li>C</li>
<li>A</li>
</ol>
</section>
</section>
</body>
</html>
