<html><head></head><body>
<div id="_idContainer404">
<h1 class="chapter-number" id="_idParaDest-214"><a id="_idTextAnchor231"/><span class="koboSpan" id="kobo.1.1">11</span></h1>
<h1 id="_idParaDest-215"><a id="_idTextAnchor232"/><span class="koboSpan" id="kobo.2.1">Working with Virtual Machines</span></h1>
<p><span class="koboSpan" id="kobo.3.1">In this chapter, you will learn about </span><strong class="bold"><span class="koboSpan" id="kobo.4.1">virtual machines</span></strong><span class="koboSpan" id="kobo.5.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.6.1">VMs</span></strong><span class="koboSpan" id="kobo.7.1">) on Linux. </span><span class="koboSpan" id="kobo.7.2">For starters, you will learn how virtualization works and how to create and use VMs. </span><span class="koboSpan" id="kobo.7.3">You will learn about one of the most widely used virtualization and hypervisor technologies on Linux, called </span><strong class="bold"><span class="koboSpan" id="kobo.8.1">Kernel-based Virtual Machine</span></strong><span class="koboSpan" id="kobo.9.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.10.1">KVM</span></strong><span class="koboSpan" id="kobo.11.1">). </span><span class="koboSpan" id="kobo.11.2">The topics in this chapter will prepare you for the future of Linux, as it is the foundation of every modern cloud technology. </span><span class="koboSpan" id="kobo.11.3">If you wish to remain up to date in a constantly changing landscape, this chapter will be an essential starting point for </span><span class="No-Break"><span class="koboSpan" id="kobo.12.1">your journey.</span></span></p>
<p><span class="koboSpan" id="kobo.13.1">In this chapter, we’re going to cover the following </span><span class="No-Break"><span class="koboSpan" id="kobo.14.1">main topics:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.15.1">Introduction to virtualization </span><span class="No-Break"><span class="koboSpan" id="kobo.16.1">on Linux</span></span></li>
<li><span class="koboSpan" id="kobo.17.1">Understanding </span><span class="No-Break"><span class="koboSpan" id="kobo.18.1">Linux KVM</span></span></li>
<li><span class="koboSpan" id="kobo.19.1">Working with basic </span><span class="No-Break"><span class="koboSpan" id="kobo.20.1">KVM commands</span></span></li>
<li><span class="koboSpan" id="kobo.21.1">Advanced </span><span class="No-Break"><span class="koboSpan" id="kobo.22.1">KVM management</span></span></li>
<li><span class="koboSpan" id="kobo.23.1">Provisioning VMs </span><span class="No-Break"><span class="koboSpan" id="kobo.24.1">using cloud-init</span></span></li>
<li><span class="koboSpan" id="kobo.25.1">Public key authentication </span><span class="No-Break"><span class="koboSpan" id="kobo.26.1">with SSH</span></span></li>
</ul>
<h1 id="_idParaDest-216"><a id="_idTextAnchor233"/><span class="koboSpan" id="kobo.27.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.28.1">No special technical requirements are needed, just a working installation of Linux on your system. </span><span class="koboSpan" id="kobo.28.2">We will mainly use Debian GNU/Linux 12 for our examples, but we will also show you how to install KVM in Fedora </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">and openSUSE.</span></span></p>
<h1 id="_idParaDest-217"><a id="_idTextAnchor234"/><span class="koboSpan" id="kobo.30.1">Introduction to virtualization on Linux</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.31.1">Virtualization</span></strong> <a id="_idIndexMarker1717"/><span class="koboSpan" id="kobo.32.1">is a way to </span><a id="_idIndexMarker1718"/><span class="koboSpan" id="kobo.33.1">make more efficient use of computer hardware. </span><span class="koboSpan" id="kobo.33.2">It is basically an abstraction layer that takes advantage of the computer’s resources. </span><span class="koboSpan" id="kobo.33.3">In this section, you will learn about the types of VMs, how they work on Linux, and how to deploy and </span><span class="No-Break"><span class="koboSpan" id="kobo.34.1">manage them.</span></span></p>
<h2 id="_idParaDest-218"><a id="_idTextAnchor235"/><span class="koboSpan" id="kobo.35.1">Efficiency in resource usage</span></h2>
<p><span class="koboSpan" id="kobo.36.1">The abstraction </span><a id="_idIndexMarker1719"/><span class="koboSpan" id="kobo.37.1">layer that virtualization uses is a software layer that allows more efficient use of all the computer’s components. </span><span class="koboSpan" id="kobo.37.2">This in turn allows better use of all the physical machine’s capabilities </span><span class="No-Break"><span class="koboSpan" id="kobo.38.1">and resources.</span></span></p>
<p><span class="koboSpan" id="kobo.39.1">Before going any further into</span><a id="_idIndexMarker1720"/><span class="koboSpan" id="kobo.40.1"> virtualization, let’s give you an example. </span><span class="koboSpan" id="kobo.40.2">In our testing laboratory, we have several physical machines, in the form of laptops and small form factor desktop computers (Intel NUCs) that we use as servers. </span><span class="koboSpan" id="kobo.40.3">Each of the systems has significant resources available, more than enough to run the services we need. </span><span class="koboSpan" id="kobo.40.4">For instance, our least performant systems are a 5th-generation Intel NUC with an Intel i3 CPU with four processing cores and 16 GB of RAM and a 7th-generation Intel NUC with a four-core Intel Pentium and 12 GB of RAM. </span><span class="koboSpan" id="kobo.40.5">Those two systems have plenty of resources that could be more efficiently used by </span><span class="No-Break"><span class="koboSpan" id="kobo.41.1">using VMs.</span></span></p>
<p><span class="koboSpan" id="kobo.42.1">For running a local web service or any kind of server on our local network, those resources can be split between various VMs with ease. </span><span class="koboSpan" id="kobo.42.2">For example, each physical system could host four different VMs, each using a single CPU core, and at least 2 GB of memory and all the necessary storage capacities. </span><span class="koboSpan" id="kobo.42.3">This way, one single machine will work as if there were four different ones. </span><span class="koboSpan" id="kobo.42.4">This is way more efficient than using individual machines for </span><span class="No-Break"><span class="koboSpan" id="kobo.43.1">separate tasks.</span></span></p>
<p><span class="koboSpan" id="kobo.44.1">In the following diagram, we are comparing the load on a single computer versus the same load divided between several VMs. </span><span class="koboSpan" id="kobo.44.2">This way of using the same hardware resources is </span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">more efficient:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer380">
<span class="koboSpan" id="kobo.46.1"><img alt="Figure 11.1 – Comparison between single computer use and using multiple VMs" src="image/B19682_11_1.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.47.1">Figure 11.1 – Comparison between single computer use and using multiple VMs</span></p>
<p><span class="koboSpan" id="kobo.48.1">Nonetheless, as we will use the hypervisor on top of a host OS, we will have to keep some resources for the OS’s </span><a id="_idIndexMarker1721"/><span class="koboSpan" id="kobo.49.1">use, so the number of VMs will be smaller. </span><span class="koboSpan" id="kobo.49.2">Here is a diagram of how the VMs work on a </span><span class="No-Break"><span class="koboSpan" id="kobo.50.1">host OS:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer381">
<span class="koboSpan" id="kobo.51.1"><img alt="Figure 11.2 – How virtualization works on a host OS" src="image/B19682_11_2.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.52.1">Figure 11.2 – How virtualization works on a host OS</span></p>
<p><span class="koboSpan" id="kobo.53.1">The preceding diagram shows the scheme of how virtualization works when used on a host OS. </span><span class="koboSpan" id="kobo.53.2">As we will see in the following sections, it is not the only type </span><span class="No-Break"><span class="koboSpan" id="kobo.54.1">of virtualization.</span></span></p>
<p><span class="koboSpan" id="kobo.55.1">It is important to note that efficiency is not related </span><a id="_idIndexMarker1722"/><span class="koboSpan" id="kobo.56.1">solely to the hardware resources used. </span><span class="koboSpan" id="kobo.56.2">A significant aspect of the efficient use of hardware in data centers is related to increased energy efficiency and a reduction of the carbon footprint. </span><span class="koboSpan" id="kobo.56.3">In this respect, virtualization</span><a id="_idIndexMarker1723"/><span class="koboSpan" id="kobo.57.1"> has played a major role for many decades in changing the usage patterns of servers inside data centers. </span><span class="koboSpan" id="kobo.57.2">Overall, virtualization and containerization are significant players in the fight against </span><span class="No-Break"><span class="koboSpan" id="kobo.58.1">climate change.</span></span></p>
<p><span class="koboSpan" id="kobo.59.1">In the following sections, we will give you a short introduction to hypervisors </span><span class="No-Break"><span class="koboSpan" id="kobo.60.1">and VMs.</span></span></p>
<h2 id="_idParaDest-219"><a id="_idTextAnchor236"/><span class="koboSpan" id="kobo.61.1">Introduction to hypervisors</span></h2>
<p><span class="koboSpan" id="kobo.62.1">The software layer </span><a id="_idIndexMarker1724"/><span class="koboSpan" id="kobo.63.1">that virtualization</span><a id="_idIndexMarker1725"/><span class="koboSpan" id="kobo.64.1"> is based on is called a </span><strong class="bold"><span class="koboSpan" id="kobo.65.1">hypervisor</span></strong><span class="koboSpan" id="kobo.66.1">. </span><span class="koboSpan" id="kobo.66.2">The physical resources are divided and used as virtual computers, better </span><a id="_idIndexMarker1726"/><span class="koboSpan" id="kobo.67.1">known as VMs. </span><span class="koboSpan" id="kobo.67.2">By using VMs, the limits of physical hardware are overcome by the </span><a id="_idIndexMarker1727"/><span class="koboSpan" id="kobo.68.1">process of </span><strong class="bold"><span class="koboSpan" id="kobo.69.1">emulation</span></strong><span class="koboSpan" id="kobo.70.1">. </span><span class="koboSpan" id="kobo.70.2">This has a lot of advantages, enabling the hardware to be used </span><span class="No-Break"><span class="koboSpan" id="kobo.71.1">more effectively.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.72.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.73.1">The process of emulation is basically an imitation process through which a piece of software replicates (or imitates) the functions of another system. </span><span class="koboSpan" id="kobo.73.2">In our case, the hypervisor (the virtualization software layer) is simulating the use of hardware as if it were a different system altogether. </span><span class="koboSpan" id="kobo.73.3">This allows the hardware resources a computer has to be used </span><span class="No-Break"><span class="koboSpan" id="kobo.74.1">more effectively.</span></span></p>
<p><span class="koboSpan" id="kobo.75.1">Hypervisors can be used either on top of an existing OS (</span><em class="italic"><span class="koboSpan" id="kobo.76.1">type 2</span></em><span class="koboSpan" id="kobo.77.1">) or directly on bare metal (hardware) (</span><em class="italic"><span class="koboSpan" id="kobo.78.1">type 1</span></em><span class="koboSpan" id="kobo.79.1">). </span><span class="koboSpan" id="kobo.79.2">For each of these types, there are various solutions that can be used, particularly on Linux. </span><span class="koboSpan" id="kobo.79.3">For a Linux OS, examples of each type are </span><span class="No-Break"><span class="koboSpan" id="kobo.80.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.81.1">Examples of hypervisors that run on top of a host OS (type 2) are Oracle VirtualBox and </span><span class="No-Break"><span class="koboSpan" id="kobo.82.1">VMware Workstation/Fusion</span></span></li>
<li><span class="koboSpan" id="kobo.83.1">Examples of hypervisors that run directly on bare metal (type 1) are Citrix Xen Server and </span><span class="No-Break"><span class="koboSpan" id="kobo.84.1">VMware ESXi</span></span></li>
<li><span class="koboSpan" id="kobo.85.1">KVM is mostly classified </span><a id="_idIndexMarker1728"/><span class="koboSpan" id="kobo.86.1">as a bare-metal hypervisor (type 1), while its underlying system is a full OS, thus it is classified as a host </span><a id="_idIndexMarker1729"/><span class="koboSpan" id="kobo.87.1">hypervisor</span><a id="_idIndexMarker1730"/><span class="koboSpan" id="kobo.88.1"> at the same time (</span><span class="No-Break"><span class="koboSpan" id="kobo.89.1">type 2)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.90.1">In this chapter, we will exclusively use KVM as the hypervisor </span><span class="No-Break"><span class="koboSpan" id="kobo.91.1">of choice.</span></span></p>
<h1 id="_idParaDest-220"><a id="_idTextAnchor237"/><span class="koboSpan" id="kobo.92.1">Understanding Linux KVMs</span></h1>
<p><span class="koboSpan" id="kobo.93.1">A VM is similar to a standalone computer. </span><span class="koboSpan" id="kobo.93.2">It is a software-based emulator that has access to the host computer’s resources. </span><span class="koboSpan" id="kobo.93.3">It uses the host’s CPU, RAM, storage, networking interface(s), and ports. </span><span class="koboSpan" id="kobo.93.4">Not only that, but it is a virtual environment that has</span><a id="_idIndexMarker1731"/><span class="koboSpan" id="kobo.94.1"> the same functions as a physical computer; it is also seen as a </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">virtual computer.</span></span></p>
<p><span class="koboSpan" id="kobo.96.1">The resources for each VM are managed by the hypervisor. </span><span class="koboSpan" id="kobo.96.2">It can relocate resources between existing VMs or create new VMs. </span><span class="koboSpan" id="kobo.96.3">The VMs are isolated from each other and from the host computer. </span><span class="koboSpan" id="kobo.96.4">As multiple VMs can exist on a single computer, each VM can use different guest OSes. </span><span class="koboSpan" id="kobo.96.5">For example, if you use a Windows machine and want to try out Linux, a popular solution would be to create a VM with the Linux distribution that you want to try. </span><span class="koboSpan" id="kobo.96.6">The same goes for Mac users, too. </span><span class="koboSpan" id="kobo.96.7">An OS installed inside a VM runs similarly to an OS installed on bare metal. </span><span class="koboSpan" id="kobo.96.8">The user experience could vary from one hypervisor to the other, and so could the resource efficiency and response times. </span><span class="koboSpan" id="kobo.96.9">From our experience, we prefer running VMs from KVM rather than running from any other hypervisor, mainly because</span><a id="_idIndexMarker1732"/><span class="koboSpan" id="kobo.97.1"> of the comprehensive </span><strong class="bold"><span class="koboSpan" id="kobo.98.1">command-line interface</span></strong><span class="koboSpan" id="kobo.99.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.100.1">CLI</span></strong><span class="koboSpan" id="kobo.101.1">). </span><span class="koboSpan" id="kobo.101.2">However, use cases could be different from one user </span><span class="No-Break"><span class="koboSpan" id="kobo.102.1">to another.</span></span></p>
<h2 id="_idParaDest-221"><a id="_idTextAnchor238"/><span class="koboSpan" id="kobo.103.1">Choosing the hypervisor</span></h2>
<p><span class="koboSpan" id="kobo.104.1">In this chapter, we</span><a id="_idIndexMarker1733"/><span class="koboSpan" id="kobo.105.1"> chose the KVM hypervisor. </span><span class="koboSpan" id="kobo.105.2">As an optional solution, if you use the GNOME desktop environment, you will have access to GNOME Boxes. </span><span class="koboSpan" id="kobo.105.3">As both KVM and GNOME Boxes are directly available from Linux repositories, we consider them to be the better solutions for newcomers to Linux. </span><span class="koboSpan" id="kobo.105.4">Both KVM and GNOME Boxes share parts of </span><strong class="source-inline"><span class="koboSpan" id="kobo.106.1">libvirt</span></strong><span class="koboSpan" id="kobo.107.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.108.1">qemu</span></strong><span class="koboSpan" id="kobo.109.1"> code (to be detailed in the next section), and in this respect, we consider them to both be the same hypervisor, which </span><span class="No-Break"><span class="koboSpan" id="kobo.110.1">is KVM.</span></span></p>
<p><span class="koboSpan" id="kobo.111.1">In </span><a href="B19682_01.xhtml#_idTextAnchor030"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.112.1">Chapter 1</span></em></span></a><span class="koboSpan" id="kobo.113.1">, </span><em class="italic"><span class="koboSpan" id="kobo.114.1">Installing Linux</span></em><span class="koboSpan" id="kobo.115.1">, you first encountered the use of a hypervisor to set up a Linux VM. </span><span class="koboSpan" id="kobo.115.2">We showed you how to use VMware solutions and VirtualBox to set up a Linux VM. </span><span class="koboSpan" id="kobo.115.3">The details used then should be sufficient for any user, whether they are experienced or a newbie. </span><span class="koboSpan" id="kobo.115.4">VirtualBox has several features that make it a fair candidate for your</span><a id="_idIndexMarker1734"/><span class="koboSpan" id="kobo.116.1"> hypervisor solution, but in our opinion, it still lacks the finesse of KVM. </span><span class="koboSpan" id="kobo.116.2">In the next section, we will walk you </span><span class="No-Break"><span class="koboSpan" id="kobo.117.1">through KVM.</span></span></p>
<h2 id="_idParaDest-222"><a id="_idTextAnchor239"/><span class="koboSpan" id="kobo.118.1">Using the KVM hypervisor</span></h2>
<p><span class="koboSpan" id="kobo.119.1">The KVM </span><a id="_idIndexMarker1735"/><span class="koboSpan" id="kobo.120.1">hypervisor is an open source virtualization project available on all major Linux distributions. </span><span class="koboSpan" id="kobo.120.2">It is a modern hypervisor that uses specific kernel modules to take </span><a id="_idIndexMarker1736"/><span class="koboSpan" id="kobo.121.1">advantage of all the benefits that the Linux kernel has to offer, including memory support, scheduler, nested virtualization, GPU pass-through, and </span><span class="No-Break"><span class="koboSpan" id="kobo.122.1">so on.</span></span></p>
<h3><span class="koboSpan" id="kobo.123.1">KVM in detail – QEMU and libvirt</span></h3>
<p><span class="koboSpan" id="kobo.124.1">KVM uses </span><strong class="bold"><span class="koboSpan" id="kobo.125.1">Quick Emulator</span></strong><span class="koboSpan" id="kobo.126.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.127.1">QEMU</span></strong><span class="koboSpan" id="kobo.128.1">) as the </span><a id="_idIndexMarker1737"/><span class="koboSpan" id="kobo.129.1">emulator software for all the hardware components and peripherals. </span><span class="koboSpan" id="kobo.129.2">The main management tool and daemon that controls the hypervisor </span><a id="_idIndexMarker1738"/><span class="koboSpan" id="kobo.130.1">and also the </span><strong class="bold"><span class="koboSpan" id="kobo.131.1">Application Programming Interface</span></strong><span class="koboSpan" id="kobo.132.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.133.1">API</span></strong><span class="koboSpan" id="kobo.134.1">) for KVM is </span><a id="_idIndexMarker1739"/><span class="koboSpan" id="kobo.135.1">called </span><strong class="source-inline"><span class="koboSpan" id="kobo.136.1">libvirt</span></strong><span class="koboSpan" id="kobo.137.1">. </span><span class="koboSpan" id="kobo.137.2">The KVM’s interface with </span><strong class="source-inline"><span class="koboSpan" id="kobo.138.1">libvirt</span></strong><span class="koboSpan" id="kobo.139.1">, specifically in GNOME, is </span><strong class="source-inline"><span class="koboSpan" id="kobo.140.1">virt-manager</span></strong><span class="koboSpan" id="kobo.141.1">. </span><span class="koboSpan" id="kobo.141.2">The CLI </span><a id="_idIndexMarker1740"/><span class="koboSpan" id="kobo.142.1">for </span><strong class="source-inline"><span class="koboSpan" id="kobo.143.1">libvirt</span></strong><span class="koboSpan" id="kobo.144.1"> is </span><span class="No-Break"><span class="koboSpan" id="kobo.145.1">called </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.146.1">virsh</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.147.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.148.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.149.1">libvirt</span></strong><span class="koboSpan" id="kobo.150.1"> API provides a </span><a id="_idIndexMarker1741"/><span class="koboSpan" id="kobo.151.1">common library for managing VMs. </span><span class="koboSpan" id="kobo.151.2">It is the management layer for VM creation, modification, and provision. </span><span class="koboSpan" id="kobo.151.3">It is running in the </span><a id="_idIndexMarker1742"/><span class="koboSpan" id="kobo.152.1">background as a daemon </span><a id="_idIndexMarker1743"/><span class="koboSpan" id="kobo.153.1">called </span><strong class="source-inline"><span class="koboSpan" id="kobo.154.1">libvirtd</span></strong><span class="koboSpan" id="kobo.155.1"> that manages </span><a id="_idIndexMarker1744"/><span class="koboSpan" id="kobo.156.1">the connections with the hypervisor at the </span><span class="No-Break"><span class="koboSpan" id="kobo.157.1">client’s request.</span></span></p>
<p><span class="koboSpan" id="kobo.158.1">QEMU is both an emulator and a virtualizer. </span><span class="koboSpan" id="kobo.158.2">When used as an emulator, QEMU </span><a id="_idIndexMarker1745"/><span class="koboSpan" id="kobo.159.1">uses </span><strong class="bold"><span class="koboSpan" id="kobo.160.1">dynamic binary translation</span></strong><span class="koboSpan" id="kobo.161.1"> methods to operate. </span><span class="koboSpan" id="kobo.161.2">This means that it can use different types of OS on the host machine, even if they are designed for different architectures. </span><span class="koboSpan" id="kobo.161.3">Dynamic binary translations are used in </span><strong class="bold"><span class="koboSpan" id="kobo.162.1">software-based virtualization</span></strong><span class="koboSpan" id="kobo.163.1">, where hardware</span><a id="_idIndexMarker1746"/><span class="koboSpan" id="kobo.164.1"> is emulated to execute instructions in virtualized environments. </span><span class="koboSpan" id="kobo.164.2">This way, QEMU emulates the machine’s CPU, using a specific binary translator </span><a id="_idIndexMarker1747"/><span class="koboSpan" id="kobo.165.1">method called </span><strong class="bold"><span class="koboSpan" id="kobo.166.1">Tiny Code Generator</span></strong><span class="koboSpan" id="kobo.167.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.168.1">TCG</span></strong><span class="koboSpan" id="kobo.169.1">), which transforms the binary code for different types </span><span class="No-Break"><span class="koboSpan" id="kobo.170.1">of architectures.</span></span></p>
<p><span class="koboSpan" id="kobo.171.1">When used as a virtualizer, QEMU uses what is known as a </span><strong class="bold"><span class="koboSpan" id="kobo.172.1">hardware-based virtualization</span></strong><span class="koboSpan" id="kobo.173.1">, where the binary</span><a id="_idIndexMarker1748"/><span class="koboSpan" id="kobo.174.1"> translation is not used, because the instructions are executed directly on the host CPU. </span><span class="koboSpan" id="kobo.174.2">The</span><a id="_idIndexMarker1749"/><span class="koboSpan" id="kobo.175.1"> differences between software- and</span><a id="_idIndexMarker1750"/><span class="koboSpan" id="kobo.176.1"> hardware-assisted virtualization are shown in</span><a id="_idIndexMarker1751"/><span class="koboSpan" id="kobo.177.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.178.1">following diagram:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer382">
<span class="koboSpan" id="kobo.179.1"><img alt="Figure 11.3 – Comparison between software- and hardware-assisted virtualization" src="image/B19682_11_3.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.180.1">Figure 11.3 – Comparison between software- and hardware-assisted virtualization</span></p>
<p><span class="koboSpan" id="kobo.181.1">As you can see in the diagram, instructions have different paths when using software- and </span><a id="_idIndexMarker1752"/><span class="koboSpan" id="kobo.182.1">hardware-assisted virtualization. </span><span class="koboSpan" id="kobo.182.2">In software-assisted virtualization, when dynamic binary translations are used, the user’s unprivileged instructions </span><a id="_idIndexMarker1753"/><span class="koboSpan" id="kobo.183.1">are sent directly to the hardware, while the guest OS privileged instructions are first sent to the hypervisor before getting to the hardware. </span><span class="koboSpan" id="kobo.183.2">In hardware-assisted virtualization, the user’s unprivileged instructions are sent to the hypervisor first, and then sent to the hardware, while the privileged instructions from the guest OS have the same path as in software-assisted virtualization. </span><span class="koboSpan" id="kobo.183.3">This ensures a certain level of isolation for the guest OS, thereby achieving better performance and </span><span class="No-Break"><span class="koboSpan" id="kobo.184.1">less complexity.</span></span></p>
<p><span class="koboSpan" id="kobo.185.1">In the following section, we will show you how to install and configure QEMU on a Debian 12 machine. </span><span class="koboSpan" id="kobo.185.2">We consider Debian to be a sufficiently lightweight distribution, offering the necessary stability for a virtualization host OS. </span><span class="koboSpan" id="kobo.185.3">Some commands can be replicated on Ubuntu </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">as well.</span></span></p>
<h3><span class="koboSpan" id="kobo.187.1">Installing the hypervisor on major Linux distributions</span></h3>
<p><span class="koboSpan" id="kobo.188.1">Installing QEMU is a straightforward task. </span><span class="koboSpan" id="kobo.188.2">All you need to do is to run the package installer utility of your distribution, with some specified</span><a id="_idIndexMarker1754"/><span class="koboSpan" id="kobo.189.1"> package names. </span><span class="koboSpan" id="kobo.189.2">In our case, we will show you how to install it on major Linux distributions such as Debian/Ubuntu, Fedora, </span><span class="No-Break"><span class="koboSpan" id="kobo.190.1">and openSUSE:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.191.1">Installing on </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.192.1">Debian/Ubuntu Linux</span></strong></span><p class="list-inset"><span class="koboSpan" id="kobo.193.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.194.1">following command:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.195.1">sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virtinst libvirt-daemon virt-manager</span></strong></pre></li> <li><strong class="bold"><span class="koboSpan" id="kobo.196.1">Installing on </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.197.1">Fedora Linux</span></strong></span><p class="list-inset"><span class="koboSpan" id="kobo.198.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.199.1">following command:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.200.1">sudo dnf group install --with-optional virtualization</span></strong></pre></li> <li><strong class="bold"><span class="koboSpan" id="kobo.201.1">Installing on </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.202.1">openSUSE Linux</span></strong></span><p class="list-inset"><span class="koboSpan" id="kobo.203.1">Run the </span><span class="No-Break"><span class="koboSpan" id="kobo.204.1">following commands:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.205.1">sudo zypper install -t pattern kvm_server kvm_tools</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.206.1">sudo zypper install libvirt-daemon</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.207.1">Once all the necessary packages are installed, you can enable and start the </span><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">libvirtd</span></strong><span class="koboSpan" id="kobo.209.1"> daemon with the following commands (valid for all Linux distributions showcased in </span><span class="No-Break"><span class="koboSpan" id="kobo.210.1">this section):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.211.1">
sudo systemctl start libvirtd
sudo systemctl enable libvirtd</span></pre> <p><span class="koboSpan" id="kobo.212.1">Once the packages are installed and the daemon is started and enabled, a safe action to take is to check whether your machine is compatible with KVM requirements. </span><span class="koboSpan" id="kobo.212.2">To do this, use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.213.1">virt-host-validate</span></strong><span class="koboSpan" id="kobo.214.1"> command as a root user or by using </span><strong class="source-inline"><span class="koboSpan" id="kobo.215.1">sudo</span></strong><span class="koboSpan" id="kobo.216.1">. </span><span class="koboSpan" id="kobo.216.2">We are running the command on a Debian GNU/Linux 12 host, but it can be used on other Linux distributions </span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">as well:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.218.1">
sudo virt-host-validate</span></pre> <p><span class="koboSpan" id="kobo.219.1">Once the command is running, you may receive a couple of errors or warnings regarding QEMU or </span><strong class="bold"><span class="koboSpan" id="kobo.220.1">Linux Containers</span></strong><span class="koboSpan" id="kobo.221.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.222.1">LXC</span></strong><span class="koboSpan" id="kobo.223.1">) – which is a technology </span><a id="_idIndexMarker1755"/><span class="koboSpan" id="kobo.224.1">used to run isolated </span><a id="_idIndexMarker1756"/><span class="koboSpan" id="kobo.225.1">systems, similar to how KVM works – depending on your system (there’s more on LXC in </span><a href="B19682_12.xhtml#_idTextAnchor257"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.226.1">Chapter 12</span></em></span></a><span class="koboSpan" id="kobo.227.1">). </span><span class="koboSpan" id="kobo.227.2">In our case, the output shows one error regarding LXC compatibility, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.228.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer383">
<span class="koboSpan" id="kobo.229.1"><img alt="Figure 11.4 – Running the host validation program" src="image/B19682_11_4.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.230.1">Figure 11.4 – Running the host validation program</span></p>
<p><span class="koboSpan" id="kobo.231.1">However, this error will not limit our use of </span><strong class="source-inline"><span class="koboSpan" id="kobo.232.1">libvirt</span></strong><span class="koboSpan" id="kobo.233.1"> and QEMU, so we do not intend to resolve </span><span class="No-Break"><span class="koboSpan" id="kobo.234.1">it here.</span></span></p>
<p><span class="koboSpan" id="kobo.235.1">After seeing that there are </span><a id="_idIndexMarker1757"/><span class="koboSpan" id="kobo.236.1">no compatibility issues regarding QEMU, we can proceed to creating our first VM using the CLI. </span><span class="koboSpan" id="kobo.236.2">Thus, we will start using </span><span class="No-Break"><span class="koboSpan" id="kobo.237.1">KVM-specific commands.</span></span></p>
<h1 id="_idParaDest-223"><a id="_idTextAnchor240"/><span class="koboSpan" id="kobo.238.1">Working with basic KVM commands</span></h1>
<p><span class="koboSpan" id="kobo.239.1">One of the first commands that you will use when working with KVM is the one used for creating a VM. </span><span class="koboSpan" id="kobo.239.2">Other commands, as </span><a id="_idIndexMarker1758"/><span class="koboSpan" id="kobo.240.1">shown in the following sections, are the ones used to start, stop, delete, or pause an already </span><span class="No-Break"><span class="koboSpan" id="kobo.241.1">existing VM.</span></span></p>
<h2 id="_idParaDest-224"><a id="_idTextAnchor241"/><span class="koboSpan" id="kobo.242.1">Creating a VM using the command line</span></h2>
<p><span class="koboSpan" id="kobo.243.1">Before creating</span><a id="_idIndexMarker1759"/><span class="koboSpan" id="kobo.244.1"> our first VM using </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">libvirt</span></strong><span class="koboSpan" id="kobo.246.1">, we must check and see whether our default bridge network configuration was created. </span><span class="koboSpan" id="kobo.246.2">We can verify this by using the </span><span class="No-Break"><span class="koboSpan" id="kobo.247.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.248.1">
sudo virsh net-list</span></pre> <p><span class="koboSpan" id="kobo.249.1">This command shows if the default bridge configuration was created and if it is running. </span><span class="koboSpan" id="kobo.249.2">In our case, the bridge connection is not running, thus we will need to set it up ourselves. </span><span class="koboSpan" id="kobo.249.3">The command used to start the default bridge network is </span><span class="No-Break"><span class="koboSpan" id="kobo.250.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.251.1">
sudo virsh net-start default</span></pre> <p><span class="koboSpan" id="kobo.252.1">Once it has been started, the network bridge is not set up for automatic start, thus we will use the following command to set it for </span><span class="No-Break"><span class="koboSpan" id="kobo.253.1">automatic start:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.254.1">
sudo virsh net-autostart default</span></pre> <p><span class="koboSpan" id="kobo.255.1">Now, the output is </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer384">
<span class="koboSpan" id="kobo.257.1"><img alt="Figure 11.5 – Enabling the default bridge connection" src="image/B19682_11_5.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.258.1">Figure 11.5 – Enabling the default bridge connection</span></p>
<p><span class="koboSpan" id="kobo.259.1">Now that the default bridge connection has been enabled and set for </span><strong class="source-inline"><span class="koboSpan" id="kobo.260.1">autostart</span></strong><span class="koboSpan" id="kobo.261.1">, we can create our first VM. </span><span class="koboSpan" id="kobo.261.2">In order to create a VM, follow </span><a id="_idIndexMarker1760"/><span class="No-Break"><span class="koboSpan" id="kobo.262.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.263.1">First, we will need to download the image file of the OS to use inside the VM. </span><span class="koboSpan" id="kobo.263.2">For our example, we will create a new VM with Ubuntu 22.04.2 LTS server edition. </span><span class="koboSpan" id="kobo.263.3">We can download the ISO image with the </span><span class="No-Break"><span class="koboSpan" id="kobo.264.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.265.1">wget https://releases.ubuntu.com/22.04.2/ubuntu-22.04.2-live-server-amd64.iso</span></strong></pre></li> <li><span class="koboSpan" id="kobo.266.1">The download location will be inside your present working directory, thus you may want to move it to another location, otherwise the hypervisor will not have permission to access your ISO file. </span><span class="koboSpan" id="kobo.266.2">The location you should move the ISO file </span><span class="No-Break"><span class="koboSpan" id="kobo.267.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.268.1">/var/lib/libvirt/images</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.269.1">.</span></span></li>
<li><span class="koboSpan" id="kobo.270.1">Once the Ubuntu image is downloaded, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.271.1">virt-install</span></strong><span class="koboSpan" id="kobo.272.1"> command to create the first VM on our</span><a id="_idIndexMarker1761"/><span class="koboSpan" id="kobo.273.1"> host system. </span><span class="koboSpan" id="kobo.273.2">We will create one VM that will use a single </span><strong class="bold"><span class="koboSpan" id="kobo.274.1">virtual CPU</span></strong><span class="koboSpan" id="kobo.275.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.276.1">vCPU</span></strong><span class="koboSpan" id="kobo.277.1">), 2 GB of RAM, and 20 GB </span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">of storage.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.279.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">virt-install</span></strong><span class="koboSpan" id="kobo.281.1"> command used is the following (run </span><span class="No-Break"><span class="koboSpan" id="kobo.282.1">as root):</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.283.1">virt-install --virt-type=kvm --name ubuntu-vm1 --vcpus=2 --memory=2048 --os-variant=ubuntufocal --cdrom=/var/lib/libvirt/images/ubuntu-22.04.2-live-server-amd64.iso --network=default --disk size=20</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.284.1">It has the following </span><span class="No-Break"><span class="koboSpan" id="kobo.285.1">mandatory arguments:</span></span></p><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">--virt-type</span></strong><span class="koboSpan" id="kobo.287.1">: Type of the </span><span class="No-Break"><span class="koboSpan" id="kobo.288.1">new VM</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">--name</span></strong><span class="koboSpan" id="kobo.290.1">: The name of the </span><span class="No-Break"><span class="koboSpan" id="kobo.291.1">new VM</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">--memory</span></strong><span class="koboSpan" id="kobo.293.1">: The amount of RAM used by </span><span class="No-Break"><span class="koboSpan" id="kobo.294.1">the VM</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.295.1">--vcpus</span></strong><span class="koboSpan" id="kobo.296.1">: The number of virtual CPUs used by the </span><span class="No-Break"><span class="koboSpan" id="kobo.297.1">new VM</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.298.1">--disk size</span></strong><span class="koboSpan" id="kobo.299.1">: The amount of </span><span class="No-Break"><span class="koboSpan" id="kobo.300.1">storage used</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">--os-variant</span></strong><span class="koboSpan" id="kobo.302.1">: The type of </span><span class="No-Break"><span class="koboSpan" id="kobo.303.1">guest OS</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.304.1">--network</span></strong><span class="koboSpan" id="kobo.305.1">: The bridge </span><span class="No-Break"><span class="koboSpan" id="kobo.306.1">network used</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.307.1">--cdrom</span></strong><span class="koboSpan" id="kobo.308.1">: The location of the guest OS </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">ISO file</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.310.1">The command will start a new </span><strong class="source-inline"><span class="koboSpan" id="kobo.311.1">virt-viewer</span></strong><span class="koboSpan" id="kobo.312.1"> window, which will start the OS installation process. </span><span class="koboSpan" id="kobo.312.2">Similarly, by using the command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.313.1">–graphics=vnc</span></strong><span class="koboSpan" id="kobo.314.1"> argument, </span><strong class="source-inline"><span class="koboSpan" id="kobo.315.1">virt-install</span></strong><span class="koboSpan" id="kobo.316.1"> will start </span><strong class="source-inline"><span class="koboSpan" id="kobo.317.1">virt-viewer</span></strong><span class="koboSpan" id="kobo.318.1">, which is the default tool for displaying the graphical console using the </span><span class="No-Break"><span class="koboSpan" id="kobo.319.1">VNC protocol.</span></span></p></li> </ol>
<p><span class="koboSpan" id="kobo.320.1">Simply knowing how to</span><a id="_idIndexMarker1762"/><span class="koboSpan" id="kobo.321.1"> create a VM is not sufficient for a system administrator. </span><span class="koboSpan" id="kobo.321.2">This is why, in the next section, we will show you some basic VM management tools </span><span class="No-Break"><span class="koboSpan" id="kobo.322.1">to use.</span></span></p>
<h2 id="_idParaDest-225"><a id="_idTextAnchor242"/><span class="koboSpan" id="kobo.323.1">Basic VM management</span></h2>
<p><span class="koboSpan" id="kobo.324.1">The basic VM tasks can be done using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.325.1">virsh</span></strong><span class="koboSpan" id="kobo.326.1"> command when using the CLI, or Virtual</span><a id="_idIndexMarker1763"/><span class="koboSpan" id="kobo.327.1"> Machine Manager when using a graphical user interface. </span><span class="koboSpan" id="kobo.327.2">In the following, we will show you the basic commands to use while inside </span><span class="No-Break"><span class="koboSpan" id="kobo.328.1">a CLI.</span></span></p>
<p><span class="koboSpan" id="kobo.329.1">To list the existing VM guests, use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.330.1">virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.331.1">list</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.332.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.333.1">
sudo virsh list</span></pre> <p><span class="koboSpan" id="kobo.334.1">Be aware that listing the VMs cannot </span><a id="_idIndexMarker1764"/><span class="koboSpan" id="kobo.335.1">be done by just anyone. </span><span class="koboSpan" id="kobo.335.2">This is why the following note needs to </span><span class="No-Break"><span class="koboSpan" id="kobo.336.1">be considered.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.337.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.338.1">When trying to list the existing guest VMs, you will not get a valid output when using a regular user. </span><span class="koboSpan" id="kobo.338.2">You will need to be logged in as </span><strong class="source-inline"><span class="koboSpan" id="kobo.339.1">root</span></strong><span class="koboSpan" id="kobo.340.1"> or use </span><strong class="source-inline"><span class="koboSpan" id="kobo.341.1">sudo</span></strong><span class="koboSpan" id="kobo.342.1"> to see the list </span><span class="No-Break"><span class="koboSpan" id="kobo.343.1">of VMs.</span></span></p>
<p><span class="koboSpan" id="kobo.344.1">The following screenshot shows some basic commands used to manage VMs, together with </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">their output</span></span><span class="No-Break"><span class="koboSpan" id="kobo.346.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer385">
<span class="koboSpan" id="kobo.347.1"><img alt="Figure 11.6 – Commands for VM management" src="image/B19682_11_6.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.348.1">Figure 11.6 – Commands for VM management</span></p>
<p><span class="koboSpan" id="kobo.349.1">Here is a short explanation of the </span><a id="_idIndexMarker1765"/><span class="koboSpan" id="kobo.350.1">commands you see in the preceding figure. </span><span class="koboSpan" id="kobo.350.2">To change the state of a VM, such as starting, stopping, and pausing, use the </span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">following commands:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.352.1">To force stop a VM</span></strong><span class="koboSpan" id="kobo.353.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.354.1">sudo virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.355.1">destroy ubuntu-vm1</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.356.1">To reboot a VM</span></strong><span class="koboSpan" id="kobo.357.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.358.1">sudo virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.359.1">reboot ubuntu-vm1</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.360.1">To pause (suspend) a VM</span></strong><span class="koboSpan" id="kobo.361.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.362.1">sudo virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.363.1">suspend ubuntu-vm1</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.364.1">To start a VM</span></strong><span class="koboSpan" id="kobo.365.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">sudo virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.367.1">start ubuntu-vm1</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.368.1">To resume an already suspended (paused) VM</span></strong><span class="koboSpan" id="kobo.369.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.370.1">sudo virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.371.1">resume ubuntu-vm1</span></strong></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.372.1">To completely delete a VM guest</span></strong><span class="koboSpan" id="kobo.373.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.374.1">sudo virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.375.1">undefine ubuntu-vm1</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.376.1">For all the options available for </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">virsh</span></strong><span class="koboSpan" id="kobo.378.1">, please refer to the manual pages using the </span><span class="No-Break"><span class="koboSpan" id="kobo.379.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.380.1">
man virsh</span></pre> <p><span class="koboSpan" id="kobo.381.1">The command-line tools for managing VMs are powerful and offer various options. </span><span class="koboSpan" id="kobo.381.2">If we consider the</span><a id="_idIndexMarker1766"/><span class="koboSpan" id="kobo.382.1"> fact that, most of the time, a system administrator will be using the CLI rather than the GUI, the ability to use command-line tools is of the </span><span class="No-Break"><span class="koboSpan" id="kobo.383.1">utmost importance.</span></span></p>
<p><span class="koboSpan" id="kobo.384.1">In the following section, we will show you some advanced KVM </span><span class="No-Break"><span class="koboSpan" id="kobo.385.1">management practices.</span></span></p>
<h1 id="_idParaDest-226"><a id="_idTextAnchor243"/><span class="koboSpan" id="kobo.386.1">Advanced KVM management</span></h1>
<p><span class="koboSpan" id="kobo.387.1">Using KVM is so much more than just creating VMs and starting or stopping them. </span><span class="koboSpan" id="kobo.387.2">VM management can be much more complex, starting with VM automated installation, storage and resources management, and up to </span><a id="_idIndexMarker1767"/><span class="koboSpan" id="kobo.388.1">VM orchestration. </span><span class="koboSpan" id="kobo.388.2">Some of these topics are out of the scope of this book, but we will still show you how to master your VMs on your </span><span class="No-Break"><span class="koboSpan" id="kobo.389.1">Linux-powered systems.</span></span></p>
<p><span class="koboSpan" id="kobo.390.1">By now, we only have one VM. </span><span class="koboSpan" id="kobo.390.2">For the purpose of the exercises in this section, we will create two more VMs, all running the same Ubuntu OS that we used for the first VM. </span><span class="koboSpan" id="kobo.390.3">We will create </span><strong class="source-inline"><span class="koboSpan" id="kobo.391.1">ubuntu-vm2</span></strong><span class="koboSpan" id="kobo.392.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.393.1">ubuntu-vm3</span></strong><span class="koboSpan" id="kobo.394.1"> VMs using the </span><span class="No-Break"><span class="koboSpan" id="kobo.395.1">following commands:</span></span></p>
<ul>
<li><span class="No-Break"><span class="koboSpan" id="kobo.396.1">For </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.397.1">ubuntu-vm2</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.398.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.399.1">sudo virt-install --virt-type=kvm --name ubuntu-vm2 --vcpus=2 --memory=2048 --os-variant=ubuntufocal --cdrom=/var/lib/libvirt/images/ubuntu-22.04.2-live-server-amd64.iso --network=default --disk size=20 --noautoconsole</span></strong></pre></li> <li><span class="No-Break"><span class="koboSpan" id="kobo.400.1">For </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.401.1">ubuntu-vm3</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.403.1">sudo virt-install --virt-type=kvm --name ubuntu-vm3 --vcpus=2 --memory=2048 --os-variant=ubuntufocal --cdrom=/var/lib/libvirt/images/ubuntu-22.04.2-live-server-amd64.iso --network=default --disk size=20 --noautoconsole</span></strong></pre></li> </ul>
<p><span class="koboSpan" id="kobo.404.1">Now, we have three VMs running </span><a id="_idIndexMarker1768"/><span class="koboSpan" id="kobo.405.1">on our system and we can begin managing them. </span><span class="koboSpan" id="kobo.405.2">In the next section, we will show you how to find out the IP of a VM and how to connect </span><span class="No-Break"><span class="koboSpan" id="kobo.406.1">to it.</span></span></p>
<h2 id="_idParaDest-227"><a id="_idTextAnchor244"/><span class="koboSpan" id="kobo.407.1">Connecting to a VM</span></h2>
<p><span class="koboSpan" id="kobo.408.1">Most of the time, we would like to connect to</span><a id="_idIndexMarker1769"/><span class="koboSpan" id="kobo.409.1"> a running VM from a terminal and not use the integrated console provided by the VM manager. </span><span class="koboSpan" id="kobo.409.2">In order to be able to do this, we will need to know the VM’s IP address. </span><span class="koboSpan" id="kobo.409.3">A simple run of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">ip neighbor</span></strong><span class="koboSpan" id="kobo.411.1"> command will show us all the IP addresses on our local network, but this will not provide the relevant information we need, such as the </span><span class="No-Break"><span class="koboSpan" id="kobo.412.1">VM’s name.</span></span></p>
<p><span class="koboSpan" id="kobo.413.1">On our system, when running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.414.1">ip neighbor</span></strong><span class="koboSpan" id="kobo.415.1"> command, the output is </span><span class="No-Break"><span class="koboSpan" id="kobo.416.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer386">
<span class="koboSpan" id="kobo.417.1"><img alt="Figure 11.7 – Viewing the IP addresses on the local network" src="image/B19682_11_7.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.418.1">Figure 11.7 – Viewing the IP addresses on the local network</span></p>
<p><span class="koboSpan" id="kobo.419.1">From the output, we can see that three of the IP addresses are from the default virtual network that is set up by KVM (</span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">virbr0</span></strong><span class="koboSpan" id="kobo.421.1">). </span><span class="koboSpan" id="kobo.421.2">This is the first information that tells us the IP addresses used by our VMs. </span><span class="koboSpan" id="kobo.421.3">But which IP is which VM? </span><span class="koboSpan" id="kobo.421.4">To find out more information, we will use the </span><span class="No-Break"><span class="koboSpan" id="kobo.422.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.423.1">
sudo virsh list --all</span></pre> <p><span class="koboSpan" id="kobo.424.1">The preceding command is used to list all the existing VMs. </span><span class="koboSpan" id="kobo.424.2">The output (as seen in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.425.1">Figure 11</span></em></span><em class="italic"><span class="koboSpan" id="kobo.426.1">.8</span></em><span class="koboSpan" id="kobo.427.1">) shows the names of the VMs. </span><span class="koboSpan" id="kobo.427.2">In order to see the IP addresses associated with each one, we will use the</span><a id="_idIndexMarker1770"/> <span class="No-Break"><span class="koboSpan" id="kobo.428.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.429.1">
sudo virsh domifaddr [vm name]</span></pre> <p><span class="koboSpan" id="kobo.430.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.431.1">[vm name]</span></strong><span class="koboSpan" id="kobo.432.1"> represents one of the VM names from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.433.1">virsh list</span></strong><span class="koboSpan" id="kobo.434.1"> command’s output. </span><span class="koboSpan" id="kobo.434.2">In the following screenshot, you can see the output of the </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">previous commands:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer387">
<span class="koboSpan" id="kobo.436.1"><img alt="Figure 11.8 – Showing the IP addresses for VMs" src="image/B19682_11_8.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.437.1">Figure 11.8 – Showing the IP addresses for VMs</span></p>
<p><span class="koboSpan" id="kobo.438.1">Now that we know the IP addresses of every VM we created, we can connect to any of the VMs using SSH (more on installing and configuring SSH in </span><a href="B19682_13.xhtml#_idTextAnchor276"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.439.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.440.1">). </span><span class="koboSpan" id="kobo.440.2">Considering that we already have openSSH installed on both our host system and the target VM, the simplest way to connect using SSH is </span><span class="No-Break"><span class="koboSpan" id="kobo.441.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.442.1">
ssh packt@192.168.122.129</span></pre> <p><span class="koboSpan" id="kobo.443.1">In the previous command, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.444.1">ssh</span></strong><span class="koboSpan" id="kobo.445.1"> command, we specified the user (in our case </span><strong class="source-inline"><span class="koboSpan" id="kobo.446.1">packt</span></strong><span class="koboSpan" id="kobo.447.1">) and the IP address of the VM (in our case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">192.168.122.129</span></strong><span class="koboSpan" id="kobo.449.1">, which is </span><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">ubuntu-vm1</span></strong><span class="koboSpan" id="kobo.451.1"> that we created earlier). </span><span class="koboSpan" id="kobo.451.2">The prompt (as shown in the following figure) asks you for confirmation, saves the key to the list of known hosts, and then connects you to </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">the machine:</span></span></p>
<p class="IMG---Figure"><span class="koboSpan" id="kobo.453.1"><img alt="Figure 11.9 – Connect to a VM through SSH" src="image/B19682_11_9.png"/></span></p>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.454.1">Figure 11.9 – Connect to a VM through SSH</span></p>
<p><span class="koboSpan" id="kobo.455.1">Another way to connect to a </span><a id="_idIndexMarker1771"/><span class="koboSpan" id="kobo.456.1">VM is by using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.457.1">virt-viewer</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.458.1"> command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.459.1">
virt-viewer --connect qemu:///system ubuntu-vm1</span></pre> <p><span class="koboSpan" id="kobo.460.1">This command will open a new console window using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.461.1">virt-viewer</span></strong><span class="koboSpan" id="kobo.462.1"> utility and connect to the VM you specify (in our case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.463.1">ubuntu-vm1</span></strong><span class="koboSpan" id="kobo.464.1"> again) without using the </span><span class="No-Break"><span class="koboSpan" id="kobo.465.1">SSH protocol:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer389">
<span class="koboSpan" id="kobo.466.1"><img alt="Figure 11.10 – Connecting to VM using virt-viewer" src="image/B19682_11_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.467.1">Figure 11.10 – Connecting to VM using virt-viewer</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.468.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.469.1">The connection remains active inside the terminal where you initiated the command. </span><span class="koboSpan" id="kobo.469.2">Thus, if you press </span><em class="italic"><span class="koboSpan" id="kobo.470.1">Ctrl</span></em><span class="koboSpan" id="kobo.471.1"> + </span><em class="italic"><span class="koboSpan" id="kobo.472.1">C</span></em><span class="koboSpan" id="kobo.473.1">, the connection will be terminated and the new console window will close. </span><span class="koboSpan" id="kobo.473.2">Take into consideration that only the connection will be terminated and the VM will still </span><span class="No-Break"><span class="koboSpan" id="kobo.474.1">be running.</span></span></p>
<p><span class="koboSpan" id="kobo.475.1">We have shown you how to use the command line to create VMs, for basic management, and to connect to a virtual machine. </span><span class="koboSpan" id="kobo.475.2">However, you can also use GUI tools. </span><span class="koboSpan" id="kobo.475.3">All modern Linux distributions </span><a id="_idIndexMarker1772"/><span class="koboSpan" id="kobo.476.1">that use GNOME as the desktop environment will offer at least two useful tools: the Virtual Machine Manager and GNOME Boxes. </span><span class="koboSpan" id="kobo.476.2">The former is simply the GUI for </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">libvirt</span></strong><span class="koboSpan" id="kobo.478.1">, and the latter is a </span><a id="_idIndexMarker1773"/><span class="koboSpan" id="kobo.479.1">new and simple way to provision VMs for immediate use inside GNOME based on QEMU/KVM technology. </span><span class="koboSpan" id="kobo.479.2">We will let you discover these GUI tools as they are pretty straightforward and not difficult to use. </span><span class="koboSpan" id="kobo.479.3">You could start creating new VMs using the Virtual Machine Manager. </span><span class="koboSpan" id="kobo.479.4">In the next section, we will show you how to </span><span class="No-Break"><span class="koboSpan" id="kobo.480.1">clone VMs.</span></span></p>
<h2 id="_idParaDest-228"><a id="_idTextAnchor245"/><span class="koboSpan" id="kobo.481.1">Cloning VMs</span></h2>
<p><span class="koboSpan" id="kobo.482.1">We have already created three different VMs on our host system. </span><span class="koboSpan" id="kobo.482.2">However, there are times when you might want to clone an existing VM instead of creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.483.1">new one.</span></span></p>
<p><span class="koboSpan" id="kobo.484.1">Before starting to clone a VM, we need to stop or suspend it. </span><span class="koboSpan" id="kobo.484.2">We will do this using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">suspend</span></strong><span class="koboSpan" id="kobo.486.1"> or the </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">shutdown</span></strong><span class="koboSpan" id="kobo.488.1"> commands. </span><span class="koboSpan" id="kobo.488.2">We</span><a id="_idIndexMarker1774"/><span class="koboSpan" id="kobo.489.1"> will stop one of our VMs, </span><span class="No-Break"><span class="koboSpan" id="kobo.490.1">as shown:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.491.1">
sudo virsh shutdown ubuntu-vm1</span></pre> <p><span class="koboSpan" id="kobo.492.1">This command will shut down the </span><strong class="source-inline"><span class="koboSpan" id="kobo.493.1">ubuntu-vm1</span></strong><span class="koboSpan" id="kobo.494.1"> VM. </span><span class="koboSpan" id="kobo.494.2">In order to clone it, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.495.1">virt-clone</span></strong><span class="koboSpan" id="kobo.496.1"> command. </span><span class="koboSpan" id="kobo.496.2">Let’s say that we want to name the clone </span><strong class="source-inline"><span class="koboSpan" id="kobo.497.1">ubuntu-vm1-clone1</span></strong><span class="koboSpan" id="kobo.498.1">. </span><span class="koboSpan" id="kobo.498.2">We will use the </span><span class="No-Break"><span class="koboSpan" id="kobo.499.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.500.1">
sudo virt-clone --original ubuntu-vm1 --name ubuntu-vm1-clone1 --auto-clone</span></pre> <p><span class="koboSpan" id="kobo.501.1">The output of the command is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer390">
<span class="koboSpan" id="kobo.503.1"><img alt="Figure 11.11 – Cloning virtual machines using virt-clone" src="image/B19682_11_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.504.1">Figure 11.11 – Cloning virtual machines using virt-clone</span></p>
<p><span class="koboSpan" id="kobo.505.1">Now that the clone has been created, we can start it using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">virsh start</span></strong><span class="koboSpan" id="kobo.507.1"> command. </span><span class="koboSpan" id="kobo.507.2">Cloning a VM will also </span><em class="italic"><span class="koboSpan" id="kobo.508.1">transfer</span></em><span class="koboSpan" id="kobo.509.1"> all the original VM’s configuration regarding the number of vCPUs, RAM, bridge networking configuration, the same MAC address, and even the same IP address. </span><span class="koboSpan" id="kobo.509.2">This can become a real headache and needs to </span><span class="No-Break"><span class="koboSpan" id="kobo.510.1">be solved.</span></span></p>
<p><span class="koboSpan" id="kobo.511.1">One way to solve this is to directly </span><a id="_idIndexMarker1775"/><span class="koboSpan" id="kobo.512.1">connect to the VM’s console (not through SSH) and run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.513.1">ip addr show</span></strong><span class="koboSpan" id="kobo.514.1"> command. </span><span class="koboSpan" id="kobo.514.2">This will enable the DHCP client to automatically assign an IP address to the host. </span><span class="koboSpan" id="kobo.514.3">In the next section, we will show you another useful way to manage cloning with </span><span class="No-Break"><span class="koboSpan" id="kobo.515.1">VM templates.</span></span></p>
<h2 id="_idParaDest-229"><a id="_idTextAnchor246"/><span class="koboSpan" id="kobo.516.1">Creating VM templates</span></h2>
<p><span class="koboSpan" id="kobo.517.1">Another useful way to overcome</span><a id="_idIndexMarker1776"/><span class="koboSpan" id="kobo.518.1"> the issue described in the previous section is to first create a VM template before cloning. </span><span class="koboSpan" id="kobo.518.2">By creating a template, you make sure that all the configuration files will not persist, including MAC and IP configuration, user settings, or SSH </span><span class="No-Break"><span class="koboSpan" id="kobo.519.1">host keys.</span></span></p>
<p><span class="koboSpan" id="kobo.520.1">To create a template, follow </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">these steps:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.522.1">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.523.1">virt-sysprep</span></strong><span class="koboSpan" id="kobo.524.1"> utility. </span><span class="koboSpan" id="kobo.524.2">In Debian 12, we will install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">libguestfs-tools</span></strong><span class="koboSpan" id="kobo.526.1"> utility, which contains the </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">virt-sysprep</span></strong><span class="koboSpan" id="kobo.528.1">, using the </span><span class="No-Break"><span class="koboSpan" id="kobo.529.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.530.1">sudo apt install libguestfs-tools</span></strong></pre></li> <li><span class="koboSpan" id="kobo.531.1">Now that the utility is installed, we will use it to create a template. </span><span class="koboSpan" id="kobo.531.2">But first, we will create a new VM running Ubuntu and use it as a template. </span><span class="koboSpan" id="kobo.531.3">We will use the following command to create the </span><span class="No-Break"><span class="koboSpan" id="kobo.532.1">new VM:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.533.1">sudo virt-install --virt-type=kvm --name ubuntu-template --vcpus=2 --memory=2048 --os-variant=ubuntufocal --cdrom=/var/lib/libvirt/images/ubuntu-22.04.2-live-server-amd64.iso --network=default --disk size=20 –noautoconsole</span></strong></pre></li> <li><span class="koboSpan" id="kobo.534.1">After finishing the OS installation, make sure that it is up to date with all the </span><span class="No-Break"><span class="koboSpan" id="kobo.535.1">available packages.</span></span></li>
<li><span class="koboSpan" id="kobo.536.1">Proceed only after</span><a id="_idIndexMarker1777"/><span class="koboSpan" id="kobo.537.1"> ensuring that the VM is turned off. </span><span class="koboSpan" id="kobo.537.2">As a precautionary method, you could first copy the file with a </span><span class="No-Break"><span class="koboSpan" id="kobo.538.1">different name:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.539.1">sudo cp /var/lib/libvirt/images/ubuntu-template.qcow2 /var/lib/libvirt/images/ubuntu-back-template.qcow2</span></strong></pre></li> <li><span class="koboSpan" id="kobo.540.1">Now you can prepare the new VM instance with the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">virt-sysprep</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.542.1"> utility:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.543.1">sudo virt-sysprep -d ubuntu-template</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.544.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.545.1">virt-sysprep</span></strong><span class="koboSpan" id="kobo.546.1"> command is preparing the VM by resetting all the configuration files that might have been created. </span><span class="koboSpan" id="kobo.546.2">The following is an excerpt from </span><span class="No-Break"><span class="koboSpan" id="kobo.547.1">the output:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer391">
<span class="koboSpan" id="kobo.548.1"><img alt="Figure 11.12 – Creating a template with virt-sysprep" src="image/B19682_11_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.549.1">Figure 11.12 – Creating a template with virt-sysprep</span></p>
<ol>
<li value="6"><span class="koboSpan" id="kobo.550.1">Now that the template is prepared, you can do either of </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">the following:</span></span><ul><li><span class="koboSpan" id="kobo.552.1">Undefine the domain by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.553.1">virsh undefine</span></strong><span class="koboSpan" id="kobo.554.1"> command. </span><span class="koboSpan" id="kobo.554.2">This command removes the</span><a id="_idIndexMarker1778"/><span class="koboSpan" id="kobo.555.1"> configuration of the VM but leaves the </span><strong class="source-inline"><span class="koboSpan" id="kobo.556.1">qcow2</span></strong><span class="koboSpan" id="kobo.557.1"> file that it created so that you could use it when creating a </span><span class="No-Break"><span class="koboSpan" id="kobo.558.1">new VM.</span></span></li><li><span class="koboSpan" id="kobo.559.1">Keep the VM (in our case, the one named </span><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">ubuntu-template</span></strong><span class="koboSpan" id="kobo.561.1">) and use it as a clone template, </span><span class="No-Break"><span class="koboSpan" id="kobo.562.1">as intended.</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.563.1">The choice is yours, but we are inclined towards the second option, as it is already configured and thus is much easier to use. </span><span class="koboSpan" id="kobo.563.2">When using only the </span><strong class="source-inline"><span class="koboSpan" id="kobo.564.1">qcow2 </span></strong><span class="koboSpan" id="kobo.565.1">file, you still have to configure (setting CPUs, RAM, networking, etc.) the VM prior to </span><span class="No-Break"><span class="koboSpan" id="kobo.566.1">using it.</span></span></p></li>
</ol>
<p><span class="koboSpan" id="kobo.567.1">Now that you know how to clone a VM and how to create templates, let’s see other ways to manage VMs. </span><span class="koboSpan" id="kobo.567.2">In the next section, we will show you how to obtain information about the VMs you work with, from the </span><span class="No-Break"><span class="koboSpan" id="kobo.568.1">command line.</span></span></p>
<h2 id="_idParaDest-230"><a id="_idTextAnchor247"/><span class="koboSpan" id="kobo.569.1">Obtaining VM and host resource information</span></h2>
<p><span class="koboSpan" id="kobo.570.1">When you’re working at the command line, some</span><a id="_idIndexMarker1779"/><span class="koboSpan" id="kobo.571.1"> information is not as visible as</span><a id="_idIndexMarker1780"/><span class="koboSpan" id="kobo.572.1"> when working with the GUI tools. </span><span class="koboSpan" id="kobo.572.2">To see if we still have the necessary sources for creating new VMs, we will need to use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.573.1">virsh nodeinfo</span></strong><span class="koboSpan" id="kobo.574.1"> command to obtain information about the </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">host machine:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer392">
<span class="koboSpan" id="kobo.576.1"><img alt="Figure 11.13 – Finding host information with the nodeinfo command" src="image/B19682_11_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.577.1">Figure 11.13 – Finding host information with the nodeinfo command</span></p>
<p><span class="koboSpan" id="kobo.578.1">In our case, as seen in the preceding image, the host has 16 vCPUs available and 48 GB of RAM, meaning that we still have </span><a id="_idIndexMarker1781"/><span class="koboSpan" id="kobo.579.1">resources available for some new VMs. </span><span class="koboSpan" id="kobo.579.2">We know that when we created the VMs</span><a id="_idIndexMarker1782"/><span class="koboSpan" id="kobo.580.1"> we allocated 2 vCPUs and 2 GB of RAM for each one. </span><span class="koboSpan" id="kobo.580.2">As we now have five VMs (as shown in the following image), it means that we use 10 out of 16 vCPUs and 10 GB out of 48 </span><span class="No-Break"><span class="koboSpan" id="kobo.581.1">GB RAM:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer393">
<span class="koboSpan" id="kobo.582.1"><img alt="Figure 11.14 – Listing the existing VMs" src="image/B19682_11_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.583.1">Figure 11.14 – Listing the existing VMs</span></p>
<p><span class="koboSpan" id="kobo.584.1">But what if we do not know how many resources the existing VMs use? </span><span class="koboSpan" id="kobo.584.2">There is a command that can help us with that. </span><span class="koboSpan" id="kobo.584.3">It is called </span><strong class="source-inline"><span class="koboSpan" id="kobo.585.1">virsh dominfo</span></strong><span class="koboSpan" id="kobo.586.1">. </span><span class="koboSpan" id="kobo.586.2">Let’s see the resources that one of our VMs is using, for </span><span class="No-Break"><span class="koboSpan" id="kobo.587.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.588.1">ubuntu-vm1</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.589.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer394">
<span class="koboSpan" id="kobo.590.1"><img alt="Figure 11.15 – Showing the VMs’ resource usage" src="image/B19682_11_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.591.1">Figure 11.15 – Showing the VMs’ resource usage</span></p>
<p><span class="koboSpan" id="kobo.592.1">In the preceding image, you can see that our VM is using 2 vCPUs and 2 GB of RAM. </span><span class="koboSpan" id="kobo.592.2">You can check the resource usage for</span><a id="_idIndexMarker1783"/><span class="koboSpan" id="kobo.593.1"> every VM that you manage. </span><span class="koboSpan" id="kobo.593.2">Besides vCPUs and RAM, you can also manage virtual disks for </span><a id="_idIndexMarker1784"/><span class="koboSpan" id="kobo.594.1">existing VMs. </span><span class="koboSpan" id="kobo.594.2">To see the disk usage for a VM you can use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.595.1">virt-df</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.596.1"> command:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer395">
<span class="koboSpan" id="kobo.597.1"><img alt="Figure 11.16 – Showing disk usage for a VM" src="image/B19682_11_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.598.1">Figure 11.16 – Showing disk usage for a VM</span></p>
<p><span class="koboSpan" id="kobo.599.1">We have used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">-d</span></strong><span class="koboSpan" id="kobo.601.1"> option for showing </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">libvirt</span></strong><span class="koboSpan" id="kobo.603.1"> domain guests and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">-h</span></strong><span class="koboSpan" id="kobo.605.1"> option to show the results in a human-readable format. </span><span class="koboSpan" id="kobo.605.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.606.1">virt-df</span></strong><span class="koboSpan" id="kobo.607.1"> command is similar to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.608.1">df</span></strong><span class="koboSpan" id="kobo.609.1"> command (see </span><a href="B19682_06.xhtml#_idTextAnchor124"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.610.1">Chapter 6</span></em></span></a><span class="No-Break"><span class="koboSpan" id="kobo.611.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.612.1">Knowing the resource usage is the first step in managing the resources that you have. </span><span class="koboSpan" id="kobo.612.2">In the following section, we will show you how to change the amount of resources a VM </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">is using.</span></span></p>
<h2 id="_idParaDest-231"><a id="_idTextAnchor248"/><span class="koboSpan" id="kobo.614.1">Managing VM resource usage</span></h2>
<p><span class="koboSpan" id="kobo.615.1">As shown earlier, knowing</span><a id="_idIndexMarker1785"/><span class="koboSpan" id="kobo.616.1"> how many resources a VM is using can prove of great value. </span><span class="koboSpan" id="kobo.616.2">You would need to be able to modify the resources already in use if you run out of resources. </span><span class="koboSpan" id="kobo.616.3">You have tools available to modify the amount of vCPUs and RAM an existing VM is using. </span><span class="koboSpan" id="kobo.616.4">For example, let’s change the resources for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.617.1">ubuntu-vm1-clone1</span></strong><span class="koboSpan" id="kobo.618.1"> VM from 2 vCPUs to 1 vCPU and from 2 GB of RAM to 1 GB of RAM. </span><span class="koboSpan" id="kobo.618.2">The command we will use is </span><strong class="source-inline"><span class="koboSpan" id="kobo.619.1">virsh setvcpus</span></strong><span class="koboSpan" id="kobo.620.1">, and we will use it </span><span class="No-Break"><span class="koboSpan" id="kobo.621.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer396">
<span class="koboSpan" id="kobo.622.1"><img alt="Figure 11.17 – Changing the vCPU count for a VM" src="image/B19682_11_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.623.1">Figure 11.17 – Changing the vCPU count for a VM</span></p>
<p><span class="koboSpan" id="kobo.624.1">We can also change the amount of RAM used with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.625.1">virsh setmem</span></strong><span class="koboSpan" id="kobo.626.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.628.1">setmaxmem</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.629.1"> commands:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer397">
<span class="koboSpan" id="kobo.630.1"><img alt="Figure 11.18 – Changing the memory used by a VM" src="image/B19682_11_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.631.1">Figure 11.18 – Changing the memory used by a VM</span></p>
<p><span class="koboSpan" id="kobo.632.1">We can now check the resources</span><a id="_idIndexMarker1786"/><span class="koboSpan" id="kobo.633.1"> used by the </span><strong class="source-inline"><span class="koboSpan" id="kobo.634.1">ubuntu-vm1-clone1</span></strong><span class="koboSpan" id="kobo.635.1"> VM using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">virsh dominfo</span></strong><span class="koboSpan" id="kobo.637.1"> command, as shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.638.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer398">
<span class="koboSpan" id="kobo.639.1"><img alt="Figure 11.19 – Checking the resources for a VM" src="image/B19682_11_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.640.1">Figure 11.19 – Checking the resources for a VM</span></p>
<p><span class="koboSpan" id="kobo.641.1">As you can see, the resources used by the VM have been changed according to your new settings. </span><span class="koboSpan" id="kobo.641.2">Now that you know how to manage KVMs, which is a required asset for a Linux system administrator. </span><span class="koboSpan" id="kobo.641.3">In the next section, we will show you how to automate KVM VM provisioning </span><span class="No-Break"><span class="koboSpan" id="kobo.642.1">using </span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.643.1">cloud-init</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">.</span></span></p>
<h1 id="_idParaDest-232"><a id="_idTextAnchor249"/><span class="koboSpan" id="kobo.645.1">Provisioning VMs using cloud-init</span></h1>
<p><span class="koboSpan" id="kobo.646.1">When you’re dealing with only one VM, things can be relatively simple. </span><span class="koboSpan" id="kobo.646.2">But when we have to create hundreds of VMs, manual creation can be daunting. </span><span class="koboSpan" id="kobo.646.3">One useful tool you can use for such a task is </span><strong class="bold"><span class="koboSpan" id="kobo.647.1">cloud-init</span></strong><span class="koboSpan" id="kobo.648.1">. </span><span class="koboSpan" id="kobo.648.2">Another tool that is suitable for this kind of task is </span><strong class="bold"><span class="koboSpan" id="kobo.649.1">Ansible</span></strong><span class="koboSpan" id="kobo.650.1"> (there’s more on Ansible in </span><a href="B19682_17.xhtml#_idTextAnchor359"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.651.1">Chapter 17</span></em></span></a><span class="koboSpan" id="kobo.652.1">). </span><span class="koboSpan" id="kobo.652.2">In this section, we will cover only cloud-init. </span><span class="koboSpan" id="kobo.652.3">It was developed</span><a id="_idIndexMarker1787"/><span class="koboSpan" id="kobo.653.1"> by Canonical to be used as a tool for configuring VM instances on cloud platforms, and it is written in Python. </span><span class="koboSpan" id="kobo.653.2">Currently, it is considered an industry standard for provisioning cloud images. </span><span class="koboSpan" id="kobo.653.3">In the next subsection, we will briefly explain to you how </span><span class="No-Break"><span class="koboSpan" id="kobo.654.1">cloud-init works.</span></span></p>
<h2 id="_idParaDest-233"><a id="_idTextAnchor250"/><span class="koboSpan" id="kobo.655.1">Understanding how cloud-init works</span></h2>
<p><span class="koboSpan" id="kobo.656.1">According to the official cloud-init documentation, it is based on several configuration sources, specific boot stages, user data formats, vendor data, and instance</span><a id="_idIndexMarker1788"/><span class="koboSpan" id="kobo.657.1"> metadata. </span><span class="koboSpan" id="kobo.657.2">The concept of boot stages is specific to cloud-init architecture, as it configures the entire instance during specific stages of the boot process. </span><span class="koboSpan" id="kobo.657.3">It provides a way for managing completely working instances that have networking, boot sequence, and local configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.658.1">files configured.</span></span></p>
<p><span class="koboSpan" id="kobo.659.1">Cloud-init is available on most widely used Linux distributions, such as Ubuntu, Debian, Red Hat Enterprise Linux, Fedora, SUSE, and openSUSE. </span><span class="koboSpan" id="kobo.659.2">We will use one of our Debian 12 systems as a host and install and configure cloud-init on it. </span><span class="koboSpan" id="kobo.659.3">We will show you how in the </span><span class="No-Break"><span class="koboSpan" id="kobo.660.1">following subsection.</span></span></p>
<h2 id="_idParaDest-234"><a id="_idTextAnchor251"/><span class="koboSpan" id="kobo.661.1">Installing and configuring cloud-init</span></h2>
<p><span class="koboSpan" id="kobo.662.1">Even if its main purpose is to be used for cloud deployments, cloud-init can also be used locally. </span><span class="koboSpan" id="kobo.662.2">We will use it to deploy VMs on our local system. </span><span class="koboSpan" id="kobo.662.3">As a prerequisite for using cloud-init, a hypervisor should already </span><a id="_idIndexMarker1789"/><span class="koboSpan" id="kobo.663.1">be installed on your system, such as KVM. </span><span class="koboSpan" id="kobo.663.2">For the guest image, cloud-init uses specific cloud images that are already available from almost </span><a id="_idIndexMarker1790"/><span class="koboSpan" id="kobo.664.1">every Linux distribution provider. </span><span class="koboSpan" id="kobo.664.2">For example, we are planning on deploying Ubuntu VMs, thus we will need Ubuntu-optimized cloud images, which are available at </span><a href="https://cloud-images.ubuntu.com/"><span class="koboSpan" id="kobo.665.1">https://cloud-images.ubuntu.com/</span></a><span class="koboSpan" id="kobo.666.1">. </span><span class="koboSpan" id="kobo.666.2">Let’s look at the steps required to prepare the image </span><span class="No-Break"><span class="koboSpan" id="kobo.667.1">for deployment:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.668.1">First, we will install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.669.1">cloud-image-utils</span></strong><span class="koboSpan" id="kobo.670.1"> additional package and then the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.671.1">cloud-init</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.672.1"> package:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.673.1">sudo apt install cloud-image-utils cloud-init</span></strong></pre></li> <li><span class="koboSpan" id="kobo.674.1">The next step is to create a new directory for the new </span><span class="No-Break"><span class="koboSpan" id="kobo.675.1">cloud images:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.676.1">mkdir local-cloud-images &amp;&amp; cd local-cloud-images</span></strong></pre></li> <li><span class="koboSpan" id="kobo.677.1">The next step is to download</span><a id="_idIndexMarker1791"/><span class="koboSpan" id="kobo.678.1"> the </span><span class="No-Break"><span class="koboSpan" id="kobo.679.1">cloud image:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.680.1">wget https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img</span></strong></pre></li> <li><span class="koboSpan" id="kobo.681.1">Then we get details for the</span><a id="_idIndexMarker1792"/><span class="koboSpan" id="kobo.682.1"> cloud </span><span class="No-Break"><span class="koboSpan" id="kobo.683.1">image file:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.684.1">qemu-img info jammy-server-cloudimg-amd64.img</span></strong></pre></li> <li><span class="koboSpan" id="kobo.685.1">Then we resize </span><span class="No-Break"><span class="koboSpan" id="kobo.686.1">the image:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.687.1">qemu-img resize jammy-server-cloudimg-amd64.img 15G</span></strong></pre></li> <li><span class="koboSpan" id="kobo.688.1">Create a new image as a </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">.qcow2</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.690.1">base image:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.691.1">qemu-img create -f qcow2 -F qcow2 -b jammy-server-cloudimg-amd64.img ubuntu.qcow2 15G</span></strong></pre></li> <li><span class="koboSpan" id="kobo.692.1">Copy the images to the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.693.1">libvirt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.694.1"> directory:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.695.1">sudo cp ubuntu.qcow2 /var/lib/libvirt/images/</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.696.1">Right now, we have the images ready for use. </span><span class="koboSpan" id="kobo.696.2">Some more steps are needed for the cloud-init configuration. </span><span class="koboSpan" id="kobo.696.3">We will need to create local files for metadata (called </span><strong class="source-inline"><span class="koboSpan" id="kobo.697.1">meta-data</span></strong><span class="koboSpan" id="kobo.698.1">) and another file for user data (called </span><strong class="source-inline"><span class="koboSpan" id="kobo.699.1">user-data</span></strong><span class="koboSpan" id="kobo.700.1">). </span><span class="koboSpan" id="kobo.700.2">They are </span><strong class="bold"><span class="koboSpan" id="kobo.701.1">Yet Another Markup Language</span></strong><span class="koboSpan" id="kobo.702.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.703.1">YAML</span></strong><span class="koboSpan" id="kobo.704.1">) files so you </span><a id="_idIndexMarker1793"/><span class="koboSpan" id="kobo.705.1">will need to use the </span><span class="No-Break"><span class="koboSpan" id="kobo.706.1">YAML syntax.</span></span></p></li> <li><span class="koboSpan" id="kobo.707.1">We will create a new directory (inside </span><strong class="source-inline"><span class="koboSpan" id="kobo.708.1">/var/lib/libvirt/image/</span></strong><span class="koboSpan" id="kobo.709.1">) to store the new configuration files. </span><span class="koboSpan" id="kobo.709.2">We will use the following commands </span><span class="No-Break"><span class="koboSpan" id="kobo.710.1">as root:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.711.1">mkdir cloud-init &amp;&amp; cd cloud-init/ &amp;&amp; touch user-data &amp;&amp; touch meta-data &amp;&amp; touch network-config</span></strong></pre></li> <li><span class="koboSpan" id="kobo.712.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.713.1">meta-data</span></strong><span class="koboSpan" id="kobo.714.1"> file will not be populated just yet. </span><span class="koboSpan" id="kobo.714.2">We will edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.715.1">user-data</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.716.1">file first.</span></span></li>
</ol>
<p class="callout-heading"><span class="koboSpan" id="kobo.717.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.718.1">At this point, we will need a pair of SSH keys to use to connect with the new VM we plan to create. </span><span class="koboSpan" id="kobo.718.2">As we have not shown you yet how to work with SSH keys, we will provide you with the needed information in the next subsection. </span><span class="koboSpan" id="kobo.718.3">Go ahead and read the </span><em class="italic"><span class="koboSpan" id="kobo.719.1">Public key authentication with SSH</span></em><span class="koboSpan" id="kobo.720.1"> section, then get back to this point, where we will continue configuring our </span><span class="No-Break"><span class="koboSpan" id="kobo.721.1">cloud-init files.</span></span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.722.1">Let’s create the </span><strong class="source-inline"><span class="koboSpan" id="kobo.723.1">user-data</span></strong><span class="koboSpan" id="kobo.724.1"> file and </span><a id="_idIndexMarker1794"/><span class="koboSpan" id="kobo.725.1">add the </span><span class="No-Break"><span class="koboSpan" id="kobo.726.1">following</span></span><span class="No-Break"><a id="_idIndexMarker1795"/></span><span class="No-Break"><span class="koboSpan" id="kobo.727.1"> information:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer399">
<span class="koboSpan" id="kobo.728.1"><img alt="Figure 11.20 – The user-data file contents" src="image/B19682_11_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.729.1">Figure 11.20 – The user-data file contents</span></p>
<ol>
<li value="10"><span class="koboSpan" id="kobo.730.1">After the </span><strong class="source-inline"><span class="koboSpan" id="kobo.731.1">user-data</span></strong><span class="koboSpan" id="kobo.732.1"> file editing is finished, we can continue and create a disk image that will contain the configuration files. </span><span class="koboSpan" id="kobo.732.2">We will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.733.1">cloud-localds</span></strong><span class="koboSpan" id="kobo.734.1"> command from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.735.1">cloud-image-utils</span></strong><span class="koboSpan" id="kobo.736.1"> package we </span><span class="No-Break"><span class="koboSpan" id="kobo.737.1">installed earlier:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.738.1">cloud-localds -v ubuntu-provisioning.qcow2 user-data meta-data</span></strong></pre></li> <li><span class="koboSpan" id="kobo.739.1">Now, we have created a </span><a id="_idIndexMarker1796"/><span class="koboSpan" id="kobo.740.1">new disk image based on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.741.1">user-data</span></strong><span class="koboSpan" id="kobo.742.1"> file we created. </span><span class="koboSpan" id="kobo.742.2">The</span><a id="_idIndexMarker1797"/><span class="koboSpan" id="kobo.743.1"> preparations are finished and we can start deploying. </span><span class="koboSpan" id="kobo.743.2">We will deploy our VM using the </span><span class="No-Break"><span class="koboSpan" id="kobo.744.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.745.1">sudo virt-install --name vm01 --virt-type kvm --vcpus 1 --memory 2048 --disk path=/var/lib/libvirt/images/ubuntu.qcow2,device=disk --disk path=/var/lib/libvirt/images/cloud-init/ubuntu-provisioning.qcow2,device=cdrom --os-type linux --os-variant generic --import --network network=default --noautoconsole</span></strong></pre></li> <li><span class="koboSpan" id="kobo.746.1">If you get any errors regarding the network activation, you might have to use the following commands to activate the </span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">default network:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.748.1">sudo virsh net-start default &amp;&amp; sudo virsh net-autostart default</span></strong></pre></li> <li><span class="koboSpan" id="kobo.749.1">After running the </span><strong class="source-inline"><span class="koboSpan" id="kobo.750.1">virt-install</span></strong><span class="koboSpan" id="kobo.751.1"> command, the output will be as shown </span><span class="No-Break"><span class="koboSpan" id="kobo.752.1">as follows:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer400">
<span class="koboSpan" id="kobo.753.1"><img alt="Figure 11.21 – Creating a new VM" src="image/B19682_11_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.754.1">Figure 11.21 – Creating a new VM</span></p>
<ol>
<li value="14"><span class="koboSpan" id="kobo.755.1">We now have deployed a new VM using cloud-init. </span><span class="koboSpan" id="kobo.755.2">We can verify that it is running by using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">sudo virsh list</span></strong><span class="koboSpan" id="kobo.757.1"> command or by using the Virtual Manager GUI. </span><span class="koboSpan" id="kobo.757.2">We will verify if the VM is running, we will find out the IP address and connect to it using SSH. </span><span class="koboSpan" id="kobo.757.3">We will use the</span><a id="_idIndexMarker1798"/><span class="koboSpan" id="kobo.758.1"> following commands: </span><strong class="source-inline"><span class="koboSpan" id="kobo.759.1">sudo virsh list</span></strong><span class="koboSpan" id="kobo.760.1"> to check the </span><a id="_idIndexMarker1799"/><span class="koboSpan" id="kobo.761.1">state of the VM, </span><strong class="source-inline"><span class="koboSpan" id="kobo.762.1">sudo virsh domifaddr vm01</span></strong><span class="koboSpan" id="kobo.763.1"> to find its IP, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.764.1">ssh packt@192.168.122.32</span></strong><span class="koboSpan" id="kobo.765.1"> to connect to it. </span><span class="koboSpan" id="kobo.765.2">The output is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.766.1">following screenshot:</span></span></li>
</ol>
<div>
<div class="IMG---Figure" id="_idContainer401">
<span class="koboSpan" id="kobo.767.1"><img alt="Figure 11.22 – Connecting to the new VM using SSH" src="image/B19682_11_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.768.1">Figure 11.22 – Connecting to the new VM using SSH</span></p>
<p><span class="koboSpan" id="kobo.769.1">We have successfully created and connected to a new VM using cloud-init. </span><span class="koboSpan" id="kobo.769.2">After finishing this section, you now possess the ability to deploy VMs using cloud-init. </span><span class="koboSpan" id="kobo.769.3">However, we have only scratched the surface of what cloud-init can do, so if you feel like you would like to learn more about it, please use the official documentation or any of the titles provided in the </span><em class="italic"><span class="koboSpan" id="kobo.770.1">Further reading</span></em><span class="koboSpan" id="kobo.771.1"> section at the end of </span><span class="No-Break"><span class="koboSpan" id="kobo.772.1">the chapter.</span></span></p>
<p><span class="koboSpan" id="kobo.773.1">In the next section, we will show you how to use public key authentication </span><span class="No-Break"><span class="koboSpan" id="kobo.774.1">with SSH.</span></span></p>
<h1 id="_idParaDest-235"><a id="_idTextAnchor252"/><span class="koboSpan" id="kobo.775.1">Public key authentication with SSH</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.776.1">Public key authentication</span></strong><span class="koboSpan" id="kobo.777.1"> is a secure way to log in to a virtual private server or a cloud instance through SSH. </span><span class="koboSpan" id="kobo.777.2">It provides better security and cryptographic strength than any strong password in use. </span><span class="koboSpan" id="kobo.777.3">When</span><a id="_idIndexMarker1800"/><span class="koboSpan" id="kobo.778.1"> setting up SSH key authentication, we generate a pair of two keys, a private and a public key. </span><span class="koboSpan" id="kobo.778.2">From those two keys, the private key will be stored on the local machine, and the public key will be used on the host VM. </span><span class="koboSpan" id="kobo.778.3">The keys</span><a id="_idIndexMarker1801"/><span class="koboSpan" id="kobo.779.1"> are stored inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">.ssh</span></strong><span class="koboSpan" id="kobo.781.1"> directory in your user’s home directory. </span><span class="koboSpan" id="kobo.781.2">To generate a new pair of keys, you will have to use the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">ssh-keygen</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.783.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.784.1">It can be used with options, the most relevant ones being: </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">-t</span></strong><span class="koboSpan" id="kobo.786.1"> to specify the type of encryption algorithm used, </span><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">-b</span></strong><span class="koboSpan" id="kobo.788.1"> to specify the number of bits. </span><span class="koboSpan" id="kobo.788.2">Used with no option, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.789.1">ssh-keygen</span></strong><span class="koboSpan" id="kobo.790.1"> command will use the RSA encryption algorithm and a 3,072-bit key. </span><span class="koboSpan" id="kobo.790.2">The following is the output for using the command </span><span class="No-Break"><span class="koboSpan" id="kobo.791.1">as is:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer402">
<span class="koboSpan" id="kobo.792.1"><img alt="Figure 11.23 – Using the ssh-keygen to create a pair of SSH keys" src="image/B19682_11_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.793.1">Figure 11.23 – Using the ssh-keygen to create a pair of SSH keys</span></p>
<p><span class="koboSpan" id="kobo.794.1">As mentioned earlier, the two keys are stored inside the </span><strong class="source-inline"><span class="koboSpan" id="kobo.795.1">.ssh</span></strong><span class="koboSpan" id="kobo.796.1"> directory. </span><span class="koboSpan" id="kobo.796.2">One will be called </span><strong class="source-inline"><span class="koboSpan" id="kobo.797.1">id_rsa</span></strong><span class="koboSpan" id="kobo.798.1"> and the other </span><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">id_rsa.pub</span></strong><span class="koboSpan" id="kobo.800.1">. </span><span class="koboSpan" id="kobo.800.2">For our use case, configuring cloud-init, we will need to use the public key. </span><span class="koboSpan" id="kobo.800.3">Thus, we will need to concatenate the contents of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">id_rsa.pub</span></strong><span class="koboSpan" id="kobo.802.1"> file and copy the key. </span><span class="koboSpan" id="kobo.802.2">In our case, the contents are </span><span class="No-Break"><span class="koboSpan" id="kobo.803.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer403">
<span class="koboSpan" id="kobo.804.1"><img alt="Figure 11.24 – The SSH public key" src="image/B19682_11_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.805.1">Figure 11.24 – The SSH public key</span></p>
<p><span class="koboSpan" id="kobo.806.1">However, if we need to use those keys to connect to a cloud instance of a virtual private server or a VM, the public key needs to be safely copied to that machine or instance. </span><span class="koboSpan" id="kobo.806.2">For this, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.807.1">ssh-copy-id</span></strong><span class="koboSpan" id="kobo.808.1"> command. </span><span class="koboSpan" id="kobo.808.2">When using the command, we will need to provide a username and an IP address or hostname for the destination machine. </span><span class="koboSpan" id="kobo.808.3">For example, if we were to</span><a id="_idIndexMarker1802"/><span class="koboSpan" id="kobo.809.1"> copy the SSH public key to a VM that has the IP </span><strong class="source-inline"><span class="koboSpan" id="kobo.810.1">192.168.122.48</span></strong><span class="koboSpan" id="kobo.811.1"> and a user </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">packt</span></strong><span class="koboSpan" id="kobo.813.1">, we would use the </span><span class="No-Break"><span class="koboSpan" id="kobo.814.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.815.1">
ssh-copy-id packt@192.168.122.48</span></pre> <p><span class="koboSpan" id="kobo.816.1">More details on how to install </span><a id="_idIndexMarker1803"/><span class="koboSpan" id="kobo.817.1">and configure an SSH server will be provided in </span><a href="B19682_13.xhtml#_idTextAnchor276"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.818.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.819.1">. </span><span class="koboSpan" id="kobo.819.2">The information shown here is sufficient for our </span><span class="No-Break"><span class="koboSpan" id="kobo.820.1">cloud-init task.</span></span></p>
<p><span class="koboSpan" id="kobo.821.1">Virtualization is an </span><a id="_idIndexMarker1804"/><span class="koboSpan" id="kobo.822.1">important part of computing, providing the technology needed to take advantage of the tremendous computing power that modern systems provide. </span><span class="koboSpan" id="kobo.822.2">It gives you the ability to get the most out of your investment in </span><span class="No-Break"><span class="koboSpan" id="kobo.823.1">hardware technology.</span></span></p>
<h1 id="_idParaDest-236"><a id="_idTextAnchor253"/><span class="koboSpan" id="kobo.824.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.825.1">In this chapter, we emphasized the importance of virtualization on a Linux system. </span><span class="koboSpan" id="kobo.825.2">We showed you how to create and manage VMs using KVM. </span><span class="koboSpan" id="kobo.825.3">You know how to clone, template, and manage resources for VMs; and you know how virtualization works and how to install the QEMU/KVM hypervisor on Linux. </span><span class="koboSpan" id="kobo.825.4">With those assets, you are prepared to start your path into virtualization with </span><span class="No-Break"><span class="koboSpan" id="kobo.826.1">no fears.</span></span></p>
<p><span class="koboSpan" id="kobo.827.1">In the next chapter, we will introduce you to Docker </span><span class="No-Break"><span class="koboSpan" id="kobo.828.1">container technologies.</span></span></p>
<h1 id="_idParaDest-237"><a id="_idTextAnchor254"/><span class="koboSpan" id="kobo.829.1">Exercises</span></h1>
<p><span class="koboSpan" id="kobo.830.1">Here’s a brief quiz about some of the essential concepts that were covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.832.1">Enumerate and describe the types </span><span class="No-Break"><span class="koboSpan" id="kobo.833.1">of hypervisors.</span></span></li>
<li><span class="koboSpan" id="kobo.834.1">Practice by installing a hypervisor on many </span><span class="No-Break"><span class="koboSpan" id="kobo.835.1">Linux hosts.</span></span></li>
<li><span class="koboSpan" id="kobo.836.1">Verify whether your hypervisor is </span><span class="No-Break"><span class="koboSpan" id="kobo.837.1">working correctly.</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.838.1">Hint</span></strong><span class="koboSpan" id="kobo.839.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.840.1">Use </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">virt-host-validate</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.842.1">.</span></span></p></li>
<li><span class="koboSpan" id="kobo.843.1">Can you think of significant differences between </span><span class="No-Break"><span class="koboSpan" id="kobo.844.1">major hypervisors?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.845.1">Hint</span></strong><span class="koboSpan" id="kobo.846.1">: Test KVM and VirtualBox for example, and make </span><span class="No-Break"><span class="koboSpan" id="kobo.847.1">a comparison.</span></span></p></li>
<li><span class="koboSpan" id="kobo.848.1">How can you find the IP addresses </span><span class="No-Break"><span class="koboSpan" id="kobo.849.1">of VMs?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.850.1">Hint</span></strong><span class="koboSpan" id="kobo.851.1">: Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">virsh </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.853.1">domifaddr</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.854.1"> command.</span></span></p></li>
</ol>
<h1 id="_idParaDest-238"><a id="_idTextAnchor255"/><span class="koboSpan" id="kobo.855.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.856.1">For more information on the topics covered in this chapter, you can refer to the following </span><span class="No-Break"><span class="koboSpan" id="kobo.857.1">Packt books:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.858.1">Mastering KVM Virtualization – Second Edition</span></em><span class="koboSpan" id="kobo.859.1">, Vedran D</span><a id="_idTextAnchor256"/><span class="koboSpan" id="kobo.860.1">akic, Humble Devassy Chirammal, Prasad Mukhedkar, </span><span class="No-Break"><span class="koboSpan" id="kobo.861.1">Anil Vettathu</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.862.1">KVM Virtualization Cookbook</span></em><span class="koboSpan" id="kobo.863.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.864.1">Konstantin Ivanov</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.865.1">For detailed information about the inner workings of cloud-init, visit the official documentation website </span><span class="No-Break"><span class="koboSpan" id="kobo.866.1">at </span></span><a href="https://cloudinit.readthedocs.io/en/latest/explanation/index.html"><span class="No-Break"><span class="koboSpan" id="kobo.867.1">https://cloudinit.readthedocs.io/en/latest/explanation/index.html</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.868.1">.</span></span></p>
</div>
</body></html>