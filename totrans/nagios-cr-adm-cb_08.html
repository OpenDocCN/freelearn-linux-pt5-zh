<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Managing Network Layout"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Managing Network Layout</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Creating a network host hierarchy</li><li class="listitem" style="list-style-type: disc">Using the network map</li><li class="listitem" style="list-style-type: disc">Choosing icons for hosts</li><li class="listitem" style="list-style-type: disc">Establishing a host dependency</li><li class="listitem" style="list-style-type: disc">Establishing a service dependency</li><li class="listitem" style="list-style-type: disc">Monitoring individual nodes in a cluster</li><li class="listitem" style="list-style-type: disc">Using the network map as an overlay</li></ul></div><div class="section" title="Introduction"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec68"/>Introduction</h1></div></div></div><p>While Nagios Core is still very useful when configured to monitor only a simple list of hosts and services, it includes some optional directives that allow defining some structural and functional properties of the monitored network; specifically, how the hosts and services interrelate. Describing this structure in the configuration allows some additional intelligent behavior in the monitoring and notification that Nagios Core performs.</p><p>There are two main approaches to working with network structure in Nagios Core:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Host parent definitions allow an administrator to define a hierarchy of connectivity to monitored hosts from the "point of view" of the Nagios Core server. An example might be a server with the monitored address in another subnet linked to the Nagios Core server by a router. If the router enters a <code class="literal">DOWN</code> state, it triggers Nagios Core's host reachability logic to automatically determine which hosts become inaccessible, and flags these as <code class="literal">UNREACHABLE</code> rather than <code class="literal">DOWN</code>, allowing refined notification behavior.</li><li class="listitem" style="list-style-type: disc">Host and service dependencies allow the formalization of relationships between hosts or services, usually for the purposes of suppressing unnecessary notifications. An example might be a service that tests a login to a mail service, that itself requires a database service to work properly. If Nagios Core finds that the database service and the login service are both down, a service dependency allows the suppressing of the notification about the login service; the administrator would therefore only be notified about the database service being down, which is more likely to be the actual problem.</li></ul></div><p>There is some overlap of functionality here, but the general pattern is that host parent definitions describe the structure of your network from the vantage point of your monitoring server, and host and service dependencies describe the way it functions, independent of the monitoring server. We will define both parent definitions and dependencies in this chapter, with the primary goal of filtering and improving the notifications that Nagios Core sends in response to failed checks, which can assist greatly in diagnosing problems.</p><p>We'll also look at another, more subtle benefit of establishing host parent definitions in making the network map of the Nagios Core web interface useful, and once a basic hierarchy is set up, we'll show how to customize the map's appearance (including defining icons for hosts), to make it generally useful as a network weather map.</p></div></div>
<div class="section" title="Creating a network host hierarchy"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec69"/>Creating a network host hierarchy</h1></div></div></div><p>In this recipe, we'll learn how to establish a parent-child <a id="id430" class="indexterm"/>relationship for two hosts in a very simple network, in order to take advantage of Nagios Core's reachability logic. Changing this configuration is very simple; it involves adding only one directive, and optionally changing some notification options.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec270"/>Getting ready</h2></div></div></div><p>You will need to be running a Nagios Core 3.0 or newer server, and have at least two hosts, one of which is only reachable via the other. The host that allows communications with the other is the <span class="strong"><strong>parent host</strong></span>
<a id="id431" class="indexterm"/>. You should be reasonably confident that a loss of connectivity to the parent host necessarily implies that the child host becomes unreachable from the monitoring server.</p><p>Access to the web interface of Nagios Core would also be useful, as making this change will change the appearance of the network map, discussed in the <span class="emphasis"><em>Using the network map</em></span> recipe in this chapter.</p><p>Our example will use a Nagios Core <a id="id432" class="indexterm"/>monitoring server, <code class="literal">olympus.naginet</code>, monitoring three hosts:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">calpe.naginet</code><a id="id433" class="indexterm"/>, a router</li><li class="listitem" style="list-style-type: disc"><code class="literal">janus.naginet</code><a id="id434" class="indexterm"/>, another router</li><li class="listitem" style="list-style-type: disc"><code class="literal">corsica.naginet</code>, a <a id="id435" class="indexterm"/>web server</li></ul></div><p>The hosts are connected as shown in the following diagram:</p><div class="mediaobject"><img src="graphics/5566OS_08_01.jpg" alt="Getting ready"/></div><p>Note that the Nagios Core server <code class="literal">olympus.naginet</code> is only able to communicate with the <code class="literal">corsica.naginet</code> web server if the router <code class="literal">calpe.naginet</code> is working correctly. If <span class="strong"><strong>calpe.naginet</strong></span> were to enter a <span class="strong"><strong>DOWN</strong></span> state, we would see <span class="strong"><strong>corsica.naginet</strong></span> enter a <span class="strong"><strong>DOWN</strong></span> state too:</p><div class="mediaobject"><img src="graphics/5566_08_02.jpg" alt="Getting ready"/></div><p>This is a little misleading, as we don't actually know whether <code class="literal">corsica.naginet</code> is down. It might be, but with the router in between the hosts not working correctly, Nagios Core has no way of knowing. A more informative and accurate status for the host would be <code class="literal">UNREACHABLE</code>; this is what the configuration we're about to add will arrange.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec271"/>How to do it...</h2></div></div></div><p>We can configure a parent-child <a id="id436" class="indexterm"/>relationship for our two <a id="id437" class="indexterm"/>hosts as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /usr/local/nagios/etc/objects</strong></span>
</pre></div></li><li class="listitem">Edit the file containing the definition for the child host. In our example, the child host is <code class="literal">corsica.naginet</code>, the web server. The host definition might look something similar to the following code snippet:<div class="informalexample"><pre class="programlisting">define host {
    use        linux-server
    host_name  corsica.naginet
    alias      corsica
    address    10.128.0.71
}</pre></div></li><li class="listitem">Add a new <code class="literal">parents</code> directive to the host's definition, and give it the same value as the <code class="literal">host_name</code> directive of the host on which it is dependent for connectivity. In our example, that host is <code class="literal">calpe.naginet</code>.<div class="informalexample"><pre class="programlisting">define host {
    use        linux-server
    host_name  corsica.naginet
    alias      corsica
    address    10.128.0.71
<span class="strong"><strong>    parents    calpe.naginet</strong></span>
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong></span>
<span class="strong"><strong># /etc/init.d/nagios restart</strong></span>
</pre></div></li></ol></div><p>With this done, if the parent host enters a <a id="id438" class="indexterm"/>
<span class="strong"><strong>DOWN</strong></span> state and the <a id="id439" class="indexterm"/>child host can't be contacted, then the child host will enter an <a id="id440" class="indexterm"/>
<span class="strong"><strong>UNREACHABLE</strong></span> state rather than also being flagged as <span class="strong"><strong>DOWN</strong></span>:</p><div class="mediaobject"><img src="graphics/5566_08_03.jpg" alt="How to do it..."/></div><p>The child host's contacts will also receive <code class="literal">UNREACHABLE</code> notification<a id="id441" class="indexterm"/>s instead of <code class="literal">DOWN</code> notifications for the child host, provided the <code class="literal">u</code> flag is included in <code class="literal">notification_options</code> for the host, and <code class="literal">host_notification_options</code> for the contacts. See the <span class="emphasis"><em>Specifying which states to be notified about</em></span> recipe in <a class="link" href="ch04.html" title="Chapter 4. Configuring Notifications">Chapter 4</a>, <span class="emphasis"><em>Configuring Notifications</em></span>, for details on this.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec272"/>How it works...</h2></div></div></div><p>This is a simple application of Nagios Core's reachability logic. When the check to <code class="literal">calpe.naginet</code> fails for the first time, Nagios Core notes that it is a parent host for one child host, <code class="literal">corsica.naginet</code>. If during checks for the child host it finds it cannot communicate with it, it flags an <code class="literal">UNREACHABLE</code> state instead of the <code class="literal">DOWN</code> state, firing a different notification event.</p><p>The primary advantages to this are twofold:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <code class="literal">DOWN</code> notification<a id="id442" class="indexterm"/> is only sent for the nearest problem parent host. All other hosts beyond that host fire <code class="literal">UNREACHABLE</code> notifications<a id="id443" class="indexterm"/>. This means that Nagios Core's reachability logic automatically determines the point of failure from its perspective, which can be very handy in diagnosing which host is actually experiencing a problem.</li><li class="listitem" style="list-style-type: disc">If the host is a parent to a large number of other hosts, the configuration can be arranged not to send urgent notifications for <code class="literal">UNREACHABLE</code> hosts. There may not be much point sending a hundred pager or e-mail messages to an administrator when a very central router goes down; they know there are problems with the downstream <a id="id444" class="indexterm"/>hosts, so all we would be doing is distracting them with useless information.</li></ul></div><p>With a little planning and some knowledge of the network, all we need to do is add a few <code class="literal">parents</code> directives to host definitions to build a simple network structure, and Nagios Core will behave much more intelligently as a result. This is one of the easiest ways to refine the notification behavior of Nagios Core; it can't be recommended enough!</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec273"/>There's more...</h2></div></div></div><p>Note that a child host can itself be a parent to other hosts in turn, allowing a nesting network structure. Perhaps in another situation, we might find that the <code class="literal">corsica.naginet</code>
<a id="id445" class="indexterm"/> server is two routers away from the monitoring server:</p><div class="mediaobject"><img src="graphics/5566OS_08_04.jpg" alt="There's more..."/></div><p>In this case, not only is <code class="literal">corsica.naginet</code> the child host of <code class="literal">calpe.naginet</code>, but <code class="literal">calpe.naginet</code> is itself the child host of <code class="literal">janus.naginet</code>. We could specify this relationship in exactly the same way:</p><div class="informalexample"><pre class="programlisting">define host {
    use        linux-router
    host_name  calpe.naginet
    alias      calpe
    address    10.128.0.129
<span class="strong"><strong>    parents    janus.naginet</strong></span>
}</pre></div><p>It's also possible to set multiple parents for a host, if there are two possible paths to the same machine:</p><div class="informalexample"><pre class="programlisting">define host {
    use        linux-server
    host_name  corsica.naginet
    alias      corsica
    address    10.128.0.71
<span class="strong"><strong>    parents    calpe.naginet,janus.naginet</strong></span>
}</pre></div><p>With this configuration, <code class="literal">corsica.naginet</code> would only be deemed <code class="literal">UNREACHABLE</code> if both of its parent hosts were down. This kind of configuration is useful to account for redundant paths in a network; use cases could include spanning tree technologies, or dynamic routing failover.</p><p>After you've set up a good basic structure for your network using the <code class="literal">parents</code> directive, definitely check out the <span class="emphasis"><em>Using the network map</em></span> recipe in this chapter to get some automatic visual feedback about your network's structure as generated from your new configuration.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec274"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using the network map</em></span> and <span class="emphasis"><em>Establishing a host dependency</em></span> recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Specifying which states to be notified about</em></span> and <span class="emphasis"><em>Configuring notification groups</em></span> recipes in <a class="link" href="ch04.html" title="Chapter 4. Configuring Notifications">Chapter 4</a>, <span class="emphasis"><em>Configuring Notifications</em></span></li></ul></div></div></div>
<div class="section" title="Using the network map"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec70"/>Using the network map</h1></div></div></div><p>In this recipe, we'll examine our network hierarchy in the network map (or status map) in the Nagios Core web interface. The network map <a id="id446" class="indexterm"/>takes the form of a generated graphic showing the hierarchy of hosts and their current states. You can learn how to establish such a hierarchy in the recipe <span class="emphasis"><em>Creating a network host hierarchy</em></span> in this chapter. The network map allows filtering to show specific hosts, and clicking on hosts to navigate through larger networks.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec275"/>Getting ready</h2></div></div></div><p>You will need to be running a Nagios Core 3.0 or newer server, and have access to its web interface. You will also need permission to view the states of hosts, preferably all hosts. You can arrange this by adding your username in the <code class="literal">authorized_for_all_hosts</code> directive, normally in <code class="literal">/usr/local/nagios/etc/cgi.cfg</code>; for example, for the user <code class="literal">tom</code>, we might configure the directive to read as follows:</p><div class="informalexample"><pre class="programlisting">authorized_for_all_hosts=nagiosadmin,tom</pre></div><p>By default, the <code class="literal">nagiosadmin</code> user<a id="id447" class="indexterm"/> should have all the necessary permissions to view the complete map.</p><p>The network map is not particularly useful without at least a few hosts configured and arranged in a hierarchy, so if you have not set any <code class="literal">parents</code> directives for your hosts, then you may wish to read the <span class="emphasis"><em>Creating a network host hierarchy</em></span> recipe in this chapter first, and arrange your monitored hosts as it explains.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec276"/>How to do it...</h2></div></div></div><p>We can inspect the network map for our newly <a id="id448" class="indexterm"/>configured host hierarchy like so:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Log in to the Nagios Core web interface.</li><li class="listitem">Click on the <span class="strong"><strong>Map</strong></span> item in the menu on the left:<div class="mediaobject"><img src="graphics/5566_08_05.jpg" alt="How to do it..."/></div><p>You should be presented with a generated graphic showing all the hosts in your network that your user has permissions to view:</p><div class="mediaobject"><img src="graphics/5566_08_06.jpg" alt="How to do it..."/></div></li><li class="listitem">Hover over any host with the mouse to <a id="id449" class="indexterm"/>see a panel breaking down the host's current state:<div class="mediaobject"><img src="graphics/5566_08_07.jpg" alt="How to do it..."/></div></li><li class="listitem">By default, the network map is centered around the <a id="id450" class="indexterm"/>Nagios Process icon. Try clicking on one of your hosts to recenter the map; in this example, it's recentered on <code class="literal">calpe.naginet</code>:<div class="mediaobject"><img src="graphics/5566_08_08.jpg" alt="How to do it..."/></div></li></ol></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec277"/>How it works...</h2></div></div></div><p>The network map is automatically generated from your host configuration. By default, it arranges the hosts in sectors, radiating outward from the central <a id="id451" class="indexterm"/>Nagios Process icon, using lines to show dependencies, and adjusting background colors to green for <code class="literal">UP</code> states, and red for <code class="literal">DOWN</code> or <code class="literal">UNREACHABLE</code> states.</p><p>This map is generated via the <span class="strong"><strong>GD2 library</strong></span>
<a id="id452" class="indexterm"/>, written by Thomas Boutell. It takes the form of a linked image map. This means that you can simply right-click the image to save it while the network is in a particular state for later reference, and also that individual nodes can be clicked to recenter the map around the nominated host. This is particularly useful for networks with a large number of hosts and very many levels of parent/child host relationships.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec278"/>There's more...</h2></div></div></div><p>Note that the form in the panel in the top-right allows customizing the appearance of the map directly:</p><div class="mediaobject"><img src="graphics/5566_08_09.jpg" alt="There's more..."/></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Layout Method</strong></span>: This allows <a id="id453" class="indexterm"/>you to select the algorithm used to arrange and draw the hosts. It's worth trying each of these to see which you prefer for your particular network layout.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Scaling factor</strong></span>: Change the value here to <a id="id454" class="indexterm"/>reduce or increase the size of the map image; values between <code class="literal">0.0</code> and <code class="literal">1.0</code> will reduce the image's size, and values above <code class="literal">1.0</code> will increase it.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Drawing Layers</strong></span>: If your hosts are <a id="id455" class="indexterm"/>organized into hostgroups, you can filter the map to only display hosts belonging to particular groups.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Layer mode</strong></span>: If you selected any host <a id="id456" class="indexterm"/>groups in the <span class="strong"><strong>Drawing Layers</strong></span> option<a id="id457" class="indexterm"/>, this allows you to select whether you want to include hosts in those groups in the map, or exclude them from it.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Suppress popups</strong></span>: If you find the yellow <a id="id458" class="indexterm"/>information popups that appear when hovering over hosts annoying, then you can turn them off by selecting this checkbox.</li></ul></div><p>After selecting or changing any one of these options, you will need to click on <span class="strong"><strong>Update</strong></span> to apply them.</p><p>The appearance of the status map can be configured well beyond this by changing directives in the Nagios Core configuration file, and adding some directives to your hosts; take a look at the recipes under the <span class="emphasis"><em>See also</em></span> section of this recipe for some examples of how this is done.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec279"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Customizing appearance of the network map</em></span>, <span class="emphasis"><em>Choosing icons for hosts</em></span>, <span class="emphasis"><em>Specifying coordinates for a host on the network map</em></span>, and <span class="emphasis"><em>Using the network map as an overlay</em></span> recipes in this chapter</li></ul></div></div></div>
<div class="section" title="Choosing icons for hosts"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec71"/>Choosing icons for hosts</h1></div></div></div><p>In this recipe, we'll learn how to select graphics for hosts, to appear in various parts of the Nagios Core web interface. This is done by adding directives to a <a id="id459" class="indexterm"/>
<a id="id460" class="indexterm"/>host to specify the paths to appropriate images to represent it.</p><p>Adding these definitions has no effect on Nagios Core's monitoring behavior; they are mostly cosmetic changes, although it's useful to see at a glance whether a particular node is a server or a workstation, particularly on the network map.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec280"/>Getting ready</h2></div></div></div><p>You will need to be running a Nagios Core 3.0 or newer server, and have access to its web interface. You must also be able to edit the configuration files for the server.</p><p>It's a good idea to check that you actually have the required images installed. The default set of icons is included in <code class="literal">/usr/local/nagios/share/images/logos</code>. Don't confuse this with its parent directory, <code class="literal">images</code>, which contains images used as part of the Nagios Core web interface itself.</p><p>In the <code class="literal">logos</code> directory, you should find a number of images in various formats. In this example, we're interested in the <code class="literal">router</code> and <code class="literal">rack-server</code> icons:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ ls /usr/local/nagios/share/images/logos/{router,rack-server}.*</strong></span>
<span class="strong"><strong>/usr/local/nagios/share/images/logos/rack-server.gd2</strong></span>
<span class="strong"><strong>/usr/local/nagios/share/images/logos/rack-server.gif</strong></span>
<span class="strong"><strong>/usr/local/nagios/share/images/logos/router.gd2</strong></span>
<span class="strong"><strong>/usr/local/nagios/share/images/logos/router.gif</strong></span>
</pre></div><p>To get the full benefit of the icons, you'll likely want to be familiar with using the network map, and have access to view it with the appropriate hosts in your own Nagios Core instance. The network map is introduced in the <span class="emphasis"><em>Using the network map</em></span> recipe in this chapter.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec281"/>How to do it...</h2></div></div></div><p>We can define images to be used in displaying our host as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /usr/local/nagios/etc/objects</strong></span>
</pre></div></li><li class="listitem">Add three new directives to each of the hosts to <a id="id461" class="indexterm"/><a id="id462" class="indexterm"/>which you want to apply the icons. In this example, the <code class="literal">rack-server</code> icon is assigned to <code class="literal">corsica.naginet</code>, and the <code class="literal">router</code> icon to both <code class="literal">calpe.naginet</code> and <code class="literal">corsica.naginet</code>:<div class="informalexample"><pre class="programlisting">define host {
    use              linux-server
    host_name        corsica.naginet
	alias            corsica
	address          10.128.0.71
<span class="strong"><strong>    icon_image       rack-server.gif</strong></span>
<span class="strong"><strong>    icon_image_alt   Rack Server</strong></span>
<span class="strong"><strong>    statusmap_image  rack-server.gd2</strong></span>
}
define host {
    use              linux-router
    host_name        janus.naginet
    alias            janus
	address          10.128.0.128
<span class="strong"><strong>    icon_image       router.gif</strong></span>
<span class="strong"><strong>    icon_image_alt   Router</strong></span>
<span class="strong"><strong>    statusmap_image  router.gd2</strong></span>
}
define host {
    use              linux-router
    host_name        calpe.naginet
    alias            calpe
	address          10.128.0.129
<span class="strong"><strong>    icon_image       router.gif</strong></span>
<span class="strong"><strong>    icon_image_alt   Router</strong></span>
<span class="strong"><strong>    statusmap_image  router.gd2</strong></span>
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong></span>
<span class="strong"><strong># /etc/init.d/nagios restart</strong></span>
</pre></div></li></ol></div><p>With this done, a visit to the status map should display the <a id="id463" class="indexterm"/>
<a id="id464" class="indexterm"/>appropriate hosts with icons rather than question marks:</p><div class="mediaobject"><img src="graphics/5566_08_10.jpg" alt="How to do it..."/></div><p>The <span class="strong"><strong>Hosts</strong></span> list should also include a scaled-down version of the image:</p><div class="mediaobject"><img src="graphics/5566_08_11.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec282"/>How it works...</h2></div></div></div><p>When a host list, service list, or network status map is generated, it checks for the presence of <code class="literal">icon_image</code> or <code class="literal">statusmap_image</code> values for each host object, reads the appropriate image if defined, and includes that as part of its processing. The network status map defaults to displaying only a question mark in the absence of a value for the <code class="literal">statusmap_image</code> directive.</p><p>Note that for the <code class="literal">statusmap_image</code> directive<a id="id465" class="indexterm"/>, we chose the <code class="literal">.gd2</code> version of the icon rather than the <code class="literal">.gif</code> version. This is for performance reasons; the status map is generated with the GD2 library, which deals more efficiently with <a id="id466" class="indexterm"/>
<a id="id467" class="indexterm"/>its native <code class="literal">.gd2</code> format.</p><p>The <a id="id468" class="indexterm"/>
<code class="literal">icon_image_alt</code> directive defines the value for the <code class="literal">alt</code> attribute when the image is displaying in an <code class="literal">&lt;img&gt;</code> HTML tag. Most web browsers will show the contents of this tag after briefly hovering over the icon.</p><p>Nagios Core 3.0 allows you to put these directives in a separate <a id="id469" class="indexterm"/>
<code class="literal">hostextinfo</code> object, but this object type is officially deprecated as of Nagios Core 4.0, so it's recommended to avoid it.</p></div><div class="section" title="There's more"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec283"/>There's more</h2></div></div></div><p>If you have a number of hosts that need to share the same image, it's a good practice to inherit from a common host template with the appropriate directives set. For our example, we might define a template as follows:</p><div class="informalexample"><pre class="programlisting">define host {
    name             router-icon
    icon_image       router.gif
    icon_image_alt   Router
    statusmap_image  router.gd2
    register         0
}</pre></div><p>We could then apply the image settings directly to both our routers simply by inheriting from that template, by adding it to the <code class="literal">use</code> directive:</p><div class="informalexample"><pre class="programlisting">define host {
<span class="strong"><strong>    use        linux-router,router-icon</strong></span>
    host_name  janus.naginet
    alias      janus
    address    10.128.0.128
}
define host {
<span class="strong"><strong>    use        linux-router,router-icon</strong></span>
    host_name  calpe.naginet
    alias      calpe
    address    10.128.0.129
}</pre></div><p>If you don't like the included icon set, there are many icon sets available online on the Nagios Exchange site at <a class="ulink" href="http://exchange.nagios.org/">http://exchange.nagios.org/</a>. If you want, you could even make your own, out of pictures of your physical hardware, saved in standard PNG or GD2 format.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec284"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Using the network map</em></span> and <span class="emphasis"><em>Specifying coordinates for a host on the network map</em></span> recipes in this chapter</li></ul></div></div></div>
<div class="section" title="Establishing a host dependency"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec72"/>Establishing a host dependency</h1></div></div></div><p>In this recipe, we'll learn how to establish a host dependency between two hosts. This feature can be used to control how Nagios Core checks <a id="id470" class="indexterm"/>hosts and notifies us about problems in situations where if one host is <code class="literal">DOWN</code>, it implies that at least one other host is necessarily <code class="literal">DOWN</code>.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec285"/>Getting ready</h2></div></div></div><p>First of all, it's very important to note that this is not quite the same thing as a host being <code class="literal">UNREACHABLE</code>, which is what the <code class="literal">parents</code> directive is for, as discussed in the <span class="emphasis"><em>Creating a network host hierarchy</em></span> recipe in this chapter. Most of the time, a host actually being <code class="literal">DOWN</code> does not mean that other hosts actually go <code class="literal">DOWN</code> by definition. It's more typical for a child host to simply be <code class="literal">UNREACHABLE</code>; it might be working fine, but Nagios Core can't check it because of the <code class="literal">DOWN</code> host in its path.</p><p>However, there's one particularly broad category where host dependencies are definitely useful: the host/guest relationship of virtual machines. If you are monitoring both a host physical machine and one or more guest virtual machines, then the virtual machines are definitely dependent on the host; if the host machine is actually in a <code class="literal">DOWN</code> state and has no redundant failover, then it would imply that the guests were <code class="literal">DOWN</code> as well, and not simply <code class="literal">UNREACHABLE</code>.</p><p>We'll use <span class="strong"><strong>virtualization</strong></span> as an example, with two virtual machines <code class="literal">zeus.naginet</code> and <code class="literal">athena.naginet</code> running on a host machine, <code class="literal">ephesus.naginet</code>. All three are already monitored, but we'll establish a host dependency so that Nagios Core doesn't notify anyone about the guests' state if it determines that the host is <code class="literal">DOWN</code>.</p><p>You will need a Nagios Core 3.0 or newer server, and have shell access to change its backend configuration.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec286"/>How to do it...</h2></div></div></div><p>We can establish our host <a id="id471" class="indexterm"/>dependencies as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /usr/local/nagios/etc/objects</strong></span>
</pre></div></li><li class="listitem">Create or edit an appropriate file that will be included by the configuration in <code class="literal">/usr/local/nagios/etc/nagios.cfg</code>. A sensible choice could be <code class="literal">/usr/local/nagios/etc/objects/dependencies.cfg</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># vi dependencies.cfg</strong></span>
</pre></div></li><li class="listitem">Add a <code class="literal">hostdependency</code> definition. In our case, the definition looks similar to the following code snippet. Note that you can include multiple dependent hosts by separating their names with commas:<div class="informalexample"><pre class="programlisting">define hostdependency {
    host_name                      ephesus.naginet
    dependent_host_name            zeus.naginet,athena.naginet
    execution_failure_criteria     n
    notification_failure_criteria  d,u
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong></span>
<span class="strong"><strong># /etc/init.d/nagios restart</strong></span>
</pre></div></li></ol></div><p>With this done, if the <code class="literal">ephesus.naginet</code> host goes down and takes both the <code class="literal">zeus.naginet</code> and <code class="literal">athena.naginet</code> hosts down with it, then checks to all three hosts will continue but notifications will be suppressed for the two guest hosts.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec287"/>How it works...</h2></div></div></div><p>The host dependency object's four directives <a id="id472" class="indexterm"/>are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">host_name</code>: This is the name of the host on <a id="id473" class="indexterm"/><a id="id474" class="indexterm"/>which at least one other host is dependent. We'll refer to this as the dependency host. This can also be a comma-separated list of host names.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dependent_host_name</code>: This is the name of the <a id="id475" class="indexterm"/><a id="id476" class="indexterm"/>dependent host. Again, this can be a comma-separated list.</li><li class="listitem" style="list-style-type: disc"><code class="literal">execution_failure_criteria</code>: This <a id="id477" class="indexterm"/><a id="id478" class="indexterm"/>defines a list of states for the dependency host. If that host is in any of these states, then Nagios Core will skip checks for the dependent hosts. This can be a comma-separated list of any of the following flags:<div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">o</code>: Dependency host <a id="id479" class="indexterm"/><a id="id480" class="indexterm"/>is <code class="literal">UP</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">d</code>: Dependency <a id="id481" class="indexterm"/><a id="id482" class="indexterm"/>host is <code class="literal">DOWN</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">u</code>: Dependency host is <a id="id483" class="indexterm"/><a id="id484" class="indexterm"/><code class="literal">UNREACHABLE</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">p</code>: Dependency host is <code class="literal">PENDING</code> <a id="id485" class="indexterm"/><a id="id486" class="indexterm"/>(not checked yet)</li></ul></div><p>Alternatively, the single flag <code class="literal">n</code> can be used (as it is in this example), to specify that the checks should take place regardless of the dependency host's state.</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">notification_failure_criteria</code>: This <a id="id487" class="indexterm"/><a id="id488" class="indexterm"/>defines a list of states for the dependency host. If that host is in any of these states, then notifications for the dependent host will not be sent. The flags are the same as for <code class="literal">execution_failure_criteria</code>; in this example, we've chosen to suppress the notifications if the dependency host is <code class="literal">DOWN</code> or <code class="literal">UNREACHABLE</code>.</li></ul></div><p>When Nagios Core notices that the <code class="literal">zeus.naginet</code> or <code class="literal">athena.naginet</code> hosts have apparently gone <code class="literal">DOWN</code> as a result of a failed host check, it refers to its configuration to check if there are any dependencies for the host, and finds that they depend on <code class="literal">ephesus.naginet</code>.</p><p>It then checks the status of <code class="literal">ephesus.naginet</code> and finds it to be <code class="literal">DOWN</code>. Referring to the <code class="literal">execution_failure_criteria</code> directive and finding <code class="literal">n</code>, it continues to run checks for both of the dependent hosts as <code class="literal">normal</code>. However, referring to the <code class="literal">notification_failure_criteria</code> directive and finding <code class="literal">d,u</code>, it determines that notifications should be suppressed until the host returns to an <code class="literal">UP</code> state.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec288"/>There's more...</h2></div></div></div><p>We can specify groups rather than host names for dependencies using the <code class="literal">hostgroup_name</code> and <a id="id489" class="indexterm"/>
<a id="id490" class="indexterm"/>
<code class="literal">dependent_hostgroup_name</code> directives:</p><div class="informalexample"><pre class="programlisting">define hostdependency {
<span class="strong"><strong>    hostgroup_name                 vm-hosts</strong></span>
<span class="strong"><strong>    dependent_hostgroup_name       vm-guests</strong></span>
    execution_failure_criteria     n
    notification_failure_criteria  d,u
}</pre></div><p>We can also provide comma-separated lists of dependency hosts:</p><div class="informalexample"><pre class="programlisting">define hostdependency {
<span class="strong"><strong>    host_name            ephesus.naginet,alexandria.naginet</strong></span>
    dependent_host_name  zeus.naginet,athena.naginet    
    execution_failure_criteria     n
    notification_failure_criteria  d,u
}</pre></div><p>If a host depends on more than one host, the check or notification rules apply if any of its dependencies are not met, rather than all of them. For the previous example, this means that if <code class="literal">ephesus.naginet</code> was <code class="literal">DOWN</code>, but <code class="literal">alexandria.naginet</code> was <code class="literal">UP</code>, then the dependency would still suppress checks or notifications for all dependent hosts.</p><p>This means that host dependencies are not really suitable in redundant scenarios where the loss of one of the depended-upon hosts does not necessarily imply the loss of all its dependent hosts. You are likely to find that monitoring nodes as a cluster is a better fit for this situation; this is discussed in the <span class="emphasis"><em>Monitoring individual nodes as a cluster</em></span> recipe, also in this chapter.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec289"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Establishing a service dependency</em></span>, <span class="emphasis"><em>Creating a network host hierarchy</em></span>, and <span class="emphasis"><em>Monitoring individual nodes as a cluster</em></span> recipes in this chapter</li></ul></div></div></div>
<div class="section" title="Establishing a service dependency"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec73"/>Establishing a service dependency</h1></div></div></div><p>In this recipe, we'll learn how to establish a service dependency between two services. This feature can be used to control how Nagios Core checks <a id="id491" class="indexterm"/>services and notifies us about problems in situations where if one service is in a <code class="literal">PROBLEM</code> state, it implies that at least one other service is necessarily also in a <code class="literal">PROBLEM</code> state.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec290"/>Getting ready</h2></div></div></div><p>You will need a Nagios Core 3.0 or newer server, and have shell access to change its backend configuration. You will also need to have at least two services defined, one of which is by definition dependent on the other; this means that if the dependency service were to enter <code class="literal">CRITICAL</code> state, then it would imply that the dependent service would also be <code class="literal">CRITICAL</code>.</p><p>We'll use a simple example: suppose we are testing authentication to a mail server <code class="literal">marathon.naginet</code> with a service <code class="literal">MAIL_LOGIN</code>, and also checking a database service <code class="literal">MAIL_DB</code> on the same host, which stores the login usernames and password hashes.</p><p>In this situation, it might well be the case that if <code class="literal">MAIL_DB</code> is not working, then <code class="literal">MAIL_LOGIN</code> will almost certainly not be working either. If so, then we can configure Nagios Core to be aware that the <code class="literal">MAIL_LOGIN</code> service<a id="id492" class="indexterm"/> is dependent on the <code class="literal">MAIL_DB</code> service.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec291"/>How to do it...</h2></div></div></div><p>We can establish our service <a id="id493" class="indexterm"/>dependency as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /usr/local/nagios/etc/objects</strong></span>
</pre></div></li><li class="listitem">Create or edit an appropriate file that will be included by the configuration in <code class="literal">/usr/local/nagios/etc/nagios.cfg</code>. A sensible choice could be <code class="literal">/usr/local/nagios/etc/objects/dependencies.cfg</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># vi dependencies.cfg</strong></span>
</pre></div></li><li class="listitem">Add a <code class="literal">servicedependency</code> definition. In our case, the definition looks similar to the following code snippet:<div class="informalexample"><pre class="programlisting">define servicedependency {
    host_name                      marathon.naginet
    service_description            MAIL_DB
    dependent_host_name            marathon.naginet
	dependent_service_description  MAIL_LOGIN
    execution_failure_criteria     c
    notification_failure_criteria  c
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong></span>
<span class="strong"><strong># /etc/init.d/nagios restart</strong></span>
</pre></div></li></ol></div><p>With this done, if the <code class="literal">MAIL_DB</code> service fails for whatever reason and enters a <code class="literal">CRITICAL</code> state, the <code class="literal">MAIL_LOGIN</code> service will skip its checks of that service, and also skip any notifications that it would normally send about its own problems, if any. Note that the web interface may still show Nagios Core is scheduling checks, but it won't actually run them.</p></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec292"/>How it works...</h2></div></div></div><p>The service dependency object's five directives are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">host_name</code>: This is the name of the <a id="id494" class="indexterm"/><a id="id495" class="indexterm"/>host with which these services are associated. We'll refer to this as the dependency host.</li><li class="listitem" style="list-style-type: disc"><code class="literal">service_description</code>: This is the <a id="id496" class="indexterm"/><a id="id497" class="indexterm"/>description of the service being depended upon. It can be a comma-separated list. We'll refer to this as the dependency service.</li><li class="listitem" style="list-style-type: disc"><code class="literal">dependent_service_description</code>: This is the <a id="id498" class="indexterm"/><a id="id499" class="indexterm"/>description of the dependent service. It can also be a comma-separated list.</li><li class="listitem" style="list-style-type: disc"><code class="literal">execution_failure_criteria</code>: This defines a list of states for the dependency service. If that service is in any of these <a id="id500" class="indexterm"/><a id="id501" class="indexterm"/>states, then Nagios Core will skip the checks for the dependent services. It can be a comma-separated list of any of the following flags:</li><li class="listitem" style="list-style-type: disc"><code class="literal">o</code>: Dependency service is <a id="id502" class="indexterm"/><a id="id503" class="indexterm"/><code class="literal">OK</code><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">w</code>: Dependency service is <a id="id504" class="indexterm"/><a id="id505" class="indexterm"/><code class="literal">WARNING</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">c</code>: Dependency service is <code class="literal">CRITICAL</code> <a id="id506" class="indexterm"/><a id="id507" class="indexterm"/>(as in this example)</li><li class="listitem" style="list-style-type: disc"><code class="literal">u</code>: Dependency service is <a id="id508" class="indexterm"/><a id="id509" class="indexterm"/><code class="literal">UNKNOWN</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">p</code>: Dependency service is <code class="literal">PENDING</code> <a id="id510" class="indexterm"/><a id="id511" class="indexterm"/>(not checked yet)</li></ul></div><p>Alternatively, the single flag <code class="literal">n</code> can be used to specify that the checks should take place regardless of the dependency service's state. In this example, we've chosen the value <code class="literal">c</code> to suppress service checks only if the dependency service is <code class="literal">CRITICAL</code>.</p></li><li class="listitem" style="list-style-type: disc"><code class="literal">notification_failure_criteria</code>: This defines a <a id="id512" class="indexterm"/>list of states for the dependency service. If that service is in any of <a id="id513" class="indexterm"/>these states, then notifications for the dependent service will not be sent. The flags are the same as for <code class="literal">execution_failure_criteria</code>; in this example, we've again chosen the value <code class="literal">c</code> to suppress the notifications only if the dependency service is <code class="literal">CRITICAL</code>.</li></ul></div><p>When Nagios Core notices the <code class="literal">MAIL_DB</code> service has gone <code class="literal">CRITICAL</code> as a result of a failed service check, it refers to its configuration to check if there are any dependencies for the service, and finds that they depend on <code class="literal">MAIL_LOGIN</code>.</p><p>It then checks the status of <code class="literal">MAIL_DB</code> and finds it to be <code class="literal">CRITICAL</code>. Referring to the <code class="literal">execution_failure_criteria</code> directive and finding <code class="literal">c</code>, it prevents checks for both of the dependent services. Referring to the <code class="literal">notification_failure_criteria</code> directive and also finding <code class="literal">c</code>, it also decides that notifications should be suppressed until the service returns to any other state.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec293"/>There's more...</h2></div></div></div><p>Note that services do not have to be on the same host to depend upon one another. We can add <code class="literal">dependent_host_name</code> or <code class="literal">dependent_hostgroup_name</code> directives to specify other hosts:</p><div class="informalexample"><pre class="programlisting">define servicedependency {
<span class="strong"><strong>    host_name                      marathon.naginet</strong></span>
    service_description            MAIL_DB
<span class="strong"><strong>    dependent_host_name            sparta.naginet</strong></span>
    dependent_service_description  WEBMAIL_LOGIN
    execution_failure_criteria     c
    notification_failure_criteria  c
}</pre></div><p>In this example, the <code class="literal">WEBMAIL_LOGIN</code> service<a id="id514" class="indexterm"/> on <code class="literal">sparta.naginet</code> is defined as dependent on the <code class="literal">MAIL_DB</code> service on <code class="literal">marathon.naginet</code>. Note that the values for <code class="literal">host_name</code> and <code class="literal">dependent_host_name</code> are different.</p><p>In versions of Nagios Core before 3.3.1, the <code class="literal">dependent_host_name</code> directive is required, even if it is the same as the <code class="literal">host_name</code>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec294"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Establishing a host dependency</em></span> and <span class="emphasis"><em>Monitoring individual nodes as a cluster</em></span> recipes in this chapter</li></ul></div></div></div>
<div class="section" title="Monitoring individual nodes in a cluster"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec74"/>Monitoring individual nodes in a cluster</h1></div></div></div><p>In this recipe, we'll learn how to monitor a collection of hosts in a cluster, using the <code class="literal">check_cluster</code> plugin <a id="id515" class="indexterm"/>included in the standard Nagios Plugins. Being able to monitor more than one host collectively is useful in situations with redundancy; one of a set of hosts being <code class="literal">DOWN</code>, perhaps for power conservation or <a id="id516" class="indexterm"/>maintenance reasons, is not necessarily a cause for notification. However, if a larger number or all of the hosts were down, we would definitely want to be notified. Using <code class="literal">check_cluster</code> allows us to arrange this.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec295"/>Getting ready</h2></div></div></div><p>You will need a Nagios Core 3.0 or newer server, and have shell access to change its backend configuration. You will also need to have at least two monitored hosts in a redundant setup for some function, such as database replication, DNS servers, or load-balanced web servers.</p><p>You should also be familiar with the way hosts and services are defined, and in particular defining commands; these concepts are discussed in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <span class="emphasis"><em>Understanding Hosts, Services, and Contacts</em></span>.</p><p>For this example, we'll work with three blade servers with hostnames <code class="literal">achilles.naginet</code>, <code class="literal">odysseus.naginet</code>, and <code class="literal">agamemnon.naginet</code>, running in a redundant cluster to support a virtual hosting environment. All three hosts are already being monitored to send an e-mail message if one of them goes down. We will arrange a <code class="literal">check_cluster</code> service on a "dummy host" in such a way that:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If none of the blades is down, the service is <code class="literal">OK</code></li><li class="listitem" style="list-style-type: disc">If one of the blades is down, the service enters <code class="literal">WARNING</code> state, again notifying us as appropriate</li><li class="listitem" style="list-style-type: disc">If two or all three of the blades are down, the service enters <code class="literal">CRITICAL</code> state, again notifying us as appropriate</li></ul></div></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec296"/>How to do it...</h2></div></div></div><p>We can arrange a cluster check for our hosts as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /usr/local/nagios/etc/objects</strong></span>
</pre></div></li><li class="listitem">Create or edit an appropriate file for defining a new command. A sensible choice might be <code class="literal">/usr/local/nagios/etc/objects/commands.cfg</code>.</li><li class="listitem">Define two new commands in this file, <code class="literal">check_dummy</code> and <code class="literal">check_host_cluster</code>:<div class="informalexample"><pre class="programlisting">define command {
    command_name  check_dummy
    command_line  $USER1$/check_dummy $ARG1$ $ARG2$
}
define command {
    command_name  check_host_cluster
    command_line  $USER1$/check_cluster -h -d $ARG1$ -w $ARG2$ -c $ARG3$
}</pre></div></li><li class="listitem">Create or edit an appropriate file that will be <a id="id517" class="indexterm"/>included by the configuration in <code class="literal">/usr/local/nagios/etc/nagios.cfg</code>. A sensible choice might be <code class="literal">/usr/local/nagios/etc/objects/clusters.cfg</code>.</li><li class="listitem">Define a dummy host for the cluster with the following values:<div class="informalexample"><pre class="programlisting">define host {
    use                 generic-host
    host_name           naginet-blade-cluster
    alias               Naginet Blade Cluster
    address             127.0.0.1
    max_check_attempts  1
    contact_groups      admins
    check_command       check_dummy!0!"Dummy host only"
}</pre></div><p>Note that the <code class="literal">address</code> directive<a id="id518" class="indexterm"/> has the value <code class="literal">127.0.0.1</code>; this is deliberate, as the dummy host itself does not really need to be actively checked or send any notifications.</p></li><li class="listitem">Add a service for the dummy host:<div class="informalexample"><pre class="programlisting">define service {
    use                   generic-service
    host_name             naginet-blade-cluster
    service_description   CLUSTER
<span class="strong"><strong>    check_command         check_host_cluster!$HOSTSTATEID:achilles.naginet$,$HOSTSTATEID:odysseus.naginet$,$HOSTSTATEID:agamemnon.naginet$!@1:!@2:</strong></span>
    notification_options  c,w,r
}</pre></div><p>The suggestion of inheriting from <code class="literal">generic-service</code> is only an example; you will likely want to use your own template or values. Note that the value for <code class="literal">check_command</code> is all on one line, with no spaces. You should substitute the hostnames of your own machines.</p></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong></span>
<span class="strong"><strong># /etc/init.d/nagios restart</strong></span>
</pre></div></li></ol></div><p>With this done, the <code class="literal">CLUSTER</code> service on the <code class="literal">naginet-blade-cluster</code> dummy host should be available for viewing. It will change state and send <a id="id519" class="indexterm"/>notifications the same way as any other service if the hosts in the cluster come up or go down:</p><div class="mediaobject"><img src="graphics/5566_08_12.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec297"/>How it works...</h2></div></div></div><p>The host added in this recipe is just a "hook" for the <code class="literal">CLUSTER</code> service, which performs the actual check. This is why we used a command using the <code class="literal">check_dummy</code> plugin to always return an <code class="literal">OK</code> state:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/libexec/check_dummy 0 "Dummy host only"</strong></span>
<span class="strong"><strong>OK: Dummy host only</strong></span>
</pre></div><p>The <code class="literal">check_cluster</code> command<a id="id520" class="indexterm"/> is actually quite simple. It performs no actual checks of its own. Instead, it determines states based on the current state of other hosts or services.</p><p>This is why the <code class="literal">$HOSTSTATEID:hostname$</code> macros<a id="id521" class="indexterm"/> are used in the <code class="literal">check_command</code> directive for the service; they evaluate to a number indicating the <a id="id522" class="indexterm"/>state of the host, with the hostname specified after the colon.</p><p>For example, if <code class="literal">achilles.naginet</code> and <code class="literal">odysseus.naginet</code> were <code class="literal">UP</code>, but <code class="literal">agamemnon.naginet</code> was <code class="literal">DOWN</code>, then the command run by Nagios Core for the check would look similar to the following code snippet after the macros were expanded:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>/usr/local/nagios/libexec/check_cluster -h -d 0,0,1 -w @1: -c @2:</strong></span>
</pre></div><p>We can run this ourselves as the <code class="literal">nagios</code> user to check the output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># sudo -s -u nagios</strong></span>
<span class="strong"><strong>$ /usr/local/nagios/libexec/check_cluster -h -d 0,0,1 -w @1: -c @2:</strong></span>
<span class="strong"><strong>CLUSTER WARNING: Service cluster: 2 ok, 1 warning, 0 unknown, 0 critical</strong></span>
</pre></div><p>The comma-separated states given in the <code class="literal">-d</code> option to the plugin correspond to two hosts being <code class="literal">UP</code> (state ID of <code class="literal">0</code>), and one host being <code class="literal">DOWN</code> (state ID of <code class="literal">1</code>). The <code class="literal">-w</code> option's value of <code class="literal">@1:</code> means that a <code class="literal">WARNING</code> state will be entered if one or more of the hosts is down. Similarly, the <code class="literal">-c</code> option's value of <code class="literal">@2:</code> means that a <code class="literal">CRITICAL</code> state will be entered if two or more of the hosts go down.</p><p>This allows you to customize notifications to be sent based on the number of hosts in the <code class="literal">DOWN</code> state, rather than merely monitoring the hosts individually. Once you're confident this is working correctly, you may even choose to prevent the individual hosts from sending notifications to your pager, and have the <code class="literal">CLUSTER</code> service notify you instead.</p></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec298"/>There's more...</h2></div></div></div><p>If you have a cluster of services rather than hosts to monitor, this can be done by using the <code class="literal">-s</code> option to <code class="literal">check_cluster</code>, rather than the <code class="literal">-h</code> option. In this case, instead of the <code class="literal">$HOSTSTATEID:&lt;host_name&gt;$</code> macro, you would use the <code class="literal">$SERVICESTATEID:&lt;host_name&gt;:&lt;service_description&gt;$</code> macro. An example configuration might look similar to the following code snippet for a cluster of two web servers, <code class="literal">sparta.naginet</code> and <code class="literal">athens.naginet</code>, given a dummy host named <code class="literal">naginet-http-cluster</code>:</p><div class="informalexample"><pre class="programlisting">define command {
    command_name  check_service_cluster
<span class="strong"><strong>    command_line  $USER1$/check_cluster -s -d $ARG1$ -w $ARG2$ -c $ARG3$</strong></span>
} 
define service {
    use                  generic-service
	host_name            naginet-http-cluster
	service_description  CLUSTER_HTTP
<span class="strong"><strong>    check_command       check_service_cluster!$SERVICESTATEID:sparta.naginet:HTTP$,$SERVICESTATEID:athens.naginet:HTTP$!@1:!@2:</strong></span>
}</pre></div></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec299"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Establishing a host dependency</em></span> recipe in this chapter</li></ul></div></div></div>
<div class="section" title="Using the network map as an overlay"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec75"/>Using the network map as an overlay</h1></div></div></div><p>In this recipe, we'll learn how to use a background for the <a id="id523" class="indexterm"/>network map and deliberate placement of hosts in specific points on it, to make a kind of network status weather map to see host statuses at a glance in a geographical context.</p><div class="section" title="Getting ready"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec300"/>Getting ready</h2></div></div></div><p>You will need a Nagios Core 3.0 or newer server, and have shell access to change its backend configuration. You should also have at least a couple of hosts configured to place on the map, and understand the basics of using the Nagios network map and icons for hosts. These are discussed in the <span class="emphasis"><em>Using the network map</em></span> and <span class="emphasis"><em>Choosing icons for hosts</em></span> recipes, in this chapter.</p><p>You should also select a background image on which you can meaningfully place hosts. If you are monitoring an office network, this could be a floor plan of the building or server room. If you're monitoring a nationwide Internet service provider, then you could use a map of your state or country. Some administrators even like to use pictures of physical equipment, and place the Nagios Core hosts over their physical analogues. In this example, we'll use a map of Australia, 640 by 509 pixels in size, a public domain image retrieved from the <a id="id524" class="indexterm"/>Natural Earth website at <a class="ulink" href="http://www.naturalearthdata.com/">http://www.naturalearthdata.com/</a>:</p><div class="mediaobject"><img src="graphics/5566_08_13.jpg" alt="Getting ready"/></div><p>The background image can be anything you like, and several graphics formats including PNG can be used. However, for the sake of quick map rendering, <a id="id525" class="indexterm"/>it's recommended to use an image in the GD2 file format, with extension .<code class="literal">gd2</code>. If you have your image in a PNG format, you can generate a GD2 image from it using the free tool <code class="literal">pngtogd2</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ pngtogd2 australia.png australia.gd2 0 1</strong></span>
</pre></div><p>This tool is available on Debian-derived systems in the <code class="literal">libgd-tools</code> package. Its source code is also available online at <a class="ulink" href="http://www.libgd.org/">http://www.libgd.org/</a>.</p></div><div class="section" title="How to do it..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec301"/>How to do it...</h2></div></div></div><p>We can set up a background for our <a id="id526" class="indexterm"/>network map as follows:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Copy your GD2 format image into the <code class="literal">images</code> subdirectory of the <code class="literal">physical_html_path</code> directory. In the default installation, this is <code class="literal">/usr/local/nagios/share/images</code>; if it is different, you can find the definition of <code class="literal">physical_html_path</code> in <code class="literal">/usr/local/nagios/etc/cgi.cfg</code>.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cp /home/tom/australia.gd2 /usr/local/nagios/share/images</strong></span>
</pre></div></li><li class="listitem">Change to the configuration directory for Nagios Core. In the default installation, this is <code class="literal">/usr/local/nagios/etc</code>. Edit the file <code class="literal">cgi.cfg</code>.<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># cd /usr/local/nagios/etc</strong></span>
<span class="strong"><strong># vi cgi.cfg</strong></span>
</pre></div></li><li class="listitem">Look for the directive <code class="literal">statusmap_background_image</code> in this file. Uncomment it and make its value the name of your image:<div class="informalexample"><pre class="programlisting">statusmap_background_image=australia.gd2</pre></div></li><li class="listitem">Look for the directive <code class="literal">default_statusmap_layout</code> in the same file. Change it to <code class="literal">0</code>, which corresponds to the <span class="strong"><strong>User-defined coordinates</strong></span> layout.<div class="informalexample"><pre class="programlisting">default_statusmap_layout=0</pre></div></li><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. In the default installation, this is <code class="literal">/usr/local/nagios/etc/objects</code>. Add <code class="literal">2d_coords</code> directives to each of the hosts you want to display on the map. You might like to include definitions for <code class="literal">statusmap_image</code> here too, which is done as follows:<div class="informalexample"><pre class="programlisting"># vi australia.cfg
define host {
    use              linux-server
    host_name        adelaide.naginet
	address          10.128.0.140
    2d_coords        390,360
<span class="strong"><strong>    statusmap_image  rack-server.gd2</strong></span>
}
define host {
    use              linux-server
    host_name        cairns.naginet
    address          10.128.0.141
    2d_coords        495,100
<span class="strong"><strong>    statusmap_image  rack-server.gd2</strong></span>
}
... etc ...</pre></div></li><li class="listitem">For the directive <code class="literal">2d_coords</code>, supply two comma-separated values describing the coordinates for the placement of the host. For example, <code class="literal">adelaide.naginet</code> is 390 pixels from the left, and 360 pixels from the top. A convenient way to get the coordinates is by using GIMP, the open source imaging tool, or even a simple tool such as <a id="id527" class="indexterm"/>MS Paint; load the image and hover over the point you wish to use to find its pixel coordinates.</li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong></span>
<span class="strong"><strong># /etc/init.d/nagios restart</strong></span>
</pre></div></li></ol></div><p>With this done, on visiting the network map in the Nagios Core web interface by clicking on <span class="strong"><strong>Map</strong></span> on the left-hand side menu, your hosts will be placed in their corresponding positions on the map, including the normal lines and colors to specify child-parent relationships and reachability:</p><div class="mediaobject"><img src="graphics/5566_08_14.jpg" alt="How to do it..."/></div></div><div class="section" title="How it works..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec302"/>How it works...</h2></div></div></div><p>The <a id="id528" class="indexterm"/>
<code class="literal">default_statusmap_layout</code> directive fixes the network map into the <span class="strong"><strong>User-supplied coords</strong></span> mode by default. In this mode, only hosts with values for <code class="literal">2d_coords</code> are shown, and they are displayed at fixed points on the map, rather than being dynamically placed.</p><p>It's possible to use this display mode without a background if we wish, but we can give a lot of useful context to the picture of the network generated by taking the extra step of using an actual background image.</p><p>Note that if you don't have any hosts with coordinates defined, you'll receive an error that looks similar to the following screenshot:</p><div class="mediaobject"><img src="graphics/5566_08_15.jpg" alt="How it works..."/></div></div><div class="section" title="There's more..."><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec303"/>There's more...</h2></div></div></div><p>Using the network map with an image background can be particularly helpful for seeing not only the statuses of individual hosts at a glance, but in the case of outages from multiple hosts, looking for possible geographical causes. If all of the nodes in one part of the city or country went down at once, we would be able to see that at a glance. This makes the network map an excellent choice for a network monitoring display, or as one of the first ports of call in diagnosing large-scale problems.</p><p>The network map is very useful in this way, and graphically it is probably the most impressive part of the Nagios Core web interface. If you would like even more options and an impressive range of visualizations for host statuses, you may like to consider looking at the excellent <span class="strong"><strong>NagVis</strong></span> extension<a id="id529" class="indexterm"/>, which could fill a whole book in itself. There is a brief introduction to its usage in the <span class="emphasis"><em>Getting extra visualizations with NagVis</em></span> recipe, in <a class="link" href="ch11.html" title="Chapter 11. Automating and Extending Nagios Core">Chapter 11</a>, <span class="emphasis"><em>Automating and Extending Nagios</em></span>.</p></div><div class="section" title="See also"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec304"/>See also</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Creating a network host hierarchy</em></span>, <span class="emphasis"><em>Using the network map</em></span>, and <span class="emphasis"><em>Choosing icons for hosts</em></span> recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <span class="emphasis"><em>Getting extra visualizations with NagVis</em></span> recipe in <a class="link" href="ch11.html" title="Chapter 11. Automating and Extending Nagios Core">Chapter 11</a>, <span class="emphasis"><em>Automating and Extending Nagios</em></span></li></ul></div></div></div></body></html>