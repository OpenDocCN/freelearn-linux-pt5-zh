<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Running a PostgreSQL Database Server</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Installing the PostgreSQL database server</li><li class="listitem" style="list-style-type: disc">Locating the PostgreSQL server configuration files</li><li class="listitem" style="list-style-type: disc">Allowing access to PostgreSQL over the network</li><li class="listitem" style="list-style-type: disc">Accessing the PostgreSQL server over an SSH tunnel</li><li class="listitem" style="list-style-type: disc">Creating a new database</li><li class="listitem" style="list-style-type: disc">Creating users and granting permissions</li><li class="listitem" style="list-style-type: disc">Creating a backup of your database</li><li class="listitem" style="list-style-type: disc">Executing custom SQL commands</li><li class="listitem" style="list-style-type: disc">Restoring a database from backup</li><li class="listitem" style="list-style-type: disc">Editing the structure of your database</li><li class="listitem" style="list-style-type: disc">Editing records in a database</li><li class="listitem" style="list-style-type: disc">Installing phpPgAdmin</li></ul></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec108"/>Introduction</h1></div></div></div><p>PostgreSQL<a id="id718" class="indexterm"/> is a powerful open source relational <strong>database management system</strong> (<strong>DBMS</strong>). It features a powerful type system and advanced <a id="id719" class="indexterm"/>programming functions. This allows it to store and perform calculations on complex values, such as geographic coordinates, JSON objects, and arrays.</p><p>PostgreSQL uses a distributed client-server architecture, which means that the database server and client applications can run on separate machines. If the client and server are running on the same system, they can communicate using <a id="id720" class="indexterm"/>Unix sockets; otherwise, they communicate over the network by using TCP sockets. The Postgres server uses port number 5432 by default, but this setting can be changed if needed.</p><div><div><h3 class="title"><a id="note64"/>Note</h3><p>Unix domain sockets are channels used for inter-process communication. Different programs running on the same machine can read and write information to a socket, enabling communication between the programs. Unix sockets are represented as nodes of the filesystem, so you can find a socket by listing the contents of a directory in which it was created.</p></div></div><p>The PostgreSQL<a id="id721" class="indexterm"/> DBMS is very popular and most operating system distributions provide packages for its easy installation. Each Postgres server hosts a database <strong>cluster</strong>
<a id="id722" class="indexterm"/> that consists of a collection of databases, associated configuration files, and running processes. On some systems, the cluster must be initiated after package installation. Initiation creates the directory structure of the cluster and fills it with standard databases. The standard database, <code class="literal">template1</code>, plays a special role, because all new databases are created as its copies by default.</p><p>Installation of the Postgres system involves the creation of a special user, usually named <code class="literal">postgres</code>. This user has complete administrative control over your databases, and Webmin will run most database commands and scripts as this user.</p><p>Webmin allows you to perform many tasks related to the running of the Postgres database server. In this chapter, we will demonstrate how Webmin can help you install PostgreSQL, set up access to the server over a network, manage user accounts, create databases, and edit their structure and data. We'll also demonstrate how to automatically back up databases and restore backup files. If you find that you need an even more advanced web-based management tool, we will demonstrate how to set up phpPgAdmin on your server.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec109"/>Installing the PostgreSQL database server</h1></div></div></div><p>Most operating systems that come with a package management solution for open source software make PostgreSQL packages available for installation. In this recipe, we will install PostgreSQL from a package and set it up on your system. Installing the server package automatically installs the PostgreSQL command-line client package, as well.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec356"/>How to do it...</h2></div></div></div><p>Perform the following steps to install the PostgreSQL database server:</p><div><ol class="orderedlist arabic"><li class="listitem">Follow the steps described in the <em>Installing software packages</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System</em>, to find and install the PostgreSQL database server package.<div><div><h3 class="title"><a id="note65"/>Note</h3><p>In most package repositories, the PostgreSQL server package is simply named <code class="literal">postgresql-server</code>. If your distribution allows you to select among different versions of PostgreSQL, the package names will contain version numbers such as <code class="literal">postgresql-9.1</code> or <code class="literal">postgresql93-server</code>. Pick the package with the latest version unless you have reasons to stick with an older one.</p></div></div></li><li class="listitem">Click the<a id="id723" class="indexterm"/> <strong>Refresh Modules</strong> link at the <a id="id724" class="indexterm"/>bottom of Webmin's main menu and reload the browser to update the menu.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>. You should see a screen that lists installed databases. It should include the default databases such as <code class="literal">postgresql</code> and <code class="literal">template1</code>.</li><li class="listitem">If you do not see the list of databases, but instead a message which indicates that the database system has not yet been initialized, click the <strong>Initialize Database</strong> button.<div><div><h3 class="title"><a id="tip95"/>Tip</h3><p>At the bottom of the screen, if you see the message, <strong>Warning: The Perl modules DBI and DBD::Pg are not installed on your system</strong>, click the link and follow Webmin's instructions to install the missing Perl modules.</p></div></div></li><li class="listitem">Navigate to <strong>System</strong> | <strong>Bootup and Shutdown</strong> and verify that the init script, <code class="literal">postgresql</code>, is set to start at boot. If it isn't, select its checkbox and click the <strong>Start Now and On Boot</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec357"/>How it works...</h2></div></div></div><p>Webmin helps you find and install the <code class="literal">postgresql-server</code> package<a id="id725" class="indexterm"/> from your distribution's repositories. The package installs the database server, client, and an init script that starts the server during system boot.</p><p>Before Postgres can be used to manage databases, a new cluster must be created. A PostgreSQL cluster is a collection of databases managed by a single server. Creating the cluster involves the creation of a directory in which the database files will be stored, and filling it with a few standard databases. The standard database named <code class="literal">template1</code> plays a special role, because all new databases in the cluster will be made by copying this template.</p><p>If your package installation script does not initialize a database cluster for you, you can ask Webmin to do it by clicking the <strong>Initialize Database</strong> button. This runs the following subcommand of the init script:</p><div><pre class="programlisting">
<strong> /etc/rc.d/init.d/postgresql initdb</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec358"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If you want to allow other computers to access your databases, take a look at the recipe, <em>Allowing access to PostgreSQL over the network</em>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec110"/>Locating the PostgreSQL server configuration files</h1></div></div></div><p>The main configuration file of the PostgreSQL server is usually named <code class="literal">postgresql.conf</code>, and<a id="id726" class="indexterm"/> is stored in the database cluster data directory by default. Various system distributions move this configuration outside of the data directory and place it in a different location, for example, in the <code class="literal">/etc/</code> directory. In this recipe, we will demonstrate how to find the <code class="literal">postgresql.conf</code> and change it to modify the server's configuration. Webmin does not assist you in the modification of the basic settings of PostgreSQL, so you will need to edit the configuration file manually.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec359"/>Getting ready</h2></div></div></div><p>Make sure that<a id="id727" class="indexterm"/> the PostgreSQL server is installed and running, <a id="id728" class="indexterm"/>and that you are able to connect to it via Webmin before starting. The recipe, <em>Installing the PostgreSQL database server</em>, provides more information.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec360"/>How to do it...</h2></div></div></div><p>Follow these steps to locate PostgreSQL's main configuration file on your system:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon of the default database, <code class="literal">postgres</code>.</li><li class="listitem">Click the <strong>Execute SQL</strong> button.</li><li class="listitem">Enter the following SQL command in the provided text area:<div><pre class="programlisting">SHOW config_file;</pre></div></li><li class="listitem">Click the <strong>Execute</strong> button and you will see the output of the SQL command, which provides the full path to the main server configuration file, as shown in the following screenshot:<div><img src="img/5849OS_10_01.jpg" alt="How to do it..."/></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec361"/>How it works...</h2></div></div></div><p>When an init<a id="id729" class="indexterm"/> script starts the PostgreSQL server, it<a id="id730" class="indexterm"/> may specify the location of the database cluster's data directory or the location of the server's main configuration file (customarily called <code class="literal">postgresql.conf</code>). By default, the main configuration file is stored inside of the data directory, but package maintainers often move it to a different location (such as <code class="literal">/etc/</code>) to keep system configuration files in order. The SQL command, <code class="literal">SHOW config_file;</code>, can be used to check where the main configuration file is located.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec362"/>There's more...</h2></div></div></div><p>The location of other configuration files and the values of other settings can also be displayed using the<a id="id731" class="indexterm"/> SQL <code class="literal">SHOW</code> command.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec128"/>Determining location of other configuration files and data files</h3></div></div></div><p>Use the following <a id="id732" class="indexterm"/>commands to check <a id="id733" class="indexterm"/>where other configuration files are located:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Setting</p>
</th><th style="text-align: left" valign="bottom">
<p>Command</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Main configuration file (<code class="literal">postgresql.conf</code>)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">SHOW config_file;</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Data directory</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">SHOW data_directory;</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Host-based access configuration file (<code class="literal">pg_hba.conf</code>)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">SHOW hba_file;</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Identity mapping file (<code class="literal">pg_ident.conf</code>)</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">SHOW ident_file;</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Directory where the Unix-domain socket will be created</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">SHOW unix_socket_directory;</code>
</p>
</td></tr></tbody></table></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec129"/>Checking values of other settings</h3></div></div></div><p>You can also reveal the values of all settings by issuing the following command:</p><div><pre class="programlisting">SHOW all;</pre></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec111"/>Allowing access to PostgreSQL over the network</h1></div></div></div><p>Programs that access <a id="id734" class="indexterm"/>PostgreSQL databases, which are <a id="id735" class="indexterm"/>called clients, may be running on the same machine as the server. In this case, the client and server will communicate most efficiently using a Unix-domain socket, a channel of inter-process communication accessed through the filesystem such as a file or directory. Access to a socket is controlled by filesystem permissions.</p><p>Other client programs may be able to communicate only over TCP network sockets. These clients may connect to the local server using the loopback interface and IP address of <code class="literal">127.0.0.1</code>.</p><p>However, if a client program is located on a machine other than the server, then communication between them must take place over the network using the TCP protocol. There are a number of ways to set up network connections for PostgreSQL. The most efficient but least secure method is to use a direct unencrypted connection between the client and server. This method has the drawback that unencrypted information could potentially be eavesdropped upon or even modified in transit over the network. Because database systems are usually designed to be as efficient as possible, this type of communication is used often, but should only be deployed inside of a secure network. We will describe how to enable this type of communication in this recipe.</p><div><div><h3 class="title"><a id="tip96"/>Tip</h3><p>In order to make network access to your PostgreSQL server more secure, you can choose to encrypt the transferred information using SSL. This prevents eavesdropping and man-in-the-middle attacks, but leaves the PostgreSQL server's network port exposed and potentially vulnerable to brute-force password guessing and other attacks.</p><p>If you really need security, for instance, to access your database server over the Internet, you should probably choose a third option: send the PostgreSQL traffic over an encrypted SSH tunnel. This is the least efficient of the described transmission methods, but it generates the fewest security concerns. For more information, take a look at the recipe, <em>Accessing the PostgreSQL server over an SSH tunnel</em>.</p></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec363"/>Getting ready</h2></div></div></div><p>In this recipe, we will prepare your PostgreSQL server to accept incoming network connections. In order to test the connection, we will need access to two computers attached to the same network: the server and a client machine. Make note of the server and client's IP or domain name before starting.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec364"/>How to do it...</h2></div></div></div><p>The steps in this recipe will be divided into five sections:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">First, we'll instruct PostgreSQL to listen for incoming network connections on the standard port (<code class="literal">5432</code>).</li><li class="listitem" style="list-style-type: disc">Next, we'll create a database user named <code class="literal">dbuser</code>.</li><li class="listitem" style="list-style-type: disc">Then, we will create a database named <code class="literal">testtdb</code>.</li><li class="listitem" style="list-style-type: disc">We will allow remote access to the database.</li><li class="listitem" style="list-style-type: disc">And finally, we will test the setup by connecting to our server from a secondary client machine.</li></ul></div><p>Perform the <a id="id736" class="indexterm"/>following steps to instruct the <a id="id737" class="indexterm"/>PostgreSQL server<a id="id738" class="indexterm"/> to listen for network connections:</p><div><ol class="orderedlist arabic"><li class="listitem">Follow steps described in the recipe, <em>Allowing access to a service through the firewall</em>in <a class="link" href="ch03.html" title="Chapter 3. Securing Your System">Chapter 3</a>, <em>Securing Your System</em>, to allow incoming TCP traffic to port 5432 through your firewall.</li><li class="listitem">Find the location of the PostgreSQL main server configuration file (<code class="literal">postgresql.conf</code>). Refer to the recipe, <em>Locating the PostgreSQL server configuration files</em>, for detailed instructions.</li><li class="listitem">Within the <code class="literal">postgresql.conf</code> file, find the line with the <code class="literal">listen_addresses </code>directive. This line may be commented out (start with the <code class="literal">#</code> character). Change the line to the following:<div><pre class="programlisting">listen_addresses = '*'</pre></div><div><div><h3 class="title"><a id="tip97"/>Tip</h3><p>The most effective way to edit files on your server is to use an editor such as Vim or Nano in a terminal session (for example, over SSH). But to make a small change in a configuration file, you do not need to leave Webmin. Take a look at the <em>Editing a file on the server</em> section of the <em>Managing files and directories on the server</em> recipe from <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>.</p></div></div></li><li class="listitem">We must restart the server after making configuration changes. Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>, click the <strong>Stop PostgreSQL Server</strong> button, and then click the <strong>Start PostgreSQL Server</strong> button.</li></ol></div><p>Your PostgreSQL server will now listen for incoming network connections on port 5432.</p><p>Perform the following steps to create a new user:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate <a id="id739" class="indexterm"/>to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong> | <strong>PostgreSQL Users</strong>.</li><li class="listitem">Click<a id="id740" class="indexterm"/> the <strong>Create new user</strong> link.</li><li class="listitem">Set<a id="id741" class="indexterm"/> <strong>Username</strong> to <code class="literal">dbuser</code> and assign a strong password in the <strong>Password</strong> field.</li><li class="listitem">Answer <strong>No</strong> to the <strong>Can create databases?</strong> and <strong>Can create users?</strong> questions.</li><li class="listitem">Set <strong>Valid until</strong> to <strong>Forever</strong>:<div><img src="img/5849OS_10_01a.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>Perform the following steps<a id="id742" class="indexterm"/> to create a database:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the <strong>Create a new database </strong>link.</li><li class="listitem">Set <strong>Database name </strong>to <code class="literal">testdb</code>.</li><li class="listitem">Set <strong>Owned by user </strong>to <code class="literal">dbuser</code>.</li><li class="listitem">Set <strong>Template database</strong> to <code class="literal">template1</code>:<div><img src="img/5849OS_10_01b.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>Perform the following steps to grant a user remote access to the database:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the <strong>Allowed Hosts</strong> icon.</li><li class="listitem">Click the <strong>Create a new allowed host </strong>link.</li><li class="listitem">Set <a id="id743" class="indexterm"/><strong>Host address</strong> to <strong>Single host</strong> and <a id="id744" class="indexterm"/>enter the IP address of the client computer (for example, <code class="literal">10.10.10.100</code>).<div><div><h3 class="title"><a id="tip98"/>Tip</h3><p>If the client can connect from more then one IP, you can specify a subnet by providing a network and netmask or CIDR length. For instance, to grant access to all computers in the <code class="literal">10.10.10.*</code> subnet, you could specify the network as <code class="literal">10.10.10.0</code> and either the netmask as <code class="literal">255.255.255.0</code> or the CIDR length as <code class="literal">24</code>.</p></div></div></li><li class="listitem">Set <strong>SSL connection required?</strong> to <strong>Yes</strong>.<div><div><h3 class="title"><a id="tip99"/>Tip</h3><p>You can shave off a little performance overhead by not using SSL, but you should only do that on entirely trusted networks.</p></div></div></li><li class="listitem">Set <strong>Database</strong> to <code class="literal">testdb</code>.</li><li class="listitem">Set <strong>Users</strong> to <strong>Listed users</strong> and enter <code class="literal">dbuser</code>.</li><li class="listitem">Set <strong>Authentication mode</strong> to <strong>MD5 encrypted password</strong>:<div><img src="img/5849OS_10_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <a id="id745" class="indexterm"/><strong>Create</strong> button.</li><li class="listitem">We'll <a id="id746" class="indexterm"/>need to restart the server one <a id="id747" class="indexterm"/>more time to load the new access configuration. Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>, click the <strong>Stop PostgreSQL Server</strong> button, and then click the <strong>Start PostgreSQL Server</strong> button.<div><div><h3 class="title"><a id="tip100"/>Tip</h3><p>On a busy production system it would be a bad idea to restart the database server unnecessarily, although that is the sure way of reloading all settings. After changing access settings, you don't really need to restart the server. You could send it a <code class="literal">SIGHUP</code> signal instead. This signal instructs Postgres to reload its configuration. On systems equipped with the <code class="literal">pg_ctl</code> program, this can be achieved by issuing the following command:</p><div><pre class="programlisting">
<strong>$ sudo pg_ctl reload</strong>
</pre></div><p>On systems with the <code class="literal">pg_ctlcluster</code> command, you will need to specify the server version and cluster name, for example:</p><div><pre class="programlisting">
<strong>$ sudo pg_ctlcluster 9.1 main reload</strong>
</pre></div></div></div></li></ol></div><p>For testing the connection, try to connect to your database server from the client machine that uses the IP we specified. If your other machine has the PostgreSQL command-line client installed, you can test the connection by typing in this command at the terminal. However, substitute <code class="literal">postgresql-host</code> with the IP or domain name of your Postgres server as follows:</p><div><pre class="programlisting">
<strong>$ psql -h postgresql-host -U dbuser testdb</strong>
<strong>testdb=# \q</strong>
</pre></div><p>If the connection is successful, you should arrive at the PostgreSQL prompt (<code class="literal">testdb=#</code>). Type <code class="literal">\q</code> and press <em>Enter</em> to exit.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec365"/>How it works...</h2></div></div></div><p>In order to<a id="id748" class="indexterm"/> enable network access to the PostgreSQL <a id="id749" class="indexterm"/>database server, we needed to modify two configuration files. We edited the main configuration file (<code class="literal">postgresql.conf</code>) manually to instruct the server to listen for incoming network connections on all network interfaces. The second file, which was edited through Webmin's interface, is the host-based authentication configuration (<code class="literal">pg_hba.conf</code>). This file instructs the server which users should be allowed to connect from which network hosts and how they should be required to authenticate.</p><p>Webmin added the following line to <code class="literal">pg_hba.conf</code>:</p><div><pre class="programlisting">hostssl testdb dbuser 10.10.10.100 255.255.255.255 md5</pre></div><p>The preceding line instructs the server to accept SSL connections to the <code class="literal">testdb</code> database by the <code class="literal">dbuser</code> user if the connection originated from the IP address <code class="literal">10.10.10.100</code>. The user should be asked to provide an MD5-encrypted password for authentication.</p><p>Another line in <code class="literal">pg_hba.conf</code> can look like the following:</p><div><pre class="programlisting">local    all    postgres    peer</pre></div><p>This line instructs the server to accept connections made locally over the Unix socket. These connections use the <code class="literal">peer</code> authentication method, which checks the username of the system account running the connecting client program. If the system username matches a Postgres account name, then the connection is considered authenticated. Password checking is not performed in <code class="literal">peer</code> authentication. The preceding line of code will allow the system account <code class="literal">postgres</code> to access <code class="literal">all</code> databases.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec366"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In order to make remote access and management of your PostgreSQL databases more secure, you can tunnel your connection over SSH. Take a look at the recipe, <em>Accessing the PostgreSQL server over an SSH tunnel</em>, for instructions.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec112"/>Accessing the PostgreSQL server over an SSH tunnel</h1></div></div></div><p>If your server is <a id="id750" class="indexterm"/>hosting a website on the <a id="id751" class="indexterm"/>Internet and running a database system on the same machine, it is safer to disable remote network access to the database. On the other hand, you may still want to manage your databases remotely. You can do so by tunneling PostgreSQL traffic over an SSH connection.</p><div><div><h3 class="title"><a id="note66"/>Note</h3><p>One of the most important aspects of a database system is the speed with which it can find and return the data that you ask for. Tunneling traffic over SSH will add significant overhead to this communication. This solution is great for intermittent management tasks, but not suitable as a replacement for a direct connection to your database system.</p></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec367"/>Getting ready</h2></div></div></div><p>Before you can access the PostgreSQL server through an SSH tunnel, you will need to make sure that an allowed hosts entry exists in the <code class="literal">pg_hba.conf</code> file. This entry should allow users from the loopback IP <code class="literal">127.0.0.1</code> to authenticate using MD5-encrypted passwords. Take a look at the recipe, <em>Allowing access to PostgreSQL over the network</em>, for more information. This is what the appropriate line in <code class="literal">pg_hba.conf</code> would look like:</p><div><pre class="programlisting"># IPv4 local connections:
host    all    all    127.0.0.1/32    md5</pre></div><p>The server you want to connect to must run both the PostgreSQL server and an SSH server. The remote client machine must have an SSH client and PostgreSQL client software installed. Make a note of the IP address or domain name of the server (<code class="literal">postgresql-host</code>), the SSH username (<code class="literal">ssh-user</code>), the PostgreSQL user (<code class="literal">postgresql-user</code>), and the database name (<code class="literal">database-name</code>). Substitute them in the following recipe.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec368"/>How to do it...</h2></div></div></div><p>In order to create an SSH tunnel for PostgreSQL, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Issue the following command on your client machine:<div><pre class="programlisting">
<strong>$ ssh -N -L 15000:localhost:5432 ssh-user@postgresql-host</strong>
</pre></div><p>This creates a tunnel between port <code class="literal">15000</code> on your client machine and port <code class="literal">5432</code> of the server. You can now access the remote database by making a PostgreSQL connection to your client computer's local port <code class="literal">15000</code>.</p></li><li class="listitem">Issue the following command on the client system to test the connection:<div><pre class="programlisting">
<strong>$ psql -h 127.0.0.1 -p 15000 -U postgresql-user database-name</strong>
</pre></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec369"/>How it works...</h2></div></div></div><p>The <a id="id752" class="indexterm"/>SSH client acts as an intermediary in the<a id="id753" class="indexterm"/> communication between the PostgreSQL client running on your machine and the remote server. It opens port <code class="literal">15000</code> on the client machine and listens for incoming connections. All packets arriving at port <code class="literal">15000</code> are encrypted and forwarded over SSH to the server. On the server side, SSH receives the packets, decrypts them, and sends them to port <code class="literal">5432</code>. Answers are sent back in the opposite direction over the same channel.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec370"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are many tools that allow you to connect to and control your PostgreSQL databases. Webmin provides a wide range of tools to perform most common tasks, and these are described in recipes in this chapter.</li><li class="listitem" style="list-style-type: disc">An even more powerful web-based solution dedicated to PostgreSQL is phpPgAdmin. It is discussed in the recipe, <em>Installing phpPgAdmin</em>.</li><li class="listitem" style="list-style-type: disc">More information about SSH tunnels is provided in the recipe, <em>Connecting to Webmin securely over an SSH tunnel</em>,in <a class="link" href="ch03.html" title="Chapter 3. Securing Your System">Chapter 3</a>, <em>Securing Your System</em>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec113"/>Creating a new database</h1></div></div></div><p>Creating a new PostgreSQL database<a id="id754" class="indexterm"/> through Webmin's interface is very quick and simple.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec371"/>How to do it...</h2></div></div></div><p>Follow these steps to create a database:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the <strong>Create a new database</strong> link.</li><li class="listitem">Enter a <strong>Database name</strong>, for instance, <code class="literal">new_db</code>.</li><li class="listitem">Select the user who will have administrative rights to the database from the <strong>Owned by user</strong> dropdown.</li><li class="listitem">Leave <strong>Character set encoding</strong> and <strong>Database file path</strong> set to <strong>Default</strong>.</li><li class="listitem">Set <strong>Template database</strong> to <code class="literal">template1</code>.</li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec372"/>How it works...</h2></div></div></div><p>Webmin takes the <a id="id755" class="indexterm"/>information you provide and creates a new database by connecting to the PostgreSQL server and executing the following command:</p><div><pre class="programlisting">
<strong>CREATE DATABASE new_db WITH OWNER="dbuser" TEMPLATE = template1;</strong>
</pre></div><p>Postgres creates the new database by making a copy of a selected template. The database, <code class="literal">template1</code>, is installed by default to serve as a source of default settings for newly created databases. If you want new databases to have different settings, for instance, character set and collation, you can introduce these changes to your template database.</p><p>Another way to create a database is to execute the <code class="literal">createdb</code> command as the user, <code class="literal">postgres</code>, for instance:</p><div><pre class="programlisting">
<strong>postgres@postgresql-host:~$ createdb --owner dbuser new_db</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec373"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If you have an initial database structure or contents, you can upload them to the server using an SQL commands file. Take a look at the recipe, <em>Executing custom SQL commands</em>, for more information.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec114"/>Creating users and granting permissions</h1></div></div></div><p>Creating PostgreSQL users through Webmin is very simple. Users can be designated as owners of newly created databases and will have complete access and administrative rights to the databases they own. Users may also be granted limited privileges on specific database tables.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec374"/>How to do it...</h2></div></div></div><p>In this recipe, we will create a new user called <code class="literal">dbuser</code> and grant selected privileges on a table named <code class="literal">dbtable</code> in a database called <code class="literal">testdb</code>.</p><p>Perform the following steps to create a user:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong> | <strong>PostgreSQL Users</strong>.</li><li class="listitem">Click the <strong>Create new user </strong>link.</li><li class="listitem">Set <strong>Username</strong> <a id="id756" class="indexterm"/>to <code class="literal">dbuser</code> and set a strong password in the <strong>Password</strong> field.</li><li class="listitem">Answer <strong>No</strong> to the <strong>Can create databases?</strong> and <strong>Can create users?</strong> questions.</li><li class="listitem">Set <strong>Valid</strong><a id="id757" class="indexterm"/><strong> until</strong> to <strong>Forever</strong>.</li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>Perform the following <a id="id758" class="indexterm"/>steps to grant <a id="id759" class="indexterm"/>user privileges on a <a id="id760" class="indexterm"/>database table:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the <strong>Granted Privileges</strong> icon.</li><li class="listitem">Click the name of the database object for which you want to modify permissions (for instance, the table name, <code class="literal">dbtable</code>).</li><li class="listitem">Select the user, <code class="literal">dbuser</code>, from the <strong>User</strong> dropdown.</li><li class="listitem">Mark the checkboxes next to the privileges you would like to grant:<div><img src="img/5849OS_10_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Save</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec375"/>How it works...</h2></div></div></div><p>Webmin creates a new database user by connecting to the PostgreSQL server and executing the following command:</p><div><pre class="programlisting">
<strong>CREATE USER 'dbuser' WITH PASSWORD '***' NOCREATEDB NOCREATEUSER;</strong>
</pre></div><p>Another way to create a database user is to execute the <code class="literal">createuser</code> command as the user <code class="literal">postgres</code>, for instance:</p><div><pre class="programlisting">
<strong>postgres@postgresql-host:~$ createuser dbuser</strong>
<strong>Shall the new role be a superuser? (y/n) n</strong>
<strong>Shall the new role be allowed to create databases? (y/n) n</strong>
<strong>Shall the new role be allowed to create more new roles? (y/n) n</strong>
</pre></div><p>Privileges are assigned to users through the <code class="literal">GRANT</code> command, for instance:</p><div><pre class="programlisting">GRANT SELECT,UPDATE,INSERT,DELETE ON "public"."dbtable" to 'dbuser';</pre></div><p>The PostgreSQL manual provides the following definitions of privileges:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Privilege</p>
</th><th style="text-align: left" valign="bottom">
<p>Definition</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">SELECT</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id761" class="indexterm"/>allows <code class="literal">SELECT</code> from<a id="id762" class="indexterm"/> any column of the specified table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">UPDATE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id763" class="indexterm"/>allows <code class="literal">UPDATE</code> of <a id="id764" class="indexterm"/>any column of the specified table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">INSERT</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This <a id="id765" class="indexterm"/>allows <code class="literal">INSERT</code> of a <a id="id766" class="indexterm"/>new row into the specified table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">DELETE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id767" class="indexterm"/> allows <code class="literal">DELETE</code> of a <a id="id768" class="indexterm"/>row from the specified table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">RULE</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This<a id="id769" class="indexterm"/> allows the <a id="id770" class="indexterm"/>creation of a rule on the table.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">REFERENCES</code>
</p>
</td><td style="text-align: left" valign="top">
<p>To create<a id="id771" class="indexterm"/> a foreign<a id="id772" class="indexterm"/> key constraint, it is necessary to have this privilege on both the referencing and referenced tables.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">TRIGGER</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This allows<a id="id773" class="indexterm"/> the <a id="id774" class="indexterm"/>creation of a trigger on the specified table.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec376"/>There's more...</h2></div></div></div><p>PostgreSQL does not make it easy to grant privileges to an entire database. In order to grant the user named <code class="literal">dbuser</code> access to all the tables defined in the <code class="literal">public</code> schema, execute the following command:</p><div><pre class="programlisting">GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO 'dbuser';</pre></div><div><div><h3 class="title"><a id="note67"/>Note</h3><p>Postgres databases may be subdivided into<a id="id775" class="indexterm"/> <strong>schemas</strong>. Each schema contains its own set of tables independent of other schemas and may use different user privileges. By default, each database contains only one schema called <code class="literal">public</code>, and all tables are assigned to it.</p></div></div><p>Inserting new objects also requires access to sequence objects, which may be granted as follows:</p><div><pre class="programlisting">
<strong>GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO dbuser;</strong>
</pre></div><p>Unfortunately, when you add new tables to the database or add another schema, you will have to execute the commands again. Another option is to set default permissions for the objects by using the <code class="literal">ALTER DEFAULT PRIVILEGES</code> command:</p><div><pre class="programlisting">
<strong>ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO 'dbuser';</strong>
<strong>ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO 'dbuser';</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec377"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Refer to the recipe, <em>Executing custom SQL commands</em>, for information about executing commands.</li><li class="listitem" style="list-style-type: disc">You can find more information about granting privileges in the PostgreSQL manual:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.postgresql.org/docs/9.3/static/sql-grant.html">http://www.postgresql.org/docs/9.3/static/sql-grant.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.postgresql.org/docs/9.3/static/sql-alterdefaultprivileges.html">http://www.postgresql.org/docs/9.3/static/sql-alterdefaultprivileges.html</a></li></ul></div></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec115"/>Creating a backup of your database</h1></div></div></div><p>Webmin can help <a id="id776" class="indexterm"/>you make backups of your PostgreSQL databases. With<a id="id777" class="indexterm"/> just a few clicks, you can make a backup of any database. Webmin can also help you set cron jobs to create backups automatically on a regular schedule.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec378"/>Getting ready</h2></div></div></div><p>Before starting, create a directory to store local backup files. You can keep these files in <code class="literal">/backups</code> in the root directory, <code class="literal">/root/backups</code>, or in any location you find convenient.</p><p>The backup directory should be owned by and be accessible only to the <code class="literal">postgres</code> user. Take a look at the recipe, <em>Changing file ownership and permissions,</em> in <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>, for more information.</p><p>To get general background information about backups, refer to <a class="link" href="ch07.html" title="Chapter 7. Backing Up Your System">Chapter 7</a>, <em>Backing Up Your System </em>.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec379"/>How to do it...</h2></div></div></div><p>Follow these steps to create a backup of a database:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the database you would like to back up.</li><li class="listitem">Click the <strong>Backup </strong>button.</li><li class="listitem">Set <strong>Backup file path</strong> to <code class="literal">/backups/database-name.sql</code>.</li><li class="listitem">Set <strong>Backup file format</strong> to <strong>Plain SQL Text</strong>.<div><div><h3 class="title"><a id="note68"/>Note</h3><p>The backup will be stored as a series of SQL statements in plain text. If you are exporting a large database, use the compressed <strong>Custom archive</strong> format.</p></div></div></li><li class="listitem">Set <strong>Tables to backup</strong> to <strong>All tables</strong>.</li><li class="listitem">Click the <strong>Backup Now</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec380"/>How it works...</h2></div></div></div><p>Webmin<a id="id778" class="indexterm"/> executes the <code class="literal">pg_dump</code> command<a id="id779" class="indexterm"/> to output a series of SQL<a id="id780" class="indexterm"/> commands that would be needed to recreate the entire database. The command is run as a user who has administrative access to the database. On most systems, the user is called <code class="literal">postgres</code>.</p><p>The database dump is saved to the specified output file. If you wanted to do the same kind of backup in the terminal, you could run a command similar to the following:</p><div><pre class="programlisting">
<strong>postgres@postgresql-host:~$ pg_dump -U postgres -f /backups/database-name.sql database-name</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec381"/>There's more...</h2></div></div></div><p>Webmin is quite a capable tool to create backups. Here are a few other easily accessible functions.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec130"/>Backing up all databases automatically</h3></div></div></div><p>Webmin can help you<a id="id781" class="indexterm"/> make an automated backup of some or all databases hosted by your server. These backups will be executed on a regular schedule by cron.</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the <strong>Backup Databases</strong> button.</li><li class="listitem">Set <strong>Backup to directory</strong> to the location of your backup directory, for instance, <code class="literal">/backups</code>.</li><li class="listitem">Set <strong>Backup file format</strong> to <strong>Custom archive</strong>.<div><div><h3 class="title"><a id="note69"/>Note</h3><p>The custom archive format is compressed to save the disk space. It's also very flexible and allows manual selection of archived items during the restore phase.</p></div></div></li><li class="listitem">Open the <strong>Backup schedule</strong> section.</li><li class="listitem">Set <strong>Scheduled backup enabled? </strong>to <strong>Yes, at times chosen below</strong>; set <strong>Simple schedule</strong> and select <strong>Daily (at midnight)</strong>.<div><div><h3 class="title"><a id="note70"/>Note</h3><p>Note that many things may be scheduled to start at midnight on your system, so you can choose another time if your system resources are limited. Choose a more complex schedule by marking the minutes, hours, and days of the month at which the job is to be performed.</p></div></div></li><li class="listitem">Click the <strong>Save</strong> button.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch10lvl3sec131"/>Exporting a database table to CSV</h3></div></div></div><p>Webmin can<a id="id782" class="indexterm"/> export a<a id="id783" class="indexterm"/> single table of your database into a CSV file that can be opened by spreadsheet programs such as Excel, Calc, or Gnumeric:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon of the database, and then click the icon of the table you would like to export.</li><li class="listitem">Click the <strong>Export as CSV</strong> button.</li><li class="listitem">Set <strong>File format</strong> to <strong>CSV with quotes</strong>.</li><li class="listitem">Set <strong>Include column names in CSV?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Export destination</strong> to <strong>Display in browser</strong>.</li><li class="listitem">Click the <strong>Export Now</strong> button.</li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec382"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can easily perform backups to a remote host using a network file sharing protocol such as NFS or CIFS. You start by creating a network volume on the remote server and then mount the volume on your server. You can then back up to directories on the remote system just as easily as if they were stored locally. Take a look at <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>, for instructions to set up network file sharing using NFS or CIFS.</li><li class="listitem" style="list-style-type: disc">Another way to store spare copies of your databases remotely is to send your backup directory to a remote server using the SSH protocol. Take a look at recipe, <em>Backing up to a remote host</em>, in <a class="link" href="ch07.html" title="Chapter 7. Backing Up Your System">Chapter 7</a>, <em>Backing Up Your System</em>, for more information.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec116"/>Executing custom SQL commands</h1></div></div></div><p>Webmin provides a<a id="id784" class="indexterm"/> simple interface to your Postgres database server, which allows you to execute arbitrary SQL commands. This can be a useful feature when you want to quickly find something in a database or perform a bulk update of multiple rows of data.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec383"/>How to do it...</h2></div></div></div><p>Perform the following steps to execute custom SQL commands:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the database you would like to use.</li><li class="listitem">Click the <strong>Execute SQL</strong> button.</li><li class="listitem">Enter SQL commands in the text area, for instance:<div><pre class="programlisting">CREATE TEMPORARY TABLE IF NOT EXISTS films (
    title varchar(40)
);
INSERT INTO films(title) VALUES ('Bananas'), ('Yojimbo');
SELECT * FROM films;</pre></div><div><img src="img/5849OS_10_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Execute</strong> button.</li></ol></div><p>You will be presented with a sortable display of data returned by the <code class="literal">SELECT</code> command. The presented data will come from a temporary <code class="literal">films</code> table created by the first command. Temporary tables are not stored when the client who created them disconnects, so you will not see this table in your database later.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec384"/>How it works...</h2></div></div></div><p>Webmin simply passes the SQL commands to the database server. If the command returns an error, it will be displayed on screen. If the command returns rows of data, Webmin will convert them into an HTML page and display them on screen. Please note that Webmin is running as the administrative user (<code class="literal">postgres</code>), so caution should be used when <a id="id785" class="indexterm"/>executing commands.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec385"/>There's more...</h2></div></div></div><p>Webmin also allows you to execute the SQL scripts saved in files. These can be used to restore databases from plain SQL text backups.</p><div><div><div><div><h3 class="title"><a id="ch10lvl3sec132"/>Executing a SQL script from a file</h3></div></div></div><p>Perform the<a id="id786" class="indexterm"/> following <a id="id787" class="indexterm"/>steps to execute a SQL script from a file:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the database you would like to use.</li><li class="listitem">Click the <strong>Execute SQL</strong> button.</li><li class="listitem">Select the <strong>Run SQL from file</strong> tab.</li><li class="listitem">If you uploaded the file onto the server, select <strong>From local file</strong> and enter the file's location in the text box. Otherwise, select <strong>From uploaded file</strong> and choose a file from your disk.</li><li class="listitem">Click the <strong>Execute</strong> button.</li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec386"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">You can save the commands that you execute often in an easy-to-use control panel in Webmin. Take a look at the recipe, <em>Creating a panel with the database commands that you execute often</em>, in <a class="link" href="ch04.html" title="Chapter 4. Controlling Your System">Chapter 4</a>, <em>Controlling Your System</em>, for more information.</li><li class="listitem" style="list-style-type: disc">If you find that you need a more full-fledged, web-based PostgreSQL management tool, consider installing phpPgAdmin. This is described in the <em>Install phpPgAdmin</em> recipe.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec117"/>Restoring a database from backup</h1></div></div></div><p>Backups of Postgres databases are created using the <code class="literal">pg_dump</code> command<a id="id788" class="indexterm"/> that can output a variety of formats. By default, backups are created as plain text SQL scripts, but a compressed custom PostgreSQL format is more efficient. Webmin helps you to create backups in both of these formats as well as in the <code class="literal">TAR</code> format.</p><p>The method of <a id="id789" class="indexterm"/>restoring <a id="id790" class="indexterm"/>your database will depend on the file format chosen during backup. If you chose the plain SQL text format, then simply running your backup script will restore the database. Take a look at the recipe, <em>Execute custom SQL commands,</em> for more information.</p><p>If you chose the custom archive or <code class="literal">TAR</code> file format, you should use the procedure described in this recipe.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec387"/>How to do it...</h2></div></div></div><p>Follow these steps to restore a database from backup:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the database you would like to restore.</li><li class="listitem">Click the <strong>Restore </strong>button.</li><li class="listitem">Choose <strong>Restore from Uploaded file</strong>, click <strong>Browse</strong>, and choose the file from your computer.<div><div><h3 class="title"><a id="tip102"/>Tip</h3><p>If the backup file is larger then a few MB, it will be safer to upload the file to the server first, before running the restore. Take a look at the recipe, <em>Uploading files to the server</em>, in <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>, for more information.</p></div></div></li><li class="listitem">Set <strong>Only restore data, not tables?</strong> to <strong>No</strong>.</li><li class="listitem">Set <strong>Delete tables before restoring?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Tables to restore</strong> to <strong>All in backup file</strong>.</li><li class="listitem">Click the <strong>Restore</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec388"/>How it works...</h2></div></div></div><p>Webmin uploads your file onto your server and then executes the <code class="literal">pg_restore</code> command to load contents of the backup into a database. If you wanted to restore a backup in the terminal, you could run a command similar to the following:</p><div><pre class="programlisting">
<strong>postgres@postgresql-host:~$ pg_restore -c -d database-name backup-file.post</strong>
</pre></div><p>Command-line options are as specified:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-c</code>: This option drops database objects before recreating them</li><li class="listitem" style="list-style-type: disc"><code class="literal">-d</code>: This option specifies the database you want to restore</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec389"/>There's more...</h2></div></div></div><p>Webmin can import data into a table of your database from a CSV file that can be created by spreadsheet programs such as Excel, Calc, or Gnumeric.</p><p>Follow these steps to<a id="id791" class="indexterm"/> restore a<a id="id792" class="indexterm"/> database table from a properly formatted CSV file:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the database to which you would like to import data.</li><li class="listitem">Click the <strong>Execute SQL</strong> button.</li><li class="listitem">Select the <strong>Import text file</strong> tab.</li><li class="listitem">If you uploaded the file onto the server, select <strong>From local file</strong> and enter the file's location in the text box. Otherwise, select <strong>From uploaded file</strong> and choose a file from your disk.</li><li class="listitem">Select a table from the <strong>Table to import data into</strong> dropdown.</li><li class="listitem">Set <strong>Delete data in table first</strong> to <strong>No</strong>.</li><li class="listitem">Set <strong>Ignore duplicate rows</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>File format</strong> to <strong>CVS with quotes</strong>.<div><div><h3 class="title"><a id="tip103"/>Tip</h3><p>You will have to select the same format when exporting data from your spreadsheet program. Experiment with the other formats if you run into problems.</p></div></div></li><li class="listitem">Click the <strong>Execute</strong> button.</li></ol></div><p>You will be presented with an information screen that describes how many rows were successfully imported or what errors were encountered.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec118"/>Editing the structure of your database</h1></div></div></div><p>Webmin allows you to<a id="id793" class="indexterm"/> quickly <a id="id794" class="indexterm"/>modify the structure of tables in your PostgreSQL database through an easy-to-use interface. In this recipe, we will demonstrate how to perform the following list of tasks:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Create a table in a database</li><li class="listitem" style="list-style-type: disc">Add a field to a database table</li><li class="listitem" style="list-style-type: disc">Create an index</li><li class="listitem" style="list-style-type: disc">Delete an index</li><li class="listitem" style="list-style-type: disc">Delete a field</li><li class="listitem" style="list-style-type: disc">Delete a table from the database</li></ul></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec390"/>Getting ready</h2></div></div></div><p>For demonstration purposes, we will be using a database called <code class="literal">testdb</code>. You can create a database with this name through Webmin by following steps described in the recipe, <em>Creating a new database</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec391"/>How to do it...</h2></div></div></div><p>In the <code class="literal">testdb</code> database, we'll create a table called <code class="literal">people</code> and add a field called <code class="literal">name</code> to the table. We'll then change the name of the field, add a unique index, and finally delete the index, field, and table from the database.</p><p>Perform the following <a id="id795" class="indexterm"/>steps to <a id="id796" class="indexterm"/>create a table in a database:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the <strong>Create Table</strong> button.</li><li class="listitem">Specify <code class="literal">people</code> as the <strong>Table name</strong>.</li><li class="listitem">Provide the definition of the field that will be the primary key for this table. Fill in the following field definition:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Type <code class="literal">id</code> in <strong>Field name</strong>.</li><li class="listitem" style="list-style-type: disc">Type <code class="literal">serial</code> in <strong>Data type</strong>.</li><li class="listitem" style="list-style-type: disc">Check the boxes <strong>Primary key</strong> and <strong>Unique</strong>.</li><li class="listitem" style="list-style-type: disc">Uncheck the boxes <strong>Array </strong>and <strong>Allow nulls</strong>:</li></ul></div><div><img src="img/5849OS_10_05.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>Perform the<a id="id797" class="indexterm"/> following <a id="id798" class="indexterm"/>steps to add a field to a database table:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon representing the <code class="literal">people</code> table.</li><li class="listitem">Select <strong>varchar</strong> from the types dropdown and click the <strong>Add field of type</strong> button.</li><li class="listitem">Fill in the following field definition:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Field name</strong>: <code class="literal">name</code></li><li class="listitem" style="list-style-type: disc"><strong>Type width</strong>: <code class="literal">80</code></li><li class="listitem" style="list-style-type: disc"><strong>Array field</strong>: <code class="literal">No</code></li></ul></div></li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>Perform the following <a id="id799" class="indexterm"/>steps to create an index:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">people</code> table.</li><li class="listitem">Click the <strong>Create Index</strong> button.</li><li class="listitem">Set <strong>Index name</strong> to <code class="literal">unique_name</code>.</li><li class="listitem">Select the field <code class="literal">name</code>, in the <strong>Fields in index</strong> list.</li><li class="listitem">Set <strong>Index type</strong> to <strong>Unique</strong>.</li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>Perform the following steps to<a id="id800" class="indexterm"/> delete an index:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">unique_name</code> index.</li><li class="listitem">Click the <a id="id801" class="indexterm"/><strong>Delete</strong> button.</li></ol></div><p>Perform the following <a id="id802" class="indexterm"/>steps to delete a field:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">people</code> table.</li><li class="listitem">Mark the checkbox next to the <code class="literal">name</code> field.</li><li class="listitem">Click the <strong>Delete Selected Fields</strong> button.</li></ol></div><p>Perform the following<a id="id803" class="indexterm"/> steps to delete a table from the database:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">people</code> table.</li><li class="listitem">Click the <strong>Drop Table</strong> button and confirm on the screen that follows.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec392"/>How it works...</h2></div></div></div><p>Webmin prepares syntax for the appropriate <code class="literal">CREATE</code>, <code class="literal">DROP</code>, and <code class="literal">ALTER TABLE</code> SQL commands to perform all of the preceding actions and executes those commands on your PostgreSQL server as the <code class="literal">postgres</code> user.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec393"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If you find that you need a more full-fledged, web-based PostgreSQL management tool, consider installing phpPgAdmin. This is described in the <em>Installing phpPgAdmin</em> recipe</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec119"/>Editing records in a database</h1></div></div></div><p>Webmin allows <a id="id804" class="indexterm"/>you<a id="id805" class="indexterm"/> to quickly edit data in your PostgreSQL database through a simple interface. In this recipe, we will demonstrate how to add, edit, and delete records in a database table.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec394"/>Getting ready</h2></div></div></div><p>In this recipe, we will use examples based on the <code class="literal">testdb</code> database and <code class="literal">people</code> table created in the recipe, <em>Editing the structure of your database</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec395"/>How to do it...</h2></div></div></div><p>We'll add a record to the <code class="literal">people</code> table of the <code class="literal">testdb</code> database; we'll edit the same record, and finally delete it to show how to perform these actions in Webmin.</p><p>Perform the<a id="id806" class="indexterm"/> following<a id="id807" class="indexterm"/> steps to <a id="id808" class="indexterm"/>add a row to a database table:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate<a id="id809" class="indexterm"/> to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">people</code> table.</li><li class="listitem">Click the <strong>View Data</strong> button.</li><li class="listitem">Click the <strong>Add row</strong> button.</li><li class="listitem">Fill in a numeric <code class="literal">id</code> and type in a <code class="literal">name</code> in the text box.</li><li class="listitem">Click the <strong>Save</strong> button.</li></ol></div><p>Perform the<a id="id810" class="indexterm"/> following <a id="id811" class="indexterm"/>steps to edit a row:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">people</code> table.</li><li class="listitem">Click the <strong>View Data</strong> button.</li><li class="listitem">Mark the checkbox next to the record you would like to edit.</li><li class="listitem">Click the <strong>Edit selected rows</strong> button.</li><li class="listitem">Change the <code class="literal">name</code> value in the text box.</li><li class="listitem">Click the <strong>Save</strong> button.</li></ol></div><p>Perform the <a id="id812" class="indexterm"/>following <a id="id813" class="indexterm"/>steps to delete a row:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>PostgreSQL Database Server</strong>.</li><li class="listitem">Click the icon that represents the <code class="literal">testdb</code> database.</li><li class="listitem">Click the icon that represents the <code class="literal">people</code> table.</li><li class="listitem">Click the <strong>View Data</strong> button.</li><li class="listitem">Mark the checkbox next to the record you would like to edit.</li><li class="listitem">Click the <strong>Delete selected rows</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec396"/>How it works...</h2></div></div></div><p>Webmin prepares syntax for the appropriate <code class="literal">INSERT</code>, <code class="literal">UPDATE</code>, and <code class="literal">DELETE</code> SQL commands to perform the preceding actions and executes those commands on your PostgreSQL server as the <code class="literal">postgres</code> user.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec397"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">If you find that you need a more full-fledged, web-based PostgreSQL management tool, consider installing phpPgAdmin. This is described in the <em>Installing phpPgAdmin</em> recipe.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec120"/>Installing phpPgAdmin</h1></div></div></div><p>phpPgAdmin<a id="id814" class="indexterm"/> is a database administration tool for PostgreSQL. It is a web-based application, like Webmin itself, but dedicated to all tasks related to the administration of a PostgreSQL server. It's easy to use and can be a helpful tool for your database users and administrators.</p><div><div><h3 class="title"><a id="note71"/>Note</h3><p>System packages are configured to run phpPgAdmin on Apache. The Apache web server and PHP are installed as package dependencies. If you're not already using Apache and PHP, this exposes a potential attack vector on your database server. Consider the security implications of installing phpPgAdmin and keeping it up to date.</p></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec398"/>How to do it...</h2></div></div></div><p>Perform the following <a id="id815" class="indexterm"/>steps to<a id="id816" class="indexterm"/> install phpPgAdmin:</p><div><ol class="orderedlist arabic"><li class="listitem">Install the package named <code class="literal">phpPgAdmin</code> (or <code class="literal">phppgadmin</code> depending on your system). Refer to the recipe, <em>Installing software packages</em>,in <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System</em> for more information.<div><div><h3 class="title"><a id="tip104"/>Tip</h3><p>On some systems, you may need to add an additional repository to install the package. For instance, if you're running a Linux distribution from the RedHat family (RHEL, CentOS, Fedora, and so on), you should add the <strong>Extra Packages for Enterprise Linux</strong> (<strong>EPEL</strong>)<a id="id817" class="indexterm"/> repository. Information about setting up EPEL can be found in the recipe, <em>Giving users access to your server via FTP,</em> in <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>.</p></div></div></li><li class="listitem">Since phpPgAdmin runs on top of Apache, you should make sure that this server is installed on your system and accessible to a browser. Follow the steps in the recipe, <em>Installing Apache on your system</em>, from <a class="link" href="ch08.html" title="Chapter 8. Running an Apache Web Server">Chapter 8</a>, <em>Running an Apache Web Server</em>, to get Apache up and running.</li><li class="listitem">Navigate to the following URL, but substitute <code class="literal">webmin-host</code> for the IP or domain name of your server: <code class="literal">http://webmin-host/phppgadmin</code> or <code class="literal">http://webmin-host/phpPgAdmin</code> (depending on distribution).<div><div><h3 class="title"><a id="tip105"/>Tip</h3><p>On some systems, phpPgAdmin is configured to be accessible to connections originating from the local host only. If you wish to change this behavior, go to <strong>Servers</strong> | <strong>Apache Webserver</strong> | <strong>Default Server</strong>, select the <strong>Per-Directory Options</strong> for phpPgAdmin's directory, and change its <strong>Access Control</strong> settings. More information is provided in the recipe, <em>Setting options for directories, files, and locations</em>, in <a class="link" href="ch08.html" title="Chapter 8. Running an Apache Web Server">Chapter 8</a>, <em>Running an Apache Web Server</em>.</p><p>Information about additional steps that may be necessary to set up phpPgAdmin in your system distribution can be found in package documentation files. Refer to the recipe, <em>Reading documentation of installed software</em> in <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System</em>.</p></div></div></li><li class="listitem">You can now log in using the username and password of a PostgreSQL account.</li></ol></div><p>Depending on the how phpPgAdmin's configuration is defined, it will connect to your Postgres server over a Unix socket or TCP network socket. The following line in <code class="literal">config.inc.php</code> decides how connections are established:</p><div><pre class="programlisting">$conf['servers'][0]['host'] = 'localhost';</pre></div><p>If the host value for a server is set to <code class="literal">'localhost'</code>, connections are made over a network socket. If the value is set as an empty string <code class="literal">''</code>, then connections are made over a Unix socket.</p><p>Your <a id="id818" class="indexterm"/>Postgres<a id="id819" class="indexterm"/> server must be set up to handle the chosen type of connection and allow users to authenticate using a password. Take a look at the recipe, <em>Allowing access to PostgreSQL over the network</em>, for more information.</p><div><div><h3 class="title"><a id="tip106"/>Tip</h3><p>If you are running a RedHat-based system with <a id="id820" class="indexterm"/>
<strong>Security Enhanced Linux</strong> (<strong>SELinux</strong>), you may have to allow Apache to connect to databases by setting the following flag:</p><div><pre class="programlisting">
<strong>$ sudo setsebool -P httpd_can_network_connect_db 1</strong>
</pre></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec399"/>How it works...</h2></div></div></div><p>phpPgAdmin is an application written in PHP. The main configuration file of phpPgAdmin is named <code class="literal">config.inc.php</code>, and is usually installed inside the <code class="literal">/etc/</code> directory. Example locations for different distributions are listed in the following table. The code of the application itself is stored in the form of PHP script files in a directory named <code class="literal">phpPgAdmin</code>.</p><p>Because phpPgAdmin is served by Apache, the installation package includes an application-specific configuration file that will be loaded by the web server. This file informs Apache where phpPgAdmin is stored on disk and which of its directories should be made available on the Web:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>File</p>
</th><th style="text-align: left" valign="bottom">
<p>OS / distro</p>
</th><th style="text-align: left" valign="bottom">
<p>Location</p>
</th></tr></thead><tbody><tr><td rowspan="3" style="text-align: left" valign="top">
<p>phpPgAdmin configuration</p>
</td><td style="text-align: left" valign="top">
<p>Debian</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/phppgadmin/config.inc.php </code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>CentOS</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/phpPgAdmin/config.inc.php</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>OpenSUSE</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/phpPgAdmin/config.inc.php</code>
</p>
</td></tr><tr><td rowspan="3" style="text-align: left" valign="top">
<p>phpPgAdmin files</p>
</td><td style="text-align: left" valign="top">
<p>Debian</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/share/phppgadmin</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>CentOS</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/usr/share/phpPgAdmin</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>OpenSUSE</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/srv/www/htdocs/phpPgAdmin</code>
</p>
</td></tr><tr><td rowspan="3" style="text-align: left" valign="top">
<p>Apache configuration file for phpPgAdmin</p>
</td><td style="text-align: left" valign="top">
<p>Debian</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/apache2/conf.d/phppgadmin</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>CentOS</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/httpd/conf.d/phpPgAdmin.conf</code>
</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>OpenSUSE</p>
</td><td style="text-align: left" valign="top">
<p>
<code class="literal">/etc/apache2/conf.d/phpPgAdmin.conf</code>
</p>
</td></tr></tbody></table></div><p>Regardless<a id="id821" class="indexterm"/> of how<a id="id822" class="indexterm"/> the package maintainers decided to prepare it, you can tweak the Apache configuration for phpPgAdmin by going to <strong>Servers</strong> | <strong>Apache Webserver</strong> | <strong>Default Server</strong> and selecting the <strong>Per-Directory Options</strong> for the phpPgAdmin directory.</p></div></div></body></html>