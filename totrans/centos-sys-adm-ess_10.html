<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch10"/>Chapter 10. Security Central</h1></div></div></div><p>Linux security is not a chapter in a book, it is a way of life. For every task that you carry out in CentOS, you should consider the security impact and how your actions can be made more secure. Of course, security takes many forms, and much of it is quite simple (for example, the physical security of servers locked in server rooms and so on. In this section, we <a class="indexterm" id="id464"/>will <a class="indexterm" id="id465"/>visit the world of <strong>pluggable authentication modules</strong> (<strong>PAM</strong>) and <strong>SELinux</strong>. Do not be scared of either, especially, SELinux; they are your friends. In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Understanding PAM configuration files</strong>: At the heart of PAM are the files located in <code class="literal">/etc/pam.d</code>; I will lead you through their syntax and meaning</li><li class="listitem" style="list-style-type: disc"><strong>Limits of PAM</strong>: Through PAM's limits module, we can restrict limits on system resources that can be obtained in a user session</li><li class="listitem" style="list-style-type: disc"><strong>SELinux</strong>: This is a quick guide to SELinux, both through the filesystem and the user's perspective</li><li class="listitem" style="list-style-type: disc"><strong>Hardening Linux</strong>: This is a checklist on what and how to secure your Linux server</li></ul></div><div><div><div><div><h1 class="title"><a id="ch10lvl1sec54"/>Understanding PAM configuration files</h1></div></div></div><p>Rather than<a class="indexterm" id="id466"/> building authentication into each and every application that needs it, most services in Linux will make use of modules such as PAM. These modules have the <code class="literal">.so</code> extension to identify them as standard modules, and are used by programs rather than the kernel directly. They make their home in <code class="literal">/lib/security</code> or <code class="literal">/lib64/security</code>, depending on whether your system is 32 bit or 64 bit. Each service or program that has PAM capabilities has its own configuration that dictates how authentication and session settings will be enforced; these files are located in <code class="literal">/etc/pam.d</code>. A quick look in this folder will reveal some recognizable names, such as <code class="literal">sshd</code>, <code class="literal">sudo</code>, <code class="literal">su</code>, and <code class="literal">login</code>, all representing services that have a level of authentication associated with them.</p><p>The <code class="literal">/etc/pam.d/login</code> file will be used by the console login program and <code class="literal">/etc/pamd/sshd</code> by the OpenSSH server. There will be multiple lines in each configuration file, and every line will have settings for type, control, module-path, and optional arguments to the module.</p><p>From the <a class="indexterm" id="id467"/>following figure, you can gain some understanding of the file syntax and see the four type settings: account, auth, session, and password.</p><div><img alt="Understanding PAM configuration files" src="img/5920OS_10_01.jpg"/></div><p>Take the following line as an example:</p><div><pre class="programlisting">account  required  pam_nologin.so</pre></div><p>This line has been taken from the <code class="literal">/etc/pam.d/login</code> file and has been set for the <code class="literal">account</code> type with the control set to <code class="literal">required</code> for the specified module: <code class="literal">pam_nologin.so</code>. This particular module checks for the existence of the <code class="literal">/etc/nologin</code> file; if it does exist, then even on successful authentication the user will not gain access to the system. He or she will be shown either the contents of the <code class="literal">/etc/nologin</code> file or a generic message explaining that login could not occur. This approach in itself becomes a simple way to temporarily disable logins to a server by just creating the <code class="literal">nologin</code> file; delete the file to re-enable logins.</p><p>Each <a class="indexterm" id="id468"/>of the elements of a PAM configuration file are listed next.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec63"/>Type</h2></div></div></div><p>Type defines <a class="indexterm" id="id469"/>when the module will be invoked. There are 4 valid entries:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Account</strong>: This is typically used to restrict or permit access to a service based on the<a class="indexterm" id="id470"/> time of day, maximum users, concurrent logins, and so on. Think of these as account restrictions.</li><li class="listitem" style="list-style-type: disc"><strong>Auth</strong>: This <a class="indexterm" id="id471"/>is used to establish who the user is, most often, by prompting for a password. This module can also be used to grant group membership.</li><li class="listitem" style="list-style-type: disc"><strong>Password</strong>: This type is used when updating a user's authentication token; again, most<a class="indexterm" id="id472"/> commonly, the password. Typically, one module will need to be loaded for each challenge and response authentication method.</li><li class="listitem" style="list-style-type: disc"><strong>Session</strong>: This<a class="indexterm" id="id473"/> is associated with events that need to be complete before a user is given access to the server, such as creating a home directory, if required.</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec64"/>Control</h2></div></div></div><p>The <a class="indexterm" id="id474"/>control field indicates the behavior of the PAM-API based on success or failure returned by the module.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>required</strong> (<code class="literal">success=ok new_authtok_reqd=ok ignore=ignore default=bad</code>): Failure<a class="indexterm" id="id475"/> will ultimately lead to the API returning <code class="literal">failure</code>, but only after the remaining modules have been invoked.</li><li class="listitem" style="list-style-type: disc"><strong>requisite</strong> (<code class="literal">success=ok new_authtok_reqd=ok ignore=ignore default=die</code>): Like <a class="indexterm" id="id476"/>required, except control and failure is immediately returned to the calling service.</li><li class="listitem" style="list-style-type: disc"><strong>sufficient</strong> (<code class="literal">success=done new_authtok_reqd=done default=ignore</code>): Success <a class="indexterm" id="id477"/>of a module with this type is enough to satisfy the authentication requirements unless a previously<a class="indexterm" id="id478"/> required module has failed. A failure of a module of this type is not fatal.</li><li class="listitem" style="list-style-type: disc"><strong>optional</strong> (<code class="literal">success=ok new_authtok_reqd=ok default=ignore</code>): Success <a class="indexterm" id="id479"/>or failure of this module is not important.</li></ul></div><div><div><h3 class="title"><a id="tip15"/>Tip</h3><p>Recently, the<a class="indexterm" id="id480"/> second notation (within the brackets) is referred to for the control value, which is accepted to be a better explanation of the meaning.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec65"/>The module path</h2></div></div></div><p>The <a class="indexterm" id="id481"/>module path will consist of either the <a class="indexterm" id="id482"/>full filesystem path to the referenced module and the path would begin with the <code class="literal">/</code> filesystem or a relative to the <code class="literal">/lib/security</code> or <code class="literal">/lib64/security</code> directory.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec66"/>Module arguments</h2></div></div></div><p>The <a class="indexterm" id="id483"/>module arguments are a space <a class="indexterm" id="id484"/>delimited list of tokens that can modify the behavior of a module. The following is an example:</p><div><pre class="programlisting">silent umask=077 skel=/etc/skel</pre></div><p>We could put arguments together and use an example whereby we create a user's home directory for them on first login. This can be useful where we create many accounts in one go and do not want to overload the server creating the home directories at the same time. This is common for universities and so on where many accounts are created in batches.</p><p>Users would most probably connect to the server using SSH, so we should consider adding the following line to the <code class="literal">/etc/pam.d/sshd</code> file:</p><div><pre class="programlisting">session  required  pam_mkhomedir.so  umask=0077 skel=/etc/skel</pre></div><p>This mechanism utilizes PAM to create the home directory at user login.</p></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec55"/>Limits of PAM</h1></div></div></div><p>Let's stick<a class="indexterm" id="id485"/> with using the SSH login at the moment. Many users will only access the server via SSH, perhaps using the PuTTY SSH client on Windows. If we want to control access to system resources, then we can implement restrictions using PAM and <code class="literal">pam_limits.so</code>. We should add the following line to the <code class="literal">/etc/pam.d/sshd</code> file:</p><div><pre class="programlisting">session required pam_limits.so</pre></div><p>This will <a class="indexterm" id="id486"/>implement the module, however, we still have to set the restrictions in the <code class="literal">/etc/security/limits.conf</code> file; the module reads from this file. The file's structure is set as follows with these elements making up a line in the limits file:</p><div><pre class="programlisting">&lt;domain&gt; &lt;type&gt; &lt;item&gt; &lt;value&gt;</pre></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec67"/>Domain</h2></div></div></div><p>Domain<a class="indexterm" id="id487"/> represents to whom the limit is intended. This, most often, is<a class="indexterm" id="id488"/> a username such as <code class="literal">user1</code> or a group entry such as <code class="literal">@users</code>; the <code class="literal">@</code> symbol differentiates between user and group names. To implement a default restriction to apply to all accounts that do not have their own entry is the wildcard <code class="literal">*</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec68"/>Type</h2></div></div></div><p>Type can be set to <code class="literal">soft</code>, <code class="literal">hard</code>, or both with <code class="literal">-</code>. Use the <code class="literal">hard</code> restriction for enforcing hard<a class="indexterm" id="id489"/> resource limits. These limits are set by the root user and enforced by<a class="indexterm" id="id490"/> the kernel. The user cannot raise their requirement of system resources above such values. Be cautious when enforcing restrictions before adequately testing, as it is possible to bring a system to a halt if enough processes cannot be spawned.</p><p>The <code class="literal">soft</code> restriction is used to enforce soft resource limits. These limits are the ones that the user can move up or down within the permitted range with any pre-existing hard limits. The values specified with this token can be thought of as default values for normal system usage. Use of the <code class="literal">-</code> symbol is to enforce both soft and hard resource limits together.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec69"/>Item</h2></div></div></div><p>The item<a class="indexterm" id="id491"/> represents the system resource on which the restriction is <a class="indexterm" id="id492"/>being made. Command items that can be restricted include the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>nofile</strong>: This<a class="indexterm" id="id493"/> sets the maximum number of open files</li><li class="listitem" style="list-style-type: disc"><strong>maxlogins</strong>: This<a class="indexterm" id="id494"/> is the maximum number of logins for this user except for the user with uid=0</li><li class="listitem" style="list-style-type: disc"><strong>maxsyslogins</strong>: This<a class="indexterm" id="id495"/> is the maximum number of all logins on a system</li><li class="listitem" style="list-style-type: disc"><strong>priority</strong>: This<a class="indexterm" id="id496"/> is the priority to run user process with (negative values boost process priority)</li><li class="listitem" style="list-style-type: disc"><strong>nice</strong>: This is <a class="indexterm" id="id497"/>the maximum nice priority allowed to raise to (Linux 2.6.12 and higher) values: [-20,19]</li></ul></div><p>You can<a class="indexterm" id="id498"/> see from the preceding partial item list that it is possible to assign certain users a higher CPU priority than others, which is useful for call center groups whose access is more time sensitive than other accounts. The following example would give the telesales group a higher priority than standard users where the priority is normally 0:</p><div><pre class="programlisting">*            -   priority    0
@telesales   -   priority   -5</pre></div><p>It may also be useful to limit concurrent logins with an entry similar to the following:</p><div><pre class="programlisting">@users  -   maxlogins   1</pre></div><p>These limits might be very important to the running of your server and its security. So do take the time to investigate what is best in your environment, and more information can be found by referencing the manual page:</p><div><pre class="programlisting">
<strong>$ man 5 limits.conf</strong>
</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec56"/>SELinux</h1></div></div></div><p>I am not <a class="indexterm" id="id499"/>really sure if I can quantify how many blogs I read on the Internet where "the solution" to an issue is to disable SELinux, or at least set it into permissive mode. While I do not disagree that the immediate problem may then be resolved, it is a little like setting the filesystem permissions to rwx for all users authenticated or otherwise. Similarly, we all joke about users sticking post-it notes with password to the screen; there is little difference in this to an administrator disabling SELinux inappropriately. </p><p>There <a class="indexterm" id="id500"/>are reasons that the <strong>mandatory access control</strong> (<strong>MAC</strong>) list exists, and we as administrators should use it to our advantage. Traditionally, we are accustomed to <a class="indexterm" id="id501"/>using <strong>discretionary access control</strong> (<strong>DAC</strong>) lists and these can be set by users as well as root. The MAC is said to be mandatory, as it can only be applied and revoked by root.</p><p>First the DAC list is applied, and then the MAC list. SELinux never gives additional rights that were not there in the first place. The real advantage that we have is that we can give the same process different rights depending on the SELinux context in which it was started or is accessing. So, a process started as a service through the <code class="literal">init</code> daemon can have different rights to the same process that was started outside of the normal <code class="literal">init</code> process by <a class="indexterm" id="id502"/>a user. SELinux is very powerful, and we just need to understand how we can channel its power.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec70"/>Reading the current SELinux mode</h2></div></div></div><p>SELinux has <a class="indexterm" id="id503"/>two modes, but it can operate in three if you include the disabled mode. The operational modes are as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Enforcing</li><li class="listitem" style="list-style-type: disc">Permissive</li></ul></div><p>SELinux is <a class="indexterm" id="id504"/>enabled in both these modes, but only<a class="indexterm" id="id505"/> the <code class="literal">Enforcing</code> mode will apply and enforce<a class="indexterm" id="id506"/> SELinux policies. In <code class="literal">Permissive</code> mode, the policies are<a class="indexterm" id="id507"/> read but not acted upon; however, we can view any denials from the audit log. The log entries still appear as denials even though the denials are not enforced while in the <code class="literal">Permissive</code> mode. The <code class="literal">/usr/sbin/getenforce</code> command can be used to display the current SELinux mode:</p><div><pre class="programlisting">
<strong>$ getenforce</strong>
</pre></div><p>This setting can also be read from the <code class="literal">/selinux/enforce</code> file:</p><div><pre class="programlisting">
<strong>$ cat  /selinux/enforce</strong>
</pre></div><p>The integers 1 and 0 represent the SELinux modes: <code class="literal">Enforcing</code> and <code class="literal">Permissive</code> respectively. Note that the <code class="literal">/selinux</code> directory is the SELinux mountpoint in CentOS; in other systems, this may be <code class="literal">/sys/fs/selinux</code>, or you can check the output of <code class="literal">sestatus</code>, which is shown in the following screenshot:</p><div><img alt="Reading the current SELinux mode" src="img/5920OS_10_02.jpg"/></div><p>The mode <a class="indexterm" id="id508"/>can also be read from the <code class="literal">sestatus</code> (<code class="literal">/usr/bin/sestatus</code>) command; this command returns a little more information including <a class="indexterm" id="id509"/>the current mode as well as the mode configured in <code class="literal">/etc/selinux/config</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec71"/>Setting the SELinux mode</h2></div></div></div><p>As with<a class="indexterm" id="id510"/> most tasks in Linux, setting the SELinux mode is very flexible, in that, it can be set in many ways. Firstly we will look at the use of <code class="literal">setenforce</code> (<code class="literal">/usr/sbin/setenforce</code>):</p><div><pre class="programlisting">
<strong># setenforce 1</strong>
<strong># setenforce Enforcing</strong>
<strong># setenforce 0</strong>
<strong># setenforce Permissive</strong>
</pre></div><p>The first two options are used to set the mode to <code class="literal">Enforcing</code> and the bottom two, to <code class="literal">Permissive</code>, either method can be used, as the word and integer have the same meaning as the <a class="indexterm" id="id511"/>
<code class="literal">setenforce</code> command.</p><p>We can also set the mode by writing directly to the control file within the SELinux mountpoint:</p><div><pre class="programlisting">
<strong># echo 1 &gt; /selinux/enforce</strong>
<strong># echo 0 &gt; /selinux/enforce</strong>
</pre></div><p>If we need more ways to set this, we can also use kernel options at boot time. Appending to the kernel entry in the GRUB configuration file will have the effect of overwriting the default mode in the <code class="literal">/etc/selinux/config</code> file:</p><div><pre class="programlisting">enforcing=1
enforcing=0</pre></div><p>Lastly, we can configure the mode in the <code class="literal">/etc/selinux/config</code> file.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec72"/>Preventing mode changes from the command line</h2></div></div></div><p>I know <a class="indexterm" id="id512"/>many system administrators who will readily set the system to <code class="literal">Permissive</code> in order to provide a <em>quick fix</em>; if this is contrary to your administration policy, then you can enforce the mode at boot time by using the <code class="literal">setsebool</code> (<code class="literal">/usr/sbin/setsebool</code>) command; perhaps, as a script at system boot:</p><div><pre class="programlisting">
<strong># setsebool secure_mode_policyload on</strong>
</pre></div><p>Once set, the mode cannot be changed from what was set during the startup process either from the file or boot parameters to the kernel. This can be seen from the following screenshot when the mode is attempted to be changed.</p><div><img alt="Preventing mode changes from the command line" src="img/5920OS_10_03.jpg"/></div><p>The <a class="indexterm" id="id513"/>setting made in this way will persist until the next boot. If we would prefer this setting to always be in place, then we can make it truly persistent with the <code class="literal">-P</code> option. Do take care while using this, as it does what it says on the tin. The setting is then persisted.</p><div><div><h3 class="title"><a id="tip16"/>Tip</h3><p>Caution is advised in implementing the following command:</p><div><pre class="programlisting">
<strong># setsebool -P secure_mode_policyload on</strong>
</pre></div></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec73"/>Understanding SELinux contexts</h2></div></div></div><p>SELinux <a class="indexterm" id="id514"/>will try to match the context of the process to the context of the resource being accessed; the SELinux policy in effect will specify what access is allowed to the resource from a given context. A SELinux context consists of four fields, note that the user is a SELinux user as opposed to a standard Linux user:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">User</li><li class="listitem" style="list-style-type: disc">Role</li><li class="listitem" style="list-style-type: disc">Type</li><li class="listitem" style="list-style-type: disc">Sensitivity</li></ul></div><div><div><h3 class="title"><a id="tip17"/>Tip</h3><p>Technically, a file has a type and a user or process a domain, but in reality both the type and the domain are suffixed with <code class="literal">-t</code>.</p></div></div><p>We can view the context of a file with <code class="literal">ls -Z</code> as follows:</p><div><pre class="programlisting">
<strong>$ ls -Z /etc/hosts</strong>
</pre></div><p>See the following screenshot:</p><div><img alt="Understanding SELinux contexts" src="img/5920OS_10_04.jpg"/></div><p>The <a class="indexterm" id="id515"/>output shows the SELinux user, role, type, and sensitivity for the <code class="literal">/etc/hosts</code> file:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">system_u</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">object_r</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">net_conf_t</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">s0</code></li></ul></div><p>We can view the SELinux context of a user with the command ID:</p><div><pre class="programlisting">
<strong>$ id -Z</strong>
</pre></div><p>See the following screenshot:</p><div><img alt="Understanding SELinux contexts" src="img/5920OS_10_05.jpg"/></div><p>We can see from the output of the command that the SELinux context for this user (<code class="literal">user</code>) is currently:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">unconfined_u</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">unconfined_r</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">unconfined_t</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">s0</code> sensitivity (<code class="literal">s0</code> starts and stops at <code class="literal">s0</code>) and any category (<code class="literal">c0</code> through to <code class="literal">c1023</code>)</li></ul></div><p>To view the SELinux context of a process, we can use the <code class="literal">ps</code> command. In this example, the process ID of <code class="literal">1629</code> represents the Nginx server:</p><div><pre class="programlisting">
<strong># ps -Z 1629</strong>
</pre></div><p>Well over 90 percent of SELinux policies work with the type (<code class="literal">_t</code>), so most often this is where we will be troubleshooting.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec74"/>Troubleshooting SELinux</h2></div></div></div><p>We will now look at what happens when the context of a file resource and process does not <a class="indexterm" id="id516"/>match the SELinux policy.</p><p>For the<a class="indexterm" id="id517"/> purpose of the demonstration, I will use CentOS 6.5 and the Apache httpd web server. To create a command SELinux issue the web server will be configured to access an aliased directory outside of the normal <code class="literal">/var/www</code> structure. This could mimic a typical process where you want to supply kickstart files via HTTP to aid the automatic installation of your workstations and servers.</p><p>Of course as soon as we work outside of the <code class="literal">/var/www/</code> directory, the file context or labels will not match the expectation of the web server and access will be denied even though we meet the requirements of the DAC (file permissions).</p><div><div><h3 class="title"><a id="tip18"/>Tip</h3><p>The web server configuration is correct to allow the URL <code class="literal">/ks</code> to point to <code class="literal">/install/ks</code> as this has been added in by way of an alias.</p></div></div><p>Consider the following commands:</p><div><pre class="programlisting">
<strong># mkdir  -m 755 -p /install/ks</strong>
<strong># cp /root/anaconda-ks.cfg /install/ks</strong>
<strong># chmod 644 /install/ks/anaconda-ks.cfg</strong>
</pre></div><p>With this in place, we can restart the web server and test access to the normal web root and to the URL <code class="literal">/ks</code>. For ease of demonstration, I have installed the command-line browser <code class="literal">w3m</code>:</p><div><pre class="programlisting">
<strong>$ w3m localhost</strong>
</pre></div><p>This works and displays the standard welcome page. Now use the following command:</p><div><pre class="programlisting">
<strong>$ w3m localhost/ks</strong>
</pre></div><p>We will see a rather ominous <strong>Forbidden</strong> page, as shown in the following screenshot:</p><div><img alt="Troubleshooting SELinux" src="img/5920OS_10_06.jpg"/></div><p>If we have the audit running, then SELinux denials are written to the audit log file, which is <code class="literal">/var/log/audit/audit.log</code>. We can use <code class="literal">ausearch</code> (available at <code class="literal">/sbin/ausearch</code>) to query this file:</p><div><pre class="programlisting">
<strong># ausearch -m avc -ts recent</strong>
</pre></div><p>The<a class="indexterm" id="id518"/> options that we have used with the command are explained <a class="indexterm" id="id519"/>as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-m</code>: This is the message to search for. We look for <code class="literal">avc</code>, which is the SELinux denials.</li><li class="listitem" style="list-style-type: disc"><code class="literal">-ts</code>: This is the time start. If we use <code class="literal">recent</code>, it means from 10 minutes ago. The input <code class="literal">today</code> can also be commonly used.</li></ul></div><p>The output of the <code class="literal">ausearch</code> command is shown in the following screenshot:</p><div><img alt="Troubleshooting SELinux" src="img/5920OS_10_07.jpg"/></div><p>As we can see from the output, we have been denied read access for the PID of <code class="literal">1731</code>. We were running the <code class="literal">httpd</code> command while accessing the <code class="literal">/ks</code> directory, which is the inode <code class="literal">22341</code> in the filesystem of <code class="literal">sda3</code>. I am already impressed with this detail! The subject context has the type <code class="literal">httpd_t</code>, and the target has the type <code class="literal">default_t</code>. The subject is process 1731, and the target is the file in this case, and they do not match contexts, and access is denied.</p><p>We can use the command, <code class="literal">chcon</code> (available at <code class="literal">/usr/bin/chcon</code>), to change the SELinux context of the target either directly or by referencing the context of a directory that we know works, <code class="literal">/var/www/html</code>:</p><div><pre class="programlisting">
<strong># chcon -Rv --reference /var/www/html /install/ks</strong>
</pre></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">-v</code>: This makes the file verbose</li><li class="listitem" style="list-style-type: disc"><code class="literal">-R</code>: This recurses all file and subdirectories</li><li class="listitem" style="list-style-type: disc"><code class="literal">--reference</code>: This means copy the context from this file</li></ul></div><p>Alternatively, we can set the context directly; although for accuracy and simplicity, I would prefer to use the <code class="literal">--reference</code> method:</p><div><pre class="programlisting">
<strong># chcon -Rv --type httpd_sys_content_t  /install.ks</strong>
</pre></div><p>A<a class="indexterm" id="id520"/> process of type <code class="literal">httpd_t</code> can access resources that include <code class="literal">httpd_sys_content_t</code>, so with this simple change, we should now have access to<a class="indexterm" id="id521"/> the <code class="literal">/ks</code> directory through the web server without disabling SELinux. </p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec57"/>Hardening Linux</h1></div></div></div><p>We can really look at the previous example using SELinux to determine what we mean by hardening<a class="indexterm" id="id522"/> Linux, but this is often not the simple option. In the case of SELinux, the simple option is to set the <code class="literal">Permissive</code> mode but this does not go hand in hand with the best security for our systems.</p><p>Start with passwords and ask yourself how often are passwords changed on your system? When was the root password last changed? How many people have access to the root password? I come across many instances where the root password is never changed, and all administrators seem to have access to the root password. This is not a secure way of running your system even though it may help in the short term. Think of how many people who no longer work for your company have access to the root user password.</p><p>Of course, the system security has to work for you and the company, but the needs of a secure system should never be undervalued. For root access, consider using <code class="literal">sudo</code> instead of <code class="literal">su</code> and don't give the root password to each administrator.</p><p>Similarly, ensure strong password for accounts that have <code class="literal">sudo</code> rights as well as the root account.</p><div><div><div><div><h2 class="title"><a id="ch10lvl2sec75"/>Password auditing</h2></div></div></div><p>I will use the <a class="indexterm" id="id523"/>term password auditing, as I do feel the tool highlights the need for adequate monitoring of password policies. You may well ask users to use strong passwords and to a degree we can enforce this use PAM modules. However, how many users have the same password, perhaps managers whose passwords are set by an assistant. It may also be the case that you have not realized how important it is not to allow weak <a class="indexterm" id="id524"/>passwords, often to save issues with forgetful users. The package john from Openwall (<a class="ulink" href="http://www.openwall.com">http://www.openwall.com</a>) is one not to be missed to help you understand the need for strong passwords and algorithms.</p><p>The RPM is not in the repository but can be obtained from the Openwall site.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec76"/>Preparing a password file</h2></div></div></div><p>The password auditing tool john will be expecting users and passwords in one file, so we will <a class="indexterm" id="id525"/>use the <code class="literal">pwunconv</code> (<code class="literal">/usr/sbin/pwunconv</code>) command to add the passwords from the <code class="literal">/etc/shadow</code> file to the <code class="literal">/etc/passwd</code> file. Although this is not ideal, you have the password file; you can copy it to you own directory and use <code class="literal">pwconv</code> to switch back to the <code class="literal">/etc/shadow</code> file. The purpose of john is to show what is possible if password security isn't as it should be, and gaining rogue root privileges to the server is not unheard of. Even if john is run as a demonstration, it becomes a great tool to show what is possible with weak passwords, and a lab machine is fine for the demo.</p><p>The <code class="literal">pwunconv</code> command<a class="indexterm" id="id526"/> run as root is enough to read passwords from the shadow file into the <code class="literal">/etc/passwd</code> file.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec77"/>Cracking passwords</h2></div></div></div><p>Now that <a class="indexterm" id="id527"/>we have the prepared password file, we can copy it our own home directory:</p><div><pre class="programlisting">
<strong># cp /etc/passwd /root/passwd</strong>
</pre></div><p>This step is not strictly required, but will allow you to convert back to shadow files as quickly as possible if this is not a lab machine. Run the following <code class="literal">john</code> command with the path through to the password file you would like to crack. The password file should contain users and passwords.</p><div><pre class="programlisting">
<strong># john /root/passwd</strong>
</pre></div><p>This will then start cracking the passwords that it finds. In my file, there is only one user with a password, and it uses the default SHA512 encryption.</p><div><div><h3 class="title"><a id="tip19"/>Tip</h3><p>On my system, a simple password <code class="literal">Password1</code> took just 1 minute and 45 seconds to crack.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec78"/>Weakening the algorithm</h2></div></div></div><p>The <a class="indexterm" id="id528"/>password is weak enough, but what if we weakened the algorithm too? MD5 is only 128-bit or 16-byte encryption; what effect would that<a class="indexterm" id="id529"/> have on the result? We can use the <code class="literal">chpasswd</code> (available at <code class="literal">/usr/sbin/chpasswd</code>) command to generate passwords with MD5 rather than SHA512 encryption:</p><div><pre class="programlisting">
<strong># echo andrew:Password | chpasswd  -c MD5</strong>
</pre></div><p>This command writes to the <code class="literal">/etc/passwd</code> file; if you need to write to your own file, send the output to <code class="literal">stdout</code> with <code class="literal">-S</code> and add the displayed text to your own password file:</p><div><pre class="programlisting">
<strong># echo andrew:Password | chpasswd -S  -c MD5</strong>
</pre></div><p>We <a class="indexterm" id="id530"/>can now try running john again. However, to ensure that the new password is cracked fairly, delete the <code class="literal">john.pol</code> file that will contain the original password:</p><div><pre class="programlisting">
<strong># rm ~/.john/john.pot</strong>
</pre></div><p>The <code class="literal">john.pot</code> file contains previously cracked passwords; so to run a true comparison, we should ensure that this file does not exist. Now, running the same test on my system, the crack, with the same password set but only with 128-bit encryption, took just 0.8 seconds.</p></div><div><div><div><div><h2 class="title"><a id="ch10lvl2sec79"/>Hardening the password</h2></div></div></div><p>With a more<a class="indexterm" id="id531"/> secure password set, we can see the difference in time needed to crack the password, as a brute force attack will be needed. In this example, we use a password <code class="literal">27csg0TNWoUS</code>. This is more of a passphrase to me, as I would remember this as <em>the 27th scout group of the Northwestern United States</em>. Anyway, I am sure you have your own ways to memorize complex passwords that don't involve post-it notes.</p><p>With this password set and MD5 encryption, I left the program running for 20 minutes, and it had not cracked the password. In time, moving from 0.8 seconds with a simple password to 20 minutes is a great demonstration on the use of secure passwords and how much more effective a strong password is compared to relying on a strong algorithm.</p><p>Start with these few steps, and your Linux system will be more secure from the outset.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch10lvl1sec58"/>Summary</h1></div></div></div><p>In this chapter, we walked on the secure side of the road. Starting out with understanding a little of how PAM modules work and looking at ways in which we can use these modules to help us in administration and security. We saw that we could create user home directories, as they log in using PAM and a just-in-time method. We also looked at how we can restrict access and grant more access to users and groups using <code class="literal">/etc/security/limits.conf</code>. We then spent a little time to understand SELinux and securing our CentOS host.</p><p>The next chapter will discuss some general best practices guides to some of the elements that the book has taken us through.</p></div></body></html>