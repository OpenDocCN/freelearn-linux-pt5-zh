<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch11"/>Chapter 11. Automating and Extending Nagios Core</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Allowing and submitting passive checks</li><li class="listitem" style="list-style-type: disc">Submitting passive checks from a remote host with NSCA</li><li class="listitem" style="list-style-type: disc">Submitting passive checks in response to SNMP traps</li><li class="listitem" style="list-style-type: disc">Setting up an event handler script</li><li class="listitem" style="list-style-type: disc">Tracking host and service states with Nagiosgraph</li><li class="listitem" style="list-style-type: disc">Reading status into a MySQL database with NDOUtils</li><li class="listitem" style="list-style-type: disc">Writing customized Nagios Core reports</li><li class="listitem" style="list-style-type: disc">Getting extra visualizations with NagVis</li></ul></div><div><div><div><div><h1 class="title"><a id="ch11lvl1sec91"/>Introduction</h1></div></div></div><p>In addition to being useful as a standalone monitoring framework, Nagios Core has a modular design that allows both interaction with and extension by other programs and tools, predominantly using its external command file for controlling the behavior of the server.</p><p>One of the most useful ways of interacting with the Nagios Core server in this way is through the use of passive checks: submitting check results to the server directly, rather than as the result of the server's own active checks.</p><p>The simplest application of the idea of passive checks is for monitoring some process that might take an indeterminate amount of time to run, and hence resists active checking; instead of the service making active checks of its own, it accepts a check result submitted by another application, perhaps something like a backup script after it has completed its run. These can be sent and accepted via an addon called the <strong>Nagios Service Check Acceptor</strong> (<strong>NSCA</strong>). Similarly, just as plugins and notifications are actually scripted calls to external commands, such as <code class="literal">check_http</code>, and <code class="literal">mail</code>, event handlers can be configured to run a specified command every time a host <a id="id665" class="indexterm"/>or service changes state. This can be used for the supplementary recording of change state data, or automated attempts at actively resolving the problem, such as restarting a remote server. We also saw event handlers used in the <em>Setting up a redundant monitoring host</em> recipe in <a class="link" href="ch10.html" title="Chapter 10. Security and Performance">Chapter 10</a>, <em>Security and Performance</em>.</p><p>Finally, this chapter also includes installation procedures and discussion of a few of the more popular extensions to Nagios Core:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Nagiosgraph</strong>: This is an <a id="id666" class="indexterm"/>advanced web-based graphing solution for Nagios Core, graphing both server performance and host and service status metrics.</li><li class="listitem" style="list-style-type: disc"><strong>NagVis</strong>: This is an advanced web-based <a id="id667" class="indexterm"/>visualization extension for Nagios Core data, especially well-suited for administrators who need something more comprehensive than Nagios Core's built-in networking mapping.</li><li class="listitem" style="list-style-type: disc"><strong>NDOUtils</strong>: This applies the translations of <a id="id668" class="indexterm"/>Nagios Core data into a standard database system such as MySQL; very useful for performing advanced queries of the Nagios Core data for custom systems such as monitoring displays, or logging with change control systems.</li></ul></div><p>We'll discuss NDOUtils, perhaps the most versatile Nagios Core extension of all, in two separate recipes; first by showing how to install it, and then some ideas on how to apply it to make custom Nagios Core reporting applications of our own, in the form of a <strong>CLI report</strong> written in <strong>Perl</strong>, and an <strong>RSS feed</strong> written in <strong>PHP</strong>.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec92"/>Allowing and submitting passive checks</h1></div></div></div><p>In this recipe, we'll learn how to configure Nagios Core to accept passive checks for a service. This allows both users and external applications to directly submit the results of checks to Nagios Core, rather than having the application seek them out itself through polling with active checks, performed via plugins such as <code class="literal">check_http</code> or <code class="literal">check_ping</code>.</p><p>We'll show one simple example of a passive check, <a id="id669" class="indexterm"/>flagging a service called <code class="literal">BACKUP</code> for an existing host. We'll show how to do this via the web interface, which is very easy, and via the external commands file, which is slightly more complex but much more flexible and open to automation.</p><p>The idea is that when a user or process receives confirmation that the backup process on a host has completed correctly, they are able to supply a check result of <code class="literal">OK</code> directly to the service, without Nagios Core needing to poll anything itself.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec370"/>Getting ready</h2></div></div></div><p>You should be running a Nagios Core 3.0 or newer server. You should also already have a host configured for which you want to define a service that will accept passive checks. In this example, we'll use the host <code class="literal">ithaca.naginet</code>, which might be defined as follows:</p><div><pre class="programlisting">define host {
    use        linux-server
    host_name  ithaca.naginet
    alias      ithaca
    address    10.128.0.21
}</pre></div><p>You will also need a working Nagios Core web interface to check that passive checks are enabled, and to try out the recipe's method of submitting passive checks.</p><p>The recipe will be in two parts: enabling and configuring the service for passive checks only, and actually submitting a passive check via the web interface. In the <em>There's more...</em> section, we'll show how to submit a check result via the <a id="id670" class="indexterm"/>external commands file, which is a little more complicated, but allows advanced automation behavior.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec371"/>How to do it...</h2></div></div></div><p>We can define a new <code class="literal">BACKUP</code> service that accepts passive <a id="id671" class="indexterm"/>checks only, as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Log in to the web interface and ensure that passive checks are enabled. The <a id="id672" class="indexterm"/><strong>Tactical Overview</strong> section shows a panel for it near the bottom. Check that it's green:<div><img src="img/5566_11_01.jpg" alt="How to do it..."/></div><p>If it's not green, you should be able to enable the checks again by clicking on the <strong>Disabled</strong> bar. In this case, you should also check the <code class="literal">/usr/local/nagios/etc/nagios.cfg</code> file to make sure that the <code class="literal">accept_passive_service_checks</code> option is set to <code class="literal">1</code> as well, so that Nagios Core allows passive checks on startup.</p></li><li class="listitem">Change to the Nagios Core <code class="literal">objects</code> configuration directory<a id="id673" class="indexterm"/>. If you're using the sample configuration, this will likely be <code class="literal">/usr/local/nagios/etc/objects</code>.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the <code class="literal">commands.cfg</code> file, and add a definition for the <code class="literal">check_dummy</code> command:<div><pre class="programlisting">define command {
    command_name  check_dummy
    command_line  $USER1$/check_dummy $ARG1$ $ARG2$
}</pre></div><p>If you already followed the <em>Monitoring individual nodes in a cluster</em> recipe in <a class="link" href="ch08.html" title="Chapter 8. Managing Network Layout">Chapter 8</a>, <em>Understanding the Network Layout</em>, then you may already have defined this command, in which case you can skip this step, as the definition is the same.</p></li><li class="listitem">Edit the file containing the definition for the existing host. In this example, the host is defined in a file called <code class="literal">ithaca.naginet.cfg</code>.<div><pre class="programlisting">
<strong># vi ithaca.naginet.cfg</strong>
</pre></div></li><li class="listitem">Add the following service definition to the <a id="id674" class="indexterm"/>end of the file, substituting the appropriate value for <code class="literal">host_name</code>.<div><pre class="programlisting">define service {
    use                     generic-service
    host_name               ithaca.naginet
    service_description     BACKUP
<strong>    active_checks_enabled   0</strong>
<strong>    passive_checks_enabled  1</strong>
<strong>    check_command           check_dummy!1!"Unwanted active check!"</strong>
}</pre></div><p>This example uses the <code class="literal">generic-service</code> template. You can use any service template you like; the important directives are <code class="literal">active_checks_enabled</code>, <code class="literal">passive_checks_enabled</code>, and <code class="literal">check_command</code>.</p></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, the Nagios Core web interface should show the service as accepting passive checks only in the <strong>Services</strong> listing:</p><div><img src="img/5566_11_02.jpg" alt="How to do it..."/></div><p>It will remain in the <code class="literal">PENDING</code> state until a passive check result is submitted for it.</p><p>We can submit a passive check result via the web interface as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Click on the service's name in the <strong>Services</strong> <a id="id675" class="indexterm"/>listing, and click on  <strong>Submit passive check result for this service</strong> menu item:<div><img src="img/5566_11_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Complete the resulting form, with the following values:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Host Name</strong>: This is the host name for which the passive check result should be submitted. This should already be filled out for us.</li><li class="listitem" style="list-style-type: disc"><strong>Service</strong>: This is the service description for which the passive check result should be submitted. This should also already be filled out with <code class="literal">BACKUP</code>.</li><li class="listitem" style="list-style-type: disc"><strong>Check Result</strong>: This is the particular result you would like to submit for the check. In this case, we choose <code class="literal">OK</code> to signal that the backup completed successfully. We could just as easily submit a <code class="literal">CRITICAL</code> result if we wished.</li><li class="listitem" style="list-style-type: disc"><strong>Check Output</strong>: This is a message to attach to the status. In this case, we choose the simple message <strong>Nightly backups were successful</strong>.</li><li class="listitem" style="list-style-type: disc"><strong>Performance Data</strong>: This is the optional extra detail about how the service being checked is performing. We can leave this blank.</li></ul></div></li><li class="listitem">Click on <strong>Commit</strong> to submit the passive <a id="id676" class="indexterm"/>check result:<div><img src="img/5566_11_04.jpg" alt="How to do it..."/></div></li></ol></div><p>After a short delay, the detail for the service should show it as reflecting the result of the passive check, along with explicitly showing that active checks are disabled:</p><div><img src="img/5566_11_05.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec372"/>How it works...</h2></div></div></div><p>The configuration added in the preceding section adds a new service called <code class="literal">BACKUP</code> to the existing <a id="id677" class="indexterm"/>
<code class="literal">ithaca.naginet</code> host, and is designed to manage and report the status of backups for this host. In our example, this isn't something Nagios Core can check manually; no network service on <code class="literal">ithaca.naginet</code> can be checked to see if the backups have succeeded.</p><p>However, suppose as administrators we do receive a backup report in our inbox every morning, so we know whether the backups have succeeded or failed and would like to register that status in Nagios Core, perhaps for record-keeping purposes or to alert other administrators to problems.</p><p>To that end, we disable active checks for the service, and put in place a dummy check command, <code class="literal">check_dummy</code>, which we never expect to run. If for whatever reason an active check is run, it will always flag a <code class="literal">WARNING</code> state, with the message <strong>Unwanted active check!</strong>. The <code class="literal">check_dummy</code> command<a id="id678" class="indexterm"/> never actually checks anything; it is configured to always return the state and output defined in its two arguments.</p><p>Instead, we enable passive checks for the service and submit the results manually. If the backups failed, we could just as easily record that with a passive check result of <code class="literal">WARNING</code> or <code class="literal">CRITICAL</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec373"/>There's more...</h2></div></div></div><p>It's also possible (and often desirable) to submit active checks via the external commands file, which is useful for automation purposes. We write details for the check in a single line into the commands file in the following format:</p><div><pre class="programlisting">[&lt;timestamp&gt;] PROCESS_SERVICE_CHECK_RESULT;&lt;host_name&gt;;&lt;service_description&gt;;&lt;service_status&gt;;&lt;plugin_output&gt;</pre></div><p>For our example, the line would be similar to the following code snippet:</p><div><pre class="programlisting">[1348806599] PROCESS_SERVICE_CHECK_RESULT;ithaca.naginet;BACKUP;0;Nightly backups were successful</pre></div><p>We can write this directly to the external commands file as follows:</p><div><pre class="programlisting">
<strong># CHECK="[`date +%s`] PROCESS_SERVICE_CHECK_RESULT;ithaca.naginet;BACKUP;0;Nightly backups were successful"</strong>
<strong># echo $CHECK &gt;&gt;/usr/local/nagios/var/rw/nagios.cmd</strong>
</pre></div><p>In this context, the <code class="literal">&lt;service_status&gt;</code> field needs to be an integer corresponding to the appropriate state. If you use the text value <code class="literal">OK</code> or <code class="literal">WARNING</code>, the command will not work as expected.</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">0</code> for <code class="literal">OK</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">1</code> for <code class="literal">WARNING</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">2</code> for <code class="literal">CRITICAL</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">3</code> for <code class="literal">UNKNOWN</code></li></ul></div><p>If the syntax is correct, then the passive check will be registered just the same way as if it were submitted via the web interface. Writing to the command file thus allows us to submit passive check results with scripts and automated systems, with a little knowledge of an appropriate shell scripting language such as Bash or Perl.</p><p>We go into a little more detail about using external commands for passive check results, including a common application with the NSCA add-on, in the <em>Submitting passive checks from a remote host with NSCA</em> recipe in this chapter. If you don't want to input your passive checks manually, then you will most likely find this recipe of interest, along with its accompanying explanation of freshness checks.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec374"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Submitting passive checks from a remote host with NSCA</em>, <em>Submitting passive checks in response to SNMP traps</em>, and <em>Setting up an event handler script</em> recipes in this chapter</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec93"/>Submitting passive checks from a remote host with NSCA</h1></div></div></div><p>In this recipe, we'll show how to automate the submission of passive checks by a remote host, using the example of a monitored host, <code class="literal">ithaca.naginet</code>, submitting a passive check to a Nagios Core server with information <a id="id679" class="indexterm"/>
<a id="id680" class="indexterm"/>
<a id="id681" class="indexterm"/>about how its <code class="literal">BACKUP</code> service is performing.</p><p>For example, if the backup process completed successfully, we configure the monitored host to submit a passive check result specifying that the <code class="literal">BACKUP</code> service should have the status <code class="literal">OK</code>. However, if there were a problem with the backup, the monitored host could send a passive check result with a <code class="literal">WARNING</code> or <code class="literal">CRITICAL</code> status.</p><p>In both cases, Nagios Core does no checking of its own; it trusts the results submitted by its target host.</p><p>To do this, we'll use the NSCA add-on. We'll install the NSCA server on the Nagios Core server, and the NSCA client program <code class="literal">send_nsca</code> on the monitored host.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec375"/>Getting ready</h2></div></div></div><p>You should already have followed the <em>Allowing and submitting passive checks</em> recipe in this chapter. In this recipe, we will be building on the configuration established in that recipe; specifically, we will assume that you already have a host with a service configured only to accept passive checks.</p><p>You will need to be able to install the software on both the monitoring server (the NSCA server) and on the server that will submit passive checks (the NSCA client), and ideally be generally familiar with the <code class="literal">./configure</code>, <code class="literal">make</code>, and <code class="literal">make install</code> process for installing software from source on UNIX-like systems.</p><p>You should also be able to define any necessary firewall configuration to allow the NSCA client to send information to TCP port <code class="literal">5667</code> on the NSCA server. A firewall is absolutely necessary to protect the <code class="literal">nsca</code> daemon from abuse.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec376"/>How to do it...</h2></div></div></div><p>We can set up the NSCA server on the monitoring server (in this example, <code class="literal">olympus.naginet</code>) as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest version of NSCA using <code class="literal">wget</code> or a similar tool. You can find download links on the Nagios Exchange page for NSCA at <a class="ulink" href="http://exchange.nagios.org/directory/Addons/Passive-Checks/NSCA--2D-Nagios-Service-Check-Acceptor/details">http://exchange.nagios.org/directory/Addons/Passive-Checks/NSCA--2D-Nagios-Service-Check-Acceptor/details</a>.<p>In this example, we're downloading and compiling it in our home directory on the monitoring server.</p><div><pre class="programlisting">
<strong>$ cd</strong>
<strong>$ wget http://downloads.sourceforge.net/project/nagios/nsca-2.x/nsca-2.7.2/nsca-2.7.2.tar.gz</strong>
</pre></div></li><li class="listitem">Inflate the <code class="literal">.tar.gz</code> file:<div><pre class="programlisting">
<strong>$ tar -xzf nsca-2.7.2.tar.gz</strong>
</pre></div></li><li class="listitem">Move into the new <code class="literal">nsca-2.7.2</code> directory, and configure and compile the <code class="literal">nsca</code> daemon. Note that this process may prompt you to install the <code class="literal">libmcrypt</code> library and its headers, <a id="id682" class="indexterm"/><a id="id683" class="indexterm"/><a id="id684" class="indexterm"/>perhaps in <code class="literal">libmcrypt</code> and <code class="literal">libmcrypt-dev</code> packages in your system's package manager:<div><pre class="programlisting">
<strong>$ cd nsca-2.7.2</strong>
<strong>$ ./configure</strong>
<strong>$ make</strong>
</pre></div></li><li class="listitem">Install the NSCA server files manually; you will likely need <code class="literal">root</code> privileges for this:<div><pre class="programlisting">
<strong># cp src/nsca /usr/local/nagios/bin</strong>
<strong># cp sample-config/nsca.cfg /usr/local/nagios/etc</strong>
</pre></div></li><li class="listitem">Edit the new file <code class="literal">/usr/local/nagios/etc/nsca.cfg</code>:<div><pre class="programlisting">
<strong># vi /usr/local/nagios/etc/nsca.cfg</strong>
</pre></div></li><li class="listitem">Uncomment the <code class="literal">password</code> directive, and define it. A random password generated by a tool such as <code class="literal">pwgen</code> or <code class="literal">makepasswd</code> will work fine. Don't use the one below; it's just an example!<div><pre class="programlisting">password=yV3aa6S2o</pre></div></li><li class="listitem">Check that the NSCA daemon runs with no errors:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nsca -c /usr/local/nagios/etc/nsca.cfg --single</strong>
</pre></div><p>If it does, you should add this command to an appropriate startup script, perhaps in <code class="literal">/etc/rc.local</code>, so that the daemon starts when the monitoring server boots. You should consult your system's documentation to find out the best <a id="id685" class="indexterm"/>
<a id="id686" class="indexterm"/>
<a id="id687" class="indexterm"/>place to add this.</p></li></ol></div><p>We can set up the NSCA client on the monitored server (in this example, <code class="literal">ithaca.naginet</code>) as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Again, download and expand the latest version of NSCA, and configure and compile it:<div><pre class="programlisting">
<strong>$ cd</strong>
<strong>$ wget http://downloads.sourceforge.net/project/nagios/nsca-2.x/nsca-2.7.2/nsca-2.7.2.tar.gz</strong>
<strong>$ tar -xzf nsca-2.7.2.tar.gz</strong>
<strong>$ cd nsca-2.7.2</strong>
<strong>$ ./configure</strong>
<strong>$ make</strong>
</pre></div></li><li class="listitem">Install the NSCA client files manually; you will likely need <code class="literal">root</code> privileges for this, and may need to create the <code class="literal">/usr/local/bin</code> and <code class="literal">/usr/local/etc</code> directories beforehand:<div><pre class="programlisting">
<strong># mkdir -p /usr/local/bin /usr/local/etc</strong>
<strong># cp src/send_nsca /usr/local/bin</strong>
<strong># cp sample-config/send_nsca.cfg /usr/local/etc</strong>
</pre></div></li><li class="listitem">Edit the new file <code class="literal">/usr/local/etc/send_nsca.cfg</code>:<div><pre class="programlisting">
<strong># vi /usr/local/etc/send_nsca.cfg</strong>
</pre></div></li><li class="listitem">Uncomment the <code class="literal">password</code> directive, and define it to be the same as the password given in <code class="literal">nsca.cfg</code> on the monitoring server:<div><pre class="programlisting">password=yV3aa6S2o</pre></div></li><li class="listitem">Run the <code class="literal">send_nsca</code> program to try and submit a passive check result:<div><pre class="programlisting">
<strong># CHECK="ithaca.naginet\tBACKUP\t0\tBackup was successful, this check submitted by NSCA\n"</strong>
<strong># echo -en $CHECK | send_nsca -c /usr/local/etc/send_nsca.cfg -H olympus.naginet</strong>
<strong>1 data packet(s) sent to host successfully.</strong>
</pre></div><p>Substitute the appropriate host names for the monitoring server (<code class="literal">olympus.naginet</code>), the monitored server (<code class="literal">ithaca.naginet</code>), and the service description <code class="literal">BACKUP</code>.</p><p>Note that the fields are separated by <code class="literal">\t</code> characters, which expand to literal <em>Tab</em> characters with <code class="literal">echo -en</code>.</p></li></ol></div><p>If this worked correctly, you should see that the passive <a id="id688" class="indexterm"/>
<a id="id689" class="indexterm"/>
<a id="id690" class="indexterm"/>check result in the web interface was successfully read by the monitoring server and applied appropriately:</p><div><img src="img/5566_11_06.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec377"/>How it works...</h2></div></div></div><p>The <code class="literal">nsca</code> daemon installed on the monitoring server is designed to listen for submitted service checks from the <code class="literal">send_nsca</code> client, provided that the password is correct and the data is in the appropriate format:</p><div><pre class="programlisting">&lt;host_name&gt;\t&lt;service_description&gt;\t&lt;check_result&gt;\t&lt;check_output&gt;\n</pre></div><p>Our example passive check took this form:</p><div><pre class="programlisting">ithaca.naginet\tBACKUP\t0\tBackup was successful, this check submitted by NSCA\n</pre></div><p>Here, as with locally submitted passive checks, <code class="literal">check_result</code> corresponds to a numeric value, to one of the following:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">0</code> for <code class="literal">OK</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">1</code> for <code class="literal">WARNING</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">2</code> for <code class="literal">CRITICAL</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">3</code> for <code class="literal">UNKNOWN</code></li></ul></div><p>Once received by the <code class="literal">nsca</code> daemon on the monitoring server, this is translated into a passive check result command, written to the Nagios Core external commands file at <code class="literal">/usr/local/nagios/var/rw/nagios.cmd</code>, and processed in the same way as a locally submitted passive check would be.</p><p>This allows us to include calls to <code class="literal">send_nsca</code> at the end of scripts such as those managing backups, to immediately and automatically send a passive check result corresponding to whether the backup script succeeded.</p><p>Because of the NSCA daemon's very simple design and very basic security checks, it's important to apply a firewall policy to ensure that only the <a id="id691" class="indexterm"/>
<a id="id692" class="indexterm"/>
<a id="id693" class="indexterm"/>appropriate hosts can write to the NSCA port on the host monitoring system. A password as implemented here is a good first step, but is not sufficient to keep things secure. Make sure you read the <code class="literal">SECURITY</code> file included in the NSCA sources to ensure your configuration for the daemon is secure. Similar security guidelines apply to the installation of NRPE as discussed in <a class="link" href="ch06.html" title="Chapter 6. Enabling Remote Execution">Chapter 6</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec378"/>There's more...</h2></div></div></div><p>To supplement this setup, it's often a good idea to also have Nagios Core check the freshness of its services. If we have a process that needs to run regularly, such as backups, we will likely want to be notified if we haven't received any passive checks from the host in a given period of time.</p><p>This can be managed by configuring the service to run an active check after a certain period of time has elapsed with no passive checks. The configuration might look similar to the following code snippet, adding values for <code class="literal">check_freshness</code> and <code class="literal">freshness_threshold</code>:</p><div><pre class="programlisting">define service {
    use                     generic-service
    host_name               ithaca.naginet
    service_description     BACKUP
    active_checks_enabled   0
    passive_checks_enabled  1
<strong>    check_freshness         1</strong>
<strong>    freshness_threshold     86400</strong>
    check_command           check_dummy!1!"No backups have run for 24 hours"
}</pre></div><p>In this case, <code class="literal">freshness_threshold</code> is 86400 seconds, or 24 hours; if there have been no passive checks submitted for 24 hours, <code class="literal">check_command</code> will be run, even though active checks are disabled. <code class="literal">check_command</code> is defined to flag a <code class="literal">WARNING</code> state for the service with an appropriate explanatory message using the <code class="literal">check_dummy</code> command and plugin, whenever it is actually run.</p><p>Check freshness is discussed in more detail in the <a id="id694" class="indexterm"/>
<a id="id695" class="indexterm"/>
<a id="id696" class="indexterm"/>Nagios Core documentation, in the section entitled <em>Service and Host Freshness Checks</em> at <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/freshness.html">http://nagios.sourceforge.net/docs/3_0/freshness.html</a>.</p><p>Note that there's no reason that the status of a service has to come from the same host. You can send a passive check from one host to submit information about another. In fact, this is the basis of a distributed monitoring setup; one host can submit check results for any number of other hosts.</p><p>This can be particularly useful for working around network connectivity or routing problems; if Nagios Core has no connectivity at all to a host it needs to monitor, but does have connectivity to an intermediate host, that host can be configured to submit checks on behalf of the unreachable host, a slightly complex but often necessary setup.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec379"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Allowing and submitting passive checks</em>, <em>Submitting passive checks in response to SNMP traps</em>, and <em>Setting up an event handler script </em>recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Using an alternative check command</em> recipe in <a class="link" href="ch02.html" title="Chapter 2. Working with Commands and Plugins">Chapter 2</a>, <em>Working with Commands and Plugins</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec94"/>Submitting passive checks in response to SNMP traps</h1></div></div></div><p>In this recipe, we'll learn how to configure Nagios Core to process <strong>Simple Network Management Protocol</strong> (<strong>SNMP</strong>) traps, information <a id="id697" class="indexterm"/>sent by monitored network devices to a central monitoring server.</p><p>Because SNMP traps often contain useful or urgent information about how a host is working, processing them in at least some way can be very helpful, particularly for firmware network devices that can't use <code class="literal">send_nsca</code> to submit a passive check result in a standard form, as explained in the <em>Submitting passive checks from a remote host with NSCA</em> recipe.</p><p>As an example, most SNMP-capable hosts can be configured to send SNMP traps when one of their network interfaces changes state, perhaps due to a pulled network cable. These are known as <code class="literal">linkUp</code> and <code class="literal">linkDown</code> traps. Monitoring this particular kind of trap is especially useful for devices with a large number of interfaces, such as switches or routers.</p><p>Keeping track of these events in Nagios Core is valuable for keeping a unified monitoring interface, rather than having to monitor SNMP traps with a separate application.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec380"/>Getting ready</h2></div></div></div><p>There are quite a few prerequisites for getting this recipe to work. It is among the most powerful but also most complex methods of Nagios Core monitoring.</p><p>First of all, the recipe assumes some knowledge of SNMP. Unfortunately, SNMP is not very simple, despite its name! You should be familiar with the concepts of <strong>SNMP checks</strong> and <a id="id698" class="indexterm"/>
<strong>SNMP traps</strong>. The documentation for <a id="id699" class="indexterm"/>
<strong>Net-SNMP</strong> (the implementation of SNMP used for this example) may help (<a class="ulink" href="http://www.net-snmp.org/docs/readmefiles.html">http://www.net-snmp.org/docs/readmefiles.html</a>).</p><p>On the same host as your Nagios Core server with version 3.0 or greater, you should have <code class="literal">snmptrapd</code> installed to collect <code class="literal">trap</code> information, and <code class="literal">snmptt</code>, the <strong>SNMP Trap Translator</strong>
<a id="id700" class="indexterm"/>, to filter useful information from the traps and submit the information to Nagios Core in a workable format. Documentation for SNMPTT is available at <a class="ulink" href="http://snmptt.sourceforge.net/docs/snmptt.shtml">http://snmptt.sourceforge.net/docs/snmptt.shtml</a>.</p><p>Both systems are free software and relatively popular, so check to see if there are packages available for your particular system to save the hassle of compiling them from source. On Debian-derived systems such as Ubuntu, for example, they are available in the <code class="literal">snmpd</code> and <code class="literal">snmptt</code> packages.</p><p>We will use an event handler called <code class="literal">submit_check_result</code>, available in the Nagios Core distribution. You will therefore need to have access to the original sources handy. If you have misplaced them, you can download them again from Nagios' website: <a class="ulink" href="http://www.nagios.org/download">http://www.nagios.org/download</a>.</p><p>It's also necessary to use values of <code class="literal">host_name</code> for your hosts that actually correspond to host names resolvable by DNS from the monitoring server. This is because when the SNMP trap is received by SNMPTT, the only way it can translate it to a host name is with DNS. <code class="literal">host_name</code> for your host might be <code class="literal">crete.naginet</code>, but the trap will arrive from an IP address such as <code class="literal">10.128.0.27</code>. The system will therefore need to be able to resolve this with reverse DNS lookup. An easy way to test this is working is to use <code class="literal">host</code> or <code class="literal">dig</code>:</p><div><pre class="programlisting">
<strong>$ host 10.128.0.27</strong>
<strong>27.0.128.10.in-addr.arpa domain name pointer crete.naginet.</strong>
<strong>$ dig -x 10.128.0.27 +short</strong>
<strong>crete.naginet.</strong>
</pre></div><p>Finally, you should, of course, actually have a device configured to send SNMP traps to your monitoring server, which in turn is configured to <a id="id701" class="indexterm"/>listen for SNMP traps with the <code class="literal">snmpd</code> daemon. I don't really want to encourage you to unplug one of your core switches to test this, so we'll generate a trap manually with <code class="literal">snmptrap</code> on the monitored server to demonstrate the principle.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec381"/>How to do it...</h2></div></div></div><p>We can configure a new service to receive SNMP traps for an existing host as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Copy the event handler script <code class="literal">contrib/eventhandlers/submit_check_result</code> from the Nagios Core source files into <code class="literal">/usr/local/nagios/libexec/eventhandlers</code>. You may need to create the target directory first. Your source files need not be in <code class="literal">/usr/local/src/nagios</code>; this is just an example.<div><pre class="programlisting">
<strong># mkdir -p /usr/local/nagios/libexec/eventhandlers</strong>
<strong># cp /usr/local/src/nagios/contrib/eventhandlers/submit_check_result /usr/local/nagios/libexec/eventhandlers</strong>
</pre></div><p>This script should be made executable as whatever user the <code class="literal">snmptrapd</code> user runs as.</p></li><li class="listitem">Change to the Nagios Core <code class="literal">objects</code> configuration directory on the monitoring server. For the default configuration, this is <code class="literal">/usr/local/nagios/etc/objects</code>.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the file containing the definition for the SNMP-enabled monitored host. In this example, the definition for <code class="literal">crete.naginet</code> is in its own file, <code class="literal">crete.naginet.cfg</code>:<div><pre class="programlisting">
<strong># vi crete.naginet.cfg</strong>
</pre></div><p>The host definition might look similar to the following code snippet:</p><div><pre class="programlisting">define host {
    use        linux-server
    host_name  crete.naginet
    alias      crete
    address    10.128.0.21
}</pre></div></li><li class="listitem">Add a service definition for your existing host that accepts only passive checks, and is flagged as <code class="literal">volatile</code>. Here we have used the <code class="literal">generic-service</code> template included in the sample <a id="id702" class="indexterm"/>configuration. You may prefer to use a different template, but all of the values defined here are important.<div><pre class="programlisting">define service {
    use                     generic-service
    host_name               crete.naginet
    service_description     TRAP
<strong>    is_volatile             1</strong>
    check_command           check-host-alive
<strong>    active_checks_enabled   0</strong>
<strong>    passive_checks_enabled  1</strong>
    max_check_attempts      1
    contact_groups          admins
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div><p>In the web interface, this service should now be visible in the <strong>Services</strong> section:</p><div><img src="img/5566_11_07.jpg" alt="How to do it..."/></div></li><li class="listitem">Check that the <code class="literal">submit_check_result</code> script actually works, by invoking it with a test string on the monitoring server:<div><pre class="programlisting">
<strong># /usr/local/nagios/libexec/eventhandlers/submit_check_result crete.naginet TRAP 0 "Everything working"</strong>
</pre></div><p>After a short delay, if this has worked correctly, we should see the service change state in the web interface to reflect the test:</p><div><img src="img/5566_11_08.jpg" alt="How to do it..."/></div></li></ol></div><p>We now need to configure <code class="literal">snmptrapd</code> and <code class="literal">snmpd</code> to receive traps, and call the <code class="literal">submit_check_result</code> script for us:</p><div><ol class="orderedlist arabic"><li class="listitem">Configure <code class="literal">snmpd</code> to pass received traps to <code class="literal">snmptt</code> by changing its configuration file <code class="literal">/etc/snmp/snmptrapd.conf</code>. The following configuration may work:<div><pre class="programlisting">traphandle default /usr/sbin/snmptt
disableAuthorization yes
donotlogtraps yes</pre></div></li><li class="listitem">Restart <code class="literal">snmpd</code> to apply this change:<div><pre class="programlisting">
<strong># /etc/init.d/snmpd restart</strong>
</pre></div></li><li class="listitem">Configure <code class="literal">snmptt</code> to convert the IP addresses to <a id="id703" class="indexterm"/>hostnames, by changing the value for <code class="literal">dns-enable</code> to <code class="literal">1</code> in <code class="literal">/etc/snmp/snmptt.ini</code>:<div><pre class="programlisting">dns_enable = 1</pre></div></li><li class="listitem">Configure <code class="literal">snmptt</code> to use Net-SNMP at startup in <code class="literal">/etc/snmp/snmptt.ini</code>:<div><pre class="programlisting">net_snmp_perl_enable = 1</pre></div></li><li class="listitem">Configure <code class="literal">snmptt</code> to respond to an SNMP event by defining it in <code class="literal">/etc/snmp/snmptt.conf</code>. Here we've used the generic <code class="literal">linkDown</code> event defined by the OID <code class="literal">.1.3.t6.1.6.3.1.1.5.3</code>:<div><pre class="programlisting">EVENT linkDown .1.3.6.1.6.3.1.1.5.3 "Status Events" Normal
FORMAT Link down on interface $1.  Admin state: $2.  Operational state: $3
EXEC /usr/local/nagios/libexec/eventhandlers/submit_check_result $r TRAP 1 "linkDown for interface $1"
SDESC
A linkDown trap signifies that the SNMP entity, acting in
an agent role, has detected that the ifOperStatus object for
one of its communication links is about to enter the down
state from some other state (but not from the notPresent
state).  This other state is indicated by the included value
of ifOperStatus.
EDESC</pre></div><p>Depending on your distribution, there may already be a definition for a <code class="literal">linkDown</code> event, in which case you may only need to change the <code class="literal">EXEC</code> field.</p></li><li class="listitem">From the monitored host, fire a test trap for a <code class="literal">linkDown</code> event. Substitute <code class="literal">olympus.naginet</code> for the name or IP address of your monitoring host. This will require the <code class="literal">snmptrap</code> utility to be <a id="id704" class="indexterm"/>installed on that host, and may require <code class="literal">root</code> privileges.<div><pre class="programlisting">
<strong># snmptrap -v 1 -c public olympus.naginet .1.3.6.1.6.3.1.1.5.3 localhost 2 0 '' .1.3.6.1.2.1.2.2.1.1.1 i 1</strong>
</pre></div><p>Note that we use the <code class="literal">public</code> community string here; your own will likely differ.</p></li><li class="listitem">Check the Nagios Core log file located at <code class="literal">/usr/local/nagios/var/nagios.log</code> to see if there's new output from the event handler:<div><pre class="programlisting">
<strong>[1348914096] EXTERNAL COMMAND: PROCESS_SERVICE_CHECK_RESULT;crete.naginet;TRAP;1;linkDown for interface 1</strong>
<strong>[1348914100] PASSIVE SERVICE CHECK: crete.naginet;TRAP;1;linkDown for interface 1</strong>
<strong>[1348914100] SERVICE ALERT: crete.naginet;TRAP;WARNING;HARD;3;linkDown for interface 1</strong>
<strong>[1348914100] SERVICE NOTIFICATION: nagiosadmin;crete.naginet;TRAP;WARNING;notify-service-by-email;linkDown for interface 1</strong>
</pre></div><p>If so, the same state should be reflected for the <code class="literal">TRAP</code> service in the web interface:</p><div><img src="img/5566_11_09.jpg" alt="How to do it..."/></div></li></ol></div><p>With this done, we've confirmed that SNMP traps from the <code class="literal">crete.naginet</code> host can be received and processed by the <code class="literal">olympus.naginet</code> server. We can apply the same setup for other hosts that generate SNMP traps in our network by configuring them to send their traps to the Nagios Core monitoring server, and adding appropriate handlers for the expected traps.</p><p>If this didn't work, the first thing to check should be that your monitoring server is actually listening for checks on the relevant IP address, as <code class="literal">snmptrap</code> does not throw errors when it can not deliver traps. On Debian-derived systems, you should check that the <code class="literal">snmptrapd</code> process is actually running; it may <a id="id705" class="indexterm"/>require a change to <code class="literal">/etc/defaults/snmp</code> and a restart of <code class="literal">snmpd</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec382"/>How it works...</h2></div></div></div><p>When an SNMP trap is generated and delivered to the monitoring server by whatever means, the <code class="literal">snmpd</code> daemon will pass it to the <code class="literal">snmptt</code> program for processing.</p><p>The <a id="id706" class="indexterm"/>
<code class="literal">snmptt</code> handler checks if the event OID matches any of the traps for which it has defined events in <code class="literal">snmptt.conf</code>. In our example, it finds a handler defined for the OID <code class="literal">.1.3.6.1.6.3.1.1.5.3</code>, which corresponds to the <code class="literal">linkDown</code> event, with the number of the relevant interface as an additional argument in <code class="literal">$1</code>.</p><p>Using this information, it fires the <code class="literal">submit_check_result</code> handler<a id="id707" class="indexterm"/> that we installed in the first part of the recipe, setting the state of the <code class="literal">TRAP</code> service to <code class="literal">WARNING</code>, and including the information <code class="literal">linkDown</code> for interface <code class="literal">1</code>, as specified by the final argument to <code class="literal">submit_check_result</code> in the <code class="literal">EXEC</code> handler. The service can be set to notify the appropriate contacts or contact groups, just as it would for an actively monitored service.</p><p>If a trap arrives on the Nagios Core server for a host that Nagios Core doesn't know about, even if it has an event handler defined for <code class="literal">snmptt</code>, it will simply ignore it.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec383"/>There's more...</h2></div></div></div><p>In order to "clear" the state of the service and return it to <code class="literal">OK</code>, we can simply schedule an active check for it from the web interface, with <strong>Force Check</strong> selected:</p><div><img src="img/5566_11_10.jpg" alt="There's more..."/></div><p>Because <code class="literal">check_command</code> is defined as <code class="literal">check-host-alive</code>, as long as the monitoring host is actually responding to <code class="literal">PING</code>, the service should assume an <code class="literal">OK</code> state:</p><div><img src="img/5566_11_11.jpg" alt="There's more..."/></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec384"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Submitting passive checks from a remote host with NSCA</em>, <em>Allowing and submitting passive checks</em>, and <em>Setting up an event handler scripts</em> recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Monitoring the output of an SNMP query</em> and <em>Creating an SNMP OID to monitor</em> recipes in <a class="link" href="ch05.html" title="Chapter 5. Monitoring Methods">Chapter 5</a>, <em>Monitoring Methods</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec95"/>Setting up an event handler script</h1></div></div></div><p>In this recipe, we'll learn how to set up an event handler script for Nagios Core. Event handlers are commands that are run on every state change for a <a id="id708" class="indexterm"/>host or service (whether for all hosts or services, or just particular ones). They are defined in a similar way to notification commands and check commands for plugins.</p><p>In this example, we'll implement a simple event handler that writes the date, the host state, and the number of check attempts to a separate file for a single host. This is a trivial example to demonstrate the concept; a more practical and complex application for the use of event handlers is given in the <em>Setting up a redundant monitoring host</em> recipe, in <a class="link" href="ch10.html" title="Chapter 10. Security and Performance">Chapter 10</a>.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec385"/>Getting ready</h2></div></div></div><p>You will need a server running Nagios Core 3.0 or higher. You should be familiar with defining new commands, as per the <em>Creating a new command</em> recipe in <a class="link" href="ch02.html" title="Chapter 2. Working with Commands and Plugins">Chapter 2</a> and the <em>Writing low-priority notifications to an MOTD</em> recipe in <a class="link" href="ch04.html" title="Chapter 4. Configuring Notifications">Chapter 4</a>, <em>Configuring Notifications</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec386"/>How to do it...</h2></div></div></div><p>We can set up a new event handler for the <a id="id709" class="indexterm"/>Nagios Core server as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. In the quick start guide installation, this is <code class="literal">/usr/local/nagios/etc/objects</code>. Edit the file <code class="literal">commands.cfg</code>:<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
<strong># vi commands.cfg</strong>
</pre></div></li><li class="listitem">Add the following command definition:<div><pre class="programlisting">define command {
    command_name    record_host_data
    command_line    /usr/bin/printf "%b" "$LONGDATETIME$: $HOSTSTATE$ (attempt $HOSTATTEMPT$)\n" &gt;&gt;/usr/local/nagios/var/states-$HOSTNAME$.log
}</pre></div></li><li class="listitem">Edit the file containing the definition for an existing host, in this example <code class="literal">delphi.naginet</code>. Add the <code class="literal">event_handler</code> directive with the value <code class="literal">record_host_data</code> to your host definition:<div><pre class="programlisting">define host {
    use            linux-server
    host_name      delphi.naginet
    alias          delphi
    address        10.128.0.26
<strong>    event_handler  record_host_data</strong>
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, the next time the host changes state (whether to a <code class="literal">SOFT</code> or <code class="literal">HARD</code> state) it should log the information in the <code class="literal">/usr/local/nagios/var/states-delphi.naginet.log</code> file:</p><div><pre class="programlisting">
<strong>Sat Sept 29 23:53:54 NZST 2012: DOWN (attempt 1)</strong>
<strong>Sat Sept 29 23:54:04 NZST 2012: DOWN (attempt 2)</strong>
<strong>Sat Sept 29 23:54:14 NZST 2012: DOWN (attempt 3)</strong>
<strong>Sat Sept 29 23:57:14 NZST 2012: UP (attempt 1)</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec387"/>How it works...</h2></div></div></div><p>The <a id="id710" class="indexterm"/>
<code class="literal">event_handler</code> command we defined is configured to use <code class="literal">printf</code> to write a line of text to a file named after the host. Its definition is built out of <a id="id711" class="indexterm"/>four macros:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">$LONGDATETIME$</code>: This specifies the date and time, in a human-readable format</li><li class="listitem" style="list-style-type: disc"><code class="literal">$HOSTSTATE$</code>: This specifies the state of the host (<code class="literal">UP</code>, <code class="literal">DOWN</code>, or <code class="literal">UNREACHABLE</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">$HOSTATTEMPT$</code>: This specifies the number of check attempts made so far for a host in a problem state</li><li class="listitem" style="list-style-type: disc"><code class="literal">$HOSTNAME$</code>: This is the hostname itself (used to build the name of the file)</li></ul></div><p>Note that this behavior is slightly different from notifications. Notification commands are only run when the number of <code class="literal">max_check_attempts</code> for a host or service has been exceeded, to alert somebody to the problem. Event handlers are run on <code class="literal">SOFT</code> changes as well as <code class="literal">HARD</code> changes, and hence can be used to keep more information about host performance that might be missed by the routine notifications.</p><p>Service event handlers can be defined in just the same way, by adding the <code class="literal">event_handler</code> directive to their definitions:</p><div><pre class="programlisting">define service {
    use                  generic-service
    host_name            crete.naginet
    service_description  PING
    check_command        check_ping!100,10%!200,20%
<strong>    event_handler        record_service_data</strong>
}</pre></div><p>In this case, we would probably want to use the macros for service states instead:</p><div><pre class="programlisting">define command {
    command_name    record_service_data
    command_line    /usr/bin/printf "%b" "$LONGDATETIME$: $SERVICESTATE$ (attempt $SERVICEATTEMPT$)\n" &gt;&gt;/usr/local/nagios/var/states-$HOSTNAME$-$SERVICEDESC$.log
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec388"/>There's more...</h2></div></div></div><p>As a shortcut, if there's an event handler we want to run on all hosts or all services, we can use the <code class="literal">global_host_event_handler</code> and <code class="literal">global_service_event_handler</code> directives in <code class="literal">nagios.cfg</code>:</p><div><pre class="programlisting">global_host_event_handler=record_host_data
global_service_event_handler=record_service_data</pre></div><p>This will apply the appropriate event handlers to all hosts and services, therefore running whenever a host or service changes state.</p><p>A specialized case of event handler for recording detailed performance data of plugins and checks is also possible using Nagios Core's Performance Data feature, as documented in the manual at <a class="ulink" href="http://nagios.sourceforge.net/docs/3_0/perfdata.html">http://nagios.sourceforge.net/docs/3_0/perfdata.html</a>.</p><p>Performance data is written on every check rather than every state change, and is hence useful for assessing the performance of plugins and checks. <a id="id712" class="indexterm"/>Performance data is used by the <strong>Nagiosgraph</strong> utility, for example, discussed in the <em>Tracking host and service states with Nagiosgraph</em> recipe in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec389"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Tracking host and service states with Nagiosgraph</em> recipe in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Creating a new command</em> recipe in <a class="link" href="ch02.html" title="Chapter 2. Working with Commands and Plugins">Chapter 2</a>, <em>Working with Commands and Plugins</em></li><li class="listitem" style="list-style-type: disc">The <em>Writing low-priority notifications to an MOTD</em> recipe in <a class="link" href="ch04.html" title="Chapter 4. Configuring Notifications">Chapter 4</a>, <em>Configuring Notifications</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec96"/>Tracking host and service states with Nagiosgraph</h1></div></div></div><p>In this recipe, we'll learn how to install and configure Nagiosgraph, a program that integrates with Nagios Core's performance data tools to <a id="id713" class="indexterm"/>
<a id="id714" class="indexterm"/>
<a id="id715" class="indexterm"/>
<a id="id716" class="indexterm"/>produce graphs showing long-term information about how checks for hosts and services are performing.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec390"/>Getting ready</h2></div></div></div><p>You will need to be running a Nagios Core 3.0 or later server. Nagiosgraph will probably still work with older versions of Nagios Core, but the configuration may be slightly different. The <a id="id717" class="indexterm"/>
<code class="literal">INSTALL</code> document included in the source for Nagiosgraph explains the differences in detail.</p><p>You should have a thorough understanding of defining hosts, services, and commands, and be able to install new software as the <code class="literal">root</code> user on the monitoring server. You should also be at least familiar with the layout of your Apache HTTPD server on the monitoring system; this recipe will assume it is installed in <code class="literal">/usr/local/apache</code>.</p><p>Because Nagiosgraph has many Perl dependencies, <a id="id718" class="indexterm"/>
<a id="id719" class="indexterm"/>you will need to have Perl installed on your server, and you will likely also need to install a few Perl modules as dependencies. The package manager for your system may include them, or you may need to download them using the <strong>Comprehensive Perl Archive Network</strong> (<strong>CPAN</strong>)<a id="id720" class="indexterm"/>: <a class="ulink" href="http://www.cpan.org/modules/INSTALL.html">http://www.cpan.org/modules/INSTALL.html</a>.</p><p>The server will need to already be monitoring at least one host with at least one service for the graphs to be any use. Nagiosgraph includes rule sets that translate known performance data strings into usable statistics. This means that graphing will work well for familiar plugins with a predictable output format <a id="id721" class="indexterm"/>
<a id="id722" class="indexterm"/>such as <code class="literal">check_ping</code> or <code class="literal">check_http</code>, but might not graph data for less commonly used plugins without a little custom configuration.</p><p>This recipe is not a comprehensive survey of everything you can do with Nagiosgraph; if you like what this does, make sure to check out Nagiosgraph's documentation online at <a class="ulink" href="http://nagiosgraph.sourceforge.net/">http://nagiosgraph.sourceforge.net/</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec391"/>How to do it...</h2></div></div></div><p>We can get some basic Nagiosgraph functionality for our monitoring server as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest version of Nagiosgraph from its website at <a class="ulink" href="http://nagiosgraph.sourceforge.net/">http://nagiosgraph.sourceforge.net/</a>, directly onto your monitoring server, using a tool such as <code class="literal">wget</code>:<div><pre class="programlisting">
<strong>$ cd</strong>
<strong>$ wget http://downloads.sourceforge.net/project/nagiosgraph/nagiosgraph/1.4.4/nagiosgraph-1.4.4.tar.gz</strong>
</pre></div></li><li class="listitem">Inflate the <code class="literal">.tar.gz</code> file and change to the directory within it:<div><pre class="programlisting">
<strong>$ tar -xzf nagiosgraph-1.4.4.tar.gz</strong>
<strong>$ cd nagiosgraph-1.4.4</strong>
</pre></div></li><li class="listitem">As the <code class="literal">root</code> user, run the <code class="literal">install.pl</code> script with the <code class="literal">--check-prereq</code> option. This will give you a survey of any dependencies you may need to install via packages or CPAN. When you have installed all the prerequisites, the output should look similar to the following code snippet:<div><pre class="programlisting">
<strong># ./install.pl --check-prereq</strong>
<strong>checking required PERL modules</strong>
<strong>  Carp...1.11</strong>
<strong>  CGI...3.43</strong>
<strong>  Data::Dumper...2.124</strong>
<strong>  File::Basename...2.77</strong>
<strong>  File::Find...1.14</strong>
<strong>  MIME::Base64...3.08</strong>
<strong>  POSIX...1.17</strong>
<strong>  RRDs...1.4003</strong>
<strong>  Time::HiRes...1.9719</strong>
<strong>checking optional PERL modules</strong>
<strong>  GD...2.39</strong>
<strong>checking nagios installation</strong>
<strong>  found nagios at /usr/local/nagios/bin/nagios</strong>
<strong>checking web server installation</strong>
<strong>  found apache at /usr/sbin/apache2</strong>
</pre></div><p>These are all reasonably standard Perl libraries, so don't forget to check if packages are available for them before you resort to using CPAN. For example, I was able to install the RRDs and GD modules on my Debian system as follows:</p><div><pre class="programlisting">
<strong># apt-get install librrds-perl libgd-gd2-perl</strong>
</pre></div><p>If you are having trouble getting <code class="literal">install.pl</code> to find your Nagios Core or Apache HTTPD instances, then take a look at the output of <code class="literal">install.pl --help</code> to run an <a id="id723" class="indexterm"/>
<a id="id724" class="indexterm"/>installation specific to your kind of system. This is documented in more detail in the <code class="literal">INSTALL</code> file.</p></li><li class="listitem">As the <code class="literal">root</code> user, run the <code class="literal">install.pl</code> script with the <code class="literal">--install</code> argument. You will be prompted many times for directory layout options. The default is shown in square brackets and should be correct for a typical Nagios Core installation, so to start with, simply press <em>Enter</em> on each option.<div><pre class="programlisting">
<strong># ./install.pl --install</strong>
<strong>...Destination directory (prefix)? [/usr/local/nagiosgraph]</strong>
<strong>Location of configuration files (etc-dir)? [/usr/local/nagiosgraph/etc]</strong>
<strong>Location of executables? [/usr/local/nagiosgraph/bin]</strong>
<strong>Location of CGI scripts? [/usr/local/nagiosgraph/cgi]</strong>
<strong>Location of documentation (doc-dir)? [/usr/local/nagiosgraph/doc]</strong>
<strong>Location of examples? [/usr/local/nagiosgraph/examples]</strong>
<strong>Location of CSS and JavaScript files? [/usr/local/nagiosgraph/share]</strong>
<strong>Location of utilities? [/usr/local/nagiosgraph/util]</strong>
<strong>Location of state files (var-dir)? [/usr/local/nagiosgraph/var]</strong>
<strong>Location of RRD files? [/usr/local/nagiosgraph/var/rrd]</strong>
<strong>Location of log files (log-dir)? [/usr/local/nagiosgraph/var]</strong>
<strong>Path of log file? [/usr/local/nagiosgraph/var/nagiosgraph.log]</strong>
<strong>Path of CGI log file? [/usr/local/nagiosgraph/var/nagiosgraph-cgi.log]</strong>
<strong>URL of CGI scripts? [/nagiosgraph/cgi-bin]</strong>
<strong>URL of CSS file? [/nagiosgraph/nagiosgraph.css]</strong>
<strong>URL of JavaScript file? [/nagiosgraph/nagiosgraph.js]</strong>
<strong>Path of Nagios performance data file? [/tmp/perfdata.log]</strong>
<strong>URL of Nagios CGI scripts? [/nagios/cgi-bin]</strong>
<strong>username or userid of Nagios user? [nagios]</strong>
<strong>username or userid of web server user? [www-data]</strong>
<strong>Modify the Nagios configuration? [n]</strong>
<strong>Modify the Apache configuration? [n]</strong>
<strong>...</strong>
</pre></div><p>After the preceding selections are all made, the files should be installed with appropriate permissions set. The final part of the output gives instructions for adding configuration to Nagios Core and Apache HTTPD, which we'll do next.</p></li><li class="listitem">Change to the Nagios Core configuration directory. In the quick start guide installation, this is <code class="literal">/usr/local/nagios/etc</code>.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc</strong>
</pre></div></li><li class="listitem">Edit the core configuration file <code class="literal">nagios.cfg</code>, and add the following directives at the end of the file:<div><pre class="programlisting">
<strong># process nagios performance data using nagiosgraph</strong>
<strong>process_performance_data=1</strong>
<strong>service_perfdata_file=/tmp/perfdata.log</strong>
<strong>service_perfdata_file_template=$LASTSERVICECHECK$||$HOSTNAME$||$SERVICEDESC$||$SERVICEOUTPUT$||$SERVICEPERFDATA$</strong>
<strong>service_perfdata_file_mode=a</strong>
<strong>service_perfdata_file_processing_interval=30</strong>
<strong>service_perfdata_file_processing_command=process-service-perfdata-for-nagiosgraph</strong>
</pre></div></li><li class="listitem">Change to the Nagios Core <code class="literal">objects</code> configuration directory. In the quick start guide installation, this is <code class="literal">/usr/local/nagios/etc/objects</code>.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the <code class="literal">commands.cfg</code> file, and add the following command definition:<div><pre class="programlisting">
<strong># command to process nagios performance data for nagiosgraph</strong>
<strong>define command {</strong>
<strong>    command_name process-service-perfdata-for-nagiosgraph</strong>
<strong>    command_line /usr/local/nagiosgraph/bin/insert.pl</strong>
<strong>}</strong>
</pre></div></li><li class="listitem">Edit the <code class="literal">httpd.conf</code> file for your Apache <a id="id725" class="indexterm"/><a id="id726" class="indexterm"/>HTTPD server to include the following line at the end:<div><pre class="programlisting">Include /usr/local/nagiosgraph/etc/nagiosgraph-apache.conf</pre></div><p>In a local install of Apache HTTPD, this file is normally in <code class="literal">/usr/local/apache/conf/httpd.conf</code>, but its location varies by system. On Debian-derived systems it may be <code class="literal">/etc/apache2/apache2.conf</code>.</p></li><li class="listitem">Validate the configuration of both the Apache HTTPD server and the Nagios Core server, and restart them both:<div><pre class="programlisting">
<strong># /usr/local/apache/bin/apachectl configtest</strong>
<strong># /usr/local/apache/bin/apachectl restart</strong>
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li><li class="listitem">Visit <a class="ulink" href="http://olympus.naginet/nagiosgraph/cgi-bin/showconfig.cgi">http://olympus.naginet/nagiosgraph/cgi-bin/showconfig.cgi</a> in your browser, substituting your own Nagios Core server's hostname, to test that everything's working. You should see a long page with configuration information for Nagiosgraph:<div><img src="img/5566_11_12.jpg" alt="How to do it..."/></div></li><li class="listitem">If everything is working up to this point, the only thing left to do is to define an action URL for the services that you want to graph, so that you can click to go directly to the graphs for that service from the Nagios Core web interface.<p>The tidiest and most straightforward <a id="id727" class="indexterm"/>
<a id="id728" class="indexterm"/>way to do this is to define a service template:</p><div><pre class="programlisting">define service {
    name        nagiosgraph
    action_url  /nagiosgraph/cgi-bin/show.cgi?host=$HOSTNAME$&amp;service=$SERVICEDESC$
    register    0
}</pre></div><p>Then, you can have the services you want graphed inherit from it, as well as from any other templates they use, by adding <code class="literal">nagiosgraph</code> to the value for the <code class="literal">use</code> directive:</p><div><pre class="programlisting">define service {
<strong>    use                   generic-service,nagiosgraph</strong>
    host_name             corinth.naginet
    service_description   PING
    check_command         check_ping!100,10%!200,20%
}</pre></div><p>You should do this for all the services for which you want graphing.</p></li><li class="listitem">Validate the configuration and restart the Nagios Core server again:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, visiting the <strong>Service</strong> section of the web <a id="id729" class="indexterm"/>
<a id="id730" class="indexterm"/>interface should include action icons after each graphed service:</p><div><img src="img/5566_11_13.jpg" alt="How to do it..."/></div><p>Clicking one of these should bring up a graph interface; for example, a service using <code class="literal">check_ping</code> might show something similar to the following screenshot:</p><div><img src="img/5566_11_14.jpg" alt="How to do it..."/></div><p>Note that it includes two line bars to show the thresholds for <code class="literal">CRITICAL</code> and <code class="literal">WARNING</code> state as well as the actual response time. Also note that the preceding graph is several days old; it will take a while to build up enough data to see a perceptible line, and you may not see any graphs until performance data has actually been received from Nagios by Nagiosgraph.</p><p>Don't forget that graphs won't work out of the box for every service. If Nagiosgraph doesn't know how to parse the performance data for a check, it will show a red error text instead of graphs. We'll mention an approach to fixing this in the <em>There's more...</em> section.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec392"/>How it works...</h2></div></div></div><p>The configuration changes in the preceding section prompt Nagios Core to log performance data for every check on every service, using the <code class="literal">service_perfdata_file_processing_command</code> <a id="id731" class="indexterm"/>directive. This command, named <code class="literal">process-service-perfdata-for-nagiosgraph</code>, is defined to pass data to the <code class="literal">bin/insert.pl</code> script included in the new<code class="literal"> /usr/local/nagiosgraph</code> directory.</p><p>This script in turn parses performance output, such as the following output from a typical service using <code class="literal">check_ping</code>:</p><div><pre class="programlisting">PING OK - Packet loss = 0%, RTA = 174.19 ms</pre></div><p>Nagiosgraph extracts numeric information from the performance data, according to the templates defined in <code class="literal">/usr/local/nagiosgraph/etc/map</code>, using Perl regular expressions. This data is recorded using Perl's bindings for the RRD library, and graphed using the GD2 library, with an appearance similar to graphs produced by MRTG.</p><p>The <code class="literal">action_url</code> <a id="id732" class="indexterm"/>directive uses macros for each service to define a URL for each service that shows its graphs. In our example, for a service PING on host <code class="literal">corinth.naginet</code>, <code class="literal">action_url</code> would expand to the following:</p><div><pre class="programlisting">action_url  /nagiosgraph/cgi-bin/show.cgi?host=corinth.naginet&amp;service=PING</pre></div><p>This isn't the only possible use of <code class="literal">action_url</code>, of course; it just happens to be a useful one in our case. You can make <code class="literal">action_url</code> go anywhere you'd like for a given host or service.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec393"/>There's more...</h2></div></div></div><p>If you don't intend to define any other kind of action for services, you may like to change the <code class="literal">action.gif</code> image to something more descriptive than the default red splotch. The Nagiosgraph sources include a possible alternative icon, <a id="id733" class="indexterm"/>
<a id="id734" class="indexterm"/>but you can use any GIF image you wish.</p><div><pre class="programlisting">
<strong># cp nagiosgraph-1.4.4/share/graph.gif /usr/local/nagios/share/images/action.gif</strong>
</pre></div><p>You may well be running some kind of check that Nagiosgraph isn't able to graph, because it doesn't understand the format of the performance output, and can't extract numeric information from it. The default mapping rules cover output from quite a few standard plugins, but if you know a little about Perl, then you may be able to add more rules to <code class="literal">/usr/local/nagiosgraph/etc/map</code> to process other kinds of plugin output.</p><p>Besides the examples in the map file, which include instructions for writing new output checks, there are more examples of such definitions included in the <code class="literal">/usr/local/nagiosgraph/examples/map_examples</code> file.</p><p>If you're comparing Nagios graphing solutions, another popular solution to try could be <strong>PNP4Nagios</strong>, <a id="id735" class="indexterm"/>available at <a class="ulink" href="http://docs.pnp4nagios.org/pnp-0.6/start">http://docs.pnp4nagios.org/pnp-0.6/start</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec394"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Getting extra visualizations with NagVis</em> recipe in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Monitoring Nagios performance with Nagiostats</em> recipe in <a class="link" href="ch10.html" title="Chapter 10. Security and Performance">Chapter 10</a>, <em>Security and Performance</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec97"/>Reading status into a MySQL database with NDOUtils</h1></div></div></div><p>In this recipe, we'll learn how to install the <a id="id736" class="indexterm"/>
<strong>NDOUtils</strong> extension to Nagios Core, in order to have all of Nagios Core's configuration and data written into a MySQL database. This allows easy development of custom reports and interfaces for Nagios Core data with languages, such as Perl and PHP, and their standard interfaces to the popular MySQL server, rather than needing to interact with Nagios Core's own logs or its data format. Some plugins, such as NagVis, use this format to read information about Nagios Core configuration and objects.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec395"/>Getting ready</h2></div></div></div><p>You will need a Nagios Core server version 3.0 or later. NDOUtils will probably still install and work on older versions of Nagios Core, but the installation process is slightly different; see the <code class="literal">INSTALL</code> file included in the NDO source for information on this.</p><p>Nagios Core uses its event broker functionality to write information to the socket for the MySQL database to pick up. You will need to have compiled Nagios Core with the <code class="literal">--enable-event-broker</code> flag:</p><div><pre class="programlisting">
<strong>$ ./configure --enable-event-broker</strong>
<strong>$ make</strong>
<strong># make install</strong>
</pre></div><p>If you are unsure whether you compiled with this flag, it is probably a good idea to recompile and reinstall Nagios Core from your original sources with this installed. Don't forget to back up your previous installation in case of problems.</p><p>In order to compile the <code class="literal">ndomod</code> part of NDOUtils, you will need to have the MySQL client libraries and headers installed on the Nagios Core server. You will also need to have a MySQL server ready to store the data. The MySQL server does not have to be running on the same host as Nagios Core, but the Nagios Core server should be able to connect to it.</p><p>Finally, you should take note of the opening paragraph of <code class="literal">README</code>, which at the time of writing points out that NDOUtils for Nagios Core 3.0 is still officially in beta; you should read the note and be aware of the risks in installing it. In my own experience, however, the code is very stable. There are also no guarantees at the time of writing that this procedure will work correctly with the unreleased Nagios 4.0.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec396"/>How to do it...</h2></div></div></div><p>We can install the NDOUtils package for <a id="id737" class="indexterm"/>Nagios Core as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest <a id="id738" class="indexterm"/>NDOUtils <code class="literal">.tar.gz</code> from its Sourceforge site at <a class="ulink" href="http://sourceforge.net/projects/nagios/files/ndoutils-1.x/">http://sourceforge.net/projects/nagios/files/ndoutils-1.x/</a>.<div><pre class="programlisting">
<strong>$ wget http://downloads.sourceforge.net/project/nagios/ndoutils-1.x/ndoutils-1.5.2/ndoutils-1.5.2.tar.gz</strong>
</pre></div></li><li class="listitem">Unpack the <code class="literal">.tar.gz</code> file and change directory into it.<div><pre class="programlisting">
<strong>$ tar -xzf ndoutils-1.5.2.tar.gz</strong>
<strong>$ cd ndoutils-1.5.2</strong>
</pre></div></li><li class="listitem">Run <code class="literal">./configure</code> and build the software. Note that there is no install target; we will be performing the installation manually.<div><pre class="programlisting">
<strong>$ ./configure</strong>
<strong>$ make</strong>
</pre></div></li><li class="listitem">Read the output of <code class="literal">./configure</code> carefully if the build fails, to determine if you are missing any dependencies on your system. The output of <code class="literal">./configure</code> should end with something similar to the following code snippet:<div><pre class="programlisting">
<strong>*** Configuration summary for ndoutils 1.5.2 06-08-2012 ***:</strong>
<strong>General Options:</strong>
<strong>-------------------------</strong>
<strong>NDO2DB user:    nagios</strong>
<strong>NDO2DB group:   nagios</strong>
<strong>Review the options above for accuracy.  If they look okay,</strong>
<strong>type 'make' to compile the NDO utilities.</strong>
</pre></div></li><li class="listitem">On the MySQL server, create a database to store the Nagios Core information, and a user to access it. In this example, the MySQL server is running on the same host as the Nagios Core server (<code class="literal">olympus.naginet</code>), so the access will be done from <code class="literal">localhost</code>.<div><pre class="programlisting">
<strong>mysql&gt; CREATE DATABASE nagios;</strong>
<strong>Query OK, 1 row affected (0.10 sec)</strong>
<strong>mysql&gt; CREATE USER 'ndo'@'localhost' IDENTIFIED BY 'mPYxbAYqa';</strong>
<strong>Query OK, 0 rows affected (0.62 sec)</strong>
<strong>mysql&gt; GRANT ALL ON nagios.* TO 'ndo'@'localhost';</strong>
<strong>Query OK, 0 rows affected (0.02 sec)</strong>
</pre></div><p>We have used a random password after <code class="literal">IDENTIFIED BY</code>. You should generate your own secure password.</p></li><li class="listitem">Run the <code class="literal">installdb</code> script in the source to create the various tables Nagios Core will use. Use the database details <a id="id739" class="indexterm"/>established in the previous step:<div><pre class="programlisting">
<strong>$ cd db</strong>
<strong>$ ./installdb -u ndo -p mPYxbAYqa -h localhost -d nagios</strong>
<strong>** Creating tables for version 1.5.2</strong>
<strong>    Using mysql.sql for installation...</strong>
<strong>** Updating table nagios_dbversion</strong>
<strong>Done!</strong>
</pre></div><p>Don't be concerned about the following error message; it is because you are installing the extension for the first time:</p><div><pre class="programlisting">DBD::mysql::db do failed: Table 'nagios.nagios_dbversion' doesn't exist at ./installdb line 51.</pre></div></li><li class="listitem">Copy the compiled <code class="literal">ndomod</code> module into the <code class="literal">/usr/local/nagios/bin</code> directory:<div><pre class="programlisting">
<strong># cd ..</strong>
<strong># cp src/ndomod-3x.o /usr/local/nagios/bin/ndomod.o</strong>
</pre></div></li><li class="listitem">Copy the sample configuration for the module into <code class="literal">/usr/local/nagios/etc</code>:<div><pre class="programlisting">
<strong># cp config/ndomod.cfg-sample /usr/local/nagios/etc/ndomod.cfg</strong>
</pre></div></li><li class="listitem">Make sure it is readable only by the <code class="literal">nagios</code> user:<div><pre class="programlisting">
<strong># chown nagios.nagios /usr/local/nagios/etc/ndomod.cfg</strong>
<strong># chmod 0600 /usr/local/nagios/etc/ndomod.cfg</strong>
</pre></div></li><li class="listitem">Edit your <code class="literal">nagios.cfg</code> file:<div><pre class="programlisting">
<strong># vi /usr/local/nagios/etc/nagios.cfg</strong>
</pre></div></li><li class="listitem">Add a <code class="literal">broker_module</code> definition to the file, and check that the <code class="literal">event_broker_options</code> directive is set to <code class="literal">-1</code>:<div><pre class="programlisting">broker_module=/usr/local/nagios/bin/ndomod.o config_file=/usr/local/nagios/etc/ndomod.cfg
event_broker_options=-1</pre></div><p>Note that the <code class="literal">broker_module</code> and <a id="id740" class="indexterm"/>
<code class="literal">config_file</code> definitions should be on the same line, but <code class="literal">event_broker_options</code> should be on its own line.</p><p>With this done, the broker module ought to be successfully installed, and we can move on to installing the <code class="literal">ndo2db</code> daemon.</p></li><li class="listitem">Copy the <code class="literal">ndo2db</code> binary into the <code class="literal">/usr/local/nagios/bin</code> directory:<div><pre class="programlisting">
<strong># cp src/ndo2db-3x /usr/local/nagios/bin/ndo2db</strong>
</pre></div></li><li class="listitem">Copy the sample configuration for the daemon into <code class="literal">/usr/local/nagios/etc</code>:<div><pre class="programlisting">
<strong># cp config/ndo2db.cfg-sample /usr/local/nagios/etc/ndo2db.cfg</strong>
</pre></div></li><li class="listitem">Make sure it is readable only by the <code class="literal">nagios</code> user:<div><pre class="programlisting">
<strong># chown nagios.nagios /usr/local/nagios/etc/ndo2db.cfg</strong>
<strong># chmod 0600 /usr/local/nagios/etc/ndo2db.cfg</strong>
</pre></div></li><li class="listitem">Edit the configuration file as installed:<div><pre class="programlisting">
<strong># vi /usr/local/nagios/etc/ndo2db.cfg</strong>
</pre></div></li><li class="listitem">Change the values in <code class="literal">ndo2db.cfg</code> to reflect the database details:<div><pre class="programlisting">db_host=localhost
db_port=3306
db_name=nagios
db_user=ndo
db_pass=mPYxbAYqa</pre></div></li><li class="listitem">Test the <code class="literal">ndo2db</code> daemon by starting it and verifying it is running with <code class="literal">ps -e</code> or <code class="literal">pgrep</code>:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/ndo2db -c /usr/local/nagios/etc/ndo2db.cfg</strong>
<strong># ps -e | grep '[n]do2db'</strong>
<strong>32285 ? 00:00:00 ndo2db</strong>
<strong># pgrep ndo2db</strong>
<strong>32285</strong>
</pre></div><p>If it works, you should add this command into your system's <code class="literal">init</code> scripts, so that the daemon is started at boot time.</p></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, inspecting the database tables in MySQL should show they have been filled with information from Nagios Core, for example the <code class="literal">nagios_services</code> table:</p><div><pre class="programlisting">
<strong>$ mysql --user=ndo --password --database=nagios</strong>
<strong>mysql&gt; select count(1) from nagios_services;</strong>
<strong>+----------+</strong>
<strong>| count(1) |</strong>
<strong>+----------+</strong>
<strong>|       54 |</strong>
<strong>+----------+</strong>
<strong>1 row in set (0.00 sec)</strong>
</pre></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec397"/>How it works...</h2></div></div></div><p>NDOUtils is in fact a collection of components, two of which we installed in the previous sections:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">ndomod</code> is <a id="id741" class="indexterm"/>used as a broker module, for writing events and data from Nagios Core to a UNIX socket in <code class="literal">/usr/local/nagios/var/ndo.sock</code>. It runs as a module of the Nagios Core server.</li><li class="listitem" style="list-style-type: disc"><code class="literal">ndo2db</code> is used as a <a id="id742" class="indexterm"/>database backend, for reading the events and data from the UNIX socket to which <code class="literal">ndomod</code> writes, and applying them as MySQL database operations. It runs independently as a daemon on the system, and performs the MySQL connection and transactions.</li></ul></div><p>
<code class="literal">broker_module</code> updates these tables as plugins are run, hosts and services change state, notifications are issued, and other Nagios Core behavior takes place. It covers most data of interest quite comprehensively. Note that it includes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuration directives</li><li class="listitem" style="list-style-type: disc">Details for types of Nagios Core objects</li><li class="listitem" style="list-style-type: disc">Properties and current states of hosts</li><li class="listitem" style="list-style-type: disc">Acknowledgement and scheduled downtime information</li><li class="listitem" style="list-style-type: disc">Notification history and complete logging</li></ul></div><p>The main reason to install NDOUtils is to put Nagios Core's data into a standardized format, so that it can be read and processed by external applications, whether in simple table-style reports or completely new application interfaces to the Nagios Core data. This tends to be much easier than custom building a Nagios Core CGI of your own!</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec398"/>There's more...</h2></div></div></div><p>Another recipe in this chapter, <em>Writing customized Nagios Core reports</em>, applies NDOUtils after its installation by demonstrating some example MySQL queries for retrieving useful data and summaries from its tables, including an example of writing a report in Perl, and a simple RSS feed in PHP.</p><p>To get the most out of NDOUtils, it's a good idea to take a look at its documentation, which includes a complete breakdown of the contents of the MySQL tables: <a class="ulink" href="http://nagios.sourceforge.net/docs/ndoutils/NDOUtils.pdf">http://nagios.sourceforge.net/docs/ndoutils/NDOUtils.pdf</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec399"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Writing customized Nagios Core reports</em> and <em>Getting extra visualizations with NagVis</em> recipes in this chapter</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec98"/>Writing customized Nagios Core reports</h1></div></div></div><p>In this recipe, we'll explore some simple applications of the <a id="id743" class="indexterm"/>NDOUtils database by trying out some queries, and change one of them into both a simple report in Perl, and also into a PHP-based RSS feed.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec400"/>Getting ready</h2></div></div></div><p>This recipe assumes you have NDOUtils already installed, and that your Nagios Core 3.0 (or later) server is monitoring at least a few hosts and services, so that the queries we try actually return some data. You should also have some means of executing MySQL queries on the database server. The <code class="literal">mysql</code> command-line client will work just fine; a tool such as phpMyAdmin might make the data a little easier to explore.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec401"/>How to do it...</h2></div></div></div><p>We can explore some queries against the NDOUtils databases as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Retrieve the content and date/time of the latest ten notifications:<div><pre class="programlisting">
<strong>mysql&gt; SELECT start_time, long_output FROM nagios_notifications ORDER BY start_time DESC LIMIT 10;</strong>
</pre></div></li><li class="listitem">Retrieve the content and date/time of the latest ten host or service comments:<div><pre class="programlisting">
<strong>mysql&gt; SELECT entry_time, comment_data FROM nagios_commenthistory ORDER BY entry_time DESC LIMIT 10;</strong>
</pre></div></li><li class="listitem">Count the number of hosts currently in the <code class="literal">OK</code> state:<div><pre class="programlisting">
<strong>mysql&gt; SELECT COUNT(1) FROM nagios_hoststatus WHERE current_state = 0;</strong>
</pre></div></li><li class="listitem">Retrieve the names of all hosts currently in scheduled downtime:<div><pre class="programlisting">
<strong>mysql&gt; SELECT display_name FROM nagios_hosts JOIN nagios_hoststatus USING (host_object_id) WHERE scheduled_downtime_depth &gt; 0;</strong>
</pre></div><p>Note that the syntax of this query assumes a MySQL version of at least 5.0.12.</p></li><li class="listitem">Return a list of all host names and the number of services associated with them:<div><pre class="programlisting">
<strong>mysql&gt; SELECT nagios_hosts.display_name, COUNT(service_id) FROM nagios_hosts LEFT JOIN nagios_services ON nagios_hosts.host_object_id = nagios_services.host_object_id GROUP BY nagios_hosts.host_object_id;</strong>
</pre></div></li></ol></div><p>We could implement a Perl script to print the latest <a id="id744" class="indexterm"/>ten notifications using the DBI module as follows:</p><div><pre class="programlisting">#!/usr/bin/env perl

# Enforce Perl best practices
use strict;
use warnings;

# Import database modules
use DBI;
use DBD::mysql;

# Get connection to database
my $nagios = DBI-&gt;connect(
    'dbi:mysql:dbname=nagios;host=localhost',
    'ndo',
    'mPYxbAYqa'
) or die "Could not connect to database";

# Define an SQL query to run
my $query = q{
    SELECT
        notification_id, start_time, name1, long_output
    FROM
        nagios_notifications
    JOIN
        nagios_objects USING (object_id)
    ORDER BY
        start_time DESC
    LIMIT
        10
};

# Execute query and retrieve notifications
my $notifications = $nagios-&gt;selectall_hashref(
    $query,
    'notification_id'
) or die 'Could not retrieve notifications';

# Print each notification
foreach my $id (keys %{$notifications}) {
    my $notification = $notifications-&gt;{$id};
    printf {*STDOUT} "%s - %s: %s\n",
        $notification-&gt;{start_time},
        $notification-&gt;{name1},
        $notification-&gt;{long_output};
}

# Exit successfully
exit 0;</pre></div><p>Saved into a file <code class="literal">latest-notifications.pl</code>, <a id="id745" class="indexterm"/>we could run it as follows:</p><div><pre class="programlisting">
<strong>$ chmod +x latest-notifications.pl</strong>
<strong>$ ./latest-notifications.pl</strong>
<strong>2012-10-06 10:11:27 - blog: PING OK - Packet loss = 0%, RTA = 160.31 ms</strong>
<strong>2012-10-06 10:48:17 - athens: PING OK - Packet loss = 0%, RTA = 155.82 ms</strong>
<strong>2012-10-06 14:08:17 - athens: PING WARNING - Packet loss = 16%, RTA = 171.79 ms</strong>
<strong>2012-10-06 14:13:17 - athens: PING OK - Packet loss = 0%, RTA = 164.39 ms</strong>
<strong>2012-10-06 10:56:17 - athens: PING CRITICAL - Packet loss = 28%, RTA = 164.65 ms</strong>
<strong>2012-10-06 10:38:17 - athens: PING CRITICAL - Packet loss = 28%, RTA = 166.10 ms</strong>
<strong>2012-10-06 10:06:27 - blog: PING WARNING - Packet loss = 16%, RTA = 163.72 ms</strong>
<strong>2012-10-06 13:39:27 - blog: PING WARNING - Packet loss = 16%, RTA = 163.78 ms</strong>
<strong>2012-10-06 13:44:27 - blog: PING OK - Packet loss = 0%, RTA = 167.10 ms</strong>
<strong>2012-10-06 13:29:27 - blog: PING CRITICAL - Packet loss = 28%, RTA = 159.55 ms</strong>
</pre></div><p>Similarly, we could implement a crude RSS feed for notifications using PHP5 with PDO MySQL as follows:</p><div><pre class="programlisting">&lt;?php
// Get connection to database
$nagios = new PDO(
    'mysql:host=localhost;dbname=nagios',
    'ndo',
    'mPYxbAYqa'
);
// Define an SQL query to run
$query = '
    SELECT
        start_time, name1, long_output
    FROM
        nagios_notifications
    JOIN
        nagios_objects
    USING
        (object_id)
    ORDER BY
        start_time DESC
    LIMIT
        10
';
// Retrieve all the notifications as objects
$statement = $nagios-&gt;prepare($query);
$statement-&gt;setFetchMode(PDO::FETCH_OBJ);
$statement-&gt;execute();
// Read the notifications into an array
for ($notifications = array(); $notification = $statement-&gt;fetch(); ) {
    $notifications[] = $notification;
}
// Send an RSS header rather than an HTML one
header("Content-Type: application/rss+xml; charset=utf-8");
echo '&lt;?xml version="1.0" encoding="UTF-8"?&gt;';
?&gt;
&lt;rss version="2.0"&gt;
    &lt;channel&gt;
        &lt;title&gt;
            Latest Nagios Core Notifications
        &lt;/title&gt;
        &lt;link&gt;
            http://olympus.naginet/nagios/
        &lt;/link&gt;
        &lt;description&gt;
            The ten most recent notifications from Nagios Core
        &lt;/description&gt;
&lt;? foreach ($notifications as $notification): ?&gt;
        &lt;item&gt;
            &lt;description&gt;
                &lt;?= htmlspecialchars($notification-&gt;name1); ?&gt;: &lt;?= htmlspecialchars($notification-&gt;long_output) ?&gt;
            &lt;/description&gt;
            &lt;pubDate&gt;
                &lt;?= htmlspecialchars(date('r', strtotime($notification-&gt;start_time))) ?&gt;
            &lt;/pubDate&gt;
        &lt;/item&gt;
&lt;? endforeach; ?&gt;
    &lt;/channel&gt;
&lt;/rss&gt;</pre></div><p>Saved in a file named <code class="literal">latest-notifications.php</code>, <a id="id746" class="indexterm"/>we could subscribe to this in our favorite RSS reader, such as <a id="id747" class="indexterm"/>
<strong>Life</strong>
<strong>rea</strong> (<a class="ulink" href="http://liferea.sourceforge.net/">http://liferea.sourceforge.net/</a>):</p><div><img src="img/5566_11_15.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec402"/>How it works...</h2></div></div></div><p>The examples given in the preceding section are just to get you started with very simple reports; there is a wealth of data available in the NDOUtils database to explore. Here are some other possibilities:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">A breakdown of all the hosts in your system and their states, ordered by name, presented in an HTML table</li><li class="listitem" style="list-style-type: disc">A list of all the hosts that have been down more than once in a month</li><li class="listitem" style="list-style-type: disc">The percentage of uptime for all hosts</li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec403"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Reading status into a MySQL database with NDOUtils</em> and <em>Getting extra visualizations with NagVis</em> recipes in this chapter</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch11lvl1sec99"/>Getting extra visualizations with NagVis</h1></div></div></div><p>In this recipe, we'll explore how to go beyond the default network map discussed in <a class="link" href="ch08.html" title="Chapter 8. Managing Network Layout">Chapter 8</a>, to get a lot of visualization power with the extension NagVis. NagVis can use the NDOUtils backend to build custom maps in various styles.</p><p>
<strong>NagVis</strong> is <a id="id748" class="indexterm"/>most likely of interest to you if you're interested in visualizing Nagios data more extensively, particularly if you're having problems with the scalability of the included Nagios Core status map. The default status map works well for smaller networks, but can struggle with rendering larger ones in a timely fashion.</p><p>A complete survey of NagVis' functions would not be possible in one recipe, but this one will walk you through downloading, installing, and configuring the extension to give you a simple <strong>automap</strong>, in order to get you started.</p><div><div><div><div><h2 class="title"><a id="ch11lvl2sec404"/>Getting ready</h2></div></div></div><p>You should have a running Nagios Core server with version 3.0 or later, and have the NDOUtils backend successfully installed and populating a MySQL database to which you have administrative access. This is discussed in the <em>Reading status into a MySQL database with NDOUtils</em> recipe in this chapter.</p><p>In order for the automap to be much use, you will need a network with at least a few parent-child relationships—see the <em>Creating a network host hierarchy</em> recipe in <a class="link" href="ch08.html" title="Chapter 8. Managing Network Layout">Chapter 8</a> for details on how this is done.</p><p>NagVis includes an installation script that deals quite well with different systems' installations of Nagios Core. However, it still requires certain dependencies, specifically:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Apache with <code class="literal">mod_php</code> on the same server as Nagios Core</li><li class="listitem" style="list-style-type: disc">PHP 5.3 or newer, with the following modules: <code class="literal">gd</code>, <code class="literal">gettext</code>, <code class="literal">mbstring</code>, <code class="literal">mysql</code>, <code class="literal">pdo</code>, <code class="literal">session</code>, <code class="literal">sqlite</code>, and <code class="literal">xml</code></li><li class="listitem" style="list-style-type: disc">The Graphviz graph visualization software, with the following modules: <code class="literal">circo</code>, <code class="literal">dot</code>, <code class="literal">fdp</code>, <code class="literal">neato</code>, <code class="literal">twopi</code></li><li class="listitem" style="list-style-type: disc">SQLite 3</li></ul></div><p>You may need to consult your system's documentation to install all these dependencies; check your system's package manager, if there is one. For Ubuntu and other Debian-derived systems, the following packages generally suffice:</p><div><pre class="programlisting">
<strong># apt-get install apache2 libapache2-mod-php5 libgd2-xpm libgd2-xpm-dev php5 php5-gd php5-mysql php5-sqlite graphviz sqlite3</strong>
</pre></div><p>On systems such as CentOS and Fedora, the following packages may work:</p><div><pre class="programlisting">
<strong># yum install php php-gd php-gettext php-mbstring php-mysql php-pdo php-sqlite php-xml graphviz graphviz-gd graphviz-php</strong>
</pre></div><p>It is difficult to anticipate the exact packages needed for all systems; searching your package manager for keywords (for example <code class="literal">php sqlite</code>) may help.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec405"/>How to do it...</h2></div></div></div><p>We can install NagVis with an NDO <a id="id749" class="indexterm"/>
<a id="id750" class="indexterm"/>backend as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Download the latest sources for NagVis from <a class="ulink" href="http://www.nagvis.org/downloads">http://www.nagvis.org/downloads</a>:<div><pre class="programlisting">
<strong>$ wget http://downloads.sourceforge.net/project/nagvis/NagVis1.7/nagvis-1.7.1.tar.gz</strong>
</pre></div></li><li class="listitem">Inflate <code class="literal">.tar.gz</code> and change directory to within it:<div><pre class="programlisting">
<strong>$ tar -xzf nagvis-1.7.1.tar.gz</strong>
<strong>$ cd nagvis-1.7.1</strong>
</pre></div></li><li class="listitem">Run the <code class="literal">install.sh</code> script as <code class="literal">root</code>:<div><pre class="programlisting">
<strong># ./install.sh</strong>
</pre></div></li><li class="listitem">The script will attempt to find your Nagios Core installation, and will ask you to specify a location for the new NagVis files. In our case, the defaults are correct and acceptable, so we can simply press <em>Enter</em>.<div><pre class="programlisting">
<strong>-- Checking paths --</strong>
<strong>Please enter the path to the nagios base directory [/usr/local/nagios]:</strong>
<strong>  nagios path /usr/local/nagios  found</strong>
<strong>Please enter the path to NagVis base [/usr/local/nagvis]:</strong>
</pre></div></li><li class="listitem">The script will attempt to find all of the prerequisites needed and will alert you if any are not found. If this is the case, you should abort the installation with <em>Ctrl</em> + <em>C</em> and install them before trying again.<div><pre class="programlisting">
<strong>-- Checking prerequisites --</strong>
<strong>PHP 5.3                                  found</strong>
<strong>  PHP Module: gd 5.3                     found</strong>
<strong>  PHP Module: mbstring compiled_in       found</strong>
<strong>  PHP Module: gettext compiled_in        found</strong>
<strong>  PHP Module: session compiled_in        found</strong>
<strong>  PHP Module: xml compiled_in            found</strong>
<strong>  PHP Module: pdo compiled_in            found</strong>
<strong>  Apache mod_php                         found</strong>
<strong>Graphviz 2.26                            found</strong>
<strong>  Graphviz Module dot 2.26.3             found</strong>
<strong>  Graphviz Module neato 2.26.3           found</strong>
<strong>  Graphviz Module twopi 2.26.3           found</strong>
<strong>  Graphviz Module circo 2.26.3           found</strong>
<strong>  Graphviz Module fdp 2.26.3             found</strong>
<strong>SQLite 3.7                               found</strong>
</pre></div></li><li class="listitem">The script will prompt you for an appropriate backend to configure as NagVis' data source. In this example, the only one we want is the <code class="literal">ndo2db</code> backend. Press <em>n</em> for all the others.<div><pre class="programlisting">
<strong>-- Checking Backends. (Available: mklivestatus,ndo2db,ido2db,merlinmy) --</strong>
<strong>Do you want to use backend mklivestatus? [y]: n</strong>
<strong>Do you want to use backend ndo2db? [n]: y</strong>
<strong>Do you want to use backend ido2db? [n]: n</strong>
<strong>Do you want to use backend merlinmy? [n]: n</strong>
<strong>  /usr/local/nagios/bin/ndo2db (ndo2db)  found</strong>
</pre></div></li><li class="listitem">The script will attempt to detect your <a id="id751" class="indexterm"/><a id="id752" class="indexterm"/>Apache HTTPD settings. It does a good job with most systems, but you should check the results are correct before you press <em>Enter</em>. It should also be safe to allow it to create an Apache configuration file for you.<div><pre class="programlisting">
<strong>-- Trying to detect Apache settings --</strong>
<strong>Please enter the web path to NagVis [/nagvis]:</strong>
<strong>Please enter the name of the web-server user [www-data]:</strong>
<strong>Please enter the name of the web-server group [www-data]:</strong>
<strong>create Apache config file [y]:</strong>
</pre></div></li><li class="listitem">The script will give you a summary of its intentions for installing the software, and will ask you to confirm. Do so by pressing <em>Enter</em>:<div><pre class="programlisting">
<strong>-- Summary --</strong>
<strong>NagVis home will be:           /usr/local/nagvis</strong>
<strong>Owner of NagVis files will be: www-data</strong>
<strong>Group of NagVis files will be: www-data</strong>
<strong>Path to Apache config dir is:  /etc/apache2/conf.d</strong>
<strong>Apache config will be created: yes</strong>
<strong>Installation mode:             install</strong>
<strong>Do you really want to continue? [y]:</strong>
</pre></div></li><li class="listitem">Restart the Apache HTTPD server:<div><pre class="programlisting">
<strong># apache2ctl configtest</strong>
<strong># apache2ctl restart</strong>
</pre></div></li></ol></div><p>If all of the above goes correctly, once the installation is finished, you should be able to visit the NagVis configuration page on <a class="ulink" href="http://olympus.naginet/nagvis/">http://olympus.naginet/nagvis/</a>, substituting the hostname for <a id="id753" class="indexterm"/>
<a id="id754" class="indexterm"/>your own Nagios Core server:</p><div><img src="img/5566_11_16.jpg" alt="How to do it..."/></div><p>You can log in with the default username <code class="literal">admin</code> and the password <code class="literal">admin</code> to take a look at some of the demo maps.</p><p>There is a little more to go yet before we can get our automap working:</p><div><ol class="orderedlist arabic"><li class="listitem">On the server, edit the <code class="literal">/usr/local/nagvis/etc/nagvis.ini.php</code> file:<div><pre class="programlisting">
<strong># vi /usr/local/nagvis/etc/nagvis.ini.php</strong>
</pre></div></li><li class="listitem">Find and change the following directives under the <code class="literal">backend_ndomy_1</code> section, adding the values you used for your <code class="literal">ndo2db</code> installation:<div><pre class="programlisting">; hostname for NDO-db
dbhost="localhost"
; portname for NDO-db
dbport=3306
; database name for NDO-db
dbname="nagios"
; username for NDO-db
dbuser="ndo"
; password for NDO-db
dbpass="mPYxbAYqa"
; prefix for tables in NDO-db
dbprefix="nagios_"
; instance name for tables in NDO-db
dbinstancename="default"</pre></div><p>Make sure that all the preceding values are uncommented (they should not be preceded by a semicolon).</p></li><li class="listitem">Log in to the NagVis web interface, <a id="id755" class="indexterm"/><a id="id756" class="indexterm"/>and click on <strong>Manage Maps</strong> under the <strong>Options</strong> menu:<div><img src="img/5566_11_17.jpg" alt="How to do it..."/></div></li><li class="listitem">Under <strong>Create Map</strong>:<div><ol class="orderedlist arabic"><li class="listitem">For <strong>Map name</strong>, enter the value <code class="literal">Automap</code>.</li><li class="listitem">For <strong>Map iconset</strong>, choose <strong>std_small</strong>.</li><li class="listitem">Leave <strong>Background</strong> blank.</li><li class="listitem">Click on <strong>Create</strong>.</li></ol></div><div><img src="img/5566_11_18.jpg" alt="How to do it..."/></div><p>The page should refresh to a blank screen, <a id="id757" class="indexterm"/>
<a id="id758" class="indexterm"/>because we have not yet elected a data source for the map.</p></li><li class="listitem">Click on <strong>Map Options</strong> under the <strong>Edit Map</strong> menu.<div><img src="img/5566_11_19.jpg" alt="How to do it..."/></div></li><li class="listitem">In the resulting dialog:<div><ol class="orderedlist arabic"><li class="listitem">Check the <strong>sources</strong> checkbox, and change the value to <code class="literal">automap</code>.</li><li class="listitem">Check the <strong>backend_id</strong> checkbox, and choose the value <strong>ndomy_1</strong>.</li><li class="listitem">Scroll down to the bottom and click on <strong>Save</strong>.</li></ol></div><div><img src="img/5566_11_20.jpg" alt="How to do it..."/></div></li></ol></div><p>With this done, the page should refresh and show you a map of your network, automatically generated from your configuration, in a similar style to the Nagios Core web interface status map. You should also be able to hover <a id="id759" class="indexterm"/>
<a id="id760" class="indexterm"/>over individual nodes to see their details.</p><div><img src="img/5566_11_21.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec406"/>How it works...</h2></div></div></div><p>NagVis' automap is generated from the data in the database that we established in the NDOUtils recipe. It generates the map in much the same way that the default status map does, but is more scalable for larger networks. The parent and <a id="id761" class="indexterm"/>
<a id="id762" class="indexterm"/>child relationships defined in the configuration are included, to make a tree-style map.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec407"/>There's more...</h2></div></div></div><p>The use of NagVis could fill an entire book in itself, and the automap is only one of many possible maps, including defining one's own backgrounds, icons, labels, and hover behavior. For more detail on how to make customized maps as well as other styles of automaps, consult the NagVis documentation at <a class="ulink" href="http://www.nagvis.org/doc">http://www.nagvis.org/doc</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch11lvl2sec408"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Reading status into a MySQL database with NDOUtils</em> and <em>Writing customized Nagios Core reports</em> recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Creating a network host hierarchy</em> and <em>Using the network map</em> recipes in <a class="link" href="ch08.html" title="Chapter 8. Managing Network Layout">Chapter 8</a>, <em>Understanding the Network Layout</em></li></ul></div></div></div></body></html>