<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;5.&#xA0;Using SELinux" id="1BRPS1-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Using SELinux</h1></div></div></div><p class="calibre7">Here is an overview of the recipes presented in this chapter:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Changing file contexts</li><li class="listitem">Configuring SELinux booleans</li><li class="listitem">Configuring SELinux port definitions</li><li class="listitem">Troubleshooting SELinux</li><li class="listitem">Creating SELinux policies</li><li class="listitem">Applying SELinux policies</li></ul></div></div>

<div class="book" title="Chapter&#xA0;5.&#xA0;Using SELinux" id="1BRPS1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec40" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">SELinux<a id="id248" class="calibre1"/> is <a id="id249" class="calibre1"/>a Linux kernel module that allows supporting <span class="strong"><strong class="calibre8">mandatory access control</strong></span> (MAC) security policies. The <a id="id250" class="calibre1"/>Red Hat implementation of SELinux <a id="id251" class="calibre1"/>combines <span class="strong"><strong class="calibre8">role-based access control</strong></span> (<span class="strong"><strong class="calibre8">RBAC</strong></span>) with <span class="strong"><strong class="calibre8">type enforcement</strong></span> (<span class="strong"><strong class="calibre8">TE</strong></span>). Optionally, <span class="strong"><strong class="calibre8">multilevel security</strong></span> (<span class="strong"><strong class="calibre8">MLS</strong></span>) is also available but isn't widely<a id="id252" class="calibre1"/> used as it implements fewer policies than the default Red Hat SELinux policies.</p><p class="calibre7">SELinux is enabled by default in RHEL 7 and supported for all software packaged by Red Hat.</p><p class="calibre7">The recipes presented in this chapter will not only provide you with a solid base to troubleshoot SELinux issues and fix them, but also a peek into how to create your own SELinux policies.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Changing file contexts"><div class="book" id="1CQAE2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec41" class="calibre1"/>Changing file contexts</h1></div></div></div><p class="calibre7">Files and processes are labeled with a SELinux context, which contains additional information about a SELinux user, role type, and level. This information is provided by the SELinux kernel module to make access control decisions.</p><p class="calibre7">The SELinux user, a unique identity known by the SELinux policy, is authorized for a number <a id="id253" class="calibre1"/>of roles.</p><p class="calibre7">SELinux roles, as we already alluded to before, are attributes of SELinux users and part of the RBAC SELinux policy. SELinux roles are authorized for SELinux domains.</p><p class="calibre7">SELinux types define the type for files and domain for processes. SELinux policies define access between types and other files and processes. By default, if there is no specific rule in the SELinux policy, access is denied.</p><p class="calibre7">The SELinux level is only used when the SELinux type is set to MLS and should be avoided altogether on anything other than servers. This set of policies doesn't cover the same domains as defined by the default Red Hat SELinux policy. The SELinux level is an attribute of MLS and <span class="strong"><strong class="calibre8">multi-category security</strong></span> (<span class="strong"><strong class="calibre8">MCS</strong></span>).</p></div>

<div class="book" title="Changing file contexts">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec103" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">All files and processes on a system are labeled to represent security-relevant information. This information is called the SELinux context. To view the contexts of files (and directories), execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# ls -Z</strong></span>
<span class="strong"><strong class="calibre8">-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 file</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div></div>

<div class="book" title="Changing file contexts">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec104" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">You can temporarily change the context of a file (or files) or permanently change their context. The first option allows easy troubleshooting if you need to figure out whether changing the context solves your problem. Persistent changes are mostly used when your applications refer to data that is not in the standard location—for example, if your web server serves data from <code class="email">/srv/www</code>.</p><div class="book" title="Temporary context changes"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec37" class="calibre1"/>Temporary context changes</h3></div></div></div><p class="calibre7">Temporary SELinux<a id="id254" class="calibre1"/> context changes remain until the file, or the filesystem that the file resides on, is relabeled.</p><p class="calibre7">To change the SELinux user of a file, execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# chcon --user &lt;SELinux user&gt; &lt;filename&gt;</strong></span>
</pre></div><p class="calibre7">To change the SELinux role of a file, execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# chcon --role &lt;SELinux role&gt; &lt;filename&gt;</strong></span>
</pre></div><p class="calibre7">To change the <a id="id255" class="calibre1"/>SELinux type of a file, execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# chcon --type &lt;SELinux typs&gt; &lt;filename&gt;</strong></span>
</pre></div></div><div class="book" title="Persistent file context changes"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec38" class="calibre1"/>Persistent file context changes</h3></div></div></div><p class="calibre7">Changing the application data location doesn't automatically modify SELinux contexts to allow your application to access this data.</p><p class="calibre7">To permanently<a id="id256" class="calibre1"/> relabel files or directories, perform the following:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Change the SELinux user for your files or directories via this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage fcontext -a --seuser &lt;SELinux user&gt; &lt;filename|dirname&gt;</strong></span>
</pre></div></li><li class="listitem" value="2">Change the SELinux type of your files or directories by running the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage fcontext -a --type &lt;SELinux type&gt; &lt;filename|dirname&gt;</strong></span>
</pre></div></li><li class="listitem" value="3">Finish with this command line by applying the directive to the <code class="email">files/directories</code>:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# restorecon &lt;filename|dirname&gt;</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div></div>

<div class="book" title="Changing file contexts">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec105" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">To show<a id="id257" class="calibre1"/> all the available SELinux users, execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage user -l</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00041.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Alternatively, you <a id="id258" class="calibre1"/>can install the <code class="email">setools-console</code> package and run the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# seinfo -u</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00042.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">To show all the<a id="id259" class="calibre1"/> available SELinux types, install the <code class="email">setools-console</code> package and run the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# seinfo -t</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00043.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">To show the<a id="id260" class="calibre1"/> available SELinux roles, install the <code class="email">setools-console</code> package and run the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# seinfo -r</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00044.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">The <code class="email">semanage</code> tool doesn't have an option to include all files recursively, but there is a solution to<a id="id261" class="calibre1"/> this. The filename or dirname you specify is actually a regular expression filter. So, for example, if you want to recursively include all the files in <code class="email">/srv/www</code>, you could specify <code class="email">"/srv/www(/.*)?"</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip07" class="calibre1"/>Tip</h3><p class="calibre7">For now, there's no way to change the SELinux role using <code class="email">semanage</code>. A way to get around this is to change the SELinux user or type using <code class="email">semanage</code> and then edit it, as follows: <code class="email">/etc/selinux/targeted/contexts/files/file_contexts.local</code>.</p></div><p class="calibre7">Here's a wrong SELinux context example of an AVC denial report found in the <code class="email">audit.log</code> file:</p><div class="informalexample"><pre class="programlisting">type=AVC msg=audit(1438884962.645:86): avc:  denied  { open } for  pid=1283 comm="httpd" path="/var/www/html/index.html" dev="dm-5" ino=1089 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:user_home_t:s0 tclass=file</pre></div><p class="calibre7">This command<a id="id262" class="calibre1"/> can be explained as follows:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Commands</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">type=AVC</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the log type</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">msg=audit(1438884962.645:86)</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the log entry timestamp</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">avc</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is a repetition of the log type</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">denied</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This states whether enforcing is enabled</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">{ open }</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is a permission that causes AVC denial</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">for  pid=1283</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is<a id="id263" class="indexterm"/> the process ID</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">comm="httpd"</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the process command</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">path="/var/www/html/index.html"</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the path that is accessed</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">dev="dm-5"</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This blocks the device that the preceding file is located on</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">ino=1089</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the inode of the preceding file</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">scontext=system_u:system_r:httpd_t:s0</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the source SELinux context</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">tcontext=system_u:object_r:user_home_t:s0</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the target SELinux context</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">tclass=file</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the target SELinux class</p>
</td></tr></tbody></table></div></div></div>

<div class="book" title="Changing file contexts">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec106" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Refer to the man page for <span class="strong"><em class="calibre9">chcon (1)</em></span> and <span class="strong"><em class="calibre9">semanage-fcontext (8)</em></span> for more information.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring SELinux booleans" id="1DOR01-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec42" class="calibre1"/>Configuring SELinux booleans</h1></div></div></div><p class="calibre7">SELinux booleans<a id="id264" class="calibre1"/> allow you to change the SELinux policy at runtime without the need to write additional policies. This allows you to change the policy without the <a id="id265" class="calibre1"/>need for recompilation, such as allowing services to access NFS volumes.</p></div>

<div class="book" title="Configuring SELinux booleans" id="1DOR01-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec107" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">This is the way to temporarily or permanently change SELinux booleans.</p><div class="book" title="Listing SELinux booleans"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec39" class="calibre1"/>Listing SELinux booleans</h3></div></div></div><p class="calibre7">For a list <a id="id266" class="calibre1"/>of all booleans and an explanation of what they do, execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage boolean -l</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00045.jpeg" alt="Listing SELinux booleans" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Now, let's try to get the value of a particular SELinux boolean. It is possible to get the value of a single SELinux boolean without the use of additional utilities, such as <span class="strong"><strong class="calibre8">grep</strong></span> and/or <span class="strong"><strong class="calibre8">awk</strong></span>. Simply execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# getsebool &lt;SELinux boolean&gt;</strong></span>
</pre></div><p class="calibre7">This shows you whether or not the boolean is set. Here's an example:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# getsebool virt_use_nfs</strong></span>
<span class="strong"><strong class="calibre8">virt_use_nfs --&gt; off</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div><div class="book" title="Changing SELinux booleans"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec40" class="calibre1"/>Changing SELinux booleans</h3></div></div></div><p class="calibre7">To set<a id="id267" class="calibre1"/> a boolean value to a particular one, use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# setsebool &lt;SELinux boolean&gt; &lt;on|off&gt;</strong></span>
</pre></div><p class="calibre7">Here's an example command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# setsebool virt_use_nfs on</strong></span>
</pre></div><p class="calibre7">This <a id="id268" class="calibre1"/>command allows you to change the value of the boolean, but it is not persistent across reboots. To allow persistence, add the <code class="email">-P</code> option to the command line, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# setsebool -P virt_use_nfs on</strong></span>
</pre></div></div></div></div>

<div class="book" title="Configuring SELinux booleans" id="1DOR01-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec108" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">If you would like a <a id="id269" class="calibre1"/>list of all the bare bones of SELinux booleans and their values, <code class="email">getsebool -a</code> is an alternative, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# getsebool -a</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00046.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Managing SELinux booleans can be rather complex as there are a lot of booleans, and their names are not always simple to remember. For this reason, the <code class="email">setsebool</code>, <code class="email">getsebool</code>, and <code class="email">semanage</code> tools come with tab completion. So, whenever you type any boolean name, you can use the <code class="email">tab</code> key to complete or display the possible options.</p><p class="calibre7">Here's an example of an AVC denial report found in the <code class="email">audit.log</code> file that can be solved by enabling a boolean:</p><div class="informalexample"><pre class="programlisting">type=AVC msg=audit(1438884483.053:48): avc:  denied  { open } for  pid=1270 comm="httpd" path="/nfs/www/html/index.html" dev="0:38" ino=2717909250 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:nfs_t:s0 tclass=file</pre></div><p class="calibre7">This is an <a id="id270" class="calibre1"/>example of a service (<code class="email">httpd</code> in this case) accessing a file located on an NFS share, which is disabled by default.</p><p class="calibre7">This can be allowed by setting the <code class="email">httpd_use_nfs</code> boolean to "<code class="email">on</code>".</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring SELinux port definitions" id="1ENBI1-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec43" class="calibre1"/>Configuring SELinux port definitions</h1></div></div></div><p class="calibre7">SELinux also controls access to your TCP/IP ports. If your application is confined by SELinux, it will also deny access to your ports when starting up the application.</p><p class="calibre7">This recipe will <a id="id271" class="calibre1"/>show you how to detect which ports <a id="id272" class="calibre1"/>are used by a particular SELinux type and change it.</p></div>

<div class="book" title="Configuring SELinux port definitions" id="1ENBI1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec109" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Let's allow the HTTP daemon to listen on the nonstandard port <code class="email">82</code> through the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, look for the ports that are accessed by HTTP via these commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage port -l |grep http</strong></span>
<span class="strong"><strong class="calibre8">http_cache_port_t              tcp      8080, 8118, 8123, 10001-10010</strong></span>
<span class="strong"><strong class="calibre8">http_cache_port_t              udp      3130</strong></span>
<span class="strong"><strong class="calibre8">http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000</strong></span>
<span class="strong"><strong class="calibre8">pegasus_http_port_t            tcp      5988</strong></span>
<span class="strong"><strong class="calibre8">pegasus_https_port_t           tcp      5989</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><p class="calibre13">The SELinux port assignment we're looking for is <code class="email">http_port_t</code>. As you can see, only the displayed ports (<code class="email">80</code>, <code class="email">81</code>, <code class="email">443</code>, <code class="email">488</code>, <code class="email">8008</code>, <code class="email">8009</code>, <code class="email">8443</code>, and <code class="email">9000</code>) are allowed to be used to listen on by any process that is allowed to use the <code class="email">http_port_t</code> type.</p></li><li class="listitem" value="2">Add port <code class="email">82</code> to the list of allowed ports, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage port -a -t http_port_t -p tcp 82</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li><li class="listitem" value="3">Next, verify the port assignment, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage port -l |grep ^http_port_t</strong></span>
<span class="strong"><strong class="calibre8">http_port_t                    tcp      82, 80, 81, 443, 488, 8008, 8009, 8443, 9000</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Configuring SELinux port definitions" id="1ENBI1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec110" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">In this <a id="id273" class="calibre1"/>example, there is reference to the HTTP daemon <a id="id274" class="calibre1"/>as the SELinux policy governing HTTP daemons is implemented not only for the Apache web server, but also for Nginx. So, as long as you use the packages provided by Red Hat, the SELinux policies will be used correctly.</p><p class="calibre7">Take a look at the following example of an AVC denial report found in the <code class="email">audit.log</code> file that is caused because the domain is not allowed to access a certain port:</p><div class="informalexample"><pre class="programlisting">type=AVC msg=audit(1225948455.061:294): avc: denied { name_bind } for pid=4997 comm="httpd" src=82 scontext=unconfined_u:system_r:httpd_t:s0 tcontext=system_u:object_r:port_t:s0 tclass=tcp_socket</pre></div><p class="calibre7">This AVC denial shows that the <code class="email">httpd</code> daemon attempted to listen (<code class="email">name_bind</code>) on port <code class="email">82</code> but was prohibited by SELinux.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Troubleshooting SELinux"><div class="book" id="1FLS42-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec44" class="calibre1"/>Troubleshooting SELinux</h1></div></div></div><p class="calibre7">Troubleshooting SELinux is not as straightforward as it may seem as at the time of writing this book, there is <a id="id275" class="calibre1"/>no integration with SELinux to return SELinux-related events back to the applications. Usually, you will find that access is denied with no further description of it in log files.</p></div>

<div class="book" title="Troubleshooting SELinux">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec111" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Make sure that <code class="email">setroubleshoot-server</code> and <code class="email">setools-console</code> are installed by executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# yum install -y setroubleshoot-server setools-console</strong></span>
</pre></div><p class="calibre7">If you have X server installed on your system, you can also install the GUI, as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# yum install -y setroubleshoot</strong></span>
</pre></div><p class="calibre7">Make sure that <code class="email">auditd</code>, <code class="email">rsyslog</code>, and <code class="email">setroubleshootd</code> are installed and running before reproducing the issue.</p></div></div>

<div class="book" title="Troubleshooting SELinux">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec112" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">There are several ways to detect SELinux issues.</p><p class="calibre7">This is a classic issue where the SELinux context of a file is incorrect, causing the application trying to access the file to fail.</p><p class="calibre7">In this case, the context of <code class="email">/var/www/html/index.html</code> is set to <code class="email">system_u:object_r:user_home_t:s0</code> instead of <code class="email">system_u:object_r:httpd_sys_content_t:s0</code>, causing <code class="email">httpd</code> to throw a <code class="email">404</code>. Take a look at the<a id="id276" class="calibre1"/> following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8"># ls -Z /var/www/html/index.html</strong></span>
<span class="strong"><strong class="calibre8">-rw-r--r--. apache apache system_u:object_r:user_home_t:s0 /var/www/html/index.html</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><div class="book" title="audit.log"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec41" class="calibre1"/>audit.log</h3></div></div></div><p class="calibre7">Use the<a id="id277" class="calibre1"/> following command to look for denied or failed<a id="id278" class="calibre1"/> entries in the audit log:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# egrep 'avc.*denied' /var/log/audit/audit.log</strong></span>
<span class="strong"><strong class="calibre8">ype=AVC msg=audit(1438884962.645:86): avc:  denied  { open } for  pid=1283 comm="httpd" path="/var/www/html/index.html" dev="dm-5" ino=1089 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:user_home_t:s0 tclass=file</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div><div class="book" title="syslog"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec42" class="calibre1"/>syslog</h3></div></div></div><p class="calibre7">You can look<a id="id279" class="calibre1"/> for SELinux messages <a id="id280" class="calibre1"/>in <code class="email">/var/log/messages</code> via the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# grep 'SELinux is preventing' /var/log/messages</strong></span>
<span class="strong"><strong class="calibre8">Aug  6 20:16:03 localhost setroubleshoot: SELinux is preventing /usr/sbin/httpd from read access on the file index.html. For complete SELinux messages., run sealert -l dc544bde-2d7e-4f3f-8826-224d9b0c71f6</strong></span>
<span class="strong"><strong class="calibre8">Aug 6 20:16:03 localhost python: SELinux is preventing /usr/sbin/httpd from read access on the file index.html.</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div><div class="book" title="ausearch"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch05lvl3sec43" class="calibre1"/>ausearch</h3></div></div></div><p class="calibre7">Use the <a id="id281" class="calibre1"/>audit search tool to find SELinux errors, as<a id="id282" class="calibre1"/> follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# ausearch -m avc</strong></span>
<span class="strong"><strong class="calibre8">time-&gt;Thu Aug  6 20:16:02 2015</strong></span>
<span class="strong"><strong class="calibre8">type=SYSCALL msg=audit(1438884962.645:86): arch=c000003e syscall=2 success=yes exit=25 a0=7f1bcfb65670 a1=80000 a2=0 a3=0 items=0 ppid=1186 pid=1283 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm="httpd" exe="/usr/sbin/httpd" subj=system_u:system_r:httpd_t:s0 key=(null)</strong></span>
<span class="strong"><strong class="calibre8">type=AVC msg=audit(1438884962.645:86): avc:  denied  { open } for  pid=1283 comm="httpd" path="/var/www/html/index.html" dev="dm-5" ino=1089 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:user_home_t:s0 tclass=file</strong></span>
<span class="strong"><strong class="calibre8">type=AVC msg=audit(1438884962.645:86): avc:  denied  { read } for  pid=1283 comm="httpd" name="index.html" dev="dm-5" ino=1089 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:user_home_t:s0 tclass=file</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><p class="calibre7">Once we <a id="id283" class="calibre1"/>restore the context of <code class="email">/var/www/html/index.html</code> to its<a id="id284" class="calibre1"/> original, the file is accessible again. Take a look at the following commands:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# restorecon /var/www/html/index.html</strong></span>
<span class="strong"><strong class="calibre8">~# ls -Z /var/www/html/index.html</strong></span>
<span class="strong"><strong class="calibre8">-rw-r--r--. apache apache system_u:object_r:httpd_sys_content_t:s0 /var/www/html/index.html</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div></div></div>

<div class="book" title="Troubleshooting SELinux">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec113" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">It's not always easy to determine whether a file has the correct context. To view the actual SELinux context<a id="id285" class="calibre1"/> and compare it to what it should be without modifying anything, execute this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# matchpathcon -V index.html</strong></span>
<span class="strong"><strong class="calibre8">index.html has context system_u:object_r:user_home_t:s0, should be system_u:object_r:httpd_sys_content_t:s0</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><p class="calibre7">This tells you what the current context is and what it should be.</p><p class="calibre7">As you can see in the preceding syslog example, the output comes with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">... run sealert -l dc544bde-2d7e-4f3f-8826-224d9b0c71f6</strong></span>
</pre></div><p class="calibre7">This command provides you with a richer description of the problem:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# sealert -l dc544bde-2d7e-4f3f-8826-224d9b0c71f6</strong></span>
<span class="strong"><strong class="calibre8">SELinux is preventing /usr/sbin/httpd from read access on the file index.html.</strong></span>

<span class="strong"><strong class="calibre8">*****  Plugin catchall_boolean (89.3 confidence) suggests   ******************</strong></span>

<span class="strong"><strong class="calibre8">If you want to allow httpd to read user content</strong></span>
<span class="strong"><strong class="calibre8">Then you must tell SELinux about this by enabling the 'httpd_read_user_content' boolean.</strong></span>
<span class="strong"><strong class="calibre8">You can read 'None' man page for more details.</strong></span>
<span class="strong"><strong class="calibre8">Do</strong></span>
<span class="strong"><strong class="calibre8">setsebool -P httpd_read_user_content 1</strong></span>

<span class="strong"><strong class="calibre8">*****  Plugin catchall (11.6 confidence) suggests   **************************</strong></span>

<span class="strong"><strong class="calibre8">If you believe that httpd should be allowed read access on the index.html file by default.</strong></span>
<span class="strong"><strong class="calibre8">Then you should report this as a bug.</strong></span>
<span class="strong"><strong class="calibre8">You can generate a local policy module to allow this access.</strong></span>
<span class="strong"><strong class="calibre8">Do</strong></span>
<span class="strong"><strong class="calibre8">allow this access for now by executing:</strong></span>
<span class="strong"><strong class="calibre8"># grep httpd /var/log/audit/audit.log | audit2allow -M mypol</strong></span>
<span class="strong"><strong class="calibre8"># semodule -i mypol.pp</strong></span>


<span class="strong"><strong class="calibre8">Additional Information:</strong></span>
<span class="strong"><strong class="calibre8">Source Context                system_u:system_r:httpd_t:s0</strong></span>
<span class="strong"><strong class="calibre8">Target Context                system_u:object_r:user_home_t:s0</strong></span>
<span class="strong"><strong class="calibre8">Target Objects                index.html [ file ]</strong></span>
<span class="strong"><strong class="calibre8">Source                        httpd</strong></span>
<span class="strong"><strong class="calibre8">Source Path                   /usr/sbin/httpd</strong></span>
<span class="strong"><strong class="calibre8">Port                          &lt;Unknown&gt;</strong></span>
<span class="strong"><strong class="calibre8">Host                          localhost.localdomain</strong></span>
<span class="strong"><strong class="calibre8">Source RPM Packages           httpd-2.4.6-31.el7.rhel.x86_64</strong></span>
<span class="strong"><strong class="calibre8">Target RPM Packages           </strong></span>
<span class="strong"><strong class="calibre8">Policy RPM                    selinux-policy-3.13.1-23.el7_1.7.noarch</strong></span>
<span class="strong"><strong class="calibre8">Selinux Enabled               True</strong></span>
<span class="strong"><strong class="calibre8">Policy Type                   targeted</strong></span>
<span class="strong"><strong class="calibre8">Enforcing Mode                Permissive</strong></span>
<span class="strong"><strong class="calibre8">Host Name                     localhost.localdomain</strong></span>
<span class="strong"><strong class="calibre8">Platform                      Linux localhost.localdomain</strong></span>
<span class="strong"><strong class="calibre8">                              3.10.0-229.4.2.el7.x86_64 #1 SMP Wed May 13</strong></span>
<span class="strong"><strong class="calibre8">                              10:06:09 UTC 2015 x86_64 x86_64</strong></span>
<span class="strong"><strong class="calibre8">Alert Count                   1</strong></span>
<span class="strong"><strong class="calibre8">First Seen                    2015-08-06 20:16:02 CEST</strong></span>
<span class="strong"><strong class="calibre8">Last Seen                     2015-08-06 20:16:02 CEST</strong></span>
<span class="strong"><strong class="calibre8">Local ID                      dc544bde-2d7e-4f3f-8826-224d9b0c71f6</strong></span>

<span class="strong"><strong class="calibre8">Raw Audit Messages</strong></span>
<span class="strong"><strong class="calibre8">type=AVC msg=audit(1438884962.645:86): avc:  denied  { read } for  pid=1283 comm="httpd" name="index.html" dev="dm-5" ino=1089 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:user_home_t:s0 tclass=file</strong></span>


<span class="strong"><strong class="calibre8">type=AVC msg=audit(1438884962.645:86): avc:  denied  { open } for  pid=1283 comm="httpd" path="/var/www/html/index.html" dev="dm-5" ino=1089 scontext=system_u:system_r:httpd_t:s0 tcontext=system_u:object_r:user_home_t:s0 tclass=file</strong></span>


<span class="strong"><strong class="calibre8">type=SYSCALL msg=audit(1438884962.645:86): arch=x86_64 syscall=open success=yes exit=ENOTTY a0=7f1bcfb65670 a1=80000 a2=0 a3=0 items=0 ppid=1186 pid=1283 auid=4294967295 uid=48 gid=48 euid=48 suid=48 fsuid=48 egid=48 sgid=48 fsgid=48 tty=(none) ses=4294967295 comm=httpd exe=/usr/sbin/httpd subj=system_u:system_r:httpd_t:s0 key=(null)</strong></span>

<span class="strong"><strong class="calibre8">Hash: httpd,httpd_t,user_home_t,file,read</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><p class="calibre7">This will <a id="id286" class="calibre1"/>actually give you more details about the problem at hand, and it will also make a couple of suggestions. Of course, in this case, the real solution is to restore the SELinux context of the file.</p><p class="calibre7">If you have installed a graphical desktop environment, you will get a notification each time your system encounters an "AVC denied" alert:</p><div class="mediaobject"><img src="../images/00047.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Clicking on the icon will present you with the following dialog:</p><div class="mediaobject"><img src="../images/00048.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Clicking on<a id="id287" class="calibre1"/> the <span class="strong"><strong class="calibre8">Troubleshoot</strong></span> button will provide you with additional information and a (or multiple) possible solution(s) for your problem, as shown in the following screenshot:</p><div class="mediaobject"><img src="../images/00049.jpeg" alt="There's more…" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">In this case, the first option (the one marked with a green line) is the correct solution.</p><p class="calibre7">Some AVC denial messages may not be logged when SELinux denies access. Applications and libraries regularly probe for more access than is actually required to perform their tasks. In order to not flood the audit logs with these kinds of messages, the policy can silence the AVC denials that are without permissions using <code class="email">dontaudit</code> rules. The <a id="id288" class="calibre1"/>downside of this is that it may make troubleshooting SELinux denials more difficult.</p><p class="calibre7">To disable the <code class="email">dontaudit</code> rules, execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage dontaudit off</strong></span>
</pre></div><p class="calibre7">This will disable the <code class="email">dontaudit</code> rules and rebuild the SELinux policy.</p><p class="calibre7">It is advisable to reenable the <code class="email">dontaudit</code> rules when you're done troubleshooting as this may flood your disks. You can do this by executing the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semanage dontaudit on</strong></span>
</pre></div><p class="calibre7">To get a full list of <code class="email">dontaudit</code> rules, run the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# sesearch --dontaudit</strong></span>
<span class="strong"><strong class="calibre8">Found 8361 semantic av rules:</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit user_ssh_agent_t user_ssh_agent_t : udp_socket listen ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit openshift_user_domain sshd_t : key view ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit user_seunshare_t user_seunshare_t : process setfscreate ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit ftpd_t selinux_config_t : dir { getattr search open } ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit user_seunshare_t user_seunshare_t : capability sys_module ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit xguest_dbusd_t xguest_dbusd_t : udp_socket listen ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit tuned_t tuned_t : process setfscreate ;</strong></span>
<span class="strong"><strong class="calibre8">...</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><p class="calibre7">If you know the domain that you wish to check for <code class="email">dontaudit</code> rules, add the <code class="email">-s</code> argument followed by the domain, as shown here:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# sesearch --dontaudit -s httpd_t</strong></span>
<span class="strong"><strong class="calibre8">Found 182 semantic av rules:</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit httpd_t snmpd_var_lib_t : file { ioctl read write getattr lock open } ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit domain rpm_var_lib_t : file { ioctl read write getattr lock append } ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit httpd_t snmpd_var_lib_t : dir { ioctl read getattr lock search open } ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit domain rpm_var_lib_t : dir getattr ;</strong></span>
<span class="strong"><strong class="calibre8">   dontaudit httpd_t snmpd_var_lib_t : lnk_file { read getattr } ;</strong></span>
<span class="strong"><strong class="calibre8">...</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div></div>

<div class="book" title="Troubleshooting SELinux">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec114" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Take a<a id="id289" class="calibre1"/> look at the man page for <span class="strong"><em class="calibre9">ausearch (8)</em></span>, <span class="strong"><em class="calibre9">matchpathcon (8)</em></span>, and <span class="strong"><em class="calibre9">sealert (8)</em></span> for more information.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating SELinux policies" id="1GKCM1-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec45" class="calibre1"/>Creating SELinux policies</h1></div></div></div><p class="calibre7">In some cases, you'll need to create a new SELinux policy—for instance, when installing a piece of software from source. Although I do not recommend installing software from source on<a id="id290" class="calibre1"/> enterprise systems, this is sometimes your only option for company-developed software.</p><p class="calibre7">It is then time to create your own SELinux policy.</p></div>

<div class="book" title="Creating SELinux policies" id="1GKCM1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec115" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">For this recipe, you need to have <code class="email">policycoreutils-python</code> installed.</p></div></div>

<div class="book" title="Creating SELinux policies" id="1GKCM1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec116" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">We'll use the <code class="email">denied</code> entries in the <code class="email">audit.log</code> log file to build our SELinux policy with <code class="email">audit2allow</code>.</p><p class="calibre7">In this recipe, we'll use the same example as in the previous recipe: the SELinux context of <code class="email">/var/www/html/index.html</code> that is changed to <code class="email">system_u:object_r:user_home_t:s0</code>. Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, create a human readable policy for verification via the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# egrep 'avc.*denied' /var/log/audit/audit.log |audit2allow -m example_policy</strong></span>

<span class="strong"><strong class="calibre8">module example_policy 1.0;</strong></span>

<span class="strong"><strong class="calibre8">require {</strong></span>
<span class="strong"><strong class="calibre8">        type httpd_t;</strong></span>
<span class="strong"><strong class="calibre8">        type user_home_t;</strong></span>
<span class="strong"><strong class="calibre8">        class file { read open };</strong></span>
<span class="strong"><strong class="calibre8">}</strong></span>

<span class="strong"><strong class="calibre8">#============= httpd_t ==============</strong></span>

<span class="strong"><strong class="calibre8">#!!!! This avc can be allowed using the boolean 'httpd_read_user_content'</strong></span>
<span class="strong"><strong class="calibre8">allow httpd_t user_home_t:file { read open };</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li><li class="listitem" value="2">When this <a id="id291" class="calibre1"/>policy is validated, you can create a compiled SELinux policy file, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">egrep 'avc.*denied' /var/log/audit/audit.log |audit2allow -M example_policy</strong></span>
<span class="strong"><strong class="calibre8">******************** IMPORTANT ***********************</strong></span>
<span class="strong"><strong class="calibre8">To make this policy package active, execute:</strong></span>

<span class="strong"><strong class="calibre8">semodule -i example_policy.pp</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Creating SELinux policies" id="1GKCM1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec117" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">When you generate a module package, two files are created: a type enforcement file (<code class="email">.te</code>) and a policy package file (<code class="email">.pp</code>) file. The <code class="email">te</code> file is the human readable policy as generated using <code class="email">audit2allow -m</code>.</p><p class="calibre7">The <code class="email">pp</code> file is the SELinux policy module package, which will later be used to enable the new policy.</p></div></div>

<div class="book" title="Creating SELinux policies" id="1GKCM1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec118" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">If you believe you have discovered a bug in an existing SELinux policy, you'll need to produce a type enforcing and policy package file to report with Red Hat Bugzilla.</p><p class="calibre7">It's important to make sure that you only parse the correct <code class="email">AVC denial</code> entries with <code class="email">audit2allow</code> as it may result in more access than required. It's a good idea to pipe the <code class="email">AVC denial</code> entries to a temporary file and remove what is not needed before you parse the file with <code class="email">audit2allow</code>.</p><p class="calibre7">If the policy you generate in this way is not exactly what you need, you can always edit the generated <code class="email">te</code> policy file, and when you're done, compile a new policy file using the <code class="email">te</code> policy file. You can do this as follows:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Build a binary policy module out of the policy file through this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# checkmodule -M -m -o example_policy.mod example_policy.te</strong></span>
<span class="strong"><strong class="calibre8">checkmodule:  loading policy configuration from example_policy.te</strong></span>
<span class="strong"><strong class="calibre8">checkmodule:  policy configuration loaded</strong></span>
<span class="strong"><strong class="calibre8">checkmodule:  writing binary representation (version 17) to example_policy.mod</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li><li class="listitem" value="2">Create the SELinux policy module package by executing the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semodule_package -o example_policy.pp -m example_policy.mod</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Creating SELinux policies" id="1GKCM1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec119" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Take a look<a id="id292" class="calibre1"/> at the man page for <span class="strong"><em class="calibre9">audit2allow(1)</em></span> for more options on creating a policy</p><p class="calibre7">To<a id="id293" class="calibre1"/> report bugs, go to <a class="calibre1" href="https://bugzilla.redhat.com/">https://bugzilla.redhat.com/</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Applying SELinux policies" id="1HIT81-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec46" class="calibre1"/>Applying SELinux policies</h1></div></div></div><p class="calibre7">We've learned how to create SELinux policies in the previous recipe. This recipe will show you how<a id="id294" class="calibre1"/> to apply your newly created SELinux policies.</p></div>

<div class="book" title="Applying SELinux policies" id="1HIT81-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec120" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">In order to apply a policy, we need a policy package file (<code class="email">pp</code>). This can be obtained by parsing AVC denials to <code class="email">audit2allow</code> or compiling your own policy package file, as explained in the <span class="strong"><em class="calibre9">Create SELinux policies</em></span> recipe.</p></div></div>

<div class="book" title="Applying SELinux policies" id="1HIT81-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How to do it..."><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec121" class="calibre1"/>How to do it...</h2></div></div></div><p class="calibre7">Follow these steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Activate the policy (this can take quite a while, depending on the number of policies applied to your system) by running the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semodule -i example_policy.pp</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li><li class="listitem" value="2">Next, verify that the policy is actually activated via these commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semodule -l |grep example_policy</strong></span>
<span class="strong"><strong class="calibre8">example_policy  1.0</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Applying SELinux policies" id="1HIT81-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch05lvl2sec122" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">When executing the <code class="email">semodule</code> command, the policy file is copied to <code class="email">/etc/selinux/targeted/modules/active/modules/</code>, and the complete SELinux policy is <a id="id295" class="calibre1"/>recompiled and applied.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip08" class="calibre1"/>Tip</h3><p class="calibre7">Be careful when applying custom-made policies as these may allow more access than required!</p></div></div></div>

<div class="book" title="Applying SELinux policies" id="1HIT81-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch05lvl2sec123" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">To remove<a id="id296" class="calibre1"/> policies, execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semodule -r example_policy</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div><p class="calibre7">This is particularly practical when you want to test the effect with and without the policy.</p><p class="calibre7">There's also a way to upgrade the module without removing it first, which is as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~# semodule -u example_policy</strong></span>
<span class="strong"><strong class="calibre8">~#</strong></span>
</pre></div></div></div>

<div class="book" title="Applying SELinux policies" id="1HIT81-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch05lvl2sec124" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Refer to the man page for <span class="strong"><em class="calibre9">semodule (8)</em></span> for more information.</p></div></div></body></html>