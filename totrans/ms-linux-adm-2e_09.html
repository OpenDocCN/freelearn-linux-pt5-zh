<html><head></head><body>
<div id="_idContainer348">
<h1 class="chapter-number" id="_idParaDest-178"><a id="_idTextAnchor194"/><span class="koboSpan" id="kobo.1.1">9</span></h1>
<h1 id="_idParaDest-179"><a id="_idTextAnchor195"/><span class="koboSpan" id="kobo.2.1">Securing Linux</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.3.1">Securing</span></strong><span class="koboSpan" id="kobo.4.1"> a Linux machine is usually a balancing act. </span><span class="koboSpan" id="kobo.4.2">The endgame is essentially protecting data from unwanted access. </span><span class="koboSpan" id="kobo.4.3">While there are many ways to achieve this goal, we should adopt the methods that yield maximum protection, along with the most efficient system administration. </span><span class="koboSpan" id="kobo.4.4">Gauging the attack and vulnerability surfaces, both internal and external, is always a good start. </span><span class="koboSpan" id="kobo.4.5">The rest of the work is building fences and putting on armor—not too high and not too heavy. </span><span class="koboSpan" id="kobo.4.6">The outer fence is a </span><strong class="bold"><span class="koboSpan" id="kobo.5.1">network firewall</span></strong><span class="koboSpan" id="kobo.6.1">. </span><span class="koboSpan" id="kobo.6.2">Internally, at the system level, we build </span><strong class="bold"><span class="koboSpan" id="kobo.7.1">application security policies</span></strong><span class="koboSpan" id="kobo.8.1">. </span><span class="koboSpan" id="kobo.8.2">This chapter introduces both, albeit the art of the balancing act is left </span><span class="No-Break"><span class="koboSpan" id="kobo.9.1">to you.</span></span></p>
<p><span class="koboSpan" id="kobo.10.1">In the first part of this chapter, we’ll look at </span><strong class="bold"><span class="koboSpan" id="kobo.11.1">access control mechanisms</span></strong><span class="koboSpan" id="kobo.12.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.13.1">ACMs</span></strong><span class="koboSpan" id="kobo.14.1">) and the related security modules—</span><strong class="bold"><span class="koboSpan" id="kobo.15.1">Security-Enhanced Linux</span></strong><span class="koboSpan" id="kobo.16.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.17.1">SELinux</span></strong><span class="koboSpan" id="kobo.18.1">) and </span><strong class="bold"><span class="koboSpan" id="kobo.19.1">AppArmor</span></strong><span class="koboSpan" id="kobo.20.1">. </span><span class="koboSpan" id="kobo.20.2">In the second part, we will explore packet filtering frameworks and </span><span class="No-Break"><span class="koboSpan" id="kobo.21.1">firewall solutions.</span></span></p>
<p><span class="koboSpan" id="kobo.22.1">After completing this chapter, you will have become acquainted with the tools for designing and managing application security frameworks and firewalls—a first solid step to securing a </span><span class="No-Break"><span class="koboSpan" id="kobo.23.1">Linux system.</span></span></p>
<p><span class="koboSpan" id="kobo.24.1">Here’s a brief overview of the topics that will be covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.25.1">this chapter:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.26.1">Understanding Linux security—An overview of the ACMs available in the </span><span class="No-Break"><span class="koboSpan" id="kobo.27.1">Linux kernel</span></span></li>
<li><span class="koboSpan" id="kobo.28.1">Introducing SELinux—An in-depth look at the Linux kernel security framework for managing access </span><span class="No-Break"><span class="koboSpan" id="kobo.29.1">control policies</span></span></li>
<li><span class="koboSpan" id="kobo.30.1">Introducing AppArmor—A relatively new security module that controls application capabilities based on </span><span class="No-Break"><span class="koboSpan" id="kobo.31.1">security profiles</span></span></li>
<li><span class="koboSpan" id="kobo.32.1">Working with firewalls—A comprehensive overview of firewall modules, including </span><strong class="bold"><span class="koboSpan" id="kobo.33.1">Netfilter</span></strong><span class="koboSpan" id="kobo.34.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.35.1">iptables</span></strong><span class="koboSpan" id="kobo.36.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.37.1">nftables</span></strong><span class="koboSpan" id="kobo.38.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.39.1">firewalld</span></strong><span class="koboSpan" id="kobo.40.1">, and the </span><strong class="bold"><span class="koboSpan" id="kobo.41.1">Uncomplicated </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.42.1">Firewall</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.43.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.44.1">ufw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.45.1">)</span></span></li>
</ul>
<h1 id="_idParaDest-180"><a id="_idTextAnchor196"/><span class="koboSpan" id="kobo.46.1">Technical requirements</span></h1>
<p><span class="koboSpan" id="kobo.47.1">This chapter covers a relatively vast array of topics, some of which will be covered with extensive command-line operations. </span><span class="koboSpan" id="kobo.47.2">We recommend that you use both a Fedora and an Ubuntu platform with Terminal or SSH access. </span><span class="koboSpan" id="kobo.47.3">Direct console access to the systems is highly preferable due to the possibly disruptive way of altering </span><span class="No-Break"><span class="koboSpan" id="kobo.48.1">firewall rules.</span></span></p>
<h1 id="_idParaDest-181"><a id="_idTextAnchor197"/><span class="koboSpan" id="kobo.49.1">Understanding Linux security</span></h1>
<p><span class="koboSpan" id="kobo.50.1">One significant consideration for securing a computer system or network is the means for system administrators to control how users and processes can access various resources, such as files, devices, and interfaces, across systems. </span><span class="koboSpan" id="kobo.50.2">The Linux kernel provides a handful of such mechanisms, collectively referred to as ACMs. </span><span class="koboSpan" id="kobo.50.3">Let’s describe </span><span class="No-Break"><span class="koboSpan" id="kobo.51.1">them briefly:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.52.1">Discretionary access control</span></strong><span class="koboSpan" id="kobo.53.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.54.1">DAC</span></strong><span class="koboSpan" id="kobo.55.1">) is </span><a id="_idIndexMarker1410"/><span class="koboSpan" id="kobo.56.1">the typical ACM related to filesystem objects, including files, directories, and devices. </span><span class="koboSpan" id="kobo.56.2">Such access is at the discretion of the object’s owner when managing permissions. </span><span class="koboSpan" id="kobo.56.3">DAC controls access to </span><em class="italic"><span class="koboSpan" id="kobo.57.1">objects</span></em><span class="koboSpan" id="kobo.58.1"> based on the identity of users and groups (</span><em class="italic"><span class="koboSpan" id="kobo.59.1">subjects</span></em><span class="koboSpan" id="kobo.60.1">). </span><span class="koboSpan" id="kobo.60.2">Depending on a subject’s access permissions, they could also pass permissions to other subjects —an administrator managing regular users, </span><span class="No-Break"><span class="koboSpan" id="kobo.61.1">for example.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.62.1">Access control lists</span></strong><span class="koboSpan" id="kobo.63.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.64.1">ACLs</span></strong><span class="koboSpan" id="kobo.65.1">) provide </span><a id="_idIndexMarker1411"/><span class="koboSpan" id="kobo.66.1">control over which subjects (such as users</span><a id="_idIndexMarker1412"/><span class="koboSpan" id="kobo.67.1"> and groups) have access to specific filesystem objects (such as files </span><span class="No-Break"><span class="koboSpan" id="kobo.68.1">and directories).</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.69.1">Mandatory access control</span></strong><span class="koboSpan" id="kobo.70.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.71.1">MAC</span></strong><span class="koboSpan" id="kobo.72.1">) provides</span><a id="_idIndexMarker1413"/><span class="koboSpan" id="kobo.73.1"> different access control levels </span><a id="_idIndexMarker1414"/><span class="koboSpan" id="kobo.74.1">to subjects over the objects they own. </span><span class="koboSpan" id="kobo.74.2">Unlike DAC, where users have full control over the filesystem objects they own, MAC adds additional labels, or categories, to all filesystem objects. </span><span class="koboSpan" id="kobo.74.3">Consequently, subjects must have the appropriate access to these categories to</span><a id="_idIndexMarker1415"/><span class="koboSpan" id="kobo.75.1"> interact with the objects labeled as such. </span><span class="koboSpan" id="kobo.75.2">MAC is</span><a id="_idIndexMarker1416"/><span class="koboSpan" id="kobo.76.1"> enforced by </span><em class="italic"><span class="koboSpan" id="kobo.77.1">SELinux</span></em><span class="koboSpan" id="kobo.78.1"> on </span><strong class="bold"><span class="koboSpan" id="kobo.79.1">Red Hat Enterprise Linux</span></strong><span class="koboSpan" id="kobo.80.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.81.1">RHEL</span></strong><span class="koboSpan" id="kobo.82.1">)/Fedora and </span><em class="italic"><span class="koboSpan" id="kobo.83.1">AppArmor</span></em> <span class="No-Break"><span class="koboSpan" id="kobo.84.1">on Ubuntu/Debian/openSUSE.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.85.1">Role-based access control</span></strong><span class="koboSpan" id="kobo.86.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.87.1">RBAC</span></strong><span class="koboSpan" id="kobo.88.1">) is an</span><a id="_idIndexMarker1417"/><span class="koboSpan" id="kobo.89.1"> alternative to the </span><a id="_idIndexMarker1418"/><span class="koboSpan" id="kobo.90.1">permission-based access control of filesystem objects. </span><span class="koboSpan" id="kobo.90.2">Instead of permissions, a system administrator assigns </span><em class="italic"><span class="koboSpan" id="kobo.91.1">roles</span></em><span class="koboSpan" id="kobo.92.1"> that have access to a specific filesystem object. </span><span class="koboSpan" id="kobo.92.2">Roles could be based on some business or functional criteria and may have different access levels </span><span class="No-Break"><span class="koboSpan" id="kobo.93.1">to objects.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.94.1">In contrast to DAC or MAC, where subjects have access to objects based strictly on the permissions involved, the RBAC model represents a logical abstraction over MAC or DAC, where the subjects must be members of a specific group or role before interacting </span><span class="No-Break"><span class="koboSpan" id="kobo.95.1">with objects.</span></span></p></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.96.1">Multi-level security</span></strong><span class="koboSpan" id="kobo.97.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.98.1">MLS</span></strong><span class="koboSpan" id="kobo.99.1">) is a</span><a id="_idIndexMarker1419"/><span class="koboSpan" id="kobo.100.1"> specific MAC scheme where the </span><em class="italic"><span class="koboSpan" id="kobo.101.1">subjects</span></em><span class="koboSpan" id="kobo.102.1"> are processes </span><a id="_idIndexMarker1420"/><span class="koboSpan" id="kobo.103.1">and the </span><em class="italic"><span class="koboSpan" id="kobo.104.1">objects</span></em><span class="koboSpan" id="kobo.105.1"> are files, sockets, and other similar </span><span class="No-Break"><span class="koboSpan" id="kobo.106.1">system resources.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.107.1">Multi-category security</span></strong><span class="koboSpan" id="kobo.108.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.109.1">MCS</span></strong><span class="koboSpan" id="kobo.110.1">) is an </span><a id="_idIndexMarker1421"/><span class="koboSpan" id="kobo.111.1">improved version of SELinux that allows </span><a id="_idIndexMarker1422"/><span class="koboSpan" id="kobo.112.1">users to label files with </span><em class="italic"><span class="koboSpan" id="kobo.113.1">categories</span></em><span class="koboSpan" id="kobo.114.1">. </span><span class="koboSpan" id="kobo.114.2">MCS reuses much of the MLS framework </span><span class="No-Break"><span class="koboSpan" id="kobo.115.1">in SELinux.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.116.1">Wrapping up our brief discussion on ACMs, we should note that we covered some of the internals of DAC and ACL in </span><a href="B19682_04.xhtml#_idTextAnchor090"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.117.1">Chapter 4</span></em></span></a><span class="koboSpan" id="kobo.118.1">, </span><em class="italic"><span class="koboSpan" id="kobo.119.1">Managing Users and Groups</span></em><span class="koboSpan" id="kobo.120.1">, particularly in the </span><em class="italic"><span class="koboSpan" id="kobo.121.1">Managing </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.122.1">permissions</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.123.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.124.1">Next, we’ll turn our attention to SELinux—a first-class citizen for </span><span class="No-Break"><span class="koboSpan" id="kobo.125.1">MAC implementations.</span></span></p>
<h1 id="_idParaDest-182"><a id="_idTextAnchor198"/><span class="koboSpan" id="kobo.126.1">Introducing SELinux</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.127.1">SELinux</span></strong><span class="koboSpan" id="kobo.128.1"> is a</span><a id="_idIndexMarker1423"/><span class="koboSpan" id="kobo.129.1"> security framework in the Linux kernel for managing the access control policies of system resources. </span><span class="koboSpan" id="kobo.129.2">It supports a combination of the MAC, RBAC, and MLS models that were described in the previous section. </span><span class="koboSpan" id="kobo.129.3">SELinux is a set of kernel-space security modules and user-space command-line utilities, and it provides a mechanism for system administrators to have control over </span><em class="italic"><span class="koboSpan" id="kobo.130.1">who</span></em><span class="koboSpan" id="kobo.131.1"> can access </span><em class="italic"><span class="koboSpan" id="kobo.132.1">what</span></em><span class="koboSpan" id="kobo.133.1"> on the system. </span><span class="koboSpan" id="kobo.133.2">SELinux is designed to also protect a system against possible misconfigurations and potentially </span><span class="No-Break"><span class="koboSpan" id="kobo.134.1">compromised processes.</span></span></p>
<p><span class="koboSpan" id="kobo.135.1">SELinux was introduced by the </span><strong class="bold"><span class="koboSpan" id="kobo.136.1">National Security Agency</span></strong><span class="koboSpan" id="kobo.137.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.138.1">NSA</span></strong><span class="koboSpan" id="kobo.139.1">) as a </span><a id="_idIndexMarker1424"/><span class="koboSpan" id="kobo.140.1">collection of </span><strong class="bold"><span class="koboSpan" id="kobo.141.1">Linux Security Modules</span></strong><span class="koboSpan" id="kobo.142.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.143.1">LSM</span></strong><span class="koboSpan" id="kobo.144.1">) with kernel updates. </span><span class="koboSpan" id="kobo.144.2">SELinux was eventually released </span><a id="_idIndexMarker1425"/><span class="koboSpan" id="kobo.145.1">to the open source community in 2000 and became part of Linux starting with the 2.6 kernel series </span><span class="No-Break"><span class="koboSpan" id="kobo.146.1">in 2003.</span></span></p>
<p><span class="koboSpan" id="kobo.147.1">So, how does SELinux work? </span><span class="koboSpan" id="kobo.147.2">We’ll look at this in the next section. </span><span class="koboSpan" id="kobo.147.3">We will use Fedora 37 Server Edition for all </span><span class="No-Break"><span class="koboSpan" id="kobo.148.1">our examples.</span></span></p>
<h2 id="_idParaDest-183"><a id="_idTextAnchor199"/><span class="koboSpan" id="kobo.149.1">Working with SELinux</span></h2>
<p><span class="koboSpan" id="kobo.150.1">SELinux </span><a id="_idIndexMarker1426"/><span class="koboSpan" id="kobo.151.1">uses </span><strong class="bold"><span class="koboSpan" id="kobo.152.1">security policies</span></strong><span class="koboSpan" id="kobo.153.1"> to define various access control levels for applications, processes, and files on a system. </span><span class="koboSpan" id="kobo.153.2">A security policy is a set of rules describing what can or cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.154.1">be accessed.</span></span></p>
<p><span class="koboSpan" id="kobo.155.1">SELinux operates with </span><strong class="bold"><span class="koboSpan" id="kobo.156.1">subjects</span></strong><span class="koboSpan" id="kobo.157.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.158.1">objects</span></strong><span class="koboSpan" id="kobo.159.1">. </span><span class="koboSpan" id="kobo.159.2">When a specific application or process (the </span><em class="italic"><span class="koboSpan" id="kobo.160.1">subject</span></em><span class="koboSpan" id="kobo.161.1">) requests access to a file (the </span><em class="italic"><span class="koboSpan" id="kobo.162.1">object</span></em><span class="koboSpan" id="kobo.163.1">), SELinux checks the required permissions involved in the request and enforces the related access control. </span><span class="koboSpan" id="kobo.163.2">The permissions for subjects and objects are stored in a lookup table known as the </span><strong class="bold"><span class="koboSpan" id="kobo.164.1">Access Vector Cache</span></strong><span class="koboSpan" id="kobo.165.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.166.1">AVC</span></strong><span class="koboSpan" id="kobo.167.1">). </span><span class="koboSpan" id="kobo.167.2">The </span><a id="_idIndexMarker1427"/><span class="koboSpan" id="kobo.168.1">AVC is generated based on the </span><strong class="bold"><span class="koboSpan" id="kobo.169.1">SELinux </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.170.1">policy database</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.171.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.172.1">A typical SELinux policy consists of the following resources (files), each reflecting a specific aspect of the </span><span class="No-Break"><span class="koboSpan" id="kobo.173.1">security policy:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.174.1">Type enforcement</span></strong><span class="koboSpan" id="kobo.175.1">: Actions that have been granted or denied for the policy (such as read or write access to </span><span class="No-Break"><span class="koboSpan" id="kobo.176.1">a file)</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.177.1">Interface</span></strong><span class="koboSpan" id="kobo.178.1">: The application interface the policy interacts with (such </span><span class="No-Break"><span class="koboSpan" id="kobo.179.1">as logging)</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.180.1">File contexts</span></strong><span class="koboSpan" id="kobo.181.1">: The system resources associated with the policy (such as </span><span class="No-Break"><span class="koboSpan" id="kobo.182.1">log files)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.183.1">These policy files are compiled together using SELinux build tools to produce a specific </span><strong class="bold"><span class="koboSpan" id="kobo.184.1">security policy</span></strong><span class="koboSpan" id="kobo.185.1">. </span><span class="koboSpan" id="kobo.185.2">The policy is loaded into the kernel, added to the SELinux policy database, and made active without a </span><span class="No-Break"><span class="koboSpan" id="kobo.186.1">system reboot.</span></span></p>
<p><span class="koboSpan" id="kobo.187.1">When creating </span><a id="_idIndexMarker1428"/><span class="koboSpan" id="kobo.188.1">SELinux policies, we usually test them in </span><em class="italic"><span class="koboSpan" id="kobo.189.1">permissive</span></em><span class="koboSpan" id="kobo.190.1"> mode first, where violations are logged but still allowed. </span><span class="koboSpan" id="kobo.190.2">When violations occur, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.191.1">audit2allow</span></strong><span class="koboSpan" id="kobo.192.1"> utility in the SELinux toolset comes to the rescue. </span><span class="koboSpan" id="kobo.192.2">We use the log traces produced by </span><strong class="source-inline"><span class="koboSpan" id="kobo.193.1">audit2allow</span></strong><span class="koboSpan" id="kobo.194.1"> to create additional rules required by the policy to account for legitimate access permissions. </span><span class="koboSpan" id="kobo.194.2">SELinux violations are logged in </span><strong class="source-inline"><span class="koboSpan" id="kobo.195.1">/var/log/messages</span></strong><span class="koboSpan" id="kobo.196.1"> and are prefixed with </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.197.1">avc: denied</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.198.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.199.1">Before we learn how to create and manage a SELinux security policy, let’s look at some higher-level operations for managing and controlling SELinux in everyday </span><span class="No-Break"><span class="koboSpan" id="kobo.200.1">administration tasks.</span></span></p>
<h3><span class="koboSpan" id="kobo.201.1">Understanding SELinux modes</span></h3>
<p><span class="koboSpan" id="kobo.202.1">SELinux is either </span><em class="italic"><span class="koboSpan" id="kobo.203.1">enabled</span></em><span class="koboSpan" id="kobo.204.1"> or </span><em class="italic"><span class="koboSpan" id="kobo.205.1">disabled</span></em><span class="koboSpan" id="kobo.206.1"> in a system. </span><span class="koboSpan" id="kobo.206.2">When enabled, it operates in either of the </span><span class="No-Break"><span class="koboSpan" id="kobo.207.1">following modes:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.208.1">enforcing</span></strong><span class="koboSpan" id="kobo.209.1">: SELinux effectively</span><a id="_idIndexMarker1429"/><span class="koboSpan" id="kobo.210.1"> monitors and controls security policies. </span><span class="koboSpan" id="kobo.210.2">In RHEL/Fedora, this mode is enabled </span><span class="No-Break"><span class="koboSpan" id="kobo.211.1">by default.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.212.1">permissive</span></strong><span class="koboSpan" id="kobo.213.1">: Security policies </span><a id="_idIndexMarker1430"/><span class="koboSpan" id="kobo.214.1">are actively monitored without enforcing access control. </span><span class="koboSpan" id="kobo.214.2">Policy violations are logged </span><span class="No-Break"><span class="koboSpan" id="kobo.215.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.216.1">/var/log/messages</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.217.1">.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.218.1">When SELinux is disabled, security policies are neither monitored nor enforced. </span><span class="koboSpan" id="kobo.218.2">The following command retrieves the current status of SELinux on </span><span class="No-Break"><span class="koboSpan" id="kobo.219.1">the system:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.220.1">
sestatus</span></pre> <p><span class="koboSpan" id="kobo.221.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.222.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer291">
<span class="koboSpan" id="kobo.223.1"><img alt="Figure 9.1 – Getting the current status of SELinux" src="image/B19682_09_01.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.224.1">Figure 9.1 – Getting the current status of SELinux</span></p>
<p><span class="koboSpan" id="kobo.225.1">When SELinux is enabled, the</span><a id="_idIndexMarker1431"/><span class="koboSpan" id="kobo.226.1"> following command retrieves the </span><span class="No-Break"><span class="koboSpan" id="kobo.227.1">current</span></span><span class="No-Break"><a id="_idIndexMarker1432"/></span><span class="No-Break"><span class="koboSpan" id="kobo.228.1"> mode:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.229.1">
getenforce</span></pre> <p><span class="koboSpan" id="kobo.230.1">In </span><strong class="source-inline"><span class="koboSpan" id="kobo.231.1">permissive</span></strong><span class="koboSpan" id="kobo.232.1"> mode, we get the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.233.1">enforcing</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.234.1"> output.</span></span></p>
<p><span class="koboSpan" id="kobo.235.1">To change from </span><strong class="source-inline"><span class="koboSpan" id="kobo.236.1">enforcing</span></strong><span class="koboSpan" id="kobo.237.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.238.1">permissive</span></strong><span class="koboSpan" id="kobo.239.1"> mode, we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.240.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.241.1">
sudo setenforce 0</span></pre> <p><span class="koboSpan" id="kobo.242.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.243.1">getenforce</span></strong><span class="koboSpan" id="kobo.244.1"> command will display </span><strong class="source-inline"><span class="koboSpan" id="kobo.245.1">permissive</span></strong><span class="koboSpan" id="kobo.246.1"> in this case. </span><span class="koboSpan" id="kobo.246.2">To switch back into </span><strong class="source-inline"><span class="koboSpan" id="kobo.247.1">enforcing</span></strong><span class="koboSpan" id="kobo.248.1"> mode, we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.249.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.250.1">
sudo setenforce 1</span></pre> <p><span class="koboSpan" id="kobo.251.1">The SELinux mode can also be set by editing the </span><strong class="source-inline"><span class="koboSpan" id="kobo.252.1">SELINUX</span></strong><span class="koboSpan" id="kobo.253.1"> value in </span><strong class="source-inline"><span class="koboSpan" id="kobo.254.1">/etc/selinux/config</span></strong><span class="koboSpan" id="kobo.255.1">. </span><span class="koboSpan" id="kobo.255.2">Possible values are documented in the </span><span class="No-Break"><span class="koboSpan" id="kobo.256.1">configuration file.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.257.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.258.1">Manually editing the SELinux configuration file requires a system reboot for changes to </span><span class="No-Break"><span class="koboSpan" id="kobo.259.1">take effect.</span></span></p>
<p><span class="koboSpan" id="kobo.260.1">With SELinux enabled, a system administrator may choose between the following SELinux policy levels by modifying the </span><strong class="source-inline"><span class="koboSpan" id="kobo.261.1">SELINUXTYPE</span></strong><span class="koboSpan" id="kobo.262.1"> value in </span><strong class="source-inline"><span class="koboSpan" id="kobo.263.1">/etc/selinux/config</span></strong><span class="koboSpan" id="kobo.264.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.265.1">targeted</span></strong><span class="koboSpan" id="kobo.266.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.267.1">minimum</span></strong><span class="koboSpan" id="kobo.268.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.269.1">mls</span></strong><span class="koboSpan" id="kobo.270.1">. </span><span class="koboSpan" id="kobo.270.2">The corresponding values are documented in the </span><span class="No-Break"><span class="koboSpan" id="kobo.271.1">configuration file.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.272.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.273.1">The default SELinux policy setting is </span><strong class="source-inline"><span class="koboSpan" id="kobo.274.1">targeted</span></strong><span class="koboSpan" id="kobo.275.1">, and it’s generally recommended not to change this setting, except </span><span class="No-Break"><span class="koboSpan" id="kobo.276.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.277.1">mls</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.278.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.279.1">With the </span><strong class="source-inline"><span class="koboSpan" id="kobo.280.1">targeted</span></strong><span class="koboSpan" id="kobo.281.1"> policy in place, only processes that are specifically configured to use SELinux security policies can run in a </span><em class="italic"><span class="koboSpan" id="kobo.282.1">confined</span></em><span class="koboSpan" id="kobo.283.1"> (or restricted) domain. </span><span class="koboSpan" id="kobo.283.2">Such processes usually include system daemons (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.284.1">dhcpd</span></strong><span class="koboSpan" id="kobo.285.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.286.1">sshd</span></strong><span class="koboSpan" id="kobo.287.1">) and well-known server applications (such as Apache</span><a id="_idIndexMarker1433"/><span class="koboSpan" id="kobo.288.1"> and PostgreSQL). </span><span class="koboSpan" id="kobo.288.2">All other (non-targeted) processes run unrestricted and are usually labeled with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.289.1">unconfined_t</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.290.1">domain type.</span></span></p>
<p><span class="koboSpan" id="kobo.291.1">To completely disable SELinux, we can edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.292.1">/etc/selinux/config</span></strong><span class="koboSpan" id="kobo.293.1"> file using a text editor of our choice (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.294.1">sudo nano /etc/selinux/config</span></strong><span class="koboSpan" id="kobo.295.1">) and make the </span><span class="No-Break"><span class="koboSpan" id="kobo.296.1">following change:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.297.1">
SELINUX=disabled</span></pre> <p><span class="koboSpan" id="kobo.298.1">Alternatively, we can run the following command to change the SELinux mode from </span><strong class="source-inline"><span class="koboSpan" id="kobo.299.1">enforcing</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.300.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.301.1">disabled</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.302.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.303.1">
sudo sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre> <p><span class="koboSpan" id="kobo.304.1">We can retrieve the current configuration with the </span><span class="No-Break"><span class="koboSpan" id="kobo.305.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.306.1">
cat /etc/selinux/config</span></pre> <p><span class="koboSpan" id="kobo.307.1">With </span><a id="_idIndexMarker1434"/><span class="koboSpan" id="kobo.308.1">SELinux disabled, we get the following </span><span class="No-Break"><span class="koboSpan" id="kobo.309.1">output (excerpt):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer292">
<span class="koboSpan" id="kobo.310.1"><img alt="Figure 9.2 – Disabling SELinux" src="image/B19682_09_02.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.311.1">Figure 9.2 – Disabling SELinux</span></p>
<p><span class="koboSpan" id="kobo.312.1">We need to reboot the system for changes to </span><span class="No-Break"><span class="koboSpan" id="kobo.313.1">take effect:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.314.1">
sudo systemctl reboot</span></pre> <p><span class="koboSpan" id="kobo.315.1">Next, let’s examine how access control decisions are made by introducing </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.316.1">SELinux contexts</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.317.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.318.1">Understanding SELinux contexts</span></h3>
<p><span class="koboSpan" id="kobo.319.1">With SELinux enabled, processes and files are labeled with a </span><strong class="bold"><span class="koboSpan" id="kobo.320.1">context</span></strong><span class="koboSpan" id="kobo.321.1"> containing additional SELinux-specific</span><a id="_idIndexMarker1435"/><span class="koboSpan" id="kobo.322.1"> information, such as </span><em class="italic"><span class="koboSpan" id="kobo.323.1">user</span></em><span class="koboSpan" id="kobo.324.1">, </span><em class="italic"><span class="koboSpan" id="kobo.325.1">role</span></em><span class="koboSpan" id="kobo.326.1">, </span><em class="italic"><span class="koboSpan" id="kobo.327.1">type</span></em><span class="koboSpan" id="kobo.328.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.329.1">level</span></em><span class="koboSpan" id="kobo.330.1"> (optional). </span><span class="koboSpan" id="kobo.330.2">The context data serves for SELinux access </span><span class="No-Break"><span class="koboSpan" id="kobo.331.1">control decisions.</span></span></p>
<p><span class="koboSpan" id="kobo.332.1">SELinux adds the </span><strong class="source-inline"><span class="koboSpan" id="kobo.333.1">-Z</span></strong><span class="koboSpan" id="kobo.334.1"> option to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.335.1">ls</span></strong><span class="koboSpan" id="kobo.336.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.337.1">ps</span></strong><span class="koboSpan" id="kobo.338.1">, and other commands, thus displaying the security context of filesystem objects, processes, </span><span class="No-Break"><span class="koboSpan" id="kobo.339.1">and more.</span></span></p>
<p><span class="koboSpan" id="kobo.340.1">Let’s create an </span><a id="_idIndexMarker1436"/><span class="koboSpan" id="kobo.341.1">arbitrary file and examine the related </span><span class="No-Break"><span class="koboSpan" id="kobo.342.1">SELinux context:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.343.1">
touch afile
ls -Z afile</span></pre> <p><span class="koboSpan" id="kobo.344.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.345.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer293">
<span class="koboSpan" id="kobo.346.1"><img alt="Figure 9.3 – Displaying the SELinux context of a file" src="image/B19682_09_03.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.347.1">Figure 9.3 – Displaying the SELinux context of a file</span></p>
<p><span class="koboSpan" id="kobo.348.1">The SELinux context has the following format—a sequence of four fields, separated by a </span><span class="No-Break"><span class="koboSpan" id="kobo.349.1">colon (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.350.1">:</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.351.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.352.1">
USER:ROLE:TYPE:LEVEL</span></pre> <p><span class="koboSpan" id="kobo.353.1">Now, let’s take a look at the SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.354.1">context fields:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.355.1">SELinux user</span></strong><span class="koboSpan" id="kobo.356.1">: The SELinux user is an identity known to the policy that’s authorized for a specific set of </span><a id="_idIndexMarker1437"/><span class="koboSpan" id="kobo.357.1">roles and has a particular level that’s designated by an MLS/MCS range (see </span><em class="italic"><span class="koboSpan" id="kobo.358.1">SELinux level</span></em><span class="koboSpan" id="kobo.359.1"> in this list for more details). </span><span class="koboSpan" id="kobo.359.2">Every Linux user account is mapped to a corresponding SELinux user identity using an SELinux policy. </span><span class="koboSpan" id="kobo.359.3">This mechanism allows regular Linux users to inherit the policy restrictions associated with </span><span class="No-Break"><span class="koboSpan" id="kobo.360.1">SELinux users.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.361.1">A process owned by a Linux user receives the mapped SELinux user’s identity to assume the corresponding SELinux roles </span><span class="No-Break"><span class="koboSpan" id="kobo.362.1">and levels.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.363.1">The following command displays a list of mappings between Linux accounts and their corresponding SELinux user identities. </span><span class="koboSpan" id="kobo.363.2">The command requires superuser privileges. </span><span class="koboSpan" id="kobo.363.3">Also, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.364.1">semanage</span></strong><span class="koboSpan" id="kobo.365.1"> utility is available with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.366.1">policycoreutils</span></strong><span class="koboSpan" id="kobo.367.1"> package, which you may need to install on </span><span class="No-Break"><span class="koboSpan" id="kobo.368.1">your system:</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.369.1">sudo semanage login -l</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.370.1">The command yields</span><a id="_idIndexMarker1438"/><span class="koboSpan" id="kobo.371.1"> the following output. </span><span class="koboSpan" id="kobo.371.2">The output may differ slightly from system </span><span class="No-Break"><span class="koboSpan" id="kobo.372.1">to system:</span></span></p></li> </ul>
<div>
<div class="IMG---Figure" id="_idContainer294">
<span class="koboSpan" id="kobo.373.1"><img alt="Figure 9.4 – Displaying the SELinux user mappings" src="image/B19682_09_04.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.374.1">Figure 9.4 – Displaying the SELinux user mappings</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.375.1">For more</span><a id="_idIndexMarker1439"/><span class="koboSpan" id="kobo.376.1"> information on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.377.1">semanage</span></strong><span class="koboSpan" id="kobo.378.1"> command-line utility, you may refer to the related system reference (</span><strong class="source-inline"><span class="koboSpan" id="kobo.379.1">man semanage</span></strong><span class="koboSpan" id="kobo.380.1">, </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.381.1">man semanage-login</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.382.1">).</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.383.1">SELinux roles</span></strong><span class="koboSpan" id="kobo.384.1">: SELinux roles are part of </span><a id="_idIndexMarker1440"/><span class="koboSpan" id="kobo.385.1">the RBAC security model, and they are essentially RBAC attributes. </span><span class="koboSpan" id="kobo.385.2">In the SELinux context hierarchy, users are authorized for roles, and roles are authorized for types or domains. </span><span class="koboSpan" id="kobo.385.3">In the SELinux context terminology, </span><strong class="bold"><span class="koboSpan" id="kobo.386.1">types</span></strong><span class="koboSpan" id="kobo.387.1"> refer to filesystem object types and </span><strong class="bold"><span class="koboSpan" id="kobo.388.1">domains</span></strong><span class="koboSpan" id="kobo.389.1"> refer to process types (see more under </span><em class="italic"><span class="koboSpan" id="kobo.390.1">SELinux type</span></em><span class="koboSpan" id="kobo.391.1"> in </span><span class="No-Break"><span class="koboSpan" id="kobo.392.1">this list).</span></span><p class="list-inset"><span class="koboSpan" id="kobo.393.1">Take Linux processes, for example. </span><span class="koboSpan" id="kobo.393.2">The SELinux role serves as an intermediary access layer between domains and SELinux users. </span><span class="koboSpan" id="kobo.393.3">An </span><em class="italic"><span class="koboSpan" id="kobo.394.1">accessible</span></em><span class="koboSpan" id="kobo.395.1"> role determines which domain (that is, processes) can be accessed through that role. </span><span class="koboSpan" id="kobo.395.2">Ultimately, this mechanism controls which object types can be accessed by the process, thus minimizing the surface for privilege </span><span class="No-Break"><span class="koboSpan" id="kobo.396.1">escalation attacks.</span></span></p></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.397.1">SELinux type</span></strong><span class="koboSpan" id="kobo.398.1">: The SELinux type is an</span><a id="_idIndexMarker1441"/><span class="koboSpan" id="kobo.399.1"> attribute of SELinux </span><em class="italic"><span class="koboSpan" id="kobo.400.1">type enforcement</span></em><span class="koboSpan" id="kobo.401.1">—a MAC security construct. </span><span class="koboSpan" id="kobo.401.2">For SELinux types, we refer to domains as process types and types as filesystem object types. </span><span class="koboSpan" id="kobo.401.3">SELinux security policies control how specific types can access each other—either with domain-to-type access or </span><span class="No-Break"><span class="koboSpan" id="kobo.402.1">domain-to-domain interactions.</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.403.1">SELinux level</span></strong><span class="koboSpan" id="kobo.404.1">: The SELinux level is an</span><a id="_idIndexMarker1442"/><span class="koboSpan" id="kobo.405.1"> attribute of the MLS/MCS schema and an optional field in the SELinux context. </span><span class="koboSpan" id="kobo.405.2">A level usually refers to the security clearance of a subject’s access control to an object. </span><span class="koboSpan" id="kobo.405.3">Levels of clearance include </span><strong class="source-inline"><span class="koboSpan" id="kobo.406.1">unclassified</span></strong><span class="koboSpan" id="kobo.407.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.408.1">confidential</span></strong><span class="koboSpan" id="kobo.409.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.410.1">secret</span></strong><span class="koboSpan" id="kobo.411.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.412.1">top-secret</span></strong><span class="koboSpan" id="kobo.413.1"> and are expressed as a </span><strong class="bold"><span class="koboSpan" id="kobo.414.1">range</span></strong><span class="koboSpan" id="kobo.415.1">. </span><span class="koboSpan" id="kobo.415.2">An MLS range represents a pair of levels, defined as </span><strong class="source-inline"><span class="koboSpan" id="kobo.416.1">low-high</span></strong><span class="koboSpan" id="kobo.417.1"> if the levels differ or just </span><strong class="source-inline"><span class="koboSpan" id="kobo.418.1">low</span></strong><span class="koboSpan" id="kobo.419.1"> if the levels are identical. </span><span class="koboSpan" id="kobo.419.2">For example, a level of </span><strong class="source-inline"><span class="koboSpan" id="kobo.420.1">s0-s0</span></strong><span class="koboSpan" id="kobo.421.1"> is the same as </span><strong class="source-inline"><span class="koboSpan" id="kobo.422.1">s0</span></strong><span class="koboSpan" id="kobo.423.1">. </span><span class="koboSpan" id="kobo.423.2">Each level represents a </span><em class="italic"><span class="koboSpan" id="kobo.424.1">sensitivity-category</span></em><span class="koboSpan" id="kobo.425.1"> pair, with categories being optional. </span><span class="koboSpan" id="kobo.425.2">When a category is specified, the level is defined as </span><strong class="source-inline"><span class="koboSpan" id="kobo.426.1">sensitivity:category-set</span></strong><span class="koboSpan" id="kobo.427.1">; otherwise, it’s defined as </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.428.1">sensitivity</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.429.1"> only.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.430.1">We are now familiar with SELinux contexts. </span><span class="koboSpan" id="kobo.430.2">We’ll see them in action, starting with the SELinux contexts for </span><span class="No-Break"><span class="koboSpan" id="kobo.431.1">users, next.</span></span></p>
<h4><span class="koboSpan" id="kobo.432.1">SELinux contexts for users</span></h4>
<p><span class="koboSpan" id="kobo.433.1">The following </span><a id="_idIndexMarker1443"/><span class="koboSpan" id="kobo.434.1">command displays the SELinux context associated with the </span><span class="No-Break"><span class="koboSpan" id="kobo.435.1">current user:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.436.1">
id -Z</span></pre> <p><span class="koboSpan" id="kobo.437.1">In our case, the output is </span><span class="No-Break"><span class="koboSpan" id="kobo.438.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer295">
<span class="koboSpan" id="kobo.439.1"><img alt="Figure 9.5 – Displaying the current user’s SELinux context" src="image/B19682_09_05.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.440.1">Figure 9.5 – Displaying the current user’s SELinux context</span></p>
<p><span class="koboSpan" id="kobo.441.1">In RHEL/Fedora, Linux users are </span><strong class="source-inline"><span class="koboSpan" id="kobo.442.1">unconfined</span></strong><span class="koboSpan" id="kobo.443.1"> (unrestricted) by default, with the following </span><span class="No-Break"><span class="koboSpan" id="kobo.444.1">context fields:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.445.1">unconfined_u</span></strong><span class="koboSpan" id="kobo.446.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.447.1">User identity</span></span></li>
<li><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.448.1">unconfined_r</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.449.1">: Role</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.450.1">unconfined_t</span></strong><span class="koboSpan" id="kobo.451.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.452.1">Domain affinity</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.453.1">s0-s0</span></strong><span class="koboSpan" id="kobo.454.1">: MLS range (the equivalent </span><span class="No-Break"><span class="koboSpan" id="kobo.455.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.456.1">s0</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.457.1">)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.458.1">c0.c1023</span></strong><span class="koboSpan" id="kobo.459.1">: Category set, representing all categories (from </span><strong class="source-inline"><span class="koboSpan" id="kobo.460.1">c0</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.461.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.462.1">c1023</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.463.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.464.1">Next, we’ll examine the</span><a id="_idIndexMarker1444"/><span class="koboSpan" id="kobo.465.1"> SELinux context </span><span class="No-Break"><span class="koboSpan" id="kobo.466.1">for processes.</span></span></p>
<h4><span class="koboSpan" id="kobo.467.1">SELinux contexts for processes</span></h4>
<p><span class="koboSpan" id="kobo.468.1">The following </span><a id="_idIndexMarker1445"/><span class="koboSpan" id="kobo.469.1">command displays the SELinux context for current </span><span class="No-Break"><span class="koboSpan" id="kobo.470.1">SSH processes:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.471.1">
ps -eZ | grep sshd</span></pre> <p><span class="koboSpan" id="kobo.472.1">The command yields the </span><span class="No-Break"><span class="koboSpan" id="kobo.473.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer296">
<span class="koboSpan" id="kobo.474.1"><img alt="Figure 9.6 – Displaying the SELinux context for SSH-related processes" src="image/B19682_09_06.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.475.1">Figure 9.6 – Displaying the SELinux context for SSH-related processes</span></p>
<p><span class="koboSpan" id="kobo.476.1">From the output, we can infer that the first line refers to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.477.1">sshd</span></strong><span class="koboSpan" id="kobo.478.1"> server process, which is running with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.479.1">system_u</span></strong><span class="koboSpan" id="kobo.480.1"> user identity, </span><strong class="source-inline"><span class="koboSpan" id="kobo.481.1">system_r</span></strong><span class="koboSpan" id="kobo.482.1"> role, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.483.1">sshd_t</span></strong><span class="koboSpan" id="kobo.484.1"> domain affinity. </span><span class="koboSpan" id="kobo.484.2">The second line refers to the current user’s SSH session, hence the </span><strong class="source-inline"><span class="koboSpan" id="kobo.485.1">unconfined</span></strong><span class="koboSpan" id="kobo.486.1"> context. </span><span class="koboSpan" id="kobo.486.2">System daemons are usually associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.487.1">system_u</span></strong><span class="koboSpan" id="kobo.488.1"> user and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.489.1">system_r</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.490.1"> role.</span></span></p>
<p><span class="koboSpan" id="kobo.491.1">Before concluding this section on SELinux contexts, we’ll examine the relatively common scenario of SELinux domain transitions, which is where a process in one domain accesses an object (or process) in a </span><span class="No-Break"><span class="koboSpan" id="kobo.492.1">different domain.</span></span></p>
<h4><span class="koboSpan" id="kobo.493.1">SELinux domain transitions</span></h4>
<p><span class="koboSpan" id="kobo.494.1">Assuming an SELinux-secured</span><a id="_idIndexMarker1446"/><span class="koboSpan" id="kobo.495.1"> process in one domain requests access to an object (or another process) in a different domain, SELinux </span><strong class="bold"><span class="koboSpan" id="kobo.496.1">domain transitions</span></strong><span class="koboSpan" id="kobo.497.1"> come into play. </span><span class="koboSpan" id="kobo.497.2">Unless there’s a specific security policy allowing the related domain transition, SELinux would </span><span class="No-Break"><span class="koboSpan" id="kobo.498.1">deny access.</span></span></p>
<p><span class="koboSpan" id="kobo.499.1">An SELinux-protected process transitioning from one domain into another invokes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.500.1">entrypoint</span></strong><span class="koboSpan" id="kobo.501.1"> type of the new domain. </span><span class="koboSpan" id="kobo.501.2">SELinux evaluates the related entrypoint permission and decides if the soliciting process can enter the </span><span class="No-Break"><span class="koboSpan" id="kobo.502.1">new domain.</span></span></p>
<p><span class="koboSpan" id="kobo.503.1">To illustrate a domain transition scenario, we will take the simple case of using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.504.1">passwd</span></strong><span class="koboSpan" id="kobo.505.1"> utility when users change their password. </span><span class="koboSpan" id="kobo.505.2">The related operation involves the interaction between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.506.1">passwd</span></strong><span class="koboSpan" id="kobo.507.1"> process and the </span><strong class="source-inline"><span class="koboSpan" id="kobo.508.1">/etc/shadow</span></strong><span class="koboSpan" id="kobo.509.1"> (and possibly </span><strong class="source-inline"><span class="koboSpan" id="kobo.510.1">/etc/gshadow</span></strong><span class="koboSpan" id="kobo.511.1">) file(s). </span><span class="koboSpan" id="kobo.511.2">When the user enters (and reenters) the password, </span><strong class="source-inline"><span class="koboSpan" id="kobo.512.1">passwd</span></strong><span class="koboSpan" id="kobo.513.1"> would hash and store the user’s password </span><span class="No-Break"><span class="koboSpan" id="kobo.514.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.515.1">/etc/shadow</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.516.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.517.1">Let’s examine the SELinux domain </span><a id="_idIndexMarker1447"/><span class="No-Break"><span class="koboSpan" id="kobo.518.1">affinities involved:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.519.1">
ls -Z /usr/bin/passwd
ls -Z /etc/shadow</span></pre> <p><span class="koboSpan" id="kobo.520.1">The corresponding output is </span><span class="No-Break"><span class="koboSpan" id="kobo.521.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer297">
<span class="koboSpan" id="kobo.522.1"><img alt="Figure 9.7 – Comparing the domain affinity context" src="image/B19682_09_07.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.523.1">Figure 9.7 – Comparing the domain affinity context</span></p>
<p><span class="koboSpan" id="kobo.524.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.525.1">passwd</span></strong><span class="koboSpan" id="kobo.526.1"> utility is labeled with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.527.1">passwd_exec_t</span></strong><span class="koboSpan" id="kobo.528.1"> type, while </span><strong class="source-inline"><span class="koboSpan" id="kobo.529.1">/etc/shadow</span></strong><span class="koboSpan" id="kobo.530.1"> is labeled with </span><strong class="source-inline"><span class="koboSpan" id="kobo.531.1">shadow_t</span></strong><span class="koboSpan" id="kobo.532.1">. </span><span class="koboSpan" id="kobo.532.2">There must be a specific security policy chain that allows the related domain to transition from </span><strong class="source-inline"><span class="koboSpan" id="kobo.533.1">passwd_exec_t</span></strong><span class="koboSpan" id="kobo.534.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.535.1">shadow_t</span></strong><span class="koboSpan" id="kobo.536.1">; otherwise, </span><strong class="source-inline"><span class="koboSpan" id="kobo.537.1">passwd</span></strong><span class="koboSpan" id="kobo.538.1"> will not work </span><span class="No-Break"><span class="koboSpan" id="kobo.539.1">as expected.</span></span></p>
<p><span class="koboSpan" id="kobo.540.1">Let’s validate our assumption. </span><span class="koboSpan" id="kobo.540.2">We’ll use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.541.1">sesearch</span></strong><span class="koboSpan" id="kobo.542.1"> tool to query for our assumed security policy. </span><span class="koboSpan" id="kobo.542.2">The command utility is not installed by default on Fedora, so you will have to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.543.1">setools-console</span></strong><span class="koboSpan" id="kobo.544.1"> package first. </span><span class="koboSpan" id="kobo.544.2">Use the </span><span class="No-Break"><span class="koboSpan" id="kobo.545.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.546.1">
sudo dnf install setools-console -y</span></pre> <p><span class="koboSpan" id="kobo.547.1">Now that the package is installed, we can use the </span><span class="No-Break"><span class="koboSpan" id="kobo.548.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.549.1">
sudo sesearch -s passwd_t -t shadow_t -p write --allow</span></pre> <p><span class="koboSpan" id="kobo.550.1">Here’s a brief explanation of the </span><span class="No-Break"><span class="koboSpan" id="kobo.551.1">preceding command:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.552.1">sesearch</span></strong><span class="koboSpan" id="kobo.553.1">: Searches the SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.554.1">policy database</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.555.1">-s passwd_t</span></strong><span class="koboSpan" id="kobo.556.1">: Finds policy rules with </span><strong class="source-inline"><span class="koboSpan" id="kobo.557.1">passwd_t</span></strong><span class="koboSpan" id="kobo.558.1"> as their source type </span><span class="No-Break"><span class="koboSpan" id="kobo.559.1">or role</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.560.1">-t shadow_t</span></strong><span class="koboSpan" id="kobo.561.1">: Finds policy rules with </span><strong class="source-inline"><span class="koboSpan" id="kobo.562.1">shadow_t</span></strong><span class="koboSpan" id="kobo.563.1"> as their target type </span><span class="No-Break"><span class="koboSpan" id="kobo.564.1">or role</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.565.1">-p write</span></strong><span class="koboSpan" id="kobo.566.1">: Finds policy rules with </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.567.1">write</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.568.1"> permissions</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.569.1">--allow</span></strong><span class="koboSpan" id="kobo.570.1">: Finds policy rules that allow the queried permissions (specified </span><span class="No-Break"><span class="koboSpan" id="kobo.571.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.572.1">-p</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.573.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.574.1">The output of the preceding command is </span><span class="No-Break"><span class="koboSpan" id="kobo.575.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer298">
<span class="koboSpan" id="kobo.576.1"><img alt="Figure 9.8 – Querying SELinux policies" src="image/B19682_09_08.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.577.1">Figure 9.8 – Querying SELinux policies</span></p>
<p><span class="koboSpan" id="kobo.578.1">Here, we </span><a id="_idIndexMarker1448"/><span class="koboSpan" id="kobo.579.1">can see the </span><strong class="source-inline"><span class="koboSpan" id="kobo.580.1">append create</span></strong><span class="koboSpan" id="kobo.581.1"> permissions, as we </span><span class="No-Break"><span class="koboSpan" id="kobo.582.1">correctly assumed.</span></span></p>
<p><span class="koboSpan" id="kobo.583.1">How did we pick the </span><strong class="source-inline"><span class="koboSpan" id="kobo.584.1">passwd_t</span></strong><span class="koboSpan" id="kobo.585.1"> source type instead of </span><strong class="source-inline"><span class="koboSpan" id="kobo.586.1">passwd_exec_t</span></strong><span class="koboSpan" id="kobo.587.1">? </span><span class="koboSpan" id="kobo.587.2">By definition, the </span><em class="italic"><span class="koboSpan" id="kobo.588.1">domain</span></em><span class="koboSpan" id="kobo.589.1"> type corresponding to the </span><em class="italic"><span class="koboSpan" id="kobo.590.1">executable file</span></em><span class="koboSpan" id="kobo.591.1"> type, </span><strong class="source-inline"><span class="koboSpan" id="kobo.592.1">passwd_exec_t</span></strong><span class="koboSpan" id="kobo.593.1">, is </span><strong class="source-inline"><span class="koboSpan" id="kobo.594.1">passwd_t</span></strong><span class="koboSpan" id="kobo.595.1">. </span><span class="koboSpan" id="kobo.595.2">If we were not sure about </span><em class="italic"><span class="koboSpan" id="kobo.596.1">who</span></em><span class="koboSpan" id="kobo.597.1"> has write permissions to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.598.1">shadow_t</span></strong><span class="koboSpan" id="kobo.599.1"> file types, we could have simply excluded the source type (</span><strong class="source-inline"><span class="koboSpan" id="kobo.600.1">-s passwd_t</span></strong><span class="koboSpan" id="kobo.601.1">) in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.602.1">sesearch</span></strong><span class="koboSpan" id="kobo.603.1"> query and parsed the output (for example, using </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.604.1">grep passwd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.605.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.606.1">The use of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.607.1">sesearch</span></strong><span class="koboSpan" id="kobo.608.1"> tool is very convenient when we’re querying security policies. </span><span class="koboSpan" id="kobo.608.2">There are a handful of similar tools for troubleshooting or managing the SELinux configuration and policies. </span><span class="koboSpan" id="kobo.608.3">One of the most notable SELinux command-line utilities is </span><strong class="source-inline"><span class="koboSpan" id="kobo.609.1">semanage</span></strong><span class="koboSpan" id="kobo.610.1"> for managing SELinux policies. </span><span class="koboSpan" id="kobo.610.2">We’ll examine this in the </span><em class="italic"><span class="koboSpan" id="kobo.611.1">Managing SELinux policies</span></em><span class="koboSpan" id="kobo.612.1"> section. </span><span class="koboSpan" id="kobo.612.2">But first, let’s look at the necessary steps for creating an SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.613.1">security policy.</span></span></p>
<h3><span class="koboSpan" id="kobo.614.1">Creating an SELinux security policy</span></h3>
<p><span class="koboSpan" id="kobo.615.1">For the examples in this section, we will </span><a id="_idIndexMarker1449"/><span class="koboSpan" id="kobo.616.1">use a program developed in the C programming language. </span><span class="koboSpan" id="kobo.616.2">This means that we will have to compile it, which is different than what we did in the previous chapter. </span><span class="koboSpan" id="kobo.616.3">In order to be able to compile C code, we will need to have the </span><strong class="bold"><span class="koboSpan" id="kobo.617.1">GNU Compiler Collection</span></strong><span class="koboSpan" id="kobo.618.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.619.1">GCC</span></strong><span class="koboSpan" id="kobo.620.1">) on our system. </span><span class="koboSpan" id="kobo.620.2">We will install </span><strong class="source-inline"><span class="koboSpan" id="kobo.621.1">gcc</span></strong><span class="koboSpan" id="kobo.622.1"> on our Fedora system with the </span><span class="No-Break"><span class="koboSpan" id="kobo.623.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.624.1">
sudo dnf install gcc</span></pre> <p><span class="koboSpan" id="kobo.625.1">Now, let’s assume that we </span><a id="_idIndexMarker1450"/><span class="koboSpan" id="kobo.626.1">have a daemon called </span><strong class="source-inline"><span class="koboSpan" id="kobo.627.1">packtd</span></strong><span class="koboSpan" id="kobo.628.1"> and that we need to secure it to access </span><strong class="source-inline"><span class="koboSpan" id="kobo.629.1">/var/log/messages</span></strong><span class="koboSpan" id="kobo.630.1">. </span><span class="koboSpan" id="kobo.630.2">For illustration purposes, the daemon has a straightforward implementation: periodically open the </span><strong class="source-inline"><span class="koboSpan" id="kobo.631.1">/var/log/messages</span></strong><span class="koboSpan" id="kobo.632.1"> file for writing. </span><span class="koboSpan" id="kobo.632.2">Use your favorite text editor (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.633.1">nano</span></strong><span class="koboSpan" id="kobo.634.1">) to add the following content (C code) to a file. </span><span class="koboSpan" id="kobo.634.2">Let’s name the </span><span class="No-Break"><span class="koboSpan" id="kobo.635.1">file </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.636.1">packtd.c</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.637.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer299">
<span class="koboSpan" id="kobo.638.1"><img alt="Figure 9.9 – A simple daemon periodically checking logs" src="image/B19682_09_09.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.639.1">Figure 9.9 – A simple daemon periodically checking logs</span></p>
<p><span class="koboSpan" id="kobo.640.1">Let’s compile and build </span><strong class="source-inline"><span class="koboSpan" id="kobo.641.1">packtd.c</span></strong><span class="koboSpan" id="kobo.642.1"> to generate </span><a id="_idIndexMarker1451"/><span class="koboSpan" id="kobo.643.1">the related binary </span><span class="No-Break"><span class="koboSpan" id="kobo.644.1">executable (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.645.1">packtd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.646.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.647.1">
gcc -o packtd packtd.c</span></pre> <p><span class="koboSpan" id="kobo.648.1">The following is the result of the command used to compile the </span><span class="No-Break"><span class="koboSpan" id="kobo.649.1">source code:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer300">
<span class="koboSpan" id="kobo.650.1"><img alt="Figure 9.10 – Compiling the C source code" src="image/B19682_09_10.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.651.1">Figure 9.10 – Compiling the C source code</span></p>
<p><span class="koboSpan" id="kobo.652.1">Now that the source code has been compiled, we are ready to proceed with the steps for creating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.653.1">packtd</span></strong><span class="koboSpan" id="kobo.654.1"> daemon and the required SELinux security policy. </span><span class="koboSpan" id="kobo.654.2">This exercise is equally useful for SELinux administration and for creating a </span><strong class="source-inline"><span class="koboSpan" id="kobo.655.1">systemd</span></strong><span class="koboSpan" id="kobo.656.1"> daemon. </span><span class="koboSpan" id="kobo.656.2">Please refer to </span><a href="B19682_05.xhtml#_idTextAnchor104"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.657.1">Chapter 5</span></em></span></a><span class="koboSpan" id="kobo.658.1"> if you need to refresh your memory on daemons. </span><span class="koboSpan" id="kobo.658.2">Now, let’s discuss the steps for creating a daemon and a </span><span class="No-Break"><span class="koboSpan" id="kobo.659.1">security policy.</span></span></p>
<h4><span class="koboSpan" id="kobo.660.1">Installing the daemon</span></h4>
<p><span class="koboSpan" id="kobo.661.1">First, we must</span><a id="_idIndexMarker1452"/><span class="koboSpan" id="kobo.662.1"> create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.663.1">systemd</span></strong><span class="koboSpan" id="kobo.664.1"> unit file for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.665.1">packtd</span></strong><span class="koboSpan" id="kobo.666.1"> daemon. </span><span class="koboSpan" id="kobo.666.2">You may use your favorite text editor (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.667.1">nano</span></strong><span class="koboSpan" id="kobo.668.1">) to create the related file. </span><span class="koboSpan" id="kobo.668.2">We will call this </span><span class="No-Break"><span class="koboSpan" id="kobo.669.1">file </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.670.1">packtd.service</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.671.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer301">
<span class="koboSpan" id="kobo.672.1"><img alt="Figure 9.11 – The packtd daemon file" src="image/B19682_09_11.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.673.1">Figure 9.11 – The packtd daemon file</span></p>
<p><span class="koboSpan" id="kobo.674.1">Copy the files we created to their respective locations, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.675.1">/usr/local/bin</span></strong><span class="koboSpan" id="kobo.676.1"> for </span><strong class="source-inline"><span class="koboSpan" id="kobo.677.1">packtd</span></strong><span class="koboSpan" id="kobo.678.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.679.1">/usr/lib/systemd/system/</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.680.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.681.1">packtd.service</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.682.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.683.1">
sudo cp packtd /usr/local/bin/
sudo cp packtd.service /usr/lib/systemd/system/</span></pre> <p><span class="koboSpan" id="kobo.684.1">At this point, we are ready to start our </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.685.1">packtd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.686.1"> daemon:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.687.1">
sudo systemctl start packtd
sudo systemctl status packtd</span></pre> <p><span class="koboSpan" id="kobo.688.1">Let’s make sure the </span><strong class="source-inline"><span class="koboSpan" id="kobo.689.1">packtd</span></strong><span class="koboSpan" id="kobo.690.1"> daemon is not confined or restricted yet </span><span class="No-Break"><span class="koboSpan" id="kobo.691.1">by SELinux:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.692.1">
ps -efZ | grep packtd | grep -v grep</span></pre> <p><span class="koboSpan" id="kobo.693.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.694.1">-Z</span></strong><span class="koboSpan" id="kobo.695.1"> option parameter of </span><strong class="source-inline"><span class="koboSpan" id="kobo.696.1">ps</span></strong><span class="koboSpan" id="kobo.697.1"> retrieves the SELinux context </span><span class="No-Break"><span class="koboSpan" id="kobo.698.1">for processes.</span></span></p>
<p><span class="koboSpan" id="kobo.699.1">The output of all these commands is </span><span class="No-Break"><span class="koboSpan" id="kobo.700.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer302">
<span class="koboSpan" id="kobo.701.1"><img alt="Figure 9.12 – Running status and confinement status of the packtd daemon" src="image/B19682_09_12.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.702.1">Figure 9.12 – Running status and confinement status of the packtd daemon</span></p>
<p><span class="koboSpan" id="kobo.703.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.704.1">unconfined_service_t</span></strong><span class="koboSpan" id="kobo.705.1"> security</span><a id="_idIndexMarker1453"/><span class="koboSpan" id="kobo.706.1"> attribute suggests that </span><strong class="source-inline"><span class="koboSpan" id="kobo.707.1">packtd</span></strong><span class="koboSpan" id="kobo.708.1"> is not restricted </span><span class="No-Break"><span class="koboSpan" id="kobo.709.1">by SELinux.</span></span></p>
<p><span class="koboSpan" id="kobo.710.1">Next, we will generate security policy files for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.711.1">packtd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.712.1"> daemon.</span></span></p>
<h4><span class="koboSpan" id="kobo.713.1">Generating policy files</span></h4>
<p><span class="koboSpan" id="kobo.714.1">To build a security</span><a id="_idIndexMarker1454"/><span class="koboSpan" id="kobo.715.1"> policy for </span><strong class="source-inline"><span class="koboSpan" id="kobo.716.1">packtd</span></strong><span class="koboSpan" id="kobo.717.1">, we need to generate the related policy files. </span><span class="koboSpan" id="kobo.717.2">The SELinux tool for building security policies is </span><strong class="source-inline"><span class="koboSpan" id="kobo.718.1">sepolicy</span></strong><span class="koboSpan" id="kobo.719.1">. </span><span class="koboSpan" id="kobo.719.2">Also, packaging the final security policy binary requires the </span><strong class="source-inline"><span class="koboSpan" id="kobo.720.1">rpm-build</span></strong><span class="koboSpan" id="kobo.721.1"> utility. </span><span class="koboSpan" id="kobo.721.2">These command-line utilities may not be available by default on your system, so you may have to install the related packages using the </span><span class="No-Break"><span class="koboSpan" id="kobo.722.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.723.1">
sudo dnf install -y policycoreutils-devel rpm-build</span></pre> <p><span class="koboSpan" id="kobo.724.1">We will use the next command to generate policy files for </span><strong class="source-inline"><span class="koboSpan" id="kobo.725.1">packtd</span></strong><span class="koboSpan" id="kobo.726.1"> (no superuser </span><span class="No-Break"><span class="koboSpan" id="kobo.727.1">privileges required):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.728.1">
sepolicy generate --init /usr/local/bin/packtd</span></pre> <p><span class="koboSpan" id="kobo.729.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.730.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer303">
<span class="koboSpan" id="kobo.731.1"><img alt="Figure 9.13 – Generating policy files with sepolicy" src="image/B19682_09_13.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.732.1">Figure 9.13 – Generating policy files with sepolicy</span></p>
<p><span class="koboSpan" id="kobo.733.1">Take a moment and</span><a id="_idIndexMarker1455"/><span class="koboSpan" id="kobo.734.1"> look over the preceding screenshot. </span><span class="koboSpan" id="kobo.734.2">You will see that </span><em class="italic"><span class="koboSpan" id="kobo.735.1">five new files</span></em><span class="koboSpan" id="kobo.736.1"> have been created in your home directory. </span><span class="koboSpan" id="kobo.736.2">Keep this in mind, as we will use them during our setup process. </span><span class="koboSpan" id="kobo.736.3">Next, we need to rebuild the system policy so that it includes the custom </span><strong class="source-inline"><span class="koboSpan" id="kobo.737.1">packtd</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.738.1">policy module.</span></span></p>
<h4><span class="koboSpan" id="kobo.739.1">Building the security policy</span></h4>
<p><span class="koboSpan" id="kobo.740.1">To build the</span><a id="_idIndexMarker1456"/><span class="koboSpan" id="kobo.741.1"> security policy, we will now use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.742.1">packtd.sh</span></strong><span class="koboSpan" id="kobo.743.1"> build script that was created in the previous step (see </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.744.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.745.1">.13</span></em><span class="koboSpan" id="kobo.746.1"> for details). </span><span class="koboSpan" id="kobo.746.2">The following command requires superuser privileges since it installs the newly created policy on </span><span class="No-Break"><span class="koboSpan" id="kobo.747.1">the system:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.748.1">
sudo ./packtd.sh</span></pre> <p><span class="koboSpan" id="kobo.749.1">The build takes a relatively long time to complete and yields the following </span><span class="No-Break"><span class="koboSpan" id="kobo.750.1">output (excerpt):</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer304">
<span class="koboSpan" id="kobo.751.1"><img alt="Figure 9.14 – Building the security policy for packtd" src="image/B19682_09_14.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.752.1">Figure 9.14 – Building the security policy for packtd</span></p>
<p><span class="koboSpan" id="kobo.753.1">Please note that the build script reinstates the default </span><em class="italic"><span class="koboSpan" id="kobo.754.1">SELinux</span></em><span class="koboSpan" id="kobo.755.1"> security context for </span><strong class="source-inline"><span class="koboSpan" id="kobo.756.1">packtd</span></strong><span class="koboSpan" id="kobo.757.1"> using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.758.1">restorecon</span></strong><span class="koboSpan" id="kobo.759.1"> command (highlighted in the previous output). </span><span class="koboSpan" id="kobo.759.2">Now that we’ve built the security policy, we’re ready to verify the </span><span class="No-Break"><span class="koboSpan" id="kobo.760.1">related permissions.</span></span></p>
<h4><span class="koboSpan" id="kobo.761.1">Verifying the security policy</span></h4>
<p><span class="koboSpan" id="kobo.762.1">First, we need to restart the </span><strong class="source-inline"><span class="koboSpan" id="kobo.763.1">packtd</span></strong><span class="koboSpan" id="kobo.764.1"> daemon to account for the </span><span class="No-Break"><span class="koboSpan" id="kobo.765.1">policy change:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.766.1">
sudo systemctl restart packtd</span></pre> <p><span class="koboSpan" id="kobo.767.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.768.1">packtd</span></strong><span class="koboSpan" id="kobo.769.1"> process should now reflect the new SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.770.1">security context:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.771.1">
ps -efZ | grep packtd | grep -v grep</span></pre> <p><span class="koboSpan" id="kobo.772.1">The output</span><a id="_idIndexMarker1457"/><span class="koboSpan" id="kobo.773.1"> shows a new label (</span><strong class="source-inline"><span class="koboSpan" id="kobo.774.1">packtd_t</span></strong><span class="koboSpan" id="kobo.775.1">) for our </span><span class="No-Break"><span class="koboSpan" id="kobo.776.1">security context:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer305">
<span class="koboSpan" id="kobo.777.1"><img alt="Figure 9.15 – The new security policy for packtd" src="image/B19682_09_15.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.778.1">Figure 9.15 – The new security policy for packtd</span></p>
<p><span class="koboSpan" id="kobo.779.1">Since SELinux now controls our </span><strong class="source-inline"><span class="koboSpan" id="kobo.780.1">packtd</span></strong><span class="koboSpan" id="kobo.781.1"> daemon, we should see the related audit traces in </span><strong class="source-inline"><span class="koboSpan" id="kobo.782.1">/var/log/messages</span></strong><span class="koboSpan" id="kobo.783.1">, where SELinux logs the system’s activity. </span><span class="koboSpan" id="kobo.783.2">Let’s look at the audit logs for </span><a id="_idIndexMarker1458"/><span class="koboSpan" id="kobo.784.1">any permission issues. </span><span class="koboSpan" id="kobo.784.2">The following command fetches the most recent events for </span><strong class="source-inline"><span class="koboSpan" id="kobo.785.1">AVC</span></strong><span class="koboSpan" id="kobo.786.1"> message types using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.787.1">ausearch</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.788.1"> utility:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.789.1">
sudo ausearch -m AVC -ts recent</span></pre> <p><span class="koboSpan" id="kobo.790.1">We will immediately notice that </span><strong class="source-inline"><span class="koboSpan" id="kobo.791.1">packtd</span></strong><span class="koboSpan" id="kobo.792.1"> has no read/write access </span><span class="No-Break"><span class="koboSpan" id="kobo.793.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.794.1">/var/log/messages</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.795.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer306">
<span class="koboSpan" id="kobo.796.1"><img alt="Figure 9.16 – No read/write access for packtd" src="image/B19682_09_16.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.797.1">Figure 9.16 – No read/write access for packtd</span></p>
<p><span class="koboSpan" id="kobo.798.1">To further inquire about the permissions needed by </span><strong class="source-inline"><span class="koboSpan" id="kobo.799.1">packtd</span></strong><span class="koboSpan" id="kobo.800.1">, we will feed the output of </span><strong class="source-inline"><span class="koboSpan" id="kobo.801.1">ausearch</span></strong><span class="koboSpan" id="kobo.802.1"> into </span><strong class="source-inline"><span class="koboSpan" id="kobo.803.1">audit2allow</span></strong><span class="koboSpan" id="kobo.804.1">, a tool for generating the required security </span><span class="No-Break"><span class="koboSpan" id="kobo.805.1">policy stubs:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.806.1">
sudo ausearch -m AVC -ts recent | audit2allow -R</span></pre> <p><span class="koboSpan" id="kobo.807.1">The output provides the code macro we’re </span><span class="No-Break"><span class="koboSpan" id="kobo.808.1">looking for:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer307">
<span class="koboSpan" id="kobo.809.1"><img alt="Figure 9.17 – Querying the missing permissions for packtd" src="image/B19682_09_17.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.810.1">Figure 9.17 – Querying the missing permissions for packtd</span></p>
<p><span class="koboSpan" id="kobo.811.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.812.1">-R</span></strong><span class="koboSpan" id="kobo.813.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.814.1">--reference</span></strong><span class="koboSpan" id="kobo.815.1">) option of </span><strong class="source-inline"><span class="koboSpan" id="kobo.816.1">audit2allow</span></strong><span class="koboSpan" id="kobo.817.1"> invokes a stub generation task, which could sometimes yield inaccurate or incomplete results. </span><span class="koboSpan" id="kobo.817.2">In such cases, it may take a few iterations to update, rebuild, and </span><a id="_idIndexMarker1459"/><span class="koboSpan" id="kobo.818.1">verify the related security policies. </span><span class="koboSpan" id="kobo.818.2">Let’s proceed with the required changes, as suggested in the output shown in the preceding screenshot. </span><span class="koboSpan" id="kobo.818.3">We’ll edit the </span><em class="italic"><span class="koboSpan" id="kobo.819.1">type enforcement</span></em><span class="koboSpan" id="kobo.820.1"> file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.821.1">packtd.te</span></strong><span class="koboSpan" id="kobo.822.1">) generated previously and add the lines (copy/paste) exactly, as indicated by the output of </span><strong class="source-inline"><span class="koboSpan" id="kobo.823.1">audit2allow</span></strong><span class="koboSpan" id="kobo.824.1">. </span><span class="koboSpan" id="kobo.824.2">The contents of the file are shown in the following screenshot (excerpt). </span><span class="koboSpan" id="kobo.824.3">The lines to be added by us </span><span class="No-Break"><span class="koboSpan" id="kobo.825.1">are highlighted:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer308">
<span class="koboSpan" id="kobo.826.1"><img alt="Figure 9.18 – Editing the packtd.te file" src="image/B19682_09_18.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.827.1">Figure 9.18 – Editing the packtd.te file</span></p>
<p><span class="koboSpan" id="kobo.828.1">After saving the file, we need to rebuild the security policy, restart the </span><strong class="source-inline"><span class="koboSpan" id="kobo.829.1">packtd</span></strong><span class="koboSpan" id="kobo.830.1"> daemon, and verify the audit logs. </span><span class="koboSpan" id="kobo.830.2">We’re reiterating the last three steps in our </span><span class="No-Break"><span class="koboSpan" id="kobo.831.1">overall procedure:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.832.1">
sudo ./packtd.sh
sudo systemctl restart packtd
sudo ausearch -m AVC -ts recent | audit2allow -R</span></pre> <p><span class="koboSpan" id="kobo.833.1">This time, the SELinux audit should come </span><span class="No-Break"><span class="koboSpan" id="kobo.834.1">out clean:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer309">
<span class="koboSpan" id="kobo.835.1"><img alt="Figure 9.19 – No more permission issues for packtd" src="image/B19682_09_19.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.836.1">Figure 9.19 – No more permission issues for packtd</span></p>
<p><span class="koboSpan" id="kobo.837.1">Sometimes, it may take a</span><a id="_idIndexMarker1460"/><span class="koboSpan" id="kobo.838.1"> little while for </span><strong class="source-inline"><span class="koboSpan" id="kobo.839.1">ausearch</span></strong><span class="koboSpan" id="kobo.840.1"> to refresh its </span><strong class="source-inline"><span class="koboSpan" id="kobo.841.1">recent</span></strong><span class="koboSpan" id="kobo.842.1"> buffer. </span><span class="koboSpan" id="kobo.842.2">Alternatively, we can specify a starting timestamp to analyze from, such as after we’ve updated the security policy, using a relatively </span><span class="No-Break"><span class="koboSpan" id="kobo.843.1">recent timestamp:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.844.1">
sudo ausearch --start 04/19/2023 '17:30:00' | audit2allow -R</span></pre> <p><span class="koboSpan" id="kobo.845.1">Now that we’ve created our own SELinux security policy, let’s understand how it can </span><span class="No-Break"><span class="koboSpan" id="kobo.846.1">be managed.</span></span></p>
<h3><span class="koboSpan" id="kobo.847.1">Managing SELinux policies</span></h3>
<p><span class="koboSpan" id="kobo.848.1">SELinux provides several</span><a id="_idIndexMarker1461"/><span class="koboSpan" id="kobo.849.1"> utilities for managing security policies and modules, some of which will be briefly described in the </span><em class="italic"><span class="koboSpan" id="kobo.850.1">Troubleshooting SELinux issues</span></em><span class="koboSpan" id="kobo.851.1"> section. </span><span class="koboSpan" id="kobo.851.2">Examining each of these tools is beyond the scope of this chapter, but we’ll take </span><strong class="source-inline"><span class="koboSpan" id="kobo.852.1">semanage</span></strong><span class="koboSpan" id="kobo.853.1"> for a quick spin to reflect on some use cases involving security </span><span class="No-Break"><span class="koboSpan" id="kobo.854.1">policy management.</span></span></p>
<p><span class="koboSpan" id="kobo.855.1">The general syntax of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.856.1">semanage</span></strong><span class="koboSpan" id="kobo.857.1"> command is </span><span class="No-Break"><span class="koboSpan" id="kobo.858.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.859.1">
semanage TARGET [OPTIONS]</span></pre> <p><strong class="source-inline"><span class="koboSpan" id="kobo.860.1">TARGET</span></strong><span class="koboSpan" id="kobo.861.1"> usually denotes a specific namespace for policy definitions (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.862.1">login</span></strong><span class="koboSpan" id="kobo.863.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.864.1">user</span></strong><span class="koboSpan" id="kobo.865.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.866.1">port</span></strong><span class="koboSpan" id="kobo.867.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.868.1">fcontext</span></strong><span class="koboSpan" id="kobo.869.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.870.1">boolean</span></strong><span class="koboSpan" id="kobo.871.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.872.1">permissive</span></strong><span class="koboSpan" id="kobo.873.1">, and so on). </span><span class="koboSpan" id="kobo.873.2">Let’s look at a few examples to get an idea of how </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.874.1">semanage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.875.1"> works.</span></span></p>
<h4><span class="koboSpan" id="kobo.876.1">Enabling secure binding on custom ports</span></h4>
<p><span class="koboSpan" id="kobo.877.1">Let’s assume we want to enable SELinux for a custom SSH port instead of the default </span><strong class="source-inline"><span class="koboSpan" id="kobo.878.1">22</span></strong><span class="koboSpan" id="kobo.879.1">. </span><span class="koboSpan" id="kobo.879.2">We can retrieve the current security records (labels) on the SSH port with the </span><span class="No-Break"><span class="koboSpan" id="kobo.880.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.881.1">
sudo semanage port -l | grep ssh</span></pre> <p><span class="koboSpan" id="kobo.882.1">For a default configuration, we will get the output shown in </span><em class="italic"><span class="koboSpan" id="kobo.883.1">line 2</span></em><span class="koboSpan" id="kobo.884.1"> in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.885.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.886.1">.20</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.887.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.888.1">If we want to enable SSH on </span><a id="_idIndexMarker1462"/><span class="koboSpan" id="kobo.889.1">a different port (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.890.1">2222</span></strong><span class="koboSpan" id="kobo.891.1">), first, we need to configure the related service (</span><strong class="source-inline"><span class="koboSpan" id="kobo.892.1">sshd</span></strong><span class="koboSpan" id="kobo.893.1">) to listen on a different port (shown in </span><a href="B19682_13.xhtml#_idTextAnchor276"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.894.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.895.1">). </span><span class="koboSpan" id="kobo.895.2">We won’t go into those details here. </span><span class="koboSpan" id="kobo.895.3">Here, we need to enable the secure binding on the new port with the </span><span class="No-Break"><span class="koboSpan" id="kobo.896.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.897.1">
sudo semanage port -a -t ssh_port_t -p tcp 2222</span></pre> <p><span class="koboSpan" id="kobo.898.1">Here’s a brief explanation of the </span><span class="No-Break"><span class="koboSpan" id="kobo.899.1">preceding command:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.900.1">-a</span></strong><span class="koboSpan" id="kobo.901.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.902.1">--add</span></strong><span class="koboSpan" id="kobo.903.1">): Adds a new record (label) for the </span><span class="No-Break"><span class="koboSpan" id="kobo.904.1">given type</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.905.1">-t ssh_port_t</span></strong><span class="koboSpan" id="kobo.906.1">: The SELinux type of </span><span class="No-Break"><span class="koboSpan" id="kobo.907.1">the object</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.908.1">-p tcp</span></strong><span class="koboSpan" id="kobo.909.1">: The network protocol associated with </span><span class="No-Break"><span class="koboSpan" id="kobo.910.1">the port</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.911.1">As a result of the previous command and the output for the default configuration, the new security policy for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.912.1">ssh_port_t</span></strong><span class="koboSpan" id="kobo.913.1"> type looks </span><span class="No-Break"><span class="koboSpan" id="kobo.914.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer310">
<span class="koboSpan" id="kobo.915.1"><img alt="Figure 9.20 – Querying and changing the SELinux security label for the SSH port" src="image/B19682_09_20.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.916.1">Figure 9.20 – Querying and changing the SELinux security label for the SSH port</span></p>
<p><span class="koboSpan" id="kobo.917.1">We could arguably delete the old security label (for port </span><strong class="source-inline"><span class="koboSpan" id="kobo.918.1">22</span></strong><span class="koboSpan" id="kobo.919.1">), but that won’t really matter if we disable port </span><strong class="source-inline"><span class="koboSpan" id="kobo.920.1">22</span></strong><span class="koboSpan" id="kobo.921.1">. </span><span class="koboSpan" id="kobo.921.2">If we want to delete a port security record, we can do so with the </span><span class="No-Break"><span class="koboSpan" id="kobo.922.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.923.1">
sudo semanage port -d -p tcp 22</span></pre> <p><span class="koboSpan" id="kobo.924.1">We used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.925.1">-d</span></strong><span class="koboSpan" id="kobo.926.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.927.1">--delete</span></strong><span class="koboSpan" id="kobo.928.1">) option to remove the related security label. </span><span class="koboSpan" id="kobo.928.2">To view the local customization for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.929.1">semanage port</span></strong><span class="koboSpan" id="kobo.930.1"> policies, we can invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.931.1">-C</span></strong><span class="koboSpan" id="kobo.932.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.933.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.934.1">locallist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.935.1">) option:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.936.1">
sudo semanage port -l -C</span></pre> <p><span class="koboSpan" id="kobo.937.1">For more information on </span><strong class="source-inline"><span class="koboSpan" id="kobo.938.1">semanage port</span></strong><span class="koboSpan" id="kobo.939.1">, you may refer to the related system reference (</span><strong class="source-inline"><span class="koboSpan" id="kobo.940.1">man semanage port</span></strong><span class="koboSpan" id="kobo.941.1">). </span><span class="koboSpan" id="kobo.941.2">Next, we’ll look at how</span><a id="_idIndexMarker1463"/><span class="koboSpan" id="kobo.942.1"> to modify security permissions for specific </span><span class="No-Break"><span class="koboSpan" id="kobo.943.1">server applications.</span></span></p>
<h4><span class="koboSpan" id="kobo.944.1">Modifying security permissions for targeted services</span></h4>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.945.1">semanage</span></strong><span class="koboSpan" id="kobo.946.1"> uses the </span><strong class="source-inline"><span class="koboSpan" id="kobo.947.1">boolean</span></strong><span class="koboSpan" id="kobo.948.1"> namespace to toggle specific features of targeted services on and off. </span><span class="koboSpan" id="kobo.948.2">A targeted service is a </span><a id="_idIndexMarker1464"/><span class="koboSpan" id="kobo.949.1">daemon with built-in SELinux protection. </span><span class="koboSpan" id="kobo.949.2">In the following example, we want to enable FTP over HTTP connections. </span><span class="koboSpan" id="kobo.949.3">By default, this security feature of Apache (</span><strong class="source-inline"><span class="koboSpan" id="kobo.950.1">httpd</span></strong><span class="koboSpan" id="kobo.951.1">) is turned off. </span><span class="koboSpan" id="kobo.951.2">Installation of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.952.1">httpd</span></strong><span class="koboSpan" id="kobo.953.1"> server is shown in </span><a href="B19682_13.xhtml#_idTextAnchor276"><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.954.1">Chapter 13</span></em></span></a><span class="koboSpan" id="kobo.955.1">. </span><span class="koboSpan" id="kobo.955.2">Let’s query the related </span><strong class="source-inline"><span class="koboSpan" id="kobo.956.1">httpd</span></strong><span class="koboSpan" id="kobo.957.1"> security policies with the </span><span class="No-Break"><span class="koboSpan" id="kobo.958.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.959.1">
sudo semanage boolean -l | grep httpd | grep ftp</span></pre> <p><span class="koboSpan" id="kobo.960.1">We get the </span><span class="No-Break"><span class="koboSpan" id="kobo.961.1">following output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer311">
<span class="koboSpan" id="kobo.962.1"><img alt="Figure 9.21 – Querying httpd policies related to FTP" src="image/B19682_09_21.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.963.1">Figure 9.21 – Querying httpd policies related to FTP</span></p>
<p><span class="koboSpan" id="kobo.964.1">As we can see, the related feature—</span><strong class="source-inline"><span class="koboSpan" id="kobo.965.1">httpd_enable_ftp_server</span></strong><span class="koboSpan" id="kobo.966.1">—is turned </span><strong class="source-inline"><span class="koboSpan" id="kobo.967.1">off</span></strong><span class="koboSpan" id="kobo.968.1"> by default. </span><span class="koboSpan" id="kobo.968.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.969.1">current</span></strong><span class="koboSpan" id="kobo.970.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.971.1">persisted</span></strong><span class="koboSpan" id="kobo.972.1"> states are currently off: </span><strong class="source-inline"><span class="koboSpan" id="kobo.973.1">(off, off)</span></strong><span class="koboSpan" id="kobo.974.1">. </span><span class="koboSpan" id="kobo.974.2">We can enable it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.975.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.976.1">
sudo semanage boolean -m --on httpd_enable_ftp_server</span></pre> <p><span class="koboSpan" id="kobo.977.1">To view the local customizations of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.978.1">semanage boolean</span></strong><span class="koboSpan" id="kobo.979.1"> policies, we can invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.980.1">-C</span></strong><span class="koboSpan" id="kobo.981.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.982.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.983.1">locallist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.984.1">) option:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.985.1">
sudo semanage boolean -l -C</span></pre> <p><span class="koboSpan" id="kobo.986.1">The new configuration now looks </span><span class="No-Break"><span class="koboSpan" id="kobo.987.1">like this:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer312">
<span class="koboSpan" id="kobo.988.1"><img alt="Figure 9.22 – Enabling the security policy for FTP over HTTP" src="image/B19682_09_22.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.989.1">Figure 9.22 – Enabling the security policy for FTP over HTTP</span></p>
<p><span class="koboSpan" id="kobo.990.1">In the preceding</span><a id="_idIndexMarker1465"/><span class="koboSpan" id="kobo.991.1"> example, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.992.1">-m</span></strong><span class="koboSpan" id="kobo.993.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.994.1">--modify</span></strong><span class="koboSpan" id="kobo.995.1">) option with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.996.1">semanage boolean</span></strong><span class="koboSpan" id="kobo.997.1"> command to toggle the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.998.1">httpd_enable_ftp_server</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.999.1"> feature.</span></span></p>
<p><span class="koboSpan" id="kobo.1000.1">For more information on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1001.1">semanage boolean</span></strong><span class="koboSpan" id="kobo.1002.1">, you may refer to the related system reference (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1003.1">man semanage boolean</span></strong><span class="koboSpan" id="kobo.1004.1">). </span><span class="koboSpan" id="kobo.1004.2">Now, let’s learn how to modify the security context of specific </span><span class="No-Break"><span class="koboSpan" id="kobo.1005.1">server applications.</span></span></p>
<h4><span class="koboSpan" id="kobo.1006.1">Modifying security contexts for targeted services</span></h4>
<p><span class="koboSpan" id="kobo.1007.1">In this example, we want to </span><a id="_idIndexMarker1466"/><span class="koboSpan" id="kobo.1008.1">secure SSH keys stored in a custom location on the local system. </span><span class="koboSpan" id="kobo.1008.2">Since we’re targeting a filesystem-related security policy, we will use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1009.1">fcontext</span></strong><span class="koboSpan" id="kobo.1010.1"> (file context) namespace </span><span class="No-Break"><span class="koboSpan" id="kobo.1011.1">with </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1012.1">semanage</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1013.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1014.1">The following command queries the file context security settings </span><span class="No-Break"><span class="koboSpan" id="kobo.1015.1">for </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1016.1">sshd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1017.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1018.1">
sudo semanage fcontext -l | grep sshd</span></pre> <p><span class="koboSpan" id="kobo.1019.1">Here’s a relevant excerpt from </span><span class="No-Break"><span class="koboSpan" id="kobo.1020.1">the output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer313">
<span class="koboSpan" id="kobo.1021.1"><img alt="Figure 9.23 – The security context of SSH keys" src="image/B19682_09_23.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1022.1">Figure 9.23 – The security context of SSH keys</span></p>
<p><span class="koboSpan" id="kobo.1023.1">The following command also adds the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1024.1">/etc/ssh/keys/</span></strong><span class="koboSpan" id="kobo.1025.1"> path to the secure locations associated with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1026.1">sshd_key_t</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.1027.1">context type:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1028.1">
sudo semanage fcontext -a -t sshd_key_t '/etc/ssh/keys(/.*)?'</span></pre> <p><span class="koboSpan" id="kobo.1029.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1030.1">'/etc/ssh/keys(/.*)?'</span></strong><span class="koboSpan" id="kobo.1031.1"> regular expression matches any files in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1032.1">/etc/ssh/keys/</span></strong><span class="koboSpan" id="kobo.1033.1"> directory, including subdirectories at any nested level. </span><span class="koboSpan" id="kobo.1033.2">To view the local customizations of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1034.1">semanage fcontext</span></strong><span class="koboSpan" id="kobo.1035.1"> policies, we can invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1036.1">-C</span></strong><span class="koboSpan" id="kobo.1037.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1038.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1039.1">locallist</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1040.1">) option:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1041.1">
sudo semanage fcontext -l -C</span><a id="_idIndexMarker1467"/><span class="koboSpan" id="kobo.1042.1">We should see our new security context:</span></pre> <div>
<div class="IMG---Figure" id="_idContainer314">
<span class="koboSpan" id="kobo.1043.1"><img alt="Figure 9.24 – The modified security context of our SSH keys" src="image/B19682_09_24.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1044.1">Figure 9.24 – The modified security context of our SSH keys</span></p>
<p><span class="koboSpan" id="kobo.1045.1">We should also initialize the filesystem security context of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1046.1">/etc/ssh/keys</span></strong><span class="koboSpan" id="kobo.1047.1"> directory (if we’ve already created it; otherwise, we would get an </span><span class="No-Break"><span class="koboSpan" id="kobo.1048.1">error message):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1049.1">
sudo restorecon -r /etc/ssh/keys</span></pre> <p><strong class="source-inline"><span class="koboSpan" id="kobo.1050.1">restorecon</span></strong><span class="koboSpan" id="kobo.1051.1"> is an SELinux utility for restoring the default security context to a filesystem object. </span><span class="koboSpan" id="kobo.1051.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1052.1">-r</span></strong><span class="koboSpan" id="kobo.1053.1"> (or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1054.1">-R</span></strong><span class="koboSpan" id="kobo.1055.1">) option specifies a recursive action on the </span><span class="No-Break"><span class="koboSpan" id="kobo.1056.1">related path.</span></span></p>
<p><span class="koboSpan" id="kobo.1057.1">For more information on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1058.1">semanage fcontext</span></strong><span class="koboSpan" id="kobo.1059.1">, you may refer to the related system reference (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1060.1">man semanage fcontext</span></strong><span class="koboSpan" id="kobo.1061.1">). </span><span class="koboSpan" id="kobo.1061.2">Next, we’ll look at enabling the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1062.1">permissive</span></strong><span class="koboSpan" id="kobo.1063.1"> mode of specific </span><span class="No-Break"><span class="koboSpan" id="kobo.1064.1">server applications.</span></span></p>
<h4><span class="koboSpan" id="kobo.1065.1">Enabling permissive mode for targeted services</span></h4>
<p><span class="koboSpan" id="kobo.1066.1">Earlier in this chapter, we</span><a id="_idIndexMarker1468"/><span class="koboSpan" id="kobo.1067.1"> created a custom daemon (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1068.1">packtd</span></strong><span class="koboSpan" id="kobo.1069.1">) with its security policy. </span><span class="koboSpan" id="kobo.1069.2">See the related topic in the </span><em class="italic"><span class="koboSpan" id="kobo.1070.1">Creating an SELinux security policy</span></em><span class="koboSpan" id="kobo.1071.1"> section earlier in this chapter. </span><span class="koboSpan" id="kobo.1071.2">During the entire process, we were able to run and test with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1072.1">packtd</span></strong><span class="koboSpan" id="kobo.1073.1"> without having the daemon shut down by SELinux due to non-compliance. </span><span class="koboSpan" id="kobo.1073.2">Our Linux system runs SELinux in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1074.1">enforcing</span></strong><span class="koboSpan" id="kobo.1075.1"> mode (by default) and is not permissive. </span><span class="koboSpan" id="kobo.1075.2">See the </span><em class="italic"><span class="koboSpan" id="kobo.1076.1">Understanding SELinux modes</span></em><span class="koboSpan" id="kobo.1077.1"> section for more information on </span><strong class="source-inline"><span class="koboSpan" id="kobo.1078.1">enforcing</span></strong><span class="koboSpan" id="kobo.1079.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1080.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1081.1"> modes.</span></span></p>
<p><span class="koboSpan" id="kobo.1082.1">By default, SELinux is permissive to any </span><em class="italic"><span class="koboSpan" id="kobo.1083.1">untargeted</span></em><span class="koboSpan" id="kobo.1084.1"> type in the system. </span><span class="koboSpan" id="kobo.1084.2">By </span><em class="italic"><span class="koboSpan" id="kobo.1085.1">untargeted</span></em><span class="koboSpan" id="kobo.1086.1">, we mean a domain (type) that hasn’t been forced into a restrictive (or confined) </span><span class="No-Break"><span class="koboSpan" id="kobo.1087.1">mode yet.</span></span></p>
<p><span class="koboSpan" id="kobo.1088.1">When we built the security</span><a id="_idIndexMarker1469"/><span class="koboSpan" id="kobo.1089.1"> policy for our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1090.1">packtd</span></strong><span class="koboSpan" id="kobo.1091.1"> daemon, we let the related SELinux build tools generate the default type enforcement file (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1092.1">packt.te</span></strong><span class="koboSpan" id="kobo.1093.1">) and other resources for our domain. </span><span class="koboSpan" id="kobo.1093.2">A quick look at the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1094.1">packt.te</span></strong><span class="koboSpan" id="kobo.1095.1"> file shows that our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1096.1">packtd_t</span></strong><span class="koboSpan" id="kobo.1097.1"> type </span><span class="No-Break"><span class="koboSpan" id="kobo.1098.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1099.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1100.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1101.1">
cat packt.te</span></pre> <p><span class="koboSpan" id="kobo.1102.1">Here’s the relevant excerpt from </span><span class="No-Break"><span class="koboSpan" id="kobo.1103.1">the file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer315">
<span class="koboSpan" id="kobo.1104.1"><img alt="Figure 9.25 – The packtd_t domain is permissive" src="image/B19682_09_25.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1105.1">Figure 9.25 – The packtd_t domain is permissive</span></p>
<p><span class="koboSpan" id="kobo.1106.1">So, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1107.1">packtd_t</span></strong><span class="koboSpan" id="kobo.1108.1"> domain is permissive by nature. </span><span class="koboSpan" id="kobo.1108.2">The only way to confine </span><strong class="source-inline"><span class="koboSpan" id="kobo.1109.1">packtd</span></strong><span class="koboSpan" id="kobo.1110.1"> is to remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1111.1">permissive</span></strong><span class="koboSpan" id="kobo.1112.1"> line from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1113.1">packtd.te</span></strong><span class="koboSpan" id="kobo.1114.1"> file and rebuild the related security policy. </span><span class="koboSpan" id="kobo.1114.2">We will leave that as an exercise for you. </span><span class="koboSpan" id="kobo.1114.3">The case we wanted to make here was to present a possibly misbehaving—in our case, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1115.1">permissive</span></strong><span class="koboSpan" id="kobo.1116.1">—domain that we can </span><em class="italic"><span class="koboSpan" id="kobo.1117.1">catch</span></em><span class="koboSpan" id="kobo.1118.1"> by managing </span><strong class="source-inline"><span class="koboSpan" id="kobo.1119.1">permissive</span></strong><span class="koboSpan" id="kobo.1120.1"> types with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1121.1">semanage </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1122.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1123.1"> command.</span></span></p>
<p><span class="koboSpan" id="kobo.1124.1">To manage </span><strong class="source-inline"><span class="koboSpan" id="kobo.1125.1">permissive</span></strong><span class="koboSpan" id="kobo.1126.1"> mode for individual targets, we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1127.1">semanage</span></strong><span class="koboSpan" id="kobo.1128.1"> command with</span><a id="_idIndexMarker1470"/><span class="koboSpan" id="kobo.1129.1"> our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1130.1">permissive</span></strong><span class="koboSpan" id="kobo.1131.1"> namespace. </span><span class="koboSpan" id="kobo.1131.2">The following command lists all the domains (types) currently in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1132.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1133.1"> mode:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1134.1">
sudo semanage permissive -l</span></pre> <p><span class="koboSpan" id="kobo.1135.1">In our case, we have the built-in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1136.1">packtd_t</span></strong><span class="koboSpan" id="kobo.1137.1"> domain, which </span><span class="No-Break"><span class="koboSpan" id="kobo.1138.1">is </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1139.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1140.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer316">
<span class="koboSpan" id="kobo.1141.1"><img alt="Figure 9.26 – Displaying permissive types" src="image/B19682_09_26.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1142.1">Figure 9.26 – Displaying permissive types</span></p>
<p><span class="koboSpan" id="kobo.1143.1">In general, it is unlikely that</span><a id="_idIndexMarker1471"/><span class="koboSpan" id="kobo.1144.1"> a default SELinux configuration would have any </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1145.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1146.1"> types.</span></span></p>
<p><span class="koboSpan" id="kobo.1147.1">We can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1148.1">semanage permissive</span></strong><span class="koboSpan" id="kobo.1149.1"> command to temporarily place a restricted domain into </span><strong class="source-inline"><span class="koboSpan" id="kobo.1150.1">permissive</span></strong><span class="koboSpan" id="kobo.1151.1"> mode while testing or troubleshooting a specific functionality. </span><span class="koboSpan" id="kobo.1151.2">For example, the following command sets the Apache (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1152.1">httpd</span></strong><span class="koboSpan" id="kobo.1153.1">) daemon in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1154.1">permissive</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1155.1"> mode:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1156.1">
sudo semanage permissive -a httpd_t</span></pre> <p><span class="koboSpan" id="kobo.1157.1">When we query for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1158.1">permissive</span></strong><span class="koboSpan" id="kobo.1159.1"> types, we get the </span><span class="No-Break"><span class="koboSpan" id="kobo.1160.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer317">
<span class="koboSpan" id="kobo.1161.1"><img alt="Figure 9.27 – Customized permissive types" src="image/B19682_09_27.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1162.1">Figure 9.27 – Customized permissive types</span></p>
<p><span class="koboSpan" id="kobo.1163.1">Domains or types that are made permissive with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1164.1">semanage permissive</span></strong><span class="koboSpan" id="kobo.1165.1"> command will show up as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1166.1">Customized </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1167.1">Permissive Types</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1168.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1169.1">To revert the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1170.1">httpd_t</span></strong><span class="koboSpan" id="kobo.1171.1"> domain to the confined (restricted) state, we can invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1172.1">semanage permissive</span></strong><span class="koboSpan" id="kobo.1173.1"> command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1174.1">-d</span></strong><span class="koboSpan" id="kobo.1175.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1176.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1177.1">delete</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1178.1">) option:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1179.1">
sudo semanage permissive -d httpd_t</span></pre> <p><span class="koboSpan" id="kobo.1180.1">The output of the command is </span><span class="No-Break"><span class="koboSpan" id="kobo.1181.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer318">
<span class="koboSpan" id="kobo.1182.1"><img alt="Figure 9.28 – Reverting permissive types" src="image/B19682_09_28.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1183.1">Figure 9.28 – Reverting permissive types</span></p>
<p><span class="koboSpan" id="kobo.1184.1">Note that we cannot confine built-in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1185.1">permissive</span></strong><span class="koboSpan" id="kobo.1186.1"> types with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1187.1">semanage</span></strong><span class="koboSpan" id="kobo.1188.1"> command. </span><span class="koboSpan" id="kobo.1188.2">As we mentioned previously, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1189.1">packtd_t</span></strong><span class="koboSpan" id="kobo.1190.1"> domain is permissive by nature and cannot </span><span class="No-Break"><span class="koboSpan" id="kobo.1191.1">be restricted.</span></span></p>
<p><span class="koboSpan" id="kobo.1192.1">At this point, we</span><a id="_idIndexMarker1472"/><span class="koboSpan" id="kobo.1193.1"> have a basic understanding of SELinux security policy internals. </span><span class="koboSpan" id="kobo.1193.2">Next, we’ll turn to some higher-level operations for managing and controlling SELinux in everyday </span><span class="No-Break"><span class="koboSpan" id="kobo.1194.1">administration tasks.</span></span></p>
<h3><span class="koboSpan" id="kobo.1195.1">Troubleshooting SELinux issues</span></h3>
<p><span class="koboSpan" id="kobo.1196.1">Even during our </span><a id="_idIndexMarker1473"/><span class="koboSpan" id="kobo.1197.1">relatively brief journey of exploring SELinux, we used a handful of tools and means to inspect some internal workings of security policies and access control between subjects (users and processes) and objects (files). </span><span class="koboSpan" id="kobo.1197.2">SELinux’s problems usually come down to action being denied, either between specific subjects or between a subject and some objects. </span><span class="koboSpan" id="kobo.1197.3">SELinux-related issues are not always obvious or easy to troubleshoot, but knowing about the tools that can help is already a good start for tackling </span><span class="No-Break"><span class="koboSpan" id="kobo.1198.1">these issues.</span></span></p>
<p><span class="koboSpan" id="kobo.1199.1">Here are some of these tools, </span><span class="No-Break"><span class="koboSpan" id="kobo.1200.1">briefly explained:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1201.1">/var/log/messages</span></strong><span class="koboSpan" id="kobo.1202.1">: The log file containing SELinux access control traces and </span><span class="No-Break"><span class="koboSpan" id="kobo.1203.1">policy violations</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1204.1">audit2allow</span></strong><span class="koboSpan" id="kobo.1205.1">: Generates SELinux policy rules from the log traces corresponding to </span><span class="No-Break"><span class="koboSpan" id="kobo.1206.1">denied operations</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1207.1">audit2why</span></strong><span class="koboSpan" id="kobo.1208.1">: Provides user-friendly translations of SELinux audit messages of </span><span class="No-Break"><span class="koboSpan" id="kobo.1209.1">policy violations</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1210.1">ausearch</span></strong><span class="koboSpan" id="kobo.1211.1">: Queries </span><strong class="source-inline"><span class="koboSpan" id="kobo.1212.1">/var/log/messages</span></strong><span class="koboSpan" id="kobo.1213.1"> for </span><span class="No-Break"><span class="koboSpan" id="kobo.1214.1">policy violations</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1215.1">ls -Z</span></strong><span class="koboSpan" id="kobo.1216.1">: Lists filesystem objects with their corresponding </span><span class="No-Break"><span class="koboSpan" id="kobo.1217.1">SELinux context</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1218.1">ps -Z</span></strong><span class="koboSpan" id="kobo.1219.1">: Lists processes with their corresponding </span><span class="No-Break"><span class="koboSpan" id="kobo.1220.1">SELinux context</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1221.1">restorecon</span></strong><span class="koboSpan" id="kobo.1222.1">: Restores the default SELinux context for </span><span class="No-Break"><span class="koboSpan" id="kobo.1223.1">filesystem objects</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1224.1">seinfo</span></strong><span class="koboSpan" id="kobo.1225.1">: Provides general information about SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.1226.1">security policies</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1227.1">semanage</span></strong><span class="koboSpan" id="kobo.1228.1">: Manages and provides insight into </span><span class="No-Break"><span class="koboSpan" id="kobo.1229.1">SELinux policies</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1230.1">semodule</span></strong><span class="koboSpan" id="kobo.1231.1">: Manages SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.1232.1">policy modules</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1233.1">sepolicy</span></strong><span class="koboSpan" id="kobo.1234.1">: Inspects </span><span class="No-Break"><span class="koboSpan" id="kobo.1235.1">SELinux policies</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1236.1">sesearch</span></strong><span class="koboSpan" id="kobo.1237.1">: Queries </span><a id="_idIndexMarker1474"/><span class="koboSpan" id="kobo.1238.1">the SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.1239.1">policy database</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1240.1">For most of these tools, there is a corresponding system reference (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.1241.1">man sesearch</span></strong><span class="koboSpan" id="kobo.1242.1">) that provides detailed information about using the tool. </span><span class="koboSpan" id="kobo.1242.2">Beyond these tools, you can also explore the vast documentation SELinux has to offer. </span><span class="No-Break"><span class="koboSpan" id="kobo.1243.1">Here’s how.</span></span></p>
<h3><span class="koboSpan" id="kobo.1244.1">Accessing SELinux documentation</span></h3>
<p><span class="koboSpan" id="kobo.1245.1">SELinux has extensive </span><a id="_idIndexMarker1475"/><span class="koboSpan" id="kobo.1246.1">documentation, available as an RHEL/Fedora installable package or online at </span><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/index"><span class="koboSpan" id="kobo.1247.1">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/using_selinux/index</span></a><span class="koboSpan" id="kobo.1248.1"> (for </span><span class="No-Break"><span class="koboSpan" id="kobo.1249.1">RHEL 9).</span></span></p>
<p><span class="koboSpan" id="kobo.1250.1">The following command installs the SELinux documentation on RHEL </span><span class="No-Break"><span class="koboSpan" id="kobo.1251.1">9 systems:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1252.1">
sudo dnf install -y selinux-policy-doc.noarch</span></pre> <p><span class="koboSpan" id="kobo.1253.1">You can browse a particular SELinux topic with (for example) the </span><span class="No-Break"><span class="koboSpan" id="kobo.1254.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1255.1">
man -k selinux | grep httpd</span></pre> <p><span class="koboSpan" id="kobo.1256.1">SELinux is among the most established and highly customizable security frameworks in the Linux kernel. </span><span class="koboSpan" id="kobo.1256.2">However, its relatively vast domain and inherent complexity may appear overwhelming to many. </span><span class="koboSpan" id="kobo.1256.3">Sometimes, even for seasoned system administrators, the choice of a Linux distribution could hang in the balance based on the underlying security module. </span><span class="koboSpan" id="kobo.1256.4">SELinux is mostly available on RHEL/Fedora platforms, but it is also available as an option on </span><strong class="bold"><span class="koboSpan" id="kobo.1257.1">SUSE Linux Enterprise</span></strong><span class="koboSpan" id="kobo.1258.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1259.1">SLE</span></strong><span class="koboSpan" id="kobo.1260.1">). </span><span class="koboSpan" id="kobo.1260.2">Google’s Android also has SELinux available, and Debian also has it as an available option. </span><span class="koboSpan" id="kobo.1260.3">Another relatively lighter and more efficient security framework is </span><strong class="bold"><span class="koboSpan" id="kobo.1261.1">AppArmor</span></strong><span class="koboSpan" id="kobo.1262.1">, and it is available by default on Ubuntu, Debian, and openSUSE. </span><span class="koboSpan" id="kobo.1262.2">Let us explore it in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1263.1">next section.</span></span></p>
<h1 id="_idParaDest-184"><a id="_idTextAnchor200"/><span class="koboSpan" id="kobo.1264.1">Introducing AppArmor</span></h1>
<p><strong class="bold"><span class="koboSpan" id="kobo.1265.1">AppArmor</span></strong><span class="koboSpan" id="kobo.1266.1"> is a Linux security module based on the MAC model that confines applications to a limited set of resources. </span><span class="koboSpan" id="kobo.1266.2">AppArmor uses an access control mechanism based on security profiles that have been loaded into the Linux kernel. </span><span class="koboSpan" id="kobo.1266.3">Each profile contains a collection of rules for accessing </span><a id="_idIndexMarker1476"/><span class="koboSpan" id="kobo.1267.1">various system resources. </span><span class="koboSpan" id="kobo.1267.2">AppArmor can be configured to either enforce access control or just complain about access </span><span class="No-Break"><span class="koboSpan" id="kobo.1268.1">control violations.</span></span></p>
<p><span class="koboSpan" id="kobo.1269.1">AppArmor proactively protects applications and operating system resources from internal and external threats, including zero-day attacks, by preventing both known and unknown vulnerabilities from </span><span class="No-Break"><span class="koboSpan" id="kobo.1270.1">being exploited.</span></span></p>
<p><span class="koboSpan" id="kobo.1271.1">AppArmor has been built into the mainline Linux kernel since version 2.6.36 and is currently shipped with Ubuntu, Debian, openSUSE, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1272.1">similar distributions.</span></span></p>
<p><span class="koboSpan" id="kobo.1273.1">In the following sections. </span><span class="koboSpan" id="kobo.1273.2">we’ll use an Ubuntu Server 22.04 LTS environment to showcase a few practical examples with AppArmor. </span><span class="koboSpan" id="kobo.1273.3">Most of the related command-line utilities will work the same on any platform with </span><span class="No-Break"><span class="koboSpan" id="kobo.1274.1">AppArmor installed.</span></span></p>
<h2 id="_idParaDest-185"><a id="_idTextAnchor201"/><span class="koboSpan" id="kobo.1275.1">Working with AppArmor</span></h2>
<p><span class="koboSpan" id="kobo.1276.1">AppArmor command-line</span><a id="_idIndexMarker1477"/><span class="koboSpan" id="kobo.1277.1"> utilities usually require superuser privileges. </span><span class="koboSpan" id="kobo.1277.2">The following command checks the current status </span><span class="No-Break"><span class="koboSpan" id="kobo.1278.1">of AppArmor:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1279.1">
sudo aa-status</span></pre> <p><span class="koboSpan" id="kobo.1280.1">Here’s an excerpt from the </span><span class="No-Break"><span class="koboSpan" id="kobo.1281.1">command’s output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer319">
<span class="koboSpan" id="kobo.1282.1"><img alt="Figure 9.29 – Getting the status of AppArmor" src="image/B19682_09_29.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1283.1">Figure 9.29 – Getting the status of AppArmor</span></p>
<p><span class="koboSpan" id="kobo.1284.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1285.1">aa-status</span></strong><span class="koboSpan" id="kobo.1286.1"> (or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1287.1">apparmor_status</span></strong><span class="koboSpan" id="kobo.1288.1">) command provides a full list of the currently loaded AppArmor profiles (not shown in the</span><a id="_idIndexMarker1478"/><span class="koboSpan" id="kobo.1289.1"> preceding excerpt). </span><span class="koboSpan" id="kobo.1289.2">We’ll examine AppArmor </span><span class="No-Break"><span class="koboSpan" id="kobo.1290.1">profiles next.</span></span></p>
<h3><span class="koboSpan" id="kobo.1291.1">Introducing AppArmor profiles</span></h3>
<p><span class="koboSpan" id="kobo.1292.1">With AppArmor, processes </span><a id="_idIndexMarker1479"/><span class="koboSpan" id="kobo.1293.1">are confined (or restricted) by profiles. </span><span class="koboSpan" id="kobo.1293.2">AppArmor profiles are loaded upon system start and run either in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1294.1">enforce</span></strong><span class="koboSpan" id="kobo.1295.1"> mode or </span><strong class="source-inline"><span class="koboSpan" id="kobo.1296.1">complain</span></strong><span class="koboSpan" id="kobo.1297.1"> mode. </span><span class="koboSpan" id="kobo.1297.2">Let’s explore these modes in </span><span class="No-Break"><span class="koboSpan" id="kobo.1298.1">some detail:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1299.1">enforce</span></strong><span class="koboSpan" id="kobo.1300.1"> mode: AppArmor </span><a id="_idIndexMarker1480"/><span class="koboSpan" id="kobo.1301.1">prevents applications running in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1302.1">enforce</span></strong><span class="koboSpan" id="kobo.1303.1"> mode from performing restricted actions. </span><span class="koboSpan" id="kobo.1303.2">Access violations are signaled with log entries in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1304.1">syslog</span></strong><span class="koboSpan" id="kobo.1305.1">. </span><span class="koboSpan" id="kobo.1305.2">Ubuntu, by default, loads the application profiles in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1306.1">enforce</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1307.1"> mode.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1308.1">complain</span></strong><span class="koboSpan" id="kobo.1309.1"> mode: Applications</span><a id="_idIndexMarker1481"/><span class="koboSpan" id="kobo.1310.1"> running in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1311.1">complain</span></strong><span class="koboSpan" id="kobo.1312.1"> mode can take restricted actions, while AppArmor creates a log entry for the related violation. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1313.1">complain</span></strong><span class="koboSpan" id="kobo.1314.1"> mode is ideal for testing AppArmor profiles. </span><span class="koboSpan" id="kobo.1314.2">Potential errors or access violations can be caught and fixed before switching the profiles to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1315.1">enforce</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1316.1"> mode.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1317.1">With these introductory notes in mind, let’s create a simple application with an </span><span class="No-Break"><span class="koboSpan" id="kobo.1318.1">AppArmor profile.</span></span></p>
<h4><span class="koboSpan" id="kobo.1319.1">Creating a profile</span></h4>
<p><span class="koboSpan" id="kobo.1320.1">In this section, we’ll </span><a id="_idIndexMarker1482"/><span class="koboSpan" id="kobo.1321.1">create a simple application guarded by AppArmor. </span><span class="koboSpan" id="kobo.1321.2">We hope this exercise will help you get a reasonable idea of the inner workings of AppArmor. </span><span class="koboSpan" id="kobo.1321.3">Let’s name this application </span><strong class="source-inline"><span class="koboSpan" id="kobo.1322.1">appackt</span></strong><span class="koboSpan" id="kobo.1323.1">. </span><span class="koboSpan" id="kobo.1323.2">We’ll make it a simple script that creates a file, writes to it, and then deletes the file. </span><span class="koboSpan" id="kobo.1323.3">The goal is to have AppArmor prevent our app from accessing any other paths in the local system. </span><span class="koboSpan" id="kobo.1323.4">To try to make some sense of this, think of it as trivial </span><span class="No-Break"><span class="koboSpan" id="kobo.1324.1">log recycling.</span></span></p>
<p><span class="koboSpan" id="kobo.1325.1">Here’s the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1326.1">appackt</span></strong><span class="koboSpan" id="kobo.1327.1"> script, and please pardon the </span><span class="No-Break"><span class="koboSpan" id="kobo.1328.1">thrifty implementation:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer320">
<span class="koboSpan" id="kobo.1329.1"><img alt="Figure 9.30 – The appackt script" src="image/B19682_09_30.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1330.1">Figure 9.30 – The appackt script</span></p>
<p><span class="koboSpan" id="kobo.1331.1">We are </span><a id="_idIndexMarker1483"/><span class="koboSpan" id="kobo.1332.1">assuming that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1333.1">log</span></strong><span class="koboSpan" id="kobo.1334.1"> directory already exists at the same location as </span><span class="No-Break"><span class="koboSpan" id="kobo.1335.1">the script:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1336.1">
mkdir ./log</span></pre> <p><span class="koboSpan" id="kobo.1337.1">Let’s make the script executable and </span><span class="No-Break"><span class="koboSpan" id="kobo.1338.1">run it:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1339.1">
chmod a+x appackt
./appackt</span></pre> <p><span class="koboSpan" id="kobo.1340.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1341.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer321">
<span class="koboSpan" id="kobo.1342.1"><img alt="Figure 9.31 – The output of the appackt script" src="image/B19682_09_31.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1343.1">Figure 9.31 – The output of the appackt script</span></p>
<p><span class="koboSpan" id="kobo.1344.1">Now, let’s work on guarding and </span><a id="_idIndexMarker1484"/><span class="koboSpan" id="kobo.1345.1">enforcing our script with AppArmor. </span><span class="koboSpan" id="kobo.1345.2">Before we start, we need to install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1346.1">apparmor-utils</span></strong><span class="koboSpan" id="kobo.1347.1"> package—the </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1348.1">AppArmor toolset</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1349.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1350.1">
sudo apt install -y apparmor-utils</span></pre> <p><span class="koboSpan" id="kobo.1351.1">We’ll use a couple of tools to help create </span><span class="No-Break"><span class="koboSpan" id="kobo.1352.1">the profile:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1353.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1354.1">: Generates an AppArmor </span><span class="No-Break"><span class="koboSpan" id="kobo.1355.1">security profile</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1356.1">aa-logprof</span></strong><span class="koboSpan" id="kobo.1357.1">: Updates an AppArmor </span><span class="No-Break"><span class="koboSpan" id="kobo.1358.1">security profile</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1359.1">We use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1360.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1361.1"> to monitor our application at runtime and have AppArmor learn about it. </span><span class="koboSpan" id="kobo.1361.2">In the process, we’ll be prompted to acknowledge and choose the behavior that’s required in </span><span class="No-Break"><span class="koboSpan" id="kobo.1362.1">specific circumstances.</span></span></p>
<p><span class="koboSpan" id="kobo.1363.1">Once the profile has been </span><a id="_idIndexMarker1485"/><span class="koboSpan" id="kobo.1364.1">created, we’ll use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1365.1">aa-logprof</span></strong><span class="koboSpan" id="kobo.1366.1"> utility to make further adjustments while testing in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1367.1">complain</span></strong><span class="koboSpan" id="kobo.1368.1"> mode, should any </span><span class="No-Break"><span class="koboSpan" id="kobo.1369.1">violations occur.</span></span></p>
<p><span class="koboSpan" id="kobo.1370.1">Let’s start with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1371.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1372.1">. </span><span class="koboSpan" id="kobo.1372.2">We need two terminals: one for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1373.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1374.1"> monitoring session (in </span><em class="italic"><span class="koboSpan" id="kobo.1375.1">Terminal 1</span></em><span class="koboSpan" id="kobo.1376.1">) and the other for running our script (in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1377.1">Terminal 2</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1378.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1379.1">We will start with </span><em class="italic"><span class="koboSpan" id="kobo.1380.1">Terminal 1</span></em><span class="koboSpan" id="kobo.1381.1"> and run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1382.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1383.1">
sudo aa-genprof ./appackt</span></pre> <p><span class="koboSpan" id="kobo.1384.1">There is a first prompt waiting for us. </span><span class="koboSpan" id="kobo.1384.2">Next, while the prompt in </span><em class="italic"><span class="koboSpan" id="kobo.1385.1">Terminal 1</span></em><span class="koboSpan" id="kobo.1386.1"> is waiting, we will switch to </span><em class="italic"><span class="koboSpan" id="kobo.1387.1">Terminal 2</span></em><span class="koboSpan" id="kobo.1388.1"> and run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1389.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1390.1">
./appackt</span></pre> <p><span class="koboSpan" id="kobo.1391.1">Now, we must go back to </span><em class="italic"><span class="koboSpan" id="kobo.1392.1">Terminal 1</span></em><span class="koboSpan" id="kobo.1393.1"> and answer the prompts sent by </span><strong class="source-inline"><span class="koboSpan" id="kobo.1394.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1395.1">, as follows (output detailed in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1396.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1397.1">.32</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1398.1">):</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.1399.1">Prompt 1</span></strong><span class="koboSpan" id="kobo.1400.1">: Waiting </span><span class="No-Break"><span class="koboSpan" id="kobo.1401.1">to scan</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1402.1">This prompt asks to scan the system log for AppArmor events in order to detect possible </span><span class="No-Break"><span class="koboSpan" id="kobo.1403.1">complaints (violations).</span></span></p><p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.1404.1">Answer</span></em><span class="koboSpan" id="kobo.1405.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1406.1">S</span></strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1407.1">(S)can</span></strong></span></p></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1408.1">Prompts 2 to 5</span></strong><span class="koboSpan" id="kobo.1409.1">: Execute permissions for </span><strong class="source-inline"><span class="koboSpan" id="kobo.1410.1">/usr/bin/touch</span></strong><span class="koboSpan" id="kobo.1411.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1412.1">/usr/bin/date</span></strong><span class="koboSpan" id="kobo.1413.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1414.1">/usr/bin/cat</span></strong><span class="koboSpan" id="kobo.1415.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1416.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1417.1">/usr/bin/rm</span></strong></span><p class="list-inset"><span class="koboSpan" id="kobo.1418.1">This prompt requests execute permissions for all the processes running </span><span class="No-Break"><span class="koboSpan" id="kobo.1419.1">our app.</span></span></p><p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.1420.1">Answer</span></em><span class="koboSpan" id="kobo.1421.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1422.1">I</span></strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1423.1">(I)nherit</span></strong></span></p></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1424.1">Prompts 6 to 9</span></strong><span class="koboSpan" id="kobo.1425.1">: Read/write permissions to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1426.1">/dev/tty</span></strong><span class="koboSpan" id="kobo.1427.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1428.1">/home/packt/log/appackt</span></strong><span class="koboSpan" id="kobo.1429.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1430.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1431.1">/etc/ld.so.cache</span></strong></span><p class="list-inset"><span class="koboSpan" id="kobo.1432.1">This prompt requests read/write permissions for the app to control </span><span class="No-Break"><span class="koboSpan" id="kobo.1433.1">different files.</span></span></p><p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.1434.1">Answer</span></em><span class="koboSpan" id="kobo.1435.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1436.1">A</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1437.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1438.1">A)llow</span></strong></span></p></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1439.1">Prompt 10</span></strong><span class="koboSpan" id="kobo.1440.1">: </span><span class="No-Break"><span class="koboSpan" id="kobo.1441.1">Save changes</span></span><p class="list-inset"><span class="koboSpan" id="kobo.1442.1">The prompt asks to </span><a id="_idIndexMarker1486"/><span class="koboSpan" id="kobo.1443.1">save or </span><span class="No-Break"><span class="koboSpan" id="kobo.1444.1">review changes.</span></span></p><p class="list-inset"><em class="italic"><span class="koboSpan" id="kobo.1445.1">Answer</span></em><span class="koboSpan" id="kobo.1446.1">: </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1447.1">S</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1448.1"> (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1449.1">S)ave</span></strong></span></p></li>
</ul>
<div>
<div class="IMG---Figure" id="_idContainer322">
<span class="koboSpan" id="kobo.1450.1"><img alt="Figure 9.32 – Running aa-genprof and setting the profile" src="image/B19682_09_32.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1451.1">Figure 9.32 – Running aa-genprof and setting the profile</span></p>
<p><span class="koboSpan" id="kobo.1452.1">At this point, we</span><a id="_idIndexMarker1487"/><span class="koboSpan" id="kobo.1453.1"> have finished scanning with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1454.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1455.1">, and we can answer the last prompt with </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1456.1">F</span></strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1457.1">(F)inish</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1458.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer323">
<span class="koboSpan" id="kobo.1459.1"><img alt="Figure 9.33 – Finishing the scanning" src="image/B19682_09_33.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1460.1">Figure 9.33 – Finishing the scanning</span></p>
<p><span class="koboSpan" id="kobo.1461.1">Our app (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1462.1">appackt</span></strong><span class="koboSpan" id="kobo.1463.1">) is now enforced by AppArmor in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1464.1">enforce</span></strong><span class="koboSpan" id="kobo.1465.1"> mode (</span><span class="No-Break"><span class="koboSpan" id="kobo.1466.1">by default).</span></span></p>
<p><span class="koboSpan" id="kobo.1467.1">For the rest of the steps, we only need one terminal window. </span><span class="koboSpan" id="kobo.1467.2">Let’s run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1468.1">aa-logprof</span></strong><span class="koboSpan" id="kobo.1469.1"> command to further tune our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1470.1">appackt</span></strong><span class="koboSpan" id="kobo.1471.1"> security profile </span><span class="No-Break"><span class="koboSpan" id="kobo.1472.1">if needed:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1473.1">
sudo aa-logprof</span></pre> <p><span class="koboSpan" id="kobo.1474.1">We’ll get several prompts </span><a id="_idIndexMarker1488"/><span class="koboSpan" id="kobo.1475.1">again, similar to the previous ones, asking for further permissions needed by our script or by other applications. </span><span class="koboSpan" id="kobo.1475.2">The prompts alternate between </span><strong class="source-inline"><span class="koboSpan" id="kobo.1476.1">Inherit</span></strong><span class="koboSpan" id="kobo.1477.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1478.1">Allow</span></strong><span class="koboSpan" id="kobo.1479.1"> answers, where appropriate. </span><span class="koboSpan" id="kobo.1479.2">We won’t go into the details here as it is beyond the scope of this book. </span><span class="koboSpan" id="kobo.1479.3">By now, you should have a general idea about these prompts and their meaning. </span><span class="koboSpan" id="kobo.1479.4">It’s always recommended, though, to ponder upon the permissions asked and </span><span class="No-Break"><span class="koboSpan" id="kobo.1480.1">act accordingly.</span></span></p>
<p><span class="koboSpan" id="kobo.1481.1">We may have to run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1482.1">aa-logprof</span></strong><span class="koboSpan" id="kobo.1483.1"> command a couple of times because, with each iteration, new permissions will be discovered and addressed, depending on the child processes that are spawned by our script, and so on. </span><span class="koboSpan" id="kobo.1483.2">Eventually, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1484.1">appackt</span></strong><span class="koboSpan" id="kobo.1485.1"> script will </span><span class="No-Break"><span class="koboSpan" id="kobo.1486.1">run successfully.</span></span></p>
<p><span class="koboSpan" id="kobo.1487.1">During the iterative process described previously, we may end up with a few unknown or orphaned entries in the AppArmor database, which are artifacts of our previous attempts to secure </span><span class="No-Break"><span class="koboSpan" id="kobo.1488.1">our application:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer324">
<span class="koboSpan" id="kobo.1489.1"><img alt="Figure 9.34 – Remnants of the iterative process" src="image/B19682_09_34.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1490.1">Figure 9.34 – Remnants of the iterative process</span></p>
<p><span class="koboSpan" id="kobo.1491.1">They will all be named according to the path of our application (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1492.1">/home/packt/appackt</span></strong><span class="koboSpan" id="kobo.1493.1">). </span><span class="koboSpan" id="kobo.1493.2">We can clean up these entries with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1494.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1495.1">
sudo aa-remove-unknown</span></pre> <p><span class="koboSpan" id="kobo.1496.1">We can now verify that our app is indeed guarded </span><span class="No-Break"><span class="koboSpan" id="kobo.1497.1">with AppArmor:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1498.1">
sudo aa-status</span></pre> <p><span class="koboSpan" id="kobo.1499.1">The relevant excerpt from the output is </span><span class="No-Break"><span class="koboSpan" id="kobo.1500.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer325">
<span class="koboSpan" id="kobo.1501.1"><img alt="Figure 9.35 – appackt in complain mode" src="image/B19682_09_35.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1502.1">Figure 9.35 – appackt in complain mode</span></p>
<p><span class="koboSpan" id="kobo.1503.1">Our application (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1504.1">/home/packt/appackt</span></strong><span class="koboSpan" id="kobo.1505.1">) is shown, as expected, in </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1506.1">enforce</span></strong></span><span class="No-Break"> </span><span class="No-Break"><span class="koboSpan" id="kobo.1507.1">mode.</span></span></p>
<p><span class="koboSpan" id="kobo.1508.1">Next, we need to validate that </span><a id="_idIndexMarker1489"/><span class="koboSpan" id="kobo.1509.1">our app complies with the security policies enforced by AppArmor. </span><span class="koboSpan" id="kobo.1509.2">Let’s edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1510.1">appackt</span></strong><span class="koboSpan" id="kobo.1511.1"> script and change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1512.1">LOG_FILE</span></strong><span class="koboSpan" id="kobo.1513.1"> path in </span><em class="italic"><span class="koboSpan" id="kobo.1514.1">line 6</span></em><span class="koboSpan" id="kobo.1515.1"> of </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1516.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.1517.1">.35</span></em><span class="koboSpan" id="kobo.1518.1"> to </span><span class="No-Break"><span class="koboSpan" id="kobo.1519.1">the following:</span></span></p>
<pre class="source-code"><span class="koboSpan" id="kobo.1520.1">
LOG_FILE="./</span><strong class="bold"><span class="koboSpan" id="kobo.1521.1">logs</span></strong><span class="koboSpan" id="kobo.1522.1">/appackt"</span></pre> <p><span class="koboSpan" id="kobo.1523.1">We have changed the output directory from </span><strong class="source-inline"><span class="koboSpan" id="kobo.1524.1">log</span></strong><span class="koboSpan" id="kobo.1525.1"> to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1526.1">logs</span></strong><span class="koboSpan" id="kobo.1527.1">. </span><span class="koboSpan" id="kobo.1527.2">Let’s create a </span><strong class="source-inline"><span class="koboSpan" id="kobo.1528.1">logs</span></strong><span class="koboSpan" id="kobo.1529.1"> directory and run </span><span class="No-Break"><span class="koboSpan" id="kobo.1530.1">our app:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1531.1">
mkdir logs
./appackt</span></pre> <p><span class="koboSpan" id="kobo.1532.1">The preceding </span><a id="_idIndexMarker1490"/><span class="koboSpan" id="kobo.1533.1">output suggests that </span><strong class="source-inline"><span class="koboSpan" id="kobo.1534.1">appackt</span></strong><span class="koboSpan" id="kobo.1535.1"> is attempting to access a path outside the permitted boundaries by AppArmor, thus validating </span><span class="No-Break"><span class="koboSpan" id="kobo.1536.1">our profile:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer326">
<span class="koboSpan" id="kobo.1537.1"><img alt="Figure 9.36 – appackt acting outside security boundaries" src="image/B19682_09_36.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1538.1">Figure 9.36 – appackt acting outside security boundaries</span></p>
<p><span class="koboSpan" id="kobo.1539.1">Let’s revert the preceding changes and have the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1540.1">appackt</span></strong><span class="koboSpan" id="kobo.1541.1"> script act normally. </span><span class="koboSpan" id="kobo.1541.2">Let’s assume that our app is not yet running in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1542.1">enforce</span></strong><span class="koboSpan" id="kobo.1543.1"> mode (but ours is already). </span><span class="koboSpan" id="kobo.1543.2">We can change it to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1544.1">enforce</span></strong><span class="koboSpan" id="kobo.1545.1"> profile mode with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1546.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1547.1">
sudo aa-enforce /home/packt/appackt</span></pre> <p><span class="koboSpan" id="kobo.1548.1">We can verify that our application is indeed running in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1549.1">enforce</span></strong><span class="koboSpan" id="kobo.1550.1"> mode with the </span><span class="No-Break"><span class="koboSpan" id="kobo.1551.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1552.1">
sudo aa-status</span></pre> <p><span class="koboSpan" id="kobo.1553.1">If we wanted</span><a id="_idIndexMarker1491"/><span class="koboSpan" id="kobo.1554.1"> to make further adjustments to our application and then test it with the related changes, we would have to change the profile mode to </span><strong class="source-inline"><span class="koboSpan" id="kobo.1555.1">complain</span></strong><span class="koboSpan" id="kobo.1556.1"> and then reiterate the steps described earlier in this section. </span><span class="koboSpan" id="kobo.1556.2">The following command sets the application profile to </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1557.1">complain</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1558.1"> mode:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1559.1">
sudo aa-complain /home/packt/appackt</span></pre> <p><span class="koboSpan" id="kobo.1560.1">AppArmor profiles are plain text files stored in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1561.1">/etc/apparmor.d/</span></strong><span class="koboSpan" id="kobo.1562.1"> directory. </span><span class="koboSpan" id="kobo.1562.2">Creating or modifying AppArmor profiles usually involves manually editing the corresponding files or the procedure described in this section using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1563.1">aa-genprof</span></strong><span class="koboSpan" id="kobo.1564.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1565.1">aa-logprof</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1566.1"> tools.</span></span></p>
<p><span class="koboSpan" id="kobo.1567.1">Next, let’s look at how to disable or enable AppArmor </span><span class="No-Break"><span class="koboSpan" id="kobo.1568.1">application profiles.</span></span></p>
<h4><span class="koboSpan" id="kobo.1569.1">Disabling and enabling profiles</span></h4>
<p><span class="koboSpan" id="kobo.1570.1">Sometimes, we </span><a id="_idIndexMarker1492"/><span class="koboSpan" id="kobo.1571.1">may want to disable a problematic application profile while </span><a id="_idIndexMarker1493"/><span class="koboSpan" id="kobo.1572.1">working on a better version. </span><span class="koboSpan" id="kobo.1572.2">Here’s how we </span><span class="No-Break"><span class="koboSpan" id="kobo.1573.1">do this.</span></span></p>
<p><span class="koboSpan" id="kobo.1574.1">First, we need to locate the application profile we want to disable (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1575.1">appackt</span></strong><span class="koboSpan" id="kobo.1576.1">). </span><span class="koboSpan" id="kobo.1576.2">The related file is in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1577.1">/etc/apparmor.d/</span></strong><span class="koboSpan" id="kobo.1578.1"> directory and it’s named according to its full path, with dots (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1579.1">.</span></strong><span class="koboSpan" id="kobo.1580.1">) instead of slashes (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1581.1">/</span></strong><span class="koboSpan" id="kobo.1582.1">). </span><span class="koboSpan" id="kobo.1582.2">In our case, the file is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1583.1">/etc/apparmor.d/home.packt.appackt</span></strong><span class="koboSpan" id="kobo.1584.1">, as seen in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1585.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer327">
<span class="koboSpan" id="kobo.1586.1"><img alt="Figure 9.37 – Location of the AppArmor profile for appackt" src="image/B19682_09_37.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1587.1">Figure 9.37 – Location of the AppArmor profile for appackt</span></p>
<p><span class="koboSpan" id="kobo.1588.1">To disable the profile, we must run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1589.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1590.1">
sudo ln -s /etc/apparmor.d/home.packt.appackt /etc/apparmor.d/disable/
sudo apparmor_parser -R /etc/apparmor.d/home.packt.appackt</span></pre> <p><span class="koboSpan" id="kobo.1591.1">If we run the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1592.1">aa-status</span></strong><span class="koboSpan" id="kobo.1593.1"> command, we won’t see our </span><strong class="source-inline"><span class="koboSpan" id="kobo.1594.1">appackt</span></strong><span class="koboSpan" id="kobo.1595.1"> profile anymore. </span><span class="koboSpan" id="kobo.1595.2">The related profile is still present in the filesystem, </span><span class="No-Break"><span class="koboSpan" id="kobo.1596.1">at </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1597.1">/etc/apparmor.d/disable/home.packt.appackt</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1598.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1599.1">In this situation, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1600.1">appackt</span></strong><span class="koboSpan" id="kobo.1601.1"> script is not enforced by any restrictions. </span><span class="koboSpan" id="kobo.1601.2">To re-enable the related security profile, we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.1602.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1603.1">
sudo rm /etc/apparmor.d/disable/home.packt.appackt
sudo apparmor_parser -r /etc/apparmor.d/home.packt.appackt</span></pre> <p><span class="koboSpan" id="kobo.1604.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1605.1">appackt</span></strong><span class="koboSpan" id="kobo.1606.1"> profile</span><a id="_idIndexMarker1494"/><span class="koboSpan" id="kobo.1607.1"> should now show up in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1608.1">aa-status</span></strong><span class="koboSpan" id="kobo.1609.1"> output as</span><a id="_idIndexMarker1495"/><span class="koboSpan" id="kobo.1610.1"> running in </span><strong class="source-inline"><span class="koboSpan" id="kobo.1611.1">enforce</span></strong><span class="koboSpan" id="kobo.1612.1"> mode. </span><span class="koboSpan" id="kobo.1612.2">All the previous commands and their output are shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1613.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer328">
<span class="koboSpan" id="kobo.1614.1"><img alt="Figure 9.38 – Disabling and enabling an AppArmor profile" src="image/B19682_09_38.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1615.1">Figure 9.38 – Disabling and enabling an AppArmor profile</span></p>
<p><span class="koboSpan" id="kobo.1616.1">To disable or enable the profile, we used the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1617.1">apparmor_parser</span></strong><span class="koboSpan" id="kobo.1618.1"> command, besides the related filesystem operations. </span><span class="koboSpan" id="kobo.1618.2">This utility assists with loading (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1619.1">-r</span></strong><span class="koboSpan" id="kobo.1620.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1621.1">--replace</span></strong><span class="koboSpan" id="kobo.1622.1">) or unloading (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1623.1">-R</span></strong><span class="koboSpan" id="kobo.1624.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1625.1">--remove</span></strong><span class="koboSpan" id="kobo.1626.1">) security profiles to and from </span><span class="No-Break"><span class="koboSpan" id="kobo.1627.1">the kernel.</span></span></p>
<p><span class="koboSpan" id="kobo.1628.1">Deleting AppArmor security profiles is functionally equivalent to disabling them. </span><span class="koboSpan" id="kobo.1628.2">We can also choose to remove the related file from the filesystem altogether. </span><span class="koboSpan" id="kobo.1628.3">If we delete a profile without removing it from the kernel first (with </span><strong class="source-inline"><span class="koboSpan" id="kobo.1629.1">apparmor_parser -R</span></strong><span class="koboSpan" id="kobo.1630.1">), we can use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1631.1">aa-remove-unknown</span></strong><span class="koboSpan" id="kobo.1632.1"> command to clean up </span><span class="No-Break"><span class="koboSpan" id="kobo.1633.1">orphaned entries.</span></span></p>
<p><span class="koboSpan" id="kobo.1634.1">Let’s conclude our relatively brief study of AppArmor internals with some </span><span class="No-Break"><span class="koboSpan" id="kobo.1635.1">final thoughts.</span></span></p>
<h2 id="_idParaDest-186"><a id="_idTextAnchor202"/><span class="koboSpan" id="kobo.1636.1">Final considerations</span></h2>
<p><span class="koboSpan" id="kobo.1637.1">Working with AppArmor</span><a id="_idIndexMarker1496"/><span class="koboSpan" id="kobo.1638.1"> is relatively easier than SELinux, especially when it comes to generating security policies or switching back and forth between permissive and non-permissive mode. </span><span class="koboSpan" id="kobo.1638.2">SELinux can only toggle the permissive context for the entire system, while AppArmor does it at the application level. </span><span class="koboSpan" id="kobo.1638.3">On the other hand, there might be no choice between the two, as some major Linux distributions either support one or the other. </span><span class="koboSpan" id="kobo.1638.4">AppArmor is used on Debian, Ubuntu, and openSUSE, while SELinux runs on RHEL/Fedora and SLE. </span><span class="koboSpan" id="kobo.1638.5">Theoretically, you can always try to port the related kernel modules across distros, but that’s not a </span><span class="No-Break"><span class="koboSpan" id="kobo.1639.1">trivial task.</span></span></p>
<p><span class="koboSpan" id="kobo.1640.1">As a final note, we should reiterate that in the big picture of Linux security, SELinux and AppArmor are ACMs that act locally on a system, at the application level. </span><span class="koboSpan" id="kobo.1640.2">When it comes to securing applications and computer systems from the outside world, firewalls come into play. </span><span class="koboSpan" id="kobo.1640.3">We’ll look at </span><span class="No-Break"><span class="koboSpan" id="kobo.1641.1">firewalls next.</span></span></p>
<h1 id="_idParaDest-187"><a id="_idTextAnchor203"/><span class="koboSpan" id="kobo.1642.1">Working with firewalls</span></h1>
<p><span class="koboSpan" id="kobo.1643.1">Traditionally, a </span><a id="_idIndexMarker1497"/><strong class="bold"><span class="koboSpan" id="kobo.1644.1">firewall</span></strong><span class="koboSpan" id="kobo.1645.1"> is a network security device that’s placed between two networks. </span><span class="koboSpan" id="kobo.1645.2">It monitors the network traffic and controls access to these networks. </span><span class="koboSpan" id="kobo.1645.3">Generally speaking, a firewall protects a local network from unwanted intrusion or attacks from the outside. </span><span class="koboSpan" id="kobo.1645.4">But a firewall can also block unsolicited locally originated traffic targeting the public internet. </span><span class="koboSpan" id="kobo.1645.5">Technically, a firewall allows or blocks incoming and outgoing network traffic based on specific </span><span class="No-Break"><span class="koboSpan" id="kobo.1646.1">security rules.</span></span></p>
<p><span class="koboSpan" id="kobo.1647.1">For example, a firewall can block all but a select set of inbound networking protocols (such as SSH and HTTP/HTTPS). </span><span class="koboSpan" id="kobo.1647.2">It may also block all but approved hosts within the local network from establishing specific outbound connections, such as allowing outbound </span><strong class="bold"><span class="koboSpan" id="kobo.1648.1">Simple Mail Transfer Protocol</span></strong><span class="koboSpan" id="kobo.1649.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1650.1">SMTP</span></strong><span class="koboSpan" id="kobo.1651.1">) connections</span><a id="_idIndexMarker1498"/><span class="koboSpan" id="kobo.1652.1"> that originated exclusively from the local </span><span class="No-Break"><span class="koboSpan" id="kobo.1653.1">email servers.</span></span></p>
<p><span class="koboSpan" id="kobo.1654.1">The following diagram shows a simple firewall deployment regulating traffic between a local network and </span><span class="No-Break"><span class="koboSpan" id="kobo.1655.1">the internet:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer329">
<span class="koboSpan" id="kobo.1656.1"><img alt="Figure 9.39 – A simple firewall diagram" src="image/B19682_09_39.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1657.1">Figure 9.39 – A simple firewall diagram</span></p>
<p><span class="koboSpan" id="kobo.1658.1">The outgoing</span><a id="_idIndexMarker1499"/><span class="koboSpan" id="kobo.1659.1"> security rules prevent bad actors, such as compromised computers and untrustworthy individuals, from directing attacks on the public internet. </span><span class="koboSpan" id="kobo.1659.2">The resulting protection benefits external networks, but it’s ultimately essential for the organization as well. </span><span class="koboSpan" id="kobo.1659.3">Thwarting hostile actions from the local network avoids them being flagged </span><a id="_idIndexMarker1500"/><span class="koboSpan" id="kobo.1660.1">by </span><strong class="bold"><span class="koboSpan" id="kobo.1661.1">internet service providers</span></strong><span class="koboSpan" id="kobo.1662.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1663.1">ISPs</span></strong><span class="koboSpan" id="kobo.1664.1">) for unruly </span><span class="No-Break"><span class="koboSpan" id="kobo.1665.1">internet traffic.</span></span></p>
<p><span class="koboSpan" id="kobo.1666.1">Configuring a firewall usually requires a default security policy acting at a global scope, and then configuring specific exceptions to this general rule, based on port numbers (protocols), IP addresses, and </span><span class="No-Break"><span class="koboSpan" id="kobo.1667.1">other criteria.</span></span></p>
<p><span class="koboSpan" id="kobo.1668.1">In the following sections, we’ll explore various firewall implementations and firewall managers. </span><span class="koboSpan" id="kobo.1668.2">First, let’s take a brief look under the hood at how a firewall monitors and controls network traffic by introducing the Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.1669.1">firewall chain.</span></span></p>
<h2 id="_idParaDest-188"><a id="_idTextAnchor204"/><span class="koboSpan" id="kobo.1670.1">Understanding the firewall chain</span></h2>
<p><span class="koboSpan" id="kobo.1671.1">At a high level, the TCP/IP stack in the Linux kernel usually performs the </span><span class="No-Break"><span class="koboSpan" id="kobo.1672.1">following workflows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1673.1">Receives data </span><a id="_idIndexMarker1501"/><span class="koboSpan" id="kobo.1674.1">from an application (process), serializes the data into network packets, and transmits the packets to a network destination, based on the respective IP address </span><span class="No-Break"><span class="koboSpan" id="kobo.1675.1">and port</span></span></li>
<li><span class="koboSpan" id="kobo.1676.1">Receives data from the network, deserializes the network packets into application data, and delivers the application data to </span><span class="No-Break"><span class="koboSpan" id="kobo.1677.1">a process</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1678.1">Ideally, in these workflows, the Linux kernel shouldn’t alter the network data in any specific way apart from shaping it due to TCP/IP protocols. </span><span class="koboSpan" id="kobo.1678.2">However, with distributed and possibly insecure network environments, the data may need further scrutiny. </span><span class="koboSpan" id="kobo.1678.3">The kernel should provide the necessary hooks to filter and alter the data packets further based on various criteria. </span><span class="koboSpan" id="kobo.1678.4">This is where firewalls and other network security and intrusion detection tools come into play. </span><span class="koboSpan" id="kobo.1678.5">They adapt to the kernel’s TCP/IP packet filtering interface and perform the required monitoring and control of network packets. </span><span class="koboSpan" id="kobo.1678.6">The blueprint of the Linux kernel’s network packet filtering procedure is also known as the </span><strong class="bold"><span class="koboSpan" id="kobo.1679.1">firewall chain</span></strong><span class="koboSpan" id="kobo.1680.1"> or </span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1681.1">firewalling chain</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1682.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer330">
<span class="koboSpan" id="kobo.1683.1"><img alt="Figure 9.40 – The Linux firewall chain" src="image/B19682_09_40.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1684.1">Figure 9.40 – The Linux firewall chain</span></p>
<p><span class="koboSpan" id="kobo.1685.1">When the incoming data enters the firewall packet filtering chain, a routing decision is made, depending on the packet’s destination. </span><span class="koboSpan" id="kobo.1685.2">Based on that routing decision, the packet can follow </span><a id="_idIndexMarker1502"/><span class="koboSpan" id="kobo.1686.1">either the </span><strong class="bold"><span class="koboSpan" id="kobo.1687.1">INPUT</span></strong><span class="koboSpan" id="kobo.1688.1"> chain (for localhost) or the </span><strong class="bold"><span class="koboSpan" id="kobo.1689.1">FORWARD</span></strong><span class="koboSpan" id="kobo.1690.1"> chain (for a remote host). </span><span class="koboSpan" id="kobo.1690.2">These chains may alter the incoming data in various ways via hooks that are implemented by network security tools or firewalls. </span><span class="koboSpan" id="kobo.1690.3">By default, the kernel won’t change the packets traversing </span><span class="No-Break"><span class="koboSpan" id="kobo.1691.1">the chains.</span></span></p>
<p><span class="koboSpan" id="kobo.1692.1">The </span><strong class="bold"><span class="koboSpan" id="kobo.1693.1">INPUT</span></strong><span class="koboSpan" id="kobo.1694.1"> chain ultimately feeds the packets into the </span><strong class="bold"><span class="koboSpan" id="kobo.1695.1">local application process</span></strong><span class="koboSpan" id="kobo.1696.1"> consuming the data. </span><span class="koboSpan" id="kobo.1696.2">These local applications are usually user-space processes, such as network clients (for example, web browsers, SSH, and email clients) or network servers (for example, web and email servers). </span><span class="koboSpan" id="kobo.1696.3">They </span><a id="_idIndexMarker1503"/><span class="koboSpan" id="kobo.1697.1">may also include kernel space processes, such as the kernel’s </span><strong class="bold"><span class="koboSpan" id="kobo.1698.1">Network File </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1699.1">System</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1700.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1701.1">NFS</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1702.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1703.1">Both the </span><strong class="bold"><span class="koboSpan" id="kobo.1704.1">FORWARD</span></strong><span class="koboSpan" id="kobo.1705.1"> chain and the </span><strong class="bold"><span class="koboSpan" id="kobo.1706.1">local processes</span></strong><span class="koboSpan" id="kobo.1707.1"> route the data packets into the </span><strong class="bold"><span class="koboSpan" id="kobo.1708.1">OUTPUT</span></strong><span class="koboSpan" id="kobo.1709.1"> chain before placing them on </span><span class="No-Break"><span class="koboSpan" id="kobo.1710.1">the network.</span></span></p>
<p><span class="koboSpan" id="kobo.1711.1">Any of the chains can filter packets based on specific criteria, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.1712.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1713.1">The source or destination </span><span class="No-Break"><span class="koboSpan" id="kobo.1714.1">IP address</span></span></li>
<li><span class="koboSpan" id="kobo.1715.1">The source or </span><span class="No-Break"><span class="koboSpan" id="kobo.1716.1">destination port</span></span></li>
<li><span class="koboSpan" id="kobo.1717.1">The network interface involved in the </span><span class="No-Break"><span class="koboSpan" id="kobo.1718.1">data transaction</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1719.1">Each chain has a set of security rules that are matched against the input packet. </span><span class="koboSpan" id="kobo.1719.2">If a rule matches, the kernel routes the data packet to the </span><strong class="bold"><span class="koboSpan" id="kobo.1720.1">target</span></strong><span class="koboSpan" id="kobo.1721.1"> specified by the rule. </span><span class="koboSpan" id="kobo.1721.2">Some predefined targets include </span><span class="No-Break"><span class="koboSpan" id="kobo.1722.1">the following:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1723.1">ACCEPT</span></strong><span class="koboSpan" id="kobo.1724.1">: Accepts the data packet for </span><span class="No-Break"><span class="koboSpan" id="kobo.1725.1">further processing</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1726.1">REJECT</span></strong><span class="koboSpan" id="kobo.1727.1">: Rejects the </span><span class="No-Break"><span class="koboSpan" id="kobo.1728.1">data packet</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1729.1">DROP</span></strong><span class="koboSpan" id="kobo.1730.1">: Ignores the </span><span class="No-Break"><span class="koboSpan" id="kobo.1731.1">data packet</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1732.1">QUEUE</span></strong><span class="koboSpan" id="kobo.1733.1">: Passes the data packet to a </span><span class="No-Break"><span class="koboSpan" id="kobo.1734.1">user-space process</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1735.1">RETURN</span></strong><span class="koboSpan" id="kobo.1736.1">: Stops processing the data packet and passes the data back to the </span><span class="No-Break"><span class="koboSpan" id="kobo.1737.1">previous chain</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1738.1">For a full list of predefined targets, please refer to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1739.1">iptables-extensions</span></strong><span class="koboSpan" id="kobo.1740.1"> system reference (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1741.1">man iptables-extensions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1742.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.1743.1">In the following sections, we’ll explore some of the most common network security frameworks and tools based on the kernel’s networking stack and firewall chain. </span><span class="koboSpan" id="kobo.1743.2">We’ll start with Netfilter—the Linux kernel’s packet filtering system. </span><span class="koboSpan" id="kobo.1743.3">Next, we’ll look at </span><strong class="source-inline"><span class="koboSpan" id="kobo.1744.1">iptables</span></strong><span class="koboSpan" id="kobo.1745.1">—the</span><a id="_idIndexMarker1504"/><span class="koboSpan" id="kobo.1746.1"> traditional interface for configuring Netfilter. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1747.1">iptables</span></strong><span class="koboSpan" id="kobo.1748.1"> is a highly configurable and flexible firewall solution. </span><span class="koboSpan" id="kobo.1748.2">Then, we’ll briefly cover </span><strong class="source-inline"><span class="koboSpan" id="kobo.1749.1">nftables</span></strong><span class="koboSpan" id="kobo.1750.1">, a tool that implements most of the complex functionality of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1751.1">iptables</span></strong><span class="koboSpan" id="kobo.1752.1"> and wraps it into a relatively easy-to-use command-line interface. </span><span class="koboSpan" id="kobo.1752.2">Finally, we’ll take a step away from the kernel’s immediate proximity </span><a id="_idIndexMarker1505"/><span class="koboSpan" id="kobo.1753.1">of packet filtering frameworks and look at </span><strong class="bold"><span class="koboSpan" id="kobo.1754.1">firewall managers</span></strong><span class="koboSpan" id="kobo.1755.1">—</span><strong class="source-inline"><span class="koboSpan" id="kobo.1756.1">firewalld</span></strong><span class="koboSpan" id="kobo.1757.1"> (RHEL/Fedora) and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1758.1">ufw</span></strong><span class="koboSpan" id="kobo.1759.1"> (Debian/Ubuntu), two user-friendly frontends for configuring Linux firewalls on major </span><span class="No-Break"><span class="koboSpan" id="kobo.1760.1">Linux distros.</span></span></p>
<p><span class="koboSpan" id="kobo.1761.1">Let’s start our journey </span><span class="No-Break"><span class="koboSpan" id="kobo.1762.1">with </span></span><span class="No-Break"><span class="koboSpan" id="kobo.1763.1">Netfilter.</span></span></p>
<h2 id="_idParaDest-189"><a id="_idTextAnchor205"/><span class="koboSpan" id="kobo.1764.1">Introducing Netfilter</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.1765.1">Netfilter</span></strong><span class="koboSpan" id="kobo.1766.1"> is a </span><a id="_idIndexMarker1506"/><span class="koboSpan" id="kobo.1767.1">packet filtering framework in the Linux kernel that provides highly customizable handlers (or hooks) to control networking-related operations. </span><span class="koboSpan" id="kobo.1767.2">These operations include </span><span class="No-Break"><span class="koboSpan" id="kobo.1768.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1769.1">Accepting or </span><span class="No-Break"><span class="koboSpan" id="kobo.1770.1">rejecting packets</span></span></li>
<li><span class="koboSpan" id="kobo.1771.1">Packet routing </span><span class="No-Break"><span class="koboSpan" id="kobo.1772.1">and forwarding</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.1773.1">Network address translation</span></strong><span class="koboSpan" id="kobo.1774.1"> and </span><strong class="bold"><span class="koboSpan" id="kobo.1775.1">network address port </span></strong><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1776.1">translation</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1777.1"> (</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1778.1">NAT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1779.1">/</span></span><span class="No-Break"><strong class="bold"><span class="koboSpan" id="kobo.1780.1">NAPT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1781.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1782.1">Applications that implement the Netfilter framework use a set of callback functions built around hooks registered with kernel modules that manipulate the networking stack. </span><span class="koboSpan" id="kobo.1782.2">These callback functions are further mapped to security rules and profiles, which control the behavior of every packet traversing the </span><span class="No-Break"><span class="koboSpan" id="kobo.1783.1">networking chain.</span></span></p>
<p><span class="koboSpan" id="kobo.1784.1">Firewall applications are first-class citizens of Netfilter framework implementations. </span><span class="koboSpan" id="kobo.1784.2">Consequently, a good understanding of Netfilter hooks will help Linux power users and administrators create reliable firewall rules </span><span class="No-Break"><span class="koboSpan" id="kobo.1785.1">and policies.</span></span></p>
<p><span class="koboSpan" id="kobo.1786.1">We’ll have a brief look at these Netfilter </span><span class="No-Break"><span class="koboSpan" id="kobo.1787.1">hooks next.</span></span></p>
<h3><span class="koboSpan" id="kobo.1788.1">Netfilter hooks</span></h3>
<p><span class="koboSpan" id="kobo.1789.1">As packets traverse </span><a id="_idIndexMarker1507"/><span class="koboSpan" id="kobo.1790.1">the various chains in the networking stack, Netfilter triggers events for the kernel modules that are registered with the corresponding </span><strong class="bold"><span class="koboSpan" id="kobo.1791.1">hooks</span></strong><span class="koboSpan" id="kobo.1792.1">. </span><span class="koboSpan" id="kobo.1792.2">These events result in notifications in the module or packet filtering application (for example, the firewall) implementing the hooks. </span><span class="koboSpan" id="kobo.1792.3">Next, the application takes control of the packet based on </span><span class="No-Break"><span class="koboSpan" id="kobo.1793.1">specific rules.</span></span></p>
<p><span class="koboSpan" id="kobo.1794.1">There are five Netfilter hooks available for packet filtering applications. </span><span class="koboSpan" id="kobo.1794.2">Each corresponds to a networking chain, as illustrated in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1795.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.1796.1">.40</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.1797.1">:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1798.1">NF_IP_PRE_ROUTING</span></strong><span class="koboSpan" id="kobo.1799.1">: Triggered by incoming traffic upon entering the network stack and before any routing decisions are made about where to send </span><span class="No-Break"><span class="koboSpan" id="kobo.1800.1">the packet</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1801.1">NF_IP_LOCAL_IN</span></strong><span class="koboSpan" id="kobo.1802.1">: Triggered after routing an incoming packet when the packet has a </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1803.1">localhost</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1804.1"> destination</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1805.1">NF_IP_FORWARD</span></strong><span class="koboSpan" id="kobo.1806.1">: Triggered after routing an incoming packet when the packet has a remote </span><span class="No-Break"><span class="koboSpan" id="kobo.1807.1">host destination</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1808.1">NF_IP_LOCAL_OUT</span></strong><span class="koboSpan" id="kobo.1809.1">: Triggered by locally initiated outbound traffic entering the </span><span class="No-Break"><span class="koboSpan" id="kobo.1810.1">network stack</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1811.1">NF_IP_POST_ROUTING</span></strong><span class="koboSpan" id="kobo.1812.1">: Triggered by outgoing or forwarded traffic, immediately after routing it and just before it exits the </span><span class="No-Break"><span class="koboSpan" id="kobo.1813.1">network stack</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1814.1">Kernel modules </span><a id="_idIndexMarker1508"/><span class="koboSpan" id="kobo.1815.1">or applications registered with Netfilter hooks must provide a priority number to determine the order the modules are called in when the hook is triggered. </span><span class="koboSpan" id="kobo.1815.2">This mechanism allows us to deterministically order multiple modules (or multiple instances of the same module) that have been registered with a specific hook. </span><span class="koboSpan" id="kobo.1815.3">When a registered module is done processing a packet, it provides a decision to the Netfilter framework about what should be done with </span><span class="No-Break"><span class="koboSpan" id="kobo.1816.1">the packet.</span></span></p>
<p><span class="koboSpan" id="kobo.1817.1">The Netfilter framework’s design and implementation is a community-driven collaborative project part of </span><a id="_idIndexMarker1509"/><span class="koboSpan" id="kobo.1818.1">the </span><strong class="bold"><span class="koboSpan" id="kobo.1819.1">Free and Open Source Software</span></strong><span class="koboSpan" id="kobo.1820.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1821.1">FOSS</span></strong><span class="koboSpan" id="kobo.1822.1">) movement. </span><span class="koboSpan" id="kobo.1822.2">As a good starting point for the Netfilter project, you may refer</span><a id="_idIndexMarker1510"/> <span class="No-Break"><span class="koboSpan" id="kobo.1823.1">to </span></span><a href="http://www.netfilter.org/"><span class="No-Break"><span class="koboSpan" id="kobo.1824.1">http://www.netfilter.org/</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.1825.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1826.1">One of the most well-known implementations of Netfilter is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1827.1">iptables</span></strong><span class="koboSpan" id="kobo.1828.1">—a widely used firewall management tool that shares a direct interface with the Netfilter packet filtering framework. </span><span class="koboSpan" id="kobo.1828.2">A practical examination of </span><strong class="source-inline"><span class="koboSpan" id="kobo.1829.1">iptables</span></strong><span class="koboSpan" id="kobo.1830.1"> would further reveal the functional aspects of Netfilter. </span><span class="koboSpan" id="kobo.1830.2">Let’s explore </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1831.1">iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1832.1"> next.</span></span></p>
<h2 id="_idParaDest-190"><a id="_idTextAnchor206"/><span class="koboSpan" id="kobo.1833.1">Working with iptables</span></h2>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.1834.1">iptables</span></strong><span class="koboSpan" id="kobo.1835.1"> is a relatively low-level</span><a id="_idIndexMarker1511"/><span class="koboSpan" id="kobo.1836.1"> Linux firewall solution and command-line utility that uses Netfilter chains to control network traffic. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1837.1">iptables</span></strong><span class="koboSpan" id="kobo.1838.1"> operates with </span><strong class="bold"><span class="koboSpan" id="kobo.1839.1">rules</span></strong><span class="koboSpan" id="kobo.1840.1"> associated with </span><strong class="bold"><span class="koboSpan" id="kobo.1841.1">chains</span></strong><span class="koboSpan" id="kobo.1842.1">. </span><span class="koboSpan" id="kobo.1842.2">A rule defines the criteria for matching the packets traversing a specific chain. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1843.1">iptables</span></strong><span class="koboSpan" id="kobo.1844.1"> also uses </span><strong class="bold"><span class="koboSpan" id="kobo.1845.1">tables</span></strong><span class="koboSpan" id="kobo.1846.1"> to organize rules based on criteria or decision type. </span><strong class="source-inline"><span class="koboSpan" id="kobo.1847.1">iptables</span></strong><span class="koboSpan" id="kobo.1848.1"> defines the </span><span class="No-Break"><span class="koboSpan" id="kobo.1849.1">following tables:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1850.1">filter</span></strong><span class="koboSpan" id="kobo.1851.1">: The default table, which is used when we’re deciding if packets should be allowed to traverse specific chains (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1852.1">INPUT</span></strong><span class="koboSpan" id="kobo.1853.1">, </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1854.1">FORWARD,</span></strong></span><span class="No-Break"> </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1855.1">OUTPUT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1856.1">).</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1857.1">nat</span></strong><span class="koboSpan" id="kobo.1858.1">: Used with packets that require a source or destination address/port translation. </span><span class="koboSpan" id="kobo.1858.2">The table operates on the following chains: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1859.1">PREROUTING</span></strong><span class="koboSpan" id="kobo.1860.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1861.1">INPUT</span></strong><span class="koboSpan" id="kobo.1862.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1863.1">OUTPUT</span></strong><span class="koboSpan" id="kobo.1864.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1865.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1866.1">POSTROUTING</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1867.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1868.1">mangle</span></strong><span class="koboSpan" id="kobo.1869.1">: Used with specialized packet alterations involving IP headers, such as </span><strong class="bold"><span class="koboSpan" id="kobo.1870.1">maximum segment size</span></strong><span class="koboSpan" id="kobo.1871.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1872.1">MSS</span></strong><span class="koboSpan" id="kobo.1873.1">) or </span><strong class="bold"><span class="koboSpan" id="kobo.1874.1">time to live</span></strong><span class="koboSpan" id="kobo.1875.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.1876.1">TTL</span></strong><span class="koboSpan" id="kobo.1877.1">). </span><span class="koboSpan" id="kobo.1877.2">The table supports the following chains: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1878.1">PREROUTING</span></strong><span class="koboSpan" id="kobo.1879.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1880.1">INPUT</span></strong><span class="koboSpan" id="kobo.1881.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1882.1">FORWARD</span></strong><span class="koboSpan" id="kobo.1883.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1884.1">OUTPUT</span></strong><span class="koboSpan" id="kobo.1885.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.1886.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1887.1">POSTROUTING</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1888.1">.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1889.1">raw</span></strong><span class="koboSpan" id="kobo.1890.1">: Used when we’re disabling connection</span><a id="_idIndexMarker1512"/><span class="koboSpan" id="kobo.1891.1"> tracking (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1892.1">NOTRACK</span></strong><span class="koboSpan" id="kobo.1893.1">) on specific packets, mainly for stateless processing and performance optimization purposes. </span><span class="koboSpan" id="kobo.1893.2">The table relates to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1894.1">PREROUTING</span></strong><span class="koboSpan" id="kobo.1895.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1896.1">OUTPUT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1897.1"> chains.</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.1898.1">security</span></strong><span class="koboSpan" id="kobo.1899.1">: Used for MAC when </span><a id="_idIndexMarker1513"/><span class="koboSpan" id="kobo.1900.1">packets are subject to SELinux policy constraints. </span><span class="koboSpan" id="kobo.1900.2">The table interacts with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1901.1">INPUT</span></strong><span class="koboSpan" id="kobo.1902.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.1903.1">FORWARD</span></strong><span class="koboSpan" id="kobo.1904.1">, and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1905.1">OUTPUT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1906.1"> chains.</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1907.1">The following diagram summarizes the tables with the corresponding chains supported </span><span class="No-Break"><span class="koboSpan" id="kobo.1908.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1909.1">iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1910.1">:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer331">
<span class="koboSpan" id="kobo.1911.1"><img alt="Figure 9.41 – Tables and chains in iptables" src="image/B19682_09_41.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1912.1">Figure 9.41 – Tables and chains in iptables</span></p>
<p><span class="koboSpan" id="kobo.1913.1">The chain traversal order of the packets in the kernel’s networking stack is </span><span class="No-Break"><span class="koboSpan" id="kobo.1914.1">as follows:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.1915.1">Incoming packets with localhost destination: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1916.1">PREROUTING</span></strong><span class="koboSpan" id="kobo.1917.1"> | </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1918.1">INPUT</span></strong></span></li>
<li><span class="koboSpan" id="kobo.1919.1">Incoming packets with remote host destination: </span><strong class="source-inline"><span class="koboSpan" id="kobo.1920.1">PREROUTING</span></strong><span class="koboSpan" id="kobo.1921.1"> | </span><strong class="source-inline"><span class="koboSpan" id="kobo.1922.1">FORWARD</span></strong><span class="koboSpan" id="kobo.1923.1"> | </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1924.1">POSTROUTING</span></strong></span></li>
<li><span class="koboSpan" id="kobo.1925.1">Locally generated packets (by application processes): </span><strong class="source-inline"><span class="koboSpan" id="kobo.1926.1">OUTPUT</span></strong><span class="koboSpan" id="kobo.1927.1"> | </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1928.1">POSTROUTING</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.1929.1">Now that we’re familiar with some introductory concepts, we can tackle a few</span><a id="_idIndexMarker1514"/><span class="koboSpan" id="kobo.1930.1"> practical examples to understand how </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1931.1">iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1932.1"> works.</span></span></p>
<p><span class="koboSpan" id="kobo.1933.1">The following examples use a Fedora 37 system, but they should work on every major Linux distribution. </span><span class="koboSpan" id="kobo.1933.2">Please note that starting with RHEL 7, the default firewall management application is </span><strong class="source-inline"><span class="koboSpan" id="kobo.1934.1">firewalld</span></strong><span class="koboSpan" id="kobo.1935.1"> (discussed in the </span><em class="italic"><span class="koboSpan" id="kobo.1936.1">Using firewall managers</span></em><span class="koboSpan" id="kobo.1937.1"> section later in this chapter). </span><span class="koboSpan" id="kobo.1937.2">If you want to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.1938.1">iptables</span></strong><span class="koboSpan" id="kobo.1939.1">, first, you need to </span><span class="No-Break"><span class="koboSpan" id="kobo.1940.1">disable </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1941.1">firewalld</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1942.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1943.1">
sudo systemctl stop firewalld
sudo systemctl disable firewalld
sudo systemctl mask firewalld</span></pre> <p><span class="koboSpan" id="kobo.1944.1">Next, install the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1945.1">iptables-services</span></strong><span class="koboSpan" id="kobo.1946.1"> package (</span><span class="No-Break"><span class="koboSpan" id="kobo.1947.1">on Fedora):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1948.1">
sudo dnf install iptables-services</span></pre> <p><span class="koboSpan" id="kobo.1949.1">The output of the preceding commands is </span><span class="No-Break"><span class="koboSpan" id="kobo.1950.1">shown here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer332">
<span class="koboSpan" id="kobo.1951.1"><img alt="Figure 9.42 – Disabling firewalld and installing iptables on Fedora" src="image/B19682_09_42.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.1952.1">Figure 9.42 – Disabling firewalld and installing iptables on Fedora</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.1953.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.1954.1">On Ubuntu, you must install </span><strong class="source-inline"><span class="koboSpan" id="kobo.1955.1">iptables</span></strong><span class="koboSpan" id="kobo.1956.1"> using </span><strong class="source-inline"><span class="koboSpan" id="kobo.1957.1">sudo apt </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1958.1">install iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1959.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.1960.1">Now, let’s start </span><a id="_idIndexMarker1515"/><span class="No-Break"><span class="koboSpan" id="kobo.1961.1">configuring </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1962.1">iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1963.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.1964.1">Configuring iptables</span></h3>
<p><span class="koboSpan" id="kobo.1965.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1966.1">iptables</span></strong><span class="koboSpan" id="kobo.1967.1"> command</span><a id="_idIndexMarker1516"/><span class="koboSpan" id="kobo.1968.1"> requires superuser privileges. </span><span class="koboSpan" id="kobo.1968.2">First, let’s check the current </span><strong class="source-inline"><span class="koboSpan" id="kobo.1969.1">iptables</span></strong><span class="koboSpan" id="kobo.1970.1"> configuration. </span><span class="koboSpan" id="kobo.1970.2">The general syntax for retrieving the rules in a chain for a specific table is </span><span class="No-Break"><span class="koboSpan" id="kobo.1971.1">as follows:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1972.1">
sudo iptables -L [CHAIN] [-t TABLE]</span></pre> <p><span class="koboSpan" id="kobo.1973.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1974.1">-L</span></strong><span class="koboSpan" id="kobo.1975.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1976.1">--list</span></strong><span class="koboSpan" id="kobo.1977.1">) option lists the rules in a </span><em class="italic"><span class="koboSpan" id="kobo.1978.1">chain</span></em><span class="koboSpan" id="kobo.1979.1">. </span><span class="koboSpan" id="kobo.1979.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1980.1">-t</span></strong><span class="koboSpan" id="kobo.1981.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.1982.1">--table</span></strong><span class="koboSpan" id="kobo.1983.1">) option specifies a table. </span><span class="koboSpan" id="kobo.1983.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.1984.1">CHAIN</span></strong><span class="koboSpan" id="kobo.1985.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.1986.1">TABLE</span></strong><span class="koboSpan" id="kobo.1987.1"> parameters are optional. </span><span class="koboSpan" id="kobo.1987.2">If the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1988.1">CHAIN</span></strong><span class="koboSpan" id="kobo.1989.1"> option is omitted, </span><em class="italic"><span class="koboSpan" id="kobo.1990.1">all</span></em><span class="koboSpan" id="kobo.1991.1"> chains and their related rules are considered within a table. </span><span class="koboSpan" id="kobo.1991.2">When no </span><strong class="source-inline"><span class="koboSpan" id="kobo.1992.1">TABLE</span></strong><span class="koboSpan" id="kobo.1993.1"> option is specified, the </span><strong class="source-inline"><span class="koboSpan" id="kobo.1994.1">filter</span></strong><span class="koboSpan" id="kobo.1995.1"> table is assumed. </span><span class="koboSpan" id="kobo.1995.2">Thus, the following command lists all the chains and rules for the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.1996.1">filter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.1997.1"> table:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.1998.1">
sudo iptables -L</span></pre> <p><span class="koboSpan" id="kobo.1999.1">On a system with a default firewall configuration, the output is </span><span class="No-Break"><span class="koboSpan" id="kobo.2000.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer333">
<span class="koboSpan" id="kobo.2001.1"><img alt="Figure 9.43 – Listing the current configuration in iptables" src="image/B19682_09_43.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2002.1">Figure 9.43 – Listing the current configuration in iptables</span></p>
<p><span class="koboSpan" id="kobo.2003.1">We can be more specific—for example, by listing all the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2004.1">INPUT</span></strong><span class="koboSpan" id="kobo.2005.1"> chain rules for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2006.1">nat</span></strong><span class="koboSpan" id="kobo.2007.1"> table with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2008.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2009.1">
sudo iptables -L INPUT -t nat</span></pre> <p><span class="koboSpan" id="kobo.2010.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2011.1">-t</span></strong><span class="koboSpan" id="kobo.2012.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2013.1">--table</span></strong><span class="koboSpan" id="kobo.2014.1">) option parameter is only required when </span><strong class="source-inline"><span class="koboSpan" id="kobo.2015.1">iptables</span></strong><span class="koboSpan" id="kobo.2016.1"> operations target something other than the default </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2017.1">filter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2018.1"> table.</span></span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2019.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2020.1">Unless the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2021.1">-t</span></strong><span class="koboSpan" id="kobo.2022.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2023.1">--table</span></strong><span class="koboSpan" id="kobo.2024.1">) option parameter is specified, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2025.1">iptables</span></strong><span class="koboSpan" id="kobo.2026.1"> assumes the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2027.1">filter</span></strong><span class="koboSpan" id="kobo.2028.1"> table </span><span class="No-Break"><span class="koboSpan" id="kobo.2029.1">by default.</span></span></p>
<p><span class="koboSpan" id="kobo.2030.1">When you’re </span><a id="_idIndexMarker1517"/><span class="koboSpan" id="kobo.2031.1">designing firewall rules from a clean slate, the following steps are </span><span class="No-Break"><span class="koboSpan" id="kobo.2032.1">generally recommended:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2033.1">Flush any remnants in the current </span><span class="No-Break"><span class="koboSpan" id="kobo.2034.1">firewall configuration.</span></span></li>
<li><span class="koboSpan" id="kobo.2035.1">Set up a default </span><span class="No-Break"><span class="koboSpan" id="kobo.2036.1">firewall policy.</span></span></li>
<li><span class="koboSpan" id="kobo.2037.1">Create firewall rules, making sure the more specific (or restrictive) rules are </span><span class="No-Break"><span class="koboSpan" id="kobo.2038.1">placed first.</span></span></li>
<li><span class="koboSpan" id="kobo.2039.1">Save </span><span class="No-Break"><span class="koboSpan" id="kobo.2040.1">the configuration.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.2041.1">Let’s briefly look at each of the preceding steps by creating a sample firewall configuration using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2042.1">filter</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2043.1"> table:</span></span></p>
<ol>
<li><strong class="bold"><span class="koboSpan" id="kobo.2044.1">Flushing the existing configuration</span></strong><span class="koboSpan" id="kobo.2045.1">: The following commands flush</span><a id="_idIndexMarker1518"/><span class="koboSpan" id="kobo.2046.1"> the rules from the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2047.1">filter</span></strong><span class="koboSpan" id="kobo.2048.1"> table’s chains (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2049.1">INPUT</span></strong><span class="koboSpan" id="kobo.2050.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2051.1">FORWARD</span></strong><span class="koboSpan" id="kobo.2052.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.2053.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2054.1">OUTPUT</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2055.1">):</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2056.1">sudo iptables -F INPUT</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2057.1">sudo iptables -F FORWARD</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2058.1">sudo iptables -F OUTPUT</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2059.1">The preceding commands yield no output unless there is an error or you invoke the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2060.1">iptables</span></strong><span class="koboSpan" id="kobo.2061.1"> command with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2062.1">-v</span></strong><span class="koboSpan" id="kobo.2063.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2064.1">--</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2065.1">verbose</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2066.1">) option.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2067.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.2068.1">as follows:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer334">
<span class="koboSpan" id="kobo.2069.1"><img alt="Figure 9.44 – Flushing existing configuration in iptables" src="image/B19682_09_44.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2070.1">Figure 9.44 – Flushing existing configuration in iptables</span></p>
<p class="callout-heading"><span class="koboSpan" id="kobo.2071.1">Important note</span></p>
<p class="callout"><span class="koboSpan" id="kobo.2072.1">The flushing operation will delete all the rules in a specific chain. </span><span class="koboSpan" id="kobo.2072.2">Please take into consideration that this kind of operation will disable your firewall. </span><span class="koboSpan" id="kobo.2072.3">This can also lock you out of an SSH connection if you are using one, thus be careful when using the </span><span class="No-Break"><span class="koboSpan" id="kobo.2073.1">flushing operation.</span></span></p>
<ol>
<li value="2"><strong class="bold"><span class="koboSpan" id="kobo.2074.1">Setting up a default firewall policy</span></strong><span class="koboSpan" id="kobo.2075.1">: By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2076.1">iptables</span></strong><span class="koboSpan" id="kobo.2077.1"> allows all </span><a id="_idIndexMarker1519"/><span class="koboSpan" id="kobo.2078.1">packets to pass through the networking (firewall) chain. </span><span class="koboSpan" id="kobo.2078.2">A secure firewall configuration should use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2079.1">DROP</span></strong><span class="koboSpan" id="kobo.2080.1"> as the default target for the </span><span class="No-Break"><span class="koboSpan" id="kobo.2081.1">relevant chains:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2082.1">sudo iptables -P INPUT DROP</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2083.1">sudo iptables -P FORWARD DROP</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2084.1">sudo iptables -P OUTPUT DROP</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2085.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2086.1">-P</span></strong><span class="koboSpan" id="kobo.2087.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2088.1">--policy</span></strong><span class="koboSpan" id="kobo.2089.1">) option parameter sets the policy for a specific chain (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2090.1">INPUT</span></strong><span class="koboSpan" id="kobo.2091.1">) to the given target (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2092.1">DROP</span></strong><span class="koboSpan" id="kobo.2093.1">). </span><span class="koboSpan" id="kobo.2093.2">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2094.1">DROP</span></strong><span class="koboSpan" id="kobo.2095.1"> target makes the system gracefully ignore </span><span class="No-Break"><span class="koboSpan" id="kobo.2096.1">all packets.</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2097.1">At this point, if we were to save our firewall configuration, the system wouldn’t accept any incoming or outgoing packets. </span><span class="koboSpan" id="kobo.2097.2">So, we should be careful not to inadvertently drop our access to the system if we use SSH or don’t have direct </span><span class="No-Break"><span class="koboSpan" id="kobo.2098.1">console access.</span></span></p></li> <li><strong class="bold"><span class="koboSpan" id="kobo.2099.1">Creating firewall rules</span></strong><span class="koboSpan" id="kobo.2100.1">: Let’s create some </span><a id="_idIndexMarker1520"/><span class="koboSpan" id="kobo.2101.1">example firewall rules, such as accepting SSH, DNS, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2102.1">HTTPS connections.</span></span><p class="list-inset"><span class="koboSpan" id="kobo.2103.1">The following commands enable SSH access from a local </span><span class="No-Break"><span class="koboSpan" id="kobo.2104.1">network (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2105.1">192.168.0.0/24</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2106.1">):</span></span></p><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2107.1">sudo iptables -A INPUT -p tcp --dport 22 -m state \</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2108.1"> --state NEW,ESTABLISHED -s 192.168.0.0/24 -j ACCEPT</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2109.1">sudo iptables -A OUTPUT -p tcp --sport 22 -m state \</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2110.1"> --state ESTABLISHED -s 192.168.0.0/24 -j ACCEPT</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2111.1">Let’s explain the parameters that were used in the previous </span><span class="No-Break"><span class="koboSpan" id="kobo.2112.1">code block:</span></span></p><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.2113.1">-A INPUT</span></strong><span class="koboSpan" id="kobo.2114.1">: Specifies the chain (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2115.1">INPUT</span></strong><span class="koboSpan" id="kobo.2116.1">) to append the </span><span class="No-Break"><span class="koboSpan" id="kobo.2117.1">rule to</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2118.1">-p tcp</span></strong><span class="koboSpan" id="kobo.2119.1">: The networking protocol (for example, TCP or UDP) transporting </span><span class="No-Break"><span class="koboSpan" id="kobo.2120.1">the packets</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2121.1">--dport 22</span></strong><span class="koboSpan" id="kobo.2122.1">: The destination port of </span><span class="No-Break"><span class="koboSpan" id="kobo.2123.1">the packets</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2124.1">--sport 22</span></strong><span class="koboSpan" id="kobo.2125.1">: The source port of </span><span class="No-Break"><span class="koboSpan" id="kobo.2126.1">the packets</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2127.1">-m state</span></strong><span class="koboSpan" id="kobo.2128.1">: The packet property we want to match (for </span><span class="No-Break"><span class="koboSpan" id="kobo.2129.1">example, </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2130.1">state</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2131.1">)</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2132.1">--state NEW,ESTABLISHED</span></strong><span class="koboSpan" id="kobo.2133.1">: The state(s) of the packet </span><span class="No-Break"><span class="koboSpan" id="kobo.2134.1">to match</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2135.1">-s 192.168.0.0/24</span></strong><span class="koboSpan" id="kobo.2136.1">: The source IP address/mask originating </span><span class="No-Break"><span class="koboSpan" id="kobo.2137.1">the packets</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2138.1">-j ACCEPT</span></strong><span class="koboSpan" id="kobo.2139.1">: The target or what to do with the packets (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2140.1">ACCEPT</span></strong><span class="koboSpan" id="kobo.2141.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2142.1">DROP</span></strong><span class="koboSpan" id="kobo.2143.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2144.1">REJECT</span></strong><span class="koboSpan" id="kobo.2145.1">, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2146.1">so on)</span></span></li></ul><p class="list-inset"><span class="koboSpan" id="kobo.2147.1">We used two</span><a id="_idIndexMarker1521"/><span class="koboSpan" id="kobo.2148.1"> commands to enable SSH access. </span><span class="koboSpan" id="kobo.2148.2">The first allows incoming SSH traffic (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2149.1">--dport 22</span></strong><span class="koboSpan" id="kobo.2150.1">) for new and existing connections (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2151.1">-m state --state NEW,ESTABLISHED</span></strong><span class="koboSpan" id="kobo.2152.1">). </span><span class="koboSpan" id="kobo.2152.2">The second command enables SSH response traffic (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2153.1">--sport 22</span></strong><span class="koboSpan" id="kobo.2154.1">) for existing connections (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2155.1">-m state –</span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2156.1">state ESTABLISHED</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2157.1">).</span></span></p><p class="list-inset"><span class="koboSpan" id="kobo.2158.1">Similarly, the following commands enable </span><span class="No-Break"><span class="koboSpan" id="kobo.2159.1">HTTPS traffic:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.2160.1">sudo iptables -A INPUT -p tcp --dport 443 -m state \</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2161.1"> --state NEW,ESTABLISHED -j ACCEPT</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2162.1">sudo iptables -A OUTPUT -p tcp --sport 443 -m state \</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2163.1"> --state ESTABLISHED,RELATED -j ACCEPT</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2164.1">To enable DNS traffic, we need to use the </span><span class="No-Break"><span class="koboSpan" id="kobo.2165.1">following commands:</span></span></p><pre class="source-code"><strong class="bold"><span class="koboSpan" id="kobo.2166.1">sudo iptables -A INPUT -p udp --dport 53 -j ACCEPT</span></strong>
<strong class="bold"><span class="koboSpan" id="kobo.2167.1">sudo iptables -A OUTPUT -p udp --sport 53 -j ACCEPT</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2168.1">For more information on the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2169.1">iptables</span></strong><span class="koboSpan" id="kobo.2170.1"> option parameters, please refer to the following system </span><span class="No-Break"><span class="koboSpan" id="kobo.2171.1">reference manuals:</span></span></p><ul><li><strong class="source-inline"><span class="koboSpan" id="kobo.2172.1">iptables</span></strong><span class="koboSpan" id="kobo.2173.1"> (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2174.1">man iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2175.1">)</span></span></li><li><strong class="source-inline"><span class="koboSpan" id="kobo.2176.1">iptables-extensions</span></strong><span class="koboSpan" id="kobo.2177.1"> (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2178.1">man iptables-extensions</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2179.1">)</span></span></li></ul></li> <li><strong class="bold"><span class="koboSpan" id="kobo.2180.1">Saving the configuration</span></strong><span class="koboSpan" id="kobo.2181.1">: To save the</span><a id="_idIndexMarker1522"/><span class="koboSpan" id="kobo.2182.1"> current </span><strong class="source-inline"><span class="koboSpan" id="kobo.2183.1">iptables</span></strong><span class="koboSpan" id="kobo.2184.1"> configuration, we must run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2185.1">following command:</span></span><pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2186.1">sudo service iptables save</span></strong></pre><p class="list-inset"><span class="koboSpan" id="kobo.2187.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.2188.1">as follows:</span></span></p></li> </ol>
<div>
<div class="IMG---Figure" id="_idContainer335">
<span class="koboSpan" id="kobo.2189.1"><img alt="Figure 9.45 – Saving the iptables configuration" src="image/B19682_09_45.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2190.1">Figure 9.45 – Saving the iptables configuration</span></p>
<p class="list-inset"><span class="koboSpan" id="kobo.2191.1">We can also dump the current configuration to a file (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2192.1">iptables.config</span></strong><span class="koboSpan" id="kobo.2193.1">) for later use with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2194.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2195.1">sudo iptables-save -f iptables.config</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2196.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2197.1">-f</span></strong><span class="koboSpan" id="kobo.2198.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2199.1">--file</span></strong><span class="koboSpan" id="kobo.2200.1">) option parameter specifies the file to save (back up) the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2201.1">iptables</span></strong><span class="koboSpan" id="kobo.2202.1"> configuration in. </span><span class="koboSpan" id="kobo.2202.2">We can restore the saved </span><strong class="source-inline"><span class="koboSpan" id="kobo.2203.1">iptables</span></strong><span class="koboSpan" id="kobo.2204.1"> configuration later with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2205.1">following command:</span></span></p>
<pre class="source-code">
<strong class="bold"><span class="koboSpan" id="kobo.2206.1">sudo iptables-restore ./iptables.config</span></strong></pre> <p class="list-inset"><span class="koboSpan" id="kobo.2207.1">Here, we can specify an arbitrary path to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2208.1">iptables</span></strong><span class="koboSpan" id="kobo.2209.1"> backup </span><span class="No-Break"><span class="koboSpan" id="kobo.2210.1">configuration file.</span></span></p>
<p><span class="koboSpan" id="kobo.2211.1">Exploring more complex rules and topics with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2212.1">iptables</span></strong><span class="koboSpan" id="kobo.2213.1"> is beyond the scope of this chapter. </span><span class="koboSpan" id="kobo.2213.2">The examples we’ve presented so far, accompanied by the theoretical introduction of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2214.1">iptables</span></strong><span class="koboSpan" id="kobo.2215.1">, should be a good start for everyone to explore more advanced configurations. </span><span class="koboSpan" id="kobo.2215.2">Also, tools such as newly emerging </span><strong class="source-inline"><span class="koboSpan" id="kobo.2216.1">nftables</span></strong><span class="koboSpan" id="kobo.2217.1"> are getting a lot of traction in some of the more recent versions of Linux distributions, and firewall management tools such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2218.1">ufw</span></strong><span class="koboSpan" id="kobo.2219.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2220.1">firewalld</span></strong><span class="koboSpan" id="kobo.2221.1"> are used out of the box in distros such as Fedora, RHEL, openSUSE </span><span class="No-Break"><span class="koboSpan" id="kobo.2222.1">or</span></span><span class="No-Break"><a id="_idIndexMarker1523"/></span><span class="No-Break"><span class="koboSpan" id="kobo.2223.1"> Ubuntu.</span></span></p>
<p><span class="koboSpan" id="kobo.2224.1">Next, we’ll look at </span><strong class="source-inline"><span class="koboSpan" id="kobo.2225.1">nftables</span></strong><span class="koboSpan" id="kobo.2226.1">, a relatively new framework that was designed and developed by the </span><em class="italic"><span class="koboSpan" id="kobo.2227.1">Netfilter project</span></em><span class="koboSpan" id="kobo.2228.1">, built to eventually </span><span class="No-Break"><span class="koboSpan" id="kobo.2229.1">replace </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2230.1">iptables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2231.1">.</span></span></p>
<h2 id="_idParaDest-191"><a id="_idTextAnchor207"/><span class="koboSpan" id="kobo.2232.1">Introducing nftables</span></h2>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2233.1">nftables</span></strong><span class="koboSpan" id="kobo.2234.1"> is a </span><a id="_idIndexMarker1524"/><span class="koboSpan" id="kobo.2235.1">successor of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2236.1">iptables</span></strong><span class="koboSpan" id="kobo.2237.1">. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2238.1">nftables</span></strong><span class="koboSpan" id="kobo.2239.1"> is a firewall management framework that supports packet filtering, NAT, and </span><a id="_idIndexMarker1525"/><span class="koboSpan" id="kobo.2240.1">various packet shaping operations. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2241.1">nftables</span></strong><span class="koboSpan" id="kobo.2242.1"> offers notable improvements in terms of features, convenience, and performance over previous packet filtering tools, such as </span><span class="No-Break"><span class="koboSpan" id="kobo.2243.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2244.1">Lookup tables instead of linear processing </span><span class="No-Break"><span class="koboSpan" id="kobo.2245.1">of rules</span></span></li>
<li><span class="koboSpan" id="kobo.2246.1">Rules are applied individually instead of processing a </span><span class="No-Break"><span class="koboSpan" id="kobo.2247.1">complete ruleset</span></span></li>
<li><span class="koboSpan" id="kobo.2248.1">A unified framework for IPv4 and </span><span class="No-Break"><span class="koboSpan" id="kobo.2249.1">IPv6 protocols</span></span></li>
<li><span class="koboSpan" id="kobo.2250.1">No </span><span class="No-Break"><span class="koboSpan" id="kobo.2251.1">protocol-specific extensions</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2252.1">The functional principles behind </span><strong class="source-inline"><span class="koboSpan" id="kobo.2253.1">nftables</span></strong><span class="koboSpan" id="kobo.2254.1"> generally follow the design patterns presented in earlier sections about firewall networking chains—that is, Netfilter and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2255.1">iptables</span></strong><span class="koboSpan" id="kobo.2256.1">. </span><span class="koboSpan" id="kobo.2256.2">Just as with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2257.1">iptables</span></strong><span class="koboSpan" id="kobo.2258.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2259.1">nftables</span></strong><span class="koboSpan" id="kobo.2260.1"> uses tables to store chains. </span><span class="koboSpan" id="kobo.2260.2">Each chain contains a set of rules for packet </span><span class="No-Break"><span class="koboSpan" id="kobo.2261.1">filtering actions.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2262.1">nftables</span></strong><span class="koboSpan" id="kobo.2263.1"> is the default packet filtering framework in Debian and RHEL/Fedora Linux distributions, replacing the old </span><strong class="source-inline"><span class="koboSpan" id="kobo.2264.1">iptables</span></strong><span class="koboSpan" id="kobo.2265.1"> (and related) tools. </span><span class="koboSpan" id="kobo.2265.2">The command-line interface for manipulating the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2266.1">nftables</span></strong><span class="koboSpan" id="kobo.2267.1"> configuration is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2268.1">nft</span></strong><span class="koboSpan" id="kobo.2269.1">. </span><span class="koboSpan" id="kobo.2269.2">Yet some users prefer to use a more user-friendly frontend instead, such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2270.1">firewalld</span></strong><span class="koboSpan" id="kobo.2271.1"> (which recently added backend support for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2272.1">nftables</span></strong><span class="koboSpan" id="kobo.2273.1">). </span><span class="koboSpan" id="kobo.2273.2">RHEL/Fedora, for example, uses </span><strong class="source-inline"><span class="koboSpan" id="kobo.2274.1">firewalld</span></strong><span class="koboSpan" id="kobo.2275.1"> as its default firewall </span><span class="No-Break"><span class="koboSpan" id="kobo.2276.1">management solution.</span></span></p>
<p><span class="koboSpan" id="kobo.2277.1">In this section, we’ll show a few examples of how to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2278.1">nftables</span></strong><span class="koboSpan" id="kobo.2279.1"> and the related command-line utilities to perform simple firewall configuration tasks. </span><span class="koboSpan" id="kobo.2279.2">For this purpose, we’ll take an RHEL/Fedora distribution where we’ll disable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2280.1">firewalld</span></strong><span class="koboSpan" id="kobo.2281.1">. </span><span class="koboSpan" id="kobo.2281.2">Let’s have a quick look at the preparatory steps required to run the examples in </span><span class="No-Break"><span class="koboSpan" id="kobo.2282.1">this section.</span></span></p>
<h3><span class="koboSpan" id="kobo.2283.1">Prerequisites for our examples</span></h3>
<p><span class="koboSpan" id="kobo.2284.1">If you</span><a id="_idIndexMarker1526"/><span class="koboSpan" id="kobo.2285.1"> have an RHEL 7 system, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2286.1">nftables</span></strong><span class="koboSpan" id="kobo.2287.1"> is not installed by default. </span><span class="koboSpan" id="kobo.2287.2">You can install it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2288.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2289.1">
sudo yum install -y nftables</span></pre> <p><span class="koboSpan" id="kobo.2290.1">The examples in this section use a Fedora 37 distribution. </span><span class="koboSpan" id="kobo.2290.2">To directly configure </span><strong class="source-inline"><span class="koboSpan" id="kobo.2291.1">nftables</span></strong><span class="koboSpan" id="kobo.2292.1">, we need to disable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2293.1">firewalld</span></strong><span class="koboSpan" id="kobo.2294.1"> and potentially </span><strong class="source-inline"><span class="koboSpan" id="kobo.2295.1">iptables</span></strong><span class="koboSpan" id="kobo.2296.1"> (if you ran the examples in the </span><em class="italic"><span class="koboSpan" id="kobo.2297.1">Working with iptables</span></em><span class="koboSpan" id="kobo.2298.1"> section). </span><span class="koboSpan" id="kobo.2298.2">The steps for disabling </span><strong class="source-inline"><span class="koboSpan" id="kobo.2299.1">firewalld</span></strong><span class="koboSpan" id="kobo.2300.1"> were shown at the beginning of the </span><em class="italic"><span class="koboSpan" id="kobo.2301.1">Configuring </span></em><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2302.1">iptables</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2303.1"> section.</span></span></p>
<p><span class="koboSpan" id="kobo.2304.1">Also, if you have </span><strong class="source-inline"><span class="koboSpan" id="kobo.2305.1">iptables</span></strong><span class="koboSpan" id="kobo.2306.1"> enabled, you need to stop and disable the related service with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2307.1">following commands:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2308.1">
sudo systemctl stop iptables
sudo systemctl disable iptables</span></pre> <p><span class="koboSpan" id="kobo.2309.1">Next, we need to enable and </span><span class="No-Break"><span class="koboSpan" id="kobo.2310.1">start </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2311.1">nftables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2312.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2313.1">
sudo systemctl enable nftables
sudo systemctl start nftables</span></pre> <p><span class="koboSpan" id="kobo.2314.1">We can check the status of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2315.1">nftables</span></strong><span class="koboSpan" id="kobo.2316.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2317.1">following </span></span><span class="No-Break"><a id="_idIndexMarker1527"/></span><span class="No-Break"><span class="koboSpan" id="kobo.2318.1">command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2319.1">
sudo systemctl status nftables</span></pre> <p><span class="koboSpan" id="kobo.2320.1">The running status of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2321.1">nftables</span></strong><span class="koboSpan" id="kobo.2322.1"> should be </span><strong class="source-inline"><span class="koboSpan" id="kobo.2323.1">active</span></strong><span class="koboSpan" id="kobo.2324.1">, as </span><span class="No-Break"><span class="koboSpan" id="kobo.2325.1">seen here:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer336">
<span class="koboSpan" id="kobo.2326.1"><img alt="Figure 9.46 – Checking the status of nftables" src="image/B19682_09_46.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2327.1">Figure 9.46 – Checking the status of nftables</span></p>
<p><span class="koboSpan" id="kobo.2328.1">At this point, we are ready to</span><a id="_idIndexMarker1528"/><span class="koboSpan" id="kobo.2329.1"> configure </span><strong class="source-inline"><span class="koboSpan" id="kobo.2330.1">nftables</span></strong><span class="koboSpan" id="kobo.2331.1">. </span><span class="koboSpan" id="kobo.2331.2">Let’s work with a few examples in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2332.1">next section.</span></span></p>
<h3><span class="koboSpan" id="kobo.2333.1">Working with nftables</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2334.1">ntftables</span></strong><span class="koboSpan" id="kobo.2335.1"> loads its</span><a id="_idIndexMarker1529"/><span class="koboSpan" id="kobo.2336.1"> configuration from </span><strong class="source-inline"><span class="koboSpan" id="kobo.2337.1">/etc/sysconfig/nftables.conf</span></strong><span class="koboSpan" id="kobo.2338.1">. </span><span class="koboSpan" id="kobo.2338.2">We can display the content of the configuration file with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2339.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2340.1">
sudo cat /etc/sysconfig/nftables.conf</span></pre> <p><span class="koboSpan" id="kobo.2341.1">A default </span><strong class="source-inline"><span class="koboSpan" id="kobo.2342.1">nftables</span></strong><span class="koboSpan" id="kobo.2343.1"> configuration has no active entries in </span><strong class="source-inline"><span class="koboSpan" id="kobo.2344.1">nftables.conf</span></strong><span class="koboSpan" id="kobo.2345.1">, except for a </span><span class="No-Break"><span class="koboSpan" id="kobo.2346.1">few comments:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer337">
<span class="koboSpan" id="kobo.2347.1"><img alt="Figure 9.47 – The default nftables configuration file" src="image/B19682_09_47.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2348.1">Figure 9.47 – The default nftables configuration file</span></p>
<p><span class="koboSpan" id="kobo.2349.1">As the comments suggest, we have a few options for changing the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2350.1">nftables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2351.1"> configuration:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2352.1">Directly edit the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2353.1">nftables.conf</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2354.1"> file</span></span></li>
<li><span class="koboSpan" id="kobo.2355.1">Manually edit the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2356.1">/etc/nftables/main.nft</span></strong><span class="koboSpan" id="kobo.2357.1"> configuration file, then uncomment the related line </span><span class="No-Break"><span class="koboSpan" id="kobo.2358.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2359.1">nftables.conf</span></strong></span></li>
<li><span class="koboSpan" id="kobo.2360.1">Use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2361.1">nft</span></strong><span class="koboSpan" id="kobo.2362.1"> command-line utility to edit the rules and then dump the current configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.2363.1">into </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2364.1">nftables.conf</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2365.1">Regardless of the approach taken, we need to reload the updated configuration by restarting the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2366.1">nftables</span></strong><span class="koboSpan" id="kobo.2367.1"> service. </span><span class="koboSpan" id="kobo.2367.2">In this section, we’ll use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2368.1">nft</span></strong><span class="koboSpan" id="kobo.2369.1"> command-line examples to change the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2370.1">nftables</span></strong><span class="koboSpan" id="kobo.2371.1"> configuration. </span><span class="koboSpan" id="kobo.2371.2">Power users usually write </span><strong class="source-inline"><span class="koboSpan" id="kobo.2372.1">nft</span></strong><span class="koboSpan" id="kobo.2373.1"> configuration scripts, but it’s best to learn the basic </span><span class="No-Break"><span class="koboSpan" id="kobo.2374.1">steps first.</span></span></p>
<p><span class="koboSpan" id="kobo.2375.1">The following command displays all the rules in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2376.1">current configuration:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2377.1">
sudo nft list ruleset</span></pre> <p><span class="koboSpan" id="kobo.2378.1">Your system may already have some default rules set up. </span><span class="koboSpan" id="kobo.2378.2">You may choose to do a backup of the related configuration (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2379.1">/etc/sysconfig/nftables.conf</span></strong><span class="koboSpan" id="kobo.2380.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2381.1">/etc/nftables/main.nft</span></strong><span class="koboSpan" id="kobo.2382.1">) before proceeding with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2383.1">next steps.</span></span></p>
<p><span class="koboSpan" id="kobo.2384.1">The following command will flush any </span><span class="No-Break"><span class="koboSpan" id="kobo.2385.1">preexisting rules:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2386.1">
sudo nft flush ruleset</span></pre> <p><span class="koboSpan" id="kobo.2387.1">At this point, we have an empty configuration. </span><span class="koboSpan" id="kobo.2387.2">Let’s design a simple firewall </span><a id="_idIndexMarker1530"/><span class="koboSpan" id="kobo.2388.1">that accepts SSH, HTTP, and HTTPS traffic, blocking </span><span class="No-Break"><span class="koboSpan" id="kobo.2389.1">anything else.</span></span></p>
<h4><span class="koboSpan" id="kobo.2390.1">Accepting SSH, HTTP, and HTTPS traffic</span></h4>
<p><span class="koboSpan" id="kobo.2391.1">First, we need to</span><a id="_idIndexMarker1531"/><span class="koboSpan" id="kobo.2392.1"> create a table and a chain. </span><span class="koboSpan" id="kobo.2392.2">The following command </span><a id="_idIndexMarker1532"/><span class="koboSpan" id="kobo.2393.1">creates</span><a id="_idIndexMarker1533"/><span class="koboSpan" id="kobo.2394.1"> a table </span><span class="No-Break"><span class="koboSpan" id="kobo.2395.1">named </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2396.1">packt_table</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2397.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2398.1">
sudo nft add table inet </span><strong class="bold"><span class="koboSpan" id="kobo.2399.1">packt_table</span></strong></pre> <p><span class="koboSpan" id="kobo.2400.1">Next, we’ll create a chain called </span><strong class="source-inline"><span class="koboSpan" id="kobo.2401.1">packt_chain</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2402.1">within </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2403.1">packt_table</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2404.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2405.1">
sudo nft add chain inet packt_table </span><strong class="bold"><span class="koboSpan" id="kobo.2406.1">packt_chain</span></strong><span class="koboSpan" id="kobo.2407.1"> { type filter hook input priority 0 \; }</span></pre> <p><span class="koboSpan" id="kobo.2408.1">Now, we can start adding rules to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2409.1">packt_chain</span></strong><span class="koboSpan" id="kobo.2410.1">. </span><span class="koboSpan" id="kobo.2410.2">Allow SSH, HTTP, and HTTPS access with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2411.1">following rule:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2412.1">
sudo nft add rule inet packt_table packt_chain tcp dport {</span><strong class="bold"><span class="koboSpan" id="kobo.2413.1">ssh, http, https</span></strong><span class="koboSpan" id="kobo.2414.1">} accept</span></pre> <p><span class="koboSpan" id="kobo.2415.1">Let’s also enable </span><span class="No-Break"><span class="koboSpan" id="kobo.2416.1">ICMP (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2417.1">ping</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2418.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2419.1">
sudo nft add rule inet packt_table packt_chain </span><strong class="bold"><span class="koboSpan" id="kobo.2420.1">ip protocol icmp</span></strong><span class="koboSpan" id="kobo.2421.1"> accept</span></pre> <p><span class="koboSpan" id="kobo.2422.1">Finally, we will reject </span><span class="No-Break"><span class="koboSpan" id="kobo.2423.1">everything else:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2424.1">
sudo nft add rule inet packt_table packt_chain reject with icmp type port-unreachable</span></pre> <p><span class="koboSpan" id="kobo.2425.1">Now, let’s have a look at our </span><span class="No-Break"><span class="koboSpan" id="kobo.2426.1">new configuration:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2427.1">
sudo nft list ruleset</span></pre> <p><span class="koboSpan" id="kobo.2428.1">The output is </span><span class="No-Break"><span class="koboSpan" id="kobo.2429.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer338">
<span class="koboSpan" id="kobo.2430.1"><img alt="Figure 9.48 – A simple firewall configuration with nftables" src="image/B19682_09_48.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2431.1">Figure 9.48 – A simple firewall configuration with nftables</span></p>
<p><span class="koboSpan" id="kobo.2432.1">The output suggests the</span><a id="_idIndexMarker1534"/><span class="koboSpan" id="kobo.2433.1"> following settings for our input </span><span class="No-Break"><span class="koboSpan" id="kobo.2434.1">chain (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2435.1">packt_chain</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2436.1">):</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2437.1">Allow TCP traffic on destination ports </span><strong class="source-inline"><span class="koboSpan" id="kobo.2438.1">22</span></strong><span class="koboSpan" id="kobo.2439.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2440.1">80</span></strong><span class="koboSpan" id="kobo.2441.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2442.1">443</span></strong><span class="koboSpan" id="kobo.2443.1"> (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2444.1">tcp dport { 22, 80, 443 } </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2445.1">accept</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2446.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.2447.1">Allow </span><strong class="source-inline"><span class="koboSpan" id="kobo.2448.1">ping</span></strong> <a id="_idIndexMarker1535"/><span class="koboSpan" id="kobo.2449.1">requests (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2450.1">ip protocol </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2451.1">icmp accept</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2452.1">)</span></span></li>
<li><span class="koboSpan" id="kobo.2453.1">Reject everything</span><a id="_idIndexMarker1536"/><span class="koboSpan" id="kobo.2454.1"> else (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2455.1">meta nfproto </span></strong><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2456.1">ipv4 reject</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2457.1">)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2458.1">Next, we will save the current configuration </span><span class="No-Break"><span class="koboSpan" id="kobo.2459.1">to </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2460.1">/etc/nftables/packt.nft</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2461.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2462.1">
sudo nft list ruleset | sudo tee /etc/nftables/packt.nft</span></pre> <p><span class="koboSpan" id="kobo.2463.1">Finally, we will point the current </span><strong class="source-inline"><span class="koboSpan" id="kobo.2464.1">nftables</span></strong><span class="koboSpan" id="kobo.2465.1"> configuration to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2466.1">/etc/nftables/packt.nft</span></strong><span class="koboSpan" id="kobo.2467.1"> in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2468.1">/etc/sysconfig/nftables.conf</span></strong><span class="koboSpan" id="kobo.2469.1"> file by adding the </span><span class="No-Break"><span class="koboSpan" id="kobo.2470.1">following line:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2471.1">
include "/etc/nftables/packt.nft"</span></pre> <p><span class="koboSpan" id="kobo.2472.1">We will use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2473.1">vim</span></strong><span class="koboSpan" id="kobo.2474.1"> (or your editor of choice) to make </span><span class="No-Break"><span class="koboSpan" id="kobo.2475.1">this change:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2476.1">
sudo vim /etc/sysconfig/nftables.conf</span></pre> <p><span class="koboSpan" id="kobo.2477.1">The new </span><strong class="source-inline"><span class="koboSpan" id="kobo.2478.1">nftables.conf</span></strong><span class="koboSpan" id="kobo.2479.1"> file now contains the reference to our </span><strong class="source-inline"><span class="koboSpan" id="kobo.2480.1">packt.nft</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2481.1">configuration file:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer339">
<span class="koboSpan" id="kobo.2482.1"><img alt="Figure 9.49 – Including the new configuration in nftables.conf" src="image/B19682_09_49.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2483.1">Figure 9.49 – Including the new configuration in nftables.conf</span></p>
<p><span class="koboSpan" id="kobo.2484.1">The following</span><a id="_idIndexMarker1537"/><span class="koboSpan" id="kobo.2485.1"> command reloads the new </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2486.1">nftables</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2487.1"> configuration:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2488.1">
sudo systemctl restart nftables</span></pre> <p><span class="koboSpan" id="kobo.2489.1">After this </span><a id="_idIndexMarker1538"/><span class="koboSpan" id="kobo.2490.1">exercise, you can quickly write a script for configuring </span><strong class="source-inline"><span class="koboSpan" id="kobo.2491.1">nftables</span></strong><span class="koboSpan" id="kobo.2492.1"> using the output of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2493.1">nft list ruleset</span></strong><span class="koboSpan" id="kobo.2494.1"> command. </span><span class="koboSpan" id="kobo.2494.2">As a matter of fact, we just did that with the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2495.1">/etc/nftables/packt.nft</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.2496.1">configuration file.</span></span></p>
<p><span class="koboSpan" id="kobo.2497.1">With that, we will conclude</span><a id="_idIndexMarker1539"/><span class="koboSpan" id="kobo.2498.1"> our examination of packet filtering frameworks and the related command-line utilities. </span><span class="koboSpan" id="kobo.2498.2">They enable power users to have granular control over every functional aspect of underlying network chains and rules. </span><span class="koboSpan" id="kobo.2498.3">Yet, some Linux administrators may find the use of such tools overwhelming and turn to relatively simpler firewall management utilities instead. </span><span class="koboSpan" id="kobo.2498.4">So, next, we’ll look at a couple of native Linux firewall management tools that provide a more streamlined and user-friendly command-line interface for configuring and </span><span class="No-Break"><span class="koboSpan" id="kobo.2499.1">managing firewalls.</span></span></p>
<h2 id="_idParaDest-192"><a id="_idTextAnchor208"/><span class="koboSpan" id="kobo.2500.1">Using firewall managers</span></h2>
<p><strong class="bold"><span class="koboSpan" id="kobo.2501.1">Firewall managers</span></strong><span class="koboSpan" id="kobo.2502.1"> are</span><a id="_idIndexMarker1540"/><span class="koboSpan" id="kobo.2503.1"> command-line utilities with a relatively easy-to-use configuration interface of firewall security rules. </span><span class="koboSpan" id="kobo.2503.2">Generally, these tools require superuser privileges, and they are a significant asset for Linux </span><span class="No-Break"><span class="koboSpan" id="kobo.2504.1">system administrators.</span></span></p>
<p><span class="koboSpan" id="kobo.2505.1">In the following sections, we’ll present two of the most common firewall managers that are widely used across modern-day </span><span class="No-Break"><span class="koboSpan" id="kobo.2506.1">Linux distributions:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2507.1">firewalld</span></strong><span class="koboSpan" id="kobo.2508.1">: On </span><span class="No-Break"><span class="koboSpan" id="kobo.2509.1">RHEL/Fedora platforms</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2510.1">ufw</span></strong><span class="koboSpan" id="kobo.2511.1">: On </span><span class="No-Break"><span class="koboSpan" id="kobo.2512.1">Ubuntu/Debian platforms</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2513.1">Firewall managers</span><a id="_idIndexMarker1541"/><span class="koboSpan" id="kobo.2514.1"> are similar to other network security tools (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2515.1">iptables</span></strong><span class="koboSpan" id="kobo.2516.1">, Netfilter, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2517.1">nftables</span></strong><span class="koboSpan" id="kobo.2518.1">), with the main difference being that they offer a more streamlined user experience for firewall security. </span><span class="koboSpan" id="kobo.2518.2">An essential benefit of using a firewall manager is the convenience of not having to restart network daemons when you’re operating various security </span><span class="No-Break"><span class="koboSpan" id="kobo.2519.1">configuration changes.</span></span></p>
<p><span class="koboSpan" id="kobo.2520.1">Let’s start with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2521.1">firewalld</span></strong><span class="koboSpan" id="kobo.2522.1">, the default firewall manager </span><span class="No-Break"><span class="koboSpan" id="kobo.2523.1">for RHEL/Fedora.</span></span></p>
<h3><span class="koboSpan" id="kobo.2524.1">Using firewalld</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2525.1">firewalld</span></strong><span class="koboSpan" id="kobo.2526.1"> is the </span><a id="_idIndexMarker1542"/><span class="koboSpan" id="kobo.2527.1">default firewall management utility for a variety of Linux distributions, including </span><span class="No-Break"><span class="koboSpan" id="kobo.2528.1">the following:</span></span></p>
<ul>
<li><span class="koboSpan" id="kobo.2529.1">RHEL 7 (</span><span class="No-Break"><span class="koboSpan" id="kobo.2530.1">and newer)</span></span></li>
<li><span class="koboSpan" id="kobo.2531.1">openSUSE 15 (</span><span class="No-Break"><span class="koboSpan" id="kobo.2532.1">and newer)</span></span></li>
<li><span class="koboSpan" id="kobo.2533.1">Fedora 18 (</span><span class="No-Break"><span class="koboSpan" id="kobo.2534.1">and newer)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2535.1">On RHEL, if </span><strong class="source-inline"><span class="koboSpan" id="kobo.2536.1">firewalld</span></strong><span class="koboSpan" id="kobo.2537.1"> is not present, we can install it with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2538.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2539.1">
sudo yum install -y firewalld</span></pre> <p><span class="koboSpan" id="kobo.2540.1">You may also have to enable the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2541.1">firewalld</span></strong><span class="koboSpan" id="kobo.2542.1"> daemon at startup with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2543.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2544.1">
sudo systemctl enable firewalld</span></pre> <p><span class="koboSpan" id="kobo.2545.1">If you use the same system you used to execute previous examples with </span><strong class="source-inline"><span class="koboSpan" id="kobo.2546.1">iptables</span></strong><span class="koboSpan" id="kobo.2547.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2548.1">nftables</span></strong><span class="koboSpan" id="kobo.2549.1">, remember that we had to disable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2550.1">firewalld</span></strong><span class="koboSpan" id="kobo.2551.1"> at the beginning on our Fedora distribution. </span><span class="koboSpan" id="kobo.2551.2">Now, it is time to re-enable it. </span><span class="koboSpan" id="kobo.2551.3">We will use the following commands to </span><span class="No-Break"><span class="koboSpan" id="kobo.2552.1">do so:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer340">
<span class="koboSpan" id="kobo.2553.1"><img alt="Figure 9.50 – Re-enabling firewalld" src="image/B19682_09_50.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2554.1">Figure 9.50 – Re-enabling firewalld</span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2555.1">firewalld</span></strong><span class="koboSpan" id="kobo.2556.1"> has a set of </span><a id="_idIndexMarker1543"/><span class="koboSpan" id="kobo.2557.1">command-line utilities for </span><span class="No-Break"><span class="koboSpan" id="kobo.2558.1">different tasks:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2559.1">firewall-cmd</span></strong><span class="koboSpan" id="kobo.2560.1">: The primary command-line tool </span><span class="No-Break"><span class="koboSpan" id="kobo.2561.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2562.1">firewalld</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2563.1">firewall-offline-cmd</span></strong><span class="koboSpan" id="kobo.2564.1">: Used for configuring </span><strong class="source-inline"><span class="koboSpan" id="kobo.2565.1">firewalld</span></strong><span class="koboSpan" id="kobo.2566.1"> while it’s offline (</span><span class="No-Break"><span class="koboSpan" id="kobo.2567.1">not running)</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2568.1">firewall-config</span></strong><span class="koboSpan" id="kobo.2569.1">: A graphical user interface tool for </span><span class="No-Break"><span class="koboSpan" id="kobo.2570.1">configuring </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2571.1">firewalld</span></strong></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2572.1">firewall-applet</span></strong><span class="koboSpan" id="kobo.2573.1">: A system-tray app for providing essential information about </span><strong class="source-inline"><span class="koboSpan" id="kobo.2574.1">firewalld</span></strong><span class="koboSpan" id="kobo.2575.1"> (such as running status, connections, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2576.1">so on)</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2577.1">In this section, we will look at a few practical examples of using the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2578.1">firewall-cmd</span></strong><span class="koboSpan" id="kobo.2579.1"> utility. </span><span class="koboSpan" id="kobo.2579.2">For any of the other utilities, you may refer to the related system reference manual (such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2580.1">man firewall-config</span></strong><span class="koboSpan" id="kobo.2581.1">) for </span><span class="No-Break"><span class="koboSpan" id="kobo.2582.1">more information.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2583.1">firewalld</span></strong><span class="koboSpan" id="kobo.2584.1"> (and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2585.1">firewalld-cmd</span></strong><span class="koboSpan" id="kobo.2586.1">, for that matter) operates with a few key concepts related to monitoring and controlling network packets: </span><em class="italic"><span class="koboSpan" id="kobo.2587.1">zones</span></em><span class="koboSpan" id="kobo.2588.1">, </span><em class="italic"><span class="koboSpan" id="kobo.2589.1">rules</span></em><span class="koboSpan" id="kobo.2590.1">, </span><span class="No-Break"><span class="koboSpan" id="kobo.2591.1">and </span></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2592.1">targets</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2593.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.2594.1">Understanding firewalld zones</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.2595.1">Zones</span></strong><span class="koboSpan" id="kobo.2596.1"> are </span><a id="_idIndexMarker1544"/><span class="koboSpan" id="kobo.2597.1">the top organizational units of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2598.1">firewalld</span></strong><span class="koboSpan" id="kobo.2599.1"> configuration. </span><span class="koboSpan" id="kobo.2599.2">A network packet monitored </span><a id="_idIndexMarker1545"/><span class="koboSpan" id="kobo.2600.1">by </span><strong class="source-inline"><span class="koboSpan" id="kobo.2601.1">firewalld</span></strong><span class="koboSpan" id="kobo.2602.1"> belongs to a zone if it matches the network interface or IP address/netmask source associated with the zone. </span><span class="koboSpan" id="kobo.2602.2">The following command lists the names of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2603.1">predefined zones:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2604.1">
sudo firewall-cmd --get-zones</span></pre> <p><span class="koboSpan" id="kobo.2605.1">For detailed</span><a id="_idIndexMarker1546"/><span class="koboSpan" id="kobo.2606.1"> information about </span><a id="_idIndexMarker1547"/><span class="koboSpan" id="kobo.2607.1">all the zones that have currently been configured, we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2608.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2609.1">
sudo firewall-cmd --list-all-zones</span></pre> <p><span class="koboSpan" id="kobo.2610.1">Here’s an excerpt of the </span><span class="No-Break"><span class="koboSpan" id="kobo.2611.1">related output:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer341">
<span class="koboSpan" id="kobo.2612.1"><img alt="Figure 9.51 – Listing firewalld zones" src="image/B19682_09_51.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2613.1">Figure 9.51 – Listing firewalld zones</span></p>
<p><span class="koboSpan" id="kobo.2614.1">The preceding output</span><a id="_idIndexMarker1548"/><span class="koboSpan" id="kobo.2615.1"> illustrates the default (active) zone in Fedora 37 Server Edition with its own attributes, some of which will be explained next. </span><span class="koboSpan" id="kobo.2615.2">Zones associated with an interface and a source are </span><a id="_idIndexMarker1549"/><span class="koboSpan" id="kobo.2616.1">known as </span><strong class="bold"><span class="koboSpan" id="kobo.2617.1">active zones</span></strong><span class="koboSpan" id="kobo.2618.1">. </span><span class="koboSpan" id="kobo.2618.2">The following command retrieves the </span><span class="No-Break"><span class="koboSpan" id="kobo.2619.1">active zones:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2620.1">
sudo firewall-cmd --get-active-zones</span></pre> <p><span class="koboSpan" id="kobo.2621.1">The output, in our case, is </span><span class="No-Break"><span class="koboSpan" id="kobo.2622.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer342">
<span class="koboSpan" id="kobo.2623.1"><img alt="Figure 9.52 – The firewalld active zones" src="image/B19682_09_52.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2624.1">Figure 9.52 – The firewalld active zones</span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.2625.1">Interfaces</span></strong><span class="koboSpan" id="kobo.2626.1"> represent</span><a id="_idIndexMarker1550"/><span class="koboSpan" id="kobo.2627.1"> the network adapters that are attached to the localhost. </span><span class="koboSpan" id="kobo.2627.2">Active interfaces are assigned to either the default zone or a user-defined zone. </span><span class="koboSpan" id="kobo.2627.3">An interface cannot be assigned to </span><span class="No-Break"><span class="koboSpan" id="kobo.2628.1">multiple zones.</span></span></p>
<p><strong class="bold"><span class="koboSpan" id="kobo.2629.1">Sources</span></strong><span class="koboSpan" id="kobo.2630.1"> are incoming</span><a id="_idIndexMarker1551"/><span class="koboSpan" id="kobo.2631.1"> IP addresses or address ranges, and they can also be assigned to zones. </span><span class="koboSpan" id="kobo.2631.2">A single source or multiple overlapping IP address ranges cannot be assigned to more than one zone. </span><span class="koboSpan" id="kobo.2631.3">Doing so would result in undefined behavior, as it would be unclear which rule takes precedence for the </span><span class="No-Break"><span class="koboSpan" id="kobo.2632.1">related zone.</span></span></p>
<p><span class="koboSpan" id="kobo.2633.1">By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2634.1">firewalld</span></strong><span class="koboSpan" id="kobo.2635.1"> assigns all network interfaces to the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2636.1">public</span></strong><span class="koboSpan" id="kobo.2637.1"> zone without associating any sources with it. </span><span class="koboSpan" id="kobo.2637.2">Also, by default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2638.1">public</span></strong><span class="koboSpan" id="kobo.2639.1"> is the only active zone and thus the default zone. </span><span class="koboSpan" id="kobo.2639.2">The following command displays the </span><span class="No-Break"><span class="koboSpan" id="kobo.2640.1">default zone:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2641.1">
sudo firewall-cmd --get-default-zone</span></pre> <p><span class="koboSpan" id="kobo.2642.1">The default output is </span><span class="No-Break"><span class="koboSpan" id="kobo.2643.1">as follows:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer343">
<span class="koboSpan" id="kobo.2644.1"><img alt="Figure 9.53 – Displaying the default zone in firewalld" src="image/B19682_09_53.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2645.1">Figure 9.53 – Displaying the default zone in firewalld</span></p>
<p><span class="koboSpan" id="kobo.2646.1">Specifying a source for a zone is optional. </span><span class="koboSpan" id="kobo.2646.2">Consequently, for every data packet, there will be a zone with a matching network interface. </span><span class="koboSpan" id="kobo.2646.3">However, there won’t necessarily be a zone with a matching source. </span><span class="koboSpan" id="kobo.2646.4">This paradigm would play an essential role in the order in which the matching rules are evaluated. </span><span class="koboSpan" id="kobo.2646.5">We’ll discuss the related topic in the </span><em class="italic"><span class="koboSpan" id="kobo.2647.1">Understanding rule precedence</span></em><span class="koboSpan" id="kobo.2648.1"> section. </span><span class="koboSpan" id="kobo.2648.2">But first, let’s get acquainted with </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2649.1">firewalld</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2650.1"> rules.</span></span></p>
<h3><span class="koboSpan" id="kobo.2651.1">Understanding firewalld rules</span></h3>
<p><strong class="bold"><span class="koboSpan" id="kobo.2652.1">Rules</span></strong><span class="koboSpan" id="kobo.2653.1"> or </span><strong class="bold"><span class="koboSpan" id="kobo.2654.1">rich rules</span></strong><span class="koboSpan" id="kobo.2655.1"> that are </span><a id="_idIndexMarker1552"/><span class="koboSpan" id="kobo.2656.1">defined in the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2657.1">firewalld</span></strong><span class="koboSpan" id="kobo.2658.1"> configuration represent the configuration settings for controlling the data packets associated with a specific zone. </span><span class="koboSpan" id="kobo.2658.2">Usually, a rule would decide whether a packet is accepted or rejected, based on some </span><span class="No-Break"><span class="koboSpan" id="kobo.2659.1">predefined criteria.</span></span></p>
<p><span class="koboSpan" id="kobo.2660.1">For example, to block </span><strong class="source-inline"><span class="koboSpan" id="kobo.2661.1">ping</span></strong><span class="koboSpan" id="kobo.2662.1"> requests (ICMP protocol) for the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2663.1">FedoraServer</span></strong><span class="koboSpan" id="kobo.2664.1"> zone, we can add the following </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2665.1">rich-rule</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2666.1"> attribute:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2667.1">
sudo firewall-cmd --zone=FedoraServer --add-rich-rule='rule protocol value="icmp" reject'</span></pre> <p><span class="koboSpan" id="kobo.2668.1">We can retrieve the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2669.1">FedoraServer</span></strong><span class="koboSpan" id="kobo.2670.1"> zone information </span><a id="_idIndexMarker1553"/><span class="koboSpan" id="kobo.2671.1">with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2672.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2673.1">
sudo firewall-cmd --info-zone=public</span></pre> <p><span class="koboSpan" id="kobo.2674.1">The </span><strong class="source-inline"><span class="koboSpan" id="kobo.2675.1">rich-rule</span></strong><span class="koboSpan" id="kobo.2676.1"> attribute reflects the </span><span class="No-Break"><span class="koboSpan" id="kobo.2677.1">updated configuration:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer344">
<span class="koboSpan" id="kobo.2678.1"><img alt="Figure 9.54 – Getting the FedoraServer zone configuration with firewalld" src="image/B19682_09_54.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2679.1">Figure 9.54 – Getting the FedoraServer zone configuration with firewalld</span></p>
<p><span class="koboSpan" id="kobo.2680.1">At this point, our host won’t respond anymore to </span><strong class="source-inline"><span class="koboSpan" id="kobo.2681.1">ping</span></strong><span class="koboSpan" id="kobo.2682.1"> (ICMP) requests. </span><span class="koboSpan" id="kobo.2682.2">We can remove the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2683.1">rich-rule</span></strong><span class="koboSpan" id="kobo.2684.1"> attribute we just </span><a id="_idIndexMarker1554"/><span class="koboSpan" id="kobo.2685.1">added with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2686.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2687.1">
sudo firewall-cmd --zone=FedoraServer --remove-rich-rule='rule protocol value="icmp" reject'</span></pre> <p><span class="koboSpan" id="kobo.2688.1">Alternatively, we can enable ICMP access with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2689.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2690.1">
sudo firewall-cmd --zone=FedoraServer --add-rich-rule='rule protocol value="icmp" accept'</span></pre> <p><span class="koboSpan" id="kobo.2691.1">Please note that changes that are made without the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2692.1">--permanent</span></strong><span class="koboSpan" id="kobo.2693.1"> option of the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2694.1">firewall-cmd</span></strong><span class="koboSpan" id="kobo.2695.1"> utility are transient </span><a id="_idIndexMarker1555"/><span class="koboSpan" id="kobo.2696.1">and won’t persist after a system or </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2697.1">firewalld</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2698.1"> restart.</span></span></p>
<p><span class="koboSpan" id="kobo.2699.1">When no rich rules are defined or matched for a zone, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2700.1">firewalld</span></strong><span class="koboSpan" id="kobo.2701.1"> uses the zone’s target to control the packet’s behavior. </span><span class="koboSpan" id="kobo.2701.2">Let’s look at </span><span class="No-Break"><span class="koboSpan" id="kobo.2702.1">targets next.</span></span></p>
<h3><span class="koboSpan" id="kobo.2703.1">Understanding firewalld targets</span></h3>
<p><span class="koboSpan" id="kobo.2704.1">When a packet matches a specific zone, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2705.1">firewalld</span></strong><span class="koboSpan" id="kobo.2706.1"> controls the packet’s behavior based on the corresponding zone’s rich rules. </span><span class="koboSpan" id="kobo.2706.2">If there are no rich rules defined, or none of the rich rules matches the </span><a id="_idIndexMarker1556"/><span class="koboSpan" id="kobo.2707.1">data packet, the packet’s behavior is ultimately determined by the </span><strong class="bold"><span class="koboSpan" id="kobo.2708.1">target</span></strong><span class="koboSpan" id="kobo.2709.1"> associated with the zone. </span><span class="koboSpan" id="kobo.2709.2">Possible target values are </span><span class="No-Break"><span class="koboSpan" id="kobo.2710.1">as follows:</span></span></p>
<ul>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2711.1">ACCEPT</span></strong><span class="koboSpan" id="kobo.2712.1">: Accepts </span><span class="No-Break"><span class="koboSpan" id="kobo.2713.1">the packet</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2714.1">REJECT</span></strong><span class="koboSpan" id="kobo.2715.1">: Rejects the packet and responds with a </span><span class="No-Break"><span class="koboSpan" id="kobo.2716.1">reject reply</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2717.1">DROP</span></strong><span class="koboSpan" id="kobo.2718.1">: Drops the packet without </span><span class="No-Break"><span class="koboSpan" id="kobo.2719.1">a reply</span></span></li>
<li><strong class="source-inline"><span class="koboSpan" id="kobo.2720.1">default</span></strong><span class="koboSpan" id="kobo.2721.1">: Defers to the default behavior </span><span class="No-Break"><span class="koboSpan" id="kobo.2722.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2723.1">firewalld</span></strong></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2724.1">Zones, rules, and targets are key configuration elements used by </span><strong class="source-inline"><span class="koboSpan" id="kobo.2725.1">firewalld</span></strong><span class="koboSpan" id="kobo.2726.1"> when analyzing and handling data packets. </span><span class="koboSpan" id="kobo.2726.2">Packets are matched using zones and then acted upon using either rules or targets. </span><span class="koboSpan" id="kobo.2726.3">Due to the dual nature of zones—based on network interfaces and IP address/range sources—</span><strong class="source-inline"><span class="koboSpan" id="kobo.2727.1">firewalld</span></strong><span class="koboSpan" id="kobo.2728.1"> follows a specific order (or precedence) when calculating the matching criteria. </span><span class="koboSpan" id="kobo.2728.2">We’ll look at </span><span class="No-Break"><span class="koboSpan" id="kobo.2729.1">this next.</span></span></p>
<h3><span class="koboSpan" id="kobo.2730.1">Understanding rule precedence</span></h3>
<p><span class="koboSpan" id="kobo.2731.1">Let’s define the </span><a id="_idIndexMarker1557"/><span class="koboSpan" id="kobo.2732.1">terminology first. </span><span class="koboSpan" id="kobo.2732.2">We’ll refer to the zones associated</span><a id="_idIndexMarker1558"/><span class="koboSpan" id="kobo.2733.1"> with interfaces as </span><strong class="bold"><span class="koboSpan" id="kobo.2734.1">interface zones</span></strong><span class="koboSpan" id="kobo.2735.1">. </span><span class="koboSpan" id="kobo.2735.2">The zones associated with sources</span><a id="_idIndexMarker1559"/><span class="koboSpan" id="kobo.2736.1"> are known as </span><strong class="bold"><span class="koboSpan" id="kobo.2737.1">source zones</span></strong><span class="koboSpan" id="kobo.2738.1">. </span><span class="koboSpan" id="kobo.2738.2">Since zones can have both interfaces and sources assigned to them, a zone can act as either an interface zone, a source zone, </span><span class="No-Break"><span class="koboSpan" id="kobo.2739.1">or both.</span></span></p>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2740.1">firewalld</span></strong><span class="koboSpan" id="kobo.2741.1"> handles a data packet in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2742.1">following order:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2743.1">It checks the corresponding source zone. </span><span class="koboSpan" id="kobo.2743.2">There will be, at most, one such zone (since sources can only be associated with a single zone). </span><span class="koboSpan" id="kobo.2743.3">If there is a match, the packet is handled according to the rules or target associated with the zone. </span><span class="koboSpan" id="kobo.2743.4">Otherwise, data packet analysis follows as the </span><span class="No-Break"><span class="koboSpan" id="kobo.2744.1">next step.</span></span></li>
<li><span class="koboSpan" id="kobo.2745.1">It checks the corresponding interface zone. </span><span class="koboSpan" id="kobo.2745.2">Exactly one such zone would (always) exist. </span><span class="koboSpan" id="kobo.2745.3">If we have a match, the packet is handled according to the zone’s rules or target. </span><span class="koboSpan" id="kobo.2745.4">Otherwise, the packet validation follows as the </span><span class="No-Break"><span class="koboSpan" id="kobo.2746.1">next step.</span></span></li>
</ol>
<p><span class="koboSpan" id="kobo.2747.1">Let’s assume the default target of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2748.1">firewalld</span></strong><span class="koboSpan" id="kobo.2749.1">—it accepts ICMP packets and rejects everything else. </span><span class="koboSpan" id="kobo.2749.2">The key takeaway from the preceding validation workflow is that source zones have precedence over interface zones. </span><span class="koboSpan" id="kobo.2749.3">A typical design pattern for multi-zone </span><strong class="source-inline"><span class="koboSpan" id="kobo.2750.1">firewalld</span></strong><span class="koboSpan" id="kobo.2751.1"> configurations defines the </span><span class="No-Break"><span class="koboSpan" id="kobo.2752.1">following zones:</span></span></p>
<ul>
<li><strong class="bold"><span class="koboSpan" id="kobo.2753.1">Privileged source zone</span></strong><span class="koboSpan" id="kobo.2754.1">: Elevated system access from select </span><span class="No-Break"><span class="koboSpan" id="kobo.2755.1">IP addresses</span></span></li>
<li><strong class="bold"><span class="koboSpan" id="kobo.2756.1">Restrictive interface zone</span></strong><span class="koboSpan" id="kobo.2757.1">: Limited access for </span><span class="No-Break"><span class="koboSpan" id="kobo.2758.1">everyone else</span></span></li>
</ul>
<p><span class="koboSpan" id="kobo.2759.1">Let’s </span><a id="_idIndexMarker1560"/><span class="koboSpan" id="kobo.2760.1">explore some more potentially useful examples using the </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2761.1">firewall-cmd</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2762.1"> utility.</span></span></p>
<p><span class="koboSpan" id="kobo.2763.1">The following command displays services enabled in </span><span class="No-Break"><span class="koboSpan" id="kobo.2764.1">the firewall:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2765.1">
sudo firewall-cmd --list-services</span></pre> <p><span class="koboSpan" id="kobo.2766.1">The following command enables HTTPS access (</span><span class="No-Break"><span class="koboSpan" id="kobo.2767.1">port </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2768.1">443</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2769.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2770.1">
sudo firewall-cmd --zone=FedoraServer --add-service=https</span></pre> <p><span class="koboSpan" id="kobo.2771.1">To add a user-defined service or port (for example, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2772.1">8443</span></strong><span class="koboSpan" id="kobo.2773.1">), we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2774.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2775.1">
sudo firewall-cmd --zone=FedoraServer --add-port=8443/tcp</span></pre> <p><span class="koboSpan" id="kobo.2776.1">The following command lists the open ports in </span><span class="No-Break"><span class="koboSpan" id="kobo.2777.1">the firewall:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2778.1">
sudo firewall-cmd --list-ports</span></pre> <p><span class="koboSpan" id="kobo.2779.1">Invoking the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2780.1">firewall-cmd</span></strong><span class="koboSpan" id="kobo.2781.1"> command without the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2782.1">--permanent</span></strong><span class="koboSpan" id="kobo.2783.1"> option results in transient changes that won’t persist after a system (or </span><strong class="source-inline"><span class="koboSpan" id="kobo.2784.1">firewalld</span></strong><span class="koboSpan" id="kobo.2785.1">) restart. </span><span class="koboSpan" id="kobo.2785.2">To reload the previously saved (permanent) configuration of </span><strong class="source-inline"><span class="koboSpan" id="kobo.2786.1">firewalld</span></strong><span class="koboSpan" id="kobo.2787.1">, we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2788.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2789.1">
sudo firewall-cmd --reload</span></pre> <p><span class="koboSpan" id="kobo.2790.1">For more information on </span><strong class="source-inline"><span class="koboSpan" id="kobo.2791.1">firewalld</span></strong><span class="koboSpan" id="kobo.2792.1">, refer to the related system reference (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2793.1">man firewalld</span></strong><span class="koboSpan" id="kobo.2794.1">) </span><span class="No-Break"><span class="koboSpan" id="kobo.2795.1">or </span></span><a href="https://www.firewalld.org"><span class="No-Break"><span class="koboSpan" id="kobo.2796.1">https://www.firewalld.org</span></span></a><span class="No-Break"><span class="koboSpan" id="kobo.2797.1">.</span></span></p>
<h3><span class="koboSpan" id="kobo.2798.1">Using ufw</span></h3>
<p><strong class="source-inline"><span class="koboSpan" id="kobo.2799.1">ufw</span></strong><span class="koboSpan" id="kobo.2800.1"> is the</span><a id="_idIndexMarker1561"/><span class="koboSpan" id="kobo.2801.1"> default firewall manager in Ubuntu. </span><strong class="source-inline"><span class="koboSpan" id="kobo.2802.1">ufw</span></strong><span class="koboSpan" id="kobo.2803.1"> provides a relatively simple management framework for </span><strong class="source-inline"><span class="koboSpan" id="kobo.2804.1">iptables</span></strong><span class="koboSpan" id="kobo.2805.1"> and Netfilter and an easy-to-use command-line interface for manipulating </span><span class="No-Break"><span class="koboSpan" id="kobo.2806.1">the firewall.</span></span></p>
<p><span class="koboSpan" id="kobo.2807.1">Let’s look at a few examples of using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2808.1">ufw</span></strong><span class="koboSpan" id="kobo.2809.1">. </span><span class="koboSpan" id="kobo.2809.2">Please note that the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2810.1">ufw</span></strong><span class="koboSpan" id="kobo.2811.1"> command-line utility needs superuser privileges. </span><span class="koboSpan" id="kobo.2811.2">The following command reports the status </span><span class="No-Break"><span class="koboSpan" id="kobo.2812.1">of </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2813.1">ufw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2814.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2815.1">
sudo ufw status</span></pre> <p><span class="koboSpan" id="kobo.2816.1">By default, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2817.1">ufw</span></strong><span class="koboSpan" id="kobo.2818.1"> is </span><strong class="source-inline"><span class="koboSpan" id="kobo.2819.1">inactive</span></strong><span class="koboSpan" id="kobo.2820.1"> (disabled). </span><span class="koboSpan" id="kobo.2820.2">We can enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2821.1">ufw</span></strong><span class="koboSpan" id="kobo.2822.1"> with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2823.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2824.1">
sudo ufw enable</span></pre> <p><span class="koboSpan" id="kobo.2825.1">Always be careful when you enable the firewall or perform any changes that may affect your access to the system. </span><span class="koboSpan" id="kobo.2825.2">By default, when enabled, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2826.1">ufw</span></strong><span class="koboSpan" id="kobo.2827.1"> will block all incoming access except </span><strong class="source-inline"><span class="koboSpan" id="kobo.2828.1">ping</span></strong><span class="koboSpan" id="kobo.2829.1"> (ICMP) requests. </span><span class="koboSpan" id="kobo.2829.2">If you’re logged in with SSH, you may get a prompt warning you that the SSH connection could be lost while trying to enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2830.1">ufw</span></strong><span class="koboSpan" id="kobo.2831.1">. </span><span class="koboSpan" id="kobo.2831.2">To play it safe, you may want to abort the preceding operation by pressing </span><strong class="source-inline"><span class="koboSpan" id="kobo.2832.1">n</span></strong><span class="koboSpan" id="kobo.2833.1"> (No) and enabling SSH access in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2834.1">firewall first:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2835.1">
sudo ufw allow ssh</span></pre> <p><span class="koboSpan" id="kobo.2836.1">If SSH access is already enabled, the output suggests that the related security rule will not be added. </span><span class="koboSpan" id="kobo.2836.2">If not, the rule will </span><span class="No-Break"><span class="koboSpan" id="kobo.2837.1">be added.</span></span></p>
<p><span class="koboSpan" id="kobo.2838.1">At this point, you can safely enable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2839.1">ufw</span></strong><span class="koboSpan" id="kobo.2840.1"> without fearing that your current or existing SSH connections will be dropped. </span><span class="koboSpan" id="kobo.2840.2">Upon enabling </span><strong class="source-inline"><span class="koboSpan" id="kobo.2841.1">ufw</span></strong><span class="koboSpan" id="kobo.2842.1">, we get the same prompt as before, but this time, we can press </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2843.1">y</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2844.1"> (Yes).</span></span></p>
<p><span class="koboSpan" id="kobo.2845.1">To check</span><a id="_idIndexMarker1562"/><span class="koboSpan" id="kobo.2846.1"> upon a detailed status of the firewall, you can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2847.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2848.1">
sudo ufw status verbose</span></pre> <p><span class="koboSpan" id="kobo.2849.1">The output for running all these commands is shown in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2850.1">following screenshot:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer345">
<span class="koboSpan" id="kobo.2851.1"><img alt="Figure 9.55 – Enabling ufw, allowing ssh, and detailed status of ufw" src="image/B19682_09_55.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2852.1">Figure 9.55 – Enabling ufw, allowing ssh, and detailed status of ufw</span></p>
<p><span class="koboSpan" id="kobo.2853.1">It’s always recommended to check your firewall settings to ensure that inadvertent access to the system is </span><span class="No-Break"><span class="koboSpan" id="kobo.2854.1">not allowed.</span></span></p>
<p><span class="koboSpan" id="kobo.2855.1">We can list the current application security profiles with the </span><span class="No-Break"><span class="koboSpan" id="kobo.2856.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2857.1">
sudo ufw app list</span></pre> <p><span class="koboSpan" id="kobo.2858.1">In our case, only OpenSSH is available, activated when we allowed SSH connections earlier in </span><span class="No-Break"><span class="koboSpan" id="kobo.2859.1">this section.</span></span></p>
<p><span class="koboSpan" id="kobo.2860.1">Let us add other services, such as HTTP (port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2861.1">80</span></strong><span class="koboSpan" id="kobo.2862.1">) and HTTPS (port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2863.1">443</span></strong><span class="koboSpan" id="kobo.2864.1">), used by Apache and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2865.1">nginx</span></strong><span class="koboSpan" id="kobo.2866.1">. </span><span class="koboSpan" id="kobo.2866.2">This can be achieved in several different ways. </span><span class="koboSpan" id="kobo.2866.3">We can either use port numbers (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2867.1">80</span></strong><span class="koboSpan" id="kobo.2868.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2869.1">443</span></strong><span class="koboSpan" id="kobo.2870.1">), we can use service names as an alternate way (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2871.1">http</span></strong><span class="koboSpan" id="kobo.2872.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2873.1">https</span></strong><span class="koboSpan" id="kobo.2874.1">), or we can specify web server names directly (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2875.1">Apache Full</span></strong><span class="koboSpan" id="kobo.2876.1">, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2877.1">Nginx Full</span></strong><span class="koboSpan" id="kobo.2878.1">). </span><span class="koboSpan" id="kobo.2878.2">Details are shown in </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2879.1">Figure 9</span></em></span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.2880.1">.56</span></em></span><span class="No-Break"><span class="koboSpan" id="kobo.2881.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2882.1">To remove a</span><a id="_idIndexMarker1563"/><span class="koboSpan" id="kobo.2883.1"> specific service’s access (such as HTTP), we can run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2884.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2885.1">
sudo ufw deny http</span></pre> <p><span class="koboSpan" id="kobo.2886.1">The output shows that a new rule has been added. </span><span class="koboSpan" id="kobo.2886.2">A subsequent detailed status check would show that access to port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2887.1">80/tcp</span></strong><span class="koboSpan" id="kobo.2888.1"> has been denied. </span><span class="koboSpan" id="kobo.2888.2">Yet, the resulting status is somewhat convoluted. </span><span class="koboSpan" id="kobo.2888.3">In the following screenshot, we can see the output of adding and removing the commands that </span><a id="_idIndexMarker1564"/><span class="koboSpan" id="kobo.2889.1">were </span><span class="No-Break"><span class="koboSpan" id="kobo.2890.1">just discussed:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer346">
<span class="koboSpan" id="kobo.2891.1"><img alt="Figure 9.56 – Adding and denying rules in ufw" src="image/B19682_09_56.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2892.1">Figure 9.56 – Adding and denying rules in ufw</span></p>
<p><span class="koboSpan" id="kobo.2893.1">To reinstate the rules in the right order, let’s get a numbered output of the rule </span><span class="No-Break"><span class="koboSpan" id="kobo.2894.1">list first:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2895.1">
sudo ufw status numbered</span></pre> <p><span class="koboSpan" id="kobo.2896.1">The output yields the </span><span class="No-Break"><span class="koboSpan" id="kobo.2897.1">following result:</span></span></p>
<div>
<div class="IMG---Figure" id="_idContainer347">
<span class="koboSpan" id="kobo.2898.1"><img alt="Figure 9.57 – Numbered list of rules in ufw" src="image/B19682_09_57.jpg"/></span>
</div>
</div>
<p class="IMG---Caption" lang="en-US" xml:lang="en-US"><span class="koboSpan" id="kobo.2899.1">Figure 9.57 – Numbered list of rules in ufw</span></p>
<p><span class="koboSpan" id="kobo.2900.1">The order of the rules is suggested by sequence numbers. </span><span class="koboSpan" id="kobo.2900.2">Always</span><a id="_idIndexMarker1565"/><span class="koboSpan" id="kobo.2901.1"> put more specific (restrictive) rules first. </span><span class="koboSpan" id="kobo.2901.2">As rules are being added or changed, you may need to delete old entries or rearrange their order to ensure that the rules are appropriately placed </span><span class="No-Break"><span class="koboSpan" id="kobo.2902.1">and evaluated.</span></span></p>
<p><span class="koboSpan" id="kobo.2903.1">Alternatively, we could use the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2904.1">insert</span></strong><span class="koboSpan" id="kobo.2905.1"> option to add a specific rule at a given position. </span><span class="koboSpan" id="kobo.2905.2">For example, the following command places the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2906.1">80/tcp DENY</span></strong><span class="koboSpan" id="kobo.2907.1"> rule in the </span><span class="No-Break"><span class="koboSpan" id="kobo.2908.1">second position:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2909.1">
sudo ufw insert 2 deny http</span></pre> <p><span class="koboSpan" id="kobo.2910.1">Let’s look at a few more examples of using </span><strong class="source-inline"><span class="koboSpan" id="kobo.2911.1">ufw</span></strong><span class="koboSpan" id="kobo.2912.1">. </span><span class="koboSpan" id="kobo.2912.2">The following command enables SSH access (port </span><strong class="source-inline"><span class="koboSpan" id="kobo.2913.1">22</span></strong><span class="koboSpan" id="kobo.2914.1">) for all protocols (</span><strong class="source-inline"><span class="koboSpan" id="kobo.2915.1">any</span></strong><span class="koboSpan" id="kobo.2916.1">) from a specific source address </span><span class="No-Break"><span class="koboSpan" id="kobo.2917.1">range (</span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2918.1">192.168.0.0/24</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2919.1">):</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2920.1">
sudo ufw allow from 192.168.0.0/24 to any port 22</span></pre> <p><span class="koboSpan" id="kobo.2921.1">The following command enables </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2922.1">ufw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2923.1"> logging:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2924.1">
sudo ufw logging on</span></pre> <p><span class="koboSpan" id="kobo.2925.1">The corresponding log traces are usually </span><span class="No-Break"><span class="koboSpan" id="kobo.2926.1">in </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2927.1">/var/log/syslog</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2928.1">:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2929.1">
grep -i ufw /var/log/syslog</span></pre> <p><span class="koboSpan" id="kobo.2930.1">To disable </span><strong class="source-inline"><span class="koboSpan" id="kobo.2931.1">ufw</span></strong><span class="koboSpan" id="kobo.2932.1"> logging, run the </span><span class="No-Break"><span class="koboSpan" id="kobo.2933.1">following command:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2934.1">
sudo ufw logging off</span></pre> <p><span class="koboSpan" id="kobo.2935.1">The following command reverts </span><strong class="source-inline"><span class="koboSpan" id="kobo.2936.1">ufw</span></strong><span class="koboSpan" id="kobo.2937.1"> to the </span><span class="No-Break"><span class="koboSpan" id="kobo.2938.1">system’s defaults:</span></span></p>
<pre class="console"><span class="koboSpan" id="kobo.2939.1">
sudo ufw reset</span></pre> <p><span class="koboSpan" id="kobo.2940.1">The preceding command results in removing all rules and </span><span class="No-Break"><span class="koboSpan" id="kobo.2941.1">disabling </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2942.1">ufw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2943.1">.</span></span></p>
<p><span class="koboSpan" id="kobo.2944.1">For more information </span><a id="_idIndexMarker1566"/><span class="koboSpan" id="kobo.2945.1">about </span><strong class="source-inline"><span class="koboSpan" id="kobo.2946.1">ufw</span></strong><span class="koboSpan" id="kobo.2947.1">, you may wish to explore the </span><em class="italic"><span class="koboSpan" id="kobo.2948.1">UFW Community Help</span></em><span class="koboSpan" id="kobo.2949.1"> wiki at </span><a href="https://help.ubuntu.com/community/UFW"><span class="koboSpan" id="kobo.2950.1">https://help.ubuntu.com/community/UFW</span></a><span class="koboSpan" id="kobo.2951.1"> or the related system reference (</span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.2952.1">man ufw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.2953.1">).</span></span></p>
<p><span class="koboSpan" id="kobo.2954.1">The use of</span><a id="_idIndexMarker1567"/><span class="koboSpan" id="kobo.2955.1"> firewall management tools such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2956.1">ufw</span></strong><span class="koboSpan" id="kobo.2957.1"> and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2958.1">firewalld</span></strong><span class="koboSpan" id="kobo.2959.1"> may have more appeal to some Linux administrators, compared with lower-level packet filtering utilities (for example, Netfilter, </span><strong class="source-inline"><span class="koboSpan" id="kobo.2960.1">iptables</span></strong><span class="koboSpan" id="kobo.2961.1">, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2962.1">nftables</span></strong><span class="koboSpan" id="kobo.2963.1">). </span><span class="koboSpan" id="kobo.2963.2">One of the arguments for choosing one tool over the other, besides platform considerations, is related to scripting and automation capabilities. </span><span class="koboSpan" id="kobo.2963.3">Some power users may consider the </span><strong class="source-inline"><span class="koboSpan" id="kobo.2964.1">nft</span></strong><span class="koboSpan" id="kobo.2965.1"> command-line utility the tool of choice for designing their firewall rules, due to the granular control provided by </span><strong class="source-inline"><span class="koboSpan" id="kobo.2966.1">nftables</span></strong><span class="koboSpan" id="kobo.2967.1">. </span><span class="koboSpan" id="kobo.2967.2">Other users may be inclined to use </span><strong class="source-inline"><span class="koboSpan" id="kobo.2968.1">iptables</span></strong><span class="koboSpan" id="kobo.2969.1">, especially on older legacy platforms. </span><span class="koboSpan" id="kobo.2969.2">In the end, it’s a matter of choice or preference, as all of these tools are capable of configuring and managing a firewall to roughly the </span><span class="No-Break"><span class="koboSpan" id="kobo.2970.1">same extent.</span></span></p>
<p><span class="koboSpan" id="kobo.2971.1">Let’s wrap up our chapter with some </span><span class="No-Break"><span class="koboSpan" id="kobo.2972.1">final considerations.</span></span></p>
<h1 id="_idParaDest-193"><a id="_idTextAnchor209"/><span class="koboSpan" id="kobo.2973.1">Summary</span></h1>
<p><span class="koboSpan" id="kobo.2974.1">The relatively vast content of this chapter may appear overwhelming. </span><span class="koboSpan" id="kobo.2974.2">A key takeaway should be the focus on the frameworks (modules). </span><span class="koboSpan" id="kobo.2974.3">If we’re discussing firewalls, we should look at packet filtering frameworks such as </span><strong class="source-inline"><span class="koboSpan" id="kobo.2975.1">iptables</span></strong><span class="koboSpan" id="kobo.2976.1">, Netfilter, and </span><strong class="source-inline"><span class="koboSpan" id="kobo.2977.1">nftables</span></strong><span class="koboSpan" id="kobo.2978.1">. </span><span class="koboSpan" id="kobo.2978.2">For access control, we have security modules such as SELinux and AppArmor. </span><span class="koboSpan" id="kobo.2978.3">We covered some of the pros and cons of each. </span><span class="koboSpan" id="kobo.2978.4">The pivoting choice, possibly deciding the Linux distro, is between AppArmor and SELinux. </span><span class="koboSpan" id="kobo.2978.5">One is perhaps swifter than the other, with the related administration effort hanging in the balance. </span><span class="koboSpan" id="kobo.2978.6">For example, choosing AppArmor would narrow down the major Linux distributions to Ubuntu, Debian, and openSUSE. </span><span class="koboSpan" id="kobo.2978.7">The distro choice, in turn, would further dictate the available firewall management solutions, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2979.1">so on.</span></span></p>
<p><span class="koboSpan" id="kobo.2980.1">Mastering the application security frameworks and firewall management tools will help you keep your systems safe with minimal effort. </span><span class="koboSpan" id="kobo.2980.2">As with any typical Linux system administration task, there are many ways of securing your system. </span><span class="koboSpan" id="kobo.2980.3">We hope that you will build upon the exploratory knowledge and tools presented in this chapter to make a balanced decision regarding keeping your </span><span class="No-Break"><span class="koboSpan" id="kobo.2981.1">systems secure.</span></span></p>
<p><span class="koboSpan" id="kobo.2982.1">The next chapter will add a further notch to the safety and protection of your system by introducing </span><strong class="bold"><span class="koboSpan" id="kobo.2983.1">disaster recovery</span></strong><span class="koboSpan" id="kobo.2984.1"> (</span><strong class="bold"><span class="koboSpan" id="kobo.2985.1">DR</span></strong><span class="koboSpan" id="kobo.2986.1">), diagnostics, and </span><span class="No-Break"><span class="koboSpan" id="kobo.2987.1">troubleshooting practices.</span></span></p>
<h1 id="_idParaDest-194"><a id="_idTextAnchor210"/><span class="koboSpan" id="kobo.2988.1">Exercises</span></h1>
<p><span class="koboSpan" id="kobo.2989.1">Here’s a brief quiz about some of the essential concepts that were covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.2990.1">this chapter:</span></span></p>
<ol>
<li><span class="koboSpan" id="kobo.2991.1">Enumerate at least a couple of ACMs that are used </span><span class="No-Break"><span class="koboSpan" id="kobo.2992.1">in Linux.</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.2993.1">Hint</span></strong><span class="koboSpan" id="kobo.2994.1">: DAC, ACL, MAC, RBAC, </span><span class="No-Break"><span class="koboSpan" id="kobo.2995.1">MLS, MCS</span></span></p></li>
<li><span class="koboSpan" id="kobo.2996.1">Enumerate the fields of the SELinux </span><span class="No-Break"><span class="koboSpan" id="kobo.2997.1">security context.</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.2998.1">Hint</span></strong><span class="koboSpan" id="kobo.2999.1">: user, role, </span><span class="No-Break"><span class="koboSpan" id="kobo.3000.1">type, level</span></span></p></li>
<li><span class="koboSpan" id="kobo.3001.1">What is a domain </span><span class="No-Break"><span class="koboSpan" id="kobo.3002.1">in SELinux?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.3003.1">Hint</span></strong><span class="koboSpan" id="kobo.3004.1">: Type assigned to </span><span class="No-Break"><span class="koboSpan" id="kobo.3005.1">a process</span></span></p></li>
<li><span class="koboSpan" id="kobo.3006.1">Can you think of a significant difference between SELinux and AppArmor in terms of enforcing </span><span class="No-Break"><span class="koboSpan" id="kobo.3007.1">security policies?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.3008.1">Hint</span></strong><span class="koboSpan" id="kobo.3009.1">: SELinux uses policies based on file labels, while AppArmor uses security policies based </span><span class="No-Break"><span class="koboSpan" id="kobo.3010.1">on paths.</span></span></p></li>
<li><span class="koboSpan" id="kobo.3011.1">How do we toggle an AppArmor application profile between the </span><strong class="source-inline"><span class="koboSpan" id="kobo.3012.1">enforce</span></strong><span class="koboSpan" id="kobo.3013.1"> and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3014.1">complain</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3015.1"> modes?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.3016.1">Hint</span></strong><span class="koboSpan" id="kobo.3017.1">: Using </span><strong class="source-inline"><span class="koboSpan" id="kobo.3018.1">aa-enforce</span></strong> <span class="No-Break"><span class="koboSpan" id="kobo.3019.1">and </span></span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3020.1">aa-complain</span></strong></span></p></li>
<li><span class="koboSpan" id="kobo.3021.1">How many chains can you think of in the Linux kernel </span><span class="No-Break"><span class="koboSpan" id="kobo.3022.1">networking stack?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.3023.1">Hint</span></strong><span class="koboSpan" id="kobo.3024.1">: </span><span class="No-Break"><em class="italic"><span class="koboSpan" id="kobo.3025.1">Figure 9</span></em></span><em class="italic"><span class="koboSpan" id="kobo.3026.1">.41</span></em><span class="koboSpan" id="kobo.3027.1"> could </span><span class="No-Break"><span class="koboSpan" id="kobo.3028.1">help you.</span></span></p></li>
<li><span class="koboSpan" id="kobo.3029.1">What is the default firewall management solution in RHEL/Fedora? </span><span class="koboSpan" id="kobo.3029.2">How </span><span class="No-Break"><span class="koboSpan" id="kobo.3030.1">about Ubuntu?</span></span><p class="list-inset"><strong class="bold"><span class="koboSpan" id="kobo.3031.1">Hint</span></strong><span class="koboSpan" id="kobo.3032.1">: </span><strong class="source-inline"><span class="koboSpan" id="kobo.3033.1">firewalld</span></strong><span class="koboSpan" id="kobo.3034.1"> (Fedora) and </span><span class="No-Break"><strong class="source-inline"><span class="koboSpan" id="kobo.3035.1">ufw</span></strong></span><span class="No-Break"><span class="koboSpan" id="kobo.3036.1"> (Ubuntu)</span></span></p></li>
</ol>
<h1 id="_idParaDest-195"><a id="_idTextAnchor211"/><span class="koboSpan" id="kobo.3037.1">Further reading</span></h1>
<p><span class="koboSpan" id="kobo.3038.1">Please refer to the following Packt books for more information about the topics that were covered in </span><span class="No-Break"><span class="koboSpan" id="kobo.3039.1">this chapter:</span></span></p>
<ul>
<li><em class="italic"><span class="koboSpan" id="kobo.3040.1">Mastering Linux Security and Hardening – Second Edition</span></em><span class="koboSpan" id="kobo.3041.1"> by Donald A. </span><span class="koboSpan" id="kobo.3041.2">Tevault, </span><span class="No-Break"><span class="koboSpan" id="kobo.3042.1">Packt Publishing</span></span></li>
<li><em class="italic"><span class="koboSpan" id="kobo.3043.1">Practical Linux Security Cookbook – Second Edition</span></em><span class="koboSpan" id="kobo.3044.1"> by Tajinder Kalsi, </span><span class="No-Break"><span class="koboSpan" id="kobo.3045.1">Packt Publishing</span></span></li>
</ul>
</div>
</body></html>