<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;6.&#xA0;Orchestrating with Ansible" id="1IHDQ1-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06" class="calibre1"/>Chapter 6. Orchestrating with Ansible</h1></div></div></div><p class="calibre7">In this chapter, the following recipes will be addressed:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Installing Ansible</li><li class="listitem">Configuring the Ansible inventory</li><li class="listitem">Creating the template for a kickstart file</li><li class="listitem">Creating a playbook to deploy a new VM with kickstart</li><li class="listitem">Creating a playbook to perform system configuration tasks</li><li class="listitem">Troubleshooting Ansible</li></ul></div></div>

<div class="book" title="Chapter&#xA0;6.&#xA0;Orchestrating with Ansible" id="1IHDQ1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="Introduction"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch06lvl1sec47" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">Ansible<a id="id297" class="calibre1"/> is an easy-to-use agentless system configuration management tool. It allows us to deploy complex configurations without the hassle of a complex interface or language.</p><p class="calibre7">Ansible uses playbooks, which are collections of tasks to deploy configurations and applications to multiple nodes over SSH in a controlled way. However, it doesn't stop there.</p><p class="calibre7">Ansible's modules, which are used to execute tasks, are all built to be idempotent in their execution.</p><p class="calibre7">The definition<a id="id298" class="calibre1"/> of Idempotence, according to Wikipedia, is as follows:</p><div class="blockquote"><blockquote class="blockquote1"><p class="calibre25"><span class="strong"><em class="calibre9">Idempotence (/ˌaɪdɨmˈpoʊtəns/ eye-dəm-poh-təns [citation needed]) is the property of certain operations in mathematics and computer science that can be applied multiple times without changing the result beyond the initial application.</em></span></p></blockquote></div><p class="calibre7">In short, any module will detect the changes to be applied and perform them. If it doesn't need to change anything, it will not reapply the requested changes or interfere with file metadata.</p><p class="calibre7">The Ansible company also provides Tower, a paid subscription with extra features, as an add-on to Ansible. Tower provides a graphical interface to control your Ansible orchestration tool. However, this is out of the scope of this chapter.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Install Ansible"><div class="book" id="1JFUC2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec48" class="calibre1"/>Install Ansible</h1></div></div></div><p class="calibre7">Ansible is not in the default RHEL 7 repositories, but in this recipe, I will show you how to install it in <a id="id299" class="calibre1"/>several ways.</p></div>

<div class="book" title="Install Ansible">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec125" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Ansible needs the following packages installed:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Python v2.7 (Ansible doesn't support v3 yet)</li><li class="listitem"><code class="email">python-httplib2</code></li><li class="listitem"><code class="email">python-jinja2</code></li><li class="listitem"><code class="email">python-paramiko</code></li><li class="listitem"><code class="email">python-setuptools</code></li><li class="listitem"><code class="email">PyYAML</code></li></ul></div><p class="calibre7">So, in order to achieve this, execute the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y python-httplib2 python-jinja2 python-keyczar python-paramiko python-setuptools PyYAML</strong></span>
</pre></div><p class="calibre7">As RHEL 7 and some other major distributions come preinstalled with Python (yum requires it, as do most of the Red Hat tools), we don't have to include it in the preceding command.</p></div></div>

<div class="book" title="Install Ansible">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec126" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">In this recipe, I will cover the three most used methods of installing Ansible.</p><div class="book" title="Installing the latest tarball"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec44" class="calibre1"/>Installing the latest tarball</h3></div></div></div><p class="calibre7">This method is <a id="id300" class="calibre1"/>quite simple as you just download the tarball and extract it in a location of your choosing. Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Grab the <a id="id301" class="calibre1"/>latest tarball located at <a class="calibre1" href="http://releases.ansible.com/ansible/">http://releases.ansible.com/ansible/</a> via the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]$ curl -o /tmp/ansible-latest.tar.gz http://releases.ansible.com/ansible/ansible-latest.tar.gz</strong></span>
<span class="strong"><strong class="calibre8"> % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</strong></span>
<span class="strong"><strong class="calibre8">                                 Dload  Upload   Total   Spent    Left  Speed</strong></span>
<span class="strong"><strong class="calibre8">100  905k  100  905k    0     0   870k      0  0:00:01  0:00:01 --:--:--  870k</strong></span>
<span class="strong"><strong class="calibre8">~]$</strong></span>
</pre></div></li><li class="listitem" value="2">Extract<a id="id302" class="calibre1"/> the tarball to <code class="email">/opt</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# tar zxf /tmp/ansible-latest.tar.gz -C /opt/</strong></span>
</pre></div></li><li class="listitem" value="3">Now, create a symbolic link for easy access using this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ln -s /opt/ansible-1.9.2 /opt/ansible</strong></span>
</pre></div></li><li class="listitem" value="4">Add the Ansible binaries and man pages to your environment's path by executing the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cat &lt;&lt; EOF &gt; /etc/profile.d/ansible.sh</strong></span>
<span class="strong"><strong class="calibre8"># Ansible-related stuff</strong></span>
<span class="strong"><strong class="calibre8">export ANSIBLE_HOME=/opt/ansible</strong></span>
<span class="strong"><strong class="calibre8">export PATH=\${PATH-""}:${ANSIBLE_HOME}/bin</strong></span>
<span class="strong"><strong class="calibre8">export MANPATH=\${MANPATH-""}:${ANSIBLE_HOME}/docs/man</strong></span>
<span class="strong"><strong class="calibre8">export PYTHONPATH=\${PYTHONPATH-""}:${ ANSIBLE_HOME}/lib</strong></span>
<span class="strong"><strong class="calibre8">EOF</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li><li class="listitem" value="5">Next, source the Ansible PATH and MANPATH by running this command line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# . /etc/profile.d/ansible.sh</strong></span>
</pre></div></li><li class="listitem" value="6">Finally, use the following command to regenerate the man pages:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# /etc/cron.daily/man-db.cron</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div><div class="book" title="Installing cutting edge from Git"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec45" class="calibre1"/>Installing cutting edge from Git</h3></div></div></div><p class="calibre7">Git makes<a id="id303" class="calibre1"/> keeping your local copy of Ansible up to date quite <a id="id304" class="calibre1"/>simple.</p><p class="calibre7">It automatically updates/removes files where needed. Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Make sure <code class="email">git</code> is installed using this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y git</strong></span>
</pre></div></li><li class="listitem" value="2">Clone the Ansible <code class="email">git</code> repository to <code class="email">/opt</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cd /opt</strong></span>
<span class="strong"><strong class="calibre8">~]# git clone git://github.com/ansible/ansible.git --recursive</strong></span>
</pre></div><div class="mediaobject"><img src="../images/00050.jpeg" alt="Installing cutting edge from Git" class="calibre10"/></div><p class="calibre15"> </p></li><li class="listitem" value="3">Add the <a id="id305" class="calibre1"/>Ansible binaries and man pages to<a id="id306" class="calibre1"/> your environment's path, through the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cat &lt;&lt; EOF &gt; /etc/profile.d/ansible.sh</strong></span>
<span class="strong"><strong class="calibre8"># Ansible-related stuff</strong></span>
<span class="strong"><strong class="calibre8">export ANSIBLE_HOME=/opt/ansible</strong></span>
<span class="strong"><strong class="calibre8">export PATH=\${PATH-""}:${ANSIBLE_HOME}/bin</strong></span>
<span class="strong"><strong class="calibre8">export MANPATH=\${MANPATH-""}:${ANSIBLE_HOME}/docs/man</strong></span>
<span class="strong"><strong class="calibre8">export PYTHONPATH=\${PYTHONPATH-""}:${ ANSIBLE_HOME}/lib</strong></span>
<span class="strong"><strong class="calibre8">EOF</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li><li class="listitem" value="4">Now, source the Ansible PATH and MANPATH via this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# . /etc/profile.d/ansible.sh</strong></span>
</pre></div></li><li class="listitem" value="5">Finally, using the following line, regenerate the man pages:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# /etc/cron.daily/man-db.cron</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div><div class="book" title="Installing Ansible from the EPEL repository"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec46" class="calibre1"/>Installing Ansible from the EPEL repository</h3></div></div></div><p class="calibre7">Installing<a id="id307" class="calibre1"/> from a repository<a id="id308" class="calibre1"/> has the advantage that you can keep your version of Ansible up to date along with your system. Here are the steps you need to perform:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Install the <a id="id309" class="calibre1"/>extra packages for the <span class="strong"><strong class="calibre8">Enterprise Linux</strong></span> (<span class="strong"><strong class="calibre8">EPEL</strong></span>) repository from <a class="calibre1" href="https://fedoraproject.org/wiki/EPEL">https://fedoraproject.org/wiki/EPEL</a> via this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</strong></span>
</pre></div></li><li class="listitem" value="2">Now, install Ansible using yum, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# yum install -y ansible</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div></div>

<div class="book" title="Install Ansible">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec127" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">If you want to keep your Git clone up to date, remember that the sources tree also contains two subtrees. You'll have to execute the following:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# git pull --release</strong></span>
<span class="strong"><strong class="calibre8">~]# git submodule update --init --recursive</strong></span>
</pre></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Configuring the Ansible inventory"><div class="book" id="1KEEU2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec49" class="calibre1"/>Configuring the Ansible inventory</h1></div></div></div><p class="calibre7">The Ansible inventory is the heart of the product as it provides a lot of variables about your environment<a id="id310" class="calibre1"/> to the deployment mechanism. These variables are known as <code class="email">facts</code> and serve Ansible to make decisions, template text-based files, and so on.</p></div>

<div class="book" title="Configuring the Ansible inventory">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec128" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">There are several ways of adding information about your environment to your inventory.</p><div class="book" title="The static inventory file"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec47" class="calibre1"/>The static inventory file</h3></div></div></div><p class="calibre7">The<a id="id311" class="calibre1"/> static inventory is basically a mini-formatted file<a id="id312" class="calibre1"/> containing the definitions for hosts and groups. Here's what you need to do:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create <code class="email">/etc/ansible/hosts</code> with the following contents:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cat &lt;&lt; EOF &gt;&gt; /etc/ansible/hosts</strong></span>
<span class="strong"><strong class="calibre8">localhost         ansible_connection=local</strong></span>
<span class="strong"><strong class="calibre8">srv1.domain.tld   ansible_connection=ssh ansible_ssh_user=root</strong></span>

<span class="strong"><strong class="calibre8">[mail]</strong></span>
<span class="strong"><strong class="calibre8">mail[01..50].domain.tld</strong></span>

<span class="strong"><strong class="calibre8">[mail:vars]</strong></span>
<span class="strong"><strong class="calibre8">dns_servers=[ '8.8.8.8', '8.8.4.4' ]</strong></span>
<span class="strong"><strong class="calibre8">mail_port=25</strong></span>
<span class="strong"><strong class="calibre8">EOF</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div><div class="book" title="The dynamic inventory file"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec48" class="calibre1"/>The dynamic inventory file</h3></div></div></div><p class="calibre7">The<a id="id313" class="calibre1"/> dynamic inventory file has to be an executable<a id="id314" class="calibre1"/> file, generating a JSON string containing information about your hosts and groups. Follow these steps::</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create an <code class="email">~/inventory.py</code> script with the following contents:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">-]# cat &lt;&lt; EOF &gt;&gt; ~/inventory.py</strong></span>
<span class="strong"><strong class="calibre8">#!/usr/bin/python -tt</strong></span>
<span class="strong"><strong class="calibre8"># -*- coding: utf-8 -*-</strong></span>
<span class="strong"><strong class="calibre8"># vim: tabstop=8 expandtab shiftwidth=4 softtabstop=4</strong></span>
<span class="strong"><strong class="calibre8">import json</strong></span>

<span class="strong"><strong class="calibre8">def main():</strong></span>
<span class="strong"><strong class="calibre8">    inventory = {</strong></span>
<span class="strong"><strong class="calibre8">        '_meta': {</strong></span>
<span class="strong"><strong class="calibre8">            'hostvars': {</strong></span>
<span class="strong"><strong class="calibre8">                'localhost': {</strong></span>
<span class="strong"><strong class="calibre8">                    'ansible_connection': 'local' },</strong></span>
<span class="strong"><strong class="calibre8">                'srv1.domain.tld': {</strong></span>
<span class="strong"><strong class="calibre8">                    'ansible_connection': 'ssh',</strong></span>
<span class="strong"><strong class="calibre8">                    'ansible_ssh_user': 'root' },</strong></span>
<span class="strong"><strong class="calibre8">                }</strong></span>
<span class="strong"><strong class="calibre8">            },</strong></span>
<span class="strong"><strong class="calibre8">        'all': {</strong></span>
<span class="strong"><strong class="calibre8">            'hosts': [</strong></span>
<span class="strong"><strong class="calibre8">                'localhost',</strong></span>
<span class="strong"><strong class="calibre8">                'srv1.domain.tld' ] },</strong></span>
<span class="strong"><strong class="calibre8">        'mail': {</strong></span>
<span class="strong"><strong class="calibre8">            'hosts': [],</strong></span>
<span class="strong"><strong class="calibre8">            'vars': {</strong></span>
<span class="strong"><strong class="calibre8">                'dns_servers': [ '8.8.8.8', '8.8.4.4' ],</strong></span>
<span class="strong"><strong class="calibre8">                'mail_port': 25} }</strong></span>
<span class="strong"><strong class="calibre8">    }</strong></span>

<span class="strong"><strong class="calibre8">    for x in range(1,50):</strong></span>
<span class="strong"><strong class="calibre8">        hostname = 'mail' + ('00%d' % x)[-2:] + '.domain.tld'</strong></span>
<span class="strong"><strong class="calibre8">        inventory['_meta']['hostvars'].update({ hostname: {} })</strong></span>
<span class="strong"><strong class="calibre8">        inventory['mail']['hosts'].append(hostname)</strong></span>



<span class="strong"><strong class="calibre8">    print json.dumps(inventory, sort_keys=True, indent=4, separators=(',',': '))</strong></span>

<span class="strong"><strong class="calibre8">if __name__ == '__main__':</strong></span>
<span class="strong"><strong class="calibre8">    main()</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li><li class="listitem" value="2">Now, make the script executable, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# chmod +x ~/inventory.py</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div><div class="book" title="host_vars files"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec49" class="calibre1"/>host_vars files</h3></div></div></div><p class="calibre7">A <code class="email">host_vars</code> file<a id="id315" class="calibre1"/> is a <code class="email">yml</code>-formatted one containing<a id="id316" class="calibre1"/> extra facts, which will only be applied to the host with the same name as the file. Simply do the following:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a <code class="email">host_vars</code> file for <code class="email">srv1.domain.tld</code> through this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cat &lt;&lt; EOF &gt;&gt; ~/host_vars/srv1.domain.tld.yml</strong></span>
<span class="strong"><strong class="calibre8">ansible_connection: ssh</strong></span>
<span class="strong"><strong class="calibre8">ansible_ssh_user: root</strong></span>
<span class="strong"><strong class="calibre8">EOF</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div><div class="book" title="group_vars files"><div class="book"><div class="book"><div class="book"><h3 class="title2"><a id="ch06lvl3sec50" class="calibre1"/>group_vars files</h3></div></div></div><p class="calibre7">Like <code class="email">host_vars</code>, <code class="email">group_vars</code> files are <code class="email">yml</code>-formatted ones containing extra facts. These will be<a id="id317" class="calibre1"/> applied to the group with the same name as <a id="id318" class="calibre1"/>the file. Perform the following:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a <code class="email">group_vars</code> file for mail via the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# cat &lt;&lt; EOF &gt;&gt; ~/group_vars/mail.yml</strong></span>
<span class="strong"><strong class="calibre8">dns_servers: [ '8.8.8.8', '8.8.4.4' ]</strong></span>
<span class="strong"><strong class="calibre8">mail_port: 25</strong></span>
<span class="strong"><strong class="calibre8">EOF</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div></div>

<div class="book" title="Configuring the Ansible inventory">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec129" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">The inventory file location is set in the Ansible configuration file—look for the line starting <a id="id319" class="calibre1"/>with <code class="email">hostfile</code> within the <code class="email">defaults</code> section. This file is either a static file, or a script returning a JSON-formatted list of hosts and groups, as shown in the preceding recipe. Ansible automatically detects whether a file is a script and treats it this way to import information.</p><p class="calibre7">There is one caveat, however: the script needs to show the JSON-formatted information by specifying <code class="email">--list</code>.</p><p class="calibre7">Ansible can automatically combine the inventory with the <code class="email">host_vars</code> and <code class="email">group_vars</code> files if the latter two directories are in the same directory as the inventory file / script. Take a look at the following:</p><div class="informalexample"><pre class="programlisting">/etc/ansible/hosts
/etc/ansible/host_vars
/etc/ansible/host_vars/srv1.domain.tld.yml
/etc/ansible/host_vars/...
/etc/ansible/group_vars
/etc/ansible/group_vars/mail.yml
/etc/ansible/group_vars/...</pre></div><p class="calibre7">The same can be achieved by putting the <code class="email">host_vars</code> and <code class="email">group_vars</code> directories in the same directory as the playbook you are executing.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip09" class="calibre1"/>Tip</h3><p class="calibre7">The facts in <code class="email">host_vars</code> and <code class="email">group_vars</code> take priority over the variables returned through the inventory.</p></div></div></div>

<div class="book" title="Configuring the Ansible inventory">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec130" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">Ansible already seeds the inventory with the facts that it retrieves from the host itself. You can easily find out which facts Ansible prepares for your use by executing the following <a id="id320" class="calibre1"/>command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible -m setup &lt;hostname&gt;</strong></span>
</pre></div><p class="calibre7">This will produce a lengthy JSON-formatted output with all the facts Ansible knows about your destination host.</p><p class="calibre7">If you want even more information, on RHEL systems, you can install <code class="email">redhat-lsb-core</code> to have access to LSB-specific facts.</p><p class="calibre7">Enterprises tend to have databases containing information regarding all their systems for change management. This is an excellent source for the inventory script to get its information.</p></div></div>

<div class="book" title="Configuring the Ansible inventory">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec131" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">If you want<a id="id321" class="calibre1"/> more detailed information about the Ansible inventory, go to <a class="calibre1" href="http://docs.ansible.com/ansible/intro_inventory.html">http://docs.ansible.com/ansible/intro_inventory.html</a>.</p><p class="calibre7">Shameless self-promotion for a personal project and a tool to automate the inventory calls for a mention of <a class="calibre1" href="https://github.com/bushvin/inventoryd/">https://github.com/bushvin/inventoryd/</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a template for a kickstart file" id="1LCVG1-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec50" class="calibre1"/>Creating a template for a kickstart file</h1></div></div></div><p class="calibre7">A <code class="email">template</code> is <a id="id322" class="calibre1"/>one of the core modules of Ansible. It is used to easily <a id="id323" class="calibre1"/>generate files (for example, configuration files) based on a common set of facts. It uses the Jinja2 template engine to interpret template files.</p><p class="calibre7">For this recipe, we'll use a simple <code class="email">kickstart</code> script that is generic enough to deploy any host. Refer to <a class="calibre1" title="Chapter 2. Deploying RHEL &quot;En Masse&quot;" href="part0025_split_000.html#NQU21-501a83dd54944cb1bf060a2ce9fab11f">Chapter 2</a>, <span class="strong"><em class="calibre9">Deploying RHEL "En Masse"</em></span>, to find out about <code class="email">kickstart</code> files.</p></div>

<div class="book" title="Creating a template for a kickstart file" id="1LCVG1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec132" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">The facts that we need for this host are <code class="email">repo_url</code>, <code class="email">root_password_hash</code>, <code class="email">ntp_servers</code>, <code class="email">timezone</code>, <code class="email">ipv4_address</code>, <code class="email">ipv4_netmask</code>, <code class="email">ipv4_gateway</code>, and <code class="email">dns_servers</code>.</p></div></div>

<div class="book" title="Creating a template for a kickstart file" id="1LCVG1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec133" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Create the <code class="email">kickstart</code> file in your playbook's template folder (<code class="email">~/playbooks/templates/kickstart/rhel7.ks</code>) with the following content:</p><div class="informalexample"><pre class="programlisting">install
url --url={{ repo_url }}
skipx
text
reboot
lang en_US.UTF-8
keyboard us
selinux --enforcing
firewall --enabled --ssh
rootpw –iscrypted {{ root_password_hash }}
authconfig --enableshadow --passalgo=sha512
timezone --utc --ntpservers {{ ntp_servers|join(',') }} {{ timezone }}
zerombr
clearpart --all
bootloader --location=mbr --timeout=5
part /boot --asprimary --fstype="xfs" --size=1024 --ondisk=sda
part pv.1   --size=1 --grow --ondisk=sda
volgroup {{ hostname }}_system pv.1
logvol / --vgname={{ inventory_hostname }}_system --size=2048 --name=root --fstype=xfs
logvol /usr --vgname={{ inventory_hostname }}_system --size=2048 --name=usr --fstype=xfs
logvol /var --vgname={{ inventory_hostname }}_system --size=2048 --name=var --fstype=xfs
logvol /var/log --vgname={{ inventory_hostname }}_system --size=2048 --name=varlog --fstype=xfs
logvol swap --vgname={{ inventory_hostname }}_system --recommended --name=swap --fstype=swap
network --device=eth0 --bootproto=static --onboot=yes --activate --ip={{ ipv4_address }} --netmask={{ ipv4_netmask }} --gateway={{ ipv4_gateway }} --nameserver={{ dns_servers|join(',') }}
%packages --excludedocs
@Core
vim-enhanced
%end</pre></div></div></div>

<div class="book" title="Creating a template for a kickstart file" id="1LCVG1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec134" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">The<a id="id324" class="calibre1"/> Jinja2 engine replaces all the variables enclosed by <code class="email">{{ }}</code> with whichever <a id="id325" class="calibre1"/>facts are available for the specified host in the inventory, resulting in a correct <code class="email">kickstart</code> file, assuming all variables have been correctly set.</p></div></div>

<div class="book" title="Creating a template for a kickstart file" id="1LCVG1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec135" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">Jinja2 can do more than just replace variables with whatever is in the inventory. It was originally developed as a rich templating language for web pages and supports major features such as conditions, loops, and so on.</p><p class="calibre7">Using<a id="id326" class="calibre1"/> Jinja, you can easily loop over a list or array within the inventory and <a id="id327" class="calibre1"/>use the resultant variable or even dictionaries and objects. For example, consider that your host has the following fact:</p><div class="informalexample"><pre class="programlisting">{ 'nics': [
    { 'device': 'eth0', 'ipv4': { 'address':'192.168.0.100', 'netmask':'255.255.255.0','gateway':'192.168.0.1'} },
    { 'device': 'eth1', 'ipv4': { 'address':'192.168.1.100', 'netmask':'255.255.255.0','gateway':'192.168.1.1'} } ] }</pre></div><p class="calibre7">This would allow you to replace the network portion of your <code class="email">kickstart</code> script with the following:</p><div class="informalexample"><pre class="programlisting">{% for nic in nics %}
network –device={{ nic.device }} --bootproto=static --onboot=yes --activate --ip={{ nic.ipv4.address }} --netmask={{ nic.ipv4.netmask }} --gateway={{ nic.ipv4.gateway }}
{% endfor %}</pre></div><p class="calibre7">There is one consideration with provisioning new systems such as this and the inventory: you can only use the facts that you have introduced yourself, not those that Ansible gets from the system. This is because firstly, they don't exist yet, and secondly, the task is executed on a different host.</p></div></div>

<div class="book" title="Creating a template for a kickstart file" id="1LCVG1-501a83dd54944cb1bf060a2ce9fab11f">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec136" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more<a id="id328" class="calibre1"/> information about templating with Ansible, read the Jinja2 Template Designer documentation at <a class="calibre1" href="http://jinja.pocoo.org/docs/dev/templates/">http://jinja.pocoo.org/docs/dev/templates/</a>.</p><p class="calibre7">For more<a id="id329" class="calibre1"/> information on the Ansible template module, go to <a class="calibre1" href="http://docs.ansible.com/ansible/template_module.html">http://docs.ansible.com/ansible/template_module.html</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a playbook to deploy a new VM with kickstart"><div class="book" id="1MBG22-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec51" class="calibre1"/>Creating a playbook to deploy a new VM with kickstart</h1></div></div></div><p class="calibre7">Creating <a id="id330" class="calibre1"/>playbooks for Ansible is a <a id="id331" class="calibre1"/>relatively easy task as most considerations are handled<a id="id332" class="calibre1"/> by the modules. All modules are made as "idempotently" as possible, meaning that a module first checks what it is supposed to do with what has been done on the system and only then applies the changes if they are different.</p></div>

<div class="book" title="Creating a playbook to deploy a new VM with kickstart">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec137" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">We don't need any additional facts for this recipe.</p><p class="calibre7">For this to work, we need to have a web server and a location to store the <code class="email">kickstart</code> files, which will be served by the web server.</p><p class="calibre7">For the sake of convenience, our web server is called <code class="email">web.domain.tld</code>, the location on this web <a id="id333" class="calibre1"/>server is <code class="email">/var/www/html/kickstart</code>, and this directory can be accessed through <code class="email">http://web.domain.tld/kickstart</code>.</p><p class="calibre7">We also need a KVM host (refer to <a class="calibre1" title="Chapter 1. Working with KVM Guests" href="part0015_split_000.html#E9OE1-501a83dd54944cb1bf060a2ce9fab11f">Chapter 1</a>, <span class="strong"><em class="calibre9">Working with KVM Guests</em></span>, on how to set up a KVM server). In this case, we'll call our KVM server <code class="email">kvm.domain.tld</code>.</p></div></div>

<div class="book" title="Creating a playbook to deploy a new VM with kickstart">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec138" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Let's create the playbook that will provision new systems via the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a <code class="email">~/playbooks/provisioning.yml</code> playbook with the following contents:<div class="informalexample"><pre class="programlisting">- name: Provision new machines
  hosts: all
  gather_facts: no
  tasks:
  - name: Publish kickstart template as new file to webserver
    action: template src=templates/kickstart/rhel7.ks dest=/var/www/html/kickstart/{{ inventory_hostname }}.ks
                     owner=apache group=apache mode=0644
                     seuser=system_u serole=object_r setype=httpd_sys_content_t selevel=s0
    delegate_to: web.domain.tld

  - name: Create new isolinux file to contain reference to the kickstart file
    action: template src=templates/isolinux/isolinux.cfg.el7 dest=/root/iso/isolinux/isolinux.cfg
    delegate_to: kvm.domain.tld

  - name: Create new iso boot media
    action: shell cd /root/iso; mkisofs -o /tmp/{{ inventory_hostname }}.iso -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -J -r .
    delegate_to: kvm.domain.tld
    
  - name: Create disk for the new kvm guest
    action: virsh vol-create-as --pool localfs-vm --name {{ hostname }}-vda.qcows2 --format qcows2 --capacity 15G
    delegate_to: kvm.domain.tld
    
  - name: Create new vm on KVM
    action: shell virt-install --hvm --name {{ inventory_hostname }} --ram 2048 --vcpus 2 --os-type linux  --boot hd,cdrom,network,menu=on --controller type=scsi,model=virtio-scsi --disk device=cdrom,path=/tmp/{{ inventory_hostname }}.iso,readonly=on,bus=scsi --disk device=disk,vol=localfs-vm/{{ inventory_hostname }}-vda.qcows2,cache=none,bus=scsi --network network=bridge-eth0,model=virtio --graphics vnc --graphics spice --noautoconsole --memballoon virtio
    delegate_to: kvm.domain.tld</pre></div></li><li class="listitem" value="2">You'll<a id="id334" class="calibre1"/> also need to create<a id="id335" class="calibre1"/> the template for the <code class="email">~/templates/isolinux/isolinux.cfg.el7</code> file; you can do this by executing<a id="id336" class="calibre1"/> the following:<div class="informalexample"><pre class="programlisting">default vesamenu.c32
timeout 600
display boot.msg
menu clear
menu background splash.png
menu title Red Hat Enterprise Linux 7.0
menu vshift 8
menu rows 18
menu margin 8
menu helpmsgrow 15
menu tabmsgrow 13
menu color sel 0 #ffffffff #00000000 none
menu color title 0 #ffcc000000 #00000000 none
menu color tabmsg 0 #84cc0000 #00000000 none
menu color hotsel 0 #84cc0000 #00000000 none
menu color hotkey 0 #ffffffff #00000000 none
menu color cmdmark 0 #84b8ffff #00000000 none
menu color cmdline 0 #ffffffff #00000000 none
label linux
  menu label ^Install Red Hat Enterprise Linux 7.0
  kernel vmlinuz
  append initrd=initrd.img ks=http://web.domain.tld/kickstart/{{ inventory_hostname }}.ks text

label local
  menu label Boot from ^local drive
  localboot 0xffff

menu end</pre></div></li><li class="listitem" value="3">Now, use<a id="id337" class="calibre1"/> the following <a id="id338" class="calibre1"/>command <a id="id339" class="calibre1"/>to execute the playbook:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible-playbook --limit newhost ~/playbooks/provisioning.yml</strong></span>

<span class="strong"><strong class="calibre8">PLAY [Provision new machines] ********************************</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Publish kickstart template as new file to webserver] **</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost -&gt; web.domain.tld]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Create new isolinux file to contain reference to the kickstart file] ***</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost -&gt; kvm.domain.tld]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Create new iso boot media] ****************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost -&gt; kvm.domain.tld]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Create disk for the new kvm guest] ********************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost -&gt; kvm.domain.tld]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Create new vm on KVM] *********************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost -&gt; kvm.domain.tld]</strong></span>

<span class="strong"><strong class="calibre8">PLAY RECAP ***************************************************</strong></span>
<span class="strong"><strong class="calibre8">newhost             : ok=5  changed=5  unreachable=0  failed=0</strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Creating a playbook to deploy a new VM with kickstart">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec139" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">The playbook starts off with a name describing the playbook, as does each task. Personally, I think naming your playbooks and tasks is a good idea as it will allow you to troubleshoot any issue at hand more easily.</p><p class="calibre7">The <code class="email">gather_facts: no</code> directive prevents the playbook from actually trying and connecting<a id="id340" class="calibre1"/> to the target host and <a id="id341" class="calibre1"/>gather information. As the host is yet to be built, this is of no <a id="id342" class="calibre1"/>use and will make the playbook fail.</p><p class="calibre7">The first task uses a template (such as the one created in the previous recipe) to generate a new <code class="email">kickstart</code> file. By default, tasks are executed on the host specified in the command line, but by specifying the <code class="email">delegate_to</code> directive, this is executed on the web server with the facts of the selected host.</p><p class="calibre7">The same goes for the two last tasks; these execute a command using the local shell on <code class="email">kvm.domain.tld</code> with the host's facts.</p></div></div>

<div class="book" title="Creating a playbook to deploy a new VM with kickstart">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec140" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">As you can see, the playbook also makes use of Jinja, allowing us to create dynamic playbooks that can do different things based on the available facts.</p><p class="calibre7">The more facts you have available in your inventory, the more dynamic you can go in your playbook. For instance, your source template could be OS-version specific and you can create all the virtual disks at once and specify the correct amount of CPUs and RAM upon system creation.</p></div></div>

<div class="book" title="Creating a playbook to deploy a new VM with kickstart">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch06lvl2sec141" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more<a id="id343" class="calibre1"/> information on playbooks, go to <a class="calibre1" href="http://docs.ansible.com/ansible/playbooks.html">http://docs.ansible.com/ansible/playbooks.html</a>.</p><p class="calibre7">For more information on Ansible templates, go to <a class="calibre1" href="http://docs.ansible.com/ansible/modules_by_category.html">http://docs.ansible.com/ansible/modules_by_category.html</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Creating a playbook to perform system configuration tasks"><div class="book" id="1NA0K2-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec52" class="calibre1"/>Creating a playbook to perform system configuration tasks</h1></div></div></div><p class="calibre7">Changing a <a id="id344" class="calibre1"/>system's configuration<a id="id345" class="calibre1"/> with Ansible isn't much more difficult than provisioning a new system.</p></div>

<div class="book" title="Creating a playbook to perform system configuration tasks">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec142" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">For this recipe, we will need the following facts for the new host:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">ntp_servers</code></li><li class="listitem"><code class="email">dns_servers</code></li><li class="listitem"><code class="email">dns_search</code></li></ul></div><p class="calibre7">We'll also need to have a couple of templates to provision the following files:</p><div class="book"><ul class="itemizedlist"><li class="listitem"><code class="email">/etc/logrotate.d/syslog</code></li><li class="listitem"><code class="email">/etc/ntp.conf</code></li><li class="listitem"><code class="email">/etc/ntp/step-tickers</code></li><li class="listitem"><code class="email">/etc/resolv.conf</code></li></ul></div></div></div>

<div class="book" title="Creating a playbook to perform system configuration tasks">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec143" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Now, we'll create the playbook to configure the system. Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">Create a <code class="email">~/playbooks/config.yml</code> playbook with the following content:<div class="informalexample"><pre class="programlisting">- name: Configure system
  hosts: all

  handlers:
  - include: networking.handlers.yml
  - include: ntp-client.handlers.yml
  
  tasks:
  - include: networking.tasks.yml
  - include: ntp-client.tasks.yml
  - include: logrotate.tasks.yml</pre></div></li><li class="listitem" value="2">Create a <code class="email">~/playbooks/networking.handlers.yml</code> file with the following content:<div class="informalexample"><pre class="programlisting">  - name: reset-sysctl
    action: command /sbin/sysctl -p</pre></div></li><li class="listitem" value="3">Now, create a <code class="email">~/playbooks/ntp-client.handlers.yml</code> file with the following content:<div class="informalexample"><pre class="programlisting">  - name: restart-ntpd
    action: service name=ntpd state=restarted enabled=yes</pre></div></li><li class="listitem" value="4">Create a <code class="email">~/playbooks/networking.tasks.yml</code> file with the following content:<div class="informalexample"><pre class="programlisting">  - name: Set the hostname
    action: hostname name={{ inventory_hostname }}

  - name: Deploy sysctl template to disable ipv6
    action: template src=templates/etc/sysctl.d/ipv6.conf.el7 dest=/etc/sysctl.d/ipv6.conf
    notify: reset-sysctl
    
  - name: 'Detect if ::1 is in /etc/hosts'
    action: shell /bin/egrep '^\s*::1.*$' /etc/hosts
    register: hosts_lo_ipv6
    failed_when: false
    always_run: yes
  
  - name: 'Remove ::1 from /etc/hosts'
    action: lineinfile dest=/etc/hosts regexp='^\s*::1.*$' state=absent
    when: hosts_lo_ipv6.rc == 0

  - name: Configure DNS
    action: template src=templates/etc/resolv.conf.el7 dest=/etc/resolv.conf</pre></div></li><li class="listitem" value="5">Next, create<a id="id346" class="calibre1"/> a <code class="email">~/playbooks/ntp-client.tasks.yml</code> file <a id="id347" class="calibre1"/>with the following content:<div class="informalexample"><pre class="programlisting">  - name: "Install ntpd (if it's not installed already)"
    action: yum name=ntp state=present
    notify: restart-ntpd
    
  - name: Configure the ntp daemon
    action: template src=templates/etc/ntp.conf.el7 dest=/etc/ntp.conf
    notify: restart-ntpd
    
  - name: Configure the step-tickers
    action: template src=templates/etc/ntp/step-tickers.el7 dest=/etc/ntp/step-tickers
    notify: restart-ntpd</pre></div></li><li class="listitem" value="6">Create a <code class="email">~/playbooks/logrotate.tasks.yml</code> file with the following content:<div class="informalexample"><pre class="programlisting">  - name: Configure logrotate for rsyslog
    action: template src=templates/etc/logrotate.d/syslog.el7 dest=/etc/logrotate.d/syslog</pre></div></li></ol><div class="calibre14"/></div><p class="calibre7">This is it for the playbook. Now we need to create the templates:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, create a <code class="email">~/playbooks/templates/etc/sysctl.d/ipv6.conf.el7</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8"># {{ ansible_managed }}</strong></span>
<span class="strong"><strong class="calibre8">net.ipv6.conf.all.disable_ipv6 = 1</strong></span>
<span class="strong"><strong class="calibre8">net.ipv6.conf.default.disable_ipv6 = 1</strong></span>
<span class="strong"><strong class="calibre8">net.ipv6.conf.lo.disable_ipv6 = 1</strong></span>
</pre></div></li><li class="listitem" value="2">Then, create<a id="id348" class="calibre1"/> a <code class="email">~/playbooks/templates/etc/resolv.conf.el7</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8"># {{ ansible_managed }}</strong></span>
<span class="strong"><strong class="calibre8">search {{ dns_search|join(' ') }}</strong></span>
<span class="strong"><strong class="calibre8">{% for dns in dns_servers %}</strong></span>
<span class="strong"><strong class="calibre8">nameserver {{ dns }}</strong></span>
<span class="strong"><strong class="calibre8">{% endfor %}</strong></span>
</pre></div></li><li class="listitem" value="3">Create <a id="id349" class="calibre1"/>a <code class="email">~/playbooks/templates/etc/ntp.conf.el7</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8"># {{ ansible_managed }}</strong></span>

<span class="strong"><strong class="calibre8">driftfile /var/lib/ntp/drift</strong></span>

<span class="strong"><strong class="calibre8">restrict default nomodify notrap nopeer noquery</strong></span>

<span class="strong"><strong class="calibre8">restrict 127.0.0.1</strong></span>
<span class="strong"><strong class="calibre8">restrict ::1</strong></span>

<span class="strong"><strong class="calibre8">{% for ntp in ntp_servers %}</strong></span>
<span class="strong"><strong class="calibre8">server {{ ntp }} iburst</strong></span>
<span class="strong"><strong class="calibre8">{% endfor %}</strong></span>
<span class="strong"><strong class="calibre8">includefile /etc/ntp/crypto/pw</strong></span>

<span class="strong"><strong class="calibre8">keys /etc/ntp/keys</strong></span>

<span class="strong"><strong class="calibre8">disable monitor</strong></span>
</pre></div></li><li class="listitem" value="4">Next, create a <code class="email">~/playbooks/templates/etc/ntp/step-tickers.el7</code> file with the following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8"># {{ ansible_managed }}</strong></span>
<span class="strong"><strong class="calibre8">{% for ntp in ntp_servers %}</strong></span>
<span class="strong"><strong class="calibre8">{{ ntp }}</strong></span>
<span class="strong"><strong class="calibre8">{% endfor %}</strong></span>
</pre></div></li><li class="listitem" value="5">Create a <code class="email">~/playbooks/templates/etc/logrotate.d/syslog.el7</code> file with <a id="id350" class="calibre1"/>the <a id="id351" class="calibre1"/>following content:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8"># {{ ansible_managed }}</strong></span>
<span class="strong"><strong class="calibre8">/var/log/cron</strong></span>
<span class="strong"><strong class="calibre8">/var/log/maillog</strong></span>
<span class="strong"><strong class="calibre8">/var/log/messages</strong></span>
<span class="strong"><strong class="calibre8">/var/log/secure</strong></span>
<span class="strong"><strong class="calibre8">/var/log/spooler</strong></span>
<span class="strong"><strong class="calibre8">{</strong></span>
<span class="strong"><strong class="calibre8">    daily</strong></span>
<span class="strong"><strong class="calibre8">    compress</strong></span>
<span class="strong"><strong class="calibre8">    delaycompress</strong></span>
<span class="strong"><strong class="calibre8">    dateext</strong></span>
<span class="strong"><strong class="calibre8">    ifempty</strong></span>
<span class="strong"><strong class="calibre8">    missingok</strong></span>
<span class="strong"><strong class="calibre8">    nocreate</strong></span>
<span class="strong"><strong class="calibre8">    nomail</strong></span>
<span class="strong"><strong class="calibre8">    rotate 365</strong></span>
<span class="strong"><strong class="calibre8">    sharedscripts</strong></span>
<span class="strong"><strong class="calibre8">    postrotate</strong></span>
<span class="strong"><strong class="calibre8">        /bin/kill -HUP `cat /var/run/syslogd.pid 2&gt; /dev/null` 2&gt; /dev/null || true</strong></span>
<span class="strong"><strong class="calibre8">    endscript</strong></span>
<span class="strong"><strong class="calibre8">}</strong></span>
</pre></div></li><li class="listitem" value="6">Then, deploy the playbook to a newly created host by executing the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible-playbook --limit newhost ~/playbooks/config.yml</strong></span>
<span class="strong"><strong class="calibre8">PLAY [Configure system] **************************************</strong></span>

<span class="strong"><strong class="calibre8">GATHERING FACTS **********************************************</strong></span>
<span class="strong"><strong class="calibre8">ok: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Set the hostname] *************************************</strong></span>
<span class="strong"><strong class="calibre8">skipping: [newhost]</strong></span>
<span class="strong"><strong class="calibre8">ok: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Deploy sysctl template to disable ipv6] ***************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Detect if ::1 is in /etc/hosts] ***********************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Remove ::1 from /etc/hosts] ***************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Configure DNS] ****************************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Install ntpd (if it's not installed already)] *********</strong></span>
<span class="strong"><strong class="calibre8">ok: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Configure the ntp daemon] *****************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Configure the step-tickers] ***************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [Configure logrotate for rsyslog] **********************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">NOTIFIED: [reset-sysctl] *************************************</strong></span>
<span class="strong"><strong class="calibre8">skipping: [newhost]</strong></span>
<span class="strong"><strong class="calibre8">ok: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">NOTIFIED: [restart-ntpd] *************************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [newhost]</strong></span>

<span class="strong"><strong class="calibre8">PLAY RECAP ***************************************************</strong></span>
<span class="strong"><strong class="calibre8">newhost            : ok=9  changed=8  unreachable=0  failed=0  </strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Creating a playbook to perform system configuration tasks">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec144" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">The guys at Ansible are really smart people, and they have Ansible packed with lots of power tools. Two that are worth mentioning here and are lifesavers for debugging your playbooks are <code class="email">--check</code> and <code class="email">--diff</code>.</p><p class="calibre7">The <code class="email">ansible-playbook --check</code> tool allows you to run your playbook on a system without <a id="id352" class="calibre1"/>actually changing anything. Why<a id="id353" class="calibre1"/> is this important, you ask? Well, the output of the playbook will list which actions of the playbook will actually change anything on the target system.</p><p class="calibre7">An important point to remember is that not all modules support this, but Ansible will tell you when it's not supported by a module.</p><p class="calibre7">The <code class="email">shell</code> module is one such module that doesn't support the dry run, and it will not execute unless you specify the <code class="email">always_run: yes</code> directive. Be careful with this directive as if the action would change anything, this directive will cause this change to be applied, even when specifying <code class="email">--check</code>.</p><p class="calibre7">I added the <code class="email">'Detect if ::1 is in /etc/hosts'</code> action to the <code class="email">networking.tasks.yml</code> file with the <code class="email">always_run: yes</code> directive. This specific action just checks whether the line is present. The <code class="email">ergep</code> returns code <code class="email">0</code> if it finds a match and <code class="email">1</code> if it doesn't. It registers the result of the shell action to a variable (<code class="email">hosts_lo_ipv6</code>).</p><p class="calibre7">This variable contains everything about the result of the action; in this case, it contains the values for <code class="email">stdout</code>, <code class="email">stder,r</code>, and also (but not limited to) the result code, which we need for the next task in the playbook (<code class="email">'Remove ::1 from /etc/hosts'</code>) to decide on. This way, we can introduce a manual form of idempotency into the playbook for modules that cannot handle idempotency due to whatever restrictions.</p><p class="calibre7">The <code class="email">ansible-playbook --diff --check</code> tool does the exact same work as discussed here. However, it comes with an added bonus: it shows you what exactly will be changed in the form of a <code class="email">diff -u</code> between what it actually is and what it's supposed to be. Of course, once again, the module has to support it.</p><p class="calibre7">As you can see in the recipe, Ansible allows us to create reusable code by creating separate task and handler yml files. This way, you could create other playbooks referring to these files, without having to reinvent the wheel.</p><p class="calibre7">This becomes particularly practical once you start using roles to deploy your playbooks.</p><p class="calibre7">Roles allow you to group playbooks and have them deployed according to the needs (that is, roles) of your server.</p><p class="calibre7">For instance, a "lamp" role would deploy Linux, Apache, MariaDB, and PHP to a system using the playbooks included in the role. Roles can define dependencies. These dependencies are other roles, and thus, the "lamp" role could be broken down into three more roles that may be more useful as separate roles: Linux, Dbserver, and ApachePHP.</p><p class="calibre7">This is a<a id="id354" class="calibre1"/> breakdown of the directory/file<a id="id355" class="calibre1"/> structure that you'll need to use for certain roles:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">File structure</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">The container for all roles to be used by Ansible.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is<a id="id356" class="indexterm"/> the container for your role.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/files</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This contains the files to be copied using the copy module to the target hosts.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/templates</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This contains the template files to be deployed using the template module.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/tasks</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is where the tasks go to perform all the necessary actions.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/tasks/main.yml</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This playbook is automatically added to the play when this role is applied to a system.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/handlers</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the location of your role handlers.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/handlers/main</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This set of handlers is automatically added to the play.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/vars</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This location holds all the variables for your role.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/vars/main.yml</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This set of variables is automatically applied to the play.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">roles/&lt;role&gt;/defaults</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This is the directory to hold the defaults for any fact you may need. The facts/variables defined in this way have the lowest priority, meaning that your inventory will win in the event that a fact is defined in both.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">role/&lt;role&gt;/defaults/main.yml</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This set of defaults is automatically added to the play.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">role/&lt;role&gt;/meta</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This <a id="id357" class="indexterm"/>directory holds all the role dependencies for this role.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">role/&lt;role&gt;/meta/main.yml</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This set of dependencies is automatically added to the play.</p>
</td></tr></tbody></table></div><p class="calibre7">In order to address the roles created in this way, you just need to create a playbook containing the following:</p><div class="informalexample"><pre class="programlisting">- name: Deploy LAMP servers
  hosts: lamp
  roles:
  - linux
  - DBserver
  - Apache-PHP</pre></div><p class="calibre7">Alternatively, you<a id="id358" class="calibre1"/> could create a role lamp<a id="id359" class="calibre1"/> that has Linux, DBserver, and ApachePHP as the dependencies in the <code class="email">meta</code>/<code class="email">main.yml</code> file by creating it with the following contents:</p><div class="informalexample"><pre class="programlisting">dependencies:
  - { role: linux }
  - { role: DBserver, db_type: mariadb }
  - { role: Apache-PHP }</pre></div></div></div>

<div class="book" title="Creating a playbook to perform system configuration tasks">
<div class="book" title="See also"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec145" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more<a id="id360" class="calibre1"/> information on Ansible Roles and Includes, go to <a class="calibre1" href="http://docs.ansible.com/ansible/playbooks_roles.html">http://docs.ansible.com/ansible/playbooks_roles.html</a>.</p><p class="calibre7">For more information on playbooks, go to <a class="calibre1" href="http://docs.ansible.com/ansible/playbooks.html">http://docs.ansible.com/ansible/playbooks.html</a>.</p><p class="calibre7">For more information on Ansible templates, go to <a class="calibre1" href="http://docs.ansible.com/ansible/modules_by_category.html">http://docs.ansible.com/ansible/modules_by_category.html</a>.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Troubleshooting Ansible"><div class="book" id="1O8H62-501a83dd54944cb1bf060a2ce9fab11f"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch06lvl1sec53" class="calibre1"/>Troubleshooting Ansible</h1></div></div></div><p class="calibre7">I've written it <a id="id361" class="calibre1"/>before, and I'll do it again: the people at Ansible are really smart as they actually packed it with power tools.</p><p class="calibre7">One of my favorite troubleshooting tools is <code class="email">--verbose</code> or <code class="email">-v</code>. As you'll find out in this recipe, it's more than just verbose logging when deploying a playbook.</p></div>

<div class="book" title="Troubleshooting Ansible">
<div class="book" title="Getting ready"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch06lvl2sec146" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Let's see what happens with a <code class="email">~/playbooks/hello_world.yml</code> playbook with the following contents when specifying up to 4 <code class="email">-v</code> tools:</p><div class="informalexample"><pre class="programlisting">- name: Hello World test
  hosts: all
  tasks:
  - action: shell echo "Hello World"</pre></div></div></div>

<div class="book" title="Troubleshooting Ansible">
<div class="book" title="How to do it…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch06lvl2sec147" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Ansible has <a id="id362" class="calibre1"/>various verbosity levels, all adding another layer of information. It's important to understand which layer adds what. Perform the following steps:</p><div class="book"><ol class="orderedlist"><li class="listitem" value="1">First, execute the playbook without <code class="email">–v</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible-playbook --limit &lt;hostname&gt; ~/playbooks/hello_world.yml</strong></span>
<span class="strong"><strong class="calibre8">PLAY [Hello World test] **************************************</strong></span>

<span class="strong"><strong class="calibre8">GATHERING FACTS **********************************************</strong></span>
<span class="strong"><strong class="calibre8">ok: [&lt;hostname&gt;]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [shell echo "Hello World"] *****************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [&lt;hostname&gt;]</strong></span>

<span class="strong"><strong class="calibre8">PLAY RECAP ***************************************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname&gt;        : ok=2  changed=1  unreachable=0    failed=0   </strong></span>
<span class="strong"><strong class="calibre8">~]#</strong></span>
</pre></div></li><li class="listitem" value="2">Execute the playbook with one <code class="email">–v</code>, as follows:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible-playbook --limit &lt;hostname&gt; ~/playbooks/hello_world.yml -v</strong></span>
<span class="strong"><strong class="calibre8">PLAY [Hello World test] **************************************</strong></span>

<span class="strong"><strong class="calibre8">GATHERING FACTS **********************************************</strong></span>
<span class="strong"><strong class="calibre8">ok: [&lt;hostname&gt;]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [shell echo "Hello World"] *****************************</strong></span>
<span class="strong"><strong class="calibre8">changed: [&lt;hostname&gt;] =&gt; {"changed": true, "cmd": "echo \"Hello World\"", "delta": "0:00:00.003436", "end": "2015-08-18 23:35:26.668245", "rc": 0, "start": "2015-08-18 23:35:26.664809", "stderr": "", "stdout": "Hello World", "warnings": []}</strong></span>

<span class="strong"><strong class="calibre8">PLAY RECAP ***************************************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname&gt;        : ok=2  changed=1  unreachable=0    failed=0</strong></span>
</pre></div></li><li class="listitem" value="3">Now, execute the <a id="id363" class="calibre1"/>playbook with two <code class="email">–v</code> tools; run the following:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible-playbook --limit &lt;hostname&gt; ~/playbooks/hello_world.yml -vv</strong></span>
<span class="strong"><strong class="calibre8">PLAY [Hello World test] **************************************</strong></span>

<span class="strong"><strong class="calibre8">GATHERING FACTS **********************************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; REMOTE_MODULE setup</strong></span>
<span class="strong"><strong class="calibre8">ok: [&lt;hostname&gt;]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [shell echo "Hello World"] *****************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; REMOTE_MODULE command echo "Hello World" #USE_SHELL</strong></span>
<span class="strong"><strong class="calibre8">changed: [&lt;hostname&gt;] =&gt; {"changed": true, "cmd": "echo \"Hello World\"", "delta": "0:00:00.004222", "end": "2015-08-18 23:37:56.737995", "rc": 0, "start": "2015-08-18 23:37:56.733773", "stderr": "", "stdout": "Hello World", "warnings": []}</strong></span>

<span class="strong"><strong class="calibre8">PLAY RECAP ***************************************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname&gt;        : ok=2  changed=1  unreachable=0    failed=0</strong></span>
</pre></div></li><li class="listitem" value="4">Next, execute the playbook with three <code class="email">–v</code> tools via this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">~]# ansible-playbook --limit &lt;hostname&gt; ~/playbooks/hello_world.yml -vvv</strong></span>
<span class="strong"><strong class="calibre8">PLAY [Hello World test] **************************************</strong></span>

<span class="strong"><strong class="calibre8">GATHERING FACTS **********************************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; ESTABLISH CONNECTION FOR USER: root</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; REMOTE_MODULE setup</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; EXEC ssh -C -tt -v -o ControlMaster=auto -o ControlPersist=60s -o ControlPath="/root/.ansible/cp/ansible-ssh-%h-%p-%r" -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 hostname_fqdn /bin/sh -c 'mkdir -p $HOME/.ansible/tmp/ansible-tmp-1439933893.82-159545120587420 &amp;&amp; echo $HOME/.ansible/tmp/ansible-tmp-1439933893.82-159545120587420'</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; PUT /tmp/tmpZgg_bx TO /root/.ansible/tmp/ansible-tmp-1439933893.82-159545120587420/setup</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; EXEC ssh -C -tt -v -o ControlMaster=auto -o ControlPersist=60s -o ControlPath="/root/.ansible/cp/ansible-ssh-%h-%p-%r" -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 hostname_fqdn /bin/sh -c 'LANG=en_US.UTF-8 LC_CTYPE=en_US.UTF-8 /usr/bin/python /root/.ansible/tmp/ansible-tmp-1439933893.82-159545120587420/setup; rm -rf /root/.ansible/tmp/ansible-tmp-1439933893.82-159545120587420/ &gt;/dev/null 2&gt;&amp;1'</strong></span>
<span class="strong"><strong class="calibre8">ok: [&lt;hostname&gt;]</strong></span>

<span class="strong"><strong class="calibre8">TASK: [shell echo "Hello World"] *****************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; ESTABLISH CONNECTION FOR USER: root</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; REMOTE_MODULE command echo "Hello World" #USE_SHELL</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; EXEC ssh -C -tt -v -o ControlMaster=auto -o ControlPersist=60s -o ControlPath="/root/.ansible/cp/ansible-ssh-%h-%p-%r" -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 hostname_fqdn /bin/sh -c 'mkdir -p $HOME/.ansible/tmp/ansible-tmp-1439933894.43-112982528558910 &amp;&amp; echo $HOME/.ansible/tmp/ansible-tmp-1439933894.43-112982528558910'</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; PUT /tmp/tmp78xbMg TO /root/.ansible/tmp/ansible-tmp-1439933894.43-112982528558910/command</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname_fqdn&gt; EXEC ssh -C -tt -v -o ControlMaster=auto -o ControlPersist=60s -o ControlPath="/root/.ansible/cp/ansible-ssh-%h-%p-%r" -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o ConnectTimeout=10 hostname_fqdn /bin/sh -c 'LANG=en_US.UTF-8 LC_CTYPE=en_US.UTF-8 /usr/bin/python /root/.ansible/tmp/ansible-tmp-1439933894.43-112982528558910/command; rm -rf /root/.ansible/tmp/ansible-tmp-1439933894.43-112982528558910/ &gt;/dev/null 2&gt;&amp;1'</strong></span>
<span class="strong"><strong class="calibre8">changed: [&lt;hostname&gt;] =&gt; {"changed": true, "cmd": "echo \"Hello World\"", "delta": "0:00:00.002934", "end": "2015-08-18 23:38:14.674213", "rc": 0, "start": "2015-08-18 23:38:14.671279", "stderr": "", "stdout": "Hello World", "warnings": []}</strong></span>

<span class="strong"><strong class="calibre8">PLAY RECAP ***************************************************</strong></span>
<span class="strong"><strong class="calibre8">&lt;hostname&gt;        : ok=2  changed=1  unreachable=0    failed=0</strong></span>
</pre></div></li></ol><div class="calibre14"/></div></div></div>

<div class="book" title="Troubleshooting Ansible">
<div class="book" title="How it works…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch06lvl2sec148" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">This table <a id="id364" class="calibre1"/>depicts what information is shown:</p><div class="informalexample"><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22"># of –v</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Information shown</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">0</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">We obtained information about the play, facts gathered (if not disabled), and tasks executed, along with an overview of which and how many tasks are executed per server.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">1</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Additionally, in this case, each task shows all the values related to the module used.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">2</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This shows some extra usage information additionally. There's not much now, but this will be expanded in the future.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">3</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">Additionally, this shows information about and the result for SSH operations.</p>
</td></tr></tbody></table></div></div></div>

<div class="book" title="Troubleshooting Ansible">
<div class="book" title="There's more…"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch06lvl2sec149" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">When using the three <code class="email">v</code> tools, you get to see what Ansible does to execute a certain task, and the SSH options will already get you started by debugging issues with communication to a certain host. As you can see, a lot of options are passed along the SSH command(s) that may not be a part of the standard SSH configuration of your control server. A mere SSH command to confirm connectivity problems is not the same as what Ansible throws at the target.</p><p class="calibre7">A lot of SSH issues occur due to a faulty profile at the other end, so besides testing your SSH connection, it may be a good idea to make sure that your <code class="email">.bashrc</code> and <code class="email">.bash_profile</code> files are correct.</p><p class="calibre7">Ansible has a module called debug, which allows you to show the values for a certain fact/variable or collection of facts. Take a look at the following code:</p><div class="informalexample"><pre class="programlisting">- action: debug var=hostvars[inventory_hostname]</pre></div><p class="calibre7">This shows you all the facts related to the target host, while the following will only show you the value for the <code class="email">inventory_hostname</code> fact:</p><div class="informalexample"><pre class="programlisting">- action: debug var=inventory_hostname</pre></div><p class="calibre7">If you <a id="id365" class="calibre1"/>want a certain playbook or task to not log anything, use the <code class="email">no_log: True</code> directive.</p><p class="calibre7">On the play level, consider the following:</p><div class="informalexample"><pre class="programlisting">- name: playbook
  hosts: all
  no_log: True</pre></div><p class="calibre7">Then, on the task level, consider the following:</p><div class="informalexample"><pre class="programlisting">- name: Forkbomb the remote host
  action: shell :(){ :|: &amp; };:
  no_log: True</pre></div></div></div></body></html>