<html><head></head><body>
<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08" class="calibre1"/>Chapter 8. Yum and Repositories</h1></div></div></div><p class="calibre7">In this chapter, we'll cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem">Managing yum history</li><li class="listitem">Creating a copy (mirror) of any (RHN) repository</li><li class="listitem">Configuring additional repositories</li><li class="listitem">Setting up yum to automatically update</li><li class="listitem">Configuring <code class="email">logrotate</code> for yum</li><li class="listitem">Recovering from a corrupted RPM database</li></ul></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_1"><a id="ch08lvl1sec60" class="calibre1"/>Introduction</h1></div></div></div><p class="calibre7">Originally, you needed to compile your GNU/Linux system manually from source, which used to be time consuming and could be problematic if you couldn't get your dependencies straight. Red Hat created <strong class="calibre8">Red Hat Package Manager</strong> (<strong class="calibre8">RPM</strong>) in 1998 to address the<a id="id404" class="calibre1"/> concerns of dependencies and reduce the time needed to install a system (among others). Since then, RPM has been improved by the Open Source community. One such improvement is yum.</p><p class="calibre7">
<strong class="calibre8">Yellowdog Updater, Modified</strong> (<strong class="calibre8">yum</strong>) is a package management tool using RPM. It allows RPM to<a id="id405" class="calibre1"/> access remote repositories of RPM files and will automatically download the required RPM files based on the dependency information provided by RPM.</p><p class="calibre7">Without a Red Hat Network subscription, you will not get access to updates.</p><p class="calibre7">Besides Red Hat Network, you can purchase Red Hat Satellite if you want even more control of your Red Hat systems.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec61" class="calibre1"/>Managing yum history</h1></div></div></div><p class="calibre7">An often overlooked feature of yum is the history. It allows you to perform a load of additional features that can save your skin in an enterprise environment.</p><p class="calibre7">It allows <a id="id406" class="calibre1"/>you to turn back the proverbial clock to the last functioning state of an application should there be an issue with a package update, without having to worry about dependencies and so on.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec164" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">In this recipe, I'll show you a couple of the most used yum history features.</p><div><div><div><div><h3 class="title2"><a id="ch08lvl3sec57" class="calibre1"/>Your yum history</h3></div></div></div><p class="calibre7">Use the<a id="id407" class="calibre1"/> following command to show your yum history:</p><div><pre class="programlisting">
<strong class="calibre8">~]# yum history list</strong>
</pre></div><p class="calibre7">The preceding command will list the output, as follows:</p><div><img src="img/00053.jpeg" alt="Your yum history" class="calibre10"/></div><p class="calibre11"> </p></div><div><div><div><div><h3 class="title2"><a id="ch08lvl3sec58" class="calibre1"/>Information about a yum transaction or package</h3></div></div></div><p class="calibre7">Show the<a id="id408" class="calibre1"/> details of a yum transaction by executing the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# yum history info 1</strong>
</pre></div><p class="calibre7">This will show you all about this single transaction:</p><div><img src="img/00054.jpeg" alt="Information about a yum transaction or package" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Show the details of a package installed with yum through the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# yum history info ntp</strong>
</pre></div><p class="calibre7">This will <a id="id409" class="calibre1"/>show information about all the transactions that have modified the <code class="email">ntp</code> package in some way (installed/updated/removed):</p><div><img src="img/00055.jpeg" alt="Information about a yum transaction or package" class="calibre10"/></div><p class="calibre11"> </p></div><div><div><div><div><h3 class="title2"><a id="ch08lvl3sec59" class="calibre1"/>Undoing/redoing certain yum transactions</h3></div></div></div><p class="calibre7">Undo a<a id="id410" class="calibre1"/> specific transaction through the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# yum history undo 7</strong>
</pre></div><p class="calibre7">This command undoes a specific transaction (defined by the ID), as shown in the following screenshot:</p><div><img src="img/00056.jpeg" alt="Undoing/redoing certain yum transactions" class="calibre10"/></div><p class="calibre11"> </p><p class="calibre7">Now, you<a id="id411" class="calibre1"/> can redo a specific transaction using the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# yum history redo 7</strong>
</pre></div><p class="calibre7">This command will reperform a specific transaction (as defined by the transaction ID), as follows:</p><div><img src="img/00057.jpeg" alt="Undoing/redoing certain yum transactions" class="calibre10"/></div><p class="calibre11"> </p></div><div><div><div><div><h3 class="title2"><a id="ch08lvl3sec60" class="calibre1"/>Roll back to a certain point in your transaction history</h3></div></div></div><p class="calibre7">This allows <a id="id412" class="calibre1"/>you to undo all transactions up until the transaction ID that you specify. Run the following command:</p><div><pre class="programlisting">
<strong class="calibre8">~]# yum history rollback 6</strong>
</pre></div><p class="calibre7">Here, the transaction ID up to which you roll back is <code class="email">6</code>. You will get the following output:</p><div><img src="img/00058.jpeg" alt="Roll back to a certain point in your transaction history" class="calibre10"/></div><p class="calibre11"> </p></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec165" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">You have to be careful when you use history options such as undo and rollback. Yum does its best to comply, but it cannot restore configurations, and it will not restore previous versions of your configuration files if you have edited them. This is not a fail-safe option if you don't have any backups. Although both options are very useful, I recommend that<a id="id413" class="calibre1"/> you do not use them too often. When you do use them, try to keep the impact of the transactions as small as possible. The smaller the delta, the more chance of succeeding in undoing or rolling back!</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec166" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Refer to the <em class="calibre9">yum(8)</em> man pages for more information about yum history options.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec62" class="calibre1"/>Creating a copy of an RHN repository</h1></div></div></div><p class="calibre7">In this recipe, I'll show you how you can set up a yum repository for Red Hat Network-based and "plain" yum repositories.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec167" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Before you<a id="id414" class="calibre1"/> create a copy of an RHN repository, you need to ensure that you have a valid subscription to the repository that you want to duplicate. When this prerequisite is met, you can perform this recipe from the machine that uses the subscription.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec168" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Before being able to create yum repositories, we need to install a couple of tools by performing the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the <code class="email">createrepo</code> and <code class="email">yum-utils</code> packages using the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y yum-utils createrepo</strong>
</pre></div></li><li class="listitem" value="2">Now, install the Apache web server, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y httpd</strong>
</pre></div></li></ol><div></div><div><div><div><div><h3 class="title2"><a id="ch08lvl3sec61" class="calibre1"/>Syncing RHN repositories</h3></div></div></div><p class="calibre7">You can only <a id="id415" class="calibre1"/>sync RHN subscriptions that you have access to. Perform the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Create a directory to hold the RHN <code class="email">rhel7</code> repository, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# mkdir /var/www/html/repo/rhel/rhel-x86_64-server-7/packages</strong>
</pre></div></li><li class="listitem" value="2">Now, create <code class="email">/mnt/iso</code> by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# mkdir -p /mnt/iso</strong>
</pre></div></li><li class="listitem" value="3">Mount the RHEL 7 Server DVD through the following:<div><pre class="programlisting">
<strong class="calibre8">~]# mount -o loop,ro /tmp/rhel-server-7.0-x86_64-dvd.iso /mnt/iso</strong>
</pre></div></li><li class="listitem" value="4">Now, copy the <code class="email">*-comps-Server.x86_64.xml</code> file from the RHEL Server DVD to your <code class="email">repo</code> directory. The following command will help in this:<div><pre class="programlisting">
<strong class="calibre8">~]# cp /mnt/iso/repodata/*-comps-Server.x86_64.xml /var/www/html/repo/rhel/comps-Server.x86_64.xml</strong>
</pre></div></li><li class="listitem" value="5">Unmount the RHEL Server DVD, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# umount /mnt/iso</strong>
</pre></div></li><li class="listitem" value="6">Synchronize the RHEL 7 OS repository by running the following command: (This may take a while… I suggest you kill time drinking a cup of freshly ground Arabica coffee!)<div><pre class="programlisting">
<strong class="calibre8">~]# reposync --repoid=rhel-7-server-rpms --norepopath –download_path=/var/www/html/repo/rhel/rhel-x86_64-server-7/packages</strong>
</pre></div></li><li class="listitem" value="7">Next, create<a id="id416" class="calibre1"/> the local repository (depending on your hardware, this may take a long time), as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# cd /var/www/html/repo/rhel/rhel-x86_64-server-7/</strong>
<strong class="calibre8">~]# createrepo --groupfile=/var/www/html/repo/rhel/comps-Server.x86_64.xml .</strong>
</pre></div></li><li class="listitem" value="8">Finally, test your repository through the following:<div><pre class="programlisting">
<strong class="calibre8">~]# curl http://localhost/repo/rhel/rhel-x86_64-server-7/repodata/repomd.xml</strong>
</pre></div></li></ol><div></div><p class="calibre7">Let's create a copy of the EPEL repository through the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">First, install the EPEL repository, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y epel-release</strong>
</pre></div></li><li class="listitem" value="2">Create a directory to hold the EPEL repository by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# mkdir -p /var/www/html/repo/epel/7/x86_64</strong>
</pre></div></li><li class="listitem" value="3">Now, download the <code class="email">*-comps-epel7.xml</code> file to <code class="email">/repo</code> as <code class="email">comps-epel7.xml</code>, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# curl -o /var/www/html/repo/epel/comps-epel7.xml http://mirror.kinamo.be/epel/7/x86_64/repodata/xxxxxxxxxxxxxxxxxxxx-comps-epel7.xml</strong>
</pre></div></li></ol><div></div><p class="calibre7">You will need to replace the multiple <code class="email">x</code>'s with the correct MD5 hash, as found in the <code class="email">repodata</code> folder.</p><div><ol class="orderedlist"><li class="listitem" value="1">Next, synchronize the EPEL repository by executing the following (this may take a very long time, depending on your hardware and internet speed):<div><pre class="programlisting">
<strong class="calibre8">~]# reposync --repoid=epel --norepopath –download_path=/var/www/html/repo/epel/7/x86_64</strong>
</pre></div></li><li class="listitem" value="2">Create the local repository (again, depending on your hardware, this may take a long time), as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# cd /var/www/html/repo/epel/7/x86_64</strong>
<strong class="calibre8">~]# createrepo --groupfile=/var/www/html/repo/epel/comps-epel7.xml .</strong>
</pre></div></li><li class="listitem" value="3">Finally, test your repository by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# curl http://localhost/repo/epel/7/x86_64/repodata/repomd.xml</strong>
</pre></div></li></ol><div></div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec169" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">When <a id="id417" class="calibre1"/>synchronizing RHEL 7 repositories, you will only be able to sync those you have entitlement to. To find out what entitlements you have on a given system connected to RHN, execute the following:</p><div><pre class="programlisting">
<strong class="calibre8">~]# cd /etc/yum/pluginconf.d/ &amp;&amp; echo *.conf | sed "s/rhnplugin.conf//"|sed 's/\([0-9a-zA-Z\-]*\).conf/--disableplugin=\1/g'|xargs yum repolist &amp;&amp; cd - &gt;/dev/null</strong>
</pre></div><p class="calibre7">Whenever you synchronize a repository, try to keep the same directory structure as the original. I have found that it makes life easier when you want to rewrite your <code class="email">/etc/yum.repos.d</code> files.</p><p class="calibre7">In an enterprise, it is useful to have a point in time when you "freeze" your yum repositories to ensure that all your systems are at the same RPM level. By default, any repository is "live" and gets updated whenever a new package is added. The advantage of this is that you always have the latest version of all packages available; the downside is that your environment is not uniform and you can end up troubleshooting for different versions of the same package.</p><p class="calibre7">The easiest way to achieve a "frozen" repository is to create a central location that holds all the RPMs as you would a normal yum mirror or copy.</p><p class="calibre7">Every <code class="email">x</code> time, which you predefine, create a new directory with a timestamp, in which you hard link all the RPMs you mirror. Then finally, create a hard link to the directory, which you will later use in your repo configuration.</p><p class="calibre7">Here's an example:</p><div><table border="1" class="calibre16"><colgroup class="calibre17"><col class="calibre18"/><col class="calibre18"/></colgroup><thead class="calibre19"><tr class="calibre20"><th valign="bottom" class="calibre21">
<p class="calibre22">Directories</p>
</th><th valign="bottom" class="calibre21">
<p class="calibre22">Description</p>
</th></tr></thead><tbody class="calibre23"><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">/rhel7/x86_64.all</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This directory contains a mirror which is synced nightly. RPMs are added, never deleted.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">/rhel7/x86_64.20150701</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This directory contains hard links to the RPMs in <code class="literal">/rhel7/x86_64</code>, all of which were synced on 01/07/2015, along with monthly iterations of the <code class="literal">/rhel6/x86_64.20150701</code> directory.</p>
</td></tr><tr class="calibre20"><td valign="top" class="calibre24">
<p class="calibre22">
<code class="literal">/rhel7/x86_64</code>
</p>
</td><td valign="top" class="calibre24">
<p class="calibre22">This directory contains a hard link to the monthly iteration, which is deemed in production.</p>
</td></tr></tbody></table></div><p class="calibre7">Of course, you<a id="id418" class="calibre1"/> need to ensure that you create a repository for each new sync!</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch08lvl2sec170" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Refer to the <em class="calibre9">createrepo(8)</em> man pages for more information about creating a repository.</p><p class="calibre7">Also, refer to the <em class="calibre9">reposync(1)</em> man pages for more information on keeping your repository up-to-date.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec63" class="calibre1"/>Configuring additional repositories</h1></div></div></div><p class="calibre7">Whether you create your own mirror repository or organizations provide software for you in repositories, setting up additional repositories on your RHEL system is quite simple. This recipe will <a id="id419" class="calibre1"/>show you how to set them up. Many repositories have their own repo files or even an RPM that automatically installs the repository. When these are available, don't hesitate to use them!</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec171" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">For this to work, you will need to have a repository set up, which can be accessed through the following URL: <code class="email">http://repo.example.com/myrepo/7/x86_64</code>.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec172" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">In order to create an additional repository, create a file in <code class="email">/etc/yum.repos.d</code> called <code class="email">myrepo.repo</code>, which contains the following information:</p><div><pre class="programlisting">[myrepo]
name=My Personal Repository
baseurl=http://repo.example.com/myrepo/$releasever/$basearch
gpgcheck=0
enabled=1</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec173" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">The <code class="email">gpgcheck=1</code> option only functions if you or the provider of a repo has signed all the RPMs in the repo. This is generally a good practice and provides extra security to your repositories.</p><p class="calibre7">The <code class="email">$releasever</code> and <code class="email">$basearch</code> variables allow you to create a single repository file that can work on multiple systems as long as you have a repository for the URLs. The <code class="email">$releasever</code> variable expands to the major version of the OS (7 in our case), and the <code class="email">$basearch</code> will <a id="id420" class="calibre1"/>expands to x86_64. On an i386 system (RHEL 7 only comes in the x86_64 architecture), <code class="email">$basearch</code> expands to i386.</p><p class="calibre7">You can find many repositories on the Internet, such as <code class="email">epel</code> and <code class="email">elrepo</code>, but it may not always be a good idea to use them. Any software provided by the Red Hat standard repositories are also supported by Red Hat, and they will no longer support you if you start using the same software provided through another repository. So, you better ensure that you don't care about support or have another party that is willing to support you.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch08lvl2sec174" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Although I do not condone the use of these in production without taking the appropriate support actions, here is<a id="id421" class="calibre1"/> a list of some popular repositories that you can use:</p><p class="calibre7">The ELRepo repository can be found at:</p><p class="calibre7">
<a class="calibre1" href="http://elrepo.org/tiki/tiki-index.php">http://elrepo.org/tiki/tiki-index.php</a></p><p class="calibre7">The EPEL repository is at:</p><p class="calibre7"><a class="calibre1" href="https://fedoraproject.org/wiki/EPEL">https://fedoraproject.org/wiki/EPEL</a></p><p class="calibre7">The Puppetlabs repositories can be found at:</p><p class="calibre7">
<a class="calibre1" href="https://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html">https://docs.puppetlabs.com/guides/puppetlabs_package_repositories.html</a></p><p class="calibre7">The Zabbix repositories are at the following link:</p><p class="calibre7">
<a class="calibre1" href="https://www.zabbix.com/documentation/2.0/manual/installation/install_from_packages">https://www.zabbix.com/documentation/2.0/manual/installation/install_from_packages</a></p><p class="calibre7">For the RepoForge repositories, refer to the following website:</p><p class="calibre7">
<a class="calibre1" href="http://repoforge.org/use/">http://repoforge.org/use/</a>
</p><p class="calibre7">Remi's repositories can be found at:</p><p class="calibre7">
<a class="calibre1" href="http://rpms.famillecollet.com/">http://rpms.famillecollet.com/</a>
</p><p class="calibre7">The Webtatic repositories are at:</p><p class="calibre7">
<a class="calibre1" href="https://webtatic.com/projects/yum-repository/">https://webtatic.com/projects/yum-repository/</a>
</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec64" class="calibre1"/>Setting up yum to automatically update</h1></div></div></div><p class="calibre7">In enterprises, automating the systematic updating of your RHEL systems is very important. You want to stay ahead of hackers or, in general, people trying to hurt you by exploiting the <a id="id422" class="calibre1"/>weaknesses in your environment.</p><p class="calibre7">Although I do not recommend applying this recipe to all systems in an enterprise, this is quite useful to ensure that certain systems are kept up to date as the patches and bugfixes are applied to the RPMs in Red Hat's (and other) repositories.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec175" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">In order for this recipe to work, you'll need to be sure that the repositories you are using are set up correctly and you have valid mail setup (using Postfix or Sendmail, for example).</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec176" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">We'll set up yum to autoupdate your system once a week (at 03:00 ) and reboot if necessary through the following steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Install the yum cron plugin, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# yum install -y yum-cron</strong>
</pre></div></li><li class="listitem" value="2">Then, disable the hourly and daily yum cron jobs through the following commands:<div><pre class="programlisting">
<strong class="calibre8">~]# echo &gt; /etc/cron.dhourly/0yum-hourly.cron</strong>
<strong class="calibre8">~]# echo &gt; /etc/cron.daily/0yum-daily.cron</strong>
</pre></div></li><li class="listitem" value="3">Create the configuration file for the weekly yum update cron job via the following:<div><pre class="programlisting">
<strong class="calibre8">~]# cp /etc/yum/yum-cron.conf /etc/yum/yum-cron-weekly.conf</strong>
</pre></div></li><li class="listitem" value="4">Modify the created configuration file to apply updates and send a notification through e-mail by setting the following values:<div><pre class="programlisting">
<strong class="calibre8">apply_updates = yes</strong>
<strong class="calibre8">emit_via = email</strong>
<strong class="calibre8">email_to = &lt;your email address&gt;</strong>
</pre></div></li><li class="listitem" value="5">Next, create a weekly cron job by adding the following contents to <code class="email">/etc/cron.weekly/yum-weekly.cron</code>:<div><pre class="programlisting">
<strong class="calibre8">#!/bin/bash                                                     </strong>

<strong class="calibre8"># Only run if this flag is set. The flag is created by the yum-cron init</strong>
<strong class="calibre8"># script when the service is started -- this allows one to use chkconfig and</strong>
<strong class="calibre8"># the standard "service stop|start" commands to enable or disable yum-cron.</strong>
<strong class="calibre8">if [[ ! -f /var/lock/subsys/yum-cron ]]; then</strong>
<strong class="calibre8">  exit 0</strong>
<strong class="calibre8">fi</strong>

<strong class="calibre8"># Action!</strong>
<strong class="calibre8">exec /usr/sbin/yum-cron /etc/yum/yum-cron-weekly.conf</strong>
<strong class="calibre8">if test "$(yum history info |egrep '\skernel'|wc -l)" != "0"; then</strong>
<strong class="calibre8">    </strong>
<strong class="calibre8">/sbin/shutdown --reboot +5 "Kernel has been upgraded, rebooting the server in 5 minutes. Please save your work."</strong>
<strong class="calibre8">fi</strong>
</pre></div></li><li class="listitem" value="6">Finally, make the cron job executable by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# chmod +x /etc/cron.weekly/yum-weekly.cron</strong>
</pre></div></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec177" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">By default, <code class="email">yum-cron</code> sets <a id="id423" class="calibre1"/>up a cron job that is run every hour (<code class="email">/etc/cron.dhourly/0yum-hourly.cron</code>) and every day (<code class="email">/etc/cron.daily/0yum-daily.cron</code>).</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_4"><a id="ch08lvl2sec178" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">This recipe will upgrade all your packages when there's an update available. If you just want to apply security fixes, modify the <code class="email">update_cmd</code> value of your yum cron configuration file in the following way:</p><div><pre class="programlisting">update_cmd = security</pre></div><p class="calibre7">Alternatively, you can even use the following configuration if you only want critical fixes:</p><div><pre class="programlisting">update_cmd = security-severity:Critical</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_5"><a id="ch08lvl2sec179" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">Check the <em class="calibre9">yum cron(8)</em> man page or the default <code class="email">yum-cron.conf</code> file located at <code class="email">/etc/yum/yum-cron.conf</code> for more information.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec65" class="calibre1"/>Configuring logrotate for yum</h1></div></div></div><p class="calibre7">Every time you use yum to install and/or update packages, it logs to <code class="email">/var/log/yum.log</code>. A lot of people <a id="id424" class="calibre1"/>don't want to rotate the file a lot as they believe (incorrectly) that it is their only source to the history of their yum tasks. They may even <a id="id425" class="calibre1"/>believe that it provides a way to restore your rpm database if it gets corrupted - it does not.</p><p class="calibre7">I do recommend keeping your complete yum history as it doesn't grow a lot, unless you reinstall packages a lot.</p><p class="calibre7">For a rich interface to your yum history, I suggest you use yum history.</p><p class="calibre7">By default, your yum log file is rotated yearly, and even then, it only rotates if the size of your log file exceeds 30 KB, and your logs are only kept for 4 years. Usually, this is enough in the physical world as physical servers tend to be replaced every 3-4 years. However, virtual servers have the potential to stay "alive" beyond these 3-4 years.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec180" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">Modify <code class="email">/etc/logrotate.d/yum</code> to the following:</p><div><pre class="programlisting">/var/log/yum.log {
    missingok
    notifempty
    size 30k
    rotate 1000
    yearly
    create 0600 root root
}</pre></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec181" class="calibre1"/>How it works…</h2></div></div></div><p class="calibre7">This configuration will only rotate the yum log when it exceeds 30 KB in size on a yearly basis, and it will keep 1000 rotated logs, which is basically log files for 1000 years!</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec182" class="calibre1"/>See also</h2></div></div></div><p class="calibre7">For more information on how to use and configure logrotate, refer to the <em class="calibre9">logrotate(8)</em> man page.</p></div></div>

<div><div><div><div><div><h1 class="title" id="calibre_pb_0"><a id="ch08lvl1sec66" class="calibre1"/>Recovering from a corrupted RPM database</h1></div></div></div><p class="calibre7">Although everything is done to ensure that your RPM databases are intact, your RPM database may become corrupt and unuseable. This happens mainly if the filesystem on which the <code class="email">rpm db</code> resides is suddenly inaccessible (full, read-only, reboot, or so on).</p><p class="calibre7">This recipe <a id="id426" class="calibre1"/>will show you the two ways in which you can attempt to restore your RPM database.</p></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_1"><a id="ch08lvl2sec183" class="calibre1"/>Getting ready</h2></div></div></div><p class="calibre7">Verify that your system is backed up in some way.</p></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_2"><a id="ch08lvl2sec184" class="calibre1"/>How to do it…</h2></div></div></div><p class="calibre7">We'll start with the easiest option and the one with the highest success rate in these steps:</p><div><ol class="orderedlist"><li class="listitem" value="1">Start by creating a backup of your corrupt <code class="email">rpm db</code>, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# cd; tar zcvf rpm-db.tar.gz /var/lib/rpm/*</strong>
</pre></div></li><li class="listitem" value="2">Remove stale lock files if they exist through the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# rm -f /var/lib/rpm/__db*</strong>
</pre></div></li><li class="listitem" value="3">Now, verify the integrity of the <code class="email">Packages</code> database via the following:<div><pre class="programlisting">
<strong class="calibre8">~]# /usr/lib/rpm/rpmdb_verify /var/lib/rpm/Packages; echo $?</strong>
</pre></div><p class="calibre13">If the previous step prints <code class="email">0</code>, proceed to Step 7.</p></li><li class="listitem" value="4">Rename the <code class="email">Packages</code> file (don't delete it, we'll need it!), as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# mv /var/lib/rpm/Packages  /var/lib/rpm/Packages.org</strong>
</pre></div></li><li class="listitem" value="5">Now, dump the <code class="email">Packages db</code> from the original <code class="email">Packages db</code> by executing the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# cd /usr/lib/rpm/rpmdb_dump Packages.org | /usr/lib/rpm/rpmdb_load Packages</strong>
</pre></div></li><li class="listitem" value="6">Verify the integrity of the newly created <code class="email">Packages</code> database. Run the following:<div><pre class="programlisting">
<strong class="calibre8">~]# /usr/lib/rpm/rpmdb_verify /var/lib/rpm/Packages; echo $?</strong>
</pre></div><p class="calibre13">If the exit code is not <code class="email">0</code>, you will need to restore the database from backup.</p></li><li class="listitem" value="7">Rebuild the <code class="email">rpm</code> indexes, as follows:<div><pre class="programlisting">
<strong class="calibre8">~]# rpm -vv --rebuilddb</strong>
</pre></div></li><li class="listitem" value="8">Next, use the following command to check the <code class="email">rpm db</code> with yum for any other issues (this may take a long time):<div><pre class="programlisting">
<strong class="calibre8">~]# yum check</strong>
</pre></div></li><li class="listitem" value="9">Restore the <a id="id427" class="calibre1"/>SELinux context of the <code class="email">rpm</code> database through the following command:<div><pre class="programlisting">
<strong class="calibre8">~]# restorecon -R -v /var/lib/rpm</strong>
</pre></div><div><img src="img/00059.jpeg" alt="How to do it…" class="calibre10"/></div><p class="calibre15"> </p></li></ol><div></div></div></div>

<div><div><div><div><div><h2 class="title1" id="calibre_pb_3"><a id="ch08lvl2sec185" class="calibre1"/>There's more…</h2></div></div></div><p class="calibre7">If, for some reason, you are unable to recover your RPM database, there is one final option left. Enterprises tend to have standardized builds, and many servers are installed with the same packages, so copy the healthy <code class="email">/var/lib/rpm</code> directory from another server with the exact same package set to the corrupted one, and perform the preceding recipe's steps to ensure that everything is okay.</p><p class="calibre7">Although you'll find additional tools that can save your skin (such as RPM cron), it's usually <a id="id428" class="calibre1"/>more practical to have a decent backup.</p></div></div></body></html>