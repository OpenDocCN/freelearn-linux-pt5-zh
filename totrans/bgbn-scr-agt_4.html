<html><head></head><body>
<div id="page" style="height:0pt"/><div class="book" title="Chapter&#xA0;4.&#xA0;Protecting GPG Keys with a Trusted Platform Module"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04" class="calibre1"/>Chapter 4. Protecting GPG Keys with a Trusted Platform Module</h1></div></div></div><p class="calibre7">After our investigation into BBB hardware security, we'll now use that technology to protect your personal encryption keys for the popular GPG software. GPG is a free implementation of the OpenPGP standard. This standard was developed based on the work of Philip Zimmerman and his <span class="strong"><strong class="calibre8">Pretty Good Privacy</strong></span> (<span class="strong"><strong class="calibre8">PGP</strong></span>) software. PGP has a complex socio-political backstory, which we'll briefly cover before getting into the project. For the project, we'll treat the BBB as a separate cryptographic co-processor and use the CryptoCape, with a keypad code entry device, to protect our GPG keys when they are not in use.</p><p class="calibre7">Specifically, we will do the following:</p><div class="book"><ul class="itemizedlist"><li class="listitem">Tell you a little about the history and importance of the PGP software</li><li class="listitem">Perform basic threat modeling to analyze your project</li><li class="listitem">Create a strong PGP key using the free GPG software</li><li class="listitem">Teach you to use the TPM to protect encryption keys</li></ul></div></div>

<div class="book" title="Chapter&#xA0;4.&#xA0;Protecting GPG Keys with a Trusted Platform Module">
<div class="book" title="History of PGP"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_1"><a id="ch04lvl1sec40" class="calibre1"/>History of PGP</h1></div></div></div><p class="calibre7">The software used<a id="id331" class="calibre1"/> in this chapter <a id="id332" class="calibre1"/>would have once been considered a munition by the U.S. Government. Exporting it without a license from the government, would have violated the <a id="id333" class="calibre1"/>
<span class="strong"><strong class="calibre8">International Traffic in Arms Regulations</strong></span> (<span class="strong"><strong class="calibre8">ITAR</strong></span>). As late as the early 1990s, cryptography was heavily controlled and restricted. While the early 90s are filled with numerous accounts by crypto-activists, all of which are well documented in Steven Levy's <span class="strong"><em class="calibre9">Crypto</em></span>, there is one man in particular who was the driving force behind the software in this project: Philip Zimmerman.</p><p class="calibre7">Philip Zimmerman had a small pet project around the year 1990, which he called <span class="strong"><strong class="calibre8">Pretty Good Privacy</strong></span>. Motivated by a strong childhood passion for codes and ciphers, combined with a sense of political activism against a government capable of strong electronic surveillance, he set out to create a strong encryption program for the people (Levy 2001).</p><p class="calibre7">One incident in particular helped to motivate Zimmerman to finish PGP and publish his work. This was the language that the then U.S. Senator Joseph Biden added to Senate Bill #266, which would mandate that:</p><div class="blockquote"><blockquote class="blockquote1"><p class="calibre22"><span class="strong"><em class="calibre9">"Providers of electronic communication services and manufacturers of electronic communications service equipment shall ensure that communication systems permit the government to obtain the plaintext contents of voice, data, and other communications when appropriately authorized by law."</em></span></p></blockquote></div><p class="calibre7">In 1991, in a rush to<a id="id334" class="calibre1"/> release PGP 1.0 before it was illegal, Zimmerman released his software as a freeware to the Internet. Subsequently, after PGP spread, the U.S. Government opened a criminal investigation on Zimmerman for the violation of the U.S. export laws. Zimmerman, in what is best described as a <span class="strong"><em class="calibre9">legal hack</em></span>, published the entire source code of PGP, including instructions on how to scan it back into digital form, as a book. As Zimmerman describes:</p><div class="blockquote"><table border="0" cellspacing="0" cellpadding="0" class="calibre13" summary="Block quote"><tr class="calibre23"><td valign="top" class="calibre21"> </td><td valign="top" class="calibre21"><p class="calibre19"><span><em class="calibre24">"It would be politically difficult for the Government to prohibit the export of a book that anyone may find in a public library or a bookstore."</em></span></p></td><td valign="top" class="calibre21"> </td></tr><tr class="calibre23"><td valign="top" class="calibre21"> </td><td colspan="2" valign="top" class="calibre25">--<span><span><em class="calibre24">(Zimmerman, 1995)</em></span></span></td></tr></table></div><p class="calibre7">A book published in the public domain would no longer fall under ITAR export controls. The genie was out of the bottle; the government dropped its case against Zimmerman in 1996.</p></div></div>

<div class="book" title="Chapter&#xA0;4.&#xA0;Protecting GPG Keys with a Trusted Platform Module">
<div class="book" title="History of PGP">
<div class="book" title="Reflecting on the Crypto Wars"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec46" class="calibre1"/>Reflecting on the Crypto Wars</h2></div></div></div><p class="calibre7">Zimmerman's battle is considered <a id="id335" class="calibre1"/>a resilient victory. Many other outspoken supporters of strong cryptography, known as<a id="id336" class="calibre1"/> <span class="strong"><strong class="calibre8">cypherpunks</strong></span>, also won battles popularizing and spreading encryption technology. But if the Crypto Wars were won in the early nineties, why hasn't cryptography become ubiquitous? Well, to a degree, it has. When you make purchases online, it should be protected by strong cryptography. Almost nobody would insist that their bank or online store <span class="strong"><em class="calibre9">not</em></span> use cryptography and most probably feel more secure that they do. But what about personal privacy protecting software? For these tools, habits must change as the normal e-mail, chat, and web browsing tools are insecure by default. This change causes tension and resistance towards adoption.</p><p class="calibre7">Also, security tools are notoriously hard to use. In the seminal paper on security usability, researchers conclude that the then PGP version 5.0, complete with a<a id="id337" class="calibre1"/> <span class="strong"><strong class="calibre8">Graphical User Interface</strong></span> (<span class="strong"><strong class="calibre8">GUI</strong></span>), was not able to prevent users, who were inexperienced with cryptography but all of whom had at least some college education, from making catastrophic security errors (Whitten 1999). Glenn Greenwald delayed his initial contact with Edward Snowden for roughly two months because he thought GPG was <span class="strong"><em class="calibre9">too complicated</em></span> to use (Greenwald, 2014). Snowden absolutely refused to share anything with Greenwald until he installed GPG.</p><p class="calibre7">GPG<a id="id338" class="calibre1"/> and PGP<a id="id339" class="calibre1"/> enable an individual to protect their own communications. Implicitly, you must also trust the receiving party not to forward your plaintext communication. GPG expects you to protect your private key and does not rely on a third party. While this adds some complexity and maintenance processes, trusting a third party with your private key can be disastrous. In August of 2013, Ladar Levison decided to shut down his own company, Lavabit, an e-mail provider, rather than turn over his users' data to the authorities. Levison courageously pulled the plug on his company rather then turn over the data.</p><p class="calibre7">The Lavabit service<a id="id340" class="calibre1"/> generated and stored your private key. While this key was encrypted to the user's password, it still enabled the server to have access to the raw key. Even though the Lavabit service alleviated users from managing their private key themselves, it enabled the awkward position for Levison. To use GPG properly, you should never turn over your private key. For a complete analysis of <a id="id341" class="calibre1"/>Lavabit, see Moxie Marlinspike's blog post at <a class="calibre1" href="http://www.thoughtcrime.org/blog/lavabit-critique/">http://www.thoughtcrime.org/blog/lavabit-critique/</a>.</p><p class="calibre7">Given the breadth and <a id="id342" class="calibre1"/>depth of state surveillance capabilities, there is a re-kindled interest in protecting one's privacy. Researchers are now designing secure protocols, with these threats in mind (Borisov, 2014). Philip Zimmerman ended the chapter on <span class="strong"><em class="calibre9">Why Do You Need PGP?</em></span> in the <span class="strong"><em class="calibre9">Official PGP User's Guide</em></span> with the following statement, which is as true today as it was when first inked:</p><div class="blockquote"><blockquote class="blockquote1"><p class="calibre22"><span class="strong"><em class="calibre9">"PGP empowers people to take their privacy into their own hands. There's a growing social need for it."</em></span></p></blockquote></div></div></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Developing a threat model"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec41" class="calibre1"/>Developing a threat model</h1></div></div></div><p class="calibre7">At the end of the previous chapter, we introduced the concept of a threat model. A <span class="strong"><strong class="calibre8">threat model</strong></span> <a id="id343" class="calibre1"/>is an analysis of the security of the system that identifies assets, threats, vulnerabilities, and risks. Like any model, the depth of the analysis can vary. In the upcoming section, we'll present a cursory analysis so that you can start thinking about this process. This analysis will also help us understand the capabilities and limitations of our project.</p></div>

<div class="book" title="Developing a threat model">
<div class="book" title="Outlining the key protection system"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec47" class="calibre1"/>Outlining the key protection system</h2></div></div></div><p class="calibre7">The first step of our analysis is to <a id="id344" class="calibre1"/>clearly provide a description of the <a id="id345" class="calibre1"/>system we are trying to protect. In this project, we'll build a logical GPG co-processor using the BBB and the CryptoCape. We'll store the GPG keys on the BBB and then connect to the BBB over <span class="strong"><strong class="calibre8">Secure Shell</strong></span> (<span class="strong"><strong class="calibre8">SSH</strong></span>)<a id="id346" class="calibre1"/> to use the keys and to run GPG. The CryptoCape will be used to encrypt your GPG key when not in use, known as<a id="id347" class="calibre1"/> <span class="strong"><strong class="calibre8">at rest</strong></span>. We'll add a keypad to collect a numeric code, which will be provided to the TPM. This will allow the TPM to unwrap your GPG key.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note27" class="calibre1"/>Note</h3><p class="calibre7">The idea for this project was inspired by Peter Gutmann's work on open source cryptographic co-processors (Gutmann, 2000). The BBB, when acting as a co-processor to a host, is extremely flexible, and considering the power usage, relatively high in performance. By running sensitive code that will have access to cleartext encryption keys on a separate hardware, we gain an extra layer of protection (or at the minimum, a layer of indirection).</p></div></div></div>

<div class="book" title="Developing a threat model">
<div class="book" title="Identifying the assets we need to protect"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec48" class="calibre1"/>Identifying the assets we need to protect</h2></div></div></div><p class="calibre7">Before we can protect anything, we <a id="id348" class="calibre1"/>must know what to protect. The most important assets are the GPG private keys. With these keys, an attacker can decrypt past encrypted messages, recover future messages, and use the keys to impersonate you. By protecting your private key, we are also protecting your reputation, which is another asset. Our decrypted messages are also an asset. An attacker may not care about your key if he/she can easily access your decrypted messages. The BBB itself is an asset that needs protecting. If the BBB is rendered inoperable, then an attacker has successfully prevented you from accessing your private keys, which is known as a <a id="id349" class="calibre1"/>
<span class="strong"><strong class="calibre8">Denial-Of-Service</strong></span> (<span class="strong"><strong class="calibre8">DOS</strong></span>).</p></div></div>

<div class="book" title="Developing a threat model">
<div class="book" title="Threat identification"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec49" class="calibre1"/>Threat identification</h2></div></div></div><p class="calibre7">To identify the threats against our<a id="id350" class="calibre1"/> system, we need to classify the capabilities of our adversaries. This is a highly personal analysis, but we can generalize our adversaries into three archetypes: a well funded state actor, a skilled cracker, and a jealous ex-lover. The state actor has nearly limitless resources both from a financial and personnel point of view. The cracker is a skilled operator, but lacks the funding and resources of the state actor. The jealous ex-lover is not a sophisticated computer attacker, but is very motivated to do you harm.</p><p class="calibre7">Unfortunately, if you are the target of directed surveillance from a state actor, you probably have much bigger problems than your GPG keys. This actor can put your entire life under monitoring and why go through the trouble of stealing your GPG keys when the hidden video camera in the wall records everything on your screen.</p><p class="calibre7">Also, it's reasonable to assume that everyone you are communicating with is also under surveillance and it only takes one mistake from one person to reveal your plans for world domination.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="tip12" class="calibre1"/>Tip</h3><p class="calibre7">The adage by Benjamin Franklin is apropos here: <span class="strong"><em class="calibre9">Three may keep a secret if two of them are dead</em></span>.</p></div><p class="calibre7">However, properly <a id="id351" class="calibre1"/>using GPG will protect you from global passive surveillance. When used correctly, neither your Internet Service Provider, nor your e-mail provider, or any passive attacker would learn the contents of your messages. The passive adversary is not going to engage your system, but they could monitor a significant amount of Internet traffic in an attempt to <span class="strong"><em class="calibre9">collect it all</em></span>. Therefore, the confidentiality of your message should remain protected.</p><p class="calibre7">We'll assume the cracker trying to harm you is remote and does not have physical access to your BBB. We'll also assume the worst case that the cracker has compromised your host machine. In this scenario there is, unfortunately, a lot that the cracker can perform. He can install a key logger and capture everything, including the password that is typed on your computer. He will not be able to get the code that we'll enter on the BBB; however, he would be able to log in to the BBB when the key is available.</p><p class="calibre7">The jealous ex-lover doesn't understand computers very well, but he doesn't need to, because he knows how to use a golf club. He knows that this BBB connected to your computer is somehow important to you because you've talked his ear off about this really cool project that you read in a book. He physically can destroy the BBB and with it, your private key (and probably the relationship as well!).</p></div></div>

<div class="book" title="Developing a threat model">
<div class="book" title="Identifying the risks"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec50" class="calibre1"/>Identifying the risks</h2></div></div></div><p class="calibre7">How likely are the<a id="id352" class="calibre1"/> previous risks? The risk of active government surveillance in most countries is fortunately low. However, the consequences of this attack are very damaging. The risk of being caught up in passive surveillance by a state actor, as we have learned from Edward Snowden, is very likely. However, by using GPG, we add protection against this threat. An active cracker seeking you harm is probably unlikely. Contracting keystroke-capturing malware, however, is probably not an unreasonable event. A 2013 study by Microsoft concluded that 8 out of every 1,000 computers were infected with malware. You may be tempted to play these odds but let's rephrase this statement: in a group of 125 computers, one is infected with malware. A school or university easily has more computers than this. Lastly, only you can assess the risk of a jealous ex-lover.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note28" class="calibre1"/>Note</h3><p class="calibre7">For the full Microsoft report,<a id="id353" class="calibre1"/> refer to <a class="calibre1" href="http://blogs.technet.com/b/security/archive/2014/03/31/united-states-malware-infection-rate-more-than-doubles-in-the-first-half-of-2013.aspx">http://blogs.technet.com/b/security/archive/2014/03/31/united-states-malware-infection-rate-more-than-doubles-in-the-first-half-of-2013.aspx</a>.</p></div></div></div>

<div class="book" title="Developing a threat model">
<div class="book" title="Mitigating the identified risks"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch04lvl2sec51" class="calibre1"/>Mitigating the identified risks</h2></div></div></div><p class="calibre7">If you find yourself the target <a id="id354" class="calibre1"/>of a state, this project alone is not going to help much. We can protect ourselves somewhat from the cracker with two strategies. The first is instead of connecting the BBB to your laptop or computer, you can use the BBB as a standalone machine and transfer files via a microSD card. This is known as an<a id="id355" class="calibre1"/> <span class="strong"><strong class="calibre8">air-gap</strong></span>. With a dedicated monitor and keyboard, it is much less likely for software vulnerabilities to break the gap and infect the BBB. However, this comes as a high level of personal inconvenience, depending on how often you encrypt files. If you consider the risk of running the BBB attached to your computer too high, create an air-gapped BBB for maximum protection. If you deem the risk low, because you've hardened your computer and have other protection mechanism, then keep the BBB attached to the computer.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note29" class="calibre1"/>Note</h3><p class="calibre7">An air-gapped computer can still be compromised. In 2010, a highly specialized worm known as Stuxnet was able to spread to networked isolated machines through USB flash drives.</p></div><p class="calibre7">The second strategy is to somehow enter the GPG passphrase directly into the BBB without using the host's keyboard. After we complete the project, we'll suggest a mechanism to do this, but it is slightly more complicated. This would eliminate the threat of the key logger since the pin is directly entered.</p><p class="calibre7">The mitigation against the ex-lover is to treat your BBB as you would your own wallet, and don't leave it out of your sight. It's slightly larger than you would want, but it's certainly small enough to fit in a small backpack or briefcase.</p></div></div>

<div class="book" title="Developing a threat model">
<div class="book" title="Summarizing our threat model"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_6"><a id="ch04lvl2sec52" class="calibre1"/>Summarizing our threat model</h2></div></div></div><p class="calibre7">Our threat model, while cursory, illustrates<a id="id356" class="calibre1"/> the thought process one should go through before using or developing security technologies. The term threat model is specific to the security industry, but it's really just proper planning. The purpose of this analysis is to find <span class="strong"><em class="calibre9">logic bugs</em></span> and <a id="id357" class="calibre1"/>prevent you from spending thousands of dollars on high-tech locks for your front door when you keep your backdoor unlocked. Now that we understand what we are trying to protect and why it is important to use GPG, let's build the project.</p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Generating GPG keys"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec42" class="calibre1"/>Generating GPG keys</h1></div></div></div><p class="calibre7">First, we need to install GPG<a id="id358" class="calibre1"/> on the BBB. It is mostly likely already installed, but you can check <a id="id359" class="calibre1"/>and install it with the following<a id="id360" class="calibre1"/> command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install gnupg gnupg-curl</strong></span>
</pre></div><p class="calibre7">Next, we need to add a secret key. For those that already have a secret key, you can import your secret key ring, <code class="email">secring.gpg</code>, to your <code class="email">~/.gnupg</code> folder. For those that want to create a new key, on the BBB, proceed to the upcoming section.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note30" class="calibre1"/>Note</h3><p class="calibre7">This project assumes some familiarity with GPG. If GPG is new to you, the Free Software Foundation maintains the <span class="strong"><strong class="calibre8">Email Self-Defense</strong></span> guide<a id="id361" class="calibre1"/> which is a very approachable introduction to the software and can be found at <a class="calibre1" href="https://emailselfdefense.fsf.org/en/index.html">https://emailselfdefense.fsf.org/en/index.html</a>.</p></div></div>

<div class="book" title="Generating GPG keys">
<div class="book" title="Generating entropy"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec53" class="calibre1"/>Generating entropy</h2></div></div></div><p class="calibre7">If you decided to create a new key <a id="id362" class="calibre1"/>on the BBB, there are a few technicalities we must consider. First<a id="id363" class="calibre1"/> of all, GPG will need a lot of random data to generate the keys. The amount of random data available in the kernel is proportional to the amount of entropy that is available. You can check the available entropy with the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">cat /proc/sys/kernel/random/entropy_avail</strong></span>
</pre></div><p class="calibre7">If this command returns a relatively low number, under 200, then GPG will not have enough entropy to generate a key. On a PC, one can increase the amount of entropy by interacting with the computer such as typing on the keyboard or moving the mouse. However, such sources of entropy are difficult for embedded systems, and in our current setup, we don't have the luxury of moving a mouse.</p><p class="calibre7">Fortunately, there are a few tools to help us. If your BBB is running kernel version 3.13 or later, we can use the hardware random number generator on the AM3358 to help us out. You'll need to install the<a id="id364" class="calibre1"/> <code class="email">rng-tools</code> package. Once installed, you can edit <code class="email">/etc/default/rng-tools</code> and add the following line to register the hardware random number generated for <code class="email">rng-tools</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">HRNGDEVICE=/dev/hwrng</strong></span>
</pre></div><p class="calibre7">After this, you should start the <code class="email">rng-tools</code> daemon with:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">/etc/init.d/rng-tools start</strong></span>
</pre></div><p class="calibre7">If you don't have <code class="email">/dev/hwrng</code>—and currently, the chips on the CryptoCape do not yet have character device support and aren't available to <code class="email">/dev/hwrng</code>—then you can install <code class="email">haveged</code>. This daemon implements the <span class="strong"><strong class="calibre8">Hardware Volatile Entropy Gathering and Expansion</strong></span> (<span class="strong"><strong class="calibre8">HAVEGE</strong></span>)<a id="id365" class="calibre1"/> algorithm, the details of <a id="id366" class="calibre1"/>which are available at <a class="calibre1" href="http://www.irisa.fr/caps/projects/hipsor/">http://www.irisa.fr/caps/projects/hipsor/</a>. This daemon will ensure that the BBB maintains a pool of entropy, which will be sufficient for<a id="id367" class="calibre1"/> generating a GPG key on the BBB.</p></div></div>

<div class="book" title="Generating GPG keys">
<div class="book" title="Creating a good gpg.conf file"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec54" class="calibre1"/>Creating a good gpg.conf file</h2></div></div></div><p class="calibre7">Before you generate your key, we need<a id="id368" class="calibre1"/> to establish some more secure defaults for GPG. As we discussed earlier, it is still not as easy as it should be to use e-mail encryption. <a class="calibre1" href="http://Riseup.net">Riseup.net</a>, an e-mail provider with a strong social cause, maintains an OpenPGP<a id="id369" class="calibre1"/> best practices guide at <a class="calibre1" href="https://help.riseup.net/en/security/message-security/openpgp/best-practices">https://help.riseup.net/en/security/message-security/openpgp/best-practices</a>. This guide details how to harden your GPG configuration and provides the motivation behind each option. It is well worth a read to understand the intricacies of GPG key management.</p><p class="calibre7">Jacob Applebaum maintains an implementation of these best practices, which<a id="id370" class="calibre1"/> you should download from <a class="calibre1" href="https://github.com/ioerror/duraconf/raw/master/configs/gnupg/gpg.conf">https://github.com/ioerror/duraconf/raw/master/configs/gnupg/gpg.conf</a> and save as your <code class="email">~/.gnupg/gpg.conf</code> file. The configuration is well commented and you can refer to the best practices guide available at <a class="calibre1" href="http://Riseup.net">Riseup.net</a> for more information. There are three entries, however, that you should modify. The first is <code class="email">default-key</code>, which is the fingerprint of your primary GPG key. Later in this chapter, we'll show you how to retrieve that fingerprint. We can't perform this action now because we don't have a key yet. The second is <code class="email">keyserver-options ca-cert-file</code>, which is the certificate authority for the<a id="id371" class="calibre1"/> <span class="strong"><strong class="calibre8">keyserver pool</strong></span>. Keyservers host your public keys and a keyserver pool is a redundant collection of keyservers. The instructions on <a class="calibre1" href="http://Riseup.net">Riseup.net</a> gives the details on how to download and install that certificate. Lastly, you can use Tor to fetch updates on your keys.</p><p class="calibre7">The act of you requesting a public key from a keyserver signals that you have a potential interest in communicating with the owner of that key. This metadata might be more interesting to a passive adversary than the contents of your message, since it reveals your social network. As we learned in <a class="calibre1" title="Chapter 2. Circumventing Censorship with a Tor Bridge" href="part0019_split_000.html#page">Chapter 2</a>, <span class="strong"><em class="calibre9">Circumventing Censorship with a Tor Bridge</em></span>, Tor is apt at protecting traffic analysis. You probably don't want to store your GPG keys on the same BBB as your bridge, so a second BBB would help here. On your GPG BBB, you need to only run Tor as a client, which is its default configuration. Then you can update <code class="email">keyserver-options http-proxy</code> to point to your Tor SOCKS proxy running on <code class="email">localhost</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note31" class="calibre1"/>Note</h3><p class="calibre7">The <span class="strong"><strong class="calibre8">Electronic Frontier Foundation</strong></span> (<span class="strong"><strong class="calibre8">EFF</strong></span>)<a id="id372" class="calibre1"/> provides some hypothetical examples on the telling nature of metadata, for example, <span class="strong"><em class="calibre9">They (the government) know you called the suicide prevention hotline from the Golden Gate Bridge. But the topic of the call remains a secret</em></span>. Refer to the EFF<a id="id373" class="calibre1"/> blog post at <a class="calibre1" href="https://www.eff.org/deeplinks/2013/06/why-metadata-matters">https://www.eff.org/deeplinks/2013/06/why-metadata-matters</a> for more details.</p></div></div></div>

<div class="book" title="Generating GPG keys">
<div class="book" title="Generating the key"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_3"><a id="ch04lvl2sec55" class="calibre1"/>Generating the key</h2></div></div></div><p class="calibre7">Now you can generate your<a id="id374" class="calibre1"/> GPG key. Follow the on screen instructions and don't include a comment. Depending on your entropy source, this could take a while. This example took 10 minutes using <code class="email">haveged</code> as the entropy collector. There are various opinions on what to set as the expiration date. If this is your first GPG, try one year at first. You can always make a new key or extend the same one. If you set the key to never expire and you lose the key, by forgetting the passphrase, people will still think it's valid unless you revoke it. Also, be sure to set the user ID to a name that matches some sort of identification, which will make it easier for people to verify that the holder of the private key is the same person as a certified piece of paper. The command to create a new key is <code class="email">gpg –-gen-key</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Please select what kind of key you want:</strong></span>
<span class="strong"><strong class="calibre8">   (1) RSA and RSA (default)</strong></span>
<span class="strong"><strong class="calibre8">   (2) DSA and Elgamal</strong></span>
<span class="strong"><strong class="calibre8">   (3) DSA (sign only)</strong></span>
<span class="strong"><strong class="calibre8">   (4) RSA (sign only)</strong></span>
<span class="strong"><strong class="calibre8">Your selection? 1</strong></span>
<span class="strong"><strong class="calibre8">RSA keys may be between 1024 and 4096 bits long.</strong></span>
<span class="strong"><strong class="calibre8">What keysize do you want? (2048) 4096</strong></span>
<span class="strong"><strong class="calibre8">Requested keysize is 4096 bits</strong></span>
<span class="strong"><strong class="calibre8">Please specify how long the key should be valid.</strong></span>
<span class="strong"><strong class="calibre8">         0 = key does not expire</strong></span>
<span class="strong"><strong class="calibre8">      &lt;n&gt;  = key expires in n days</strong></span>
<span class="strong"><strong class="calibre8">      &lt;n&gt;w = key expires in n weeks</strong></span>
<span class="strong"><strong class="calibre8">      &lt;n&gt;m = key expires in n months</strong></span>
<span class="strong"><strong class="calibre8">      &lt;n&gt;y = key expires in n years</strong></span>
<span class="strong"><strong class="calibre8">Key is valid for? (0) 1y</strong></span>
<span class="strong"><strong class="calibre8">Key expires at Sat 06 Jun 2015 10:07:07 PM UTC</strong></span>
<span class="strong"><strong class="calibre8">Is this correct? (y/N) y</strong></span>

<span class="strong"><strong class="calibre8">You need a user ID to identify your key; the software constructs the user ID</strong></span>
<span class="strong"><strong class="calibre8">from the Real Name, Comment and Email Address in this form:</strong></span>
<span class="strong"><strong class="calibre8">    "Heinrich Heine (Der Dichter) &lt;heinrichh@duesseldorf.de&gt;"</strong></span>

<span class="strong"><strong class="calibre8">Real name: Tyrone Slothrop</strong></span>
<span class="strong"><strong class="calibre8">Email address: tyrone.slothrop@yoyodyne.com</strong></span>
<span class="strong"><strong class="calibre8">Comment:</strong></span>
<span class="strong"><strong class="calibre8">You selected this USER-ID:</strong></span>
<span class="strong"><strong class="calibre8">    "Tyrone Slothrop &lt;tyrone.slothrop@yoyodyne.com&gt;"</strong></span>

<span class="strong"><strong class="calibre8">Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O</strong></span>
<span class="strong"><strong class="calibre8">You need a Passphrase to protect your secret key.</strong></span>

<span class="strong"><strong class="calibre8">We need to generate a lot of random bytes. It is a good idea to perform some other action (type on the keyboard, move the mouse, utilize the disks) during the prime generation; this gives the random number generator a better chance to gain enough entropy.</strong></span>
<span class="strong"><strong class="calibre8">......+++++</strong></span>
<span class="strong"><strong class="calibre8">..+++++</strong></span>

<span class="strong"><strong class="calibre8">gpg: key 0xABD9088171345468 marked as ultimately trusted</strong></span>
<span class="strong"><strong class="calibre8">public and secret key created and signed.</strong></span>

<span class="strong"><strong class="calibre8">gpg: checking the trustdb</strong></span>
<span class="strong"><strong class="calibre8">gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model</strong></span>
<span class="strong"><strong class="calibre8">gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u</strong></span>
<span class="strong"><strong class="calibre8">gpg: next trustdb check due at 2015-06-06</strong></span>
<span class="strong"><strong class="calibre8">pub   4096R/0xABD9088171345468 2014-06-06 [expires: 2015-06-06]</strong></span>
<span class="strong"><strong class="calibre8">      Key fingerprint = CBF9 1404 7214 55C5 C477  B688 ABD9 0881 7134 5468</strong></span>
<span class="strong"><strong class="calibre8">uid                 [ultimate] Tyrone Slothrop &lt;tyrone.slothrop@yoyodyne.com&gt;</strong></span>
<span class="strong"><strong class="calibre8">sub   4096R/0x9DB8B6ACC7949DD1 2014-06-06 [expires: 2015-06-06]</strong></span>

<span class="strong"><strong class="calibre8">gpg --gen-key  320.62s user 0.32s system 51% cpu 10:23.26 total</strong></span>
</pre></div><p class="calibre7">From this example, we know<a id="id375" class="calibre1"/> that our secret key is <code class="email">0xABD9088171345468</code>. If you end up creating multiple keys, but use just one of them more regularly, you can edit your <code class="email">gpg.conf</code> file and add the following line:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">default-key 0xABD9088171345468</strong></span>
</pre></div></div></div>

<div class="book" title="Generating GPG keys">
<div class="book" title="Postgeneration maintenance"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_4"><a id="ch04lvl2sec56" class="calibre1"/>Postgeneration maintenance</h2></div></div></div><p class="calibre7">In order for people to send<a id="id376" class="calibre1"/> you encrypted messages, they need to know your public key. Having your public key server can help distribute your public key. You can post your key as follows, and replace the fingerprint with your primary key ID:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">gpg --send-keys 0xABD9088171345468</strong></span>
</pre></div><div class="informalexample" title="Note"><h3 class="title2"><a id="note32" class="calibre1"/>Note</h3><p class="calibre7">GPG does not rely on third parties and expects you to perform key management. To ease this burden, the OpenPGP standards define the Web-of-Trust as a mechanism to verify other users' keys. Details on how to participate in the Web-of-Trust can be found in the GPG Privacy Handbook<a id="id377" class="calibre1"/> at <a class="calibre1" href="https://www.gnupg.org/gph/en/manual/x334.html">https://www.gnupg.org/gph/en/manual/x334.html</a>.</p></div><p class="calibre7">You are also going to want to<a id="id378" class="calibre1"/> create a revocation certificate. A revocation certificate is needed when you want to revoke your key. You would do this when the key has been compromised, say if it was stolen. Or more likely, if the BBB fails and you can no longer access your key. Generate the certificate and follow the ensuing prompts replacing the ID with your key ID:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">gpg --output revocation-certificate.asc --gen-revoke 0xABD9088171345468</strong></span>

<span class="strong"><strong class="calibre8">sec  4096R/0xABD9088171345468 2014-06-06 Tyrone Slothrop &lt;tyrone.slothrop@yoyodyne.com&gt;</strong></span>

<span class="strong"><strong class="calibre8">Create a revocation certificate for this key? (y/N) y</strong></span>
<span class="strong"><strong class="calibre8">Please select the reason for the revocation:</strong></span>
<span class="strong"><strong class="calibre8">  0 = No reason specified</strong></span>
<span class="strong"><strong class="calibre8">  1 = Key has been compromised</strong></span>
<span class="strong"><strong class="calibre8">  2 = Key is superseded</strong></span>
<span class="strong"><strong class="calibre8">  3 = Key is no longer used</strong></span>
<span class="strong"><strong class="calibre8">  Q = Cancel</strong></span>
<span class="strong"><strong class="calibre8">(Probably you want to select 1 here)</strong></span>
<span class="strong"><strong class="calibre8">Your decision? 0</strong></span>
<span class="strong"><strong class="calibre8">Enter an optional description; end it with an empty line:</strong></span>
<span class="strong"><strong class="calibre8">&gt;</strong></span>
<span class="strong"><strong class="calibre8">Reason for revocation: No reason specified</strong></span>
<span class="strong"><strong class="calibre8">(No description given)</strong></span>
<span class="strong"><strong class="calibre8">Is this okay? (y/N) y</strong></span>

<span class="strong"><strong class="calibre8">You need a passphrase to unlock the secret key for</strong></span>
<span class="strong"><strong class="calibre8">user: "Tyrone Slothrop &lt;tyrone.slothrop@yoyodyne.com&gt;"</strong></span>
<span class="strong"><strong class="calibre8">4096-bit RSA key, ID 0xABD9088171345468, created 2014-06-06</strong></span>

<span class="strong"><strong class="calibre8">ASCII armored output forced.</strong></span>
<span class="strong"><strong class="calibre8">Revocation certificate created.</strong></span>

<span class="strong"><strong class="calibre8">Please move it to a medium which you can hide away; if Mallory gets access to this certificate he can use it to make your key unusable.</strong></span>
<span class="strong"><strong class="calibre8">It is smart to print this certificate and store it away, just in case your media become unreadable.  But have some caution:  The print system of your machine might store the data and make it available to others!</strong></span>
</pre></div><p class="calibre7">Do take the advice and move this<a id="id379" class="calibre1"/> file off the BeagleBone. Printing it out and storing it somewhere safe is a good option, or burn it to a CD.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note33" class="calibre1"/>Note</h3><p class="calibre7">The lifespan of a CD or DVD may not be as long as you think. The United States National Archives Frequently Asked Questions (FAQ) page on optical storage media states that:</p><p class="calibre7">
<span class="strong"><em class="calibre9">"CD/DVD experiential life expectancy is 2 to 5 years even though published life expectancies are often cited as 10 years, 25 years, or longer."</em></span>
</p><p class="calibre7">Refer to their<a id="id380" class="calibre1"/> website <a class="calibre1" href="http://www.archives.gov/records-mgmt/initiatives/temp-opmedia-faq.html">http://www.archives.gov/records-mgmt/initiatives/temp-opmedia-faq.html</a> for more details.</p></div><p class="calibre7">Lastly, create an encrypted backup of your encryption key and consider storing that in a safe location on durable media.</p></div></div>

<div class="book" title="Generating GPG keys">
<div class="book" title="Using GPG"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_5"><a id="ch04lvl2sec57" class="calibre1"/>Using GPG</h2></div></div></div><p class="calibre7">With your <a id="id381" class="calibre1"/>GPG private key created or imported, you can now use GPG on the BBB as you would on any other computer. In <a class="calibre1" title="Chapter 1. Creating Your BeagleBone Black Development Environment" href="part0015_split_000.html#page">Chapter 1</a>, <span class="strong"><em class="calibre9">Creating Your BeagleBone Black Development Environment</em></span>, you installed Emacs on your host computer. If you follow the GNU/Linux instructions, you can also install Emacs on the BBB. If you do, you'll enjoy automatic GPG encryption and decryption for files that end in the <code class="email">.gpg</code> extension. For example, suppose you want to send a message to your good friend, Pirate Prentice, whose GPG key you already have. Compose your message in Emacs, and then save it with a <code class="email">.gpg</code> extension. Emacs will prompt you to select the public keys for encryption and will automatically encrypt the buffer. If a GPG-encrypted message is encrypted to a public key, with which you have the corresponding private key, Emacs will automatically decrypt the message if it ends with <code class="email">.gpg</code>. When using Emacs from the terminal, the prompt for encryption should look like the following screenshot:</p><div class="mediaobject"><img src="../images/00017.jpeg" alt="Using GPG" class="calibre10"/></div><p class="calibre11"> </p></div></div>

<div id="page" style="height:0pt"/><div class="book" title="Protecting your GPG key with a TPM"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec43" class="calibre1"/>Protecting your GPG key with a TPM</h1></div></div></div><p class="calibre7">If you want, you could stop the project <a id="id382" class="calibre1"/>now and happily use GPG on your BBB. But if you do, you would miss out on adding some extra protection with the CryptoCape, specifically, the <span class="strong"><strong class="calibre8">Trusted Platform Module</strong></span> (<span class="strong"><strong class="calibre8">TPM</strong></span>).<a id="id383" class="calibre1"/> In the upcoming sections, we will use the TPM to protect our GPG private key.</p></div>

<div class="book" title="Protecting your GPG key with a TPM">
<div class="book" title="Introducing trusted computing"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_1"><a id="ch04lvl2sec58" class="calibre1"/>Introducing trusted computing</h2></div></div></div><p class="calibre7">The TPM is a<a id="id384" class="calibre1"/> cryptographic co-processor. The TPM on the CryptoCape is Atmel's embedded I2C version, which conforms to version 1.2 of the TPM spec published by the <a id="id385" class="calibre1"/>
<span class="strong"><strong class="calibre8">Trusted Computing Grou</strong></span>p (<span class="strong"><strong class="calibre8">TCG</strong></span>). The TCG is an industry consortium that maintains and develops open specifications for trusted computing. <span class="strong"><em class="calibre9">Trusted</em></span> in this sense is the definition from RFC 4949: <span class="strong"><em class="calibre9">a system that operates as expected, according to design and policy</em></span>.</p><p class="calibre7">Cryptographically, TPM 1.2 is limited. It implements the RSA algorithm, SHA-1, has an internal random number generator, and some limited storage. It does not provide any symmetric ciphers. These limitations were a result of the design goal for a low cost embeddable module. Symmetric ciphers were eliminated, because with the TPM, one can protect the symmetric keys at rest and allow the much more powerful host computer to operate on them.</p><p class="calibre7">The TPM 1.2 specification is, in total, over 700 pages. We will focus on a unique feature of the TPM that enables many of its security features: <span class="strong"><strong class="calibre8">Platform Control Registers</strong></span> (<span class="strong"><strong class="calibre8">PCRs</strong></span>). PCRs are TPM registers that can always be read but may only be written to with the <span class="strong"><strong class="calibre8">extend operation</strong></span>. The extend operation takes the current value of the 20 byte PCR, combines it with a 20 byte input value, and sets the new <a id="id386" class="calibre1"/>PCR value to the SHA-1 result of the combination. The key point is that once a PCR is set, it can't be reversed. It can only be continued to be combined in future extend operations.</p><p class="calibre7">At first, it may not be<a id="id387" class="calibre1"/> obvious how this feature helps. Let's consider an example. On boot, your computer's BIOS, prior to loading the bootloader, first sends a SHA-1 hash of the bootloader to the TPM to extend one of the PCRs. It then loads the bootloader. The bootloader performs the same operation on your kernel. The kernel then performs the same operation on various startup systems before finally allowing normal user operation. At the end of this process, the PCRs will be populated with a series of hash values.</p><p class="calibre7">The values of these registers represent a trusted measurement of your system. Now, say malware has infected your computer and has modified the boot process. On next boot, at least one of the PCRs will have a drastically different value than previously recorded. PCRs enable measurements of the boot process which provide assertions of the boot process.</p><p class="calibre7">There are several terms relating to the TPM-protected boot process. Secure boot will halt the boot processes if the PCR values do not match a known configuration. Authenticated boot simply measures the boot process and allows remote parties to make assertions on the pedigree of the boot process. Trusted boot refers to a system that uses both authenticated and secure boots.</p></div></div>

<div class="book" title="Protecting your GPG key with a TPM">
<div class="book" title="Encrypting data to a PCR state"><div class="book"><div class="book"><div class="book"><h2 class="title1" id="calibre_pb_2"><a id="ch04lvl2sec59" class="calibre1"/>Encrypting data to a PCR state</h2></div></div></div><p class="calibre7">The TPM supports another<a id="id388" class="calibre1"/> feature that builds on the state of the PCRs. As previously mentioned, the TPM can perform RSA encryption. However, the TPM can also combine the state of the PCRs to the encryption in a process known as<a id="id389" class="calibre1"/> <span class="strong"><strong class="calibre8">sealing</strong></span>. Once data is sealed to a PCR value, it can only be decrypted when the PCR matches the same value as when the encryption was performed.</p><p class="calibre7">How is this going to help us protect our GPG key? We will encrypt the GPG key to a known PCR state. We'll use the numeric code entered from the keypad connected to the CryptoCape as input into this PCR state. When the TPM decrypts the GPG private key, it will be available for use by GPG as usual. While GPG private keys are already protected with a passphrase, the TPM provides extra protection for the key at rest. The passphrase could still be captured with a keylogger, but our key won't be available until the BBB boots with the CryptoCape attached and the code entered directly into the BBB.</p><p class="calibre7">This system also helps in<a id="id390" class="calibre1"/> preventing offline attacks on the numeric code. The PCR value, once extended with the correct code, will allow unsealing of the data. But, if the wrong code is entered, the PCR value will be incorrect and the only way to reset the PCR, if that PCR is one of the <span class="strong"><em class="calibre9">non-resettable</em></span> PCRs, is to reboot.</p></div></div>
<div class="book" title="Adding the keypad"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec44" class="calibre1"/>Adding the keypad</h1></div></div></div><p class="calibre7">We're going to need a way to enter<a id="id391" class="calibre1"/> this code into the BBB. This code is used to populate one of the TPM's PCRs that will be used to seal the GPG key. This keypad will be connected to the ATmega328p on the CryptoCape. While the BBB is more than capable of handling the I/O for the keypad, by using the ATmega328p, we take advantage of code reuse. For most hardware products in the SparkFun catalog, there exists at least an unofficial Arduino library. If the components aren't available at SparkFun, then you should be able to find similar parts from the product descriptions. In the case of the keypad, there is an official library. The hardware for this project is listed in the following table:</p><div class="informalexample"><table border="1" class="calibre13"><colgroup class="calibre14"><col class="calibre15"/><col class="calibre15"/></colgroup><thead class="calibre16"><tr class="calibre17"><th valign="bottom" class="calibre18">
<p class="calibre19">Device</p>
</th><th valign="bottom" class="calibre18">
<p class="calibre19">SparkFun number</p>
</th></tr></thead><tbody class="calibre20"><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">CryptoCape</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">DEV-12773</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">Keypad</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">COM-08653</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">F/F jumper wires </p>
</td><td valign="top" class="calibre21">
<p class="calibre19">PRT-08430</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">Male breakaway headers</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">PRT-00116</p>
</td></tr></tbody></table></div><p class="calibre7">To build this Arduino<a id="id392" class="calibre1"/> library, you'll first need to install the <code class="email">Keypad</code> library from the Arduino playground site: <a class="calibre1" href="http://playground.arduino.cc/code/Keypad">http://playground.arduino.cc/code/Keypad</a>. Then clone the following repository from GitHub:</p><div class="informalexample"><pre class="programlisting">git clone https://github.com/jbdatko/beagle-bone-for-secret-agents.git
</pre></div><p class="calibre7">In the <code class="email">ch4</code> code folder, you'll find both the <code class="email">keypad.ino</code> source and the compiled hex that is ready to be loaded onto the 328p. From <a class="calibre1" title="Chapter 3. Adding Hardware Security with the CryptoCape" href="part0031_split_000.html#page">Chapter 3</a>, <span class="strong"><em class="calibre9">Adding Hardware Security with the CryptoCape</em></span>, remember that compiled sketches can be uploaded to the ATmega328p with the following command, just be sure to install the program jumpers:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo ./upload.sh keypad_cryptocape.cpp.hex</strong></span>
</pre></div><p class="calibre7">This program has the 328p joining the I2C bus at hex address 0x42. It then waits to receive data from an I2C master device, the BBB, and then will collect your five-digit code from the keypad. You have ten seconds to enter a five-digit code and the timer starts once the CryptoCape LED is lit. Each time you press a key, the LED will momentarily flash. Once all five characters are collected, the LED will turn off.</p><p class="calibre7">To connect the keypad to the <a id="id393" class="calibre1"/>CryptoCape, you first need to solder 0.1" male<a id="id394" class="calibre1"/> pins to the keypad. Also, you'll need to solder the 0.1" male header pins to the CryptoCape ATmega328p pads. Once the pins are installed, now you need to connect a jumper wire from the keypad to the CryptoCape. Note that the keypad has nine pins but only seven are used. Consider the first pin, closest to the <code class="email">*</code> character as <span class="strong"><em class="calibre9">pin 0</em></span>. Connect the jumpers per the following table:</p><div class="informalexample"><table border="1" class="calibre13"><colgroup class="calibre14"><col class="calibre15"/><col class="calibre15"/></colgroup><thead class="calibre16"><tr class="calibre17"><th valign="bottom" class="calibre18">
<p class="calibre19">Keypad pin</p>
</th><th valign="bottom" class="calibre18">
<p class="calibre19">Arduino digital pin</p>
</th></tr></thead><tbody class="calibre20"><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">3</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D2</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">1</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D3</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">5</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D4</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">2</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D5</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">7</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D6</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">6</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D7</p>
</td></tr><tr class="calibre17"><td valign="top" class="calibre21">
<p class="calibre19">4</p>
</td><td valign="top" class="calibre21">
<p class="calibre19">D8</p>
</td></tr></tbody></table></div><p class="calibre7">The keypad, when attached to the CryptoCape, should look like the following image:</p><div class="mediaobject"><img src="../images/00018.jpeg" alt="Adding the keypad" class="calibre10"/></div><p class="calibre11"> </p><div class="informalexample" title="Note"><h3 class="title2"><a id="note34" class="calibre1"/>Note</h3><p class="calibre7">The case shown in the image is<a id="id395" class="calibre1"/> logic supply's plated steel chassis. It is available on their website: <a class="calibre1" href="http://www.logicsupply.com/components/beaglebone/boards-cases-kits/bb100-orange/">http://www.logicsupply.com/components/beaglebone/boards-cases-kits/bb100-orange/</a>.</p></div><p class="calibre7">Now, we need <a id="id396" class="calibre1"/>some software that will initiate the code collection process on the<a id="id397" class="calibre1"/> ATmega328p. Remember that the software needs to collect the code and then extend the PCR. In the previously listed repository is a file, <code class="email">keypad.c</code>, which does exactly this. To build this program, you'll need the development package of the open source TCG software stack:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install libtspi-dev</strong></span>
</pre></div><p class="calibre7">Then you should be able to compile the program with:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">gcc keypad.c -o getgpgpin -ltspi</strong></span>
</pre></div></div>
<div class="book" title="Taking ownership of the TPM"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec45" class="calibre1"/>Taking ownership of the TPM</h1></div></div></div><p class="calibre7">Before we use the <a id="id398" class="calibre1"/>TPM, we must first take ownership of it. Taking ownership establishes an owner password for maintenance operations and a password for one of the root keys inside the TPM, the <span class="strong"><strong class="calibre8">Storage Root Key</strong></span> (<span class="strong"><strong class="calibre8">SRK</strong></span>)<a id="id399" class="calibre1"/> (pronounced <span class="strong"><em class="calibre9">shark</em></span>). You can set the administrator password to any password you want, but to work with legacy software, you'll want to set the SRK to the <span class="strong"><em class="calibre9">well-known password</em></span> of twenty zeros. You can set a unique SRK password if you want, but the TrouSerS software, the software used to control the TPM, includes a command-line parameter to set the password to its well-known value for a reason. First install <code class="email">tpm-tools</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install tpm-tools</strong></span>
</pre></div><p class="calibre7">Then you should restart your BBB with the CryptoCape attached. This will ensure that the TPM kernel driver and associate software load correctly. To check if everything is working properly issue the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">dmesg | grep TPM</strong></span>
</pre></div><p class="calibre7">This should return:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">[    5.370109] tpm_i2c_atmel 1-0029: Issuing TPM_STARTUP</strong></span>
</pre></div><p class="calibre7">Then check for the daemon by issuing:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">ps aux | grep tcsd</strong></span>
</pre></div><p class="calibre7">This command should return something like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">tss  799  0.0  0.1  11492   980 ?  Ss Jun08 0:00 /usr/sbin/tcsd</strong></span>
</pre></div><p class="calibre7">Then you can take ownership of the TPM as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">tpm_takeownership -z -l debug</strong></span>
</pre></div><p class="calibre7">You'll be prompted to enter an owner password. The <code class="email">-z</code> option sets the SRK to the well-known passphrase. The response should be:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">Tspi_Context_Create success</strong></span>
<span class="strong"><strong class="calibre8">Enter owner password:</strong></span>
<span class="strong"><strong class="calibre8">Confirm password:</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Context_Connect success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Context_GetTpmObject success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_GetPolicyObject success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Policy_SetSecret success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Context_CreateObject success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_GetPolicyObject success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Policy_SetSecret success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_TPM_TakeOwnership success</strong></span>
<span class="strong"><strong class="calibre8">tpm_takeownership succeeded</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Context_CloseObject success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Context_FreeMemory success</strong></span>
<span class="strong"><strong class="calibre8">Tspi_Context_Close success</strong></span>
</pre></div><p class="calibre7">Now you are ready to use the TPM.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note35" class="calibre1"/>Note</h3><p class="calibre7">If you <a id="id400" class="calibre1"/>have the<a id="id401" class="calibre1"/> CryptoCape v02, then you will need to perform some additional steps. The version number is found on the bottom layer of the board, above the P8 header, near the open source hardware logo, which looks like a gear. The TPMs on this revision are shipped in compliance mode, which means the keys loaded on them are test keys. This helps test the TPM during manufacture, but the keys need to be changed by<a id="id402" class="calibre1"/> the end user. Refer to the page <a class="calibre1" href="http://cryptotronix.com/cryptocape-tpm/">http://cryptotronix.com/cryptocape-tpm/</a> for more details.</p></div></div>
<div class="book" title="Extending a PCR"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec46" class="calibre1"/>Extending a PCR</h1></div></div></div><p class="calibre7">We'll need to extend a PCR <a id="id403" class="calibre1"/>so that we can encrypt our GPG key. We'll arbitrarily choose PCR number 9. First let's view the PCR status to be sure that it is blank:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">cat /sys/class/misc/tpm0/device/pcrs | grep PCR-09</strong></span>
</pre></div><p class="calibre7">This should return the current state of the PCR, which without using secure boot is:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">PCR-09:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</strong></span>
</pre></div><p class="calibre7">Now, run the <code class="email">getgpgpin</code> program from the following section. You should see the LED turn green on the CryptoCape and you have 10 seconds to enter a five-digit pin. Each time you press a key, the LED should briefly flash and when five digits have been entered, the LED will turn off. After 10 seconds, the <code class="email">getgpgpin</code> program will silently exit. If you compiled the program with <code class="email">#define DEBUG</code> set to <code class="email">1</code>, you should see something like this:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">54321</strong></span>
<span class="strong"><strong class="calibre8">(Line 53, extend_pcr)  Create a Context</strong></span>
<span class="strong"><strong class="calibre8"> returned 0x00000000. Success.</strong></span>
<span class="strong"><strong class="calibre8">(Line 55, extend_pcr)  Connect to TPM</strong></span>
<span class="strong"><strong class="calibre8"> returned 0x00000000. Success.</strong></span>
<span class="strong"><strong class="calibre8">(Line 59, extend_pcr)  GetTPM Handle</strong></span>
<span class="strong"><strong class="calibre8"> returned 0x00000000. Success.</strong></span>
<span class="strong"><strong class="calibre8">(Line 62, extend_pcr)  Owner Policy</strong></span>
<span class="strong"><strong class="calibre8"> returned 0x00000000. Success.</strong></span>
<span class="strong"><strong class="calibre8">36987(Line 73, extend_pcr)  extend</strong></span>
<span class="strong"><strong class="calibre8"> returned 0x00000000. Success.</strong></span>
</pre></div><p class="calibre7">Now, check your PCR status again:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">cat /sys/class/misc/tpm0/device/pcrs | grep PCR-09</strong></span>
</pre></div><p class="calibre7">You should now have a populated PCR9:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">PCR-09:2B 1E 41 10 EB A0 91 9E B4 89 0E 04 83 0B 70 C5 C2 AA 23 44</strong></span>
</pre></div><p class="calibre7">You can only enter the code once. If you try it again, the program will extend PCR9 again using the now incorrect PCR state as input into the next. Now, let's seal our GPG secret key ring:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">tpm_sealdata -p 9 -i secring.gpg -o secring.gpg.tpm -z -l debug</strong></span>
</pre></div><p class="calibre7">You can remove <code class="email">-l debug</code> if you wish and the command will silently complete. Let's test decryption:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">tpm_unsealdata -i secring.gpg.tpm -o deleteme -z</strong></span>
</pre></div><p class="calibre7">It should silently complete <a id="id404" class="calibre1"/>on success. You can now delete the temporary file <code class="email">deleteme</code> and the original <code class="email">secring.gpg</code>. You did make an encrypted backup, right? You'll probably want to delete the file in a more secure fashion. The secure remove tool <code class="email">srm</code> does just that and overwrites the file numerous times before deleting. To install use the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">sudo apt-get install secure-delete</strong></span>
</pre></div><p class="calibre7">Then use just as you would <code class="email">rm</code>.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note36" class="calibre1"/>Note</h3><p class="calibre7">Bunnie Huang and Sean Cross (also known <a id="id405" class="calibre1"/>as <span class="strong"><em class="calibre9">xobs</em></span>) presented a talk at the <span class="strong"><strong class="calibre8">30th Chaos Communication Congress</strong></span> (<span class="strong"><strong class="calibre8">30C3</strong></span>)<a id="id406" class="calibre1"/> on hacking SD cards. Your SD or eMMC includes a small microcontroller that manages the attached flash memory. This microcontroller is perfectly situated to act as a Man-in-the-Middle attacker and manipulate the data you store on the device. For example, the microcontroller could keep a backup copy of your data since it would report to your computer a storage capacity of 8GB, but actually it contains a 16 GB flash chip. More information can be found on<a id="id407" class="calibre1"/> Bunnie's blog at <a class="calibre1" href="http://www.bunniestudios.com/blog/?p=3554">http://www.bunniestudios.com/blog/?p=3554</a>.</p></div></div>
<div class="book" title="Unlocking your key at startup"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec47" class="calibre1"/>Unlocking your key at startup</h1></div></div></div><p class="calibre7">Finally, we need to automate this <a id="id408" class="calibre1"/>process. When the BBB boots, we want it to collect the code, extend the PCR, and unwrap the GPG keys so that they are ready to use. We'll make an <code class="email">init.d</code> script that will handle this, but we still need to deal with the GPG key. We don't want an unwrapped GPG key lying around the disk, even if it is protected with a password. Instead, we'll keep the GPG keys on a <code class="email">ramfs</code>, which will never touch persistent storage.</p><p class="calibre7">To create the <code class="email">ramfs</code>, add the following to <code class="email">/etc/fstab</code>:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">ramfs    /mnt/ramdisk ramfs nodev,nosuid,noexec,nodiratime,size=1M,uid=1000,gid=1002   0 0</strong></span>
</pre></div><p class="calibre7">Be sure to replace your uid and gid with the appropriate values for your user. This can be obtained by running the <code class="email">id</code> command. Either reboot or run <code class="email">mount -a</code> to reload the <code class="email">fstab</code>. Since GPG expects the <code class="email">secring.gpg</code> to live in <code class="email">~/.gnupg/secring.gpg</code>, we'll create a link from there to the ramdisk. Create the following symlink:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">ln -s /mnt/ramdisk/secring.gpg ~/.gnupg/secring.gpg</strong></span>
</pre></div><p class="calibre7">Now, we want a script to run on boot. In the <code class="email">beagle-bone-for-secret-agents/ch4</code> repository, there is a script, <code class="email">tpm_gpg</code>, which you can copy to <code class="email">/etc/init.d/</code>. This script expects <code class="email">getgpgpin</code> to live in <code class="email">/usr/local/bin</code> and that your <code class="email">secring.gpg</code> is in the normal place. Edit as desired. To register this script, run as root:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong class="calibre8">update-rc.d tpm_gpg defaults</strong></span>
</pre></div><p class="calibre7">With the script in place, the ramdisk set to mount at boot, the ATmega programmed to collect the code, and the hardware attached, reboot one more time. Watch for the CryptoCape LED to turn on, enter your pin, and then log back in to the BBB. If your GPG key is in <code class="email">/mnt/ramdisk</code>, congratulations, you have just used your TPM to protect your GPG key! Because of the symlink, all GPG-related programs will use the keys just as usual. If not, recompile <code class="email">keypad.c</code> with debug<a id="id409" class="calibre1"/> set to <code class="email">1</code> to make sure everything is working.</p><div class="informalexample" title="Note"><h3 class="title2"><a id="note37" class="calibre1"/>Note</h3><p class="calibre7">While the ramfs is meant to ensure that the GPG key, which is still protected by a password, is destroyed without power, researchers have recovered keys from RAM in the past. Refer to the URL <a class="calibre1" href="https://citp.princeton.edu/research/memory/">https://citp.princeton.edu/research/memory/</a> on cold boot attacks.</p></div></div>
<div class="book" title="Iterating on the threat model"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec48" class="calibre1"/>Iterating on the threat model</h1></div></div></div><p class="calibre7">Threat modeling and<a id="id410" class="calibre1"/> system design is an iterative process. The system we built in this chapter is a good start, but it can be improved. We identified a problem at the beginning of the chapter in that we still had to enter the GPG passphrase from a potentially compromised computer. The code entry on the keypad is currently only protecting the GPG key when the BBB is powered off. It also protects the key if an attacker who doesn't know the code boots the BBB, since the PCR will not have the correct value after the 10-second window has passed. To mitigate against the key logger attack, we would want to enter a passphrase directly into the BBB.</p><p class="calibre7">There is a piece of software called <a id="id411" class="calibre1"/>
<span class="strong"><strong class="calibre8">gpg-agent</strong></span>, which manages your passphrase per login session. It can support different types of <span class="strong"><em class="calibre9">pin entry</em></span> programs. For example, one pin entry program is X-Windows-based and <a id="id412" class="calibre1"/>another supports a command-line interface. You could certainly create your own pin entry program that supported your custom hardware. However, when you create this custom pin entry, you'd want to consider the effect of a potentially weaker passphrase, one composed of only numbers, for your GPG key. This demonstrates the importance of re-evaluating your threat model as new features are added to the design to ensure the correctness of the original assumptions.</p><p class="calibre7">Also, you might want to consider adding an enclosure for your project. Your local hackerspace will be able to help you make a professionally looking enclosure. If you want something on the cheap, find a small translucent container and cut out room for the keypad and the connectors <a id="id413" class="calibre1"/>as shown in the following image:</p><div class="mediaobject"><img src="../images/00019.jpeg" alt="Iterating on the threat model" class="calibre10"/></div><p class="calibre11"> </p></div>
<div class="book" title="Summary"><div class="book"><div class="book"><div class="book"><h1 class="title" id="calibre_pb_0"><a id="ch04lvl1sec49" class="calibre1"/>Summary</h1></div></div></div><p class="calibre7">In this chapter, you learned how GPG can protect e-mail confidentiality. We created a threat model for our system and showed how this analysis can help us understand the capabilities and limitations of our design. At the end, we successfully built a BBB GPG co-processor that uses a TPM to help protect the GPG keys at rest and got more practice combining a microcontroller with an embedded Linux platform.</p><p class="calibre7">In the next chapter, we will investigate another major privacy enhancing technology that is used to protect real-time chat. You'll learn about the unique cryptographic properties of <a id="id414" class="calibre1"/>
<span class="strong"><strong class="calibre8">Off-the-Record</strong></span> (<span class="strong"><strong class="calibre8">OTR</strong></span>) and how to use OTR over an Internet Relay Chat gateway that is hosted by your BBB.</p></div></body></html>