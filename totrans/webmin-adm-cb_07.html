<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch07"/>Chapter 7. Backing Up Your System</h1></div></div></div><p>In this chapter, we will cover the following topics:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Backing up configuration files</li><li class="listitem" style="list-style-type: disc">Restoring configuration files from backup</li><li class="listitem" style="list-style-type: disc">Automatically backing up configuration files</li><li class="listitem" style="list-style-type: disc">Creating a backup of a selected directory</li><li class="listitem" style="list-style-type: disc">Creating a backup of an entire mount point</li><li class="listitem" style="list-style-type: disc">Backing up to a remote host</li><li class="listitem" style="list-style-type: disc">Setting up automatic backups</li><li class="listitem" style="list-style-type: disc">Backing up databases</li></ul></div><div><div><div><div><h1 class="title"><a id="ch07lvl1sec73"/>Introduction</h1></div></div></div><p>Data stored on your server is usually more important and valuable than the server hardware on which it is stored. Keeping your server secure and your data safe is one of the top priorities of a system administrator. As much as we hope to avoid trouble such as hardware failures or malicious security breaches, we need to be prepared to fix the consequences of these problems. Making regular backups of your data is essential to recover from unforeseen disasters. You should also regularly test the backups you create to make sure they will actually allow you to recover data when you need it.</p><p>In this chapter, we will provide recipes that demonstrate how Webmin helps you keep a backup of the following things:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Data files on your server, such as the source code of your applications and data entered and uploaded by users. See <em>Creating a backup of a selected directory</em>.</li><li class="listitem" style="list-style-type: disc">Information stored in databases. See <em>Backing up databases</em>.</li><li class="listitem" style="list-style-type: disc">Configuration settings. See <em>Backing up configuration files</em>.</li><li class="listitem" style="list-style-type: disc">The entire server filesystem. See <em>Creating a backup of an entire mount point</em>.</li></ul></div><p>Keep the following things in mind when designing your <a id="id495" class="indexterm"/>backup strategy:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Complete or incremental backups</strong>: A complete backup<a id="id496" class="indexterm"/> of a server or directory stores every file from that location. A backup of this type may be quite large, even if it is compressed, and your server may need a long time to create it. An incremental backup<a id="id497" class="indexterm"/>, on the other hand, stores only the files that were changed since the previous backup. This consumes much less space and can be completed quickly. On the other hand, incremental backups are slightly harder to restore, because you must first restore your last complete backup and then add files from the incremental backups created since the complete backup was created.</li><li class="listitem" style="list-style-type: disc"><strong>Online or offline backups</strong>: An online backup<a id="id498" class="indexterm"/> is readily accessible by your server or another computer, while an offline backup hand is stored on a tape or disconnected disk on a shelf. It cannot be accessed without the intervention of a human. Online backups are more convenient, but if a malicious attacker takes over your system, he/she can erase them. It's a good idea to keep offline copies of your data, as well.</li><li class="listitem" style="list-style-type: disc"><strong>Local or offsite backups</strong>: Keeping <a id="id499" class="indexterm"/>your backups in the same building as your servers <a id="id500" class="indexterm"/>will not protect you in the case of a fire or other disaster. You may want to keep additional backups in another remote location.</li></ul></div><p>A perfect backup strategy would store daily (and maybe even hourly) incremental backups and periodic (weekly or monthly) full backups in offline and offsite form. The number of backups you keep will determine how far back in time you can go to retrieve a lost or corrupted file.</p><div><div><h3 class="title"><a id="tip61"/>Tip</h3><p>Backups may contain sensitive data, such as passwords or other confidential information. Make sure to store backups securely, perhaps consider encrypting files stored offsite.</p></div></div><p>In this chapter, we'll demonstrate how to create backups, but it's up to you to make sure that the backup files are stored in a safe location and regularly tested.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec74"/>Backing up configuration files</h1></div></div></div><p>You spend a lot of time<a id="id501" class="indexterm"/> setting up your system and optimizing its settings for the best performance and features. Erasing a configuration file or even making changes that turn out not to be optimal can have dire consequences, especially in a production setting. Before making changes, you should make a backup of configuration files and keep it handy in case you need to revert to the previous configuration. Webmin has a facility to help you do just that.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec229"/>Getting ready</h2></div></div></div><p>In this recipe, we will create backup files with names containing the current date. We need to enable this feature. So, before starting the backup process, navigate to <strong>Webmin</strong> | <strong>Backup Configuration Files</strong> | <strong>Module Config</strong> and answer <strong>Yes</strong> to the question, <strong>Do strftime substitution of backup destinations?</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec230"/>How to do it...</h2></div></div></div><p>Perform the following steps to back up the configuration files:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a directory to store local backups in the root directory, for example, <code class="literal">/backups</code>.<div><div><h3 class="title"><a id="tip62"/>Tip</h3><p>Make sure that your backup directory is stored on a partition with enough disk space so you don't accidentally fill up your entire disk. Placing <code class="literal">/backups</code> on a separate partition or in <code class="literal">/var/backups</code> may be a good idea.</p><p>You should also protect the backup location from prying eyes. You can use permissions and ACLs to do this, as explained in the <em>Changing ACLs on a directory</em> section of the <em>Changing file ownership and permissions</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>.</p></div></div></li><li class="listitem">Navigate to <strong>Webmin</strong> | <strong>Backup Configuration Files</strong>.</li><li class="listitem">Select the <strong>Backup now</strong> tab.</li><li class="listitem">From the <strong>Modules to back up</strong> list, select the module you're planning to work with, for instance, <strong>Webmin Configuration</strong>.<div><div><h3 class="title"><a id="tip63"/>Tip</h3><p>You can backup multiple modules, or even all of them, if you want a more complete backup.</p></div></div></li><li class="listitem">Set <strong>Backup destination</strong> to <strong>Local file</strong> and specify the following for a filename: <code class="literal">/backups/webmin-config-%Y%m%d%H%M.tgz</code>.</li><li class="listitem">Set <strong>Include in backup</strong> to <strong>Server configuration files</strong>:<div><img src="img/5849_07_03.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Backup Now</strong> button.</li></ol></div><p>Webmin configuration <a id="id502" class="indexterm"/>files will be backed up in a file in the <code class="literal">/backups</code> directory. The name of the file will contain the date and time of the backup.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec231"/>How it works...</h2></div></div></div><p>Webmin knows which configuration files are used by the services it helps you configure. When you back up configuration files for a given module, Webmin creates a compressed <code class="literal">TAR</code> file with those files in the location you specify.</p><p>Since we activated <code class="literal">strftime</code> substitution, patterns preceded by a percent sign (<code class="literal">%</code>) are replaced by date components. For instance, <code class="literal">%Y</code> is replaced by the year number and <code class="literal">%m</code> by the month number. A full list of available tokens can be found by clicking the <strong>Do strftime substitution of backup destinations?</strong> link in the <strong>Module Config</strong> screen.</p><div><div><h3 class="title"><a id="tip64"/>Tip</h3><p>Webmin only backs up the files that it is aware of. If you would like to perform a complete backup of all configuration files on your server, you should consider making a backup of the entire <code class="literal">/etc</code> directory. Take a look at the <em>Creating a backup of a selected directory</em> recipe in this chapter for more information.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec232"/>There's more...</h2></div></div></div><p>Webmin allows you to<a id="id503" class="indexterm"/> back up files to a remote server using the FTP or SFTP (SSH) protocol. The steps to do this are the same as listed in the preceding section, except for changing the <strong>Backup destination</strong> option to <strong>FTP Server</strong> or <strong>SSH Server</strong>. To transfer files to a remote server, you also need to specify the remote server's IP or domain name and a username and password on the remote server. You may also choose to download the backup to the computer from which you are connecting to Webmin by choosing the <strong>Download in browser</strong> destination option.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec233"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are two other recipes in this chapter related to Webmin's backups of configuration settings files. Take a look at the <em>Restoring configuration files from backup</em> and <em>Automatically backing up configuration files</em> recipes of this chapter.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec75"/>Restoring configuration files from backup</h1></div></div></div><p>If you use Webmin to <a id="id504" class="indexterm"/>create backups of configuration files, you<a id="id505" class="indexterm"/> can use them later to restore system settings if you run into problems with the changes that you made since the backup.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec234"/>How to do it...</h2></div></div></div><p>To restore the configuration backups, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Webmin</strong> | <strong>Backup Configuration Files</strong>.</li><li class="listitem">Select the <strong>Restore now</strong> tab.</li><li class="listitem">From the <strong>Modules to restore</strong> list, select the module associated with the software whose configuration you would like to restore, for instance, <strong>Webmin Configuration</strong>.</li><li class="listitem">Set <strong>Restore from</strong> to <strong>Local file</strong>, click the ellipsis (<strong>…</strong>) button to bring up the file chooser, and select the backup file.<div><div><h3 class="title"><a id="tip65"/>Tip</h3><p>You may also choose a file located on a remote FTP or SSH server, or upload a file from the computer you're using to connect to Webmin.</p></div></div></li><li class="listitem">Set <strong>Apply configurations?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Just show what will be restored?</strong> to <strong>No</strong>.</li><li class="listitem">Click the <strong>Restore Now</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec235"/>How it works...</h2></div></div></div><p>Webmin keeps an <a id="id506" class="indexterm"/>index of files used by each module inside the <a id="id507" class="indexterm"/>backup archive. When you select one or more modules to restore, Webmin will replace their active configuration files with their backed up counterparts. If it's necessary, Webmin will restart the services that use the restored configuration files.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec236"/>There's more...</h2></div></div></div><p>It's a good idea to check which files would be restored from backup without actually making any changes before restoring the actual backup. To do this, follow the preceding section, but set the <strong>Just show what will be restored?</strong> option to <strong>Yes</strong>.</p><p>If you want, you can also inspect the content of the configuration files stored in the backup. After all, the backup is just a compressed <code class="literal">TAR</code> archive, so you can extract the files and view them. Take a look at the <em>Managing files and directories on the server</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>, to see how you can do this without leaving Webmin.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec237"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">There are two other recipes in this chapter related to Webmin's backups of configuration settings files. Take a look at the <em>Backing up configuration files</em> and <em>Automatically backing up configuration files</em> recipes of this chapter.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec76"/>Automatically backing up configuration files</h1></div></div></div><p>Webmin allows you to set up a schedule it will follow to create backups of system configuration files automatically. You can use this option to keep a rolling archive of configuration changes made on your system.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec238"/>Getting ready</h2></div></div></div><p>In this recipe, we will create backup files with names containing the current date. We need to enable this feature, so before starting, navigate to <strong>Webmin</strong> | <strong>Backup Configuration Files</strong> | <strong>Module Config</strong> and answer <strong>Yes</strong> to the question, <strong>Do strftime substitution of backup destinations?</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec239"/>How to do it...</h2></div></div></div><p>Perform the following<a id="id508" class="indexterm"/> steps to automatically back up the configuration files:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a directory to store local backups in the root directory, for example, <code class="literal">/backups</code>.<div><div><h3 class="title"><a id="tip66"/>Tip</h3><p>Make sure that your backup directory is stored on a partition with enough disk space so you don't accidentally fill up your entire disk. Placing <code class="literal">/backups</code> on a separate partition or in <code class="literal">/var/backups</code> may be a good idea.</p><p>You should also protect the backup location from prying eyes. You can use permissions and ACLs to do this, as explained in the <em>Changing ACLs on a directory</em> section of the <em>Changing file ownership and permissions</em> recipe in <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>.</p></div></div></li><li class="listitem">Navigate to <strong>Webmin</strong> | <strong>Backup Configuration Files</strong>.</li><li class="listitem">Select the <strong>Scheduled backups</strong> tab.</li><li class="listitem">Click the <strong>Add a new scheduled backup</strong> link.</li><li class="listitem">Select all modules in the <strong>Modules to backup</strong> list.</li><li class="listitem">Set <strong>Backup destination</strong> to <strong>Local file</strong> and specify the following for a filename: <code class="literal">/backups/system-config-%Y%m%d%H%M.tgz</code>.</li><li class="listitem">Set <strong>Include in backup</strong> to <strong>Server configuration files</strong>.</li><li class="listitem">Open the <strong>Backup schedule</strong> section.</li><li class="listitem">Provide your e-mail address in the <strong>Email result to address</strong> field.</li><li class="listitem">Set <strong>When to send email</strong> to <strong>Always</strong>.<div><div><h3 class="title"><a id="tip67"/>Tip</h3><p>After you receive a few e-mails to confirm that backups are working as expected, you can come back and switch this option to <strong>Only when an error occurs</strong>.</p></div></div></li><li class="listitem">Set <strong>Scheduled backup enabled?</strong> to <strong>Yes</strong>, select <strong>Simple schedule</strong>, and choose <strong>Daily (at midnight)</strong> from the dropdown.</li><li class="listitem">Click the <strong>Create</strong> button.</li></ol></div><p>System configuration files will be backed up every day at midnight to a file in the <code class="literal">/backups</code> directory. The name of the file will contain the date and time of the backup.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec240"/>How it works...</h2></div></div></div><p>Webmin creates a <a id="id509" class="indexterm"/>
<strong>cron</strong> job <a id="id510" class="indexterm"/>that runs at every midnight. The task creates a compressed <code class="literal">TAR</code> archive containing all the configuration files that Webmin is aware of. If an error occurs while creating the backup archive, an e-mail will be sent to the provided address.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec241"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Take a look at the <em>Restoring configuration files from backup</em> recipe of this chapter for information about getting your settings back in case of a problem.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec77"/>Creating a backup of a selected directory</h1></div></div></div><p>Webmin allows you to <a id="id511" class="indexterm"/>easily back up the contents of a directory to a <code class="literal">TAR</code> (tape archive) file. Backup <a id="id512" class="indexterm"/>tasks are saved, so you can perform the backup again with a single click in the future.</p><div><div><h3 class="title"><a id="note39"/>Note</h3><p>The <code class="literal">TAR</code> file format<a id="id513" class="indexterm"/> preserves information about file ownership and permissions set on each file. It does not, however, store the extended attributes of the files. If you're using extended attributes and an <code class="literal">ext</code> filesystem, you should use the <code class="literal">dump</code> command instead. Take a look at the <em>Creating a backup of an entire mount point</em> recipe of this chapter for more information about making backups with the <code class="literal">dump</code> command.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec242"/>Getting ready</h2></div></div></div><p>In this recipe, we will create backup files with names containing the current date. We need to enable this feature. So, before starting, navigate to <strong>System</strong> | <strong>Filesystem Backup</strong> | <strong>Module Config</strong> and answer <strong>Yes</strong> to the question, <strong>Do strftime substitution of backup destinations?</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec243"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Create a directory to store backups in the root directory, for example, <code class="literal">/backups</code>.</li><li class="listitem">Navigate to <strong>System</strong> | <strong>Filesystem Backup</strong>.</li><li class="listitem">Enter the path of the directory you would like to back up, for example, <code class="literal">/var/www</code> in the text field.</li><li class="listitem">Select the <strong>In TAR format</strong> option.</li><li class="listitem">Click the <strong>Add a new backup of directory</strong> button.</li><li class="listitem">Set <strong>Backup to</strong> to <strong>File or tape device</strong> and enter the destination backup filename in the text field, for example, <code class="literal">/backups/www-%Y%m%d%H%M.tgz</code>.</li><li class="listitem">Open the <strong>Backup Options</strong> section.</li><li class="listitem">Set <strong>Compress archive?</strong> to <strong>Yes, with gzip</strong>.</li><li class="listitem">Click the <strong>Create and Backup Now</strong> button.</li></ol></div><p>A backup of the directory will be created in a compressed <code class="literal">TAR</code> archive at the specified destination. The filename will include the date and time of creation.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec244"/>How it works...</h2></div></div></div><p>Webmin creates a Gzip <a id="id514" class="indexterm"/>compressed <code class="literal">TAR</code> archive of the selected directory<a id="id515" class="indexterm"/> in the specified backup location. This is roughly equivalent to running the following command at the command line:</p><div><pre class="programlisting">
<strong>$ tar -czf /backups/backup-destination.tgz /backup/source/directory</strong>
</pre></div><p>Before creating the backup, Webmin also executes the <code class="literal">sync</code> command that flushes the filesystem buffers, committing unwritten changes to the disk.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec245"/>There's more...</h2></div></div></div><p>When the time comes to restore files from a backup, you have a number of options. You can restore the files to a separate directory and then move them to the original location. You can also restore files from the archive directly to their original locations.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec85"/>Restoring files from a backup archive</h3></div></div></div><p>The following steps extract <a id="id516" class="indexterm"/>files to a temporary location from which you'll<a id="id517" class="indexterm"/> have to move them to their final locations:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a temporary directory (<code class="literal">/tmp/restore</code>) in which we'll store restored files before putting them in their original places.</li><li class="listitem">Navigate to <strong>System</strong> | <strong>Filesystem Backup</strong>.</li><li class="listitem">If you are presented with the option of filesystem type to restore, select <strong>TAR</strong>.</li><li class="listitem">Click the <strong>Restore backup of filesystem</strong> button.</li><li class="listitem">Set <strong>Restore from file or device</strong> to <strong>File or tape device</strong> and use the file chooser (the <strong>...</strong> button) to locate the backup archive you would like to restore.</li><li class="listitem">Set <strong>Restore to directory</strong> to <code class="literal">/tmp/restore</code>.</li><li class="listitem">Set <strong>Only show files in backup?</strong> to <strong>No</strong>.</li><li class="listitem">If your backup archive was compressed with Gzip, set <strong>Uncompress archive?</strong> to <strong>Yes, with gzip</strong>.</li><li class="listitem">Click the <strong>Restore Backup Now</strong> button.</li><li class="listitem">Move the files you want to restore from the <code class="literal">/tmp/restore</code> directory to their original locations.</li><li class="listitem">Delete the <code class="literal">/tmp/restore</code> directory.<div><div><h3 class="title"><a id="tip68"/>Tip</h3><p>To place files in their original locations automatically, use the root directory (<code class="literal">/</code>) as <strong>Restore to directory</strong>. Note that this option will place files from the backup back in place, but will not delete files created since the backup was created. If you would like to restore only those files that were deleted since backing up, use the <strong>Don't overwrite files?</strong> option.</p></div></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec246"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Take a look at the <em>Creating a backup of an entire mount point</em>, <em>Backing up to a remote host</em>, and <em>Setting up automatic backups</em> recipes of this chapter for more information about backing up files on your system.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec78"/>Creating a backup of an entire mount point</h1></div></div></div><p>Webmin allows <a id="id518" class="indexterm"/>you to set up <a id="id519" class="indexterm"/>backup tasks that use the UNIX <code class="literal">dump</code> command<a id="id520" class="indexterm"/> to archive the entire <code class="literal">ext</code> filesystem's mount points. This strategy has a number of advantages over creating archives using <code class="literal">TAR</code>. Firstly, all information contained in the filesystem is preserved, including extended file attributes, ACLs, special files, and so on.</p><p>Secondly, <code class="literal">dump</code> allows you to create incremental archives containing only the files changed since the previous backup. The <a id="id521" class="indexterm"/>
<code class="literal">dump</code> command uses the concept of levels to distinguish between full and partial backups. A level 0 backup will archive all files (full backup), while a level 1 will only archive files changed since the last level 0 backup. A level 2 backup will archive all files changed since the last level 1 backup, and so on. There are 10 levels to choose from, and you don't need to use consecutive level numbers. One possible <code class="literal">dump</code> strategy is to perform a level 0 backup every month, a level 3 backup every week, and a level 6 backup every day. This means that the daily backups will be relatively small and fast, as they keep track only of changes made during the week.</p><p>If you use an incremental <a id="id522" class="indexterm"/>backup strategy with <code class="literal">dump</code>, you'll need to restore backups from <a id="id523" class="indexterm"/>archives of each level. For example, if you followed the 0-3-6 strategy described in the previous paragraph, you would start by restoring files from the most recent level 0, then the most recent level 3, and finally, the most recent level 6 archive.</p><div><div><h3 class="title"><a id="tip69"/>Tip</h3><p>The <code class="literal">dump</code> command was designed to write backup archives to magnetic tape drives. Webmin will be able to assist you in writing files to a tape device; just specify the device name instead of a destination filename when creating a backup task.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec247"/>Getting ready</h2></div></div></div><p>Before starting, install the <code class="literal">dump</code> package on your system, or check that it is installed. Refer to the <em>Installing software packages</em> recipe from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System</em>, for more information.</p><p>You should also prepare a backup destination that is located on another filesystem, other than the one you're planning to back up. This may be an external drive, a network filesystem, or a magnetic tape device. In this recipe, I will assume you're backing up to an external disk mounted as <code class="literal">/media/backups</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec248"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>System</strong> | <strong>Filesystem Backup</strong>.</li><li class="listitem">In the text field, enter the mount point that you would like to back up, for example, <code class="literal">/</code>.</li><li class="listitem">Click the <strong>Add a new backup of directory</strong> button.</li><li class="listitem">Set <strong>Backup to</strong> to <strong>File or tape device</strong> and enter the destination backup filename in the text field, for example, <code class="literal">/media/backups/root-fs-level0-%Y%m%d%H%M.ext4dump</code>.<div><div><h3 class="title"><a id="note40"/>Note</h3><p>You don't need the file extension, but you may find it useful in the future to quickly check what type of filesystem is contained in a backup archive. Change <code class="literal">ext4</code> to <code class="literal">ext3</code> or <code class="literal">ext2</code>, depending on your system.</p></div></div></li><li class="listitem">Open the <a id="id524" class="indexterm"/><strong>Backup Options</strong> <a id="id525" class="indexterm"/>section.</li><li class="listitem">Set <strong>Update /etc/dumpdates file?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Dump level</strong> to <strong>0 (full backup)</strong>.</li><li class="listitem">Set <strong>Compress data?</strong> to <strong>Yes, with level</strong> and enter <code class="literal">2</code>.</li><li class="listitem">Click the <strong>Create and Backup Now</strong> button:<div><img src="img/5849_07_01.jpg" alt="How to do it..."/></div></li></ol></div><p>A backup of the<a id="id526" class="indexterm"/> entire filesystem's mount point will be created in a compressed <code class="literal">dump</code> archive at <a id="id527" class="indexterm"/>the specified destination. The filename will include the date and time of creation.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec249"/>How it works...</h2></div></div></div><p>Webmin uses the <code class="literal">dump</code> command<a id="id528" class="indexterm"/> to create a backup archive containing all the files from the filesystem mounted in the specified source directory. All the metadata contained in the filesystem is also stored in the archive. The backup is compressed using the <code class="literal">bzip</code> algorithm to reduce the size of the archive.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec250"/>There's more...</h2></div></div></div><p>In order to create an incremental backup that will be completed more quickly and use less disk space, create a <code class="literal">dump</code> of a level other than 0.</p><div><div><div><div><h3 class="title"><a id="ch07lvl3sec86"/>Creating an incremental backup archive</h3></div></div></div><p>A <code class="literal">dump</code> archive of another level will <a id="id529" class="indexterm"/>contain only the files that were modified since the most recent dump of a lower level was performed. Follow the same steps that were given in the preceding section to create an incremental backup, but change the <strong>Dump level</strong> parameter to a different value and make sure that the filename (or tape label) reflects that this archive contains a backup of this level. Remember that you will need the most recent archives of all levels, down to level 0, to restore all backed up files.</p></div><div><div><div><div><h3 class="title"><a id="ch07lvl3sec87"/>Restoring data from a backup archive</h3></div></div></div><p>To restore a<a id="id530" class="indexterm"/> backup <a id="id531" class="indexterm"/>from a <code class="literal">dump</code> archive, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>System</strong> | <strong>Filesystem Backup</strong>.</li><li class="listitem">If you are presented with the option of the type of filesystem to restore, select the type of filesystem you backed up, for example, <strong>EXT4</strong>.</li><li class="listitem">Click the <strong>Restore backup of filesystem</strong> button.</li><li class="listitem">Set <strong>Restore from file or device</strong> to <strong>File or tape device</strong> and use the file chooser (the <strong>...</strong> button) to locate the backup archive you would like to restore.</li><li class="listitem">Set <strong>Restore to directory</strong> to the location of the mount point which was backed up, for example, <code class="literal">/</code> for the root mount point, <code class="literal">/home/</code>, and so on.<div><div><h3 class="title"><a id="tip70"/>Tip</h3><p>You do not have to enter the original path as the restore destination. You can enter another path to extract the backup to a different location.</p></div></div></li><li class="listitem">Set <strong>Files to restore</strong> to <strong>Everything in backup</strong>.</li><li class="listitem">Set <strong>Only show files in backup?</strong> to <strong>No</strong>.</li><li class="listitem">Click the <strong>Restore Backup Now</strong> button.<div><div><h3 class="title"><a id="tip70_a"/>Tip</h3><p>You can check what files are contained in the backup archive by choosing the <strong>Only show files in backup?</strong> option.</p><p>If you would like to restore only a few files or directories, set <strong>Files to restore</strong> to <strong>Listed files</strong> and enter a list of pathnames separated by spaces.</p></div></div></li></ol></div></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec251"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Take a look at the <em>Backing up to a remote host</em> and <em>Setting up automatic backups</em> recipes of this chapter for more information about backing up files on your system.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec79"/>Backing up to a remote host</h1></div></div></div><p>Storing backup archives locally on the same machine will not protect you from hardware failure or malicious attack. When the machine goes down, backups will go down with it. For this reason, backups should be stored remotely on another server.</p><p>The easiest way to back up to a <a id="id532" class="indexterm"/>remote host is to use a network file sharing protocol such as NFS or CIFS. You start by creating a network volume on the remote server and then mount the volume on your server. Now, you can back up to the files on the remote system just as easily as if they were stored locally. Take a look at <a class="link" href="ch06.html" title="Chapter 6. Managing Files on Your System">Chapter 6</a>, <em>Managing Files on Your System</em>, for instructions on setting up network file sharing using NFS or CIFS.</p><p>If you have only SSH access to the remote host or want to back up to a remote magnetic tape device, you can follow the steps outlined in this recipe. We'll demonstrate how Webmin helps you set up either <code class="literal">tar</code> or <code class="literal">dump</code> to create remote backups over SSH.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec252"/>Getting ready</h2></div></div></div><p>The <code class="literal">root</code> user of our server will need to access the remote server over SSH without entering a password. Instead of a password, SSH will use a key; so, we'll need to instruct the remote server to accept it.</p><p>Let's start by locating the public RSA key of our server's <code class="literal">root</code> user. The key is stored in a file named <code class="literal">/root/.ssh/id_rsa.pub</code> by default.</p><p>If this file does not exist, you may need to create a SSH public and private key pair for the <code class="literal">root</code> user of your server. This can be done by entering the following command at the terminal, but by substituting <code class="literal">root@my_server</code> with the e-mail of your server's root user:</p><div><pre class="programlisting">
<strong># ssh-keygen -P "" -f "/root/.ssh/id_rsa"-t rsa -C "root@my_server"</strong>
</pre></div><p>The next step is to instruct the remote server to accept SSH connections using this key. Let's say that we are going to log in as a user called <code class="literal">backups</code> on the remote server. We would need to append the content of the <code class="literal">/root/.ssh/id_rsa.pub</code> file from our local server to the end of the <code class="literal">/home/backups/.ssh/authorized_keys</code> file in the home directory of the user on the remote server.</p><div><div><h3 class="title"><a id="note41"/>Note</h3><p>Connections made using any of the keys placed in a file named <code class="literal">~/.ssh/authorized_keys</code> in a users' home directory are treated as legitimate, authorized connections.</p></div></div><p>When this is done, the <code class="literal">root</code> user of our server should be able to log in over SSH to the remote server as the user, <code class="literal">backups</code>, without providing a password.</p><p>The final step is to <a id="id533" class="indexterm"/>make sure that the <code class="literal">rmt</code> command is installed on the remote host while also noting the path to the <code class="literal">rmt</code> binary. You can check for this by running the command, <code class="literal">which rmt</code> as <code class="literal">root</code>. If the command is not found, install the <code class="literal">rmt</code> or <code class="literal">tar</code> package on the remote host.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec253"/>How to do it...</h2></div></div></div><p>You can convert any filesystem backup task created in Webmin into a remote backup. Start by creating a backup task as described in the <em>Creating a backup of a selected directory</em> or <em>Creating a backup of an entire mount point</em> recipes of this chapter. Perform the following steps to back up to a remote host:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>System</strong> | <strong>Filesystem Backup</strong>.</li><li class="listitem">Click a link in the <strong>Directory to backup</strong> column for the backup that you would like to modify.</li><li class="listitem">Switch the <strong>Backup to</strong> option to <strong>Host</strong> and enter the IP address or domain name of the remote host, followed by the name of the user and the path to the backup file on the remote server.</li><li class="listitem">Set <strong>Remote backup command</strong> to <strong>SSH</strong>:<div><img src="img/5849_07_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Open the <strong>Backup options</strong> section.</li><li class="listitem">If you're modifying a <code class="literal">TAR</code> backup job, set the <strong>Path to rmt on remote system</strong> to the path where the <code class="literal">rmt</code> binary is located on the remote server.</li><li class="listitem">Click the <strong>Save and Backup Now</strong> button.</li></ol></div><p>The backup job will run and an archive containing the backup will be created in the location specified on the remote server.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec254"/>How it works...</h2></div></div></div><p>Modern versions of <a id="id534" class="indexterm"/>both the <code class="literal">tar</code> and <code class="literal">dump</code> commands are able to use the SSH protocol to transfer backup archives securely over the Internet to a remote destination backup server. Webmin assists you by setting the slightly complex set of options needed to run <code class="literal">tar</code> or <code class="literal">dump</code> over SSH.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec80"/>Setting up automatic backups</h1></div></div></div><p>Backups should be performed on a <a id="id535" class="indexterm"/>regular schedule. You can use cron to automate this process and run backup tasks at specified times. Webmin's backup facility makes this very simple.</p><div><div><div><div><h2 class="title"><a id="ch07lvl2sec255"/>How to do it...</h2></div></div></div><p>You can convert any filesystem backup task created in Webmin into an automatic backup. Start by creating a backup task as described in <em>Creating a backup of a selected directory</em> or <em>Creating a backup of an entire mount point</em> recipes of this chapter. Perform the following steps to set up automatic backups:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>System</strong> | <strong>Filesystem Backup</strong>.</li><li class="listitem">Click a link in the <strong>Directory to backup</strong> column for the backup you would like to modify.</li><li class="listitem">Open the <strong>Backup schedule</strong> section.</li><li class="listitem">Set <strong>Scheduled backup enabled?</strong> to <strong>Enabled, at times chosen below</strong>.<div><div><h3 class="title"><a id="tip71"/>Tip</h3><p>If you have a series of backups that you would like to run together, Webmin allows you to schedule a backup to run after another backup completes.</p></div></div></li><li class="listitem">Select <strong>Simple schedule</strong> and <strong>Weekly (on Sunday)</strong>.<div><div><h3 class="title"><a id="tip72"/>Tip</h3><p>Choose a more complex schedule—if you require one—by marking the minutes, hours, and days of the month at which the job is to be performed.</p></div></div></li><li class="listitem">Set <strong>Email scheduled output</strong> to your e-mail address.</li><li class="listitem">Click the <strong>Save</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec256"/>How it works...</h2></div></div></div><p>Webmin adds an entry, <a id="id536" class="indexterm"/>which starts the backup job to the cron table of your system's <code class="literal">root</code> user. Whenever cron<a id="id537" class="indexterm"/> is running during the scheduled time, the backup job will be started. When the backup task is completed, you should receive a message with information about the success or failure of the job.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch07lvl1sec81"/>Backing up databases</h1></div></div></div><p>Webmin can help you set up a <a id="id538" class="indexterm"/>schedule to perform automatic backups of all databases hosted on your system. Webmin will dump the databases as SQL files into a directory on your local filesystem or locally mounted remote network volume.</p><div><div><h3 class="title"><a id="tip73"/>Tip</h3><p>You can make backups of databases to a local directory and back that directory up to a remote server. You can also instruct Webmin to run a command that will remove old local backups after transferring them to a remote location.</p></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec257"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Depending on the database system you're using, click either the <strong>MySQL Database Server</strong> or <strong>PostgreSQL Database Server</strong> link in the <strong>Servers</strong> section of Webmin's main menu.</li><li class="listitem">Click the <strong>Backup Databases</strong> button.</li><li class="listitem">In the <strong>Backup to directory</strong> field, enter a directory where the database backups will be created, for instance, <code class="literal">/backups/databases</code>.</li><li class="listitem">Set <strong>Create destination directory?</strong> to <strong>Yes</strong>. Webmin will create a directory with the appropriate owner and permissions for the database system to write output there.</li><li class="listitem">In the <strong>Backup schedule</strong> section, set <strong>Scheduled backup enabled?</strong> to <strong>Yes, at times chosen below</strong>.</li><li class="listitem">Enter your e-mail address in the <strong>Send backup status email to</strong> field.</li><li class="listitem">Set <strong>Send email for</strong> to <strong>All backups</strong>.<div><div><h3 class="title"><a id="tip74"/>Tip</h3><p>After you receive a <a id="id539" class="indexterm"/>few e-mails to confirm that backups are working as expected, you can come back and switch this option to <strong>Only when an error occurs</strong>.</p></div></div></li><li class="listitem">Choose <strong>Simple schedule</strong> and select <strong>Daily (at midnight)</strong>.<div><div><h3 class="title"><a id="tip75"/>Tip</h3><p>Choose a more complex schedule—if you require one—by marking the minutes, hours, and days of the month at which the job is to be performed.</p></div></div><div><img src="img/5849_07_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Save</strong> button.<div><div><h3 class="title"><a id="tip76"/>Tip</h3><p>You can click the <strong>Backup Now</strong> button to save the databases to SQL files immediately.</p></div></div></li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec258"/>How it works...</h2></div></div></div><p>Webmin accesses<a id="id540" class="indexterm"/> your database system and creates an SQL dump file for each database on your server. The database files are stored on the disk in the specified directory. When you set up a schedule for automatic backups, Webmin adds a job to the <code class="literal">root</code> user's cron table to create the backups at specified times. When a backup task is completed, Webmin sends an e-mail to the address specified, but we set it to only send e-mails in the event of problems to avoid spamming you unnecessarily.</p></div><div><div><div><div><h2 class="title"><a id="ch07lvl2sec259"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Take a look at <a class="link" href="ch09.html" title="Chapter 9. Running a MySQL Database Server">Chapter 9</a>, <em>Running a MySQL Database Server</em>, and <a class="link" href="ch10.html" title="Chapter 10. Running a PostgreSQL Database Server">Chapter 10</a>, <em>Running a PostgreSQL Database Server</em>, for more information about running a database server with the assistance of Webmin.</li></ul></div></div></div></body></html>