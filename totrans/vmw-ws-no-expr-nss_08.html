<html><head></head><body><div class="chapter" title="Chapter&#xA0;8.&#xA0;Cloning and Snapshots"><div class="titlepage"><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Cloning and Snapshots</h1></div></div></div><p>In a test environment, it is often necessary to deploy virtual machines rapidly and to revert to a previous state in an easy way. VMware Workstation provides all the tools that are required for this purpose. In this chapter, you'll learn to work with cloning and snapshot tools that enable you to perform these tasks.</p><div class="section" title="Understanding when to apply which tools"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec41"/>Understanding when to apply which tools</h1></div></div></div><p>A <span class="strong"><strong>snapshot</strong></span> <a id="id261" class="indexterm"/>is a photo of a state of a virtual machine. As a virtual machine often requires a lot of work before a desired state of the machine is reached, it is a good idea to take a picture of that exact state. If something goes wrong at a later stage, having a snapshot makes it possible to easily revert to the previous state of the virtual machine. So the base concept of working with snapshots is to make it easier to revert to a previous state.</p><p>A <span class="strong"><strong>clone</strong></span> <a id="id262" class="indexterm"/>is a copy of a virtual machine. Using clones is convenient if several virtual machines are needed, with more or less the same configuration on each virtual machine. By cloning a virtual machine, you'll make a copy of the actual state of a machine. After making the clone, you'll just have to modify the properties of the virtual machine that need to be unique on that machine.</p><p>In some ways, clones and snapshots are closely related. This is because you can create a clone of a snapshot of a virtual machine, but you can also clone the current state of a virtual machine, which in fact creates a snapshot of the virtual machine. To understand this, you need to understand the difference between a linked clone and a full clone.</p><p>In a <a id="id263" class="indexterm"/>
<span class="strong"><strong>linked clone</strong></span>, only modifications are stored. This means that if something happens to the original state of the virtual machine (for example, the VM files get corrupted), the linked clone gets corrupted as well. It is, however, an approach that is very efficient with regard to available disk space. As only modifications are stored in a linked clone, the disk space requirement is minimal. Creating a linked clone is also a very fast process.</p><p>A <span class="strong"><strong>full clone</strong></span><a id="id264" class="indexterm"/> is like a complete copy of a virtual machine. Creating a full clone is a much longer process as the entire virtual machine disk has to be copied over. It requires more disk space as well, but the benefit is that a full clone creates an independent virtual machine. Therefore, you're better off with full clones if you need a maximum amount of flexibility. In the following sections, you'll learn how to work with snapshots and clones.</p></div></div>
<div class="section" title="Working with snapshots"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec42"/>Working with snapshots</h1></div></div></div><p>In this section, you'll learn<a id="id265" class="indexterm"/> how to create snapshots of virtual machines. You'll also learn how to use the Snapshot Manager to manage a setup where different snapshots are used.</p><div class="section" title="Creating snapshots"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec46"/>Creating snapshots</h2></div></div></div><p>To create a <a id="id266" class="indexterm"/>snapshot, you don't have to do anything with the virtual machine. You can create a snapshot irrespective of the actual state of the virtual machine, so it doesn't matter if it is currently active or not. If the machine is powered on, the current state of the virtual machine memory is included in the snapshot as well. This is a useful feature as it allows you to return to the exact state the machine was in while taking the snapshot.</p><p>To create a snapshot of a virtual machine, select the virtual machine first. Then from the VM menu, navigate to <span class="strong"><strong>Snapshot</strong></span> | <span class="strong"><strong>Take snapshot</strong></span>. Here you are presented with a small dialog box where you can enter a short description of the snapshot. You should always enter some description as it may be clear now what the snapshot is being used for, but you probably won't know it anymore if you have a look at the virtual machine a few months later. Also, having a clear description for a snapshot makes it easier to identify the right snapshot in the Snapshot Manager.</p><div class="mediaobject"><img src="graphics/9182EN_08_01.jpg" alt="Creating snapshots"/><div class="caption"><p>To make identifying the snapshot easier at a later stage, enter a clear description of what it is being used for</p></div></div><p>Once the snapshot process has started, it will take a while to complete. You will see a progress bar in the lower-left part of the virtual machine window if it has been activated. In theory, you can just continue working in the virtual machine; in practice, you'll notice that it is slow and sometimes even very unresponsive. It's better to wait a while and give the snapshot process a few minutes to complete.</p><p>The actual files of the<a id="id267" class="indexterm"/> snapshots will be created in the directory where the VMDK files of the virtual machine are stored. For each VMDK file, you'll find a snapshot file as well. You'll notice that the snapshot file is smaller as it only contains the modifications that were made since the last snapshot was taken; or if this is the first snapshot you have taken, it will contain the differences from the original virtual machine.</p><div class="mediaobject"><img src="graphics/9182EN_08_02.jpg" alt="Creating snapshots"/><div class="caption"><p>For each VMDK file, a corresponding snapshot file is created</p></div></div></div><div class="section" title="Reverting a snapshot"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec47"/>Reverting a snapshot</h2></div></div></div><p>The goal of <a id="id268" class="indexterm"/>creating a snapshot is that at any moment you can easily revert to the previous state of a virtual machine. The easiest way to do this is using the <span class="strong"><strong>Revert to snapshot state</strong></span> option that you can find at <span class="strong"><strong>VM</strong></span> | <span class="strong"><strong>Snapshot</strong></span>. This option allows you to easily get back to the last snapshot that you have created on a virtual machine. Reverting to a previous snapshot resets the virtual machine to its previous state, and you'll know for sure that all changes that have been made since have been lost. Also, while reverting to the state prior to the snapshot, you will be unable to use the virtual machine and hence lose connection. A much more sophisticated method to revert to a previous state is using the Snapshot Manager.</p></div><div class="section" title="Using autoprotect snapshots"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec48"/>Using autoprotect snapshots</h2></div></div></div><p>A special kind of snapshot is the <a id="id269" class="indexterm"/>
<span class="strong"><strong>autoprotect snapshot</strong></span>. This is a snapshot that is created automatically every day. If you want to use autoprotect snapshots, you'll have to enable them for each virtual machine that you want to use them on. This doesn't happen automatically because you need disk space to store the autoprotect snapshots. Using autoprotect costs a minimum of 3 GB for every virtual machine.</p><p>To enable<a id="id270" class="indexterm"/> autoprotect, apply the following procedure:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Select the virtual machine that you want to use autoprotect for.</li><li class="listitem">From the VM menu, open the <span class="strong"><strong>Settings</strong></span> item and click on the <span class="strong"><strong>Options</strong></span> tab.</li><li class="listitem">On the <span class="strong"><strong>Options</strong></span> tab, select <span class="strong"><strong>Enable AutoProtect</strong></span> and specify how you want to use it.<div class="mediaobject"><img src="graphics/9182EN_08_03.jpg" alt="Using autoprotect snapshots"/><div class="caption"><p>With autoprotect, you'll enable a sort of automatic backup schedule</p></div></div></li></ol></div><p>When using autoprotect snapshots, it is important to realize that autoprotect doesn't just create one snapshot everyday and keep that around for a couple of days. By default, autoprotect creates a snapshot everyday, and it keeps three different autoprotect snapshots: one that allows you to go back one day, another one that allows you to go back one week, and a third that allows you to go back one month. It is possible to have autoprotect create more than just three backups, but you'll need to make sure that you have the required amount of disk space to store all these snapshots.</p></div><div class="section" title="Snapshots and powering off"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec49"/>Snapshots and powering off</h2></div></div></div><p>Using autoprotect snapshots helps you create an automated backup solution for your virtual machine. Another way of creating snapshots automatically is using the option to create a snapshot when a virtual machine is powered down. On the <span class="strong"><strong>Options</strong></span> tab of the <span class="strong"><strong>Virtual Machine Settings</strong></span> window, you can find the <span class="strong"><strong>Snapshot</strong></span> option. This option allows you to use the<a id="id271" class="indexterm"/> following options:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Just power off</strong></span>: This option will do nothing and just power off the virtual machine.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Take a new snapshot</strong></span>: Use this option if you automatically want to take a snapshot of a virtual machine every time you power it off.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Revert to snapshot</strong></span>: Use this option if you never want to keep the modifications that have been applied to a virtual machine. Using this option is very useful in educational environments where you want a virtual machine to be started in a clean state at the start of each class.</li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Ask me</strong></span>: This option asks the user if a snapshot must be taken or if a reversion to the last state of the virtual machine has to be done.<div class="mediaobject"><img src="graphics/9182EN_08_04.jpg" alt="Snapshots and powering off"/><div class="caption"><p>When powering off the virtual machine, you can automatically either revert to a previous snapshot or take a new snapshot</p></div></div></li></ul></div></div><div class="section" title="Working with the Snapshot Manager"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec50"/>Working with the Snapshot Manager</h2></div></div></div><p>The Snapshot Manager <a id="id272" class="indexterm"/>allows you to work with snapshots in the most flexible way. You can use it to revert to any virtual machine state, start from there, and build a completely different configuration so that you can create two development branches based on a specific snapshot state and decide which solution fits you best.</p><p>You can find the Snapshot Manager by opening the virtual machine you want to manage and navigating to <span class="strong"><strong>VM</strong></span> | <span class="strong"><strong>Snapshot</strong></span> | <span class="strong"><strong>Snapshot Manager</strong></span>. You'll now see the Snapshot Manager with all the snapshots that have been created for this virtual machine.</p><div class="mediaobject"><img src="graphics/9182EN_08_05.jpg" alt="Working with the Snapshot Manager"/><div class="caption"><p>The Snapshot Manager allows you to revert to any state of a virtual machine</p></div></div><p>Working with snapshots from the Snapshot Manager<a id="id273" class="indexterm"/> is not hard to do at all. You'll just select the snapshot that you want to start from and restore it (irrespective of whether there are snapshots that have already been created based on the selected snapshot). Once restored, you can continue working on the virtual machine from the selected snapshot state.</p><p>By default, in the Snapshot Manager you don't see autoprotect snapshots. Even if the Snapshot Manager shows an option that displays autoprotect snapshots as well, it is probably not a good idea to do that. You'll typically use the snapshots in Snapshot Manager to walk back a clearly defined path in the snapshots on your system. In autoprotect, there isn't really a plan, and even more importantly, the snapshots are removed automatically. Therefore, you should make sure to never create a snapshot that is based on an autoprotect snapshot.</p></div></div>
<div class="section" title="Creating clones"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec43"/>Creating clones</h1></div></div></div><p>A snapshot is a virtual machine that is in a specific state. When working with snapshots, there will still be one virtual machine that can easily be restored to a specific state. The major difference between a clone and a snapshot is that a clone is a new virtual machine that is independent of the original virtual machine. Even if there is some relation between a snapshot and a clone (for instance, you can create a clone based on a snapshot), a clone basically is a new virtual machine. This means that once you have created a clone of a virtual machine, you can even start creating new snapshots of that virtual machine.</p><p>When creating <a id="id274" class="indexterm"/>clones, you really need to think well about what you want to use them for. If you just want to use them for your own convenience, a linked clone is the best solution. It can be created very fast, and it takes the least possible amount of disk space while it still offers full functionality. The major difference though is that you'll never be able to copy it as an independent virtual machine to another computer. If you need to do that, you'll need a full clone.</p><p>There are different ways to create clones. No matter which method you use, you will have to make sure that the virtual machine is shut down before you can make the clone. This requirement exists because the virtual machine files cannot be modified while the cloning is in process. The most important reason for this is that VMware Workstation is used on a Linux host or Windows platform where filesystems are used that do not allow virtual machine files to be modified by different processes at the same time. You'll need a VMFS filesystem in a VMware ESXi environment if you want to be able to clone a virtual machine without shutting it down first.</p><p>The most direct way of creating a clone is by using the <span class="strong"><strong>Manage</strong></span> option in the VM menu. From this menu, select the <span class="strong"><strong>Clone</strong></span> option to start the Clone wizard. The first step of the clone wizard asks where you want to create the clone from. This can either be from the actual state of the virtual machine or from a snapshot, if it has been created. If no fit snapshot exists, the wizard will show an error, indicating that it's not possible to create a clone based on a snapshot for the selected virtual machine.</p><div class="mediaobject"><img src="graphics/9182EN_08_06.jpg" alt="Creating clones"/><div class="caption"><p>Selecting on the basis of what you want to clone</p></div></div><p>After selecting what you want to create the clone on, you'll need to select between either a linked clone or a full clone. You have to realize that a full clone is a complete copy of a virtual machine, so you'll need the same amount of disk space that is used by the virtual machine as available disk space on the host computer. So if the virtual machine uses 60 gigabytes of disk space, you'll need at least 60 gigabytes of disk space on the host as well!</p><p>After verifying<a id="id275" class="indexterm"/> that you have the required amount of free disk space, you can start the cloning process. In the last step of the wizard, specify the name that you want to assign to the clone as well as the location on the host operating system where the clone has to be stored. Once created, the clone will show in the VMware console as a new virtual machine, and that is also how it is to be considered.</p><div class="mediaobject"><img src="graphics/9182EN_08_07.jpg" alt="Creating clones"/><div class="caption"><p>A cloned virtual machine appears as a completely new virtual machine in the VMware Workstation library</p></div></div><p>Another way of creating clones is using the Snapshot Manager. The advantage is that using Snapshot Manager, you can easily select a snapshot that you want to create a clone of. Just select the snapshot state you want to use and click on the <span class="strong"><strong>Clone</strong></span> button.</p><div class="section" title="Preparing virtual machines before cloning"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec51"/>Preparing virtual machines before cloning</h2></div></div></div><p>If you're creating <a id="id276" class="indexterm"/>clones of Linux virtual machines, the procedure is rather easy. You just have to start the cloning process; once the process has been completed, there are a few items that need to be changed. You can just change these one by one. Typically, on a Linux virtual machine you need to be sure to change the following to create a new identity for the cloned virtual machine:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The hostname</li><li class="listitem" style="list-style-type: disc">The IP address</li><li class="listitem" style="list-style-type: disc">The entry for this host in <code class="literal">/etc/hosts</code></li></ul></div><p>After changing these, you will need to restart the virtual machine to make sure it picks up on the new identity.</p><p>On Windows, changing the identity of a virtual machine is more complicated. The main reason for this is that the Windows license is bound to the identity of a Windows virtual machine. To make sure that you'll be compliant with the Windows license that you've purchased, you should generate a new identity and enter a new license code for it. The most versatile way to do this is to use <a id="id277" class="indexterm"/>
<span class="strong"><strong>Sysprep</strong></span>; it resets Windows to the state it was in when it was started for the first time. In the following section, you can read how to use Sysprep on Windows to create a template of your Windows virtual machine.</p></div><div class="section" title="Using Sysprep on Windows to create a template"><div class="titlepage"><div><div><h2 class="title"><a id="ch08lvl2sec52"/>Using Sysprep on Windows to create a template</h2></div></div></div><p>On Windows, the <a id="id278" class="indexterm"/>procedure is much more complicated as the<a id="id279" class="indexterm"/> identity of a Windows machine is not just in <a id="id280" class="indexterm"/>a few configuration files; it is all over the Windows virtual machine. That is why Microsoft has created Sysprep, a tool that allows you to create a base image of a virtual machine. You'll typically find this tool in any Windows installation under the location, <code class="literal">c:\Windows\System32\sysprep</code>.</p><p>You generally don't want to run Sysprep on a virtual machine that already has lots of things installed. The aim of Sysprep is to create a template of a new virtual machine; this makes it easier to deploy new virtual machines based on the Sysprep template.</p><p>After installing the Windows virtual machine that has a basic configuration, start the Sysprep tool and make sure you select the <span class="strong"><strong>Enter System Out of Box Experience</strong></span> option. This puts your Windows installation in a mode where all personalized information is removed, and Windows<a id="id281" class="indexterm"/> behaves as if it has been started for the first time. Also make sure to select <span class="strong"><strong>Shutdown</strong></span> as<a id="id282" class="indexterm"/> the shutdown mode (you want the virtual<a id="id283" class="indexterm"/> machine to be shut down after the completion of the Sysprep procedure) and select the <span class="strong"><strong>Generalize</strong></span> option.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>Make sure to select <span class="strong"><strong>Shutdown</strong></span> as the default shutdown mode. By default, <span class="strong"><strong>Restart</strong></span> is selected. Using this mode, you can restart the virtual machine, and once it restarts, the reconfiguration will be started automatically. This is not what you need, because the purpose of sysprepping a virtual machine is to remove all the specific configuration from it.</p></div></div><div class="mediaobject"><img src="graphics/9182EN_08_08.jpg" alt="Using Sysprep on Windows to create a template"/><div class="caption"><p>Before cloning Windows, you should run the Sysprep tool</p></div></div><p>Once the virtual machine has been sysprepped, open the <span class="strong"><strong>Settings</strong></span> window for the virtual machine from the VM menu, click on the <span class="strong"><strong>Options</strong></span> tab, and on that tab, click on <span class="strong"><strong>Advanced</strong></span>. From here, navigate to <span class="strong"><strong>Settings</strong></span> | <span class="strong"><strong>Enable Template</strong></span> and click on <span class="strong"><strong>OK</strong></span>.</p><div class="mediaobject"><img src="graphics/9182EN_08_09.jpg" alt="Using Sysprep on Windows to create a template"/><div class="caption"><p>On a sysprepped virtual machine, you should enable the template mode</p></div></div><p>After setting the<a id="id284" class="indexterm"/> template mode, you'll first have to<a id="id285" class="indexterm"/> create a snapshot of the virtual machine. Once <a id="id286" class="indexterm"/>you've done that, you can clone the virtual machine. In the clone wizard, make sure to select the option to create a clone based on a snapshot—you'll notice that this is the only available option anyway because the virtual machine is in the template mode.</p><div class="mediaobject"><img src="graphics/9182EN_08_10.jpg" alt="Using Sysprep on Windows to create a template"/><div class="caption"><p>In the template mode, you can only clone a snapshot and not the current state</p></div></div><p>In the remainder of the process, you can choose whichever option you want to use—they are not really important for the cloning process to complete. When you start the virtual machine again, it will start in the same way a Windows instance starts on a new computer. This means that you'll need to enter the license information first and then provide all the other details required to configure the virtual machine.</p></div></div>
<div class="section" title="Backups in a virtual environment"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec44"/>Backups in a virtual environment</h1></div></div></div><p>In this chapter, you've<a id="id287" class="indexterm"/> learned how to use snapshots and clones. Because of<a id="id288" class="indexterm"/> these features, you don't really need backups in a traditional way (in which a backup program is scheduled to copy files from a filesystem to an offline medium) anymore. If you enable a feature such as autoprotect snapshots, a backup is created automatically every day. There are a few things to consider however, before thinking that you're completely secure when using features such as clones and backups. The most important considerations are listed as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">No matter how good your cloning and snapshot strategy is, as long as they are on the same disk as the original virtual machine files, you can hardly consider these virtual machines fully protected. In a good backup scheme, files need to be copied to another medium, and if possible, even to another site.</li><li class="listitem" style="list-style-type: disc">A clone is just a copy of a virtual machine. The longer back that the clone was created, the less you can consider it a decent backup of a virtual machine. Clones are useful to make working with virtual machines easier, but you should not consider them backups.</li><li class="listitem" style="list-style-type: disc">An autoprotect snapshot is what comes closest to a real backup. It at least protects you from errors within the virtual machine. But still, you need access to the original virtual machine files.</li></ul></div></div>
<div class="section" title="Summary"><div class="titlepage"><div><div><h1 class="title"><a id="ch08lvl1sec45"/>Summary</h1></div></div></div><p>In this chapter, you learned how to work with snapshots and clones in a versatile test environment. Using these techniques makes it possible to easily deploy new virtual machines and save the current state of virtual machines. You have also read about how to change the identity of virtual machines after cloning, and how to handle the cloning process in the case of Windows where the actual state of the virtual machine is closely related to the license that you have acquired for Windows.</p><p>In the next and last chapter of this book, you'll learn how to use VMware Workstation as a tool to enable the sharing of virtual machines with others in a cloud environment.</p></div></body></html>