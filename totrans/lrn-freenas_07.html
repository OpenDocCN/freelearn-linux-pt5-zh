<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch08"/>Chapter 8. Advanced System Configuration</h1></div></div></div><p>If you have followed everything in this book until now, you are almost an expert in all things FreeNAS. There are just a few more things to learn and your training will be complete. This chapter looks at Advanced System Configuration like disk encryption, adding a swap space, and tweaking FreeBSD.</p><div><div><div><div><h1 class="title"><a id="ch08lvl1sec01"/>Disk Encryption</h1></div></div></div><p>If the data you are storing on your FreeNAS server is of a sensitive nature (for example military, medical, financial or other confidential data) then it is worth considering using encryption to protect your data should the server fall into the wrong hands.<a id="id282" class="indexterm"/>
</p><p>If security is a top priority for you, then encrypting the data on the disk is only one of several measures you should take to safe guard your data. For example if your building or the people in your building (for example employees) aren't subject to stringent security measures then having your hard disk encrypted is of minimal value. Someone (from within or without) could access your data over the network and copy the sensitive data and then email it to almost anywhere. Having your hard disk encrypted won't stop that from happening.</p><p>FreeNAS offers the ability to encrypt an entire disk with a strong level of encryption. If the server should be stolen, then the perpetrators will have a tough time accessing the data on the disk.</p><p>Normally, to add a new disk to your FreeNAS server you need to:<a id="id283" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem"><p>1. Add the disk in<strong> Disks: Add</strong>.</p></li><li class="listitem"><p>2. Format the disk in<strong> Disks: Format</strong>.</p></li><li class="listitem"><p>3. Add a mount point in<strong> Disks: Mount Point</strong>.</p></li></ol></div><p>To add a new encrypted disk, almost the same procedure is used except that there is a new step to create an encrypted volume between step 1 and step 2. The new sequence of events becomes:<a id="id284" class="indexterm"/>
</p><div><ol class="orderedlist"><li class="listitem"><p>1. Add the disk in<strong> Disks: Add</strong>.</p></li><li class="listitem"><p>2. Create an encrypted volume using the previously added disk in<strong> Disks: Encryption</strong>.</p></li><li class="listitem"><p>3. Format the disk in<strong> Disks: Format</strong>.</p></li><li class="listitem"><p>4. Add a mount point in<strong> Disks: Mount Point</strong>.</p></li></ol></div><p>Notice that the creation of the encrypted volumes occurs before the disk is formatted. This is because the encryption used by FreeNAS is at a very low level. It is not file-based (meaning that each file is individually encrypted) but rather it is sector-based, which means that each piece of information that is written to the hard disk (including directory names etc) is encrypted.</p><div><h3 class="title"><a id="tip59"/>Note</h3><p><strong>Do You Really Need Encryption?</strong></p><p>Encrypting your data actually increases the chances of data loss. Your data is actually more likely to be lost to encryption misconfiguration or lost keys than to theft. <strong>There is no password recovery system for an encrypted hard drive</strong>. If the password is lost, misplaced, forgotten or the holder becomes unavailable then the data is in actuality lost.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec01"/>Encrypting a Disk in FreeNAS</h2></div></div></div><p>If you are encrypting a disk that has previously had data on it, it is important to completely erase all the old data before using the disk for encryption. This is because when the disk is initialized for encryption, the old data is not physically overwritten and as such, this old data would still be accessible at the sector level of the hard disk should the disk be stolen and analyzed. Unfortunately, FreeNAS doesn't provide a way to do this and you will need to remove the disk from the FreeNAS server and security wipe it in another machine.<a id="id285" class="indexterm"/>
</p><p>To encrypt a disk, first of all, make sure it has been added to the system using the<strong> Disks: Add page</strong>. Then, go to<strong> Disks: Encryption</strong>.</p><p>Click on the add circle to add a new encrypted disk. There are four parameters for adding an encrypted disk:<a id="id286" class="indexterm"/>
</p><div><ul class="itemizedlist"><li class="listitem"><p>
<strong>Disk—</strong> Select the disk you want to encrypt. It has to be a whole disk and can not be a partition of a disk. This means that you can't encrypt the second partition of a disk where you have installed FreeNAS on the first partition. Also, the disk must have been previously added in<strong> Disks: Add</strong>.</p></li><li class="listitem"><p>
<strong>Encryption algorithm—</strong> You can choose between three different encryption algorithms with which to encrypt your data. If you are unsure, stick with AES as it is the standard encryption method used by the U.S. government, it has been analyzed extensively and is now used worldwide.</p></li><li class="listitem"><p>
<strong>Passphrase—</strong> The password. Whenever the disk is mounted on the FreeNAS server (generally after a reboot), then the password needs to be entered to unlock the encrypted drive. Using a good, solid password is essential for the disk encryption to be worthwhile. Don't use your birthday or your daughter's name!</p></li><li class="listitem"><p>
<strong>Initialize—</strong> If this disk has never been used as an encrypted disk before, it needs to be initialized and made ready for the encryption process. You need to tick this box unless this is a previously a encrypted disk that you are adding back into the FreeNAS server.<a id="id287" class="indexterm"/>
</p></li></ul></div><div><h3 class="title"><a id="note39"/>Note</h3><p>Initializing the disk will cause all data to be lost on this disk.</p></div><p>Having selected the disk from the drop down box as well as picking an algorithm, you need to enter a good unguessable password and tick the<strong> initialize</strong> box. Now click<strong> Add</strong>. The disk will now be prepared and encrypted. The output will look something like this:</p><div><pre class="programlisting">Encrypting '/dev/ad1'... Please wait!
Calculating number of iterations...
Done, using 38638 iterations.
Metadata value stored on /dev/ad1.
Done.
Attaching provider '/dev/ad1'.
Attached to /dev/ad1.
Done.
</pre></div><p>The reassuring<strong> Done</strong>. lets you know that all went well. It is always best to double check the output for any errors.</p><p>Now that the disk has been set up for encryption, it can be used just like any other disk. You can format it or mount it and also share it on the networking using CIFS, NFS, and AFP etc.<a id="id288" class="indexterm"/>
</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec02"/>Entering the Password When You Reboot</h2></div></div></div><p>Because the volume is encrypted, it needs a password to unlock it and allow it to be accessed. Whenever the FreeNAS server is rebooted, the encrypted volume will not be accessible until you have entered the password.<a id="id289" class="indexterm"/>
</p><p>Once the system is booted, go<strong> to Disk: Mount Point</strong>. You will see an error because FreeNAS can't mount the encrypted volume without the password.</p><div><img src="img/4688_08_02.jpg" alt="Entering the Password When You Reboot"/></div><p>Now go to<strong> Disk: Encryption</strong>. The encrypted volume has the status<strong> Not attached</strong>. To enter the password, click on the<strong> Tools</strong> tab. Choose the encrypted disk from<em> Encrypted disk name</em> drop down list and select the command<strong> attach</strong> (which should be the default). Now enter the password and click on<strong> Send Command!</strong> The output should be something like this:<a id="id290" class="indexterm"/>
</p><div><pre class="programlisting">Attached to /dev/ad0.
Done.
Mounting device.
Successful.
</pre></div><p>If you mistyped the password, then the output would be something like this:</p><div><pre class="programlisting">Wrong key for ad0.
</pre></div><p>Click on the<strong> Management</strong> tab and the disk status will now be shown as<strong> Attached</strong>. Finally, go back to<strong> Disk: Mount Point</strong> and check that the mount point status is<strong> OK</strong>. If it isn't, click on<strong> Retry</strong> (which forces FreeNAS to mount the disk again) and then it should show<strong> OK</strong>.</p></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec03"/>Encryption Tools</h2></div></div></div><p>When the FreeNAS server is rebooted, the password needs to be entered to unlock the volume. To do this, you use<strong> Tools</strong> tab in<strong> Disk: Encryption</strong> (see<em> Entering the password when you reboot</em> above). Here is an overview of the other actions that can be performed on an encrypted disk.<a id="id291" class="indexterm"/>
</p><div><div><div><div><h3 class="title"><a id="ch08lvl3sec01"/>How to Unlock an Encrypted Disk—Attach and Detach</h3></div></div></div><p>Attach and detach are technical FreeBSD words for unlock and lock. Attach means that the password supplied will be used to open up the disk and set up the necessary decryption parameters. Once successfully attached, the disk is able to be used like any other hard disk.Detach is the opposite. Here, the disk is locked and the data is inaccessible without the correct password. To detach an already attached disk, choose the attached, encrypted disk from<em> Encrypted disk name</em> drop down list and select the command<strong> detach</strong> and click on<strong> Send Command!</strong>
<a id="id292" class="indexterm"/>
</p></div><div><div><div><div><h3 class="title"><a id="ch08lvl3sec02"/>How to Change the Password on an Encrypted Disk—setkey</h3></div></div></div><p>Remaining on the<strong> Tools</strong> tab in the<strong> Disk: Encryption</strong> page, you can change the password of an encrypted disk by using the setkey command. Choose the encrypted disk from<em> Encrypted disk name</em> drop down list and select the command<em> setkey</em>. Now enter the old password along with the new password and click on<strong> Send Command!</strong> The output is just a simple<strong> Done</strong>.<a id="id293" class="indexterm"/>
</p><div><h3 class="title"><a id="note40"/>Note</h3><p>You are not asked to confirm the new password. If you make a mistake in typing in the new password, all your data will be lost as you can not unlock the disk.</p></div></div><div><div><div><div><h3 class="title"><a id="ch08lvl3sec03"/>Checking the Status of an Encrypted Disk—list and status</h3></div></div></div><p>To get some simple status information about your encrypted drives, you can use the<code class="literal"> status</code> and<code class="literal"> list</code> commands.<a id="id294" class="indexterm"/>
</p><p>
<code class="literal">status</code> simply lists which drives are encrypted and in fact, might not even tell you their status! Here is an example output:<a id="id295" class="indexterm"/>
</p><div><pre class="programlisting">Name Status Components
ad0.eli N/A ad0
</pre></div><p>The list command is a bit more verbose. An example out would be:<a id="id296" class="indexterm"/>
</p><div><pre class="programlisting">Geom name: ad0.eli
EncryptionAlgorithm: AES-CBC
KeyLength: 128
Crypto: software
UsedKey: 0
Flags: NONE
Providers:
1. Name: ad0.eli
Mediasize: 10262568448 (9.6G)
Sectorsize: 512
Mode: r1w1e2
Consumers:
1. Name: ad0
Mediasize: 10262568960 (9.6G)
Sectorsize: 512
Mode: r1w1e1
</pre></div><p>The<code class="literal"> Geom name:</code> tells you the name of the encrypted disk. It will be the name of the disk device (say ad0 for the first IDE hard disk) followed by<code class="literal"> .eli</code>, in our example it was:<code class="literal"> ad0.eli</code>. The<code class="literal"> EncryptionAlgorithm:</code> tells you which algorithm is being used (which in this case was AES) and the<code class="literal"> KeyLength:</code> tells you the strength of the encryption.</p><p>The provider and consumer are the two ends of the encryption process. In FreeBSD terms, this means the physical hard disk (ad0) and the pseudo device (ad0.eli) which is the hard disk after encryption. As FreeBSD writes to the pseudo version of the hard disk, (ad0.eli) the encryption software applies its algorithms and the encrypted data is written to the real hard disk (ad0). The opposite happens during a read; the encrypted data is read from the hard disk and passed to the decryption software before being passed on higher up.<a id="id297" class="indexterm"/>
</p></div></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec02"/>Advanced Hard Drive Parameters (S.M.A.R.T)</h1></div></div></div><p>Self-Monitoring, Analysis, and Reporting Technology, or S.M.A.R.T, is a system for monitoring hard disks to report on a variety of characteristics that pertain to the reliability of the disk. Monitoring these characteristics should (in theory) help anticipate drive failures. According to Seagate, the hard disk manufacturer, mechanical failures (that are usually predictable failures) account for 60 percent of drive failure.<a id="id298" class="indexterm"/>
</p><p>Not all hard drives have S.M.A.R.T capabilities and different manufacturers measure different characteristics and define different thresholds of failure. Essentially each hard disk model defines its health according to the rules set down by its manufacturer. Therefore one model of hard disk may have a different value for a certain characteristic than another model of hard drive and yet both be defined as acceptable by the manufacturer.</p><p>The characteristics or attributes of each drive has two values: one is the raw value whose meaning is defined by the drive manufacturer. The other is a normalized value that ranges from 1 to 253 (where 1 is the worst case and 253 the best).</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec04"/>Enabling and using S.M.A.R.T of the FreeNAS</h2></div></div></div><p>Before you can use S.M.A.R.T on your FreeNAS server, you need to check if your hard disk supports S.M.A.R.T. Go to<strong> Diagnostics: Information</strong> and click on the<strong> S.M.A.R.T</strong>. tab. The output will show a list of disks (IDE, SATA, SCSI, and even flash disks) along with any S.M.A.R.T information available.<a id="id299" class="indexterm"/>
</p><p>If a particular device doesn't support S.M.A.R.T, the output will simply say:</p><div><pre class="programlisting">Device does not support SMART
</pre></div><p>If the device supports S.M.A.R.T, it will report more information about the drive including the model number. Here is an example for an aging 10GB Quantum Fireball disk:<a id="id300" class="indexterm"/>
</p><div><pre class="programlisting">Device Model: QUANTUM FIREBALLlct10 10
Serial Number: 872001057089
Firmware Version: A03.0900
User Capacity: 10,262,568,960 bytes
Device is: Not in smartctl database [for details use: -P showall]
ATA Version is: 4
ATA Standard is: ATA/ATAPI-4 T13 1153D revision 15
Local Time is: Tue Mar 18 21:22:34 2008 UTC
SMART support is: Available - device has SMART capability.
SMART support is: Disabled
</pre></div><p>The key thing to note here is that<em> SMART support is: Available—device has SMART capability</em>. But that<em> SMART support is: Disabled</em>.</p><p>To enable S.M.A.R.T monitoring for this disk, go to<strong> System: Advanced</strong> and tick the<strong> S.M.A.R.T Daemon</strong> box. This will enable the S.M.A.R.T daemon (monitoring process) and log the status to the log file.<a id="id301" class="indexterm"/>
</p><p>Now, if you return to the<strong> Diagnostics: Information</strong> page and again click on the<strong> S.M.A.R.T</strong>. tab, you will see that the output has changed significantly. The first difference is that<em> SMART support is: Enabled</em>. Below the initial summary is now a comprehensive list of different drive attributes pertaining to the reliability of the hard disk.</p><p>The first line is normally a report on the overall health of the disk. If it is healthy, it should read something like this:</p><div><pre class="programlisting">SMART overall-health self-assessment test result: PASSED
</pre></div><p>If the overall health is listed as FAILED, then you need to back up the hard disk immediately and replace it with another one.</p><p>Below the overall health check is a list of hard disk-specific information that culminates in a list of<em> Vendor Specific SMART Attributes with Thresholds</em>. This list shows each attribute along with its normalized value, the worst value that this attribute has had in the life time of the drive, and the thresholds of the value. When reading these values, you need to remember that 1 is the worst case and 253 the best. For example:</p><div><pre class="programlisting">Vendor Specific SMART Attributes with Thresholds:
ATTRIBUTE_NAME FLAG VALUE WORST THRESH RAW_VALUE
Raw_Read_Error_Rate 0x0029 100 253 020 0
Spin_Up_Time 0x0027 083 081 020 2195
Start_Stop_Count 0x0032 093 093 008 5025
Reallocated_Sector_Ct 0x0033 100 100 020 0
Seek_Error_Rate 0x000b 100 100 023 0
Power_On_Hours 0x0012 090 090 001 6675
Calibration_Retry_Count 0x0013 100 100 020 0
Power_Cycle_Count 0x0032 093 093 008 4740
Read_Soft_Error_Rate 0x000b 100 100 023 0
UDMA_CRC_Error_Count 0x001a 116 116 000 84
Reallocated_Event_Count 0x0010 100 100 020 0
Current_Pending_Sector 0x0032 100 100 020 0
Offline_Uncorrectable 0x0010 100 253 000 0
</pre></div><p>Looking at the<code class="literal"> Raw_Read_Error_Rate</code>, you can see that its normalized value is<code class="literal"> 100</code> but that the raw value is<code class="literal"> 0</code>. This means that there have been no read errors on this hard disk that the disk manufacturer has normalized to the value<code class="literal"> 100</code>. However, what is important is that the threshold is<code class="literal"> 20</code>. So IF read errors started to appear on this drive, then the normalized value would start to shrink until it reached<code class="literal"> 20</code>. At which point, the overall health of the drive would be reported as FAILED.</p><p>An attribute from a failing hard disk might look like this:</p><div><pre class="programlisting">ATTRIBUTE_NAME VALUE WORST THRESH WHEN_FAILED
Reallocated_Sector_Ct 136 136 140 FAILING_NOW
</pre></div><p>Notice here that the<code class="literal"> when_failing</code> column reports the drive in the process of failing. Looking at the normalized value, we read<code class="literal"> 136</code> and the threshold is<code class="literal"> 140</code>. Remembering that the lower the number the worse the situation, we see that this particular attribute has just recently gone passed its threshold and as such triggered the failure warnings.</p><p>On the FreeNAS server, when an attribute passes its threshold it will be reported in the SMARTD log on the<strong> Diagnostics: Logs</strong> page.</p><p>Here is a list of some key S.M.A.R.T attributes that if they pass their threshold, the disk is in a critical state:<a id="id302" class="indexterm"/>
</p><div><table border="1"><colgroup><col width="1.9371455026455" style="text-align: left"/><col width="3.28905886243386" style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Attributes</p>
</th><th style="text-align: left" valign="bottom">
<p>Meaning</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Read Error Rate</p>
</td><td style="text-align: left" valign="top">
<p>Measures the rate of read errors that occurred when reading data in the disk.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Reallocated Sectors Count</p>
</td><td style="text-align: left" valign="top">
<p>The number of reallocated sectors. When the hard drive finds a sector with an error it marks this sector as "reallocated" and transfers data to a special reserved area. If the number reallocated sectors increases too much, the disk is starting to fail.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Spin Retry Count</p>
</td><td style="text-align: left" valign="top">
<p>Number of retries of spin start attempts. This is the total number of the spin retries. An increase of this number is a sign of a mechanical problem.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Uncorrectable Sector Count</p>
</td><td style="text-align: left" valign="top">
<p>This is total number of uncorrectable errors when reading or writing to a sector. If this number starts to increase, it can mean that there is a problem with the hard disk's magnetic surface.</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec03"/>File System Consistency Check—FSCK</h1></div></div></div><p>The FreeNAS server has a tool to verify if the file system on a disk is healthy. This is different than checking the S.M.A.R.T status of the disk in that S.M.A.R.T is at the hardware level and support for it is provided by the disk manufacturer. However, FreeBSD/FreeNAS writes data to the disk in a certain order and using a special structure that enables it to find files and folders. This special structure is called a file system and it is important to verify (from time to time) that the file system is intact and doesn't contain any errors. File system errors most often occur when the FreeNAS server is switched off without a proper shutdown. This can mean that the file system is left in a state where write operations were queued or cached and they were never actually completed. What remains therefore is a file system inconsistency. The FreeBSD tool for checking the file system consistency is called fsck (File System Consistency checK).<a id="id303" class="indexterm"/>
</p><p>To run a file system consistency check, go to<strong> Disks: Mount Point</strong> and click on the<strong> Fsck</strong> tab. First, you need to select the disk to check from the drop down box. Next, you need to decide how you want to run the file system check.<a id="id304" class="indexterm"/>
</p><p>If the<strong> Unmount disk/partition</strong> is not ticked then fsck is run in read-only mode. Here the file system is checked for errors but any errors are reported but<strong> not</strong> corrected. Running a file system check on a busy disk can reduce performance.</p><p>If<strong> Unmount disk/partition</strong> is ticked then the disk will first be unmounted and all errors will be fixed automatically. During the file system check, the data on the disk won't be available to the network users.</p><p>The output for fsck will look something like this:<a id="id305" class="indexterm"/>
</p><div><pre class="programlisting">** /dev/ad0p1 (NO WRITE)
** Last Mounted on /mnt/store
** Phase 1 - Check Blocks and Sizes
** Phase 2 - Check Pathnames
** Phase 3 - Check Connectivity
** Phase 4 - Check Reference Counts
** Phase 5 - Check Cyl groups
317 files, 17249 used, 4833873 free (121 frags, 604219 blocks, 0.0% fragmentation)
Successful
</pre></div><div><h3 class="title"><a id="tip61"/>Note</h3><p><strong>Large Disks and fsck</strong></p><p>Depending on the hard disk size, running fsck can take from minutes to hours. Therefore, on large hard disks, running fsck from the web interface can give you a time-out. fsck will fix all errors on the file system but you will not see the output on web interface.</p><p>Also, note that fsck requires a large amount of RAM to run. For large volumes (2TB or greater), you should have a minimum 512MB RAM.</p></div><p>It is also possible to run the fsck tool from the command line. This might be useful for large hard disks if the web interface times out while waiting for the command to complete. Please see chapter 10 for more details.</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec04"/>Advanced OS Tweaking</h1></div></div></div><p>The underlying operating system of FreeNAS is FreeBSD. Like all complex systems, FreeBSD has a number of configuration parameters that can change its behavior. At the heart of the FreeBSD system, is its kernel and the kernel can be 'tweaked' to perform better under certain situations. The FreeNAS developers have defined a set of kernel parameters that can be tweaked at the click of the mouse. These parameters are as follows:<a id="id306" class="indexterm"/>
<a id="id307" class="indexterm"/>
</p><div><table border="1"><colgroup><col width="2.06923148148148" style="text-align: left"/><col width="0.566246031746033" style="text-align: left"/><col width="0.666070512820513" style="text-align: left"/><col width="2.1480811965812" style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Parameter</p>
</th><th style="text-align: left" valign="bottom">
<p>Normal</p>
<p>value</p>
</th><th style="text-align: left" valign="bottom">
<p>Tweaked</p>
<p>value</p>
</th><th style="text-align: left" valign="bottom">
<p>Meaning</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">net.inet.tcp.delayed_ack:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>1</p>
</td><td style="text-align: left" valign="top">
<p>0</p>
</td><td style="text-align: left" valign="top">
<p>This tells FreeBSD to attempt to include TCP ACK information on a data packet instead of sending additional packets to signal the end of a connection.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">net.inet.tcp.sendspace:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>32768</p>
</td><td style="text-align: left" valign="top">
<p>65536</p>
</td><td style="text-align: left" valign="top">
<p>This along with<code class="literal"> net.inet.udp.recvspace</code> define the maximum network packet size. Increasing the packet size can increase network performance, but it also increases memory usage.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">net.inet.udp.recvspace:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>42080</p>
</td><td style="text-align: left" valign="top">
<p>65536</p>
</td><td style="text-align: left" valign="top">
<p>See above.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">net.inet.udp.maxdgram:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>9216</p>
</td><td style="text-align: left" valign="top">
<p>57344</p>
</td><td style="text-align: left" valign="top">
<p>This is the maximum outgoing UDP datagram size. Increasing it can improve network performance but also increased memory usage.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">net.local.stream.recvspace:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>8192</p>
</td><td style="text-align: left" valign="top">
<p>65535</p>
</td><td style="text-align: left" valign="top">
<p>This and the .sendspace below are further buffer tweaks for networking. Performance can increase but so will memory usage.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">net.local.stream.sendspace :</code>
</p>
</td><td style="text-align: left" valign="top">
<p>8192</p>
</td><td style="text-align: left" valign="top">
<p>65535</p>
</td><td style="text-align: left" valign="top">
<p>See above.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kern.ipc.maxsockbuf:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>262144</p>
</td><td style="text-align: left" valign="top">
<p>2097152</p>
</td><td style="text-align: left" valign="top">
<p>This is the maximum combined buffer size for both sides of a TCP socket. It is increased along with the other network related parameters to boost network performance.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kern.ipc.somaxconn:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>128</p>
</td><td style="text-align: left" valign="top">
<p>8192</p>
</td><td style="text-align: left" valign="top">
<p>This controls how many simultaneous connection attempts the system will try to handle.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kern.ipc.maxsockets:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>3072</p>
</td><td style="text-align: left" valign="top">
<p>16424</p>
</td><td style="text-align: left" valign="top">
<p>This is the total number of sockets available on the system. You need one socket for every network connection.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kern.ipc.nmbclusters:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>3072</p>
</td><td style="text-align: left" valign="top">
<p>60000</p>
</td><td style="text-align: left" valign="top">
<p>This controls the number of <em>mbufs</em> allocated by the system An <em>mbuf</em> is a chunk of kernel memory used for networking. This is increased in line with other network buffer increases.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kern.maxfiles:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>1064</p>
</td><td style="text-align: left" valign="top">
<p>65536</p>
</td><td style="text-align: left" valign="top">
<p>The maximum number of files that the system can have open for reading or writing at any one time.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">kern.maxfilesperproc:</code>
</p>
</td><td style="text-align: left" valign="top">
<p>957</p>
</td><td style="text-align: left" valign="top">
<p>32768</p>
</td><td style="text-align: left" valign="top">
<p>This is the maximum number of files a single process can open.</p>
</td></tr></tbody></table></div><p>Enabling Kernel Tuning will result in two things. First, a probable increase in the performance of the FreeNAS server and second, an increase in the amount of memory used by the FreeNAS server. If your system has sufficient memory (256MB or more) and your server experiences heavy network traffic, try enabling Kernel Tuning.<a id="id308" class="indexterm"/>
</p><p>To enable it, go to<strong> System: Advanced</strong> and tick the<strong> Tuning</strong> box. Click<strong> Save</strong> to apply the changes.<a id="id309" class="indexterm"/>
</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec05"/>Tweaking the Network Settings</h1></div></div></div><p>The FreeNAS server has a couple of advanced sections for controlling the network. The first is the global network configurations for each network installed in the machine and the second is the ability to add static routes to the network routing table.<a id="id310" class="indexterm"/>
</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec05"/>MTU, Device Polling, Speed, and Duplex</h2></div></div></div><p>On the<strong> Interfaces: LAN</strong> page (where LAN represents the default network card), there are four parameters that can be changed to increase the performance of your network.<a id="id311" class="indexterm"/>
</p><div><table border="1"><colgroup><col width="1.18190608465608" style="text-align: left"/><col width="4.28371164021164" style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Parameters</p>
</th><th style="text-align: left" valign="bottom">
<p>Meaning</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>MTU</p>
</td><td style="text-align: left" valign="top">
<p>The Maximum Transmission Unit (MTU) is the size (in bytes) of the largest packet that can be sent on your network. A higher MTU means higher bandwidth efficiency. For an 10/100 Ethernet network, 1500 is the largest allowed MTU. For a Gigabit Ethernet network (with Jumbo Frame support), 9000 is best (and maximum) option.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Device polling</p>
</td><td style="text-align: left" valign="top">
<p>Device polling is a technique that lets the system periodically poll network devices for new data instead of relying on interrupts. This can reduce CPU load and therefore increase throughput, at the expense of a slightly higher forwarding delay (the devices are polled 1000 times per second). Not all network cards support polling.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Speed</p>
</td><td style="text-align: left" valign="top">
<p>The speed of your network card should be automatically selected (autoselect) but if you find that it is not selected, then you can manually select from: 10baseT/UTP, 100baseTX, 1000baseTX, and 1000baseSX.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Duplex</p>
</td><td style="text-align: left" valign="top">
<p>If your network card and the switch to which it is connected are capable of supporting full duplex communications (meaning the card and switch can send while receiving and visa-versa) then you can set it here.</p>
</td></tr></tbody></table></div><div><h3 class="title">Note</h3><p>Avoid Duplex Mismatch</p><p>Duplex mismatch occurs when two connected devices operate in different duplex modes (one in half duplex while the other is in full duplex). The result of a duplex mismatch is a network that is not completely 'broken' but is incredibly slow. Duplex mismatch may occur from wrongly manually setting two connected network interfaces at different duplex modes, and also from connecting a device that performs auto-negotiation to one that is manually set to a full duplex mode. The auto-negotiating device will assume half duplex if it fails to negotiate.</p></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec06"/>Adding a Static Route</h2></div></div></div><p>If you are using two or more network cards, it can sometimes be of benefit to add a static route to the networking routing table. The network routing table defines to who each network connection is routed, or in other words which path it takes across the network. A default route is defined when you configure the default gateway in either the console menu or the Interfaces section of the web interface. By defining the default gateway, you are creating a default path for all traffic that is not destined for the local network. It is assumed that the router (which can be another PC or a DSL modem as well as a network router) can correctly direct the traffic to its destination. If you have more than one network card or you have a second router that handles traffic for a particular part of your network, it can be beneficial to add a static route telling the FreeNAS server to direct all traffic for that particular network to the second router rather than to the default gateway.<a id="id312" class="indexterm"/>
</p><p>To add a static route, go to<strong> System: Static routes</strong> and click on the add circle. There are three mandatory fields to complete:</p><div><table border="1"><colgroup><col width="1.81942989417989" style="text-align: left"/><col width="3.3106480972731" style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Parameter</p>
</th><th style="text-align: left" valign="bottom">
<p>Meaning</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Interface</p>
</td><td style="text-align: left" valign="top">
<p>Specify which interface this route applies to.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Destination network</p>
</td><td style="text-align: left" valign="top">
<p>Destination network for this static route.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Gateway</p>
</td><td style="text-align: left" valign="top">
<p>Gateway to be used to reach the destination network.</p>
</td></tr></tbody></table></div><p>The destination network takes the form of an IP address in dot notation (or more specifically a subnet address in that the ending digits will be 0 depending on the network mask) followed by a network mask specified as with 8, 16 or 24 for 255.0.0.0, 255.255.0.0 or 255.255.255.0, respectively.</p><p>For example, if the IP address of my FreeNAS server is 192.168.1.250 and there is a router other than the default gateway that can router traffic to the network 192.168.99.0 (meaning all machines with the IP address from 192.168.99.1 to 192.168.99.254), and that this router has an IP address of 192.168.1.123 then the settings would be:</p><p>Destination network: 192.168.99.0/24</p><p>Gateway: 192.168.1.123</p><p>Click<strong> Add</strong> and apply the changes to add the static route.</p><div><img src="img/4688_08_01.jpg" alt="Adding a Static Route"/></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec06"/>Using Wireless</h1></div></div></div><p>If you have a wireless network card that is supported by FreeNAS, then you can configure it to offer wireless access to the FreeNAS server.</p><p>To configure the wireless card, go to the<strong> Interfaces: Management</strong> page. Here, you will be able to configure the card and set the various wireless parameters like the Service Set Identifier (SSID) and the channel number. You can also configure the wireless security with Wired Equivalent Privacy (WEP).<a id="id313" class="indexterm"/>
</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec07"/>Adding a Swap File</h1></div></div></div><p>Some operations on the FreeNAS server, most notably using the iSCSI target and running fsck for big hard disks, require a minimum of 256MB of RAM (Random Access Memory). If your system does not have 256MB of RAM, you can use a swap file to temporarily extend the system's memory.<a id="id314" class="indexterm"/>
</p><p>FreeBSD divides its physical RAM into chucks of memory called pages. Swapping is the process whereby a page of memory is copied to a swap file, to free up that page of memory. The combined sizes of the physical memory and the swap file is the amount of virtual memory available.</p><p>Swapping is necessary when the system requires more memory than is physically available; the kernel (the core of FreeBSD) swaps out less used pages and gives memory to the current application (process) that needs the memory immediately.<a id="id315" class="indexterm"/>
</p><p>However, swapping does have a downside. Compared to memory, disks are very slow. Accessing the disk can be tens of thousands times slower than accessing physical memory. The more swapping that occurs, the slower your system will be.</p><p>Before adding a swap file, it is best to consider the option of adding more memory to your system.</p><p>To add a swap file go to<strong> System: Advanced</strong> and click on the<strong> Swap</strong> tab. To enable the use of a swap file, tick the<strong> Enable</strong> box in the title bar. Select the disk you wish to use to host the swap file, it will be listed by mount point name in the<strong> Mount to use for swap</strong> drop down box. Now, enter the amount of swap space you require. 256MB will be more than enough (note that you don't need to enter the MB part, just 256).<a id="id316" class="indexterm"/>
</p><p>Once you click on<strong> save</strong>, a file called<code class="literal"> swap_file</code> will be created on the specified disk and it will be used for swapping.</p><p>To double check that your swap file is configured correctly go to<strong> Diagnostics: Information</strong> and click on the<strong> Swap</strong> tab. The output should look something this:</p><div><pre class="programlisting">Swap Status:
Device 512-blocks Used Avail Capacity
/dev/md0 524288 0 524288 0%
</pre></div><p>This shows that there is a 256MB swap file in use (524288 divided by 2 as it is shown in 512 byte blocks not in Kilobytes). Currently, all the swap space is available as none of it is being used.</p></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec08"/>Enabling Secure Shell Connections (SSH)</h1></div></div></div><p>In chapters 9 and 10, it may be necessary to make a connection to the FreeNAS server and use the command line of FreeBSD. The command line is often referred to as a terminal or a shell (name after the command line interpreter of the same name). Secure SHell (SSH) is a way to use the command line on the FreeNAS via an encrypted connection and so allows you to use the FreeNAS server without the danger of others, who are snooping around on your network, discovering your passwords.<a id="id317" class="indexterm"/>
</p><p>By default, SSH access is disabled to enable it go to<strong> Services: SSHD</strong> and enable the<strong> SSH Daemon</strong> (server) by ticking<strong> Enable</strong> in the title of the configuration data table. Click<strong> Save and Restart</strong> to finish start the SSH server.</p><p>By default, SSH only allows local FreeNAS users to log in if they have been granted<strong> Full Shell</strong> access. Go to<strong> Access: Users and Groups</strong>. If you don't have any users created, then create one (after first creating a group). When you create the user, make sure the<strong> Full Shell</strong> box is ticked. This tells FreeNAS that this user is allowed to connect to the server via SSH and have access to the command line. For more details on user management, see chapter 5.</p><p>If you already have a user created who you wish to grant<strong> Full Shell</strong> access, then click the<strong> edit</strong> button next to the user name (an 'e' in a circle) and tick the<strong> Full Shell</strong> attribute. Click<strong> Save</strong> to store the new settings and apply the changes.</p><p>In FreeBSD, there are two categories of users, one is the normal user who has limited privileges (for example they can't stop or start services) and the other is the administrator or in FreeBSD terms is know as<strong> root</strong>. Root is a superuser who can do anything on the server.</p><div><div><div><div><h2 class="title"><a id="ch08lvl2sec07"/>Allow Root Login</h2></div></div></div><p>For troubleshooting and using FreeBSD, the most useful user is root. By default, root is not allowed to log in to the FreeNAS server via SSH as it can pose a security risk. To allow root to log in go to<strong> Services: SSHD</strong> and tick<strong> Permit root login</strong>. Then click<strong> Save and Restart</strong> to finish start the SSH server.<a id="id318" class="indexterm"/>
</p><div><h3 class="title"><a id="tip63"/>Note</h3><p><strong>Root Password</strong></p><p>The root password is the same as the web interface password, which by default is <em>freenas</em>. If the web interface password is changed, so does the root password.</p></div></div><div><div><div><div><h2 class="title"><a id="ch08lvl2sec08"/>Types of SSH Authentication</h2></div></div></div><p>SSH has two types of authentication method. The first is what it calls<em> keyboard-interactive authentication</em>, which in normal English—means you type in a username and password to log in. The second type is known as<em> public key authentication</em> Here, a system known as public-key cryptography is used to enable a remote SSH client to log in to the FreeNAS without a password.<a id="id319" class="indexterm"/>
</p><p>In public key cryptography, there are two keys called a private key and a public key. The magic behind public key cryptography is that you are free (in fact, encouraged) to give out your public key to anyone who wants it. Then that person can encrypt some information using the public key and once encrypted, only the private key can unlock it. Someone with your public key cannot unlock a message created with your public key.</p><p>What this means for SSH is that if the FreeNAS has a copy of your public key, it can correctly authenticate you as the holder of the private key. Thus, a secure connection is made between you and the FreeNAS server and you can use the command line knowing that your passwords and commands cannot be seen.</p><p>To get this working with the FreeNAS server, a few simple steps need to occur:</p><div><ol class="orderedlist"><li class="listitem"><p>1. A public and private key need to be generated.</p></li><li class="listitem"><p>2. The public key needs to be copied to the FreeNAS server.</p></li><li class="listitem"><p>3. You connect to the FreeNAS server and by exchanging of data encrypted using your public key and decrypted using your private key, secure communications are established.</p></li></ol></div><p>The following example is for Apple OS X and Linux. If you are using Linux, you need to be sure that the OpenSSH package is installed (which it will be by default on most Linux distributions).</p><p>First, a public and private key pair need to be generated. This is done with the <em>ssh-keygen</em> command:</p><div><pre class="programlisting">ssh-keygen
<a id="id320" class="indexterm"/>
</pre></div><p>The output will look something like this:</p><div><pre class="programlisting">Generating public/private rsa key pair.
Enter file in which to save the key (/Users/gary/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /Users/gary/.ssh/id_rsa.
Your public key has been saved in /Users/gary/.ssh/id_rsa.pub.
The key fingerprint is:
18:fa:6b:68:c7:9f:49:80:bb:0a:1a:2e:15:86:99:e6 gary@apple-mac.local
</pre></div><p>Here, on my Apple Mac, two files are created<code class="literal"> id_rsa</code> and<code class="literal"> id_rsa.pub</code>. The<code class="literal"> .pub</code> file is the public key and can be freely distributed. The<code class="literal"> id_rsa</code> file is the private key and needs to be protected. In this example I have not used a password. This means that to start the decryption process, no password is needed. The benefit of this is that the client SSH program can connect to the FreeNAS server and it will be authenticated without any input from the user. The disadvantage is that if someone else takes your private key (<code class="literal">id_rsa</code>) they can also do the same thing, completely unhindered. It is therefore recommended that if you need extra security, you should include a password for your private key.<a id="id321" class="indexterm"/>
</p><p>The next step is to tell the FreeNAS server your public key. The best way to do this is to copy it to the server using the SCP program. SCP stands for Secure Copy and it is a way to copy files in a secure manner from one machine to another. The<code class="literal"> id_rsa.pub</code> file needs to be copied to the<code class="literal"> /root/.ssh/authorized_keys2</code> file on the FreeNAS server.</p><p>The main problem is that the<code class="literal"> /root/.ssh</code> directory doesn't exist and SCP can't copy a file to a non-existent directory. There are several solutions to this, of which the simplest is to go to the FreeNAS console (and if needed press 
<em>ENTER</em> to remove the logo and see the menu). Now choose<strong> 6) Shell</strong>. At the # prompt type:</p><div><pre class="programlisting">mkdir .ssh
</pre></div><p>Now to copy<code class="literal"> id_rsa.pub</code> file to<code class="literal"> /root/.ssh/authorized_keys2</code> file on the FreeNAS server with SCP you need to enter:</p><div><pre class="programlisting">scp ~/.ssh/id_rsa.pub root@192.168.1.250:.ssh/authorized_keys2
</pre></div><p>where 192.168.1.250 is the address of your FreeNAS server. You will be asked to enter the root password.</p><p>The final step is to connect to the FreeNAS server using SSH:</p><div><pre class="programlisting">ssh -l root 192.168.1.250
</pre></div><p>The<code class="literal"> -l</code> option specifies who to log in as (in this case root) and 192.168.1.250 is the IP address of the FreeNAS server.</p><p>When you are connected, you will see something like this:<a id="id322" class="indexterm"/>
</p><div><pre class="programlisting">Last login: Wed Mar 19 14:20:52 2008 from 192.168.1.249
Copyright (c) 1980, 1983, 1986, 1988, 1990, 1991, 1993, 1994
The Regents of the University of California. All rights reserved.
freenas:~#
</pre></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch08lvl1sec09"/>Summary</h1></div></div></div><p>In this chapter, we have looked at advanced system configuration including disk encryption, S.M.A.R.T and SSH access.</p><p>The next chapter is about troubleshooting and helping you solve the most common FreeNAS problems.</p></div></body></html>