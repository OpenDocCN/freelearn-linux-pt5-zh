<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Configuring Notifications</h1></div></div></div><p>In this chapter, we will cover the following recipes:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Configuring notification periods</li><li class="listitem" style="list-style-type: disc">Configuring notification for groups</li><li class="listitem" style="list-style-type: disc">Specifying which states to be notified about</li><li class="listitem" style="list-style-type: disc">Tolerating a certain number of failed checks</li><li class="listitem" style="list-style-type: disc">Automating contact rotation</li><li class="listitem" style="list-style-type: disc">Defining an escalation for repeated notifications</li><li class="listitem" style="list-style-type: disc">Defining a custom notification method</li></ul></div><div><div><div><div><h1 class="title"><a id="ch04lvl1sec33"/>Introduction</h1></div></div></div><p>
<strong>Notifications</strong> in Nagios Core <a id="id176" class="indexterm"/>refer to the events fired and the messages generated when hosts or services change state, for the purposes of informing appropriate people or systems.</p><p>For example, when connectivity to a host is lost, <a id="id177" class="indexterm"/>it leaves the <code class="literal">UP</code> state and goes to the <code class="literal">DOWN</code> state on the next check. This eventually generates a notification event, and provided the appropriate flags are set and a contact is available, a message about the state change is generated and dealt with in some way as defined in the configuration.</p><p>The default text for such notifications goes into some detail about the problem, including the output from the appropriate plugin command:</p><div><pre class="programlisting">
<strong>***** Nagios *****</strong>
<strong>Notification Type: PROBLEM</strong>
<strong>Host: sparta.naginet</strong>
<strong>State: DOWN</strong>
<strong>Address: 10.128.0.21</strong>
<strong>Info: CRITICAL - Host Unreachable (10.128.0.21)</strong>
<strong>Date/Time: Sat May 19 16:27:39 NZST 2012</strong>
</pre></div><p>So, with this kind of text generated as a result of the event, the next question is what Nagios Core should do with it. A common method of notification that will be familiar to most Nagios Core administrators is sending this text as an e-mail message using the system mailer, but the same generated message <a id="id178" class="indexterm"/>can be used in a wide variety of ways. Just as commands can be flexibly defined in terms of the command lines they run, the action appropriate for a particular contact can be defined very flexibly to use the text of any notifications that a contact is configured to receive.</p><p>In this chapter, we'll learn how to refine notifications management in Nagios Core, to make sure that the appropriate people or systems are notified about appropriate network events, and not nagged about others which may not matter. We'll also learn how to set up notification methods beyond the simple e-mail message, and how to escalate notifications when problems remain unfixed after a certain period of time.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec34"/>Configuring notification periods</h1></div></div></div><p>In this recipe, we'll adjust the configuration for a service that has been bugging us with notifications late at night. We'll arrange to keep checking this host, <code class="literal">sparta.naginet</code>, on a 24x7 basis, but we'll prevent it from sending notifications outside of work hours, using two of the predefined time periods in the default <a id="id179" class="indexterm"/>Nagios Core configuration.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec117"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server with at least one host configured already. We'll use the example of <code class="literal">sparta.naginet</code>, a host defined in its own file.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec118"/>How to do it...</h2></div></div></div><p>We can define the <code class="literal">check_period</code>
<a id="id180" class="indexterm"/> and <code class="literal">notification_period</code> plugin<a id="id181" class="indexterm"/>s for our host as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the objects configuration directory for Nagios Core. The default is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the file containing your host definition, and find the definition within the file:<div><pre class="programlisting">
<strong># vi sparta.naginet.cfg</strong>
</pre></div><p>The host definition may look similar to the following code snippet:</p><div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21
}</pre></div></li><li class="listitem">Add or edit the value for the <code class="literal">check_period</code> directive to <code class="literal">24x7</code>:<div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21
<strong>    check_period         24x7</strong>
}</pre></div></li><li class="listitem">Add or edit the value for the <code class="literal">notification_period</code> directive to <code class="literal">workhours</code>:<div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21
    check_period         24x7
<strong>    notification_period  workhours</strong>
}</pre></div></li><li class="listitem">Validate the configuration and <a id="id182" class="indexterm"/>restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, Nagios Core will run its check of the host all the time (24 hours a day, 7 days a week), including logging the <code class="literal">UP</code> and <code class="literal">DOWN</code> states and showing them in the web interface and reporting, but will only send notifications to the nominated contact for the host during work hours, by default from 9 AM to 5 PM, Monday to Friday.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec119"/>How it works...</h2></div></div></div><p>The preceding configuration changed two properties of the host object type, to affect the changes we needed:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">check_period</code>: This defines the time <a id="id183" class="indexterm"/>periods during which the host should be checked; we chose the predefined period <code class="literal">24x7</code>, meaning checks against the host are always to be run, regardless of the time of day or night.</li><li class="listitem" style="list-style-type: disc"><code class="literal">notification_period</code>: This defines the <a id="id184" class="indexterm"/>time periods during which the host should send notifications to the appropriate contact; we <a id="id185" class="indexterm"/>chose the predefined period <code class="literal">workhours</code>, meaning that notifications will only be sent from 9 AM to 5 PM, Monday to Friday.</li></ul></div><p>The same configuration could be applied exactly to a service, rather than a host:</p><div><pre class="programlisting">define service {
    ...
<strong>    check_period         24x7</strong>
<strong>    notification_period  workhours</strong>
}</pre></div><p>The two time periods to which this new configuration refers are themselves defined in the Nagios Core configuration. The ones we've used, <code class="literal">24x7</code> and <code class="literal">workhours</code>, are standard time periods included in the defaults, kept in the <code class="literal">/usr/local/nagios/etc/objects/timeperiods.cfg</code> file. The definition for <code class="literal">workhours</code>, for example, looks similar to the following code snippet:</p><div><pre class="programlisting">define timeperiod {
    timeperiod_name  workhours
    alias            Normal Work Hours
    monday           09:00-17:00
    tuesday          09:00-17:00
    wednesday        09:00-17:00
    thursday         09:00-17:00
    friday           09:00-17:00
}</pre></div><p>The ones we've used here are just examples of common time periods. We can define time periods ourselves with great precision; see the <em>Creating a new time period</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <em>Understanding Hosts, Services, and Contacts</em> for some detail on how to do this.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec120"/>There's more...</h2></div></div></div><p>The distinction between the two directives is very important. Under most circumstances, we will want a <code class="literal">check_period</code> directive that corresponds to all times for services that are up day and night, because it means we can retain information about long-term uptime for the service. Keeping a distinct <code class="literal">notification_period</code> directive simply allows us to control when notifications should be sent, perhaps because they would otherwise go to a pager and wake up a grumpy systems administrator for a relatively unimportant system!</p><p>It's valid for Nagios Core configuration to set a <code class="literal">check_period</code> plugin for a reduced time period, for example <code class="literal">workhours</code>. However, you shouldn't need to do this unless your host is actually going to be down outside these hours. In most cases, it's appropriate to use the <code class="literal">24x7</code> time period as a value for <code class="literal">check_period</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec121"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Configuring notification for groups</em> recipe in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Creating a new time period</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <em>Understanding Hosts, Services, and Contacts</em></li><li class="listitem" style="list-style-type: disc">The <em>Specifying how frequently to check a host or service</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Working with Checks and States">Chapter 3</a>, <em>Working with Checks and States</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec35"/>Configuring notification for groups</h1></div></div></div><p>In this recipe, we'll learn how to define a contact group for a host. We'll demonstrate this as part of the general best practice of sending notifications to contact groups, rather than to individual contacts, which allows for more <a id="id186" class="indexterm"/>flexibility in assigning individual contacts to the appropriate groups for receiving appropriate notifications.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec122"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server with at least one host configured already. We'll use the example of <code class="literal">sparta.naginet</code>, a host defined in its own file, which we'll configure to send its notifications to an existing contact group called <code class="literal">noc</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec123"/>How to do it...</h2></div></div></div><p>We can configure notifications to be sent to our contact group as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Ensure that an appropriate <code class="literal">contact_group</code> definition<a id="id187" class="indexterm"/> exists for the group to which you intend to direct your notifications. A valid definition might look something similar to the following code snippet, perhaps kept in <code class="literal">contacts.cfg</code>:<div><pre class="programlisting">define contactgroup {
    contactgroup_name  noc
    alias              Network Operations
    members            john,jane
}</pre></div></li><li class="listitem">If any contacts are referenced for the group, then you should ensure those are also defined. They might look similar <a id="id188" class="indexterm"/>to the following code snippet:<div><pre class="programlisting">define contact {
    use            generic-contact
    contact_name   john
    alias          John Smith
    email          john@naginet
}
define contact {
    use            generic-contact
    contact_name   jane
    alias          Jane Doe
    email          jane@naginet
}</pre></div></li><li class="listitem">Edit the file containing your host definition, and find the definition within the file:<div><pre class="programlisting">
<strong># vi sparta.naginet.cfg</strong>
</pre></div><p>The host definition may look similar to the following code snippet:</p><div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21notification_period  24x7
}</pre></div><p>Add or edit the value for the <code class="literal">contact_groups</code> directive to <code class="literal">noc</code>:</p><div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21
    notification_period  24x7
<strong>    contact_groups       noc</strong>
}</pre></div></li><li class="listitem">If contacts for the host are already defined, then you may wish to remove them, though you don't have to.</li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, all notifications for this host <a id="id189" class="indexterm"/>should be sent to each member of the <code class="literal">noc</code> group; in our example, the contacts are <code class="literal">jane</code> and <code class="literal">john</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec124"/>How it works...</h2></div></div></div><p>Defining the contacts that should receive notifications for particular hosts can be done by referring to them individually, or as groups, or both. We could have managed the same result as the preceding one by defining the <code class="literal">contacts</code> directive for the host as <code class="literal">jane,john</code>, referring to the individual contacts directly, rather than by their group name.</p><p>Almost the same configuration process applies for setting the contact group for services, rather than hosts; we add a value for the <code class="literal">contact_groups</code> directive to the <code class="literal">service</code> definition:</p><div><pre class="programlisting">define service {
    ...
<strong>    contact_groups  noc</strong>
}</pre></div><p>When an event takes place for the host or service that prompts a notification, and the valid <code class="literal">notification_option</code> flag<a id="id190" class="indexterm"/>s are set for that event, Nagios Core will check the values of both the <code class="literal">contacts</code> and the <code class="literal">contact_groups</code> directives for the host, to determine to whom to send the notification. In our case, the server finds the value of <code class="literal">contact_groups</code> to be <code class="literal">noc</code>, and so refers to that contact group to identify the individual contacts within it, and then sends the notification to each of them.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec125"/>There's more...</h2></div></div></div><p>Which of the two methods to use for defining contacts for hosts or services, whether by individual contact references or groups, is up to you. For large numbers of hosts and services, it tends to be easier to direct notifications to appropriate groups rather than individuals, as it affords us more flexibility in choosing to whom notifications will be sent simply by changing the individuals in the group.</p><p>You need to define at least one contact or contact group for a host or service, or have it inherit one through a template, for it to be a valid configuration for Nagios Core.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec126"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Configuring notification periods</em>, <em>Specifying which states to be notified about</em>, and <em>Automating contact rotation</em> recipes in this chapter </li><li class="listitem" style="list-style-type: disc">The <em>Creating a new contact</em> and <em>Creating a new contact group</em> recipes in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <em>Understanding Hosts, Services, and Contacts</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec36"/>Specifying which states to be notified about</h1></div></div></div><p>In this recipe, we'll learn how to refine which notifications are sent by a host or service, and which notifications should be received by a particular contact. We'll do this by changing both the notification types that hosts and services should generate, and to complement that, the notification types that a contact should be configured to receive.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec127"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server, with at least one host configured already. We'll use the example of <code class="literal">sparta.naginet</code>, a host defined in its own file, which we'll configure to send only <code class="literal">DOWN</code> and <code class="literal">RECOVERY</code> notifications, ignoring other notifications such as <code class="literal">WARNING</code> and <code class="literal">UNKNOWN</code>. It will send notifications to an existing contact called <code class="literal">john</code>; we'll ensure that this contact is configured to receive those notifications.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec128"/>How to do it...</h2></div></div></div><p>We can configure the notification types for our host as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration <a id="id191" class="indexterm"/>directory for Nagios Core. The default is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the file containing the definition for your host. It might look similar to the following code snippet:<div><pre class="programlisting">define host {
    use                    linux-server
    host_name              sparta.naginet
    alias                  sparta
    address                10.128.0.21
    contacts               john
    notification_period    24x7
}</pre></div></li><li class="listitem">Add a value for the <code class="literal">notification_options</code> directive. In our case, we'll use <code class="literal">d,r</code>, to correspond to notifications for <code class="literal">DOWN</code> and <code class="literal">RECOVERY</code> states:<div><pre class="programlisting">define host {
    use                    linux-server
    host_name              sparta.naginet
    alias                  sparta
    address                10.128.0.21
    contacts               john
    notification_period    24x7
<strong>    notification_options   d,r</strong>
}</pre></div></li><li class="listitem">We should also ensure that notifications for this host are enabled, specifically that <code class="literal">notifications_enabled</code> is set to <code class="literal">1</code>. An easy way to set this and other relevant directives is to have the host inherit from a template such as <code class="literal">linux-server</code>, as done previously, but we can set it explicitly if we prefer:<div><pre class="programlisting">define host {
    use                    linux-server
    host_name              sparta.naginet
    alias                  sparta
    address                10.128.0.21
    contacts               john
    notification_period    24x7
    notification_options   d,r
<strong>    notifications_enabled  1</strong>
}</pre></div></li><li class="listitem">Edit the file containing the definition for the host's nominated contacts, or the contacts within its nominated contact group. In this case, we're editing the host's nominated contact <code class="literal">john</code>. The definition might look similar to the following code snippet:<div><pre class="programlisting">define contact {
    use           generic-contact
    contact_name  john
    alias         John Smith
<strong>    email         john@naginet</strong>
}</pre></div></li><li class="listitem">Edit or set the directive for <code class="literal">host_notification_options</code>, for each contact, to include the same values that you set for the host. In this case, we set it to <code class="literal">d</code>, <code class="literal">u</code>, <code class="literal">r</code>, which means that <code class="literal">John Smith</code> can <a id="id192" class="indexterm"/>receive the <code class="literal">DOWN</code>, <code class="literal">UNREACHABLE</code>, and <code class="literal">RECOVERY</code> notifications about hosts:<div><pre class="programlisting">define contact {
    use                        generic-contact
    contact_name               john
    alias                      John Smith
    email                      john@naginet
<strong>    host_notification_options  d,u,r</strong>
}</pre></div></li><li class="listitem">Again, you should ensure that the contacts are configured to receive host notifications, using the <code class="literal">host_notifications_enabled</code> directive being set to <code class="literal">1</code>. We can do this via inheritance from a template such as <code class="literal">generic-contact</code>, which tends to be easier, or we can set it explicitly:<div><pre class="programlisting">define contact {
    use                         generic-contact
    contact_name                john
    alias                       John Smith
    email                       john@naginet
    host_notification_options   d,r
<strong>    host_notifications_enabled  1</strong>
}</pre></div><p>The analogous directive for receiving service notifications is <code class="literal">service_notifications_enabled</code>.</p></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, notifications sent when the host enters the <code class="literal">DOWN</code> state should be sent to the contact, and also when it recovers to the <code class="literal">OK</code> state, but no other notifications about the host (such as the <code class="literal">UNREACHABLE</code> or <code class="literal">DOWNTIMESTART</code> notifications) should be sent about the <code class="literal">sparta.naginet</code> host to the contact<code class="literal"> john</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec129"/>How it works...</h2></div></div></div><p>The kinds of notifications a host should produce is defined <a id="id193" class="indexterm"/>in its <code class="literal">notification_options</code> directive, and the kind of host notifications that a defined contact should receive is configured in its <code class="literal">host_notification_options</code> directive. Both take the form of comma-separated values.</p><p>The valid values for the <code class="literal">notification_options</code> directive for host objects are:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">d</code>: Notifications for a host being in the <a id="id194" class="indexterm"/><a id="id195" class="indexterm"/><code class="literal">DOWN</code> state</li><li class="listitem" style="list-style-type: disc"><code class="literal">u</code>: Notifications for a host being in the <a id="id196" class="indexterm"/><a id="id197" class="indexterm"/><code class="literal">UNREACHABLE</code> state</li><li class="listitem" style="list-style-type: disc"><code class="literal">r</code>: Notifications for a host recovering from <a id="id198" class="indexterm"/><a id="id199" class="indexterm"/>problems (becoming <code class="literal">UP</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">f</code>: Notifications for a host beginning or <a id="id200" class="indexterm"/><a id="id201" class="indexterm"/>ending the flapping state</li><li class="listitem" style="list-style-type: disc"><code class="literal">s</code>: Notifications for a host beginning or <a id="id202" class="indexterm"/><a id="id203" class="indexterm"/>ending scheduled downtime</li></ul></div><p>For example, for a host that should only send notifications when entering the <code class="literal">DOWN</code> or <code class="literal">UP</code> states, but ignoring notification events for <code class="literal">UNREACHABLE</code> or flapping, we might define the following:</p><div><pre class="programlisting">define host {
    ...
<strong>    notification_options d,r</strong>
}</pre></div><p>The valid directives are slightly different for service objects:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">w</code>: Notifications for a service being <a id="id204" class="indexterm"/>in the <code class="literal">WARNING</code> state</li><li class="listitem" style="list-style-type: disc"><code class="literal">u</code>: Notifications for a service being in the <a id="id205" class="indexterm"/><code class="literal">UNKNOWN</code> state</li><li class="listitem" style="list-style-type: disc"><code class="literal">c</code>: Notifications for a service being in the <a id="id206" class="indexterm"/><code class="literal">CRITICAL</code> state</li><li class="listitem" style="list-style-type: disc"><code class="literal">r</code>: Notifications for a service recovering from <a id="id207" class="indexterm"/>problems (becoming <code class="literal">OK</code>)</li><li class="listitem" style="list-style-type: disc"><code class="literal">f</code>: Notifications for a service beginning or <a id="id208" class="indexterm"/>ending a flapping state</li><li class="listitem" style="list-style-type: disc"><code class="literal">s</code>: Notifications for a service beginning or <a id="id209" class="indexterm"/>ending scheduled downtime</li></ul></div><p>For example, for a host that should send notifications for all of these events except for flapping and scheduled downtime states, we might define the following:</p><div><pre class="programlisting">define service {
    ...
<strong>    notification_options  w,u,c,r</strong>
}</pre></div><p>All of the preceding values can be used in contact object definitions to restrict the service notifications a particular contact should receive, through the <code class="literal">service_notification_options</code> directive:</p><div><pre class="programlisting">define contact {
    ...
<strong>    service_notifications_enabled  1</strong>
<strong>    service_notification_options   w,u,c,r</strong>
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec130"/>There's more...</h2></div></div></div><p>Unless we have a specific reason for particular contacts not to accept notifications of a particular kind, it's a good practice to configure contacts to receive all notifications that they are sent, by including all the flags in both the directives for the contact:</p><div><pre class="programlisting">define contact {
    ...
<strong>    host_notification_options     d,u,r,f,s</strong>
<strong>    service_notification_options  w,u,c,r,f,s</strong>
}</pre></div><p>This means that the contact will process any notification dispatched to it, and we can instead restrict the kinds of notifications that are sent out by the hosts and services for which this is the delegated contact. With new configurations, it is generally better to start by sending too much information, and then removing unnecessary notification flags if appropriate, rather than potentially missing important messages because they're never sent.</p><p>If we intend to do this for all of our contacts, it may be appropriate to include these directives as part of a contact template, and inherit from it using the <code class="literal">use</code> directive. The <code class="literal">generic-contact</code> contact template included with the default configuration may be suitable.</p><p>If you want to completely disable notifications for a given host, service, or contact, the single value <code class="literal">n</code> for <code class="literal">notification_options</code>, <code class="literal">host_notification_options</code>, and <code class="literal">service_notification_options</code> will do this.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec131"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Configuring notification for groups</em>, <em>Automating contact rotation</em>, and <em>Defining a custom notification method</em> recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Using inheritance to simplify configuration</em> recipe in <a class="link" href="ch09.html" title="Chapter 9. Managing Configuration">Chapter 9</a>, <em>Configuration Management</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec37"/>Tolerating a certain number of failed checks</h1></div></div></div><p>In this recipe, we'll learn how to arrange Nagios Core configuration to only send notifications about problems with a host or service after a check has been repeated a certain number of times and failed each time.</p><p>This can be an ideal arrangement for non-critical <a id="id210" class="indexterm"/>hosts that occasionally have "blips" or short outages for whatever reason, and only become problematic if they remain down after repeated checks.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec132"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server, with at least one host configured already. We'll use the example of <code class="literal">sparta.naginet</code>, a host defined in its own file. We'll arrange for it to send us notifications only after a total of five failed host checks.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec133"/>How to do it...</h2></div></div></div><p>We can configure the number of failed checks to tolerate before sending a notification as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the file containing your host definition, and find the definition within it. It may look similar to the following code snippet:<div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21
    notification_period  24x7
}</pre></div></li><li class="listitem">Add or edit the value for <code class="literal">max_check_attempts</code> to <code class="literal">5</code>:<div><pre class="programlisting">define host {
    use                  linux-server
    host_name            sparta.naginet
    alias                sparta
    address              10.128.0.21
    notification_period  24x7
<strong>    max_check_attempts   5</strong>
}</pre></div></li><li class="listitem">Validate the configuration and restart the <a id="id211" class="indexterm"/>Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, Nagios Core will not send a notification for the host entering the <code class="literal">DOWN</code> state until the check has been attempted a total of five times, and has failed each time. In the following screenshot, even though four checks have already taken place and failed, no notification has been sent, and the state is listed as <strong>SOFT</strong>
<a id="id212" class="indexterm"/>:</p><div><img src="img/5566_04_01.jpg" alt="How to do it..."/></div><p>The <code class="literal">SOFT</code> state shows that while Nagios Core has flagged the host as <code class="literal">DOWN</code>, it will retry the check until it exhausts <code class="literal">max_check_attempts</code>. At this point it will flag the host as being in a <code class="literal">HARD</code> <code class="literal">DOWN</code> state and send a notification.</p><p>However, if the host were to come back up before the <a id="id213" class="indexterm"/>next check, then the state would change back to <strong>UP</strong>, without ever having sent a notification:</p><div><img src="img/5566_04_02.jpg" alt="How to do it..."/></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec134"/>How it works...</h2></div></div></div><p>The preceding configuration alters the <code class="literal">max_check_attempts</code> directive for the host to specify the number of checks that need to have failed before the host will flag a <code class="literal">HARD</code> <code class="literal">DOWN</code> or <code class="literal">UNREACHABLE</code> state, and generate a notification event.</p><p>The process for changing the maximum number of attempts <a id="id214" class="indexterm"/>before a notification for a service is identical; we add the same directive and value to the definition for the service:</p><div><pre class="programlisting">define service {
    use                  generic-service
    host_name            sparta.naginet
    service_description  HTTP
    check_command        check_http
<strong>    max_check_attempts   5</strong>
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec135"/>There's more...</h2></div></div></div><p>The time between successive retry checks of a host before sending any notification can also be customized with the <code class="literal">retry_interval</code> directive. By default, the interval is in minutes, so if we wanted to configure a two-minute wait between retry checks, we could add this directive to the host or service:</p><div><pre class="programlisting">define host {
    ...
<strong>    retry_interval  2</strong>
}
define service {
    ...
<strong>    retry_interval  2</strong>
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec136"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Specifying how frequently to check a host or service</em> and <em>Managing brief outages with flapping</em> recipes in <a class="link" href="ch03.html" title="Chapter 3. Working with Checks and States">Chapter 3</a>, <em>Working with Checks and States</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec38"/>Automating contact rotation</h1></div></div></div><p>In this recipe, we'll learn how to automatically arrange notifications so that they are only received by certain contacts in a group at certain times.</p><p>For companies with more than one person as dedicated network staff, it's a common practice to have an on-call roster<a id="id215" class="indexterm"/>, where one member of staff will be the dedicated on-call person for a certain period of time, perhaps a <a id="id216" class="indexterm"/>week or two. The kind of setup we'll configure here allows filtering notifications, so that they're only delivered to contacts at appropriate times; notifications are generated by hosts and services and sent to all the contacts in the nominated group, but only one (or perhaps more than one) of the contacts actually receives it.</p><p>We'll set this up using two properties of contacts that allow us to restrict the time period within which they should receive notifications: <code class="literal">host_notification_period</code> and <code class="literal">service_notification_period</code>.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec137"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server, with at least one contact group configured already, with at least two contacts within it. You should be familiar with configuring time periods and understand the basics of notifications as discussed earlier in this chapter.</p><p>We'll use the very simple example of three network operators, named as contacts <code class="literal">alan</code>, <code class="literal">brenden</code>, and <code class="literal">charlotte</code>, taking turns with monitoring duty every week. All three are members of the group <code class="literal">ops</code>, which is specified in the <code class="literal">contact_groups</code> directive for all of the hosts and services on the network.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec138"/>How to do it...</h2></div></div></div><p>We can set up a basic alternating schedule for receiving notifications for our operators as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Check the relevant file or files to ensure your contacts are defined, and that they are members of the appropriate contact group. A good location for such information is in the <code class="literal">contacts.cfg</code> file. The configuration might look similar to the following code snippet:<div><pre class="programlisting">define contactgroup {
    contactgroup_name  ops
    alias              Network Operations
    members            alan,brenden,charlotte
}
    define contact {
        use           generic-contact
        contact_name  alan
        alias         Alan Jones
        email         alan@pager.naginet
    }
    define contact {
        use           generic-contact
        contact_name  brenden
        alias         Brenden Peters
        email         brenden@pager.naginet
    }
    define contact {
        use           generic-contact
        contact_name  charlotte
        alias         Charlotte Franks
        email         charlotte@pager.naginet
    }</pre></div></li><li class="listitem">In this case, all our hosts and services are <a id="id217" class="indexterm"/>configured to send messages to the <code class="literal">ops</code> contact group:<div><pre class="programlisting">    define host {
        ...
<strong>        contact_groups  ops</strong>
    }
    define service {
        ...
<strong>        contact_groups  ops</strong>
    }</pre></div></li><li class="listitem">Define time periods to correspond to the times during which each of your contacts should be receiving messages. We'll use the special syntax of time period definitions to set up the definitions for this rotation:<div><pre class="programlisting">define timeperiod {
    timeperiod_name  alan-pageralias            Alan pager schedule
    2012-06-05 / 21  00:00-24:00
    2012-06-06 / 21  00:00-24:00
    2012-06-07 / 21  00:00-24:00
    2012-06-08 / 21  00:00-24:00
    2012-06-09 / 21  00:00-24:00
    2012-06-10 / 21  00:00-24:00
    2012-06-11 / 21  00:00-24:00
}
define timeperiod {
    timeperiod_name  brenden-pageralias            Brenden pager schedule
    2012-06-12 / 21  00:00-24:00
    2012-06-13 / 21  00:00-24:00
    2012-06-14 / 21  00:00-24:00
    2012-06-15 / 21  00:00-24:00
    2012-06-16 / 21  00:00-24:00
    2012-06-17 / 21  00:00-24:00
    2012-06-18 / 21  00:00-24:00
}
define timeperiod {
    timeperiod_name  charlotte-pager
    alias            Charlotte pager schedule
    2012-06-19 / 21  00:00-24:00
    2012-06-20 / 21  00:00-24:00
    2012-06-21 / 21  00:00-24:00
    2012-06-22 / 21  00:00-24:00
    2012-06-23 / 21  00:00-24:00
    2012-06-24 / 21  00:00-24:00
    2012-06-25 / 21  00:00-24:00
}</pre></div></li><li class="listitem">Go back and configure each of your contacts with the <code class="literal">host_notification_period</code> and <code class="literal">service_notification_period</code> directives, to filter notifications to only be received during their dedicated time period:<div><pre class="programlisting">define contact {
    use                          generic-contact
    contact_name                 alan
    alias                        Alan Jones
    email                        alan@pager.naginet
<strong>    host_notification_period     alan-pager</strong>
<strong>    service_notification_period  alan-pager</strong>
}
define contact {
    use                          generic-contact
    contact_name                 brenden
    alias                        Brenden Peters
    email                        brenden@pager.naginet
<strong>    host_notification_period     brenden-pager</strong>
<strong>    service_notification_period  brenden-pager</strong>
}
define contact {
    use                          generic-contact
    contact_name                 charlotte
    alias                        Charlotte Franks
    email                        charlotte@pager.naginet
<strong>    host_notification_period     charlotte-pager</strong>
<strong>    service_notification_period  charlotte-pager</strong>
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, the contacts configured should only receive notifications during their dedicated pager time. If these are our only contacts, then all the notifications generated will go to only one person at any given time.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec139"/>How it works...</h2></div></div></div><p>The <code class="literal">host_notification_period</code>
<a id="id218" class="indexterm"/> and <code class="literal">service_notification_period</code> directive<a id="id219" class="indexterm"/>s in the definitions for our contacts are used to limit the times during which these contacts should receive any notifications. Each of our <a id="id220" class="indexterm"/>contacts in this example has their own time period defined to correspond to their portion of the pager schedule.</p><p>Let's take a look at Alan's example:</p><div><pre class="programlisting">    define timeperiod {
        timeperiod_name  alan-pager
        2012-06-05 / 21  00:00-24:00
        2012-06-06 / 21  00:00-24:00
        2012-06-07 / 21  00:00-24:00
        2012-06-08 / 21  00:00-24:00
        2012-06-09 / 21  00:00-24:00
        2012-06-10 / 21  00:00-24:00
        2012-06-11 / 21  00:00-24:00
    }</pre></div><p>The second line of the directive, <code class="literal">2012-06-05 / 21  00:00-24:00</code>, can be broken down as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Starting from the 5th of June,</li><li class="listitem" style="list-style-type: disc">Every 21 days,</li><li class="listitem" style="list-style-type: disc">From midnight to the following midnight (i.e., the entire day).</li></ul></div><p>The configuration then goes on to do the same for the <a id="id221" class="indexterm"/>remaining days of the first week Alan will be on call, and specifies that he will be on call the same day 21 days (3 weeks) later. A similar configuration, but starting one week and two weeks later, is set up for the contacts <code class="literal">brenden</code> and <code class="literal">charlotte</code> respectively.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec140"/>There's more...</h2></div></div></div><p>Note that there's no reason time periods can't overlap. If it happens to suit us to arrange for more than one contact to receive a notification, we can do that. Similarly, we can leave gaps in the schedule if notifications aren't needed during a certain time period.</p><p>Time periods in Nagios Core are highly flexible; to see some examples of the various syntaxes you can use for defining them, take a look at the <em>Creating a new time period</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <em>Understanding Hosts, Services, and Contacts</em>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec141"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Configuring notification for groups</em> and <em>Specifying which states to be notified about </em>recipes in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Creating a new contact</em>, <em>Creating a new contact group</em>, and <em>Creating a new time period</em> recipes in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <em>Understanding Hosts, Services, and Contacts</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec39"/>Defining an escalation for repeated notifications</h1></div></div></div><p>In this recipe, we'll learn how to arrange a Nagios Core configuration such that after a certain number of repetitions, notifications for <a id="id222" class="indexterm"/>
<a id="id223" class="indexterm"/>problems on hosts or services are escalated to another contact, instead of (or in addition to) the normally defined contact. This is done by defining a separate object type called a host or service escalation.</p><p>This kind of setup could be useful to alert more senior networking staff to an unresolved problem that a less experienced person is struggling to fix, and can also function as a "safety valve" to ensure that problem notifications for hosts eventually do reach someone else if they remain unfixed.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec142"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server, with at least one host or service configured already, and at least two contact groups—one for the first few notifications, and one for the escalations. You should understand how notifications are generated and sent to the <code class="literal">contacts</code> and <code class="literal">contact_groups</code> for hosts or services.</p><p>We'll use the example of a host called <code class="literal">sparta.naginet</code> which normally sends notifications to a group called <code class="literal">ops</code>. We'll <a id="id224" class="indexterm"/>arrange for all of the notifications after the fourth one to also be sent to a contact group called <code class="literal">emergency</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec143"/>How to do it...</h2></div></div></div><p>We can configure an escalation for our host or service as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Change to the objects configuration directory for Nagios Core. The default is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the file containing the definition for the host. The definition might look similar to the following code snippet:<div><pre class="programlisting">define host {
    use                    linux-server
    host_name              sparta.naginet
    alias                  sparta
    address                10.128.0.21
    contact_groups         ops
    notification_period    24x7
    notification_interval  10
}</pre></div></li><li class="listitem">Underneath the host definition, add the configuration for a new <code class="literal">hostescalation</code> object:<div><pre class="programlisting">define hostescalation {
    host_name              sparta.naginet
    contact_groups         ops,emergency
    first_notification     5
    last_notification      0
    notification_interval  10
}</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, when problems are encountered with the host that generate notifications, all the notifications beyond the fifth one will be sent to both the <code class="literal">ops</code> contact group and also to the <code class="literal">emergency</code> contact group, expanding the number of people or systems contacted, to make it more likely the problem will actually be addressed or fixed. Perhaps someone on the ops team has misplaced their pager.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec144"/>How it works...</h2></div></div></div><p>The configuration added in the preceding section is best thought of as a special case or an override for a particular host, in that it specifies a range of <a id="id225" class="indexterm"/>
<a id="id226" class="indexterm"/>notifications that should be sent to a different set of contact groups. It can be broken down as follows:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">host_name</code>: This is the same value of <a id="id227" class="indexterm"/><code class="literal">host_name</code> given for the host in its definition; we specified <code class="literal">sparta.naginet</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">contact_groups</code>: This is the contact groups to which notifications meeting this special case should be sent. <a id="id228" class="indexterm"/>We specify both the <code class="literal">emergency</code> group and the <code class="literal">ops</code> group, so that matching notifications go to both. Note that they are comma-separated.</li><li class="listitem" style="list-style-type: disc"><code class="literal">first_notification</code><a id="id229" class="indexterm"/>: This is the count of the first notification that should match this escalation; we chose the fifth notification.</li><li class="listitem" style="list-style-type: disc"><code class="literal">last_notification</code><a id="id230" class="indexterm"/>: This is the count of the last notification that should match this escalation. We set this to zero, which means that all notifications after <code class="literal">first_notification</code> should be sent to the nominated contact or contact groups. The notifications will not stop until they are manually turned off, or the problem is fixed.</li><li class="listitem" style="list-style-type: disc"><code class="literal">notification_interval</code><a id="id231" class="indexterm"/>: Like the host and service directives of the same name, this specifies how long Nagios Core should wait before sending new notifications if the host remains in a problematic state. Here, we've chosen ten minutes.</li></ul></div><p>Individual contacts can also (or instead) be specified with the <code class="literal">contacts</code> directive, rather than <code class="literal">contact_groups</code>.</p><p>Service escalations work in much the same way; the difference is that you need to specify the service by its <code class="literal">service_description</code> directive as well as its host name. Everything else works the same way. A similar escalation for a service <a id="id232" class="indexterm"/>check with a <code class="literal">service_description</code> of  <code class="literal">HTTP</code> running on <code class="literal">sparta.naginet</code> might look similar to the following code snippet:</p><div><pre class="programlisting">define serviceescalation {
    host_name              sparta.naginet
    service_description    HTTP
    contact_groups         ops,emergency
    first_notification     5
    last_notification      0
    notification_interval  10
}</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec145"/>There's more...</h2></div></div></div><p>The preceding escalation continues sending notifications both to the original <code class="literal">ops</code> group and also to the members of the <code class="literal">emergency</code> group. It's generally a good idea to do it this way rather than sending notifications only to the escalated group, because the point of escalations is to increase the reach of the notifications when a problem is not being dealt with, rather than merely to try contacting a different group of people instead.</p><p>This principle applies to stacking escalations, as well; if we had a host group with all of our contacts in it, perhaps named <code class="literal">everyone</code>, we could define a second escalation so that the tenth notification onwards goes to every single contact:</p><div><pre class="programlisting">define hostescalation {
    host_name              sparta.naginet
    contact_groups         everyone
    first_notification     10
    last_notification      0
    notification_interval  10
}</pre></div><p>Just as we can specify multiple host escalations, it's also fine for the ranges of notifications to overlap so that more than one escalation applies.</p><p>With a little arithmetic, you can arrange escalations such that they work after a host or service has been in a problematic state for a certain period of time. For example, the escalation we specified in the recipe will apply after the host has been in a problem state for 40 minutes, because <code class="literal">notification_interval</code> specifies that Nagios Core should wait for 10 minutes between re-sending notifications.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec146"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Configuring notifications for groups</em> recipe in this chapter</li><li class="listitem" style="list-style-type: disc">The <em>Creating a new contact group</em> recipe in <a class="link" href="ch01.html" title="Chapter 1. Understanding Hosts, Services, and Contacts">Chapter 1</a>, <em>Understanding Hosts, Services, and Contacts</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch04lvl1sec40"/>Defining a custom notification method</h1></div></div></div><p>In this recipe, we'll learn how to specify an alternative method for a contact to receive notifications about a service. A very typical method for a contact to receive notifications is by sending an e-mail to their contact address; e-mail messages could be sent to an inbox or a paging device.</p><p>However, notifications are just text; we can <a id="id233" class="indexterm"/>arrange to deal with them via any command we wish, in much the same way as we can configure host or service checks. In this recipe, we'll set up a new contact called <code class="literal">motd</code>, which when it receives notifications will write them into the server's <code class="literal">/etc/motd</code> directory to be displayed on login.</p><div><div><div><div><h2 class="title"><a id="ch04lvl2sec147"/>Getting ready</h2></div></div></div><p>You should have a Nagios Core 3.0 or newer server, with at least one host or service configured already. You should understand how notifications are generated and their default behavior in being sent to the <code class="literal">contacts</code> and <code class="literal">contact_groups</code> for hosts or services.</p><p>We'll use the example of a host called <code class="literal">troy.naginet</code>, configured to send notifications to the  <code class="literal">ops</code> contact group. We'll add a new contact within this group called <code class="literal">motd</code>.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec148"/>How to do it...</h2></div></div></div><p>We can arrange our custom notification method as follows:</p><div><ol class="orderedlist arabic"><li class="listitem">Ensure that your <code class="literal">/etc/motd</code> file can be written to by Nagios Core, and that it's a static file that your system will not overwrite on boot. If you run your Nagios Core server as the recommended default user and group of <code class="literal">nagios</code>, you could do something similar to the following:<div><pre class="programlisting">
<strong># chgrp nagios /etc/motd</strong>
<strong># chmod g+w /etc/motd</strong>
</pre></div></li><li class="listitem">It would be a good idea to test that the user can write to the file using <code class="literal">su</code> or <code class="literal">sudo</code>:<div><pre class="programlisting">
<strong># sudo -s -u nagios</strong>
<strong>$ echo 'test' &gt;&gt;/etc/motd</strong>
</pre></div></li><li class="listitem">Change to the <code class="literal">objects</code> configuration directory for Nagios Core. The default path is <code class="literal">/usr/local/nagios/etc/objects</code>. If you've put the definition for your host in a different file, then move to its directory instead.<div><pre class="programlisting">
<strong># cd /usr/local/nagios/etc/objects</strong>
</pre></div></li><li class="listitem">Edit the file containing the definitions for your notification commands. By default, this is in the file <code class="literal">commands.cfg</code>. Append the following definitions to the file:<div><pre class="programlisting">define command {
    command_name    notify-host-motd
    command_line    /usr/bin/printf "%s\n" "$SHORTDATETIME$: $HOSTALIAS$ is $HOSTSTATE$" &gt;&gt;/etc/motd
}
define command {
    command_name    notify-service-motd
    command_line    /usr/bin/printf "%s\n" "$SHORTDATETIME$: $SERVICEDESC$ on $HOSTALIAS$ is $SERVICESTATE$" &gt;&gt;/etc/motd
}</pre></div></li><li class="listitem">Edit the file containing the definitions for <a id="id234" class="indexterm"/>your contacts. In the QuickStart configuration, this is in the file <code class="literal">contacts.cfg</code>. Append the following definitions to the file:<div><pre class="programlisting">define contact {
    use                            generic-contact
    contact_name                   motd
    contact_groups                 ops
    alias                          MOTD
    host_notification_commands     notify-host-motd
    service_notification_commands  notify-service-motd
}</pre></div></li><li class="listitem">Edit the file containing the definitions for your host and/or services, to ensure that they specify <code class="literal">ops</code> in their <code class="literal">contact_groups</code> directives:<div><pre class="programlisting">define host {
    host_name       troy.naginet
    ...
<strong>    contact_groups  ops</strong>
}
    define service {
        host_name       troy.naginet
        ...
<strong>        contact_groups  ops</strong>
    }</pre></div></li><li class="listitem">Validate the configuration and restart the Nagios Core server:<div><pre class="programlisting">
<strong># /usr/local/nagios/bin/nagios -v /usr/local/nagios/etc/nagios.cfg</strong>
<strong># /etc/init.d/nagios restart</strong>
</pre></div></li></ol></div><p>With this done, the next notifications that go out for the host and services should not only be e-mailed to any contacts in the <code class="literal">ops</code> group, but should also be written by the <code class="literal">motd</code> contact to <code class="literal">/etc/motd</code>, to be presented on login:</p><div><pre class="programlisting">06-30-2012 17:24:05: troy is DOWN
06-30-2012 17:24:05: HTTP on troy is CRITICAL
06-30-2012 17:25:07: troy is DOWN
06-30-2012 17:25:07: HTTP on troy is CRITICAL</pre></div></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec149"/>How it works...</h2></div></div></div><p>The first part of the configuration that we added is defining new notification commands. These are actually command definitions, just the same as those used with the <code class="literal">check_command</code> definition<a id="id235" class="indexterm"/>s for hosts and services; the difference is that they're used by contacts to send notifications to people (or in this case, <a id="id236" class="indexterm"/>write them to files) in the appropriate way.</p><p>If you're using the default Nagios Core configuration, the commands already defined in <code class="literal">commands.cfg</code> should include <code class="literal">notify-host-by-email</code> and <code class="literal">notify-service-by-email</code>. I've truncated the complete command line as it's very long:</p><div><pre class="programlisting">define command {
    command_name    notify-host-by-email
    command_line    /usr/bin/printf "%b" "***** Nagios *****\n\nNotification...
}
define command {
    command_name    notify-service-by-email
    command_line    /usr/bin/printf "%b" "***** Nagios *****\n\nNotification...
}</pre></div><p>These commands use the system <code class="literal">printf</code> implementation along with many Nagios Core macros to build an appropriate notification string, which is e-mailed to the appropriate contact using a shell pipe into the system mailer.</p><p>If we inspect the <code class="literal">templates.cfg</code> file where the <code class="literal">generic-contact</code> template is defined, we can see these methods are referred to in two directives:</p><div><pre class="programlisting">define contact {
    ...
    service_notification_commands notify-service-by-email
    host_notification_commands notify-host-by-email
}</pre></div><p>This configuration thus defines a particular notification command to be used for hosts that derive from the <code class="literal">generic-host</code> template<a id="id237" class="indexterm"/>.</p><p>Our own command definition does something similar in building a string with a call to <code class="literal">printf</code>. But instead of writing the output into a pipe to the system mailer, it appends it to the <code class="literal">/etc/motd</code> file.</p><p>The <code class="literal">command_line</code> directive<a id="id238" class="indexterm"/> that we specified for the <code class="literal">motd</code> contact to process host notifications is as follows:</p><div><pre class="programlisting">
<strong>/usr/bin/printf "%s\n" "$SHORTDATETIME$: $HOSTALIAS$ is $HOSTSTATE$" &gt;&gt;/etc/motd</strong>
</pre></div><p>The first thing Nagios Core does when a notification event <a id="id239" class="indexterm"/>for this contact is successfully fired is substitute values for its macros, <code class="literal">$SHORTDATETIME$</code>, <code class="literal">$HOSTALIAS$</code>, and <code class="literal">$HOSTSTATE$</code>:</p><div><pre class="programlisting">
<strong>/usr/bin/printf "%s\n" "06-30-2012 17:24:05: troy is DOWN" &gt;&gt;/etc/motd</strong>
</pre></div><p>The resulting string is then executed as a command by the running Nagios Core user, by default <code class="literal">nagios</code>, and providing that user has the appropriate permissions, it's appended to the end of the MOTD.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec150"/>There's more...</h2></div></div></div><p>Adding messages to the MOTD may not be useful for all network administrators, particularly for larger or more sensitive networks, for which hundreds of notifications could be generated daily. The main thing to take away from this is that Nagios Core can be configured to process notification events in pretty much any way, provided:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">We can define a command line that will consistently do what is needed with what the results of the macro substitution Nagios Core will perform for us</li><li class="listitem" style="list-style-type: disc">The <code class="literal">nagios</code> user, or whichever user as which the Nagios Core server is running, has all the relevant permissions it needs to run the command</li></ul></div><p>E-mail notifications, particularly to a mobile paging device, are a very sensible basis for notifications for most administrators. However, if some other means of notification is needed, such as inserting into a database or piping into a <a id="id240" class="indexterm"/>Perl script, it is possible to do this as well.</p><p>Note that it's safest to specify the full paths to any binaries or file we use in these commands, hence <code class="literal">/usr/bin/printf</code> rather than merely <code class="literal">printf</code>. This is to ensure that the program we actually intend to run is run, and avoids having to mess about with the <code class="literal">$PATH</code> specifications for the <code class="literal">nagios</code> user.</p></div><div><div><div><div><h2 class="title"><a id="ch04lvl2sec151"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The <em>Configuring notifications for groups</em> recipe in this chapter </li><li class="listitem" style="list-style-type: disc">The <em>Creating a new command</em> and <em>Customizing an existing command</em> recipes in <a class="link" href="ch02.html" title="Chapter 2. Working with Commands and Plugins">Chapter 2</a>, <em>Working with Commands and Plugins</em></li></ul></div></div></div></body></html>