- en: Chapter 4. Configuring Notifications
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第4章：配置通知
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将涵盖以下内容：
- en: Configuring notification periods
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置通知周期
- en: Configuring notification for groups
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置组的通知
- en: Specifying which states to be notified about
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 指定需要通知的状态
- en: Tolerating a certain number of failed checks
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 容忍一定数量的检查失败
- en: Automating contact rotation
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 自动化联系人轮换
- en: Defining an escalation for repeated notifications
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为重复通知定义升级
- en: Defining a custom notification method
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 定义自定义通知方法
- en: Introduction
  id: totrans-9
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 简介
- en: '**Notifications** in Nagios Core refer to the events fired and the messages
    generated when hosts or services change state, for the purposes of informing appropriate
    people or systems.'
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: '**Nagios Core中的通知**是指当主机或服务状态变化时触发的事件和生成的消息，目的是通知相关人员或系统。'
- en: For example, when connectivity to a host is lost, it leaves the `UP` state and
    goes to the `DOWN` state on the next check. This eventually generates a notification
    event, and provided the appropriate flags are set and a contact is available,
    a message about the state change is generated and dealt with in some way as defined
    in the configuration.
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，当与主机的连接丢失时，它会离开`UP`状态并在下次检查时进入`DOWN`状态。这最终会生成一个通知事件，只要设置了适当的标志并且有可用的联系人，关于状态变化的消息就会生成并按照配置的方式处理。
- en: 'The default text for such notifications goes into some detail about the problem,
    including the output from the appropriate plugin command:'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 此类通知的默认文本详细描述了问题，包括来自相应插件命令的输出：
- en: '[PRE0]'
  id: totrans-13
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: So, with this kind of text generated as a result of the event, the next question
    is what Nagios Core should do with it. A common method of notification that will
    be familiar to most Nagios Core administrators is sending this text as an e-mail
    message using the system mailer, but the same generated message can be used in
    a wide variety of ways. Just as commands can be flexibly defined in terms of the
    command lines they run, the action appropriate for a particular contact can be
    defined very flexibly to use the text of any notifications that a contact is configured
    to receive.
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，随着事件生成这种文本，接下来的问题是Nagios Core应该如何处理它。大多数Nagios Core管理员都会熟悉通过系统邮件发送此文本作为电子邮件消息的常见通知方法，但同样生成的消息可以以多种方式使用。就像命令可以灵活定义其运行的命令行一样，适用于特定联系人的操作也可以非常灵活地定义，使用任何联系人被配置接收的通知文本。
- en: In this chapter, we'll learn how to refine notifications management in Nagios
    Core, to make sure that the appropriate people or systems are notified about appropriate
    network events, and not nagged about others which may not matter. We'll also learn
    how to set up notification methods beyond the simple e-mail message, and how to
    escalate notifications when problems remain unfixed after a certain period of
    time.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: 在本章中，我们将学习如何优化Nagios Core中的通知管理，以确保适当的人或系统能收到相关网络事件的通知，而不被不重要的事件打扰。我们还将学习如何设置超越简单电子邮件消息的通知方法，并且当问题在一定时间内未得到解决时，如何升级通知。
- en: Configuring notification periods
  id: totrans-16
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置通知周期
- en: In this recipe, we'll adjust the configuration for a service that has been bugging
    us with notifications late at night. We'll arrange to keep checking this host,
    `sparta.naginet`, on a 24x7 basis, but we'll prevent it from sending notifications
    outside of work hours, using two of the predefined time periods in the default
    Nagios Core configuration.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: 在本例中，我们将调整配置，解决一个在深夜频繁发出通知的服务。我们将安排对主机`sparta.naginet`进行24小时全天候监控，但我们会使用默认Nagios
    Core配置中的两个预定义时间周期，避免其在工作时间以外发送通知。
- en: Getting ready
  id: totrans-18
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should have a Nagios Core 3.0 or newer server with at least one host configured
    already. We'll use the example of `sparta.naginet`, a host defined in its own
    file.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该已经拥有一个Nagios Core 3.0或更新版本的服务器，并且至少配置了一个主机。我们将使用`sparta.naginet`作为示例，这个主机在其自己的文件中定义。
- en: How to do it...
  id: totrans-20
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can define the `check_period` and `notification_period` plugins for our
    host as follows:'
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以为主机定义`check_period`和`notification_period`插件，如下所示：
- en: Change to the objects configuration directory for Nagios Core. The default is
    `/usr/local/nagios/etc/objects`. If you've put the definition for your host in
    a different file, then move to its directory instead.
  id: totrans-22
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 进入Nagios Core的对象配置目录。默认目录是`/usr/local/nagios/etc/objects`。如果你的主机定义在其他文件中，则转到其目录。
- en: '[PRE1]'
  id: totrans-23
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'Edit the file containing your host definition, and find the definition within
    the file:'
  id: totrans-24
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机定义的文件，并在文件中找到相应的定义：
- en: '[PRE2]'
  id: totrans-25
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'The host definition may look similar to the following code snippet:'
  id: totrans-26
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 主机定义可能类似于以下代码片段：
- en: '[PRE3]'
  id: totrans-27
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Add or edit the value for the `check_period` directive to `24x7`:'
  id: totrans-28
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 `check_period` 指令的值添加或编辑为 `24x7`：
- en: '[PRE4]'
  id: totrans-29
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE4]'
- en: 'Add or edit the value for the `notification_period` directive to `workhours`:'
  id: totrans-30
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将 `notification_period` 指令的值添加或编辑为 `workhours`：
- en: '[PRE5]'
  id: totrans-31
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-32
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重启 Nagios Core 服务器：
- en: '[PRE6]'
  id: totrans-33
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: With this done, Nagios Core will run its check of the host all the time (24
    hours a day, 7 days a week), including logging the `UP` and `DOWN` states and
    showing them in the web interface and reporting, but will only send notifications
    to the nominated contact for the host during work hours, by default from 9 AM
    to 5 PM, Monday to Friday.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此操作后，Nagios Core 将始终对主机进行检查（每天24小时，每周7天），包括记录 `UP` 和 `DOWN` 状态，并在网页界面和报告中显示，但只会在工作时间内（默认从早上9点到下午5点，周一至周五）向指定的联系人发送通知。
- en: How it works...
  id: totrans-35
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的……
- en: 'The preceding configuration changed two properties of the host object type,
    to affect the changes we needed:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 上述配置更改了主机对象类型的两个属性，以实现所需的更改：
- en: '`check_period`: This defines the time periods during which the host should
    be checked; we chose the predefined period `24x7`, meaning checks against the
    host are always to be run, regardless of the time of day or night.'
  id: totrans-37
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`check_period`：此指令定义了应检查主机的时间段；我们选择了预定义的时间段`24x7`，意味着无论白天还是夜晚，都会对主机进行检查。'
- en: '`notification_period`: This defines the time periods during which the host
    should send notifications to the appropriate contact; we chose the predefined
    period `workhours`, meaning that notifications will only be sent from 9 AM to
    5 PM, Monday to Friday.'
  id: totrans-38
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`notification_period`：此指令定义了主机应在何时向适当的联系人发送通知；我们选择了预定义的时间段 `workhours`，意味着通知只会在早上9点到下午5点之间发送，周一至周五。'
- en: 'The same configuration could be applied exactly to a service, rather than a
    host:'
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: 相同的配置可以精确地应用于服务，而不是主机：
- en: '[PRE7]'
  id: totrans-40
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'The two time periods to which this new configuration refers are themselves
    defined in the Nagios Core configuration. The ones we''ve used, `24x7` and `workhours`,
    are standard time periods included in the defaults, kept in the `/usr/local/nagios/etc/objects/timeperiods.cfg`
    file. The definition for `workhours`, for example, looks similar to the following
    code snippet:'
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 这个新配置所涉及的两个时间段本身是在 Nagios Core 配置中定义的。我们使用的 `24x7` 和 `workhours` 是默认包含的标准时间段，保存在
    `/usr/local/nagios/etc/objects/timeperiods.cfg` 文件中。例如，`workhours` 的定义类似于以下代码片段：
- en: '[PRE8]'
  id: totrans-42
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: The ones we've used here are just examples of common time periods. We can define
    time periods ourselves with great precision; see the *Creating a new time period*
    recipe in [Chapter 1](ch01.html "Chapter 1. Understanding Hosts, Services, and
    Contacts"), *Understanding Hosts, Services, and Contacts* for some detail on how
    to do this.
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 这里使用的只是常见时间段的示例。我们可以非常精确地定义时间段；有关如何操作的更多细节，请参考 [第1章](ch01.html "第1章. 理解主机、服务和联系人")中的
    *创建新时间段* 章节。
- en: There's more...
  id: totrans-44
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多……
- en: The distinction between the two directives is very important. Under most circumstances,
    we will want a `check_period` directive that corresponds to all times for services
    that are up day and night, because it means we can retain information about long-term
    uptime for the service. Keeping a distinct `notification_period` directive simply
    allows us to control when notifications should be sent, perhaps because they would
    otherwise go to a pager and wake up a grumpy systems administrator for a relatively
    unimportant system!
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 这两个指令的区别非常重要。在大多数情况下，我们会希望 `check_period` 指令对应全天候服务的时间段，因为这样可以保留该服务的长期正常运行时间信息。而保留一个独立的
    `notification_period` 指令，主要是为了控制通知的发送时间，可能是因为否则通知会发送到寻呼机，打扰到一位心情不佳的系统管理员，尤其是对于一些相对不重要的系统！
- en: It's valid for Nagios Core configuration to set a `check_period` plugin for
    a reduced time period, for example `workhours`. However, you shouldn't need to
    do this unless your host is actually going to be down outside these hours. In
    most cases, it's appropriate to use the `24x7` time period as a value for `check_period`.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: 在 Nagios Core 配置中，将 `check_period` 插件设置为较短的时间段（例如 `workhours`）是有效的。但除非主机在这些时间段之外会实际停止运行，否则通常不需要这么做。在大多数情况下，适当的做法是将
    `24x7` 时间段作为 `check_period` 的值。
- en: See also
  id: totrans-47
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参阅
- en: The *Configuring notification for groups* recipe in this chapter
  id: totrans-48
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章中的*配置组通知*食谱
- en: The *Creating a new time period* recipe in [Chapter 1](ch01.html "Chapter 1. Understanding
    Hosts, Services, and Contacts"), *Understanding Hosts, Services, and Contacts*
  id: totrans-49
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在[第1章](ch01.html "第1章. 理解主机、服务和联系人")中的*创建新时间段*食谱，*理解主机、服务和联系人*
- en: The *Specifying how frequently to check a host or service* recipe in [Chapter
    3](ch03.html "Chapter 3. Working with Checks and States"), *Working with Checks
    and States*
  id: totrans-50
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在[第3章](ch03.html "第3章. 使用检查和状态")中的*指定检查主机或服务的频率*食谱，*使用检查和状态*
- en: Configuring notification for groups
  id: totrans-51
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置组通知
- en: In this recipe, we'll learn how to define a contact group for a host. We'll
    demonstrate this as part of the general best practice of sending notifications
    to contact groups, rather than to individual contacts, which allows for more flexibility
    in assigning individual contacts to the appropriate groups for receiving appropriate
    notifications.
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 在本食谱中，我们将学习如何为主机定义一个联系人组。我们将展示这是如何作为一种通用最佳实践来实现的，即将通知发送到联系人组，而不是单个联系人，这样可以更灵活地将单个联系人分配到适当的组中，以接收相应的通知。
- en: Getting ready
  id: totrans-53
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should have a Nagios Core 3.0 or newer server with at least one host configured
    already. We'll use the example of `sparta.naginet`, a host defined in its own
    file, which we'll configure to send its notifications to an existing contact group
    called `noc`.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 您应当已经有一个Nagios Core 3.0或更高版本的服务器，并且至少配置了一个主机。我们将使用`sparta.naginet`的示例，这是一个在其自己文件中定义的主机，我们将配置它将通知发送到一个名为`noc`的现有联系人组。
- en: How to do it...
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 操作步骤...
- en: 'We can configure notifications to be sent to our contact group as follows:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以按照以下方式配置通知，发送到我们的联系人组：
- en: Change to the `objects` configuration directory for Nagios Core. The default
    path is `/usr/local/nagios/etc/objects`. If you've put the definition for your
    host in a different file, then move to its directory instead.
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到Nagios Core的`objects`配置目录。默认路径是`/usr/local/nagios/etc/objects`。如果您将主机的定义放在了其他文件中，请转到该文件所在的目录。
- en: '[PRE9]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Ensure that an appropriate `contact_group` definition exists for the group
    to which you intend to direct your notifications. A valid definition might look
    something similar to the following code snippet, perhaps kept in `contacts.cfg`:'
  id: totrans-59
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保为您打算发送通知的组定义了一个适当的`contact_group`。有效的定义可能类似于以下代码片段，可能存放在`contacts.cfg`中：
- en: '[PRE10]'
  id: totrans-60
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'If any contacts are referenced for the group, then you should ensure those
    are also defined. They might look similar to the following code snippet:'
  id: totrans-61
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果组中引用了任何联系人，您应确保这些联系人也已定义。它们可能类似于以下代码片段：
- en: '[PRE11]'
  id: totrans-62
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Edit the file containing your host definition, and find the definition within
    the file:'
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机定义的文件，并在文件中找到相应的定义：
- en: '[PRE12]'
  id: totrans-64
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'The host definition may look similar to the following code snippet:'
  id: totrans-65
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 主机定义可能类似于以下代码片段：
- en: '[PRE13]'
  id: totrans-66
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Add or edit the value for the `contact_groups` directive to `noc`:'
  id: totrans-67
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 将`contact_groups`指令的值添加或编辑为`noc`：
- en: '[PRE14]'
  id: totrans-68
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: If contacts for the host are already defined, then you may wish to remove them,
    though you don't have to.
  id: totrans-69
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果主机已经定义了联系人，您可能希望将它们删除，尽管这不是必须的。
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-70
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重新启动Nagios Core服务器：
- en: '[PRE15]'
  id: totrans-71
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: With this done, all notifications for this host should be sent to each member
    of the `noc` group; in our example, the contacts are `jane` and `john`.
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此步骤后，所有针对此主机的通知应发送给`noc`组的每个成员；在我们的示例中，联系人是`jane`和`john`。
- en: How it works...
  id: totrans-73
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理...
- en: Defining the contacts that should receive notifications for particular hosts
    can be done by referring to them individually, or as groups, or both. We could
    have managed the same result as the preceding one by defining the `contacts` directive
    for the host as `jane,john`, referring to the individual contacts directly, rather
    than by their group name.
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: 定义应该接收特定主机通知的联系人，可以通过单独引用它们、作为组或两者结合来完成。我们本可以通过将主机的`contacts`指令定义为`jane,john`，直接引用单个联系人，而不是通过其组名，来实现与前面相同的结果。
- en: 'Almost the same configuration process applies for setting the contact group
    for services, rather than hosts; we add a value for the `contact_groups` directive
    to the `service` definition:'
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: 设置服务的联系人组（而不是主机）时，几乎相同的配置过程适用；我们只需在`service`定义中为`contact_groups`指令添加一个值：
- en: '[PRE16]'
  id: totrans-76
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: When an event takes place for the host or service that prompts a notification,
    and the valid `notification_option` flags are set for that event, Nagios Core
    will check the values of both the `contacts` and the `contact_groups` directives
    for the host, to determine to whom to send the notification. In our case, the
    server finds the value of `contact_groups` to be `noc`, and so refers to that
    contact group to identify the individual contacts within it, and then sends the
    notification to each of them.
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 当主机或服务发生事件并触发通知时，如果该事件设置了有效的`notification_option`标志，Nagios Core将检查主机的`contacts`和`contact_groups`指令的值，以确定向谁发送通知。在我们的例子中，服务器发现`contact_groups`的值是`noc`，因此会引用该联系人组以识别其中的单个联系人，并将通知发送给每个联系人。
- en: There's more...
  id: totrans-78
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: Which of the two methods to use for defining contacts for hosts or services,
    whether by individual contact references or groups, is up to you. For large numbers
    of hosts and services, it tends to be easier to direct notifications to appropriate
    groups rather than individuals, as it affords us more flexibility in choosing
    to whom notifications will be sent simply by changing the individuals in the group.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: 选择哪种方法来定义主机或服务的联系人，无论是通过单独的联系人引用还是通过组，这取决于你自己。对于大量的主机和服务，通常将通知定向到适当的组比定向到个人更为容易，因为它可以通过简单地更改组中的个人来为我们提供更多灵活性，选择发送通知给谁。
- en: You need to define at least one contact or contact group for a host or service,
    or have it inherit one through a template, for it to be a valid configuration
    for Nagios Core.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 你需要为主机或服务定义至少一个联系人或联系人组，或者通过模板继承一个联系人组，才能使其成为Nagios Core的有效配置。
- en: See also
  id: totrans-81
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Configuring notification periods*, *Specifying which states to be notified
    about*, and *Automating contact rotation* recipes in this chapter
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章中的*配置通知周期*、*指定需要通知的状态*以及*自动化联系人轮换*教程
- en: The *Creating a new contact* and *Creating a new contact group* recipes in [Chapter
    1](ch01.html "Chapter 1. Understanding Hosts, Services, and Contacts"), *Understanding
    Hosts, Services, and Contacts*
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第1章](ch01.html "第1章. 理解主机、服务和联系人")中的*创建新联系人*和*创建新联系人组*教程，*理解主机、服务和联系人*。'
- en: Specifying which states to be notified about
  id: totrans-84
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 指定需要通知的状态
- en: In this recipe, we'll learn how to refine which notifications are sent by a
    host or service, and which notifications should be received by a particular contact.
    We'll do this by changing both the notification types that hosts and services
    should generate, and to complement that, the notification types that a contact
    should be configured to receive.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个教程中，我们将学习如何细化由主机或服务发送的通知类型，以及特定联系人应接收哪些通知。我们将通过修改主机和服务应生成的通知类型，以及配置联系人的接收通知类型来实现这一目标。
- en: Getting ready
  id: totrans-86
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should have a Nagios Core 3.0 or newer server, with at least one host configured
    already. We'll use the example of `sparta.naginet`, a host defined in its own
    file, which we'll configure to send only `DOWN` and `RECOVERY` notifications,
    ignoring other notifications such as `WARNING` and `UNKNOWN`. It will send notifications
    to an existing contact called `john`; we'll ensure that this contact is configured
    to receive those notifications.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该拥有一个Nagios Core 3.0或更高版本的服务器，并且已经配置了至少一个主机。我们将使用`sparta.naginet`的例子，它是一个在自己文件中定义的主机，我们将配置它仅发送`DOWN`和`RECOVERY`通知，忽略其他如`WARNING`和`UNKNOWN`的通知。它将把通知发送给名为`john`的现有联系人；我们会确保这个联系人已经配置为接收这些通知。
- en: How to do it...
  id: totrans-88
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can configure the notification types for our host as follows:'
  id: totrans-89
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以按如下方式配置主机的通知类型：
- en: Change to the `objects` configuration directory for Nagios Core. The default
    is `/usr/local/nagios/etc/objects`. If you've put the definition for your host
    in a different file, then move to its directory instead.
  id: totrans-90
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到Nagios Core的`objects`配置目录。默认目录是`/usr/local/nagios/etc/objects`。如果你将主机的定义放在了不同的文件中，则转到该文件所在的目录。
- en: '[PRE17]'
  id: totrans-91
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Edit the file containing the definition for your host. It might look similar
    to the following code snippet:'
  id: totrans-92
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机定义的文件。它可能看起来像以下代码片段：
- en: '[PRE18]'
  id: totrans-93
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE18]'
- en: 'Add a value for the `notification_options` directive. In our case, we''ll use
    `d,r`, to correspond to notifications for `DOWN` and `RECOVERY` states:'
  id: totrans-94
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 为`notification_options`指令添加一个值。在我们的例子中，我们将使用`d,r`，对应于`DOWN`和`RECOVERY`状态的通知：
- en: '[PRE19]'
  id: totrans-95
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'We should also ensure that notifications for this host are enabled, specifically
    that `notifications_enabled` is set to `1`. An easy way to set this and other
    relevant directives is to have the host inherit from a template such as `linux-server`,
    as done previously, but we can set it explicitly if we prefer:'
  id: totrans-96
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 我们还应确保该主机的通知已启用，具体来说，`notifications_enabled`应设置为`1`。设置此项以及其他相关指令的一个简单方法是让主机继承一个模板，如之前所做的`linux-server`，但如果我们愿意，也可以显式地设置它：
- en: '[PRE20]'
  id: totrans-97
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Edit the file containing the definition for the host''s nominated contacts,
    or the contacts within its nominated contact group. In this case, we''re editing
    the host''s nominated contact `john`. The definition might look similar to the
    following code snippet:'
  id: totrans-98
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机指定联系人定义的文件，或其指定联系人组内的联系人。在这种情况下，我们正在编辑主机的指定联系人`john`。定义可能如下所示：
- en: '[PRE21]'
  id: totrans-99
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: 'Edit or set the directive for `host_notification_options`, for each contact,
    to include the same values that you set for the host. In this case, we set it
    to `d`, `u`, `r`, which means that `John Smith` can receive the `DOWN`, `UNREACHABLE`,
    and `RECOVERY` notifications about hosts:'
  id: totrans-100
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑或设置每个联系人的`host_notification_options`指令，以包括与您为主机设置的相同值。在这种情况下，我们将其设置为`d`、`u`、`r`，这意味着`John
    Smith`可以接收有关主机的`DOWN`、`UNREACHABLE`和`RECOVERY`通知：
- en: '[PRE22]'
  id: totrans-101
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Again, you should ensure that the contacts are configured to receive host notifications,
    using the `host_notifications_enabled` directive being set to `1`. We can do this
    via inheritance from a template such as `generic-contact`, which tends to be easier,
    or we can set it explicitly:'
  id: totrans-102
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 同样，您应确保联系人配置为接收主机通知，方法是将`host_notifications_enabled`指令设置为`1`。我们可以通过继承一个模板，如`generic-contact`，这通常更简单，或者我们可以显式地设置它：
- en: '[PRE23]'
  id: totrans-103
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: The analogous directive for receiving service notifications is `service_notifications_enabled`.
  id: totrans-104
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 接收服务通知的类似指令是`service_notifications_enabled`。
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-105
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重启Nagios Core服务器：
- en: '[PRE24]'
  id: totrans-106
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: With this done, notifications sent when the host enters the `DOWN` state should
    be sent to the contact, and also when it recovers to the `OK` state, but no other
    notifications about the host (such as the `UNREACHABLE` or `DOWNTIMESTART` notifications)
    should be sent about the `sparta.naginet` host to the contact `john`.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此操作后，当主机进入`DOWN`状态时，发送的通知应发送给联系人，并且当主机恢复到`OK`状态时也应发送通知，但不应发送有关该主机的其他通知（例如`UNREACHABLE`或`DOWNTIMESTART`通知）给联系人`john`。
- en: How it works...
  id: totrans-108
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The kinds of notifications a host should produce is defined in its `notification_options`
    directive, and the kind of host notifications that a defined contact should receive
    is configured in its `host_notification_options` directive. Both take the form
    of comma-separated values.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 主机应产生的通知类型由其`notification_options`指令定义，而定义的联系人应接收的主机通知类型由其`host_notification_options`指令配置。两者都采用以逗号分隔的值的形式。
- en: 'The valid values for the `notification_options` directive for host objects
    are:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: '`notification_options`指令对于主机对象的有效值是：'
- en: '`d`: Notifications for a host being in the `DOWN` state'
  id: totrans-111
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`d`: 主机处于`DOWN`状态时的通知'
- en: '`u`: Notifications for a host being in the `UNREACHABLE` state'
  id: totrans-112
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`u`: 主机处于`UNREACHABLE`状态时的通知'
- en: '`r`: Notifications for a host recovering from problems (becoming `UP`)'
  id: totrans-113
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`r`: 主机从问题中恢复（变为`UP`）时的通知'
- en: '`f`: Notifications for a host beginning or ending the flapping state'
  id: totrans-114
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`f`: 主机开始或结束颠簸状态时的通知'
- en: '`s`: Notifications for a host beginning or ending scheduled downtime'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`s`: 主机开始或结束计划的停机时间时的通知'
- en: 'For example, for a host that should only send notifications when entering the
    `DOWN` or `UP` states, but ignoring notification events for `UNREACHABLE` or flapping,
    we might define the following:'
  id: totrans-116
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，对于一个主机，当其进入`DOWN`或`UP`状态时应发送通知，但忽略`UNREACHABLE`或颠簸的通知事件，我们可以定义如下：
- en: '[PRE25]'
  id: totrans-117
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'The valid directives are slightly different for service objects:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: 对于服务对象，合法的指令稍有不同：
- en: '`w`: Notifications for a service being in the `WARNING` state'
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`w`: 服务处于`WARNING`状态时的通知'
- en: '`u`: Notifications for a service being in the `UNKNOWN` state'
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`u`: 服务处于`UNKNOWN`状态时的通知'
- en: '`c`: Notifications for a service being in the `CRITICAL` state'
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`c`: 服务处于`CRITICAL`状态时的通知'
- en: '`r`: Notifications for a service recovering from problems (becoming `OK`)'
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`r`: 服务从故障中恢复（变为`OK`）时的通知'
- en: '`f`: Notifications for a service beginning or ending a flapping state'
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`f`: 服务开始或结束颠簸状态时的通知'
- en: '`s`: Notifications for a service beginning or ending scheduled downtime'
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`s`: 服务开始或结束计划的停机时间时的通知'
- en: 'For example, for a host that should send notifications for all of these events
    except for flapping and scheduled downtime states, we might define the following:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 例如，对于一个主机，我们希望它为所有这些事件发送通知，但排除波动和计划停机状态，我们可能会定义以下内容：
- en: '[PRE26]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'All of the preceding values can be used in contact object definitions to restrict
    the service notifications a particular contact should receive, through the `service_notification_options`
    directive:'
  id: totrans-127
  prefs: []
  type: TYPE_NORMAL
  zh: 上述所有值可以在联系对象定义中使用，通过`service_notification_options`指令来限制特定联系人应接收的服务通知：
- en: '[PRE27]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: There's more...
  id: totrans-129
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容...
- en: 'Unless we have a specific reason for particular contacts not to accept notifications
    of a particular kind, it''s a good practice to configure contacts to receive all
    notifications that they are sent, by including all the flags in both the directives
    for the contact:'
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: 除非我们有特别的原因让某些联系人不接受某种特定类型的通知，否则最好配置联系人以接收所有发送给他们的通知，通过在联系人指令中包括所有标志：
- en: '[PRE28]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: This means that the contact will process any notification dispatched to it,
    and we can instead restrict the kinds of notifications that are sent out by the
    hosts and services for which this is the delegated contact. With new configurations,
    it is generally better to start by sending too much information, and then removing
    unnecessary notification flags if appropriate, rather than potentially missing
    important messages because they're never sent.
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 这意味着该联系人将处理所有发送给它的通知，我们可以通过限制由该联系人管理的主机和服务发送的通知类型来替代这一点。对于新的配置，通常最好从发送过多的信息开始，然后在适当时删除不必要的通知标志，而不是因为从未发送而错过重要消息。
- en: If we intend to do this for all of our contacts, it may be appropriate to include
    these directives as part of a contact template, and inherit from it using the
    `use` directive. The `generic-contact` contact template included with the default
    configuration may be suitable.
  id: totrans-133
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们打算对所有的联系人执行此操作，可能需要将这些指令作为联系模板的一部分，并通过`use`指令从中继承。默认配置中包含的`generic-contact`联系模板可能适用。
- en: If you want to completely disable notifications for a given host, service, or
    contact, the single value `n` for `notification_options`, `host_notification_options`,
    and `service_notification_options` will do this.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想完全禁用给定主机、服务或联系人的通知，可以为`notification_options`、`host_notification_options`和`service_notification_options`使用单一值`n`来实现。
- en: See also
  id: totrans-135
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Configuring notification for groups*, *Automating contact rotation*, and
    *Defining a custom notification method* recipes in this chapter
  id: totrans-136
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章中的*配置组通知*、*自动化联系人轮换*和*定义自定义通知方法*配方
- en: The *Using inheritance to simplify configuration* recipe in [Chapter 9](ch09.html
    "Chapter 9. Managing Configuration"), *Configuration Management*
  id: totrans-137
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本书中[第9章](ch09.html "第9章。管理配置")的*使用继承简化配置*配方，*配置管理*
- en: Tolerating a certain number of failed checks
  id: totrans-138
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 容忍一定数量的失败检查
- en: In this recipe, we'll learn how to arrange Nagios Core configuration to only
    send notifications about problems with a host or service after a check has been
    repeated a certain number of times and failed each time.
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: 在本配方中，我们将学习如何安排Nagios Core配置，仅在主机或服务的检查失败且重复一定次数后，才发送关于问题的通知。
- en: This can be an ideal arrangement for non-critical hosts that occasionally have
    "blips" or short outages for whatever reason, and only become problematic if they
    remain down after repeated checks.
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: 这对于那些偶尔会出现“波动”或短暂宕机的非关键主机来说是一个理想的配置安排，只有在多次检查后仍然处于宕机状态时才会变得有问题。
- en: Getting ready
  id: totrans-141
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: You should have a Nagios Core 3.0 or newer server, with at least one host configured
    already. We'll use the example of `sparta.naginet`, a host defined in its own
    file. We'll arrange for it to send us notifications only after a total of five
    failed host checks.
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该有一个Nagios Core 3.0或更新版本的服务器，并且已经配置了至少一个主机。我们将使用`sparta.naginet`这个例子，它是一个在其自身文件中定义的主机。我们将安排它仅在进行五次连续失败检查后才向我们发送通知。
- en: How to do it...
  id: totrans-143
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can configure the number of failed checks to tolerate before sending a notification
    as follows:'
  id: totrans-144
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以配置容忍失败检查的次数，然后才发送通知，方法如下：
- en: Change to the `objects` configuration directory for Nagios Core. The default
    path is `/usr/local/nagios/etc/objects`. If you've put the definition for your
    host in a different file, then move to its directory instead.
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到Nagios Core的`objects`配置目录。默认路径是`/usr/local/nagios/etc/objects`。如果你的主机定义在其他文件中，请转到该文件所在的目录。
- en: '[PRE29]'
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'Edit the file containing your host definition, and find the definition within
    it. It may look similar to the following code snippet:'
  id: totrans-147
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机定义的文件，并找到其中的定义。它可能类似于以下代码片段：
- en: '[PRE30]'
  id: totrans-148
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Add or edit the value for `max_check_attempts` to `5`:'
  id: totrans-149
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将`max_check_attempts`的值添加或编辑为`5`：
- en: '[PRE31]'
  id: totrans-150
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-151
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重新启动Nagios Core服务器：
- en: '[PRE32]'
  id: totrans-152
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'With this done, Nagios Core will not send a notification for the host entering
    the `DOWN` state until the check has been attempted a total of five times, and
    has failed each time. In the following screenshot, even though four checks have
    already taken place and failed, no notification has been sent, and the state is
    listed as **SOFT** :'
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此设置后，Nagios Core将在主机进入`DOWN`状态之前，不会发送通知，直到检查已尝试了五次且每次都失败。在以下截图中，尽管已经进行了四次检查并失败，但没有发送通知，并且状态被列为**SOFT**：
- en: '![How to do it...](img/5566_04_01.jpg)'
  id: totrans-154
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作...](img/5566_04_01.jpg)'
- en: The `SOFT` state shows that while Nagios Core has flagged the host as `DOWN`,
    it will retry the check until it exhausts `max_check_attempts`. At this point
    it will flag the host as being in a `HARD` `DOWN` state and send a notification.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: '`SOFT`状态表示，尽管Nagios Core已将主机标记为`DOWN`，它将继续重试检查，直到用尽`max_check_attempts`。此时，它将标记主机为`HARD`
    `DOWN`状态并发送通知。'
- en: 'However, if the host were to come back up before the next check, then the state
    would change back to **UP**, without ever having sent a notification:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，如果主机在下一次检查之前恢复，那么状态将会恢复为**UP**，而不会发送任何通知：
- en: '![How to do it...](img/5566_04_02.jpg)'
  id: totrans-157
  prefs: []
  type: TYPE_IMG
  zh: '![如何操作...](img/5566_04_02.jpg)'
- en: How it works...
  id: totrans-158
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The preceding configuration alters the `max_check_attempts` directive for the
    host to specify the number of checks that need to have failed before the host
    will flag a `HARD` `DOWN` or `UNREACHABLE` state, and generate a notification
    event.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: 前面的配置修改了主机的`max_check_attempts`指令，用于指定在主机标记为`HARD` `DOWN`或`UNREACHABLE`状态并生成通知事件之前，需要失败的检查次数。
- en: 'The process for changing the maximum number of attempts before a notification
    for a service is identical; we add the same directive and value to the definition
    for the service:'
  id: totrans-160
  prefs: []
  type: TYPE_NORMAL
  zh: 更改服务在发送通知之前的最大尝试次数的过程是相同的；我们向服务的定义中添加相同的指令和值：
- en: '[PRE33]'
  id: totrans-161
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: There's more...
  id: totrans-162
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: 'The time between successive retry checks of a host before sending any notification
    can also be customized with the `retry_interval` directive. By default, the interval
    is in minutes, so if we wanted to configure a two-minute wait between retry checks,
    we could add this directive to the host or service:'
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 在发送任何通知之前，主机的连续重试检查之间的时间间隔也可以通过`retry_interval`指令进行自定义。默认情况下，间隔以分钟为单位，因此如果我们想配置两分钟的重试等待时间，可以向主机或服务添加此指令：
- en: '[PRE34]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: See also
  id: totrans-165
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Specifying how frequently to check a host or service* and *Managing brief
    outages with flapping* recipes in [Chapter 3](ch03.html "Chapter 3. Working with
    Checks and States"), *Working with Checks and States*
  id: totrans-166
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第3章](ch03.html "第3章：与检查和状态一起工作")中的*指定检查主机或服务的频率*和*通过抖动管理短期故障*配方，*与检查和状态一起工作*'
- en: Automating contact rotation
  id: totrans-167
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 自动化联系人轮换
- en: In this recipe, we'll learn how to automatically arrange notifications so that
    they are only received by certain contacts in a group at certain times.
  id: totrans-168
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个配方中，我们将学习如何自动安排通知，以便它们仅在特定时间由某些组中的联系人接收。
- en: For companies with more than one person as dedicated network staff, it's a common
    practice to have an on-call roster, where one member of staff will be the dedicated
    on-call person for a certain period of time, perhaps a week or two. The kind of
    setup we'll configure here allows filtering notifications, so that they're only
    delivered to contacts at appropriate times; notifications are generated by hosts
    and services and sent to all the contacts in the nominated group, but only one
    (or perhaps more than one) of the contacts actually receives it.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 对于拥有多名专职网络工作人员的公司，通常会有一个值班名单，某个员工在一定时间内（可能是一周或两周）担任专职值班人员。我们在这里配置的这种设置允许过滤通知，使其仅在适当的时间发送给联系人；通知由主机和服务生成，并发送给指定组中的所有联系人，但实际上只有一个（或者多个）联系人会接收到它。
- en: 'We''ll set this up using two properties of contacts that allow us to restrict
    the time period within which they should receive notifications: `host_notification_period`
    and `service_notification_period`.'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将通过使用联系人属性中的两个设置来完成此配置，允许我们限制他们应接收通知的时间段：`host_notification_period` 和 `service_notification_period`。
- en: Getting ready
  id: totrans-171
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should have a Nagios Core 3.0 or newer server, with at least one contact
    group configured already, with at least two contacts within it. You should be
    familiar with configuring time periods and understand the basics of notifications
    as discussed earlier in this chapter.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 您应该有一个Nagios Core 3.0或更高版本的服务器，并且已经配置了至少一个联系人组，并且该组中至少有两个联系人。您应该熟悉配置时间段，并理解本章前面讨论的通知基础知识。
- en: We'll use the very simple example of three network operators, named as contacts
    `alan`, `brenden`, and `charlotte`, taking turns with monitoring duty every week.
    All three are members of the group `ops`, which is specified in the `contact_groups`
    directive for all of the hosts and services on the network.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用一个非常简单的例子，假设有三个网络运营商，分别命名为联系人`alan`、`brenden`和`charlotte`，他们每周轮流值班监控。三者都是`ops`组的成员，该组在网络上所有主机和服务的`contact_groups`指令中指定。
- en: How to do it...
  id: totrans-174
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can set up a basic alternating schedule for receiving notifications for
    our operators as follows:'
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以为接收通知的操作员设置一个基本的交替时间表，如下所示：
- en: Change to the `objects` configuration directory for Nagios Core. The default
    path is `/usr/local/nagios/etc/objects`. If you've put the definition for your
    host in a different file, move to its directory instead.
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到Nagios Core的`objects`配置目录。默认路径是`/usr/local/nagios/etc/objects`。如果您将主机的定义放在了其他文件中，请转到其目录。
- en: '[PRE35]'
  id: totrans-177
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Check the relevant file or files to ensure your contacts are defined, and that
    they are members of the appropriate contact group. A good location for such information
    is in the `contacts.cfg` file. The configuration might look similar to the following
    code snippet:'
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 检查相关文件或文件，以确保您的联系人已定义，并且他们是适当联系人组的成员。此类信息的一个好位置是在`contacts.cfg`文件中。配置可能看起来类似于以下代码片段：
- en: '[PRE36]'
  id: totrans-179
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'In this case, all our hosts and services are configured to send messages to
    the `ops` contact group:'
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在这种情况下，所有我们的主机和服务都已配置为向`ops`联系人组发送消息：
- en: '[PRE37]'
  id: totrans-181
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'Define time periods to correspond to the times during which each of your contacts
    should be receiving messages. We''ll use the special syntax of time period definitions
    to set up the definitions for this rotation:'
  id: totrans-182
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定义时间段，以对应每个联系人应该接收消息的时间。我们将使用时间段定义的特殊语法来设置这个轮换的定义：
- en: '[PRE38]'
  id: totrans-183
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'Go back and configure each of your contacts with the `host_notification_period`
    and `service_notification_period` directives, to filter notifications to only
    be received during their dedicated time period:'
  id: totrans-184
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 返回并使用`host_notification_period`和`service_notification_period`指令配置每个联系人，以便仅在他们的专用时间段内接收通知：
- en: '[PRE39]'
  id: totrans-185
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重新启动Nagios Core服务器：
- en: '[PRE40]'
  id: totrans-187
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: With this done, the contacts configured should only receive notifications during
    their dedicated pager time. If these are our only contacts, then all the notifications
    generated will go to only one person at any given time.
  id: totrans-188
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此操作后，配置的联系人应该仅在其专用的呼叫器时间内接收通知。如果这些是我们唯一的联系人，那么所有生成的通知将在任何给定时间只发送给一个人。
- en: How it works...
  id: totrans-189
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The `host_notification_period` and `service_notification_period` directives
    in the definitions for our contacts are used to limit the times during which these
    contacts should receive any notifications. Each of our contacts in this example
    has their own time period defined to correspond to their portion of the pager
    schedule.
  id: totrans-190
  prefs: []
  type: TYPE_NORMAL
  zh: 在我们联系人的定义中，`host_notification_period`和`service_notification_period`指令用于限制这些联系人应接收通知的时间段。在这个例子中，我们的每个联系人都有自己定义的时间段，以对应他们在呼叫器时间表中的部分。
- en: 'Let''s take a look at Alan''s example:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 我们来看看Alan的例子：
- en: '[PRE41]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'The second line of the directive, `2012-06-05 / 21 00:00-24:00`, can be broken
    down as follows:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 指令的第二行，`2012-06-05 / 21 00:00-24:00`，可以分解为如下：
- en: Starting from the 5th of June,
  id: totrans-194
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从6月5日开始，
- en: Every 21 days,
  id: totrans-195
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 每21天，
- en: From midnight to the following midnight (i.e., the entire day).
  id: totrans-196
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 从午夜到第二天午夜（即整天）。
- en: The configuration then goes on to do the same for the remaining days of the
    first week Alan will be on call, and specifies that he will be on call the same
    day 21 days (3 weeks) later. A similar configuration, but starting one week and
    two weeks later, is set up for the contacts `brenden` and `charlotte` respectively.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 配置然后继续为Alan值班的第一周的剩余几天做相同的配置，并指定他将在21天（即3周）后的同一天继续值班。对于联系人`brenden`和`charlotte`，分别设置了类似的配置，但分别从一周和两周后开始。
- en: There's more...
  id: totrans-198
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: Note that there's no reason time periods can't overlap. If it happens to suit
    us to arrange for more than one contact to receive a notification, we can do that.
    Similarly, we can leave gaps in the schedule if notifications aren't needed during
    a certain time period.
  id: totrans-199
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，时间段不一定不能重叠。如果我们觉得合适，可以安排多个联系人接收通知。类似地，如果某个时间段内不需要通知，我们也可以在时间表中留出空隙。
- en: Time periods in Nagios Core are highly flexible; to see some examples of the
    various syntaxes you can use for defining them, take a look at the *Creating a
    new time period* recipe in [Chapter 1](ch01.html "Chapter 1. Understanding Hosts,
    Services, and Contacts"), *Understanding Hosts, Services, and Contacts*.
  id: totrans-200
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios Core 中的时间段非常灵活；要查看你可以用来定义它们的各种语法示例，可以参考[第1章](ch01.html "Chapter 1. Understanding
    Hosts, Services, and Contacts")中的*创建新的时间段*教程，*理解主机、服务和联系人*。
- en: See also
  id: totrans-201
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: The *Configuring notification for groups* and *Specifying which states to be
    notified about* recipes in this chapter
  id: totrans-202
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章节中的*配置群组的通知*和*指定要通知的状态*教程
- en: The *Creating a new contact*, *Creating a new contact group*, and *Creating
    a new time period* recipes in [Chapter 1](ch01.html "Chapter 1. Understanding
    Hosts, Services, and Contacts"), *Understanding Hosts, Services, and Contacts*
  id: totrans-203
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第1章](ch01.html "Chapter 1. Understanding Hosts, Services, and Contacts")中的*创建新的联系人*、*创建新的联系人组*和*创建新的时间段*教程，*理解主机、服务和联系人*'
- en: Defining an escalation for repeated notifications
  id: totrans-204
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 为重复通知定义升级
- en: In this recipe, we'll learn how to arrange a Nagios Core configuration such
    that after a certain number of repetitions, notifications for problems on hosts
    or services are escalated to another contact, instead of (or in addition to) the
    normally defined contact. This is done by defining a separate object type called
    a host or service escalation.
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个教程中，我们将学习如何配置 Nagios Core，使得在重复一定次数后，关于主机或服务的故障通知会升级到另一个联系人，而不是（或除了）通常定义的联系人。这是通过定义一个名为主机或服务升级的独立对象类型来实现的。
- en: This kind of setup could be useful to alert more senior networking staff to
    an unresolved problem that a less experienced person is struggling to fix, and
    can also function as a "safety valve" to ensure that problem notifications for
    hosts eventually do reach someone else if they remain unfixed.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 这种配置可能对提醒更资深的网络人员注意一个无法解决的问题非常有用，尤其是在经验较少的人无法解决问题时，也可以作为“安全阀”，确保主机的故障通知最终能传达到其他人那里，若问题依旧未被修复。
- en: Getting ready
  id: totrans-207
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should have a Nagios Core 3.0 or newer server, with at least one host or
    service configured already, and at least two contact groups—one for the first
    few notifications, and one for the escalations. You should understand how notifications
    are generated and sent to the `contacts` and `contact_groups` for hosts or services.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该拥有一个 Nagios Core 3.0 或更新版本的服务器，且已经配置了至少一个主机或服务，并且至少有两个联系人组——一个用于前几次通知，另一个用于升级通知。你应该理解如何生成通知，并将其发送到主机或服务的`contacts`和`contact_groups`。
- en: We'll use the example of a host called `sparta.naginet` which normally sends
    notifications to a group called `ops`. We'll arrange for all of the notifications
    after the fourth one to also be sent to a contact group called `emergency`.
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 我们以名为`sparta.naginet`的主机为例，该主机通常会将通知发送到一个名为`ops`的组。我们将配置使得第四次及以后的所有通知也发送到一个名为`emergency`的联系人组。
- en: How to do it...
  id: totrans-210
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can configure an escalation for our host or service as follows:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以如下配置主机或服务的升级：
- en: Change to the objects configuration directory for Nagios Core. The default is
    `/usr/local/nagios/etc/objects`. If you've put the definition for your host in
    a different file, then move to its directory instead.
  id: totrans-212
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到 Nagios Core 的对象配置目录。默认目录为`/usr/local/nagios/etc/objects`。如果你将主机的定义放在了不同的文件中，则进入其所在的目录。
- en: '[PRE42]'
  id: totrans-213
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'Edit the file containing the definition for the host. The definition might
    look similar to the following code snippet:'
  id: totrans-214
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机定义的文件。该定义可能类似于以下代码片段：
- en: '[PRE43]'
  id: totrans-215
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE43]'
- en: 'Underneath the host definition, add the configuration for a new `hostescalation`
    object:'
  id: totrans-216
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在主机定义下面，添加一个新的`hostescalation`对象的配置：
- en: '[PRE44]'
  id: totrans-217
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-218
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重启 Nagios Core 服务器：
- en: '[PRE45]'
  id: totrans-219
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: With this done, when problems are encountered with the host that generate notifications,
    all the notifications beyond the fifth one will be sent to both the `ops` contact
    group and also to the `emergency` contact group, expanding the number of people
    or systems contacted, to make it more likely the problem will actually be addressed
    or fixed. Perhaps someone on the ops team has misplaced their pager.
  id: totrans-220
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此配置后，当遇到主机问题并生成通知时，超过第五个通知的所有通知将同时发送到`ops`联系组和`emergency`联系组，扩展了接收到通知的人或系统的数量，从而更有可能让问题得到解决或修复。也许ops团队的某个成员把他们的寻呼机弄丢了。
- en: How it works...
  id: totrans-221
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'The configuration added in the preceding section is best thought of as a special
    case or an override for a particular host, in that it specifies a range of notifications
    that should be sent to a different set of contact groups. It can be broken down
    as follows:'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 前面一节中添加的配置最好被看作是针对特定主机的特殊情况或覆盖，因为它指定了一系列应该发送到不同联系组的通知。可以将其分解如下：
- en: '`host_name`: This is the same value of `host_name` given for the host in its
    definition; we specified `sparta.naginet`.'
  id: totrans-223
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`host_name`：这是在主机定义中给定的`host_name`的相同值；我们指定了`sparta.naginet`。'
- en: '`contact_groups`: This is the contact groups to which notifications meeting
    this special case should be sent. We specify both the `emergency` group and the
    `ops` group, so that matching notifications go to both. Note that they are comma-separated.'
  id: totrans-224
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`contact_groups`：这是应该接收满足此特殊情况的通知的联系人组。我们指定了`emergency`组和`ops`组，以便匹配的通知都发送给这两个组。请注意，它们是用逗号分隔的。'
- en: '`first_notification`: This is the count of the first notification that should
    match this escalation; we chose the fifth notification.'
  id: totrans-225
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`first_notification`：这是应该与此升级匹配的第一次通知计数；我们选择了第五次通知。'
- en: '`last_notification`: This is the count of the last notification that should
    match this escalation. We set this to zero, which means that all notifications
    after `first_notification` should be sent to the nominated contact or contact
    groups. The notifications will not stop until they are manually turned off, or
    the problem is fixed.'
  id: totrans-226
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`last_notification`：这是应该与此升级匹配的最后一次通知计数。我们将其设置为零，这意味着`first_notification`之后的所有通知应发送给指定的联系人或联系组。通知将持续发送，直到手动关闭或问题解决。'
- en: '`notification_interval`: Like the host and service directives of the same name,
    this specifies how long Nagios Core should wait before sending new notifications
    if the host remains in a problematic state. Here, we''ve chosen ten minutes.'
  id: totrans-227
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`notification_interval`：与主机和服务的同名指令一样，它指定如果主机仍处于问题状态，Nagios Core应等待多长时间后发送新通知。在这里，我们选择了十分钟。'
- en: Individual contacts can also (or instead) be specified with the `contacts` directive,
    rather than `contact_groups`.
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 个人联系人也可以使用`contacts`指令（或替代）进行指定，而不是使用`contact_groups`。
- en: 'Service escalations work in much the same way; the difference is that you need
    to specify the service by its `service_description` directive as well as its host
    name. Everything else works the same way. A similar escalation for a service check
    with a `service_description` of `HTTP` running on `sparta.naginet` might look
    similar to the following code snippet:'
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 服务升级的工作原理与此相似；不同之处在于，你需要通过`service_description`指令指定服务以及其主机名。其他部分的工作方式相同。一个类似的服务检查升级，`service_description`为`HTTP`，运行在`sparta.naginet`上的代码片段可能如下所示：
- en: '[PRE46]'
  id: totrans-230
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: There's more...
  id: totrans-231
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多...
- en: The preceding escalation continues sending notifications both to the original
    `ops` group and also to the members of the `emergency` group. It's generally a
    good idea to do it this way rather than sending notifications only to the escalated
    group, because the point of escalations is to increase the reach of the notifications
    when a problem is not being dealt with, rather than merely to try contacting a
    different group of people instead.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 前面的升级会继续将通知发送给原始的`ops`组和`emergency`组的成员。通常最好这样做，而不是仅仅将通知发送给升级组，因为升级的目的是在问题没有被处理时扩大通知的覆盖范围，而不是单纯地尝试联系另一组人。
- en: 'This principle applies to stacking escalations, as well; if we had a host group
    with all of our contacts in it, perhaps named `everyone`, we could define a second
    escalation so that the tenth notification onwards goes to every single contact:'
  id: totrans-233
  prefs: []
  type: TYPE_NORMAL
  zh: 这一原则同样适用于堆叠升级；如果我们有一个包含所有联系人主机组，可能名为`everyone`，我们可以定义第二次升级，以便从第十个通知开始，所有通知都发送给每个联系人：
- en: '[PRE47]'
  id: totrans-234
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: Just as we can specify multiple host escalations, it's also fine for the ranges
    of notifications to overlap so that more than one escalation applies.
  id: totrans-235
  prefs: []
  type: TYPE_NORMAL
  zh: 正如我们可以指定多个主机升级一样，通知的范围也可以重叠，这样就可以应用多个升级。
- en: With a little arithmetic, you can arrange escalations such that they work after
    a host or service has been in a problematic state for a certain period of time.
    For example, the escalation we specified in the recipe will apply after the host
    has been in a problem state for 40 minutes, because `notification_interval` specifies
    that Nagios Core should wait for 10 minutes between re-sending notifications.
  id: totrans-236
  prefs: []
  type: TYPE_NORMAL
  zh: 通过一点数学运算，你可以安排升级，使它们在主机或服务处于问题状态一段时间后生效。例如，我们在配方中指定的升级将在主机处于问题状态40分钟后应用，因为 `notification_interval`
    指定 Nagios Core 应该在重新发送通知之间等待10分钟。
- en: See also
  id: totrans-237
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 参见
- en: The *Configuring notifications for groups* recipe in this chapter
  id: totrans-238
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章中的 *配置组的通知* 配方
- en: The *Creating a new contact group* recipe in [Chapter 1](ch01.html "Chapter 1. Understanding
    Hosts, Services, and Contacts"), *Understanding Hosts, Services, and Contacts*
  id: totrans-239
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在[第1章](ch01.html "第1章：理解主机、服务和联系人")中，*创建新的联系人组* 配方，*理解主机、服务和联系人*
- en: Defining a custom notification method
  id: totrans-240
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 定义一个自定义通知方法
- en: In this recipe, we'll learn how to specify an alternative method for a contact
    to receive notifications about a service. A very typical method for a contact
    to receive notifications is by sending an e-mail to their contact address; e-mail
    messages could be sent to an inbox or a paging device.
  id: totrans-241
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个配方中，我们将学习如何为联系人指定一种替代方法，以便接收有关服务的通知。联系人接收通知的一种非常典型的方法是通过电子邮件发送到他们的联系地址；电子邮件消息可以发送到收件箱或分页设备。
- en: However, notifications are just text; we can arrange to deal with them via any
    command we wish, in much the same way as we can configure host or service checks.
    In this recipe, we'll set up a new contact called `motd`, which when it receives
    notifications will write them into the server's `/etc/motd` directory to be displayed
    on login.
  id: totrans-242
  prefs: []
  type: TYPE_NORMAL
  zh: 然而，通知仅仅是文本；我们可以像配置主机或服务检查一样，通过任何我们希望的命令来处理它们。在这个配方中，我们将设置一个名为 `motd` 的新联系人，当它接收到通知时，会将通知写入服务器的
    `/etc/motd` 目录，以便在登录时显示。
- en: Getting ready
  id: totrans-243
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: You should have a Nagios Core 3.0 or newer server, with at least one host or
    service configured already. You should understand how notifications are generated
    and their default behavior in being sent to the `contacts` and `contact_groups`
    for hosts or services.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 你应该拥有一个 Nagios Core 3.0 或更高版本的服务器，并且至少已经配置了一个主机或服务。你需要了解通知是如何生成的，并且理解它们默认的行为是如何发送到主机或服务的
    `contacts` 和 `contact_groups`。
- en: We'll use the example of a host called `troy.naginet`, configured to send notifications
    to the `ops` contact group. We'll add a new contact within this group called `motd`.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用一个名为 `troy.naginet` 的主机示例，该主机配置为将通知发送到 `ops` 联系人组。我们将在这个组中添加一个名为 `motd`
    的新联系人。
- en: How to do it...
  id: totrans-246
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'We can arrange our custom notification method as follows:'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以如下安排我们的自定义通知方法：
- en: 'Ensure that your `/etc/motd` file can be written to by Nagios Core, and that
    it''s a static file that your system will not overwrite on boot. If you run your
    Nagios Core server as the recommended default user and group of `nagios`, you
    could do something similar to the following:'
  id: totrans-248
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 确保你的 `/etc/motd` 文件可以被 Nagios Core 写入，并且它是一个静态文件，系统在启动时不会覆盖该文件。如果你以推荐的默认用户和组
    `nagios` 运行 Nagios Core 服务器，可以像下面这样操作：
- en: '[PRE48]'
  id: totrans-249
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'It would be a good idea to test that the user can write to the file using `su`
    or `sudo`:'
  id: totrans-250
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过 `su` 或 `sudo` 测试用户是否能够写入该文件会是个好主意：
- en: '[PRE49]'
  id: totrans-251
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: Change to the `objects` configuration directory for Nagios Core. The default
    path is `/usr/local/nagios/etc/objects`. If you've put the definition for your
    host in a different file, then move to its directory instead.
  id: totrans-252
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 切换到 Nagios Core 的 `objects` 配置目录。默认路径是 `/usr/local/nagios/etc/objects`。如果你将主机的定义放在了其他文件中，那么请转到该文件所在的目录。
- en: '[PRE50]'
  id: totrans-253
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: 'Edit the file containing the definitions for your notification commands. By
    default, this is in the file `commands.cfg`. Append the following definitions
    to the file:'
  id: totrans-254
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含通知命令定义的文件。默认情况下，这些定义在 `commands.cfg` 文件中。将以下定义附加到该文件：
- en: '[PRE51]'
  id: totrans-255
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'Edit the file containing the definitions for your contacts. In the QuickStart
    configuration, this is in the file `contacts.cfg`. Append the following definitions
    to the file:'
  id: totrans-256
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含联系人定义的文件。在 QuickStart 配置中，这些定义在 `contacts.cfg` 文件中。将以下定义附加到该文件：
- en: '[PRE52]'
  id: totrans-257
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'Edit the file containing the definitions for your host and/or services, to
    ensure that they specify `ops` in their `contact_groups` directives:'
  id: totrans-258
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 编辑包含主机和/或服务定义的文件，确保它们在 `contact_groups` 指令中指定了 `ops`：
- en: '[PRE53]'
  id: totrans-259
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'Validate the configuration and restart the Nagios Core server:'
  id: totrans-260
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证配置并重启 Nagios Core 服务器：
- en: '[PRE54]'
  id: totrans-261
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE54]'
- en: 'With this done, the next notifications that go out for the host and services
    should not only be e-mailed to any contacts in the `ops` group, but should also
    be written by the `motd` contact to `/etc/motd`, to be presented on login:'
  id: totrans-262
  prefs: []
  type: TYPE_NORMAL
  zh: 完成此操作后，接下来的主机和服务通知不仅应通过电子邮件发送给 `ops` 组中的任何联系人，还应由 `motd` 联系人写入 `/etc/motd`，以便在登录时显示：
- en: '[PRE55]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: How it works...
  id: totrans-264
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The first part of the configuration that we added is defining new notification
    commands. These are actually command definitions, just the same as those used
    with the `check_command` definitions for hosts and services; the difference is
    that they're used by contacts to send notifications to people (or in this case,
    write them to files) in the appropriate way.
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 我们添加的配置的第一部分是定义新的通知命令。这些实际上是命令定义，就像用于主机和服务的 `check_command` 定义一样；区别在于，它们被联系人用于将通知发送给相关人员（或在这种情况下，将通知写入文件）以适当的方式。
- en: 'If you''re using the default Nagios Core configuration, the commands already
    defined in `commands.cfg` should include `notify-host-by-email` and `notify-service-by-email`.
    I''ve truncated the complete command line as it''s very long:'
  id: totrans-266
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你使用的是默认的 Nagios Core 配置，`commands.cfg` 中已经定义的命令应包括 `notify-host-by-email`
    和 `notify-service-by-email`。我已经截断了完整的命令行，因为它非常长：
- en: '[PRE56]'
  id: totrans-267
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: These commands use the system `printf` implementation along with many Nagios
    Core macros to build an appropriate notification string, which is e-mailed to
    the appropriate contact using a shell pipe into the system mailer.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 这些命令使用系统的 `printf` 实现，并结合许多 Nagios Core 宏来构建适当的通知字符串，该字符串通过 shell 管道发送到系统邮件程序并通过电子邮件发送给适当的联系人。
- en: 'If we inspect the `templates.cfg` file where the `generic-contact` template
    is defined, we can see these methods are referred to in two directives:'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 如果我们检查定义了 `generic-contact` 模板的 `templates.cfg` 文件，我们可以看到这两个方法在两个指令中被引用：
- en: '[PRE57]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: This configuration thus defines a particular notification command to be used
    for hosts that derive from the `generic-host` template.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 该配置因此定义了一个特定的通知命令，供从 `generic-host` 模板派生的主机使用。
- en: Our own command definition does something similar in building a string with
    a call to `printf`. But instead of writing the output into a pipe to the system
    mailer, it appends it to the `/etc/motd` file.
  id: totrans-272
  prefs: []
  type: TYPE_NORMAL
  zh: 我们自己的命令定义类似地通过调用 `printf` 来构建字符串。但不同的是，它不是将输出写入管道发送到系统邮件程序，而是将其附加到 `/etc/motd`
    文件中。
- en: 'The `command_line` directive that we specified for the `motd` contact to process
    host notifications is as follows:'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 我们为 `motd` 联系人处理主机通知所指定的 `command_line` 指令如下：
- en: '[PRE58]'
  id: totrans-274
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'The first thing Nagios Core does when a notification event for this contact
    is successfully fired is substitute values for its macros, `$SHORTDATETIME$`,
    `$HOSTALIAS$`, and `$HOSTSTATE$`:'
  id: totrans-275
  prefs: []
  type: TYPE_NORMAL
  zh: Nagios Core 在成功触发该联系人的通知事件时，首先会替换它的宏值，`$SHORTDATETIME$`、`$HOSTALIAS$` 和 `$HOSTSTATE$`：
- en: '[PRE59]'
  id: totrans-276
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: The resulting string is then executed as a command by the running Nagios Core
    user, by default `nagios`, and providing that user has the appropriate permissions,
    it's appended to the end of the MOTD.
  id: totrans-277
  prefs: []
  type: TYPE_NORMAL
  zh: 生成的字符串随后由正在运行的 Nagios Core 用户（默认为 `nagios`）作为命令执行，只要该用户具有适当的权限，它将被附加到 MOTD 的末尾。
- en: There's more...
  id: totrans-278
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容...
- en: 'Adding messages to the MOTD may not be useful for all network administrators,
    particularly for larger or more sensitive networks, for which hundreds of notifications
    could be generated daily. The main thing to take away from this is that Nagios
    Core can be configured to process notification events in pretty much any way,
    provided:'
  id: totrans-279
  prefs: []
  type: TYPE_NORMAL
  zh: 向 MOTD 添加消息对于所有网络管理员来说可能没有用，特别是对于大型或更敏感的网络，因为这些网络每天可能会生成数百个通知。这里需要记住的主要内容是，Nagios
    Core 可以根据需要配置为处理通知事件，只要：
- en: We can define a command line that will consistently do what is needed with what
    the results of the macro substitution Nagios Core will perform for us
  id: totrans-280
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 我们可以定义一个命令行，确保它在执行时能始终按照 Nagios Core 为我们执行宏替换的结果完成所需的操作
- en: The `nagios` user, or whichever user as which the Nagios Core server is running,
    has all the relevant permissions it needs to run the command
  id: totrans-281
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`nagios` 用户，或者说 Nagios Core 服务器运行的用户，拥有执行该命令所需的所有相关权限'
- en: E-mail notifications, particularly to a mobile paging device, are a very sensible
    basis for notifications for most administrators. However, if some other means
    of notification is needed, such as inserting into a database or piping into a
    Perl script, it is possible to do this as well.
  id: totrans-282
  prefs: []
  type: TYPE_NORMAL
  zh: 电子邮件通知，特别是发送到移动分页设备，对于大多数管理员来说，是一个非常合理的通知基础。然而，如果需要其他通知方式，例如插入数据库或管道传递到Perl脚本中，这也是可以实现的。
- en: Note that it's safest to specify the full paths to any binaries or file we use
    in these commands, hence `/usr/bin/printf` rather than merely `printf`. This is
    to ensure that the program we actually intend to run is run, and avoids having
    to mess about with the `$PATH` specifications for the `nagios` user.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，最好为我们在这些命令中使用的任何二进制文件或文件指定完整路径，因此使用`/usr/bin/printf`而不仅仅是`printf`。这样可以确保我们实际打算运行的程序被正确运行，并避免需要处理`nagios`用户的`$PATH`配置。
- en: See also
  id: totrans-284
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: The *Configuring notifications for groups* recipe in this chapter
  id: totrans-285
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 本章中的*为组配置通知*教程
- en: The *Creating a new command* and *Customizing an existing command* recipes in
    [Chapter 2](ch02.html "Chapter 2. Working with Commands and Plugins"), *Working
    with Commands and Plugins*
  id: totrans-286
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第二章](ch02.html "第二章：使用命令和插件")中的*创建新命令*和*自定义现有命令*教程，*使用命令和插件*'
