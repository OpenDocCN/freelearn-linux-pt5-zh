<html><head></head><body><div><div><div><div><h1 class="title"><a id="ch12"/>Chapter 12. Setting Up an E-mail Server</h1></div></div></div><p>In this chapter, we will cover:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Setting up your server to send and receive e-mails</li><li class="listitem" style="list-style-type: disc">Setting up secure IMAP access to mailboxes</li><li class="listitem" style="list-style-type: disc">Setting up a secure SMTP relay for users</li><li class="listitem" style="list-style-type: disc">Controlling the mail queue</li><li class="listitem" style="list-style-type: disc">Reading and writing e-mails on the server</li><li class="listitem" style="list-style-type: disc">Configuring e-mail aliases</li><li class="listitem" style="list-style-type: disc">Filtering incoming mail using Procmail and SpamAssassin</li><li class="listitem" style="list-style-type: disc">Debugging e-mail-related problems</li></ul></div><div><div><div><div><h1 class="title"><a id="ch12lvl1sec130"/>Introduction</h1></div></div></div><p>E-mail <a id="id910" class="indexterm"/>is a standard means of communication on the Internet. As a way to send messages to anyone in the world, instantly and for free, it became one of the first killer features of the Internet and a harbinger of many things to come.</p><p>E-mail is an old technology, designed in the early, naive days of the Internet. Initially, every mail server accepted all messages from anyone and forwarded them on to any destination. E-mail accounts were protected by passwords, but those were symbolic—sent as plain text over unencrypted connections, and the word, "spam" was still associated mainly with the <a id="id911" class="indexterm"/>Monty Python sketches.</p><p>Unfortunately, as more and more people came online, many malicious users started to abuse the e-mail system. E-mail became a free way to send marketing information with the ability to reach every person on the planet. This caused an explosion of unwanted e-mail messages, most commonly called <a id="id912" class="indexterm"/>
<strong>spam</strong>, which, at its peak, made up more than 95 percent of e-mail traffic. These days, the problem is slowly subsiding as administrators valiantly fight against the spam tide. On a properly configured system, spam is no longer the nuisance it once was, but there is no single foolproof solution. If you decide to host your own mail server, be aware that you will have to put in a substantial bit of work to get everything working properly.</p><div><div><h3 class="title"><a id="tip129"/>Tip</h3><p>You may decide to let someone else host mail for your domain. For example, Google<a id="id913" class="indexterm"/> provides a commercial version of its Gmail service<a id="id914" class="indexterm"/> to businesses as Google Apps for Business. Many companies offer similar services.</p></div></div><p>Because e-mail is such a complex topic, one book chapter will only get you started. If you follow these recipes, you will end up with a working, but very basic, e-mail system. If e-mail is important to your enterprise, you should proceed to read other material on this topic. There is a benefit of starting here, as we will demonstrate how helpful Webmin can be in administering a mail server.</p><p>In this chapter, we will set up <a id="id915" class="indexterm"/>Postfix, a popular open source mail transfer agent. Its alternatives, such as<a id="id916" class="indexterm"/> exim and <a id="id917" class="indexterm"/>sendmail, are also supported by Webmin but are not covered here.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec131"/>Setting up your server to send and receive e-mails</h1></div></div></div><p>To handle e-mail, your server needs to run a service called a <strong>Mail Transfer Agent</strong> (<strong>MTA</strong>) that is <a id="id918" class="indexterm"/>capable of:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Receiving incoming e-mail and placing it in the user's local mail spool</li><li class="listitem" style="list-style-type: disc">Sending e-mail to other MTAs for delivery to users on remote systems</li></ul></div><p>MTAs <a id="id919" class="indexterm"/>exchange messages using <a id="id920" class="indexterm"/>
<strong>Simple Mail Transfer Protocol</strong> (<strong>SMTP</strong>). A mail server listens for <a id="id921" class="indexterm"/>connections on port 25 and accepts incoming <a id="id922" class="indexterm"/>e-mail messages from anywhere on the <a id="id923" class="indexterm"/>Internet. If the message is <a id="id924" class="indexterm"/>addressed to a valid local address, it should be delivered to the destination mailbox.</p><p>When a user of our server decides to send an e-mail, the MTA picks up the message, checks where it is addressed to, and forwards it to the MTA associated with the destination domain.</p><div><div><h3 class="title"><a id="note85"/>Note</h3><p>MTAs can also relay e-mails—forward e-mails coming in over SMTP but bound for other destinations. This is discussed in the <em>Setting up a secure SMTP relay for users</em> recipe later in this chapter.</p></div></div><p>In this recipe, we will set up the<a id="id925" class="indexterm"/> Postfix mail transfer agent on your server.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec432"/>Getting ready</h2></div></div></div><p>E-mail addresses are based on the following structure: <code class="literal">mailbox@fqdn</code>, where <code class="literal">mailbox</code> uniquely identifies a user or alias and <code class="literal">fqdn</code> uniquely identifies a mail system through a <a id="id926" class="indexterm"/>fully qualified domain name (FQDN). You will need to assign an FQDN to your server in order to make use of the e-mail system.</p><div><div><h3 class="title"><a id="tip130"/>Tip</h3><p>To make sure that your server is assigned an FQDN, check that your domain's DNS A or MX (Mail eXchange)<a id="id927" class="indexterm"/> record points to the IP of your mail server. A DNS MX record allows you to host mail on a machine other than the one indicated by the basic A record.</p></div></div><p>Throughout this<a id="id928" class="indexterm"/> recipe, <a id="id929" class="indexterm"/>we will assume that your server's FQDN is <code class="literal">mailserver.example.com</code>, which<a id="id930" class="indexterm"/> makes <code class="literal">mailserver</code> its <a id="id931" class="indexterm"/>hostname and <code class="literal">example.com</code> its domain. Replace these with your real values.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec433"/>How to do it...</h2></div></div></div><p>Follow these steps to set up <a id="id932" class="indexterm"/>Postfix<a id="id933" class="indexterm"/> on your server:</p><div><ol class="orderedlist arabic"><li class="listitem">Follow the instructions contained in the <em>Installing software packages</em> recipe from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System</em>, and install the <code class="literal">postfix</code> package for your system. <div><div><h3 class="title"><a id="note86"/>Note</h3><p>A system can have only one MTA installed at any time. If another MTA was installed on your system, you will need to uninstall it. If you're installing from a system package, this should be done automatically.</p></div></div></li><li class="listitem">To receive mail, your server will need to answer incoming SMTP connections on TCP port 25. Follow the steps described in the <em>Allowing access to a service through the firewall</em> recipe in <a class="link" href="ch03.html" title="Chapter 3. Securing Your System">Chapter 3</a>, <em>Securing Your System</em>, to allow incoming TCP traffic to port <code class="literal">25</code> through your firewall.</li><li class="listitem">Navigate to <strong>System</strong> | <strong>Bootup and Shutdown</strong>, check the box next to <code class="literal">postfix</code>, and click the <strong>Start Now and On Boot</strong> button.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>General Options</strong>.</li><li class="listitem">Set <strong>What domain to use in outbound mail</strong> to <strong>Use domainname</strong>.</li><li class="listitem">Set <strong>What domains to receive mail for</strong> to <strong>Whole domain</strong>.</li><li class="listitem">Set <strong>Internet hostname of this mail system</strong> to <code class="literal">mailserver.example.com</code>.</li><li class="listitem">Set <strong>Local internet domain name</strong> to <strong>Default</strong>. This sets the mail domain to the hostname without the first component. In our case, this would be <code class="literal">example.com</code>.</li><li class="listitem">Set <strong>Network interfaces for receiving mail</strong> to <strong>All</strong>.</li><li class="listitem">Click the <strong>Save and Apply</strong> button.</li><li class="listitem">Click the <strong>Stop Postfix</strong> <a id="id934" class="indexterm"/>and then the <strong>Start Postfix</strong> buttons to <a id="id935" class="indexterm"/>restart the mail system.</li></ol></div><p>Your system should<a id="id936" class="indexterm"/> now be able to send and receive e-mail messages. Test <a id="id937" class="indexterm"/>the ability of the server to <a id="id938" class="indexterm"/>send e-mail, and its ability to receive it, by following the <a id="id939" class="indexterm"/>steps in the <em>Debugging e-mail related problems</em> recipe later in this chapter.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec434"/>How it works...</h2></div></div></div><p>In this recipe, we installed the popular open source MTA called Postfix on your system. In order to receive mail, we opened port 25 in your firewall, and we also made sure that the service is started during system boot.</p><p>We then proceeded to configure the mail system's basic settings. Postfix keeps settings in a text file located in the path <code class="literal">/etc/postfix/main.cf</code>. Posfix's default configuration is very close to what a working system requires, so we only needed to specify which domain we are going to handle mail for and instruct Postfix to listen for connections on all network interfaces.</p><p>More information about each setting we modified is available in Webmin. Just click the label of any form field to get a detailed description.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec435"/>See also</h2></div></div></div><p>Now that you have gotten your feet wet, you should probably read all recipes in this chapter:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">In particular, take a look at the <em>Debugging e-mail related problems</em> recipe</li><li class="listitem" style="list-style-type: disc">To allow users to pick up e-mail from your server, refer to the recipe, <em>Setting up secure IMAP access to mailboxes</em></li><li class="listitem" style="list-style-type: disc">To allow users to send e-mails through your system, refer to the recipe, <em>Setting up a secure SMTP relay for users</em></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec132"/>Setting up secure IMAP access to mailboxes</h1></div></div></div><p>Mail received by your<a id="id940" class="indexterm"/> MTA is delivered to a queue directory on your server. Recipients are expected to pick up messages from here and store them in their own mailboxes. If users connect to your server by SSH, they may use terminal applications such as <code class="literal">mutt</code> or <code class="literal">alpine</code> and store messages in their home directories. Another access method you can provide is a web mail application such as <a id="id941" class="indexterm"/>Roundcube, which runs on Apache with PHP. Webmin's companion product, Usermin, also provides basic mail functionality for users. See the <em>Installing Usermin</em> <a id="id942" class="indexterm"/>recipe in <a class="link" href="ch02.html" title="Chapter 2. User Management">Chapter 2</a>, <em>User Management</em>, for more information.</p><div><div><h3 class="title"><a id="tip131"/>Tip</h3><p>You can find <a id="id943" class="indexterm"/>more information on each of these programs online, but most system distributions offer convenient packages, which make installation very easy:</p><p>Roundcube: <a class="ulink" href="http://www.roundcube.net">http://www.roundcube.net</a>
</p><p>Alpine, the successor <a id="id944" class="indexterm"/>to Pine: <a class="ulink" href="https://www.washington.edu/alpine/">https://www.washington.edu/alpine/</a>
</p><p>Mutt: <a class="ulink" href="http://www.mutt.org">http://www.mutt.org</a>
</p></div></div><p>The standard method of picking up e-mail, however, is to use a<a id="id945" class="indexterm"/> <strong>Mail User Agent</strong> (<strong>MUA</strong>), more commonly referred to as an e-mail client or e-mail reader. Programs such as Thunderbird, KMail, Evolution, Apple Mail, Outlook, and many others, serve this role for desktop users. These programs expect to talk to your server using the<a id="id946" class="indexterm"/> IMAP, <a id="id947" class="indexterm"/>POP3, and SMTP<a id="id948" class="indexterm"/> protocols.</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Protocol</p>
</th><th style="text-align: left" valign="bottom">
<p>Function</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>POP3</p>
</td><td style="text-align: left" valign="top">
<p>Used to pick up messages from the server by downloading the entire mailbox.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>IMAP</p>
</td><td style="text-align: left" valign="top">
<p>Used to download new mail and manages message on the server.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>SMTP</p>
</td><td style="text-align: left" valign="top">
<p>Used to submit mail for delivery to others.</p>
</td></tr></tbody></table></div><p>In this recipe, we'll demonstrate how to set up IMAP access to your Postfix server using a companion server named <a id="id949" class="indexterm"/>Dovecot. We'll make sure that access is secured using a TLS encrypted connection. In the next recipe, <em>Setting up a secure SMTP relay for users</em>, we'll demonstrate setting up SMTP.</p><div><div><h3 class="title"><a id="note87"/>Note</h3><p>The POP3 protocol is becoming obsolete, so in this recipe, we'll focus on IMAP. If you need it, enabling POP3 using the described software is simple.</p></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec436"/>Getting ready</h2></div></div></div><p>In this recipe, we're building on basic Postfix MTA setup described in <em>Setting up your server to send and receive e-mails</em>. Make sure your Postfix is working properly before starting with this recipe.</p><p>We will need to know the location of your Postfix mail queue directory. Check it by following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>General Options</strong>.</li><li class="listitem">Make a note of the <strong>Mail queue directory</strong> value.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec437"/>How to do it...</h2></div></div></div><p>Follow these steps to set up the <a id="id950" class="indexterm"/>Dovecot IMAP service:</p><div><ol class="orderedlist arabic"><li class="listitem">Follow the <a id="id951" class="indexterm"/>instructions contained in the <em>Installing software packages</em>recipe from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System,</em> and install Dovecot Version 2. The package should be named <code class="literal">dovecot</code>, but on some (Debian-based) systems you may need to install a number of smaller packages such as <code class="literal">dovecot-common</code>, <code class="literal">dovecot-imapd</code>, and optionally, <code class="literal">dovecot-pop3d</code>.</li><li class="listitem">Your server will need to answer incoming IMAP connections on TCP ports 143 and 993. Follow the steps described in the <em>Allowing access to a service through the firewall</em>recipe in <a class="link" href="ch03.html" title="Chapter 3. Securing Your System">Chapter 3</a>, <em>Securing Your System,</em> to allow incoming TCP traffic to ports <code class="literal">143 </code>and <code class="literal">993</code> through your firewall.</li><li class="listitem">Navigate to <strong>System</strong> | <strong>Bootup and Shutdown</strong>, check the box next to <code class="literal">dovecot</code>, and click the <strong>Start Now and On Boot</strong> button.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Dovecot IMAP/POP3 Server</strong> | <strong>Networking and Protocols</strong>.</li><li class="listitem">In the <strong>Serve mail protocols,</strong> select <strong>IMAP</strong>.</li><li class="listitem">Click <strong>Save</strong>.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Dovecot IMAP/POP3 Server</strong> | <strong>Mail Files</strong>.</li><li class="listitem">Set mail location and reading options to <strong>Other Dovecot</strong> location, and enter a string based on the location of your Postfix mail queue directory. For example, if the location is <code class="literal">/var/spool/postfix</code>, enter the following:<div><pre class="programlisting">mbox:~/mail:INBOX=/var/spool/postfix/%u</pre></div></li><li class="listitem">Set <strong>UIDL format</strong> to <strong>Other</strong>, and enter <code class="literal">%08Xu%08Xv</code> in the text field.</li><li class="listitem">Click <strong>Save</strong>.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Dovecot IMAP/POP3 Server</strong> | <strong>SSL Configuration</strong>.</li><li class="listitem">Set <strong>Disallow plaintext authentication in non-SSL mode?</strong> to <strong>Yes</strong>.</li><li class="listitem">Click <strong>Save</strong>.</li><li class="listitem">Click the <strong>Apply Configuration</strong> button.</li></ol></div><p>Users will now be able to connect to your server to receive mail via IMAP. Test the configuration by creating an account in your e-mail client program with the following settings:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>IMAP server</strong>: The hostname of your mail server</li><li class="listitem" style="list-style-type: disc"><strong>Port</strong>: <code class="literal">143</code> or <code class="literal">993</code></li><li class="listitem" style="list-style-type: disc"><strong>Require SSL</strong>: <strong>Yes</strong></li><li class="listitem" style="list-style-type: disc"><strong>Username</strong>: Your system username</li><li class="listitem" style="list-style-type: disc"><strong>Password</strong>: Your system password<div><div><h3 class="title"><a id="tip132"/>Tip</h3><p>If you're having trouble connecting, look for debugging information in your server's mail log. If you see an error message resembling <code class="literal">Operation not permitted (egid=500(username), group based on /var/spool/mail/username)</code>, then you will need to change the group permissions of files in your mail spool directory. You can do that by issuing the following command:</p><div><pre class="programlisting">
<strong>$ sudo find /var/spool/mail -type f -execchmod 0600 '{}' \; -print</strong>
</pre></div><p>Paste the error messages you encounter into a search engine to find resolutions of other problems.</p></div></div></li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec438"/>How it works...</h2></div></div></div><p>Dovecot <a id="id952" class="indexterm"/>was <a id="id953" class="indexterm"/>designed to be secure and easy to configure. During installation, it generates a self-signed SSL certificate to encrypt communication with clients. This is very important because without encryption, your system username and password travels in plain text throughout the Internet and may be read by every ISP along the way. E-mail clients will complain that no recognized certificate authority signed your certificate. You may purchase a signed certificate and replace the self-signed certificate that Dovecot generated to get rid of these error messages. Take a look at the <em>There's more</em> section for more information.</p><p>Dovecot listens for IMAP connections on ports 143 or 993. Traditionally, port 143 was used for unencrypted IMAP connections and port 993 for SSL/TLS encrypted connections. Dovecot allows both ports to use encryption; in fact, we specifically instructed it to reject authentication attempts in non-SSL mode. Leaving both ports open makes it easier for users to configure their e-mail clients, which attempt to guess IMAP ports.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec439"/>There's more...</h2></div></div></div><p>Professional e-mail services use commercially signed SSL certificates. To replace your certificate<a id="id954" class="indexterm"/>, follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Upload your purchased certificate, private key, and the certificate of your certificate authority to a folder on your server.</li><li class="listitem">Make sure that the private key is protected and not readable by users other than root.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Dovecot IMAP/POP3 Server</strong> | <strong>SSL Configuration</strong>.</li><li class="listitem">Specify the paths to each of the uploaded files in the text fields labeled <strong>SSL certificate file</strong>, <strong>SSL private key file</strong>, and <strong>SSL CA certificate file</strong>.</li><li class="listitem">If your key is password protected, enter the password in the <strong>Password for key file</strong> field.</li><li class="listitem">Click the <strong>Save</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec440"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">For more information about working with SSL certificates, take a look at the <em>Setting up encrypted websites with SSL</em> recipe in <a class="link" href="ch08.html" title="Chapter 8. Running an Apache Web Server">Chapter 8</a>, <em>Running an Apache Web Server.</em></li><li class="listitem" style="list-style-type: disc">Your users will need to send e-mail through your server via SMTP. Take a look at the next recipe, <em>Setting up a secure SMTP relay for users</em>, for information about that.</li><li class="listitem" style="list-style-type: disc">As with every recipe in this chapter, if you run into problems, take a look at the <em>Debugging e-mail-related problems</em> recipe in this chapter.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec133"/>Setting up a secure SMTP relay for users</h1></div></div></div><p>Users who employ a mail <a id="id955" class="indexterm"/>client program will want to send messages<a id="id956" class="indexterm"/> through your server using the SMTP protocol. Since we set up an MTA, your server already supports SMTP connections, but only to receive e-mail destined for your domain. Messages submitted anonymously for destinations other than your domain should be rejected. Otherwise, we would create a so-called <a id="id957" class="indexterm"/>
<strong>open relay</strong>, and spammers would quickly abuse your server. Anti-spam filters would then put your server on blacklists, and other mail servers would stop accepting messages from your users.</p><p>In order to avoid creating an open relay, and yet allow remote users to send mail to other domains, we need to require user authentication. We will allow authenticated users to submit mail bound for any domain but reject outbound mail submitted anonymously.</p><p>The SMTP protocol supports a method of authentication called <strong>Simple Authentication and Security Layer</strong> (<strong>SASL</strong>), which allows users to<a id="id958" class="indexterm"/> specify their username and password before submitting e-mail.</p><p>In this recipe, we will use a combination of Postfix and Dovecot to set up SASL authentication for your SMTP server. Sensitive information should not be sent using an unencrypted connection, so we will also provide a layer of TLS encryption for SMTP connections.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec441"/>Getting ready</h2></div></div></div><p>This recipe builds on the groundwork performed in the previous recipes, <em>Setting up your server to send and receive e-mails</em> and <em>Setting up secure IMAP access to mailboxes</em>. Make sure your Postfix and Dovecot are working properly before starting with this recipe.</p><p>We will need to know the name of your Postfix user name and group. Check it by following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>General Options</strong>.</li><li class="listitem">Make a note of the <strong>Mail owner</strong> value; this is the Postfix user name.</li><li class="listitem">Navigate to <strong>System</strong> | <strong>Users and Groups</strong>, and check the primary group of this user.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec442"/>How to do it...</h2></div></div></div><p>Follow these <a id="id959" class="indexterm"/>steps to <a id="id960" class="indexterm"/>set up a secure SMTP relay for your users:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>SMTP Authentication And Encryption</strong>.</li><li class="listitem">Set <strong>Require SASL SMTP authentication?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Disallow SASL</strong> <strong>authentication over insecure connections?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Handle non-compliant SMTP clients?</strong> to <strong>Yes</strong>.</li><li class="listitem">Under <strong>SMTP security options</strong>, check the box labeled <strong>Reject anonymous logins</strong>.</li><li class="listitem">Under <strong>SMTP relaying restrictions</strong>, check the boxes marked as follows:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>Allow connections from same network</strong></li><li class="listitem" style="list-style-type: disc"><strong>Allow authenticated clients</strong></li><li class="listitem" style="list-style-type: disc"><strong>Reject email to other domains</strong></li></ul></div></li><li class="listitem">Set <strong>Enable TLS encryption?</strong> to <strong>If requested by client</strong>.</li><li class="listitem">You should use the same SSL certificates that the Dovecot server uses. Provide a path to your <strong>TLS certificate file</strong>, <strong>TLS private key file</strong>, and optionally to your <strong>TLS certificate authority file</strong>:<div><img src="img/5849OS_12_01.jpg" alt="How to do it..."/></div></li><li class="listitem">Click <a id="id961" class="indexterm"/><strong>Save and Apply</strong>.</li><li class="listitem">Navigate<a id="id962" class="indexterm"/> to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Edit Config Files</strong>.</li><li class="listitem">Select <code class="literal">main.cf</code> from the <strong>Edit config file</strong> dropdown.</li><li class="listitem">Click the <strong>Edit</strong> button.</li><li class="listitem">Scroll down to the end of the configuration file, and add the following settings:<div><pre class="programlisting">smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth</pre></div></li><li class="listitem">Click <strong>Save</strong>.</li><li class="listitem">Navigate to <a id="id963" class="indexterm"/><strong>Servers</strong> | <strong>Dovecot IMAP/POP3</strong> <strong>Server</strong> | <strong>Edit Config Files</strong>.</li><li class="listitem">Select <code class="literal">10-master.conf</code> from the <strong>Edit config</strong> file dropdown.</li><li class="listitem">Click the <strong>Edit</strong> button.</li><li class="listitem">Find the configuration section for the <code class="literal">auth</code> service, and uncomment lines related to the socket. Specify the username and group name of your Postfix user. The section should look something like the following code when finished:<div><pre class="programlisting">service auth
{
...
  # Postfix smtp-auth
  unix_listener /var/spool/postfix/private/auth
  {
    mode = 0660
    user = postfix
    group = postfix
  }
...
}</pre></div><div><img src="img/5849OS_12_02.jpg" alt="How to do it..."/></div></li><li class="listitem">Click <strong>Save</strong>.</li><li class="listitem">Click the <a id="id964" class="indexterm"/><strong>Stop Dovecot Server</strong> button and then<a id="id965" class="indexterm"/> the <strong>Start Dovecot Server</strong> button to restart the daemon.</li></ol></div><p>Users will now be able to connect to your server and send mail via SMTP. Test the configuration by creating an account in your e-mail client program with the following settings:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><strong>SMTP server</strong>: The hostname of your mail server</li><li class="listitem" style="list-style-type: disc"><strong>Port</strong>: <code class="literal">25</code><div><div><h3 class="title"><a id="tip134"/>Tip</h3><p>Some users may have problems using port 25. Take a look at the <em>There's more...</em> section for instructions on adding the alternate SMTP port number 587.</p></div></div></li><li class="listitem" style="list-style-type: disc"><strong>Require SSL</strong>: <strong>Yes</strong></li><li class="listitem" style="list-style-type: disc"><strong>Username</strong>: Your system username</li><li class="listitem" style="list-style-type: disc"><strong>Password</strong>: Your system password<div><div><h3 class="title"><a id="tip135"/>Tip</h3><p>If you're having trouble connecting, look for debugging information in your server's mail log. Refer to the <em>Using Telnet to test SMTP authentication</em> section of the <em>Debugging e-mail related problems</em> recipe for a way to manually test your server. Paste any error messages you encounter into a search engine to find solutions.</p></div></div></li></ul></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec443"/>How it works...</h2></div></div></div><p>Dovecot and <a id="id966" class="indexterm"/>Postgres work together to provide an authenticated <a id="id967" class="indexterm"/>SMTP server. Dovecot provides the SASL authentication service, which is accessible via a UNIX socket. The configuration file, <code class="literal">10-master.conf</code>, tells Dovecot which services to launch when starting. We edited this file to instruct Dovecot to start the SASL service (named <code class="literal">auth</code>). We specified the location of the socket (<code class="literal">/var/spool/postfix/private/auth</code>) and which user and group may connect to it (<code class="literal">postfix</code>).</p><p>We also edited the main configuration file of Postfix called <code class="literal">main.cf</code>. The changes we made cause Postfix to require SASL authentication over an encrypted connection for submission of messages for relaying. We also told Postfix which type of authentication backend to use (<code class="literal">dovecot</code>) and the location of the socket relative to its mail queue directory (<code class="literal">private/auth</code>).</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec444"/>There's more...</h2></div></div></div><p>Some Internet service providers block traffic on port 25 to prevent machines infected by viruses and worms from abusing the e-mail system. Your server can provide the SMTP service at an alternate port 587. This will allow users from such ISPs to send mail through your server.</p><p>Follow these steps to instruct <a id="id968" class="indexterm"/>Postfix to listen for SMTP connections on port 587:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Server Processes</strong>.</li><li class="listitem">Click <strong>Add a new server process</strong>.</li><li class="listitem">Set <strong>Transport type</strong> to <strong>Internet</strong>.</li><li class="listitem">Set <strong>Server name/port</strong> to <code class="literal">587</code>.</li><li class="listitem">Set <strong>Process command</strong> to <code class="literal">smtpd</code>.</li><li class="listitem">Set <strong>Enabled?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Listen on host address</strong> to <strong>Any address</strong>.</li><li class="listitem">Set <strong>Private to mail system?</strong> to <strong>No</strong>.<div><img src="img/5849OS_12_07.jpg" alt="There's more..."/></div></li><li class="listitem">Click <a id="id969" class="indexterm"/><strong>Create</strong>.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Server Processes</strong>.</li><li class="listitem">Click <strong>Stop Postfix</strong> and then <strong>Start Postfix</strong> to restart the service.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec445"/>See also</h2></div></div></div><p>To find more detailed information about this setup, refer to the Postfix and Dovecot manuals:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://wiki2.dovecot.org/HowTo/PostfixAndDovecotSASL">http://wiki2.dovecot.org/HowTo/PostfixAndDovecotSASL</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.postfix.org/SASL_README.html">http://www.postfix.org/SASL_README.html</a></li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec134"/>Controlling the mail queue</h1></div></div></div><p>Messages that your mail <a id="id970" class="indexterm"/>server is going to send are placed in a mail queue. Normally, they don't stay there very long as the server deletes them as soon as they are sent. However, if for any reason a message cannot be sent, it may stay stuck in the queue.</p><p>Inspecting the mail queue will give you important information about the health of your mail system. Webmin provides a convenient graphical user interface to view and control the queue.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec446"/>Getting ready</h2></div></div></div><p>In this recipe, we are going to control the Postfix MTA's mail queue. Refer to the <em>Setting up your server to send and receive e-mails</em> recipe in this chapter for information about its installation.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec447"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Mail Queue</strong>.</li><li class="listitem">If no messages are currently queued for delivery, Webmin will inform you of that. Otherwise, you will see a list of messages resembling the following screenshot:<div><img src="img/5849OS_12_03.jpg" alt="How to do it..."/></div></li><li class="listitem">To delete a message from the queue, mark the checkbox next to its ID, and click <strong>Delete Selected Messages</strong>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec448"/>How it works...</h2></div></div></div><p>Webmin controls <a id="id971" class="indexterm"/>the Postfix mail queue by issuing appropriate Postfix superintendent (<code class="literal">postsuper</code>) or Postfix queue control (<code class="literal">postqueue</code>) commands. The following table lists the functions of commands that Webmin allows you to execute:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Command</p>
</th><th style="text-align: left" valign="bottom">
<p>Function</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>Delete message</p>
</td><td style="text-align: left" valign="top">
<p>This removes the message from the queue without sending it.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Requeue message</p>
</td><td style="text-align: left" valign="top">
<p>This moves the message to a new queue file, and restarts the delivery attempt.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Hold message</p>
</td><td style="text-align: left" valign="top">
<p>This puts the message <em>on hold</em> and does not attempt to deliver it.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Un-Hold message</p>
</td><td style="text-align: left" valign="top">
<p>This removes the hold on a message and attempts to deliver it.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Flush queue</p>
</td><td style="text-align: left" valign="top">
<p>This attempts to deliver all queued messages.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>Refresh queue</p>
</td><td style="text-align: left" valign="top">
<p>This updates the information about the queue.</p>
</td></tr></tbody></table></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec135"/>Reading and writing e-mails on the server</h1></div></div></div><p>Webmin gives you a<a id="id972" class="indexterm"/> convenient<a id="id973" class="indexterm"/> interface to read and write messages <a id="id974" class="indexterm"/>as any user of your system. This can be <a id="id975" class="indexterm"/>very useful when debugging mail problems, for instance, to check if a particular message reached a particular mailbox. Keep your users' privacy in mind of course.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec449"/>How to do it...</h2></div></div></div><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Read User Mail</strong>.</li><li class="listitem">Click on the name of the user whose mailbox you would like to visit.</li><li class="listitem">You will be presented with a graphical interface similar to any mail program, which allows you to read the user's e-mail messages:<div><img src="img/5849OS_12_04.jpg" alt="How to do it..."/></div></li><li class="listitem">Click the <strong>Compose</strong> button to see an interface for writing and sending a new message.</li><li class="listitem">Enter a destination address, message subject, and body.</li><li class="listitem">Click the <strong>Send Mail</strong> button.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec450"/>How it works...</h2></div></div></div><p>Webmin features a basic mail client program written in Perl. Thanks to this functionality, Webmin is able to read and write messages in your users' mailboxes.</p></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec136"/>Configuring e-mail aliases</h1></div></div></div><p>Each e-mail address <a id="id976" class="indexterm"/>is normally associated with a single user's mailbox<a id="id977" class="indexterm"/> on your server. In some situations, however, it's beneficial to forward incoming mail to multiple users or to an address on another server. This can be achieved by using mail aliases, which Postfix supports and Webmin makes easy to administer.</p><div><div><h3 class="title"><a id="tip136"/>Tip</h3><p>There are a number of aliases which every mail server should define. For instance, mail to the <code class="literal">root</code> mailbox should always reach an actual person. If you're running a mail server, you should also define aliases named <code class="literal">postmaster</code> and <code class="literal">abuse</code> through which people can report mail-related issues. If you wish to read mail sent in reply to automated messages from your MTA, define an alias for <code class="literal">mailer-daemon</code>.</p><p>More information about common mailbox names may be found in the <a id="id978" class="indexterm"/>RFC2142 document at <a class="ulink" href="http://tools.ietf.org/html/2142.">http://tools.ietf.org/html/2142.</a>
</p></div></div><p>Postfix aliases allow you to not only forward mail to other addresses, but also save their content to files or pipe them to other applications. Sensitive data such as password verification codes are often sent via e-mail, so keep the security of such destinations in mind.</p><p>In this recipe, we demonstrate how easy it is to configure Postfix mail aliases using Webmin.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec451"/>How to do it...</h2></div></div></div><p>For configuring e-mail aliases, perform the following steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Mail Aliases</strong>.</li><li class="listitem">Click <strong>Create a new alias</strong>.</li><li class="listitem">In the <strong>Address</strong> field, enter a local e-mail address without the domain, that is, for <code class="literal">mailbox@example.com</code>, enter just <code class="literal">mailbox.</code></li><li class="listitem">Set <strong>Enabled?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Alias to</strong> to <strong>Email address</strong>, and enter a full e-mail address or a local mailbox name in the text field provided.</li><li class="listitem">Click <strong>Save</strong>.</li></ol></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec452"/>How it works...</h2></div></div></div><p>Whenever Postfix encounters an incoming message, it checks whether the destination address is contained amongst defined aliases. The main list of aliases is stored in a text file named <code class="literal">/etc/aliases</code> on most systems. Because this file can grow quite large, it isn't used directly in its text format. Instead, it's converted to an indexed binary file, which allows quick lookups. Every time the alias file is modified, Webmin executes a command named <code class="literal">postalias</code>, which creates the binary index. The command will resemble the following with paths adjusted for your system:</p><div><pre class="programlisting">
<strong>/usr/sbin/postalias -c /etc/postfix /etc/aliases </strong>
</pre></div><p>Postfix aliases may<a id="id979" class="indexterm"/> serve a number of different functions listed in the <a id="id980" class="indexterm"/>following table. Webmin allows you to not only create all of these, but also others that may not be supported by your MTA. This table lists examples of different ways to define the alias <code class="literal">test</code> (as in <code class="literal">test@example.com</code>) and what function they may serve:</p><div><table border="1"><colgroup><col style="text-align: left"/><col style="text-align: left"/></colgroup><thead><tr><th style="text-align: left" valign="bottom">
<p>Alias syntax</p>
</th><th style="text-align: left" valign="bottom">
<p>Function</p>
</th></tr></thead><tbody><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">test: user</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This forwards the message to another local mailbox.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">test: user@remotedomain.com</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This forwards the message to a remote e-mail address.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">test: "/path/to/file"</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This appends incoming messages to a file.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">test: "|/usr/local/bin/mailhelper"</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This pipes incoming messages to a program.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">test: user, root, user@remotedomain.com</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This forwards the message to a list of recipients.</p>
</td></tr><tr><td style="text-align: left" valign="top">
<p>
<code class="literal">test: :include:/path/to/aliases</code>
</p>
</td><td style="text-align: left" valign="top">
<p>This forwards the message to destinations listed in <code class="literal">/path/to/aliases</code>.</p>
</td></tr></tbody></table></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec453"/>There's more...</h2></div></div></div><p>There are many interesting ways to use mail aliases, for instance, to create a basic mailing list. Users can also influence how their mail is forwarded by creating a special file in their home directory.</p><div><div><div><div><h3 class="title"><a id="ch12lvl3sec142"/>Creating a simple mailing list</h3></div></div></div><p>You can create a basic mailing list by <a id="id981" class="indexterm"/>creating an address and assigning it to forward mail to addresses defined in a text file. You can then manage subscriptions by editing the file. For example, you could create a mailing list, <code class="literal">students@yourdomain.com</code>, by following these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Create a file <code class="literal">/etc/postfix/list-students.txt</code><code class="literal">.</code></li><li class="listitem">Enter e-mail addresses of all list members in the file, one address per line.</li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Mail Aliases</strong>.</li><li class="listitem">Click the <strong>Create a new alias</strong> link.</li><li class="listitem">In the <strong>Address</strong> field, enter the mailing list address without the domain, for example, <code class="literal">students.</code></li><li class="listitem">Set <strong>Enabled?</strong> to <strong>Yes</strong>.</li><li class="listitem">Set <strong>Alias to</strong> to <strong>Addresses in file</strong>, and enter <code class="literal">/etc/postfix/list-students.txt</code> in<a id="id982" class="indexterm"/> the provided text field.</li><li class="listitem">Click <strong>Save</strong>.<div><div><h3 class="title"><a id="tip137"/>Tip</h3><p>This type of mailing list provides only the most basic functionality. Users cannot manage their mailing preferences or sign out. There are multiple applications dedicated to running full-featured mailing lists. Take a look at Mailman (<a class="ulink" href="http://www.list.org">http://www.list.org</a>) and Sympa (<a class="ulink" href="http://www.sympa.org">http://www.sympa.org</a>).</p></div></div></li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch12lvl3sec143"/>Using .forward files</h3></div></div></div><p>Users can also control their<a id="id983" class="indexterm"/> own mail-forwarding preferences by placing a file named <code class="literal">.forward</code> in their home directory. Before Postfix delivers mail to a user, it will check if this file exists, and if it does, Postfix will obediently forward the message to addresses specified in the file. Other types of alias behaviors can also be specified in <code class="literal">.forward</code> files.</p></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec454"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Find more information about Postfix aliases in its manual at <a class="ulink" href="http://www.postfix.org/aliases.5.html">http://www.postfix.org/aliases.5.html</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec137"/>Filtering incoming mail using Procmail and SpamAssassin</h1></div></div></div><p>E-mail gives us the <a id="id984" class="indexterm"/>ability<a id="id985" class="indexterm"/> to send <a id="id986" class="indexterm"/>free messages to nearly <a id="id987" class="indexterm"/>everyone in the world. Unfortunately, some people decided to abuse this system and send unsolicited mass mail (spam) in hopes of making money through advertising or fraud. So many people were tempted by this possibility that, at some point, spam made up over 95 percent of e-mail traffic. This would make e-mail practically unusable, but thankfully, anti-spam filters make this problem more manageable.</p><p>Spam fighting is a large and complex topic. In this recipe, we will demonstrate an effective yet basic technique based on the programs Procmail and SpamAssassin. If your site handles a large volume of e-mail, you will probably need a more efficient solution.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec455"/>How to do it...</h2></div></div></div><p>This recipe is<a id="id988" class="indexterm"/> divided into two parts. First, we instruct our <a id="id989" class="indexterm"/>Postfix MTA to hand incoming messages <a id="id990" class="indexterm"/>to a filtering program called Procmail. Next, <a id="id991" class="indexterm"/>we create a filter, which pipes messages through SpamAssassin and sends spam to a separate mailbox.</p><p>First, let's start with setting up Procmail filters in Postfix:</p><div><ol class="orderedlist arabic"><li class="listitem">Follow instructions contained in the <em>Installing software packages</em> recipe from <a class="link" href="ch01.html" title="Chapter 1. Setting Up Your System">Chapter 1</a>, <em>Setting Up Your System,</em> and install Procmail. The package should simply be named <code class="literal">procmail</code>.</li><li class="listitem">Determine the location of the <code class="literal">procmail</code> binary by issuing the following command:<div><pre class="programlisting">
<strong>$ which procmail</strong>
</pre></div><p>The output of this command will give you the location of the binary, as follows:</p><div><pre class="programlisting">
<strong>/usr/bin/procmail</strong>
</pre></div></li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Postfix Mail Server</strong> | <strong>Local Delivery</strong>.</li><li class="listitem">Enter the following command in the <strong>External command to use instead of mailbox delivery</strong> text field. Replace <code class="literal">/usr/bin/procmail</code> with your location if it's different.<div><pre class="programlisting">
<strong>/usr/bin/procmail -a "$EXTENSION"</strong>
</pre></div></li><li class="listitem">Click <strong>Save and Apply</strong>.</li></ol></div><p>Now, let's set up SpamAssassin filters in Procmail:</p><div><ol class="orderedlist arabic"><li class="listitem">Install SpamAssassin its package should simply be named <code class="literal">spamassassin</code>.</li><li class="listitem">Determine the location of the <code class="literal">spamassassin</code> binary by issuing the following command:<div><pre class="programlisting">
<strong>$ which spamassassin</strong>
<strong>/usr/bin/spamassassin</strong>
</pre></div></li><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Procmail Mail Filter</strong>.</li><li class="listitem">Click the <strong>Add a new filter action</strong> link.</li><li class="listitem">Set <strong>Delivery mode</strong> to <strong>Feed to program</strong>, and enter the path to the <code class="literal">spamassassin</code> binary in the text field.</li><li class="listitem">Mark the checkboxes, <strong>Action program is a filter</strong> and <strong>Wait for action program to finish, and check result</strong>.</li><li class="listitem">Set <strong>Delivery lock file</strong> to <strong>Specific file</strong>, and enter <code class="literal">spamassassin.lock</code> in the text field.</li><li class="listitem">Don't <a id="id992" class="indexterm"/>set any action conditions; we<a id="id993" class="indexterm"/> want to run all<a id="id994" class="indexterm"/> mail through<a id="id995" class="indexterm"/> SpamAssassin:<div><img src="img/5849OS_12_05.jpg" alt="How to do it..."/></div></li><li class="listitem">Click <strong>Create</strong>.</li></ol></div><p>Let's create a second filter now, which will move all spam messages to another folder called <code class="literal">Junk</code>.</p><div><ol class="orderedlist arabic"><li class="listitem">Click the <strong>Add a new filter action</strong> link.</li><li class="listitem">Set <strong>Delivery mode</strong> to <strong>Append to file</strong>, and enter <code class="literal">$HOME/mail/Junk</code> in the text field.</li><li class="listitem">Set <strong>Delivery lock file</strong> to <strong>Default</strong>.</li><li class="listitem">Under <strong>Condition type</strong>, select <strong>Matches regular expression</strong>, and enter <code class="literal">^X-Spam-Status: Yes</code>:<div><img src="img/5849OS_12_06.jpg" alt="How to do it..."/></div></li><li class="listitem">Click <strong>Create</strong>.</li></ol></div><p>Incoming mail should<a id="id996" class="indexterm"/> now be passed to SpamAssassin. Detected <a id="id997" class="indexterm"/>spam messages should<a id="id998" class="indexterm"/> not be delivered to your users' regular mailboxes but to files named <code class="literal">~/mail/Junk</code> in their home directories.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec456"/>How it works...</h2></div></div></div><p>This recipe attempts to filter out spam by passing incoming messages through two programs. The first is Procmail, a mail delivery agent (MDA). Postfix hands messages off to the MDA for delivery to mailboxes. Procmail has the added functionality of passing mail through a series of configurable filters. A Procmail filter inspects the headers or body of a message and decides what to do with the message based on its content.</p><div><div><h3 class="title"><a id="note88"/>Note</h3><p>Procmail<a id="id999" class="indexterm"/> is a stable software installed by default on many operating systems. Unfortunately, it's no longer maintained, so no new features will be added in the future. The <strong>maildrop</strong> program<a id="id1000" class="indexterm"/> is often recommended as a newer replacement for Procmail, but Webmin does not currently support it. More information is available at <a class="ulink" href="http://www.courier-mta.org/maildrop/">http://www.courier-mta.org/maildrop/</a>.</p></div></div><p>In our example, we set up two Procmail filters. The first has no conditions, which means that it applies to every message, and it hands the message off to yet another program for spam analysis. SpamAssassin inspects every part of the message, looks up DNS records of MTAs the message was relayed through, and checks them against spam blacklist and other sources of information about spammers. It uses all this data to perform statistical and artificial intelligence analysis and ends up giving every message a score. If the score is high, the message should probably be considered spam. SpamAssassin writes its report in the headers of the messages and hands it back to Procmail.</p><p>Our second <a id="id1001" class="indexterm"/>Procmail filter inspects message headers to <a id="id1002" class="indexterm"/>check if SpamAssassin decided that <a id="id1003" class="indexterm"/>the message is<a id="id1004" class="indexterm"/> spam (<code class="literal">X-Spam-Status: Yes</code>). These messages will not be delivered to a user's inbox but instead appended to a secondary inbox called Junk (<code class="literal">~/mail/Junk</code>).</p><div><div><h3 class="title"><a id="tip138"/>Tip</h3><p>If your system is going to handle a lot of mail, then invoking SpamAssassin for every message can create a serious bottleneck. It could slow down your server significantly and cause problems. There is a way to optimize SpamAssassin's performance by running it as a background daemon. Look for it in its manual.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec457"/>There's more...</h2></div></div></div><p>Once you have everything set up, you should test your anti-spam configuration. There is a way to trigger an automatic SpamAssassin high score. Just enter the following string in a message, and it will be marked as spam:</p><div><pre class="programlisting">XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X</pre></div><p>You can find more information about this technique, called <strong>Generic Test for Unsolicited Bulk E-mail</strong> (<strong>GTUBE</strong>)<a id="id1005" class="indexterm"/>, in SpamAssassin's manual at <a class="ulink" href="http://spamassassin.apache.org/gtube/">http://spamassassin.apache.org/gtube/</a>.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec458"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Find more information about the type of setup we created in the SpamAssassin manual, which contains a slightly more complex set of Procmail filters that solves some common bugs you may encounter, at the following URL: <a class="ulink" href="http://wiki.apache.org/spamassassin/UsedViaProcmail">http://wiki.apache.org/spamassassin/UsedViaProcmail</a>.</li></ul></div></div></div>
<div><div><div><div><h1 class="title"><a id="ch12lvl1sec138"/>Debugging e-mail-related problems</h1></div></div></div><p>You will learn most <a id="id1006" class="indexterm"/>about your mail server by talking to it directly in SMTP through a Telnet session. At the same time, you should be monitoring mail logfiles for any messages that occur while you're performing your tests.</p><p>In this recipe, we cover a number of techniques for testing and debugging e-mail systems. We will demonstrate how to test your system's ability to:</p><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Receive e-mail by submitting a message directly over SMTP</li><li class="listitem" style="list-style-type: disc">Send e-mail by sending a message though the mail command</li><li class="listitem" style="list-style-type: disc">Authenticate users</li></ul></div><p>We'll also mention the location of mail logs, various ways of sending e-mail, debugging SMTP authentication, and other topics. Read on; this recipe should give you a way to find the solution to your problem.</p><div><div><div><div><h2 class="title"><a id="ch12lvl2sec459"/>Getting ready</h2></div></div></div><p>We will be testing the mailing capabilities of a system located at the <code class="literal">mailserver.example.com</code> domain name. Our test will be performed from another machine (the client). </p><p>Before starting, make sure that you have the Telnet program installed on the client machine. A Telnet client is installed by default on most systems and can be installed from a package named <code class="literal">telnet</code> on others.</p><div><div><h3 class="title"><a id="tip139"/>Tip</h3><p>On some systems, the Netcat (nc) program may be a better alternative to using Telnet. You can find out more about it on its website: <a class="ulink" href="http://nc110.sourceforge.net">http://nc110.sourceforge.net</a>.</p></div></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec460"/>How to do it...</h2></div></div></div><p>Follow these steps to submit an e-mail message directly to your server using Telnet:</p><div><ol class="orderedlist arabic"><li class="listitem">On the client machine, open a terminal, and type in the following command to start a Telnet client and connect to port <code class="literal">25</code> of the <code class="literal">mailserver.example.com</code> system:<div><pre class="programlisting">
<strong>$ telnet mailserver.example.com 25</strong>
</pre></div><p>The mail server should respond with its greeting banner.</p></li><li class="listitem">Type in the <code class="literal">EHLO</code> command followed by the fully qualified domain name of your client system. When you press <em>Enter</em>, the server should reply with a list of <code class="literal">250</code> messages:<div><pre class="programlisting">
<strong>EHLO localhost.localdomain</strong>
</pre></div><div><div><h3 class="title"><a id="tip140"/>Tip</h3><p>If your client system isn't a mail server in its own right, it may not have an FQDN. In this situation, use <code class="literal">localhost.localdomain</code>, but note that most mail servers will reject your message if it comes from a misidentified sender. Look for information about the <code class="literal">XCLIENT</code> command in the Postfix manual if this is causing a problem for you.</p></div></div></li><li class="listitem">Type in <a id="id1007" class="indexterm"/>the <code class="literal">MAIL FROM</code> command to specify the sender's e-mail address. The server should respond with a <code class="literal">250 OK</code> message for the following command:<div><pre class="programlisting">
<strong>MAIL FROM: user@localhost.localdomain</strong>
</pre></div></li><li class="listitem">Type in the <code class="literal">RCPT TO</code> command to specify the recipient's e-mail address. The server should respond with a <code class="literal">250 OK</code> message for the following command:<div><pre class="programlisting">
<strong>RCPT TO: user@example.com</strong>
</pre></div></li><li class="listitem">Type in the <code class="literal">DATA</code> command to start the message body.</li><li class="listitem">Optionally, type in e-mail headers. For instance, enter a <code class="literal">Subject:</code> header to specify the message subject, as shown in the following command:<div><pre class="programlisting">
<strong>Subject: Test</strong>
</pre></div></li><li class="listitem">Enter a blank line to close the headers section and start the message body.</li><li class="listitem">Type in a message, and end by entering a dot (<code class="literal">.</code>) on a single line. The server should respond with a <code class="literal">250 OK</code> message and indicate that the message was queued for delivery.</li><li class="listitem">Type <code class="literal">QUIT</code> to finish the SMTP session.</li></ol></div><p>The complete Telnet session may look something like the following commands. Your commands are highlighted.</p><div><pre class="programlisting">$ telnet mailserver.example.com 25
Trying 10.10.10.200...
Connected to mailserver.example.com.
Escape character is '^]'.
220 mailserver.example.com ESMTP Postfix (Debian/GNU)
<strong>EHLO localhost.localdomain</strong>
250-mailserver.example.com
250-PIPELINING
250-SIZE 10240000
250-VRFY
250-ETRN
250-STARTTLS
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
<strong>MAIL FROM: user@localhost.localdomain</strong>
250 2.1.0 Ok
<strong>RCPT TO: user@example.com</strong>
250 2.1.5 Ok
<strong>DATA</strong>
354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;
<strong>Subject: Test</strong>

<strong>This is the message body.</strong>
<strong>.</strong>
250 2.0.0 Ok: queued as DBE6040983
<strong>QUIT</strong>
221 2.0.0 Bye
Connection closed by foreign host.</pre></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec461"/>How it works...</h2></div></div></div><p>The Telnet <a id="id1008" class="indexterm"/>client allows you to establish an interactive TCP connection to your server. When you successfully connect to port <code class="literal">25</code>, the SMTP service answers with code <code class="literal">220</code> and a welcome message. You can then type text commands, which will be sent to the server when you press <em>Enter</em>. The server's answers are displayed inline, and you can proceed to send the next command. This technique may be used to debug any text-based protocol running over TCP such as HTTP, FTP, POP, or IMAP.</p><p>Simple Mail Transfer Protocol (SMTP) is as simple as the name promises. The only commands you need to send an e-mail are <code class="literal">EHLO</code>, <code class="literal">MAIL</code> <code class="literal">FROM</code>, <code class="literal">RCPT TO</code>, and <code class="literal">DATA</code>. </p><div><div><h3 class="title"><a id="note89"/>Note</h3><p>The <code class="literal">EHLO</code> command<a id="id1009" class="indexterm"/> used to be called <code class="literal">HELO</code>. It was substituted in the current extended version of the protocol (ESMTP). Using <code class="literal">EHLO</code> indicates that you are ready to use this protocol version.</p></div></div><p>Other information about the message is provided in an envelope, which consists of a number of headers. Each header is provided on a separate line consisting of the header name, colon, and header content. This section ends with an empty line.</p><div><div><h3 class="title"><a id="note90"/>Note</h3><p>More information about e-mail formats may be found in RFC 2822:</p><p>
<a class="ulink" href="http://tools.ietf.org/html/rfc2822">http://tools.ietf.org/html/rfc2822</a>
</p></div></div><p>The message body ends <a id="id1010" class="indexterm"/>when a line with a single dot character (<code class="literal">.</code>) is sent. This finishes the submission of this message, and the server will answer with <code class="literal">250 OK</code> and information that the message was queued for delivery or an error message. The fact that a message was queued is not a guarantee of its delivery. The e-mail system will scan it for viruses, analyze if it isn't spam, and may decide not to deliver (bounce) the message. In most cases, the sender of the message will be notified by a response e-mail if the message could not be delivered. This may not be true if the message was classified as spam.</p><p>Using Telnet to analyze what your e-mail server is doing is a great way to see what errors others who try to send you mail may encounter. Note that not all diagnostic messages are displayed as SMTP responses. You should keep an eye on the server's mail log for additional details if you see any errors.</p></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec462"/>There's more...</h2></div></div></div><p>There are many additional tools you should use when debugging e-mail system issues. Some of them are described in the following sections:</p><div><div><div><div><h3 class="title"><a id="ch12lvl3sec144"/>Analyzing mail logs</h3></div></div></div><p>Your Postfix server <a id="id1011" class="indexterm"/>sends detailed logs to Syslog's <code class="literal">mail</code> facility. These messages are usually saved in a file named <code class="literal">/var/log/mail.log</code>, <code class="literal">/var/log/maillog</code>, or some such similar name. Refer to the <em>Viewing and searching through system log files</em> and <em>Saving Syslog messages to a file</em> recipes in <a class="link" href="ch05.html" title="Chapter 5. Monitoring Your System">Chapter 5</a>, <em>Monitoring Your System</em>, for more information.</p><p>Every message coming into your server is given a unique ID, which allows you to track it through verbose logs. For instance, a single message sent from <code class="literal">root@mailserver.example.com</code> to <code class="literal">user@other.example.com</code> could leave the following log trace as it is picked up, queued, delivered, and removed by your server. Note that the message identifier, <code class="literal">EB0FA2049B</code>, is contained in every entry.</p><div><pre class="programlisting">Jan 11 09:35:27 mailserver postfix/pickup[23061]:<strong>EB0FA2049B</strong>: uid=0 from=&lt;root@mailserver.example.com&gt;
Jan 11 09:35:27 mailserver postfix/cleanup[23063]:<strong>EB0FA2049B</strong>: message-id=&lt;1389429314.22675@mailserver.example.com&gt;
Jan 11 09:35:27 mailserver postfix/qmgr[23062]:<strong>EB0FA2049B</strong>: from=&lt;root@mailserver.example.com&gt;,size=581, nrcpt=1 (queue active)
Jan 11 09:35:33 mailserver postfix/smtp[23065]:<strong>EB0FA2049B</strong>: to=&lt;user@other.example.com&gt;, relay=other.example.com[10.10.10.200]:25, delay=18,delays=13/0.03/5.1/0.02, dsn=2.0.0,status=sent (250 2.0.0 Ok: queued as <strong>5431B40983</strong>)
Jan 11 09:35:33 mailserver postfix/qmgr[23062]:<strong>EB0FA2049B</strong>: removed</pre></div></div><div><div><div><div><h3 class="title"><a id="ch12lvl3sec145"/>Testing message sending through Webmin</h3></div></div></div><p>Webmin provides a convenient <a id="id1012" class="indexterm"/>way to test whether your mail server is <a id="id1013" class="indexterm"/>actually able to send e-mail messages. To do that, just follow these steps:</p><div><ol class="orderedlist arabic"><li class="listitem">Navigate to <strong>Servers</strong> | <strong>Read User Mail</strong>.</li><li class="listitem">Click on the username of the user you would like to send a message as, for instance, <strong>root</strong>.</li><li class="listitem">Click the <strong>Compose</strong> button.</li><li class="listitem">Use the GUI to enter an e-mail message, subject, and recipient address.</li><li class="listitem">Click <strong>Send</strong>.</li></ol></div></div><div><div><div><div><h3 class="title"><a id="ch12lvl3sec146"/>Sending mail from the command line</h3></div></div></div><p>A quick way to send e-mail <a id="id1014" class="indexterm"/>messages to others is to use the<a id="id1015" class="indexterm"/> <code class="literal">mail</code> command. You can<a id="id1016" class="indexterm"/> type the message body manually or pipe it into the <code class="literal">mail</code> command. For instance, to send a message to <code class="literal">user@example.com</code> , you can use the following syntax:</p><div><pre class="programlisting">
<strong>$ echo "Message body" | mail -s "Subject" user@example.com</strong>
</pre></div><p>If the command is not found on your system, you may need to install a package named <code class="literal">mail</code> or <code class="literal">mailx</code>.</p></div><div><div><div><div><h3 class="title"><a id="ch12lvl3sec147"/>Using Telnet to test SMTP authentication</h3></div></div></div><p>You may test your server's <a id="id1017" class="indexterm"/>SMTP authentication through a <a id="id1018" class="indexterm"/>Telnet session. The only tricky part is to encode your username and password combination using Base64. For instance, to encode the username <code class="literal">myusername</code> and password <code class="literal">mypassword</code>, use the following Perl command:</p><div><pre class="programlisting">
<strong>$ perl -MMIME::Base64 -e 'printencode_base64("\000myusername\000mypassword");'</strong>
</pre></div><p>You should see the following output:</p><div><pre class="programlisting">
<strong>AG15dXNlcm5hbWUAbXlwYXNzd29yZA==</strong>
</pre></div><div><div><h3 class="title"><a id="note91"/>Note</h3><p>Base64 is just a form of encoding; it's not a one-way hash or encryption. The algorithm is fully reversible, for instance, by using the following command:</p><div><pre class="programlisting">
<strong>$ perl -MMIME::Base64 -e 'printdecode_base64("AG15dXNlcm5hbWUAbXlwYXNzd29yZA==");</strong>
<strong>myusernamemypassword</strong>
</pre></div></div></div><p>Once you have your <a id="id1019" class="indexterm"/>Base64 encoded username and password, you <a id="id1020" class="indexterm"/>can use it in the <code class="literal">AUTH</code> command<a id="id1021" class="indexterm"/> of a Telnet SMTP session, as shown in the following commands:</p><div><pre class="programlisting">$ telnet mailserver.example.com 25
Trying 10.10.10.200...
Connected to mailserver.example.com.
Escape character is '^]'.
220 mailserver.example.com ESMTP Postfix (Debian/GNU)
<strong>EHLO localhost.localdomain</strong>
250-mailserver.example.com
250-PIPELINING
250-SIZE 10240000
250-VRFY
250-ETRN
250-STARTTLS
250-ENHANCEDSTATUSCODES
250-8BITMIME
250 DSN
<strong>AUTH PLAIN AG15dXNlcm5hbWUAbXlwYXNzd29yZA==</strong>
235 2.0.0 Authentication successful</pre></div><p>If everything went according to the plan, you should see the <code class="literal">Authentication successful</code> message.</p></div></div><div><div><div><div><h2 class="title"><a id="ch12lvl2sec463"/>See also</h2></div></div></div><div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Take a look at the Postfix manual for more information about configuration and debugging. In particular, take a look at the <a class="ulink" href="http://www.postfix.org/DEBUG_README.html">http://www.postfix.org/DEBUG_README.html</a> page, which deals with debugging.</li><li class="listitem" style="list-style-type: disc">Other, more advanced Postfix debugging tools include the <code class="literal">qshape</code> command, which will give you an overview of which messages are getting stuck on your server, and the <code class="literal">XCLIENT</code> facility, which allows you to pretend to be a user of another system. More information is available in these manual pages:<div><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.postfix.org/qshape.1.html">http://www.postfix.org/qshape.1.html</a></li><li class="listitem" style="list-style-type: disc"><a class="ulink" href="http://www.postfix.org/XCLIENT_README.html">http://www.postfix.org/XCLIENT_README.html</a></li></ul></div></li><li class="listitem" style="list-style-type: disc">Also, take a look at the <em>Controlling the mail queue</em> recipe in this chapter.</li></ul></div></div></div></body></html>