<html><head></head><body><div class="chapter" title="Chapter&#xA0;4.&#xA0;Managing Clusters" id="aid-RL0A1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter 4. Managing Clusters</h1></div></div></div><p>In this chapter, we will cover how to setup and manage a local CoreOS cluster on a personal computer. You will learn how to bootstrap a three-peer cluster, customize it via the <code class="literal">cloud-config</code> file, and schedule a fleet unit in the cluster.</p><p>In this chapter, we will cover the following topics:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">Bootstrapping a local cluster</li><li class="listitem">Customizing a cluster via the<code class="literal">cloud-config</code> file</li><li class="listitem">Scheduling a <code class="literal">fleet</code> unit in the cluster</li></ul></div><p>You are going to learn how to setup a simple three-node cluster on your personal computer.</p><div class="section" title="Determining the optimal etcd cluster size"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec23"/>Determining the optimal etcd cluster size</h1></div></div></div><p>The most efficient cluster size is between three and nine peers. For larger clusters, <code class="literal">etcd</code> will select a subset of instances to participate in order to keep it efficient.</p><p>The bigger the cluster, the <a id="id62" class="indexterm"/>slower the writing to the cluster becomes, as all of the data needs to be replicated around the cluster peers. To have a cluster well-optimized, it needs to be based on an odd number of peers. It must have a quorum of at least of three peers and prevent a split-brain in the event of network partition.</p><p>In our case, we are going to set up a three-peer <code class="literal">etcd </code>cluster. To build a highly available cluster on the cloud (GCE, AWS, Azure, and so on), you should use multiple availability zones in order to decrease the effect of failure in a single domain.</p><p>In a general cluster, peers are not recommended to be used for anything except for running an <code class="literal">etcd</code> cluster. But for testing our cluster setup, it will be fine to deploy some <code class="literal">fleet</code> units there.</p><p>In later chapters, you will learn how to properly set up clusters to be used for production.</p></div></div>
<div class="section" title="Bootstrapping a local cluster"><div class="titlepage" id="aid-SJGS2"><div><div><h1 class="title"><a id="ch04lvl1sec24"/>Bootstrapping a local cluster</h1></div></div></div><p>As discussed earlier, we<a id="id63" class="indexterm"/> will be installing a three-peer <code class="literal">etcd </code>cluster on our computer.</p><div class="section" title="Cloning the coreos-vagrant project"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec17"/>Cloning the coreos-vagrant project</h2></div></div></div><p>Let's clone the<a id="id64" class="indexterm"/> project and get it running. Follow these steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In your terminal or<a id="id65" class="indexterm"/> command prompt, type this:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ mkdir cluster </strong></span>
<span class="strong"><strong>$ cd cluster</strong></span>
<span class="strong"><strong>$ git clone https://github.com/coreos/coreos-vagrant.git</strong></span>
<span class="strong"><strong>$ cd coreos-vagrant</strong></span>
<span class="strong"><strong>$ cpconfig.rb.sampleconfig.rb</strong></span>
<span class="strong"><strong>$ cp user-data.sample user-data</strong></span>
</pre></div></li><li class="listitem">Now we need to adjust some settings. Edit <code class="literal">config.rb</code> and change the file's top part to this example:<div class="informalexample"><pre class="programlisting"># Size of the CoreOS cluster created by Vagrant
$num_instances=3

# Used to fetch a new discovery token for a cluster of size $num_instances
$new_discovery_url="https://discovery.etcd.io/new?size=#{$num_instances}"

# To automatically replace the discovery token on 'vagrant up', uncomment
# the lines below:
#
if File.exists?('user-data') &amp;&amp;ARGV[0].eql?('up')
  require 'open-uri'
  require 'yaml'

  token = open($new_discovery_url).read

  data = YAML.load(IO.readlines('user-data')[1..-1].join)
  if data['coreos'].key? 'etcd'
    data['coreos']['etcd']['discovery'] = token
  end
  if data['coreos'].key? 'etcd2'
    data['coreos']['etcd2']['discovery'] = token
  end

yaml = YAML.dump(data)
File.open('user-data', 'w') { |file| file.write("#cloud-config\n\n#{yaml}") }
end
#</pre></div><div class="note" title="Note"><h3 class="title"><a id="note05"/>Note</h3><p>Alternatively, you can use the example code of this chapter, which will be kept up to date with changes in the coreos-vagrant GitHub repository.</p></div><p>What we did here<a id="id66" class="indexterm"/> is as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem">We set the cluster to three instances</li><li class="listitem">Discovery token is automatically replaced on each <code class="literal">vagrant up</code> command</li></ul></div></li><li class="listitem">Next, we need to edit the user data file:<p>Change the <code class="literal">"#discovery: https://discovery.etcd.io/&lt;token&gt;" </code>line to this:</p><div class="informalexample"><pre class="programlisting">"discovery: https://discovery.etcd.io/&lt;token&gt;"</pre></div><p>So, when we boot our vagrant-based cluster the next time, we will have three CoreOS <code class="literal">etcd</code> peers running and connected to the same cluster via the discovery token provided through "<code class="literal">https://discovery.etcd.io/&lt;token&gt;</code>".</p></li><li class="listitem">Let's now fire<a id="id67" class="indexterm"/> up our new cluster using the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant up</strong></span>
</pre></div><p>We should see something like this in our terminal:</p><div class="mediaobject"><img src="../Images/image00121.jpeg" alt="Cloning the coreos-vagrant project"/></div><p style="clear:both; height: 1em;"> </p><p>Hold <a id="id68" class="indexterm"/>on! There's<a id="id69" class="indexterm"/> more output!</p><div class="mediaobject"><img src="../Images/image00122.jpeg" alt="Cloning the coreos-vagrant project"/></div><p style="clear:both; height: 1em;"> </p><p>The cluster should be up and running now.</p></li><li class="listitem">To check the status of the <a id="id70" class="indexterm"/>cluster, type the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant status</strong></span>
</pre></div><p>You should see<a id="id71" class="indexterm"/> something like what is shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00123.jpeg" alt="Cloning the coreos-vagrant project"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div><p>Now it's time to test our new CoreOS cluster. We need to run <code class="literal">ssh </code>for one of our peers and check the <code class="literal">fleet</code> machines. This can be done by the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh core-01 -- -A</strong></span>
<span class="strong"><strong>$ fleetctl list-machines</strong></span>
</pre></div><p>We should see something like what is shown in the following screenshot:</p><div class="mediaobject"><img src="../Images/image00124.jpeg" alt="Cloning the coreos-vagrant project"/></div><p style="clear:both; height: 1em;"> </p><p>Excellent! We have <a id="id72" class="indexterm"/>got our first CoreOS cluster set, as we see all the three machines up and running. Now, let's try to set a key in <code class="literal">etcd </code>with which we can<a id="id73" class="indexterm"/> check on another machine later on. Type in the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ etcdctl set etcd-cluster-key "Hello CoreOS"</strong></span>
</pre></div><p>You will see the following output:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Hello CoreOS</strong></span>
</pre></div><p>Press <span class="emphasis"><em>Ctrl</em></span>+<span class="emphasis"><em>D</em></span> to exit and type the following command to get to VM host's console:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh core-02 -- -A</strong></span>
</pre></div><p>Let's verify that we can see our new <code class="literal">etcd</code> key there too:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ etcdctl get etcd-cluster-key</strong></span>
<span class="strong"><strong>Hello CoreOS</strong></span>
</pre></div><p>Brilliant! Our <code class="literal">etcd </code>cluster is working just fine.</p><p>Exit from the <code class="literal">core-02</code> machine by pressing <span class="emphasis"><em>Ctrl</em></span>+<span class="emphasis"><em>D</em></span>.</p></div><div class="section" title="Customizing a cluster via the cloud-config file"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec18"/>Customizing a cluster via the cloud-config file</h2></div></div></div><p>Let's make some <a id="id74" class="indexterm"/>changes to the <code class="literal">cloud-config</code> file and <a id="id75" class="indexterm"/>push it into the cluster machines:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">In the user data file (<code class="literal">cloud-config</code> file for Vagrant-based CoreOS), below the text block <code class="literal">fleet</code> make changes:<div class="informalexample"><pre class="programlisting">public-ip: $public_ipv4</pre></div><p>Add a new line:</p><div class="informalexample"><pre class="programlisting">metadata: cluster=vagrant</pre></div><p>So, it will look like this:</p><div class="informalexample"><pre class="programlisting">fleet:
      public-ip: $public_ipv4
      metadata: cluster=vagrant</pre></div></li><li class="listitem">Let's add a <code class="literal">test.txt</code> file to the <code class="literal">/home/core</code> folder via <code class="literal">cloud-config</code> too. At the end of the user data file, add this code:<div class="informalexample"><pre class="programlisting">write_files:
  - path: /home/core/test.txt
    permissions: 0644
    owner: core
    content: |
Hello Cluster</pre></div><p>This will add a new file in the<code class="literal">/home/core</code> folder on each cluster machine.</p></li><li class="listitem">To get our changes implemented which we did previously, run<a id="id76" class="indexterm"/> the following<a id="id77" class="indexterm"/> commands:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant provision</strong></span>
</pre></div><p>You will see the following result:</p><div class="mediaobject"><img src="../Images/image00125.jpeg" alt="Customizing a cluster via the cloud-config file"/></div><p style="clear:both; height: 1em;"> </p><p>Then, run this command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant reload</strong></span>
</pre></div><p>The first command provisionally updated user data file on all three VMs, and the second reloaded them.</p></li><li class="listitem">To <code class="literal">ssh</code> to one of  the VMs, enter this code:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh core-03 -- -A</strong></span>
<span class="strong"><strong>$ ls</strong></span>
<span class="strong"><strong>test.txt</strong></span>
</pre></div></li><li class="listitem">To check the content of the <code class="literal">test.txt</code> file, use this line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ cat test.txt</strong></span>
</pre></div><p>You should see output as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Hello Cluster</strong></span>
</pre></div></li></ol><div style="height:10px; width: 1px"/></div><p>As you can see, we have<a id="id78" class="indexterm"/> added some files to all cluster machines via the <code class="literal">cloud-config</code> file.</p><p>Let's check one more change that <a id="id79" class="indexterm"/>we have done in that file using the following command:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl list-machines</strong></span>
</pre></div><p>You will see something like this:</p><div class="mediaobject"><img src="../Images/image00126.jpeg" alt="Customizing a cluster via the cloud-config file"/></div><p style="clear:both; height: 1em;"> </p><p>Thus, you can see that we have some metadata assigned to cluster machines via the <code class="literal">cloud-init</code> file.</p></div><div class="section" title="Scheduling a fleet unit in the cluster"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec19"/>Scheduling a fleet unit in the cluster</h2></div></div></div><p>Now, for the fun part, we <a id="id80" class="indexterm"/>will schedule a <code class="literal">fleet</code> unit in the <a id="id81" class="indexterm"/>cluster.</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">Let's log in to the <code class="literal">core-03</code> machine:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh core-03 -- -A</strong></span>
</pre></div></li><li class="listitem">Create a new <code class="literal">fleet</code> unit called <code class="literal">hello-cluster.service</code> by copying and pasting this line:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vi hello-cluster.service</strong></span>
<span class="strong"><strong>[Unit]</strong></span>
<span class="strong"><strong>[Service]</strong></span>
<span class="strong"><strong>ExecStart=/usr/bin/bash -c "while true; do echo 'Hello Cluster'; sleep 1; done"</strong></span>
</pre></div></li><li class="listitem">Let's schedule the <code class="literal">hello-cluster.service</code> job for the cluster:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl start hello-cluster.service</strong></span>
</pre></div><p>You should see output as follows:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>Unit hello-cluster.service launched on bb53c039.../172.17.8.103</strong></span>
</pre></div><p>We can see that <code class="literal">hello-cluster.service</code> was scheduled to be run on the <code class="literal">172.17.8.103</code> machine because that machine first responded to the <code class="literal">fleetctl</code> command.</p><p>In later chapters, you will learn<a id="id82" class="indexterm"/> how to specifically schedule jobs to a particular <a id="id83" class="indexterm"/>machine. Now let's check out the real-time <code class="literal">hello-cluster.service</code> log:</p><div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ journalctl -u hello-cluster.service–f</strong></span>
</pre></div><p>You will see something like this:</p><div class="mediaobject"><img src="../Images/image00127.jpeg" alt="Scheduling a fleet unit in the cluster"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">To exit from the VM and reload the cluster, type the following command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant reload</strong></span>
</pre></div></li><li class="listitem">Now, <code class="literal">ssh</code> again back to any machine:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh core-02 -- -A</strong></span>
</pre></div></li><li class="listitem">Then run this command:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ fleetctl list-units</strong></span>
</pre></div><p>The following output will be seen:</p><div class="mediaobject"><img src="../Images/image00128.jpeg" alt="Scheduling a fleet unit in the cluster"/></div><p style="clear:both; height: 1em;"> </p></li><li class="listitem">As you can see, <code class="literal">hello-cluster.service </code>got scheduled on another machine; in our case, it is <code class="literal">core-01</code>. Suppose we <code class="literal">ssh</code> to it:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ vagrant ssh core-01 -- -A</strong></span>
</pre></div></li><li class="listitem">Then, we run the<a id="id84" class="indexterm"/> following command there. As a<a id="id85" class="indexterm"/> result, we will see the real-time log again:<div class="informalexample"><pre class="programlisting">
<span class="strong"><strong>$ journalctl -u hello-cluster.service–f</strong></span>
</pre></div><div class="mediaobject"><img src="../Images/image00129.jpeg" alt="Scheduling a fleet unit in the cluster"/></div><p style="clear:both; height: 1em;"> </p></li></ol><div style="height:10px; width: 1px"/></div></div></div>
<div class="section" title="References" id="aid-TI1E1"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec25"/>References</h1></div></div></div><p>You can read more <a id="id86" class="indexterm"/>about how to use cloud-config at <a class="ulink" href="https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/">https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/</a>.You can find out more <a id="id87" class="indexterm"/>about Vagrant at <a class="ulink" href="https://docs.vagrantup.com">https://docs.vagrantup.com</a>.If you have any issues or questions about Vagrant, you can subscribe to the<a id="id88" class="indexterm"/> Vagrant Google group at <a class="ulink" href="https://groups.google.com/forum/#!forum/vagrant-up">https://groups.google.com/forum/#!forum/vagrant-up</a>.</p></div>
<div class="section" title="Summary" id="aid-UGI01"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec26"/>Summary</h1></div></div></div><p>In this chapter,you learned how to set up aCoreOS cluster, customize it via cloud-config, schedule <code class="literal">fleet</code> service units to the cluster, and check the <code class="literal">fleet</code> unit in the cluster status and log.In the next chapter,you will learn how to perform local and cloud development setups.</p></div></body></html>