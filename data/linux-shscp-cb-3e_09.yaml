- en: Put On the Monitors Cap
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 戴上监控帽
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下食谱：
- en: Monitoring disk usage
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控磁盘使用情况
- en: Calculating the execution time for a command
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 计算命令的执行时间
- en: Collecting information about logged in users, boot logs, and boot failures
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 收集已登录用户的信息、启动日志和启动失败信息
- en: Listing the top ten CPU– consuming processes in an hour
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 列出一个小时内 CPU 消耗最多的前十个进程
- en: Monitoring command outputs with watch
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 `watch` 监控命令输出
- en: Logging access to files and directories
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 记录文件和目录的访问
- en: Logging with syslog
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 syslog 进行日志记录
- en: Managing log files with `logrotate`
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 `logrotate` 管理日志文件
- en: Monitoring user logins to find intruders
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控用户登录以发现入侵者
- en: Monitoring remote disk usage health
  id: totrans-11
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控远程磁盘使用健康状况
- en: Determining active user hours on a system
  id: totrans-12
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 确定系统上的活跃用户时段
- en: Measuring and optimizing power usage
  id: totrans-13
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 测量和优化电源使用
- en: Monitoring disk activity
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 监控磁盘活动
- en: Checking disks and filesystems for errors
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检查磁盘和文件系统的错误
- en: Examining disk health
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 检查磁盘健康状况
- en: Getting disk statistics
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 获取磁盘统计信息
- en: Introduction
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 介绍
- en: A computing system is a set of hardware and the software components that control
    it. The software includes the operating system kernel which allocates resources
    and many modules that perform individual tasks, ranging from reading disk data
    to serving web pages.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 计算机系统是硬件和控制它的软件组件的集合。软件包括操作系统内核，它分配资源，以及许多执行各个任务的模块，从读取磁盘数据到提供网页服务等。
- en: An administrator needs to monitor these modules and applications to confirm
    that they are working correctly and to understand whether resources need to be
    reallocated (moving a user partition to a larger disk, providing a faster network,
    and so on).
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 管理员需要监控这些模块和应用程序，以确认它们是否正常工作，并了解是否需要重新分配资源（例如将用户分区迁移到更大的磁盘、提供更快的网络等）。
- en: Linux provides both interactive programs for examining the system's current
    performance and modules for logging performance over time.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: Linux 提供了交互式程序来检查系统当前的性能，以及用于记录性能随时间变化的模块。
- en: This chapter describes the commands that monitor system activity and discusses
    logging techniques.
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍了监控系统活动的命令，并讨论了日志记录技术。
- en: Monitoring disk usage
  id: totrans-23
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控磁盘使用情况
- en: Disk space is always a limited resource. We monitor disk usage to know when
    it's running low, then search for large files or folders to delete, move, or compress.
    This recipe illustrates disk monitoring commands.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 磁盘空间始终是有限的资源。我们监控磁盘使用情况，以便在磁盘空间不足时及时发现，然后搜索大文件或文件夹以删除、移动或压缩。本食谱展示了磁盘监控命令。
- en: Getting ready
  id: totrans-25
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: The `du` (disk usage) and `df` (disk free) commands report disk usage. These
    tools report what files and folders are consuming disk space and how much space
    is available.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: '`du`（磁盘使用）和 `df`（磁盘空闲）命令用于报告磁盘使用情况。这些工具报告哪些文件和文件夹正在占用磁盘空间，以及剩余多少可用空间。'
- en: How to do it...
  id: totrans-27
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'To find the disk space used by a file (or files), use the following command:'
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 要查找文件（或文件）所占用的磁盘空间，请使用以下命令：
- en: '[PRE0]'
  id: totrans-29
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'Consider this example:'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考这个例子：
- en: '[PRE1]'
  id: totrans-31
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'To obtain the disk usage for all files inside a directory, along with the individual
    disk usage for each file shown in each line, use this command:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 要获取目录内所有文件的磁盘使用情况，并在每一行中显示每个文件的单独磁盘使用情况，请使用以下命令：
- en: '[PRE2]'
  id: totrans-33
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: The `-a` option outputs results for all files in the specified directory or
    directories recursively.
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: '`-a` 选项递归地输出指定目录或目录中所有文件的结果。'
- en: Running `du DIRECTORY` will output a similar result, but it will show only the
    size consumed by subdirectories. However, this does not show the disk usage for
    each of the files. For printing the disk usage by files, `-a` is mandatory.
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: 运行 `du DIRECTORY` 将输出类似的结果，但它只会显示子目录所占用的大小。然而，这并不显示每个文件的磁盘使用情况。要打印每个文件的磁盘使用情况，必须使用
    `-a`。
- en: 'Consider this example:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考这个例子：
- en: '[PRE3]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'The `du` command can be used on a directory:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '`du` 命令可以用于查看目录：'
- en: '[PRE4]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: There's more...
  id: totrans-40
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多...
- en: The `du` command includes options to define how the data is reported.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: '`du` 命令包括定义如何报告数据的选项。'
- en: Displaying disk usage in KB, MB, or blocks
  id: totrans-42
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 以 KB、MB 或块为单位显示磁盘使用情况
- en: 'By default, the disk usage command displays the total bytes used by a file.
    A more human-readable format is expressed in units such as KB, MB, or GB. The
    `-h` option displays the results in a human-readable format:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，磁盘使用命令显示文件所使用的总字节数。更易读的格式以 KB、MB 或 GB 等单位表示。`-h` 选项以人类可读的格式显示结果：
- en: '[PRE5]'
  id: totrans-44
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: 'Consider this example:'
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: 请参考这个例子：
- en: '[PRE6]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Alternatively, use it like this:'
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，像这样使用：
- en: '[PRE7]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: Displaying the grand total sum of disk usage
  id: totrans-49
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 显示磁盘使用情况的总和
- en: 'The `-c` option will calculate the total size used by files or directories,
    as well as display individual file sizes:'
  id: totrans-50
  prefs: []
  type: TYPE_NORMAL
  zh: '`-c`选项将计算文件或目录使用的总大小，并显示每个文件的大小：'
- en: '[PRE8]'
  id: totrans-51
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'Alternatively, use it like one of these:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，可以像这样使用它：
- en: '[PRE9]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'Or:'
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: 或者：
- en: '[PRE10]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: The `-c` option can be used with options such as `-a` and `-h` to produce the
    usual output, with an extra line containing the total size.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: '`-c`选项可以与`-a`和`-h`等选项一起使用，生成常规输出，并附加一行包含总大小的额外信息。'
- en: 'The `-s` option (summarize), will print the grand total as the output. The
    `-h` flag can be used with it to print in a human-readable format:'
  id: totrans-57
  prefs: []
  type: TYPE_NORMAL
  zh: '`-s`选项（汇总），将打印总计作为输出。`-h`标志可以与其一起使用，以以人类可读的格式打印：'
- en: '[PRE11]'
  id: totrans-58
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: Printing sizes in specified units
  id: totrans-59
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 以指定单位打印大小
- en: 'The `-b`, `-k`, and `-m` options will force `du` to print the disk usage in
    specified units. Note that these cannot be used with the `-h` option:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '`-b`、`-k`和`-m`选项将强制`du`以指定的单位打印磁盘使用情况。请注意，这些选项不能与`-h`选项一起使用：'
- en: 'Print the size in bytes (by default):'
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以字节为单位打印大小（默认）：
- en: '[PRE12]'
  id: totrans-62
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Print the size in kilobytes:'
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以千字节为单位打印大小：
- en: '[PRE13]'
  id: totrans-64
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Print the size in megabytes:'
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以兆字节为单位打印大小：
- en: '[PRE14]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Print the size in the given `BLOCK` size specified:'
  id: totrans-67
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 以指定的给定`BLOCK`大小打印大小：
- en: '[PRE15]'
  id: totrans-68
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: Here, `BLOCK_SIZE` is specified in bytes.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 这里，`BLOCK_SIZE`以字节为单位指定。
- en: 'Note that the file size returned is not intuitively obvious. With the `-b`
    option, `du` reports the exact number of bytes in the file. With other options,
    `du` reports the amount of disk space used by the file. Since disk space is allocated
    in fixed-size chunks (commonly 4 K), the space used by a 400-byte file will be
    a single block (4 K):'
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，返回的文件大小并不直观明显。使用`-b`选项时，`du`报告文件的确切字节数。使用其他选项时，`du`报告文件使用的磁盘空间量。由于磁盘空间是以固定大小的块（通常是4K）分配的，一个400字节的文件将占用一个块（4K）的空间：
- en: '[PRE16]'
  id: totrans-71
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Excluding files from the disk usage calculation
  id: totrans-72
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在磁盘使用计算中排除文件
- en: The `--exclude` and `-exclude-from` options cause `du` to exclude files from
    the disk usage calculation.
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '`--exclude`和`-exclude-from`选项会导致`du`排除文件的磁盘使用计算。'
- en: 'The `-exclude` option can be used with wildcards or a single filename:'
  id: totrans-74
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`-exclude`选项可以与通配符或单个文件名一起使用：'
- en: '[PRE17]'
  id: totrans-75
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: 'Consider this example:'
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑以下示例：
- en: '[PRE18]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: The `--exclude` option will exclude one file or files that match a pattern.
    The `-exclude-from` option allows more files or patterns to be excluded. Each
    filename or pattern must be on a single line.
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`--exclude`选项将排除一个文件或与模式匹配的文件。`-exclude-from`选项允许排除更多的文件或模式。每个文件名或模式必须单独占一行。'
- en: '[PRE19]'
  id: totrans-79
  prefs: []
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'The `-max-depth` option restricts how many subdirectories du will examine.
    A depth of `1` calculates disk usage in the current directory. A depth of `2` calculates
    usage in the current directory and the next subdirectory:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: '`-max-depth`选项限制`du`将检查的子目录层级。深度为`1`时计算当前目录的磁盘使用情况，深度为`2`时计算当前目录和下一级子目录的使用情况：'
- en: '[PRE20]'
  id: totrans-81
  prefs: []
  type: TYPE_PRE
  zh: '[PRE20]'
- en: The `-x` option limits `du` to a single filesystem. The default behavior for
    du is to follow links and mount points.
  id: totrans-82
  prefs: []
  type: TYPE_NORMAL
  zh: '`-x`选项将`du`限制为单个文件系统。`du`的默认行为是跟随链接和挂载点。'
- en: The `du` command requires read permission for all files, and read and execute
    for all directories. The `du` command will throw an error if the user running
    it does not have proper permissions.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: '`du`命令需要对所有文件的读取权限，并且对所有目录需要读取和执行权限。如果执行该命令的用户没有适当的权限，`du`命令将抛出错误。'
- en: Finding the ten largest size files from a given directory
  id: totrans-84
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 从给定目录中找到十个最大的文件
- en: 'Combine the `du` and sort commands to find large files that should be deleted
    or moved:'
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 将`du`和排序命令结合起来，找出应删除或移动的大文件：
- en: '[PRE21]'
  id: totrans-86
  prefs: []
  type: TYPE_PRE
  zh: '[PRE21]'
- en: The `-a` option makes du display the size of all the files and directories in
    the `SOURCE_DIR`. The first column of the output is the size. The `-k` option
    causes it to be displayed in kilobytes. The second column contains the file or
    folder name.
  id: totrans-87
  prefs: []
  type: TYPE_NORMAL
  zh: '`-a`选项使`du`显示`SOURCE_DIR`中所有文件和目录的大小。输出的第一列是大小。`-k`选项使其以千字节为单位显示。第二列包含文件或文件夹名称。'
- en: 'The `-n` option to `sort` performs a numerical sort. The `-1` option specifies
    column `1` and the `-r` option reverses the sort order. The `head` command extracts
    the first ten lines from the output:'
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: '`-n`选项对`sort`执行数字排序。`-1`选项指定列`1`，`-r`选项则会反转排序顺序。`head`命令从输出中提取前十行：'
- en: '[PRE22]'
  id: totrans-89
  prefs: []
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'One of the drawbacks of this one-liner is that it includes directories in the
    result. We can improve the one-liner to output only the large files with the `find`
    command:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 这个单行命令的一个缺点是它包括了目录在结果中。我们可以改进这个命令，通过`find`命令只输出大文件：
- en: '[PRE23]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE23]'
- en: The find command selects only filenames for du to process, rather than having
    du traverse the filesystem to select items to report.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: '`find`命令仅选择文件名供`du`处理，而不是让`du`遍历文件系统来选择要报告的项目。'
- en: Note that the du command reports the number of bytes that a file requires. This
    is not necessarily the same as the amount of disk space the file is consuming.
    Space on the disk is allocated in blocks, so a 1-byte file will consume one disk
    block, usually between 512 and 4096 bytes.
  id: totrans-93
  prefs: []
  type: TYPE_NORMAL
  zh: 请注意，`du`命令报告一个文件所需的字节数。这不一定与文件实际占用的磁盘空间相同。磁盘空间是按块分配的，所以一个1字节的文件会占用一个磁盘块，通常大小在512到4096字节之间。
- en: The next section describes using the `df` command to determine how much space
    is actually available.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: 下一部分描述如何使用`df`命令来确定实际可用的空间。
- en: Disk free information
  id: totrans-95
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 磁盘空闲信息
- en: 'The `du` command provides information about the usage, while `df` provides
    information about free disk space. Use `-h` with `df` to print the disk space
    in a human-readable format. Consider this example:'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '`du`命令提供使用情况的信息，而`df`提供有关可用磁盘空间的信息。使用`-h`选项与`df`一起使用，可以以人类可读的格式打印磁盘空间。考虑这个例子：'
- en: '[PRE24]'
  id: totrans-97
  prefs: []
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'The `df` command can be invoked with a folder name. In that case, it will report
    free space for the disk partition that contains that directory. This is useful
    if you don''t know which partition contains a directory:'
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '`df`命令可以与文件夹名称一起调用。在这种情况下，它将报告包含该目录的磁盘分区的空闲空间。如果你不知道哪个分区包含该目录，这将非常有用：'
- en: '[PRE25]'
  id: totrans-99
  prefs: []
  type: TYPE_PRE
  zh: '[PRE25]'
- en: Calculating the execution time for a command
  id: totrans-100
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 计算命令的执行时间
- en: Execution time is the criteria for analyzing an application's efficiency or
    comparing algorithms.
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: 执行时间是分析应用程序效率或比较算法的标准。
- en: How to do it...
  id: totrans-102
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: The `time` command measures an application's execution time.
  id: totrans-103
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`time`命令用于衡量应用程序的执行时间。'
- en: 'Consider the following example:'
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑以下例子：
- en: '[PRE26]'
  id: totrans-105
  prefs: []
  type: TYPE_PRE
  zh: '[PRE26]'
- en: The `time` command executes `APPLICATION`. When `APPLICATION` is complete, the
    `time` command reports the real, system, and user time statistics to `stderr`
    and sends the APPLICATION's normal output to `stdout`.
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: '`time`命令执行`APPLICATION`。当`APPLICATION`完成时，`time`命令将实际时间、系统时间和用户时间统计信息报告到`stderr`，并将`APPLICATION`的正常输出发送到`stdout`。'
- en: '[PRE27]'
  id: totrans-107
  prefs: []
  type: TYPE_PRE
  zh: '[PRE27]'
- en: An executable binary of the `time` command is found in `/usr/bin/time`. If you
    are running bash, you'll get the shell built-in `time` by default. The shell built-in
    `time` has limited options. Use an absolute path (`/usr/bin/time`) to access the
    extended functionality.
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: '`time`命令的可执行二进制文件位于`/usr/bin/time`。如果你使用的是bash，默认情况下会得到shell内置的`time`命令。内置的`time`命令选项有限。使用绝对路径（`/usr/bin/time`）可以访问扩展功能。'
- en: 'The `-o` option will write the time statistics to a file:'
  id: totrans-109
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-o`选项将时间统计信息写入文件：'
- en: '[PRE28]'
  id: totrans-110
  prefs: []
  type: TYPE_PRE
  zh: '[PRE28]'
- en: The filename must appear immediately after the `-o` flag.
  id: totrans-111
  prefs: []
  type: TYPE_NORMAL
  zh: 文件名必须紧跟在`-o`标志后面。
- en: 'The `-a` flag can be used with `-o` to append the time statistics to a file:'
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: '`-a`标志可以与`-o`一起使用，将时间统计信息附加到文件中：'
- en: '[PRE29]'
  id: totrans-113
  prefs: []
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'The `-f` option specifies the statistics to report and the format for the output.
    A format string includes one or more parameters prefixed with a `%`. Format parameters
    include the following:'
  id: totrans-114
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-f`选项指定要报告的统计信息及输出格式。格式字符串包括一个或多个以`%`为前缀的参数。格式参数包括以下内容：'
- en: 'Real time: `%e`'
  id: totrans-115
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 实际时间：`%e`
- en: 'User time: `%U`'
  id: totrans-116
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 用户时间：`%U`
- en: 'System time: `%S`'
  id: totrans-117
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统时间：`%S`
- en: 'System Page size: `%Z`'
  id: totrans-118
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 系统页面大小：`%Z`
- en: 'We can create a formatted output by combining these parameters with extra text:'
  id: totrans-119
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以通过将这些参数与额外的文本结合，创建格式化的输出：
- en: '[PRE30]'
  id: totrans-120
  prefs: []
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Consider this example:'
  id: totrans-121
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑这个例子：
- en: '[PRE31]'
  id: totrans-122
  prefs: []
  type: TYPE_PRE
  zh: '[PRE31]'
- en: The `%U` parameter specifies user time.
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: '`%U`参数指定用户时间。'
- en: The **time** command sends the target application's output to `stdout` and the
    time command output to `stderr`. We can redirect the output with a redirection
    operator (`>`) and redirect the time information output with the (`2>`) error
    redirection operator.
  id: totrans-124
  prefs: []
  type: TYPE_NORMAL
  zh: '**time**命令将目标应用程序的输出发送到`stdout`，并将`time`命令的输出发送到`stderr`。我们可以使用重定向操作符（`>`）重定向输出，并使用错误重定向操作符（`2>`）重定向时间信息输出。'
- en: 'Consider the following example:'
  id: totrans-125
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑以下例子：
- en: '[PRE32]'
  id: totrans-126
  prefs: []
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'The format command can report memory usage as well as timing information. The
    `%M` flag shows the maximum memory used in KB and `%Z` parameter causes the time
    command to report the system page size:'
  id: totrans-127
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 格式命令可以报告内存使用情况以及计时信息。`%M`标志显示最大使用内存（以KB为单位），`%Z`参数使得时间命令报告系统页面大小：
- en: '[PRE33]'
  id: totrans-128
  prefs: []
  type: TYPE_PRE
  zh: '[PRE33]'
- en: In this example, the output of the target application is unimportant, so the
    standard output is directed to `/dev/null` rather than being displayed.
  id: totrans-129
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个例子中，目标应用程序的输出并不重要，因此标准输出被重定向到`/dev/null`，而不是显示出来。
- en: How it works...
  id: totrans-130
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'The time command reports these times by default:'
  id: totrans-131
  prefs: []
  type: TYPE_NORMAL
  zh: '`time`命令默认报告以下时间：'
- en: '**Real**: This is the wall clock time-the time from start to finish of the
    command. This is the elapsed time including time slices used by other processes
    and the time the process spends when blocked (for example, time spent waiting
    for I/O to complete).'
  id: totrans-132
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Real**：这是墙钟时间——命令从开始到结束的时间。包括其他进程使用的时间片以及进程在被阻塞时所花费的时间（例如，等待 I/O 完成的时间）。'
- en: '**User**: This is the amount of CPU time spent in user-mode code (outside the
    kernel) within the process. This is the CPU time used to execute the process.
    Other processes, and the time these processes spend when blocked do not count
    toward this figure.'
  id: totrans-133
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**User**：这是进程在用户模式代码（内核外部）中消耗的 CPU 时间量。它是执行进程所用的 CPU 时间。其他进程以及这些进程在被阻塞时所花费的时间不计入此项。'
- en: '**Sys**: This is the amount of CPU time spent in the kernel within the process;
    the CPU time spent in system calls within the kernel, as opposed to the library
    code, which runs in the user space. Like user time, this is only the CPU time
    used by the process. Refer to the following table for a brief description of the
    kernel mode (also known as supervisor mode) and the system call mechanism.'
  id: totrans-134
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**Sys**：这是进程在内核中消耗的 CPU 时间量；指的是在内核中进行系统调用时消耗的 CPU 时间，而不是运行在用户空间中的库代码。像用户时间一样，这只是进程使用的
    CPU 时间。请参考下表，简要描述内核模式（也称为主管模式）和系统调用机制。'
- en: Many details regarding a process can be reported by the `time` command. These
    include exit status, number of signals received, and number of context switches
    made. Each parameter can be displayed when a suitable format string is supplied
    to the `-f` option.
  id: totrans-135
  prefs: []
  type: TYPE_NORMAL
  zh: '`time` 命令可以报告进程的许多细节，包括退出状态、接收到的信号数量和进行的上下文切换次数。每个参数都可以在提供适当格式字符串给 `-f` 选项时显示。'
- en: 'The following table shows some of the interesting parameters:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: 下表展示了一些有趣的参数：
- en: '| **Parameter** | **Description** |'
  id: totrans-137
  prefs: []
  type: TYPE_TB
  zh: '| **Parameter** | **Description** |'
- en: '| --- | --- |'
  id: totrans-138
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- |'
- en: '| `%C` | This shows the name and command-line arguments of the command being
    timed. |'
  id: totrans-139
  prefs: []
  type: TYPE_TB
  zh: '| `%C` | 显示正在计时的命令的名称和命令行参数。 |'
- en: '| `%D` | This shows the average size of the process''s unshared data area,
    in kilobytes. |'
  id: totrans-140
  prefs: []
  type: TYPE_TB
  zh: '| `%D` | 显示进程未共享数据区域的平均大小，单位是千字节。 |'
- en: '| `%E` | This shows the elapsed real (wall clock) time used by the process
    in [hours:] minutes:seconds. |'
  id: totrans-141
  prefs: []
  type: TYPE_TB
  zh: '| `%E` | 显示进程使用的实际（墙钟）时间，格式为 [小时：]分钟：秒。 |'
- en: '| `%x` | This shows the exit status of the command. |'
  id: totrans-142
  prefs: []
  type: TYPE_TB
  zh: '| `%x` | 显示命令的退出状态。 |'
- en: '| `%k` | This shows the number of signals delivered to the process. |'
  id: totrans-143
  prefs: []
  type: TYPE_TB
  zh: '| `%k` | 显示发送到进程的信号数量。 |'
- en: '| `%W` | This shows the number of times the process was swapped out of the
    main memory. |'
  id: totrans-144
  prefs: []
  type: TYPE_TB
  zh: '| `%W` | 显示进程被交换出主内存的次数。 |'
- en: '| `%Z` | This shows the system''s page size in bytes. This is a per-system
    constant, but varies between systems. |'
  id: totrans-145
  prefs: []
  type: TYPE_TB
  zh: '| `%Z` | 显示系统的页面大小，单位是字节。这是一个每个系统的常量，但在不同的系统之间会有所不同。 |'
- en: '| `%P` | This shows the percentage of the CPU that this job got. This is just
    user + system times divided by the total running time. It also prints a percentage
    sign. |'
  id: totrans-146
  prefs: []
  type: TYPE_TB
  zh: '| `%P` | 显示该作业获得的 CPU 百分比。它是用户时间 + 系统时间除以总运行时间的结果，并显示百分号。 |'
- en: '| `%K` | This shows the average total (data + stack + text) memory usage of
    the process, in Kilobytes. |'
  id: totrans-147
  prefs: []
  type: TYPE_TB
  zh: '| `%K` | 显示进程的平均总内存使用量（数据 + 堆栈 + 文本），单位是千字节。 |'
- en: '| `%w` | This shows the number of times that the program was context-switched
    voluntarily, for instance, while waiting for an I/O operation to complete. |'
  id: totrans-148
  prefs: []
  type: TYPE_TB
  zh: '| `%w` | 显示程序自愿进行上下文切换的次数，例如，在等待 I/O 操作完成时。 |'
- en: '| `%c` | This shows the number of times the process was context-switched involuntarily
    (because the time slice expired). |'
  id: totrans-149
  prefs: []
  type: TYPE_TB
  zh: '| `%c` | 显示进程被强制上下文切换的次数（因为时间片用完）。 |'
- en: Collecting information about logged in users, boot logs, and boot failures
  id: totrans-150
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 收集有关登录用户、启动日志和启动失败的信息
- en: Linux supports commands to report aspects of the runtime system including logged
    in users, how long the computer has been powered on, and boot failures. This data
    is used to allocate resources and diagnose problems.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: Linux 支持报告运行时系统方面的命令，包括登录用户、计算机开机时长和启动失败。这些数据用于分配资源和诊断问题。
- en: Getting ready
  id: totrans-152
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: This recipe introduces the who, w, users, uptime, last, and lastb commands.
  id: totrans-153
  prefs: []
  type: TYPE_NORMAL
  zh: 本文介绍了 who、w、users、uptime、last 和 lastb 命令。
- en: How to do it...
  id: totrans-154
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The `who` command reports information about the current users:'
  id: totrans-155
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`who` 命令报告当前用户的信息：'
- en: '[PRE34]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE34]'
- en: This output lists the login name, the TTY used by the users, login time, and
    remote hostname (or X display information) about logged in users.
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: 该输出列出了登录名、用户使用的TTY、登录时间以及关于登录用户的远程主机名（或X显示信息）。
- en: '**TTY** (the term comes from **TeleTYpewriter**) is the device file associated
    with a text terminal that is created in `/dev` when a terminal is newly spawned
    by the user (for example, `/dev/pts/3`). The device path for the current terminal
    can be found out by executing the `tty` command.'
  id: totrans-158
  prefs: []
  type: TYPE_NORMAL
  zh: '**TTY**（这个术语源自**TeleTYpewriter**）是与文本终端相关联的设备文件，它在用户新创建终端时会在`/dev`目录下生成（例如，`/dev/pts/3`）。可以通过执行`tty`命令找到当前终端的设备路径。'
- en: 'The `w` command provides more detailed information:'
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`w`命令提供更详细的信息：'
- en: '[PRE35]'
  id: totrans-160
  prefs: []
  type: TYPE_PRE
  zh: '[PRE35]'
- en: This first line lists the current time, system uptime, number of users currently
    logged on, and the system load averages for the past 1, 5, and 15 minutes. Following
    this, the details about each login session are displayed with each line containing
    the login name, the TTY name, the remote host, login time, idle time, total CPU
    time used by the user since login, CPU time of the currently running process,
    and the command line of their current process.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: 第一行列出了当前时间、系统开机时间、当前登录的用户数，以及过去1、5和15分钟的系统负载平均值。接下来，关于每个登录会话的详细信息会显示出来，每一行都包含登录名、TTY名称、远程主机、登录时间、空闲时间、用户自登录以来的总CPU时间、当前进程的CPU时间以及当前进程的命令行。
- en: Load average in the `uptime` command's output indicates system load. This is
    explained in more detail in [Chapter 10](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml),
    *Administration Calls*.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: '`uptime`命令输出中的负载平均值表示系统负载。更详细的说明可以参见[第10章](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml)，*系统管理调用*。'
- en: 'The users command lists only the name of logged-in users:'
  id: totrans-163
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`users`命令仅列出登录用户的名字：'
- en: '[PRE36]'
  id: totrans-164
  prefs: []
  type: TYPE_PRE
  zh: '[PRE36]'
- en: 'If a user has multiple sessions open, either by logging in remotely several
    times or opening several terminal windows, there will be an entry for each session.
    In the preceding output, the `slynux` user has opened three terminals sessions.
    The easiest way to print unique users is to filter the output through `sort` and
    `uniq`:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 如果用户打开了多个会话，比如多次远程登录或打开多个终端窗口，那么每个会话都会有一个条目。在上述输出中，`slynux`用户打开了三个终端会话。最简单的方法是通过`sort`和`uniq`命令来过滤输出，以打印唯一的用户：
- en: '[PRE37]'
  id: totrans-166
  prefs: []
  type: TYPE_PRE
  zh: '[PRE37]'
- en: The `tr` command replaces each `' '` character with `'\n'`. Then a combination
    of `sort` and `uniq` reduces the list to a unique entry for each user.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: '`tr`命令将每个空格字符`'' ''`替换为换行符`''\n''`。然后，`sort`和`uniq`的组合将列表减少为每个用户的唯一条目。'
- en: 'The `uptime` command reports how long the system has been powered on:'
  id: totrans-168
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`uptime`命令报告系统已开机的时长：'
- en: '[PRE38]'
  id: totrans-169
  prefs: []
  type: TYPE_PRE
  zh: '[PRE38]'
- en: 'The time that follows the `up` word is how long the system has been powered
    on. We can write a one-liner to extract the uptime only:'
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 紧随“up”一词后的时间表示系统已开机的时长。我们可以编写一个一行命令，仅提取系统的开机时间：
- en: '[PRE39]'
  id: totrans-171
  prefs: []
  type: TYPE_PRE
  zh: '[PRE39]'
- en: This uses `sed` to replace the line of output with only the string between the
    word up and the comma before users.
  id: totrans-172
  prefs: []
  type: TYPE_NORMAL
  zh: 这使用`sed`命令将输出行替换为仅包含“up”一词和“users”前面的逗号之间的字符串。
- en: 'The `last` command provides a list of users who have logged onto the system
    since the `/var/log/wtmp` file was created. This may go back a year or more:'
  id: totrans-173
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`last`命令提供自`/var/log/wtmp`文件创建以来，所有登录系统的用户列表。这个列表可能会回溯一年或更长时间：'
- en: '[PRE40]'
  id: totrans-174
  prefs: []
  type: TYPE_PRE
  zh: '[PRE40]'
- en: The `last` command reports who logged in, what `tty` they were assigned, where
    they logged in from (IP address or local terminal), the login, logout, and session
    time. Reboots are marked as a login by a pseudo-user named `reboot`.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: '`last`命令报告谁登录了，分配给他们的`tty`，他们从哪里登录（IP地址或本地终端），登录时间、注销时间以及会话时长。重启会被伪用户`reboot`标记为登录。'
- en: 'The `last` command allows you to define a user to get only information about
    that user:'
  id: totrans-176
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`last`命令允许你定义一个用户，仅获取该用户的信息：'
- en: '[PRE41]'
  id: totrans-177
  prefs: []
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'USER can be a real user or the pseudo-user `reboot`:'
  id: totrans-178
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 用户（USER）可以是真实用户或伪用户`reboot`：
- en: '[PRE42]'
  id: totrans-179
  prefs: []
  type: TYPE_PRE
  zh: '[PRE42]'
- en: 'The `lastb` command will give you a list of the failed login attempts:'
  id: totrans-180
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`lastb`命令会列出所有失败的登录尝试：'
- en: '[PRE43]'
  id: totrans-181
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: The `lastb` command must be run as the root user.
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: '`lastb`命令必须以root用户身份运行。'
- en: Both `last` and `lastb` report the contents of `/var/log/wtmp`. The default
    is to report month, day, and time of the event. However, there may be multiple
    years of data in that file, and the month/day can be confusing.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: '`last`和`lastb`命令报告`/var/log/wtmp`文件的内容。默认情况下，报告事件的月份、日期和时间。然而，该文件中可能有多年的数据，月份和日期可能会让人困惑。'
- en: 'The `-F` flag will report the full date:'
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: '`-F`标志会报告完整日期：'
- en: '[PRE44]'
  id: totrans-185
  prefs: []
  type: TYPE_PRE
  zh: '[PRE44]'
- en: Listing the top ten CPU– consuming processes in an hour
  id: totrans-186
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 列出一个小时内CPU消耗最多的十个进程
- en: The CPU is another resource that can be exhausted by a misbehaving process.
    Linux supports commands to identify and control the processes hogging the CPU.
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: CPU是另一个可以被不当行为的进程耗尽的资源。Linux支持命令来识别并控制占用CPU资源的进程。
- en: Getting ready
  id: totrans-188
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: The `ps` command displays details about the processes running on the system.
    It reports details such as CPU usage, running commands, memory usage, and process
    status. The `ps` command can be used in a script to identify who consumed the
    most CPU resource over an hour. For more details on the `ps` command, refer to
    [Chapter 10](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml), *Administration Calls*.
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: '`ps`命令显示系统中运行的进程的详细信息。它报告诸如CPU使用率、运行命令、内存使用情况和进程状态等详细信息。`ps`命令可以在脚本中使用，以识别在一小时内消耗最多CPU资源的进程。有关`ps`命令的更多详细信息，请参阅[第10章](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml)《系统管理命令》。'
- en: How to do it...
  id: totrans-190
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何实现...
- en: 'This shell script monitors and calculates CPU usages for one hour:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 这个shell脚本监视并计算CPU使用率，持续一个小时：
- en: '[PRE45]'
  id: totrans-192
  prefs: []
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'The output resembles the following:'
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: 输出类似如下：
- en: '[PRE46]'
  id: totrans-194
  prefs: []
  type: TYPE_PRE
  zh: '[PRE46]'
- en: How it works...
  id: totrans-195
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The CPU usage data is generated by the first loop that runs for one hour (3600
    seconds). Once each minute, the `ps -eocomm,pcpu` command generates a report on
    the system activity at that time. The `-e` option specifies to collect data on
    all processes, not just this session's tasks. The `-o` option specifies an output
    format. The `comm` and `pcpu` words specify reporting the command name and percentage
    of CPU, respectively. This `ps` command generates a line with the command name
    and current percentage of CPU usage for each running process. These lines are
    filtered with `grep` to remove lines where there was no CPU usage (%CPU is 0.0)
    and the `COMMAND %CPU` header. The interesting lines are appended to a temporary
    file.
  id: totrans-196
  prefs: []
  type: TYPE_NORMAL
  zh: CPU使用数据是由第一个循环生成的，该循环运行一小时（3600秒）。每分钟，`ps -eocomm,pcpu`命令会生成该时刻的系统活动报告。`-e`选项指定收集所有进程的数据，而不仅仅是当前会话的任务。`-o`选项指定输出格式。`comm`和`pcpu`字段分别指定报告命令名和CPU使用百分比。该`ps`命令为每个正在运行的进程生成一行，显示命令名称和当前的CPU使用百分比。这些行通过`grep`过滤，去除没有CPU使用的行（%CPU为0.0）和`COMMAND
    %CPU`表头。感兴趣的行将附加到临时文件中。
- en: The temporary file is named `/tmp/cpu_usage.$$`. Here, `$$` is a script variable
    that holds the process ID (PID) of the current script. For example, if the script's
    PID is `1345`, the temporary file will be named `/tmp/cpu_usage.1345`.
  id: totrans-197
  prefs: []
  type: TYPE_NORMAL
  zh: 临时文件命名为`/tmp/cpu_usage.$$`。其中，`$$`是一个脚本变量，表示当前脚本的进程ID（PID）。例如，如果脚本的PID为`1345`，则临时文件名为`/tmp/cpu_usage.1345`。
- en: The statistics file will be ready after one hour and will contain 60 sets of
    entries, corresponding to the system status at each minute. The `awk` script sums
    the total CPU usage for each process into an associative array named process.
    This array uses the process name as array index. Finally, `awk` sorts the result
    with a numeric reverse sort according to the total CPU usage and uses head to
    limit the report to the top 10 usage entries.
  id: totrans-198
  prefs: []
  type: TYPE_NORMAL
  zh: 统计文件将在一小时后准备好，并包含60组条目，分别对应每分钟的系统状态。`awk`脚本将每个进程的总CPU使用率加总到一个名为process的关联数组中。该数组以进程名称作为数组索引。最后，`awk`按照总CPU使用率对结果进行数字反向排序，并使用head命令限制报告为前10个使用量条目。
- en: See also
  id: totrans-199
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 另见
- en: The *Using awk for advanced text processing* recipe of [Chapter 4](22424a9e-fea7-49de-9589-ea32aeb0b829.xhtml),
    *Texting and Driving*, explains the `awk` command
  id: totrans-200
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第4章](22424a9e-fea7-49de-9589-ea32aeb0b829.xhtml)《文本处理与驾驶》中的*使用awk进行高级文本处理*方法解释了`awk`命令'
- en: The *Using head and tail for printing the last or first 10 lines* recipe of
    [Chapter 3](19219dcb-e034-408e-8fe2-db6daa9278c8.xhtml), *File In, File Out*,
    explains the `tail` command
  id: totrans-201
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第3章](19219dcb-e034-408e-8fe2-db6daa9278c8.xhtml)《文件输入，文件输出》中的*使用head和tail打印最后或最前10行*方法解释了`tail`命令'
- en: Monitoring command outputs with watch
  id: totrans-202
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用`watch`监控命令输出
- en: The watch command will execute a command at intervals and display that command's
    output. You can use a terminal session and the screen command described in [chapter
    10](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml), *Administration Calls* to create
    a customized dashboard to monitor your systems with watch.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: '`watch`命令会定期执行命令并显示该命令的输出。你可以使用终端会话和在[第10章](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml)《系统管理命令》中描述的`screen`命令，创建一个自定义仪表盘，通过`watch`监控系统。'
- en: How to do it...
  id: totrans-204
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何实现...
- en: 'The `watch` command monitors the output of a command on the terminal at regular
    intervals. The syntax of the `watch` command is as follows:'
  id: totrans-205
  prefs: []
  type: TYPE_NORMAL
  zh: '`watch`命令定期监视终端上命令的输出。`watch`命令的语法如下：'
- en: '[PRE47]'
  id: totrans-206
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: 'Consider this example:'
  id: totrans-207
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑这个例子：
- en: '[PRE48]'
  id: totrans-208
  prefs: []
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'Alternatively, it can be used like this:'
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，它可以这样使用：
- en: '[PRE49]'
  id: totrans-210
  prefs: []
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'Consider the following example:'
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: 请考虑以下示例：
- en: '[PRE50]'
  id: totrans-212
  prefs: []
  type: TYPE_PRE
  zh: '[PRE50]'
- en: This command will update the output at a default interval of two seconds.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 该命令将在默认的两秒间隔内更新输出。
- en: 'The `-n SECONDS` option defines the time interval for updating the output:'
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: '`-n SECONDS` 选项定义了更新输出的时间间隔：'
- en: '[PRE51]'
  id: totrans-215
  prefs: []
  type: TYPE_PRE
  zh: '[PRE51]'
- en: There's more
  id: totrans-216
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多
- en: The `watch` command can be used with any command that generates output. Some
    commands change their output frequently, and the changes are more important than
    the entire output. The watch command will highlight the difference between consecutive
    runs. Note that this highlight only lasts until the next update.
  id: totrans-217
  prefs: []
  type: TYPE_NORMAL
  zh: '`watch` 命令可以与任何生成输出的命令一起使用。有些命令会频繁更改其输出，而这些变化比整个输出更为重要。`watch` 命令会突出显示连续执行之间的差异。请注意，这种高亮显示仅持续到下一次更新。'
- en: Highlighting the differences in the watch output
  id: totrans-218
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 在 `watch` 输出中突出显示差异
- en: 'The `-d` option highlights differences between successive runs of the command
    being watched:'
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: '`-d` 选项用于突出显示被监视命令连续执行之间的差异：'
- en: '[PRE52]'
  id: totrans-220
  prefs: []
  type: TYPE_PRE
  zh: '[PRE52]'
- en: Logging access to files and directories
  id: totrans-221
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 记录对文件和目录的访问
- en: There are many reasons you may need to be notified when a file is accessed.
    You might want to know when a file is modified so it can be backed up, or you
    might want to know when files in `/bin` are modified by a hacker.
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 有很多原因可能需要在文件被访问时得到通知。你可能想知道何时修改了文件，以便进行备份，或者你可能想知道 `/bin` 目录中的文件是否被黑客修改。
- en: Getting ready
  id: totrans-223
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备中
- en: The `inotifywait` command watches a file or directory and reports when an event
    occurs. It doesn't come by default with every Linux distribution. You have to
    install the `inotify-tools` package. It requires the `inotify` support in the
    Linux kernel. Most new GNU/Linux distributions compile the `inotify` support into
    the kernel.
  id: totrans-224
  prefs: []
  type: TYPE_NORMAL
  zh: '`inotifywait` 命令用于监视文件或目录，并在发生事件时报告。并非每个 Linux 发行版都默认包含它。你需要安装 `inotify-tools`
    包。它需要 Linux 内核中的 `inotify` 支持。大多数新的 GNU/Linux 发行版将 `inotify` 支持编译进内核。'
- en: How to do it...
  id: totrans-225
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何做...
- en: 'The `inotify` command can monitor a directory:'
  id: totrans-226
  prefs: []
  type: TYPE_NORMAL
  zh: '`inotify` 命令可以监视一个目录：'
- en: '[PRE53]'
  id: totrans-227
  prefs: []
  type: TYPE_PRE
  zh: '[PRE53]'
- en: 'A sample output resembles the following:'
  id: totrans-228
  prefs: []
  type: TYPE_NORMAL
  zh: 示例输出如下所示：
- en: '[PRE54]'
  id: totrans-229
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: How it works...
  id: totrans-230
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理...
- en: The previous script will log create, move, and delete events in the given path.
    The `-m` option causes watch to stay active and monitor changes continuously,
    rather than exiting after an event happens. The `-r` option enables a recursive
    watch of the directories (symbolic links are ignored). The `-e` option specifies
    the list of events to be watched and `-q` reduces the verbose messages and prints
    only the required ones. This output can be redirected to a log file.
  id: totrans-231
  prefs: []
  type: TYPE_NORMAL
  zh: 上述脚本会记录指定路径中的创建、移动和删除事件。`-m` 选项使 `watch` 命令保持活跃，并持续监控更改，而不是在事件发生后退出。`-r` 选项启用递归监视目录（符号链接会被忽略）。`-e`
    选项指定要监视的事件列表，`-q` 选项减少冗长信息，仅打印所需的内容。此输出可以重定向到日志文件。
- en: 'The events that `inotifywait` can check include the following:'
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: '`inotifywait` 可以检查的事件包括以下内容：'
- en: '| **Event** | **Description** |'
  id: totrans-233
  prefs: []
  type: TYPE_TB
  zh: '| **事件** | **描述** |'
- en: '| `access` | When a read happens to a file |'
  id: totrans-234
  prefs: []
  type: TYPE_TB
  zh: '| `access` | 当文件发生读取操作时 |'
- en: '| `modify` | When file contents are modified |'
  id: totrans-235
  prefs: []
  type: TYPE_TB
  zh: '| `modify` | 当文件内容被修改时 |'
- en: '| `attrib` | When metadata is changed |'
  id: totrans-236
  prefs: []
  type: TYPE_TB
  zh: '| `attrib` | 当文件元数据发生变化时 |'
- en: '| `move` | When a file undergoes a move operation |'
  id: totrans-237
  prefs: []
  type: TYPE_TB
  zh: '| `move` | 当文件发生移动操作时 |'
- en: '| `create` | When a new file is created |'
  id: totrans-238
  prefs: []
  type: TYPE_TB
  zh: '| `create` | 当新文件被创建时 |'
- en: '| `open` | When a file undergoes an open operation |'
  id: totrans-239
  prefs: []
  type: TYPE_TB
  zh: '| `open` | 当文件进行打开操作时 |'
- en: '| `close` | When a file undergoes a close operation |'
  id: totrans-240
  prefs: []
  type: TYPE_TB
  zh: '| `close` | 当文件进行关闭操作时 |'
- en: '| `delete` | When a file is removed |'
  id: totrans-241
  prefs: []
  type: TYPE_TB
  zh: '| `delete` | 当文件被删除时 |'
- en: Logging with syslog
  id: totrans-242
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 `syslog` 记录日志
- en: Log files related to daemons and system processes are located in the `/var/log`
    directory. These log files use a standard protocol called **syslog**, handled
    by the `syslogd` daemon. Every standard application makes use of `syslogd` to
    log information. This recipe describes how to use `syslogd` to log information
    from a shell script.
  id: totrans-243
  prefs: []
  type: TYPE_NORMAL
  zh: 与守护进程和系统进程相关的日志文件位于 `/var/log` 目录中。这些日志文件使用一种名为 **syslog** 的标准协议，由 `syslogd`
    守护进程处理。每个标准应用程序都会使用 `syslogd` 记录信息。本食谱描述了如何使用 `syslogd` 从 shell 脚本中记录信息。
- en: Getting ready
  id: totrans-244
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备中
- en: Log files help you deduce what is going wrong with a system. It is a good practice
    to log progress and actions with log file messages. The logger command will place
    data into log files with `syslogd`.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 日志文件有助于你推断系统出现问题的原因。记录进度和操作信息是一个很好的实践，使用日志文件消息。`logger` 命令会将数据记录到日志文件中，并使用 `syslogd`
    进行管理。
- en: 'These are some of the standard Linux log files. Some distributions use different
    names for these files:'
  id: totrans-246
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是一些标准的 Linux 日志文件。有些发行版使用不同的文件名：
- en: '| **Log file** | **Description** |'
  id: totrans-247
  prefs: []
  type: TYPE_TB
  zh: '| **日志文件** | **描述** |'
- en: '| `/var/log/boot.log` | Boot log information |'
  id: totrans-248
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/boot.log` | 启动日志信息 |'
- en: '| `/var/log/httpd` | Apache web server log |'
  id: totrans-249
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/httpd` | Apache 网络服务器日志 |'
- en: '| `/var/log/messages` | Post boot kernel information |'
  id: totrans-250
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/messages` | 启动后内核信息 |'
- en: '| `/var/log/auth.log``/var/log/secure` | User authentication log |'
  id: totrans-251
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/auth.log``/var/log/secure` | 用户认证日志 |'
- en: '| `/var/log/dmesg` | System boot up messages |'
  id: totrans-252
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/dmesg` | 系统启动消息 |'
- en: '| `/var/log/mail.log``/var/log/maillog` | Mail server log |'
  id: totrans-253
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/mail.log``/var/log/maillog` | 邮件服务器日志 |'
- en: '| `/var/log/Xorg.0.log` | X server log |'
  id: totrans-254
  prefs: []
  type: TYPE_TB
  zh: '| `/var/log/Xorg.0.log` | X 服务器日志 |'
- en: How to do it...
  id: totrans-255
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The `logger` command allows scripts to create and manage log messages:'
  id: totrans-256
  prefs: []
  type: TYPE_NORMAL
  zh: '`logger` 命令允许脚本创建和管理日志消息：'
- en: 'Place a message in the syslog file `/var/log/messages`:'
  id: totrans-257
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 将消息放入系统日志文件 `/var/log/messages`：
- en: '[PRE55]'
  id: totrans-258
  prefs: []
  type: TYPE_PRE
  zh: '[PRE55]'
- en: 'Consider this example:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 请考虑以下示例：
- en: '[PRE56]'
  id: totrans-260
  prefs: []
  type: TYPE_PRE
  zh: '[PRE56]'
- en: The `/var/log/messages` log file is a general purpose log file. When the `logger`
    command is used, it logs to `/var/log/messages` by default.
  id: totrans-261
  prefs: []
  type: TYPE_NORMAL
  zh: '`/var/log/messages` 日志文件是一个通用日志文件。当使用 `logger` 命令时，它默认记录到 `/var/log/messages`。'
- en: 'The `-t` flag defines a tag for the message:'
  id: totrans-262
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-t` 标志定义消息的标签：'
- en: '[PRE57]'
  id: totrans-263
  prefs: []
  type: TYPE_PRE
  zh: '[PRE57]'
- en: The `-p` option to logger and configuration files in `/etc/rsyslog.d` control
    where log messages are saved.
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: '`-p` 选项控制 logger 和 `/etc/rsyslog.d` 中的配置文件，决定日志消息的保存位置。'
- en: 'To save to a custom file, follow these steps:'
  id: totrans-265
  prefs: []
  type: TYPE_NORMAL
  zh: 要保存到自定义文件，请按照以下步骤操作：
- en: Create a new configuration file in `/etc/rsyslog.d`
  id: totrans-266
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 在 `/etc/rsyslog.d` 中创建一个新的配置文件
- en: Add a pattern for a priority and the log file
  id: totrans-267
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 为优先级和日志文件添加模式
- en: Restart the log daemon
  id: totrans-268
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 重启日志守护进程
- en: 'Consider the following example:'
  id: totrans-269
  prefs: []
  type: TYPE_NORMAL
  zh: 请考虑以下示例：
- en: '[PRE58]'
  id: totrans-270
  prefs: []
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'The `-f` option will log the lines from another file:'
  id: totrans-271
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-f` 选项将从另一个文件中记录行：'
- en: '[PRE59]'
  id: totrans-272
  prefs: []
  type: TYPE_PRE
  zh: '[PRE59]'
- en: See also
  id: totrans-273
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参见
- en: The *Using head and tail for printing the last or first 10 lines* recipe of
    [Chapter 3](19219dcb-e034-408e-8fe2-db6daa9278c8.xhtml), *File In, File Out*,
    explains the head and tail commands
  id: totrans-274
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第 3 章](19219dcb-e034-408e-8fe2-db6daa9278c8.xhtml) *文件输入与输出* 中的 *使用 head 和
    tail 打印最后或前 10 行* 配方解释了 head 和 tail 命令'
- en: Managing log files with logrotate
  id: totrans-275
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 使用 logrotate 管理日志文件
- en: Log files keep track of events on the system. They are essential for debugging
    problems and monitoring live machines. Log files grow as time passes and more
    events are recorded. Since the older data is less useful than the current data,
    log files are renamed when they reach a size limit and the oldest files are deleted.
  id: totrans-276
  prefs: []
  type: TYPE_NORMAL
  zh: 日志文件跟踪系统上的事件。它们对于调试问题和监控实时机器至关重要。随着时间的推移，日志文件会增长，记录更多事件。由于较旧的数据不如当前数据有用，当日志文件达到大小限制时，它们会被重命名，并删除最旧的文件。
- en: Getting ready
  id: totrans-277
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: The `logrotate` command can restrict the size of the log file. The system logger
    facility appends information to the end of a log file without deleting earlier
    data. Thus a log file will grow larger over time. The `logrotate` command scans
    log files defined in the configuration file. It will keep the last 100 kilobytes
    (for example, specified S*IZE = 100 k*) from the log file and move the rest of
    the data (older log data) to a new file `logfile_name.1`. When the old-data file
    (`logfile_name.1`) exceeds `SIZE`, `logrotate` renames that file to `logfile_name.2`
    and starts a new `logfile_name.1`. The `logrotate` command can compress the older
    logs as `logfile_name.1.gz`, `logfile_name.2.gz`, and so on.
  id: totrans-278
  prefs: []
  type: TYPE_NORMAL
  zh: '`logrotate` 命令可以限制日志文件的大小。系统日志工具会将信息附加到日志文件的末尾，而不会删除之前的数据。因此，日志文件会随着时间推移而增大。`logrotate`
    命令会扫描配置文件中定义的日志文件。它将保留日志文件的最后 100 千字节（例如，指定 S*IZE = 100 k*），并将其余数据（较旧的日志数据）移动到一个新文件
    `logfile_name.1`。当旧数据文件（`logfile_name.1`）超过 `SIZE` 时，`logrotate` 会将该文件重命名为 `logfile_name.2`
    并开始一个新的 `logfile_name.1`。`logrotate` 命令还可以将旧日志压缩为 `logfile_name.1.gz`、`logfile_name.2.gz`
    等。'
- en: How to do it...
  id: totrans-279
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: The system's `logrotate` configuration files are held in `/etc/logrotate.d`.
    Most Linux distributions have many files in this folder.
  id: totrans-280
  prefs: []
  type: TYPE_NORMAL
  zh: 系统的 `logrotate` 配置文件保存在 `/etc/logrotate.d` 中。大多数 Linux 发行版在该文件夹中都有多个文件。
- en: 'We can create a custom configuration for a log file (say `/var/log/program.log`):'
  id: totrans-281
  prefs: []
  type: TYPE_NORMAL
  zh: 我们可以为日志文件（例如 `/var/log/program.log`）创建自定义配置：
- en: '[PRE60]'
  id: totrans-282
  prefs: []
  type: TYPE_PRE
  zh: '[PRE60]'
- en: This is a complete configuration. The `/var/log/program.log` string specifies
    the log file path. Logrotate will archive old logs in the same directory.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 这是一个完整的配置。`/var/log/program.log` 字符串指定了日志文件路径。Logrotate 会将旧日志存档到同一目录中。
- en: How it works...
  id: totrans-284
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: 'The `logrotate` command supports these options in the configuration file:'
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: '`logrotate` 命令支持配置文件中的这些选项：'
- en: '| **Parameter** | **Description** |'
  id: totrans-286
  prefs: []
  type: TYPE_TB
  zh: '| **参数** | **描述** |'
- en: '| `missingok` | This ignores if the log file is missing and return without
    rotating the log. |'
  id: totrans-287
  prefs: []
  type: TYPE_TB
  zh: '| `missingok` | 如果日志文件丢失，则忽略并返回，不进行日志轮换。 |'
- en: '| `notifempty` | This only rotates the log if the source log file is not empty.
    |'
  id: totrans-288
  prefs: []
  type: TYPE_TB
  zh: '| `notifempty` | 仅在源日志文件不为空时才进行轮换。 |'
- en: '| `size 30k` | This limits the size of the log file for which the rotation
    is to be made. It can be 1 M for 1 MB. |'
  id: totrans-289
  prefs: []
  type: TYPE_TB
  zh: '| `size 30k` | 这限制了要进行轮换的日志文件的大小。可以设置为1M，即1MB。 |'
- en: '| `compress` | This enables compression with gzip for older logs. |'
  id: totrans-290
  prefs: []
  type: TYPE_TB
  zh: '| `compress` | 启用gzip压缩以压缩旧日志。 |'
- en: '| `weekly` | This specifies the interval at which the rotation is to be performed.
    It can be weekly, yearly, or daily. |'
  id: totrans-291
  prefs: []
  type: TYPE_TB
  zh: '| `weekly` | 这指定了轮换执行的间隔。可以是每周、每年或每天。 |'
- en: '| `rotate 5` | This is the number of older copies of log file archives to be
    kept. Since 5 is specified, there will be `program.log.1.gz`, `program.log.2.gz`,
    and so on up to `program.log.5.gz`. |'
  id: totrans-292
  prefs: []
  type: TYPE_TB
  zh: '| `rotate 5` | 这是要保留的日志文件存档的旧副本数量。指定为5时，将保留`program.log.1.gz`、`program.log.2.gz`，依此类推，直到`program.log.5.gz`。
    |'
- en: '| `create 0600 root root` | This specifies the mode, user, and the group of
    the log file archive to be created. |'
  id: totrans-293
  prefs: []
  type: TYPE_TB
  zh: '| `create 0600 root root` | 这指定了日志文件存档的权限、用户和组。 |'
- en: The options in the table are examples of what can be specified. More options
    can be defined in the `logrotate` configuration file. Refer to the man page at
    `http://linux.die.net/man/8/logrotate`, for more information.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 表中的选项是可以指定的示例。更多选项可以在`logrotate`配置文件中定义。有关更多信息，请参考`http://linux.die.net/man/8/logrotate`的手册页。
- en: Monitoring user logins to find intruders
  id: totrans-295
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控用户登录以寻找入侵者
- en: Log files can be used to gather details about the state of the system and attacks
    on the system.
  id: totrans-296
  prefs: []
  type: TYPE_NORMAL
  zh: 日志文件可以用于收集系统状态和系统攻击的详细信息。
- en: 'Suppose we have a system connected to the Internet with SSH enabled. Many attackers
    are trying to log in to the system. We need to design an intrusion detection system
    to identify users who fail their login attempts. Such attempts may be of a hacker
    using a dictionary attack. The script should generate a report with the following
    details:'
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 假设我们有一个连接到互联网的系统，并且启用了SSH。许多攻击者正在尝试登录系统。我们需要设计一个入侵检测系统，以识别那些登录失败的用户。这些失败的尝试可能是黑客使用字典攻击进行的。脚本应生成一个报告，包含以下详细信息：
- en: User that failed to log in
  id: totrans-298
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 登录失败的用户
- en: Number of attempts
  id: totrans-299
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 尝试次数
- en: IP address of the attacker
  id: totrans-300
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 攻击者的IP地址
- en: Host mapping for the IP address
  id: totrans-301
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: IP地址的主机映射
- en: Time when login attempts occurred
  id: totrans-302
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 登录尝试发生的时间
- en: Getting ready
  id: totrans-303
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 正在准备
- en: A shell script can scan the log files and gather the required information. Login
    details are recorded in `/var/log/auth.log` or `/var/log/secure`. The script scans
    the log file for failed login attempts and analyzes the data. It uses the `host`
    command to map the host from the IP address.
  id: totrans-304
  prefs: []
  type: TYPE_NORMAL
  zh: 一个Shell脚本可以扫描日志文件并收集所需的信息。登录详细信息记录在`/var/log/auth.log`或`/var/log/secure`中。脚本扫描日志文件以查找失败的登录尝试并分析数据。它使用`host`命令根据IP地址映射主机。
- en: How to do it...
  id: totrans-305
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The intrusion detection script resembles this:'
  id: totrans-306
  prefs: []
  type: TYPE_NORMAL
  zh: 入侵检测脚本类似于如下：
- en: '[PRE61]'
  id: totrans-307
  prefs: []
  type: TYPE_PRE
  zh: '[PRE61]'
- en: 'The output resembles the following:'
  id: totrans-308
  prefs: []
  type: TYPE_NORMAL
  zh: 输出类似如下：
- en: '[PRE62]'
  id: totrans-309
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: How it works...
  id: totrans-310
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The `intruder_detect.sh` script defaults to using `/var/log/auth.log` as input.
    Alternatively, we can provide a log file with a command-line argument. The failed
    logins are collected in a temporary file to reduce processing.
  id: totrans-311
  prefs: []
  type: TYPE_NORMAL
  zh: '`intruder_detect.sh`脚本默认使用`/var/log/auth.log`作为输入日志。或者，我们可以通过命令行参数提供日志文件。失败的登录记录会被收集到临时文件中，以减少处理。'
- en: 'When a login attempt fails, SSH logs lines are similar to this:'
  id: totrans-312
  prefs: []
  type: TYPE_NORMAL
  zh: 当登录尝试失败时，SSH日志行类似如下：
- en: '[PRE63]'
  id: totrans-313
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: The script `greps` for the `Failed passw` string and puts those lines in `/tmp/failed.$$.log`.
  id: totrans-314
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本`greps`用于查找`Failed passw`字符串，并将这些行放入`/tmp/failed.$$.log`文件中。
- en: The next step is to extract the users who failed to login. The `awk` command
    extracts the fifth field from the end (the user name) and pipes that to sort and
    `uniq` to create a list of the users.
  id: totrans-315
  prefs: []
  type: TYPE_NORMAL
  zh: 下一步是提取未能登录的用户。`awk`命令从末尾提取第五个字段（用户名），然后将其传递给`sort`和`uniq`命令，创建用户列表。
- en: Next, the unique IP addresses are extracted with a regular expression and the
    `egrep` command.
  id: totrans-316
  prefs: []
  type: TYPE_NORMAL
  zh: 接下来，使用正则表达式和`egrep`命令提取唯一的IP地址。
- en: Nested for loops iterate through the IP address and users extracting the lines
    with each IP address and user combination. If the number of attempts for this
    IP/User combination is > 0, the time of the first occurrence is extracted with
    `grep`, head, and cut. If the number of attempts is > 1, then the last time is
    extracted using tail instead of head.
  id: totrans-317
  prefs: []
  type: TYPE_NORMAL
  zh: 嵌套的for循环遍历IP地址和用户，提取每个IP地址和用户组合的行。如果该IP/用户组合的尝试次数大于0，则使用`grep`、head和cut提取第一次出现的时间。如果尝试次数大于1，则使用tail而不是head提取最后一次的时间。
- en: This login attempt is then reported with the formatted `printf` command.
  id: totrans-318
  prefs: []
  type: TYPE_NORMAL
  zh: 然后使用格式化的`printf`命令报告此登录尝试。
- en: Finally, the temporary file is removed.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 最后，临时文件被删除。
- en: Monitoring remote disk usage health
  id: totrans-320
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控远程磁盘使用健康状况
- en: Disks fill up and sometimes wear out. Even RAIDed storage systems can fail if
    you don't replace a faulty drive before the others fail. Monitoring the health
    of the storage systems is part of an administrator's job.
  id: totrans-321
  prefs: []
  type: TYPE_NORMAL
  zh: 磁盘会被填满，有时也会损坏。即使是RAID存储系统，如果在其他驱动器故障之前不更换有问题的驱动器，也可能会失败。监控存储系统的健康状况是管理员工作的一部分。
- en: The job gets easier when an automated script checks the devices on the network
    and generates a one-line report, the date, IP address of the machine, device,
    capacity of device, used space, free space, percentage usage, and alert status.
    If the disk usage is under 80 percent, the drive status is reported as `SAFE`.
    If the drive is getting full and needs attention, the status is reported as `ALERT`.
  id: totrans-322
  prefs: []
  type: TYPE_NORMAL
  zh: 当一个自动化脚本检查网络上的设备并生成一行报告时，工作变得更加轻松，报告内容包括日期、机器的IP地址、设备、设备容量、已用空间、剩余空间、使用百分比和警告状态。如果磁盘使用率低于80％，驱动器状态将报告为`SAFE`。如果驱动器快满并且需要注意，则状态将报告为`ALERT`。
- en: Getting ready
  id: totrans-323
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: The script uses SSH to log in to remote systems, collect disk usage statistics,
    and write them to a log file in the central machine. This script can be scheduled
    to run at a particular time.
  id: totrans-324
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本使用SSH登录远程系统，收集磁盘使用统计数据，并将其写入中央机器的日志文件中。此脚本可以调度在特定时间运行。
- en: The script requires a common user account on the remote machines so the `disklog`
    script can log in to collect data. We should configure auto-login with SSH for
    the common user (the *Password-less auto-login with SSH* recipe of [Chapter 8](5ba784d5-fa8b-4840-b4c5-cac906e484f9.xhtml),
    *The Old-Boy Network*, explains auto-login).
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本需要在远程机器上拥有一个普通用户账户，以便`disklog`脚本可以登录收集数据。我们应该为普通用户配置SSH自动登录（[第8章](5ba784d5-fa8b-4840-b4c5-cac906e484f9.xhtml)《老男孩网络》中介绍了*无密码SSH自动登录*的操作）。
- en: How to do it...
  id: totrans-326
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'Here''s the code:'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 以下是代码：
- en: '[PRE64]'
  id: totrans-328
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: 'The `cron` utility will schedule the script to run at regular intervals. For
    example, to run the script every day at 10 a.m., write the following entry in
    `crontab`:'
  id: totrans-329
  prefs: []
  type: TYPE_NORMAL
  zh: '`cron`工具将定期调度脚本运行。例如，要每天上午10点运行该脚本，可以在`crontab`中写入以下条目：'
- en: '[PRE65]'
  id: totrans-330
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: Run the `crontab -e` command and add the preceding line.
  id: totrans-331
  prefs: []
  type: TYPE_NORMAL
  zh: 运行`crontab -e`命令并添加上述行。
- en: 'You can run the script manually as follows:'
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过以下方式手动运行脚本：
- en: '[PRE66]'
  id: totrans-333
  prefs: []
  type: TYPE_PRE
  zh: '[PRE66]'
- en: 'The output for the previous script resembles this:'
  id: totrans-334
  prefs: []
  type: TYPE_NORMAL
  zh: 之前脚本的输出类似如下：
- en: '[PRE67]'
  id: totrans-335
  prefs: []
  type: TYPE_PRE
  zh: '[PRE67]'
- en: How it works...
  id: totrans-336
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The `disklog.sh` script accepts the log file path as a command-line argument
    or uses the default log file. The `-e $logfile` checks whether the file exists
    or not. If the log file does not exist, it is initialized with a column header.
    The list of remote machine IP addresses can be hardcoded in `IP_LIST`, delimited
    with spaces, or the `nmap` command can be used to scan the network for available
    nodes. If you use the `nmap` call, adjust the IP address range for your network.
  id: totrans-337
  prefs: []
  type: TYPE_NORMAL
  zh: '`disklog.sh`脚本接受日志文件路径作为命令行参数，或者使用默认日志文件。`-e $logfile`检查文件是否存在。如果日志文件不存在，则使用列标题进行初始化。远程机器的IP地址列表可以在`IP_LIST`中硬编码，以空格分隔，或者可以使用`nmap`命令扫描网络以查找可用节点。如果使用`nmap`调用，请根据您的网络调整IP地址范围。'
- en: A for loop iterates through each of the IP addresses. The `ssh` application
    sends the `df -H` command to each node to retrieve the disk usage information.
    The `df` output is stored in a temporary file. A `while` loop reads that file
    line by line and invokes `awk` to extract the relevant data and output it. An
    `egrep` command extracts the percent full value and strips `%`. If this value
    is less than 80, the line is marked `SAFE`, else it's marked `ALERT`. The entire
    output string must be redirected to the `log` file. Hence, the `for` loop is enclosed
    in a subshell `()` and the standard output is redirected to the log file.
  id: totrans-338
  prefs: []
  type: TYPE_NORMAL
  zh: 一个 for 循环遍历每个 IP 地址。`ssh` 应用程序向每个节点发送 `df -H` 命令以获取磁盘使用情况信息。`df` 输出存储在临时文件中。一个
    `while` 循环逐行读取该文件，并调用 `awk` 提取相关数据并输出。一个 `egrep` 命令提取百分比值并去除 `%`。如果该值小于 80，则该行标记为
    `SAFE`，否则标记为 `ALERT`。整个输出字符串必须重定向到 `log` 文件。因此，`for` 循环被包含在子 shell `()` 中，标准输出被重定向到日志文件。
- en: See also
  id: totrans-339
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 参见
- en: The *Scheduling with a cron* recipe in [Chapter 10](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml),
    *Administration Calls*, explains the `crontab` command
  id: totrans-340
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '[第10章](20129291-0a5b-43a8-ad0c-54c74992d0e3.xhtml)《调度与 cron》中的*调度与 cron* 介绍了
    `crontab` 命令。'
- en: Determining active user hours on a system
  id: totrans-341
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 确定系统上活跃用户的小时数
- en: This recipe makes use of the system logs to find out how many hours each user
    has spent on the server and ranks them according to the total usage hours. A report
    is generated with the details, including rank, user, first logged in date, last
    logged in date, number of times logged in, and total usage hours.
  id: totrans-342
  prefs: []
  type: TYPE_NORMAL
  zh: 这个配方利用系统日志来查明每个用户在服务器上花费了多少小时，并根据总使用时长对他们进行排名。报告包括排名、用户、首次登录日期、最后登录日期、登录次数和总使用时长等详细信息。
- en: Getting ready
  id: totrans-343
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: The raw data about user sessions is stored in a binary format in the `/var/log/wtmp`
    file. The `last` command returns details about login sessions. The sum of the
    session hours for each user is that user's total usage hours.
  id: totrans-344
  prefs: []
  type: TYPE_NORMAL
  zh: 关于用户会话的原始数据以二进制格式存储在 `/var/log/wtmp` 文件中。`last` 命令返回有关登录会话的详细信息。每个用户的会话小时数之和即为该用户的总使用时长。
- en: How to do it...
  id: totrans-345
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'This script will determine the active users and generate the report:'
  id: totrans-346
  prefs: []
  type: TYPE_NORMAL
  zh: 该脚本将确定活跃用户并生成报告：
- en: '[PRE68]'
  id: totrans-347
  prefs: []
  type: TYPE_PRE
  zh: '[PRE68]'
- en: 'The output resembles the following:'
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
  zh: 输出类似于以下内容：
- en: '[PRE69]'
  id: totrans-349
  prefs: []
  type: TYPE_PRE
  zh: '[PRE69]'
- en: How it works...
  id: totrans-350
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The `active_users.sh` script reads from `/var/log/wtmp` or a `wtmp` log file
    defined on the command line. The `last -f` command extracts the log file contents.
    The first column in the log file is the username. The `cut` command extracts the
    first column from the log file. The `sort` and `uniq` commands reduce this to
    a list of unique users.
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: '`active_users.sh` 脚本从 `/var/log/wtmp` 或命令行中定义的 `wtmp` 日志文件中读取数据。`last -f` 命令提取日志文件内容。日志文件中的第一列是用户名。`cut`
    命令提取日志文件中的第一列。`sort` 和 `uniq` 命令将其减少为唯一用户的列表。'
- en: The script's outer loop iterates through the users. For each user, `grep` is
    used to extract the log lines corresponding to a particular user.
  id: totrans-352
  prefs: []
  type: TYPE_NORMAL
  zh: 脚本的外部循环遍历所有用户。对于每个用户，使用 `grep` 提取对应用户的日志行。
- en: The last column of each line is the duration of this login session. These values
    are summed in the inner `while read t` loop.
  id: totrans-353
  prefs: []
  type: TYPE_NORMAL
  zh: 每行的最后一列是该次登录会话的持续时间。这些值在内部的 `while read t` 循环中进行求和。
- en: The session duration is formatted as `(HOUR:SEC)`. This value is extracted with
    awk to report the last field and then piped to `tr -d` to remove the parentheses.
    A second `awk` command converts the *HH::MM* string to minutes and the minutes
    are totaled. When the loop is complete, the total minutes are converted to hours
    by dividing `$minutes` with 60.
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
  zh: 会话持续时间的格式为 `(HOUR:SEC)`。该值通过 `awk` 提取最后一个字段，然后通过 `tr -d` 去除括号。第二个 `awk` 命令将
    *HH::MM* 字符串转换为分钟数，然后将分钟数相加。当循环完成时，使用 `$minutes` 除以 60 将总分钟数转换为小时。
- en: The first login time for a user is the last line in the temporary file of user
    data. This is extracted with tail and `awk`. The number of login sessions is the
    number of lines in this file, calculated with `wc`.
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: 用户的首次登录时间是用户数据临时文件中的最后一行。这通过 `tail` 和 `awk` 提取。登录会话的数量是该文件中的行数，通过 `wc` 计算。
- en: The users are sorted by the total usage hours with sort's `-nr` option for the
    numeric and descending order and `-k4` to specify the sort column (usage hour).
    Finally, the output of the sort is passed to `awk`, which prefixes each line with
    a line number representing the rank of each user.
  id: totrans-356
  prefs: []
  type: TYPE_NORMAL
  zh: 用户按总使用时长排序，使用 `sort` 的 `-nr` 选项进行数字降序排序，`-k4` 用于指定排序的列（使用时长）。最后，排序后的输出传递给 `awk`，它会在每行前加上行号，表示每个用户的排名。
- en: Measuring and optimizing power usage
  id: totrans-357
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 测量和优化功耗
- en: Battery capacity is a critical resource on mobile devices, such as notebook
    computers and tablets. Linux provides tools that measure power consumption, one
    such command is `powertop`.
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: 电池容量是移动设备（如笔记本电脑和平板电脑）上的一个关键资源。Linux提供了测量功耗的工具，其中一个命令是`powertop`。
- en: Getting ready
  id: totrans-359
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备就绪
- en: The `powertop` application doesn't come preinstalled with many Linux distributions,
    you will have to install it using your package manager.
  id: totrans-360
  prefs: []
  type: TYPE_NORMAL
  zh: '`powertop`应用程序在许多Linux发行版中没有预安装，你需要使用你的包管理器安装它。'
- en: How to do it...
  id: totrans-361
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The `powertop` application measures per-module power consumption and supports
    interactively optimizing power consumption:'
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
  zh: '`powertop`应用程序测量每个模块的功耗，并支持交互式优化功耗：'
- en: 'With no options, `powertop` presents a display on the terminal:'
  id: totrans-363
  prefs: []
  type: TYPE_NORMAL
  zh: 如果没有选项，`powertop`将在终端上显示一个界面：
- en: '[PRE70]'
  id: totrans-364
  prefs: []
  type: TYPE_PRE
  zh: '[PRE70]'
- en: 'The `powertop` command takes measurements and displays detailed information
    about power usage, the processes using the most power, and so on:'
  id: totrans-365
  prefs: []
  type: TYPE_NORMAL
  zh: '`powertop`命令进行测量，并显示有关功耗、最耗电的进程等详细信息：'
- en: '[PRE71]'
  id: totrans-366
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: 'The `-html` tag will cause `powertop` to take measurements over a period of
    time and generate an HTML report with the default filename `PowerTOP.html`, which
    you can open using any web browser:'
  id: totrans-367
  prefs: []
  type: TYPE_NORMAL
  zh: '`-html`标签将使`powertop`在一段时间内进行测量，并生成一个默认文件名为`PowerTOP.html`的HTML报告，你可以使用任何网页浏览器打开：'
- en: '[PRE72]'
  id: totrans-368
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: In the interactive mode, you can optimize power usage. When `powertop` is running,
    use the arrow or tab keys to switch to the Tunables tab; this shows a list of
    attributes `powertop` can tune to for consuming less power. Choose the ones you
    want, press Enter to toggle from Bad to Good.
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
  zh: 在交互模式下，你可以优化功耗。当`powertop`运行时，使用箭头键或Tab键切换到Tunables标签页；这将显示`powertop`可以调整的属性列表，以减少功耗。选择你想要的选项，按回车键在“Bad”和“Good”之间切换。
- en: If you want to monitor the power consumption from a portable device's battery,
    it is required to remove the charger and use the battery for `powertop` to make
    measurements.
  id: totrans-370
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想监控便携设备电池的电力消耗，需要拔掉充电器并使用电池，以便`powertop`进行测量。
- en: Monitoring disk activity
  id: totrans-371
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 监控磁盘活动
- en: A popular naming convention for monitoring tools is to end the name with the
    `'top'` word (the command used to monitor processes). The tool to monitor disk
    I/O is called `iotop`.
  id: totrans-372
  prefs: []
  type: TYPE_NORMAL
  zh: 监控工具的常见命名约定是以`'top'`结尾（用于监控进程的命令）。用于监控磁盘I/O的工具叫做`iotop`。
- en: Getting ready
  id: totrans-373
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备就绪
- en: The **iotop** application doesn't come preinstalled with most Linux distributions,
    you will have to install it using your package manager. The iotop application
    requires root privileges, so you'll need to run it as `sudo` or root user.
  id: totrans-374
  prefs: []
  type: TYPE_NORMAL
  zh: '**iotop**应用程序在大多数Linux发行版中没有预安装，你需要使用你的包管理器安装它。`iotop`应用程序需要root权限，所以你需要以`sudo`或root用户身份运行它。'
- en: How to do it...
  id: totrans-375
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The `iotop` application can either perform continuous monitoring or generate
    reports for a fixed period:'
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: '`iotop`应用程序可以执行连续监控或在固定时间段内生成报告：'
- en: 'For continuous monitoring, use the command as follows:'
  id: totrans-377
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 对于连续监控，请使用以下命令：
- en: '[PRE73]'
  id: totrans-378
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: The `-o` option tells `iotop` to show only those processes that are doing active
    I/O while it is running, which reduces the noise in the output.
  id: totrans-379
  prefs: []
  type: TYPE_NORMAL
  zh: '`-o`选项告诉`iotop`只显示那些在运行时进行活跃I/O的进程，从而减少输出中的噪声。'
- en: 'The `-n` option tells iotop to run for *N* times and exit:'
  id: totrans-380
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-n`选项告诉iotop运行*N*次后退出：'
- en: '[PRE74]'
  id: totrans-381
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: 'The `-p` option monitors a specific process:'
  id: totrans-382
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-p`选项用于监控特定进程：'
- en: '[PRE75]'
  id: totrans-383
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: '`PID` is the process you wish to monitor.'
  id: totrans-384
  prefs: []
  type: TYPE_NORMAL
  zh: '`PID`是你希望监控的进程。'
- en: In most modern distributions, instead of finding the PID and supplying it to
    `iotop`, you can use the `pidof` command and write the preceding command as follows: #
    iotop -p `pidof cp`
  id: totrans-385
  prefs: []
  type: TYPE_NORMAL
  zh: 在大多数现代发行版中，你可以使用`pidof`命令，而不是查找PID并将其提供给`iotop`，可以将前面的命令写成：# iotop -p `pidof
    cp`
- en: Checking disks and filesystems for errors
  id: totrans-386
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 检查磁盘和文件系统的错误
- en: Linux filesystems are incredibly robust. Despite that, a filesystem can become
    corrupted and data can be lost. The sooner you find a problem, the less data loss
    and corruption you need to worry about.
  id: totrans-387
  prefs: []
  type: TYPE_NORMAL
  zh: Linux文件系统非常强大。尽管如此，文件系统可能会损坏并导致数据丢失。尽早发现问题，能减少数据丢失和损坏的风险。
- en: Getting ready
  id: totrans-388
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备就绪
- en: The standard tool for checking filesystems is `fsck`. This command is installed
    on all modern distributions. Note that you'll need to run `fsck` as root or via
    a `sudo`.
  id: totrans-389
  prefs: []
  type: TYPE_NORMAL
  zh: 检查文件系统的标准工具是`fsck`。该命令在所有现代发行版中都已安装。请注意，你需要以root用户身份或通过`sudo`运行`fsck`。
- en: How to do it...
  id: totrans-390
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: Linux will run `fsck` automatically at boot time if the filesystem has been
    unchecked for a long time or there is a reason (unsafe reboot after a power glitch)
    to suspect it's been corrupted. You can run `fsck` manually.
  id: totrans-391
  prefs: []
  type: TYPE_NORMAL
  zh: 如果文件系统长时间未检查，或者有原因（如电力中断后不安全的重启）怀疑它已经损坏，Linux将在启动时自动运行`fsck`。你也可以手动运行`fsck`。
- en: 'To check for errors on a partition or filesystem, pass the path to `fsck`:'
  id: totrans-392
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要检查分区或文件系统中的错误，传递路径给`fsck`：
- en: '[PRE76]'
  id: totrans-393
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: 'The `-A` flag checks all the filesystems configured in `/etc/fstab`:'
  id: totrans-394
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-A`标志检查`/etc/fstab`中配置的所有文件系统：'
- en: '[PRE77]'
  id: totrans-395
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: This will go through the `/etc/fstab` file, checking each filesystem. The `fstab`
    file defines the mapping between physical disk partitions and mount points. It's
    used to mount filesystems during boot.
  id: totrans-396
  prefs: []
  type: TYPE_NORMAL
  zh: 这将遍历`/etc/fstab`文件，检查每个文件系统。`fstab`文件定义了物理磁盘分区与挂载点之间的映射。它在启动时用于挂载文件系统。
- en: 'The `-a` option instructs `fsck` to automatically attempt to fix errors, instead
    of interactively asking us whether or not to repair them. Use this option with
    caution:'
  id: totrans-397
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-a`选项指示`fsck`自动尝试修复错误，而不是交互式地询问我们是否修复它们。使用此选项时要小心：'
- en: '[PRE78]'
  id: totrans-398
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: 'The `-N` option simulates the actions `fsck` will perform:'
  id: totrans-399
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: '`-N`选项模拟`fsck`将执行的操作：'
- en: '[PRE79]'
  id: totrans-400
  prefs: []
  type: TYPE_PRE
  zh: '[PRE79]'
- en: How it works...
  id: totrans-401
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 它是如何工作的...
- en: The `fsck` application is a frontend for filesystem specific `fsck` applications.
    When we run `fsck`, it detects the type of the filesystem and runs the appropriate
    `fsck.fstype` command, where `fstype` is the type of the filesystem. For example,
    if we run `fsck` on an `ext4` filesystem, it will end up calling the `fsck.ext4`
    command.
  id: totrans-402
  prefs: []
  type: TYPE_NORMAL
  zh: '`fsck`应用程序是文件系统特定`fsck`应用程序的前端。当我们运行`fsck`时，它会检测文件系统的类型并运行相应的`fsck.fstype`命令，其中`fstype`是文件系统的类型。例如，如果我们在`ext4`文件系统上运行`fsck`，它将调用`fsck.ext4`命令。'
- en: Because of this, `fsck` supports only the common options across all filesystem-specific
    tools. To find more detailed options, read the application specific man pages
    such as `fsck.ext4`.
  id: totrans-403
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，`fsck`仅支持所有文件系统特定工具中共有的选项。要查找更详细的选项，请阅读特定应用程序的手册页，如`fsck.ext4`。
- en: It's very rare, but possible, for `fsck` to lose data or make a badly damaged
    filesystem worse. If you suspect severe corruption of a filesystem, you should
    use the `-N` option to list the actions that `fsck` will perform without actually
    performing them. If `fsck` reports more than a dozen problems it can fix or if
    these include damaged directory structures, you may want to mount the drive in
    the read-only mode and try to extract critical data before running `fsck`.
  id: totrans-404
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然非常罕见，但`fsck`可能会丢失数据或使已经严重损坏的文件系统更糟。如果你怀疑文件系统严重损坏，应该使用`-N`选项列出`fsck`将执行的操作，而不实际执行它们。如果`fsck`报告它可以修复的超过十个问题，或者这些问题包括损坏的目录结构，你可能想要以只读模式挂载驱动器，并在运行`fsck`之前尽量提取关键数据。
- en: Examining disk health
  id: totrans-405
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 检查磁盘健康
- en: Modern disk drives run for years with no problems, but when a disk fails, it's
    a major disaster. Modern disk drives include a **Self-Monitoring, Analysis, and
    Reporting Technology** (**SMART**) facility to monitor the disk's health so you
    can replace an ailing drive before a major failure occurs.
  id: totrans-406
  prefs: []
  type: TYPE_NORMAL
  zh: 现代磁盘驱动器运行多年没有问题，但当磁盘故障时，它是一次重大灾难。现代磁盘驱动器配备了**自监控、分析和报告技术**（**SMART**）设施，以监控磁盘健康状态，这样你可以在发生重大故障之前更换即将故障的驱动器。
- en: Getting ready
  id: totrans-407
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'Linux supports interacting with the drives SMART utilities via the `smartmontools`
    package. This is installed by default on most distributions. If it''s not present,
    you can install it with your package manager:'
  id: totrans-408
  prefs: []
  type: TYPE_NORMAL
  zh: Linux通过`smartmontools`软件包支持与磁盘的SMART工具交互。大多数发行版默认安装此软件包。如果它未安装，你可以通过包管理器安装：
- en: '[PRE80]'
  id: totrans-409
  prefs: []
  type: TYPE_PRE
  zh: '[PRE80]'
- en: 'Alternatively, this command can be used:'
  id: totrans-410
  prefs: []
  type: TYPE_NORMAL
  zh: 另外，可以使用以下命令：
- en: '[PRE81]'
  id: totrans-411
  prefs: []
  type: TYPE_PRE
  zh: '[PRE81]'
- en: How to do it...
  id: totrans-412
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: The user interface to `smartmontools` is the `smartctl` application. This application
    initiates tests on the disk drive and reports the status of the SMART device.
  id: totrans-413
  prefs: []
  type: TYPE_NORMAL
  zh: '`smartmontools`的用户界面是`smartctl`应用程序。此应用程序启动磁盘驱动器的测试并报告SMART设备的状态。'
- en: Since the `smartctl` application accesses the raw disk device, you must have
    root access to run it.
  id: totrans-414
  prefs: []
  type: TYPE_NORMAL
  zh: 由于`smartctl`应用程序访问原始磁盘设备，因此你必须具有根权限才能运行它。
- en: 'The `-a` option reports the full status of a device:'
  id: totrans-415
  prefs: []
  type: TYPE_NORMAL
  zh: '`-a`选项报告设备的完整状态：'
- en: '[PRE82]'
  id: totrans-416
  prefs: []
  type: TYPE_PRE
  zh: '[PRE82]'
- en: 'The output will be a header of basic information, a set of raw data values
    and the test results. The header includes details about the drive being tested
    and a datestamp for this report:'
  id: totrans-417
  prefs: []
  type: TYPE_NORMAL
  zh: 输出将包括基本信息的标题、一组原始数据值和测试结果。标题包括关于被测试驱动器的详细信息以及此报告的日期戳：
- en: '[PRE83]'
  id: totrans-418
  prefs: []
  type: TYPE_PRE
  zh: '[PRE83]'
- en: 'The raw data values include error counts, spin-up time, power-on hours, and
    more. The last two columns (`WHEN_FAILED` and `RAW_VALUE`) are of particular interest.
    In the following sample, the device has been powered on 9823 hours. It was powered
    on and off 11 times (servers don''t get power-cycled a lot) and the current temperature
    is 30° C. When the value for power on gets close to the manufacturer''s **Mean
    Time Between Failures** (**MTBF**), it''s time to start considering replacing
    the drive or moving it to a less critical system. If the Power Cycle count increases
    between reboots, it could indicate a failing power supply or faulty cables. If
    the temperature gets high, you should consider checking the drive''s enclosure.
    A fan may have failed or a filter might be clogged:'
  id: totrans-419
  prefs: []
  type: TYPE_NORMAL
  zh: 原始数据值包括错误计数、启动时间、开机小时数等。最后两列（`WHEN_FAILED` 和 `RAW_VALUE`）尤其值得关注。在以下示例中，设备已开机9823小时。它已经开关机了11次（服务器不常进行断电重启），当前温度为30°C。当开机时间接近制造商的**平均故障间隔时间**（**MTBF**）时，就该考虑更换硬盘或将其移至不太关键的系统。如果重启之间的电源循环次数增加，可能表示电源故障或电缆有问题。如果温度过高，应考虑检查硬盘的外壳，可能是风扇故障或过滤器堵塞：
- en: '[PRE84]'
  id: totrans-420
  prefs: []
  type: TYPE_PRE
  zh: '[PRE84]'
- en: 'The last section of the output will be the results of the tests:'
  id: totrans-421
  prefs: []
  type: TYPE_NORMAL
  zh: 输出的最后一部分将是测试结果：
- en: '[PRE85]'
  id: totrans-422
  prefs: []
  type: TYPE_PRE
  zh: '[PRE85]'
- en: 'The `-t` flag forces the SMART device to run the self-tests. These are non-destructive
    and can be run on a drive while it is in service. SMART devices can run a long
    or short test. A short test will take a few minutes, while the long test will
    take an hour or more on a large device:'
  id: totrans-423
  prefs: []
  type: TYPE_NORMAL
  zh: '`-t` 标志强制 SMART 设备运行自检。这些测试是非破坏性的，可以在硬盘运行时进行。SMART 设备可以运行长时间或短时间的测试。短时间测试需要几分钟，而长时间测试在大容量设备上可能需要一小时或更长时间：'
- en: '[PRE86]'
  id: totrans-424
  prefs: []
  type: TYPE_PRE
  zh: '[PRE86]'
- en: In a bit over two hours, this test will be completed and the results will be
    viewable with the `smartctl -a` command.
  id: totrans-425
  prefs: []
  type: TYPE_NORMAL
  zh: 在两个多小时后，此测试将完成，并可以通过 `smartctl -a` 命令查看结果。
- en: How it works
  id: totrans-426
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理
- en: Modern disk drives are much more than a spinning metal disk. They include a
    CPU, ROM, memory, and custom signal processing chips. The `smartctl` command interacts
    with the small operating system running on the disk's CPU to requests tests and
    reports.
  id: totrans-427
  prefs: []
  type: TYPE_NORMAL
  zh: 现代硬盘远不止一个旋转的金属盘。它们包括 CPU、ROM、内存和定制的信号处理芯片。`smartctl` 命令通过与硬盘 CPU 上运行的小型操作系统交互，来请求测试并报告结果。
- en: Getting disk statistics
  id: totrans-428
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 获取磁盘统计信息
- en: The `smartctl` command provides many disk statistics and tests the drives. The
    `hdparm` command provides more statistics and examines how the disk performs in
    your system, which may be influenced by controller chips, cables, and so on.
  id: totrans-429
  prefs: []
  type: TYPE_NORMAL
  zh: '`smartctl` 命令提供了许多磁盘统计信息，并测试硬盘。`hdparm` 命令提供更多统计信息，并检查磁盘在系统中的表现，可能会受到控制器芯片、电缆等的影响。'
- en: Getting ready
  id: totrans-430
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 准备就绪
- en: The `hdparm` command is standard on most Linux distributions. You must have
    root access to use it.
  id: totrans-431
  prefs: []
  type: TYPE_NORMAL
  zh: '`hdparm` 命令在大多数 Linux 发行版中都是标准命令。使用它需要 root 权限。'
- en: How to do it...
  id: totrans-432
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 如何操作...
- en: 'The `-I` option will provide basic information about your device:'
  id: totrans-433
  prefs: []
  type: TYPE_NORMAL
  zh: '`-I` 选项将提供有关设备的基本信息：'
- en: '[PRE87]'
  id: totrans-434
  prefs: []
  type: TYPE_PRE
  zh: '[PRE87]'
- en: 'The following sample output shows some of the data reported. The model number
    and firmware are the same as reported by `smartctl`. The configuration includes
    parameters that can be tuned before a drive is partitioned and a filesystem is
    created:'
  id: totrans-435
  prefs: []
  type: TYPE_NORMAL
  zh: 以下示例输出展示了报告的部分数据。型号和固件与 `smartctl` 报告的一致。配置包括可以在分区和创建文件系统之前调节的参数：
- en: '[PRE88]'
  id: totrans-436
  prefs: []
  type: TYPE_PRE
  zh: '[PRE88]'
- en: How it works
  id: totrans-437
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 工作原理
- en: The `hdparm` command is a user interface into the kernel libraries and modules.
    It includes support for modifying parameters as well as reporting them. Use extreme
    caution when changing these parameters!
  id: totrans-438
  prefs: []
  type: TYPE_NORMAL
  zh: '`hdparm` 命令是进入内核库和模块的用户界面。它支持修改参数和报告参数。修改这些参数时必须小心谨慎！'
- en: There's more
  id: totrans-439
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 还有更多
- en: 'The `hdparm` command can test a disk''s performance. The `-t` and `-T` options
    performs timing tests on buffered and cached reads, respectively:'
  id: totrans-440
  prefs: []
  type: TYPE_NORMAL
  zh: '`hdparm` 命令可以测试磁盘性能。`-t` 和 `-T` 选项分别对缓冲和缓存读取进行时间测试：'
- en: '[PRE89]'
  id: totrans-441
  prefs: []
  type: TYPE_PRE
  zh: '[PRE89]'
