- en: Chapter 1. Working with KVM Guests
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 第 1 章：与 KVM 客户机的工作
- en: 'In this chapter, we will cover the following recipes:'
  id: totrans-1
  prefs: []
  type: TYPE_NORMAL
  zh: 本章将涵盖以下内容：
- en: Installing and configuring a KVM
  id: totrans-2
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 安装和配置 KVM
- en: Configuring resources
  id: totrans-3
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 配置资源
- en: Building VMs
  id: totrans-4
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 构建虚拟机
- en: Adding CPUs on the fly
  id: totrans-5
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 动态添加 CPU
- en: Adding RAM on the fly
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 动态添加内存
- en: Adding disks on the fly
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 动态添加磁盘
- en: Moving disks to another storage
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 将磁盘移动到另一个存储
- en: Moving VMs
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 移动虚拟机
- en: Backing up your VM metadata
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 备份虚拟机元数据
- en: Introduction
  id: totrans-11
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 简介
- en: This book will attempt to show you how to deploy RHEL 7 systems without too
    much of a hassle. As this book is written with automation in mind, I will emphasize
    on command-line utilities rather than elaborating on its GUI counterparts, which
    are useless for automation.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 本书将尝试向你展示如何不费太多力气地部署 RHEL 7 系统。由于本书是以自动化为目标编写的，因此我将强调命令行工具，而不是详细讨论其图形界面版本，因为图形界面对于自动化没有什么帮助。
- en: This chapter explains how to build and manage KVM guests using the libvirt interface
    and various tools built around it. It will provide a brief overview on how to
    set up a KVM on RHEL and manage its resources. The setup provided in this overview
    is far from the ready enterprise as it doesn't provide any redundancy, which is
    generally required in enterprises. However, the recipes provided are relevant
    in enterprise setups as the interface stays the same. Most of the time, you will
    probably use a management layer (such as RHEV or oVirt), which will make your
    life easier in managing redundancy.
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 本章解释了如何使用 libvirt 接口和围绕它构建的各种工具来构建和管理 KVM 客户机。它将简要概述如何在 RHEL 上设置 KVM 并管理其资源。此概述中的设置远非企业级准备，因为它不提供通常在企业中所需的冗余。然而，提供的食谱对于企业设置仍然具有参考意义，因为界面保持不变。大多数情况下，你可能会使用一个管理层（如
    RHEV 或 oVirt），这将使你在管理冗余时更加轻松。
- en: Note
  id: totrans-14
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: Libvirt is the API between the user and the various virtualization and container
    layers that are available, such as KVM, VMware, Hyper-V, and Linux Containers.
    Check [https://libvirt.org/drivers.html](https://libvirt.org/drivers.html) for
    a complete list of supported hypervisors and container solutions.
  id: totrans-15
  prefs: []
  type: TYPE_NORMAL
  zh: Libvirt 是用户与各种虚拟化和容器层之间的 API，例如 KVM、VMware、Hyper-V 和 Linux 容器。查看 [https://libvirt.org/drivers.html](https://libvirt.org/drivers.html)
    了解完整的支持的虚拟化程序和容器解决方案列表。
- en: As most tasks performed need to be automated in the end, I tend not to use any
    graphical interfaces as these do not allow an easy conversion into script. Hence,
    you will not find any recipes in this chapter involving a graphical interface.
    These recipes will primarily focus on `virsh`, the libvirt management user interface
    that is used to manage various aspects of your KVM host and guests. While a lot
    of people rely on the edit option of `virsh`, it doesn't allow you to edit a guest's
    configuration in real time. Editing your guest's XML configuration in this way
    will require you to shut down and boot your guest for the changes to take effect.
    A reboot of your guest doesn't do the trick as the XML configuration needs to
    be completely reread by the guest's instance in order for it to apply the changes.
    Only a fresh boot of the guest will do this.
  id: totrans-16
  prefs: []
  type: TYPE_NORMAL
  zh: 由于大多数任务最终需要自动化，我倾向于不使用任何图形界面，因为这些界面无法轻松转换为脚本。因此，本章不会涉及任何图形界面的操作。这些内容将主要聚焦于 `virsh`，即
    libvirt 管理用户界面，用于管理你的 KVM 主机及其虚拟机的各个方面。虽然很多人依赖 `virsh` 的编辑选项，但它不允许你实时编辑虚拟机的配置。通过这种方式编辑虚拟机的
    XML 配置，需要你关机并重启虚拟机，才能使更改生效。重启虚拟机并不奏效，因为虚拟机实例需要完全重新读取 XML 配置文件才能应用更改。只有重新启动虚拟机才能做到这一点。
- en: The `virsh` interface is also a shell, so by launching `virsh` without any commands,
    you will enter the libvirt management shell. A very interesting command is `help`.
    This will output all the available commands grouped by keyword. Each command accepts
    the `--help` argument to show a detailed list of the possible arguments, and their
    explanation, which you can use.
  id: totrans-17
  prefs: []
  type: TYPE_NORMAL
  zh: '`virsh` 接口也是一个 shell，因此通过启动 `virsh` 而不带任何命令，你将进入 libvirt 管理 shell。一个非常有趣的命令是
    `help`。此命令将按关键字输出所有可用的命令。每个命令都可以接受 `--help` 参数，显示可能的参数及其说明，供你使用。'
- en: Installing and configuring a KVM
  id: totrans-18
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 安装和配置 KVM
- en: This recipe covers the installing of virtualization tools and packages on RHEL
    7.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: 本章介绍如何在 RHEL 7 上安装虚拟化工具和软件包。
- en: 'By default, a RHEL 7 system doesn''t come with a KVM or libvirt preinstalled.
    This can be installed in three ways:'
  id: totrans-20
  prefs: []
  type: TYPE_NORMAL
  zh: 默认情况下，RHEL 7 系统并未预安装 KVM 或 libvirt。可以通过以下三种方式安装：
- en: Through the graphical setup during the system's setup
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过系统设置过程中的图形化设置
- en: Via a kickstart installation
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过 kickstart 安装
- en: Through a manual installation from the command line
  id: totrans-23
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 通过命令行进行手动安装
- en: For this recipe, you should know how to install packages using yum, and your
    system should be configured to have access to the default RHEL 7 repository (refer
    to [Chapter 8](part0066_split_000.html#1UU541-501a83dd54944cb1bf060a2ce9fab11f
    "Chapter 8. Yum and Repositories"), *Yum and Repositories*, for more information),
    which is required for the packages that we will use.
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 对于本教程，您应该知道如何使用 yum 安装软件包，并且您的系统应该配置为可以访问默认的 RHEL 7 仓库（有关更多信息，请参见 [第 8 章](part0066_split_000.html#1UU541-501a83dd54944cb1bf060a2ce9fab11f
    "Chapter 8. Yum and Repositories")，*Yum 和仓库*），这是我们将要使用的软件包所必需的。
- en: Alternatively, you could install packages from the installation media using
    `rpm`, but you'll need to figure out the dependencies yourself.
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以使用 `rpm` 从安装介质中安装软件包，但您需要自己解决依赖问题。
- en: 'Check the dependencies of an `rpm` using the following command:'
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令检查 `rpm` 的依赖项：
- en: '[PRE0]'
  id: totrans-27
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: This will output a list of binaries, libraries, and files that you need installed
    prior to installing this package.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: 这将输出安装此软件包之前需要安装的二进制文件、库和文件的列表。
- en: 'Check which package contains these files through this command:'
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: 通过以下命令检查哪个软件包包含这些文件：
- en: '[PRE1]'
  id: totrans-30
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: As you can imagine, this is a tedious job and can take quite some time as you
    need to figure out every dependency for every package that you want to install
    in this way.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所想，这是一项繁琐的工作，可能需要相当长的时间，因为您需要为每个要以这种方式安装的软件包找出每个依赖项。
- en: Getting ready
  id: totrans-32
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: To install a KVM, you will require at least 6 GB of free disk space, 2 GB of
    RAM, and an additional core or thread per guest.
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: 安装 KVM 时，您至少需要 6 GB 的空闲磁盘空间、2 GB 的 RAM，并且每个虚拟机需要额外的一个核心或线程。
- en: 'Check whether your CPU supports a virtualization flag (such as SVM or VMX).
    Some hardware vendors disable this in the BIOS, so you may want to check your
    BIOS as well. Run the following command:'
  id: totrans-34
  prefs: []
  type: TYPE_NORMAL
  zh: 检查您的 CPU 是否支持虚拟化标志（如 SVM 或 VMX）。某些硬件厂商在 BIOS 中禁用了该功能，因此您可能还需要检查您的 BIOS。请运行以下命令：
- en: '[PRE2]'
  id: totrans-35
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Alternatively, you can run the following command:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 或者，您可以运行以下命令：
- en: '[PRE3]'
  id: totrans-37
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: 'Check whether the hardware virtualization modules (such as `kvm_intel` and
    `kvm`) are loaded in the kernel using the following command:'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: 使用以下命令检查硬件虚拟化模块（如 `kvm_intel` 和 `kvm`）是否已加载到内核中：
- en: '[PRE4]'
  id: totrans-39
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: How to do it…
  id: totrans-40
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: We'll look at the three ways of installing a KVM onto your system.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将介绍将 KVM 安装到系统上的三种方式。
- en: Manual installation
  id: totrans-42
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 手动安装
- en: 'This way of installing a KVM is generally done once the base system is installed
    by some other means. You need to perform the following steps:'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: 这种安装 KVM 的方式通常是在使用其他方式安装基本系统后进行的。您需要执行以下步骤：
- en: 'Install the software needed to provide an environment to host virtualized guests
    with the following command:'
  id: totrans-44
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令安装提供虚拟化客机环境所需的软件：
- en: '[PRE5]'
  id: totrans-45
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The installation of these packages will include quite a lot of dependencies.
  id: totrans-46
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这些软件包的安装将包含相当多的依赖项。
- en: 'Install additional utilities required to configure `libvirt` and install virtual
    machines by running this command:'
  id: totrans-47
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 运行此命令安装配置 `libvirt` 和安装虚拟机所需的附加实用工具：
- en: '[PRE6]'
  id: totrans-48
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'By default, the `libvirt` daemon is marked to `autostart` on each boot. Check
    whether it is enabled by executing the following command:'
  id: totrans-49
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 默认情况下，`libvirt` 守护进程会在每次启动时自动启动。通过执行以下命令检查它是否已启用：
- en: '[PRE7]'
  id: totrans-50
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE7]'
- en: 'If for some reason this is not the case, mark it for autostart by executing
    the following:'
  id: totrans-51
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 如果由于某些原因情况并非如此，请通过执行以下命令将其标记为自动启动：
- en: '[PRE8]'
  id: totrans-52
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE8]'
- en: 'To manually stop/start/restart the `libvirt` daemon, this is what you''ll need
    to execute:'
  id: totrans-53
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 要手动停止/启动/重启 `libvirt` 守护进程，您需要执行以下命令：
- en: '[PRE9]'
  id: totrans-54
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Kickstart installation
  id: totrans-55
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: Kickstart 安装
- en: 'Installing a KVM during kickstart offers you an easy way to automate the installation
    of KVM instances. Perform the following steps:'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: 在 kickstart 过程中安装 KVM 提供了一种简单的方式来自动化 KVM 实例的安装。请按照以下步骤操作：
- en: 'Add the following package groups to your kickstarted file in the `%packages`
    section:'
  id: totrans-57
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在您的 kickstart 文件的 `%packages` 部分添加以下软件包组：
- en: '[PRE10]'
  id: totrans-58
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE10]'
- en: Start the installation of your host with this kickstart file.
  id: totrans-59
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用此 kickstart 文件开始安装您的主机。
- en: Graphical setup during the system's setup
  id: totrans-60
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在系统设置过程中进行图形化设置
- en: 'This is probably the least common way of installing a KVM. The only time I
    used this was during the course of writing this recipe. Here''s how you can do
    this:'
  id: totrans-61
  prefs: []
  type: TYPE_NORMAL
  zh: 这可能是安装 KVM 最不常见的方式。我唯一使用这种方式的时间是在编写本教程时。以下是如何操作：
- en: Boot from the RHEL 7 Installation media.
  id: totrans-62
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 从 RHEL 7 安装介质启动。
- en: Complete all steps besides the **Software selection** step.![Graphical setup
    during the system's setup](img/00002.jpeg)
  id: totrans-63
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 完成除**软件选择**步骤之外的所有步骤。![系统设置中的图形界面设置](img/00002.jpeg)
- en: Go to **Software Selection** to complete the KVM software selection.
  id: totrans-64
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 前往**软件选择**完成KVM软件选择。
- en: Select the **Virtualization host** radio button in **Base Environment**, and
    check the **Virtualization Platform** checkbox in **Add-Ons for Selected Environment**:![Graphical
    setup during the system's setup](img/00003.jpeg)
  id: totrans-65
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**基础环境**中选择**虚拟化主机**单选按钮，在**为选定环境添加附加组件**中勾选**虚拟化平台**复选框：![系统设置中的图形界面设置](img/00003.jpeg)
- en: Finalize the installation.
  id: totrans-66
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 完成安装。
- en: On the **Installation Summary** screen, complete any other steps and click on
    **Begin Installation**.
  id: totrans-67
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在**安装总结**屏幕上，完成其他步骤并点击**开始安装**。
- en: See also
  id: totrans-68
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参见
- en: To set up your repositories, check out [Chapter 8](part0066_split_000.html#1UU541-501a83dd54944cb1bf060a2ce9fab11f
    "Chapter 8. Yum and Repositories"), *Yum and Repositories*.
  id: totrans-69
  prefs: []
  type: TYPE_NORMAL
  zh: 要设置您的软件仓库，请查看[第8章](part0066_split_000.html#1UU541-501a83dd54944cb1bf060a2ce9fab11f
    "第8章。Yum和仓库")，*Yum和仓库*。
- en: To deploy a system using kickstart, refer to [Chapter 2](part0025_split_000.html#NQU21-501a83dd54944cb1bf060a2ce9fab11f
    "Chapter 2. Deploying RHEL "En Masse""), *Deploying RHEL "En Masse"*.
  id: totrans-70
  prefs: []
  type: TYPE_NORMAL
  zh: 要使用kickstart部署系统，请参考[第2章](part0025_split_000.html#NQU21-501a83dd54944cb1bf060a2ce9fab11f
    "第2章。大规模部署RHEL")，*大规模部署RHEL*。
- en: For more in-depth information about using libvirt, go to [http://www.libvirt.org/](http://www.libvirt.org/).
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: 有关如何使用libvirt的更深入信息，请访问[http://www.libvirt.org/](http://www.libvirt.org/)。
- en: 'RHEL 7 has certain support limits, which are listed at these locations:'
  id: totrans-72
  prefs: []
  type: TYPE_NORMAL
  zh: RHEL 7有某些支持限制，列在以下位置：
- en: '[https://access.redhat.com/articles/rhel-kvm-limits](https://access.redhat.com/articles/rhel-kvm-limits)'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://access.redhat.com/articles/rhel-kvm-limits](https://access.redhat.com/articles/rhel-kvm-limits)'
- en: '[https://access.redhat.com/articles/rhel-limits](https://access.redhat.com/articles/rhel-limits)'
  id: totrans-74
  prefs: []
  type: TYPE_NORMAL
  zh: '[https://access.redhat.com/articles/rhel-limits](https://access.redhat.com/articles/rhel-limits)'
- en: Configuring resources
  id: totrans-75
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 配置资源
- en: Virtual machines require CPUs, memory, storage, and network access, similar
    to physical machines. This recipe will show you how to set up a basic KVM environment
    for easy resource management through libvirt.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: 虚拟机需要CPU、内存、存储和网络访问，类似于物理机器。此食谱将向您展示如何通过libvirt设置基本的KVM环境，以便轻松管理资源。
- en: 'A storage pool is a virtual container limited by two factors:'
  id: totrans-77
  prefs: []
  type: TYPE_NORMAL
  zh: 存储池是一个虚拟容器，受到两个因素的限制：
- en: The maximum size allowed by `qemu-kvm`
  id: totrans-78
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`qemu-kvm`允许的最大大小'
- en: The size of the disk on the physical machine
  id: totrans-79
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 物理机器上磁盘的大小
- en: 'Storage pools may not exceed the size of the disk on the host. The maximum
    sizes are as follows:'
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: 存储池的大小不得超过主机磁盘的大小。最大值如下：
- en: virtio-blk = 2^63 bytes or 8 exabytes (raw files or disk)
  id: totrans-81
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: virtio-blk = 2^63字节或8艾字节（原始文件或磁盘）
- en: EXT4 = ~ 16 TB (using 4 KB block size)
  id: totrans-82
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: EXT4 = ~16 TB（使用4KB块大小）
- en: XFS = ~8 exabytes
  id: totrans-83
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: XFS = ~8艾字节
- en: Getting ready
  id: totrans-84
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: For this recipe, you will need a volume of at least 2 GB mounted on `/vm` and
    access to an NFS server and export.
  id: totrans-85
  prefs: []
  type: TYPE_NORMAL
  zh: 对于此食谱，您需要至少2GB的卷挂载在`/vm`，并且可以访问NFS服务器及其导出目录。
- en: We'll use `NetworkManager` to create a bridge, so ensure that you don't disable
    `NetworkManager` and have `bridge-utils` installed.
  id: totrans-86
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将使用`NetworkManager`创建一个桥接，因此请确保不要禁用`NetworkManager`，并且已安装`bridge-utils`。
- en: How to do it…
  id: totrans-87
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: Let's have a look into managing storage pools and networks.
  id: totrans-88
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们看看如何管理存储池和网络。
- en: Creating storage pools
  id: totrans-89
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 创建存储池
- en: 'In order to create storage pools, we need to provide the necessary details
    to the KVM for it to be able to create it. You can do this as follows:'
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: 为了创建存储池，我们需要向KVM提供必要的详细信息，以便它能够创建存储池。您可以按以下方式进行操作：
- en: 'Create a `localfs` storage pool using `virsh` on `/vm`, as follows:'
  id: totrans-91
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`virsh`在`/vm`上创建一个`localfs`存储池，如下所示：
- en: '[PRE11]'
  id: totrans-92
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'Create the target for the storage pool through the following command:'
  id: totrans-93
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令创建存储池的目标：
- en: '[PRE12]'
  id: totrans-94
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'Create an NFS storage pool using `virsh` on NFS server:`/export/vm`, as follows:'
  id: totrans-95
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用`virsh`在NFS服务器上创建一个NFS存储池：`/export/vm`，如下所示：
- en: '[PRE13]'
  id: totrans-96
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Make the storage pools persistent across reboots through the following commands:'
  id: totrans-97
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令使存储池在重启后保持持久：
- en: '[PRE14]'
  id: totrans-98
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE14]'
- en: 'Start the storage pool, as follows:'
  id: totrans-99
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 启动存储池，如下所示：
- en: '[PRE15]'
  id: totrans-100
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Verify that the storage pools are created, started, and persistent across reboots.
    Run the following for this:'
  id: totrans-101
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 验证存储池是否已创建、启动并在重启后保持持久。为此，运行以下命令：
- en: '[PRE16]'
  id: totrans-102
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE16]'
- en: Querying storage pools
  id: totrans-103
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 查询存储池
- en: At some point in time, you will need to know how much space you have left in
    your storage pool.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: 在某些时刻，您需要知道存储池中剩余的空间。
- en: 'Get the information of the storage pool by executing the following:'
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: 执行以下命令获取存储池的信息：
- en: '[PRE17]'
  id: totrans-106
  prefs: []
  type: TYPE_PRE
  zh: '[PRE17]'
- en: As you can see, this command easily shows you its disk space allocation and
    availability.
  id: totrans-107
  prefs: []
  type: TYPE_NORMAL
  zh: 如您所见，该命令可以轻松地显示磁盘空间的分配和可用性。
- en: Tip
  id: totrans-108
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 提示
- en: Be careful though; if you use a filesystem that supports sparse files, these
    numbers will most likely be incorrect. You will have to manually calculate the
    sizes yourself!
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: 但请小心，如果使用支持稀疏文件的文件系统，这些数字很可能是错误的。您需要手动计算文件的大小！
- en: 'To detect whether a file is sparse, run `ls -lhs` against the file. The `-s`
    command will show an additional column (the first), showing the exact space that
    the file is occupying, as follows:'
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: 要检测文件是否是稀疏文件，请运行`ls -lhs`命令查看文件。`-s`命令会显示一个额外的列（第一个），显示文件占用的确切空间，如下所示：
- en: '[PRE18]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE18]'
- en: Removing storage pools
  id: totrans-112
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 删除存储池
- en: Sometimes, storage is phased out. So, it needs to be removed from the host.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: 有时，存储会被淘汰，因此需要从主机中移除。
- en: 'You have to ensure that no guest is using volumes on the storage pool before
    proceeding, and you need to remove all the remaining volumes from the storage
    pool. Here''s how to do this:'
  id: totrans-114
  prefs: []
  type: TYPE_NORMAL
  zh: 在继续之前，您必须确保没有虚拟机正在使用存储池中的卷，并且需要移除存储池中所有剩余的卷。操作方法如下：
- en: 'Remove the storage volume, as follows:'
  id: totrans-115
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照以下方式删除存储卷：
- en: '[PRE19]'
  id: totrans-116
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE19]'
- en: 'Stop the storage pool through the following command:'
  id: totrans-117
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令停止存储池：
- en: '[PRE20]'
  id: totrans-118
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE20]'
- en: 'Delete the storage pool using the following command:'
  id: totrans-119
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令删除存储池：
- en: '[PRE21]'
  id: totrans-120
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE21]'
- en: Creating a virtual network
  id: totrans-121
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 创建虚拟网络
- en: Before creating the virtual networks, we need to build a bridge over our existing
    network interface. For the sake of convenience, this NIC will be called `eth0`.
    Ensure that you record your current network configuration as we'll destroy it
    and recreate it on the bridge.
  id: totrans-122
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建虚拟网络之前，我们需要在现有的网络接口上构建一个桥接。为了方便起见，这个NIC将被称为`eth0`。确保记录下您当前的网络配置，因为我们将销毁它并在桥接上重新创建它。
- en: 'Unlike the storage pool, we need to create an XML configuration file to define
    the networks. There is no command similar to `pool-create-as` for networks. Perform
    the following steps:'
  id: totrans-123
  prefs: []
  type: TYPE_NORMAL
  zh: 与存储池不同，我们需要创建XML配置文件来定义网络。没有类似于`pool-create-as`的命令用于网络。执行以下步骤：
- en: 'Create a bridge interface on your network''s interface, as follows:'
  id: totrans-124
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照以下方式在您的网络接口上创建桥接接口：
- en: '[PRE22]'
  id: totrans-125
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE22]'
- en: 'Remove your NIC''s configuration using the following command:'
  id: totrans-126
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令移除您的NIC配置：
- en: '[PRE23]'
  id: totrans-127
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE23]'
- en: 'Configure your bridge, as follows:'
  id: totrans-128
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照以下方式配置您的桥接：
- en: '[PRE24]'
  id: totrans-129
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE24]'
- en: 'Finally, add your NIC to the bridge by executing the following:'
  id: totrans-130
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 最后，通过执行以下命令将您的网络接口卡（NIC）添加到桥接中：
- en: '[PRE25]'
  id: totrans-131
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE25]'
- en: 'For starters, we''ll take a look at how we can create a NATed network similar
    to the one that is configured by default and called the default:'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: 首先，我们来看一下如何创建一个类似于默认配置并称为默认的NAT网络：
- en: 'Create the network XML configuration file, `/tmp/net-nat.xml`, as follows:'
  id: totrans-133
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 创建网络XML配置文件`/tmp/net-nat.xml`，方法如下：
- en: '[PRE26]'
  id: totrans-134
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE26]'
- en: 'Define the network in the KVM using the preceding XML configuration file. Execute
    the following command:'
  id: totrans-135
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用前述XML配置文件在KVM中定义网络。执行以下命令：
- en: '[PRE27]'
  id: totrans-136
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE27]'
- en: 'Now, let''s create a bridged network that can use the network bound to this
    bridge through the following steps:'
  id: totrans-137
  prefs: []
  type: TYPE_NORMAL
  zh: 现在，让我们通过以下步骤创建一个桥接网络，该网络可以通过该桥接使用绑定的网络：
- en: 'Create the network XML configuration file, `/tmp/net-bridge-eth0.xml`, by running
    the following:'
  id: totrans-138
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过运行以下命令创建网络XML配置文件`/tmp/net-bridge-eth0.xml`：
- en: '[PRE28]'
  id: totrans-139
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE28]'
- en: 'Create the network in the KVM using the preceding file, as follows:'
  id: totrans-140
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用前述文件在KVM中创建网络，方法如下：
- en: '[PRE29]'
  id: totrans-141
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE29]'
- en: 'There''s one more type of network that is worth mentioning: the isolated network.
    This network is only accessible to guests defined in this network as there is
    no connection to the "real" world.'
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: 还有一种值得提及的网络类型：隔离网络。该网络只能供定义在该网络中的虚拟机访问，因为它与“真实”世界没有连接。
- en: 'Create the network XML configuration file, `/tmp/net-local.xml`, by using the
    following code:'
  id: totrans-143
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下代码创建网络XML配置文件`/tmp/net-local.xml`：
- en: '[PRE30]'
  id: totrans-144
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE30]'
- en: 'Create the network in KVM by using the above file:'
  id: totrans-145
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用上述文件在KVM中创建网络：
- en: '[PRE31]'
  id: totrans-146
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE31]'
- en: 'Creating networks in this way will register them with the KVM but will not
    activate them or make them persistent through reboots. So, this is an additional
    step that you need to perform for each network. Now, perform the following steps:'
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: 通过这种方式创建网络将使它们在KVM中注册，但不会激活它们或使其在重启后保持持久性。因此，这是您需要为每个网络执行的额外步骤。现在，执行以下步骤：
- en: 'Make the network persistent across reboots using the following command:'
  id: totrans-148
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令使网络在重启后保持持久性：
- en: '[PRE32]'
  id: totrans-149
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE32]'
- en: 'Activate the network, as follows:'
  id: totrans-150
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按照以下方式激活网络：
- en: '[PRE33]'
  id: totrans-151
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE33]'
- en: 'Verify the existence of the KVM network by executing the following:'
  id: totrans-152
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过执行以下命令来验证 KVM 网络是否存在：
- en: '[PRE34]'
  id: totrans-153
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE34]'
- en: Removing networks
  id: totrans-154
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 删除网络
- en: On some occasions, the networks are phased out; in this case, we need to remove
    the network from our setup.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: 在某些情况下，网络会被淘汰；在这种情况下，我们需要从设置中删除该网络。
- en: 'Prior to executing this, you need to ensure that no guest is using the network
    that you want to remove. Perform the following steps to remove the networks:'
  id: totrans-156
  prefs: []
  type: TYPE_NORMAL
  zh: 在执行此操作之前，你需要确保没有虚拟机使用你想要删除的网络。请执行以下步骤删除网络：
- en: 'Stop the network with the following command:'
  id: totrans-157
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 使用以下命令停止网络：
- en: '[PRE35]'
  id: totrans-158
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE35]'
- en: 'Then, delete the network using this command:'
  id: totrans-159
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 然后，使用以下命令删除网络：
- en: '[PRE36]'
  id: totrans-160
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE36]'
- en: How it works…
  id: totrans-161
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的…
- en: It's easy to create multiple storage pools using the define-pool-as command,
    as you can see. Every type of storage pool needs more, or fewer, arguments. In
    the case of the NFS storage pool, we need to specify the NFS server and export.
    This is done by specifying--source-host and--source-path respectively.
  id: totrans-162
  prefs: []
  type: TYPE_NORMAL
  zh: 使用 `define-pool-as` 命令创建多个存储池非常简单，如你所见。每种类型的存储池需要的参数多或少。以 NFS 存储池为例，我们需要指定 NFS
    服务器和导出路径。这通过分别指定 `--source-host` 和 `--source-path` 来完成。
- en: Creating networks is a bit more complex as it requires you to create a XML configuration
    file. When you want a network connected transparently to your physical networks,
    you can only use bridged networks as it is impossible to bind a network straight
    to your network's interface.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: 创建网络稍微复杂一些，因为它需要你创建一个 XML 配置文件。当你想要一个网络透明地连接到你的物理网络时，你只能使用桥接网络，因为不可能将网络直接绑定到网络接口。
- en: There's more…
  id: totrans-164
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多…
- en: 'The storage backend created in this recipe is not the limit. Libvirt also supports
    the following backend pools:'
  id: totrans-165
  prefs: []
  type: TYPE_NORMAL
  zh: 本食谱中创建的存储后端并不是限制。Libvirt 还支持以下后端池：
- en: Local storage pools
  id: totrans-166
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 本地存储池
- en: Local storage pools are directly connected to the physical machine. They include
    local directories, disks, partitions, and LVM volume groups. Local storage pools
    are not suitable for enterprises as these do not support live migration.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: 本地存储池直接连接到物理机器。它们包括本地目录、磁盘、分区和 LVM 卷组。由于本地存储池不支持实时迁移，因此不适合企业使用。
- en: Networked or shared storage pools
  id: totrans-168
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 网络或共享存储池
- en: Network storage pools include storage shared through standard protocols over
    a network. This is required when we migrate virtual machines between physical
    hosts. The supported network storage protocols are Fibre Channel-based LUNs, iSCSI,
    NFS, GFS2, and SCSI RDMA.
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: 网络存储池包括通过标准协议在网络上共享的存储。这在我们在物理主机之间迁移虚拟机时是必需的。支持的网络存储协议包括基于 Fibre Channel 的 LUN、iSCSI、NFS、GFS2
    和 SCSI RDMA。
- en: By defining the storage pools and networks in libvirt, you ensure the availability
    of the resources for your guest. If, for some reason, the resource is unavailable,
    the KVM will not attempt to start the guests that use these resources.
  id: totrans-170
  prefs: []
  type: TYPE_NORMAL
  zh: 通过在 libvirt 中定义存储池和网络，你确保了虚拟机资源的可用性。如果由于某些原因资源不可用，KVM 将不会尝试启动使用这些资源的虚拟机。
- en: 'When checking out the man page for *virsh (1)*, you will find a similar command
    to `net-define`, `pool-define`: `net-create`, and `pool-create` (and `pool-create-as`).
    The `net-create` command, similar to `pool-create` and `pool-create-as`, creates
    transient (or temporary) resources, which will be gone when libvirt is restarted.
    On the other hand, `net-define` and `pool-define` (as also `pool-define-as`) create
    persistent (or permanent) resources, which will still be there after you restart
    libvirt.'
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: 当查看 *virsh (1)* 的手册页时，你会发现一个类似于 `net-define`、`pool-define` 的命令：`net-create`
    和 `pool-create`（以及 `pool-create-as`）。`net-create` 命令类似于 `pool-create` 和 `pool-create-as`，它创建临时资源，这些资源在
    libvirt 重启后将消失。另一方面，`net-define` 和 `pool-define`（以及 `pool-define-as`）创建持久性资源，这些资源在你重启
    libvirt 后仍然存在。
- en: See also
  id: totrans-172
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: You can find out more on libvirt storage backend pools at [https://libvirt.org/storage.html](https://libvirt.org/storage.html)
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以在 [https://libvirt.org/storage.html](https://libvirt.org/storage.html) 上了解更多关于
    libvirt 存储后端池的信息
- en: More information on libvirt networking can be found at [http://wiki.libvirt.org/page/Networking](http://wiki.libvirt.org/page/Networking)
  id: totrans-174
  prefs: []
  type: TYPE_NORMAL
  zh: 更多关于 libvirt 网络的信息可以在 [http://wiki.libvirt.org/page/Networking](http://wiki.libvirt.org/page/Networking)
    上找到
- en: Building guests
  id: totrans-175
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 创建客户端
- en: 'After you install and configure a KVM on the host system, you can create guest
    operating systems. Every guest is defined by a set of resources and parameters
    stored in the XML format. When you want to create a new guest, creating such an
    XML file is quite cumbersome. There are two ways to create a guest:'
  id: totrans-176
  prefs: []
  type: TYPE_NORMAL
  zh: 在宿主系统上安装并配置 KVM 后，你可以创建来宾操作系统。每个来宾由一组以 XML 格式存储的资源和参数定义。当你想要创建一个新来宾时，创建这样的 XML
    文件是相当繁琐的。创建来宾有两种方法：
- en: Using `virt-manager`
  id: totrans-177
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 `virt-manager`
- en: Using `virt-install`
  id: totrans-178
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 使用 `virt-install`
- en: This recipe will employ the latter as it is perfect for scripting, while `virt-manager`
    is a GUI and not very well suited to automate things.
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程将采用后者，因为它非常适合脚本编写，而 `virt-manager` 是一个 GUI，不太适合自动化操作。
- en: Getting ready
  id: totrans-180
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: In this recipe, we will cover a generic approach to create a new virtual machine
    using the `bridge-eth0` network bridge and create a virtual disk on the `localfs-vm`
    storage pool, which is formatted as QCOW2\. The QCOW2 format is a popular virtual
    disk format as it allows thin provisioning and snapshotting. We will boot the
    RHEL 7 installation media located on the `localfs-iso` storage pool (`rhel7-install.iso`)
    to start installing a new RHEL 7 system.
  id: totrans-181
  prefs: []
  type: TYPE_NORMAL
  zh: 在本教程中，我们将介绍如何使用 `bridge-eth0` 网络桥接来创建一个新的虚拟机，并在 `localfs-vm` 存储池上创建一个虚拟磁盘，格式为
    QCOW2。QCOW2 格式是流行的虚拟磁盘格式，因为它允许薄配给和快照。我们将从位于 `localfs-iso` 存储池中的 RHEL 7 安装媒体（`rhel7-install.iso`）启动，开始安装一个新的
    RHEL 7 系统。
- en: How to do it…
  id: totrans-182
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: Let's create some guests and delete them.
  id: totrans-183
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们创建一些来宾并删除它们。
- en: Create a guest
  id: totrans-184
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 创建来宾
- en: 'Let''s first create a disk for the guest and then create the guest on this
    disk, as follows:'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们先为来宾创建一个磁盘，然后在此磁盘上创建来宾，步骤如下：
- en: 'Create a 10 GB QCOW2 format disk in the `localfs-vm` pool, as follows:'
  id: totrans-186
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在 `localfs-vm` 存储池中创建一个 10 GB 的 QCOW2 格式磁盘，步骤如下：
- en: '[PRE37]'
  id: totrans-187
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE37]'
- en: 'Create the virtual machine and start it through the following command:'
  id: totrans-188
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令创建虚拟机并启动它：
- en: '[PRE38]'
  id: totrans-189
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE38]'
- en: Deleting a guest
  id: totrans-190
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 删除来宾
- en: 'At some point, you''ll need to remove the guests. You can do this as follows:'
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: 在某些情况下，你需要移除来宾。你可以按以下步骤进行：
- en: 'First, ensure that the guest is down by running the following:'
  id: totrans-192
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 首先，确保通过运行以下命令让来宾关闭：
- en: '[PRE39]'
  id: totrans-193
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE39]'
- en: 'If the state is not `shut off`, you can forcefully shut it down:'
  id: totrans-194
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 如果状态不是 `shut off`，你可以强制关闭它：
- en: '[PRE40]'
  id: totrans-195
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE40]'
- en: 'List the storage volumes in use by your guest and copy this somewhere:'
  id: totrans-196
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 列出当前来宾正在使用的存储卷，并将其复制到某个地方：
- en: '[PRE41]'
  id: totrans-197
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE41]'
- en: 'Delete the guest through the following command:'
  id: totrans-198
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令删除来宾：
- en: '[PRE42]'
  id: totrans-199
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE42]'
- en: Adding `--remove-all-storage` to the command will wipe off the data on the storage
    volumes dedicated to this guest prior to deleting the volume from the pool.
  id: totrans-200
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 在命令中添加 `--remove-all-storage` 将在删除存储池中的卷之前清除该来宾专用存储卷上的数据。
- en: How it works…
  id: totrans-201
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的…
- en: The `virt-install` command supports creating storage volumes (disks) by specifying
    the pool, size, and format. However, if this storage volume already exists, the
    application will fail. Depending on the speed of your KVM host disks (local or
    network) and the size of the guest's disks, the process of creating a new disk
    may take some time to be completed. By specifying an existing disk with `virt-install`,
    you can reuse the disk should you need to reinstall the guest. It would be possible
    to only create the disk on the first pass and change your command line appropriately
    after this. However, the fact remains that using `virsh vol-create-as` gives you
    more granular control of what you want to do.
  id: totrans-202
  prefs: []
  type: TYPE_NORMAL
  zh: '`virt-install` 命令支持通过指定池、大小和格式来创建存储卷（磁盘）。但是，如果该存储卷已存在，应用程序将失败。根据 KVM 宿主机磁盘（本地或网络）的速度以及来宾磁盘的大小，创建新磁盘的过程可能需要一些时间才能完成。通过使用
    `virt-install` 指定现有磁盘，如果需要重新安装来宾，你可以重用该磁盘。可以在第一次创建时只创建磁盘，并在此后相应地更改命令行。然而，事实是，使用
    `virsh vol-create-as` 能让你对所做的操作有更精细的控制。'
- en: We're using the QCOW2 format to contain the guest's disk as it is a popular
    format when it comes to storing KVM guest disks. This is because it supports thin
    provisioning and snapshotting.
  id: totrans-203
  prefs: []
  type: TYPE_NORMAL
  zh: 我们使用 QCOW2 格式来存储来宾的磁盘，因为它是存储 KVM 来宾磁盘时流行的格式。这是因为它支持薄配给和快照。
- en: 'When creating the guest, we specify both the `maxmemory` option for memory
    configuration and the `maxvcpus` option for vcpus configuration. This will allow
    us to add CPUs and RAM to the guest while it is running. If we do not assign these,
    we''ll have to shut down the system before being able to change the XML configuration
    using the following command:'
  id: totrans-204
  prefs: []
  type: TYPE_NORMAL
  zh: 在创建虚拟机时，我们指定了`maxmemory`选项来配置内存，以及`maxvcpus`选项来配置虚拟CPU。这将允许我们在虚拟机运行时增加CPU和内存。如果我们没有指定这些选项，我们将不得不先关闭系统，然后才能使用以下命令更改XML配置：
- en: '[PRE43]'
  id: totrans-205
  prefs: []
  type: TYPE_PRE
  zh: '[PRE43]'
- en: As you can see, we're using the `virtio` driver for any hardware (network, disks,
    or balloon) that supports it as it is native to the KVM and is included in the
    RHEL 7 kernel.
  id: totrans-206
  prefs: []
  type: TYPE_NORMAL
  zh: 如你所见，我们使用`virtio`驱动程序来支持任何硬件（网络、磁盘或气球设备），因为它是KVM的本地驱动，并且包含在RHEL 7内核中。
- en: Note
  id: totrans-207
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 注意
- en: If, for some reason, your guest OS doesn't support `virtio` drivers, you should
    remove the `--controller` option of the command line and the bus specification
    from the `--disk` option.
  id: totrans-208
  prefs: []
  type: TYPE_NORMAL
  zh: 如果由于某些原因，虚拟机操作系统不支持`virtio`驱动程序，你应该删除命令行中的`--controller`选项以及`--disk`选项中的总线规范。
- en: For more information on `virtio` support, go to [http://wiki.libvirt.org/page/Virtio](http://wiki.libvirt.org/page/Virtio).
  id: totrans-209
  prefs: []
  type: TYPE_NORMAL
  zh: 有关`virtio`支持的更多信息，请访问 [http://wiki.libvirt.org/page/Virtio](http://wiki.libvirt.org/page/Virtio)。
- en: The `--memballoon` option will ensure that we do not run into problems when
    we overcommit our memory. When specific guests require more memory, the ballooning
    driver will ensure that the "idle" guests' memory can be evenly redistributed.
  id: totrans-210
  prefs: []
  type: TYPE_NORMAL
  zh: '`--memballoon`选项将确保我们在内存过度分配时不会遇到问题。当特定虚拟机需要更多内存时，气球驱动程序将确保“空闲”虚拟机的内存可以均匀地重新分配。'
- en: The `graphics` option will allow you to connect to the guest through the host
    using either VNC (which is a popular client to control remote computers) or spice
    (which is the default client for `virt-manager`). The configuration for both VNC
    and spice is insecure, though. You can either set this up by specifying a password—by
    adding `password=<password>` to each graphics stanza—or by editing the `/etc/libvirt/qemu.conf`
    file on the KVM host, which will be applied to all guests.
  id: totrans-211
  prefs: []
  type: TYPE_NORMAL
  zh: '`graphics`选项将允许你通过宿主机连接到虚拟机，可以使用VNC（这是一种常用的远程计算机控制客户端）或spice（这是`virt-manager`的默认客户端）。不过，VNC和spice的配置都是不安全的。你可以通过指定密码进行设置——在每个graphics配置块中添加`password=<password>`，或者通过编辑KVM宿主机上的`/etc/libvirt/qemu.conf`文件来进行设置，这样的设置将适用于所有虚拟机。'
- en: There's more…
  id: totrans-212
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多…
- en: In this recipe, we used "local" install media in the form of an ISO image to
    install the system. However, it is also possible to install a guest without a
    CD, DVD, or an ISO image. The `--location` installation method option allows you
    to specify a URI that contains your kernel/initrd pair, which is required to start
    the installation.
  id: totrans-213
  prefs: []
  type: TYPE_NORMAL
  zh: 在本教程中，我们使用了“本地”安装介质，以ISO镜像的形式来安装系统。然而，也可以在没有CD、DVD或ISO镜像的情况下安装虚拟机。`--location`安装方法选项允许你指定一个URI，URI中包含启动安装所需的内核/initrd文件对。
- en: Using `--location` in combination with `--extra-args` will allow you to specify
    kernel command-line arguments to pass to the installer. This can be used, for
    instance, to pass on the location of an Anaconda kickstart file for automated
    installs and/or specifying your IP configuration during the installer.
  id: totrans-214
  prefs: []
  type: TYPE_NORMAL
  zh: 将`--location`与`--extra-args`结合使用将允许你指定内核命令行参数传递给安装程序。例如，可以用来传递Anaconda kickstart文件的位置，进行自动化安装和/或在安装过程中指定IP配置。
- en: See also
  id: totrans-215
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另见
- en: Check the man page of *virt-install (1)* for more information on how to use
    it to your advantage.
  id: totrans-216
  prefs: []
  type: TYPE_NORMAL
  zh: 查看*virt-install (1)*的手册页，了解更多如何充分利用它的信息。
- en: Adding CPUs on the fly
  id: totrans-217
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 动态添加CPU
- en: Imagine an enterprise having to correctly add dimension to all their systems
    right from the start. In my experience, this is very difficult. You will either
    underdimension it, and your customers will complain about performance at some
    point, or you will overdimension it, and then the machine will sit there, idling
    about, which is not optimal either. This is the reason hardware vendors have come
    up with `hot-add` resources. This allows a system to have its CPUs, memory, and/or
    disks to be upgraded/increased without the need for a shutdown. A KVM implements
    a similar functionality for its guests. It allows you to increase the CPUs, memory,
    and disks on the fly.
  id: totrans-218
  prefs: []
  type: TYPE_NORMAL
  zh: 想象一下，一个企业必须从一开始就正确地为所有系统进行扩展。在我的经验中，这非常困难。你可能会低估需求，客户在某个时刻会抱怨性能，或者你会过度配置，导致机器空闲，这也不是最优的。这就是硬件供应商提出`hot-add`资源的原因。这样，系统可以在不需要停机的情况下升级或增加CPU、内存和/或磁盘。KVM为其客户机实现了类似的功能，允许你动态增加CPU、内存和磁盘。
- en: The actual recipe is very simple to execute, but there are some prerequisites
    to be met.
  id: totrans-219
  prefs: []
  type: TYPE_NORMAL
  zh: 实际的操作非常简单，但需要满足一些前提条件。
- en: Getting ready
  id: totrans-220
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: In order to be able to add CPUs on the fly to a guest, the guest's configuration
    must support them.
  id: totrans-221
  prefs: []
  type: TYPE_NORMAL
  zh: 为了能够动态为客户机添加CPU，客户机的配置必须支持该功能。
- en: 'There are two ways to achieve this:'
  id: totrans-222
  prefs: []
  type: TYPE_NORMAL
  zh: 有两种方法可以实现这一点：
- en: 'It must be created with the max option, as follows:'
  id: totrans-223
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 必须在创建时指定`max`选项，如下所示：
- en: '[PRE44]'
  id: totrans-224
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE44]'
- en: 'You can set the maximum using `virsh` (which will be applied at the next boot)
    through the following command:'
  id: totrans-225
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以通过以下命令使用`virsh`设置最大值（将在下次启动时应用）：
- en: '[PRE45]'
  id: totrans-226
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE45]'
- en: 'You can edit the guests'' XML files, as follows:'
  id: totrans-227
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以编辑客户机的XML文件，如下所示：
- en: '[PRE46]'
  id: totrans-228
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE46]'
- en: The last two options will require you to shut down and boot (not reboot) your
    guest as these commands cannot change the "live" configuration.
  id: totrans-229
  prefs: []
  type: TYPE_NORMAL
  zh: 最后两种选项要求你关闭并启动（而不是重启）客户机，因为这些命令无法更改“实时”配置。
- en: 'The guest''s XML file must contain the following element with the subsequent
    attributes:'
  id: totrans-230
  prefs: []
  type: TYPE_NORMAL
  zh: 客户机的XML文件必须包含以下元素及其随后的属性：
- en: '[PRE47]'
  id: totrans-231
  prefs: []
  type: TYPE_PRE
  zh: '[PRE47]'
- en: Here, `current` indicates the number of CPUs in use, and the number within the
    node indicates the maximum number of vCPUs that can be assigned. This number can
    be increased but should never exceed the number of cores or threads in your host.
  id: totrans-232
  prefs: []
  type: TYPE_NORMAL
  zh: 这里，`current`表示正在使用的CPU数量，而节点内的数字表示可以分配的vCPU的最大数量。这个数字可以增加，但永远不能超过主机的核心数或线程数。
- en: How to do it…
  id: totrans-233
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: Let's add some CPUs to the guest.
  id: totrans-234
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们给客户机增加一些CPU。
- en: 'On the KVM host, perform the following steps:'
  id: totrans-235
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在KVM主机上，执行以下步骤：
- en: 'Get the maximum number vCPUs that you can assign, as follows:'
  id: totrans-236
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 获取可以分配的最大vCPU数量，如下所示：
- en: '[PRE48]'
  id: totrans-237
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE48]'
- en: 'Now, set the new number of vCPUs through this command:'
  id: totrans-238
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，通过以下命令设置新的vCPU数量：
- en: '[PRE49]'
  id: totrans-239
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE49]'
- en: 'On the KVM guest, perform the following:'
  id: totrans-240
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 在KVM客户机上，执行以下操作：
- en: 'Tell your guest OS there are more CPUs available by executing the following
    command:'
  id: totrans-241
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过执行以下命令告诉客户机操作系统有更多的CPU可用：
- en: '[PRE50]'
  id: totrans-242
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE50]'
- en: Adding RAM on the fly
  id: totrans-243
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 动态添加RAM
- en: As with CPUs, the possibility to add memory on the fly is an added value in
    mission-critical environments where downtime can literally cost a company millions
    of Euros.
  id: totrans-244
  prefs: []
  type: TYPE_NORMAL
  zh: 与CPU一样，动态添加内存在任务关键型环境中是一个附加价值，其中停机时间可能会给公司带来数百万欧元的损失。
- en: The recipe presented here is quite simple, similar to the one on CPUs. Here,
    your guest needs to be prepared to use this functionality as well.
  id: totrans-245
  prefs: []
  type: TYPE_NORMAL
  zh: 这里介绍的操作非常简单，类似于CPU的操作。在这里，客户机也需要为使用此功能做好准备。
- en: Getting ready
  id: totrans-246
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: 'If you want to be able to add memory on the fly to a guest, it must be configured
    to support it. As with the CPU, this has to be activated. There are three ways
    to do this:'
  id: totrans-247
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你想能够动态为客户机添加内存，必须配置以支持此功能。与CPU一样，这必须被激活。实现这一点有三种方法：
- en: 'The guest must be created with the `maxmem` option, as follows:'
  id: totrans-248
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 客户机必须在创建时指定`maxmem`选项，如下所示：
- en: '[PRE51]'
  id: totrans-249
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE51]'
- en: 'You can set the maximum memory using the `virsh` command, as follows:'
  id: totrans-250
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以使用`virsh`命令设置最大内存，如下所示：
- en: '[PRE52]'
  id: totrans-251
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE52]'
- en: 'You can edit the guests'' XML files:'
  id: totrans-252
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你可以编辑客户机的XML文件：
- en: '[PRE53]'
  id: totrans-253
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE53]'
- en: Of course, the latter 2 option requires you to shut down the guest, which is
    not always possible in production environments.
  id: totrans-254
  prefs: []
  type: TYPE_NORMAL
  zh: 当然，后两种选项要求你关闭客户机，这在生产环境中并不总是可能的。
- en: 'Ensure that the guests'' XML configuration files contain the following elements
    with the subsequent attributes:'
  id: totrans-255
  prefs: []
  type: TYPE_NORMAL
  zh: 确保客户机的XML配置文件包含以下元素及其随后的属性：
- en: '[PRE54]'
  id: totrans-256
  prefs: []
  type: TYPE_PRE
  zh: '[PRE54]'
- en: How to do it…
  id: totrans-257
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: Let's increase the guest's memory.
  id: totrans-258
  prefs: []
  type: TYPE_NORMAL
  zh: 让我们增加客户机的内存。
- en: 'On the KVM host, perform the following steps:'
  id: totrans-259
  prefs: []
  type: TYPE_NORMAL
  zh: 在KVM主机上，执行以下步骤：
- en: 'Get the current and maximum memory allocation for a guest, as follows:'
  id: totrans-260
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 获取来宾当前和最大内存分配，操作如下：
- en: '[PRE55]'
  id: totrans-261
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE55]'
- en: 'Set the new amount of memory for the guest by executing the following command:'
  id: totrans-262
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过执行以下命令来设置来宾的新内存量：
- en: '[PRE56]'
  id: totrans-263
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE56]'
- en: 'On the KVM guest, perform the following:'
  id: totrans-264
  prefs: []
  type: TYPE_NORMAL
  zh: 在KVM来宾上，执行以下操作：
- en: 'Tell your guest OS about the memory increase through this command:'
  id: totrans-265
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令通知来宾操作系统内存增加：
- en: '[PRE57]'
  id: totrans-266
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE57]'
- en: Adding disks on the fly
  id: totrans-267
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 动态添加磁盘
- en: This recipe includes instructions on how to create different types of storage
    volumes. Storage volumes are dedicated storage sets aside for use by guests.
  id: totrans-268
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程包括了如何创建不同类型的存储卷的说明。存储卷是为来宾专门划分的存储空间。
- en: Getting ready
  id: totrans-269
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: There is not a lot of preparation to be done in order to add disks to your guest,
    which is in contrast to adding CPUs and RAM.
  id: totrans-270
  prefs: []
  type: TYPE_NORMAL
  zh: 向来宾添加磁盘所需的准备工作不多，这与添加CPU和内存的过程不同。
- en: You only need to ensure that the storage pool has enough free disk space to
    accommodate the new disk.
  id: totrans-271
  prefs: []
  type: TYPE_NORMAL
  zh: 你只需要确保存储池有足够的空闲磁盘空间来容纳新磁盘。
- en: How to do it…
  id: totrans-272
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'Similar to the recipe for creating guests, you''ll need to create a disk first.
    This can be done as follows:'
  id: totrans-273
  prefs: []
  type: TYPE_NORMAL
  zh: 类似于创建来宾的过程，你首先需要创建一个磁盘。可以按以下方式操作：
- en: 'Let''s create a raw disk in the `localfs-vm` pool that is `30` GB big through
    the following command:'
  id: totrans-274
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令，在`localfs-vm`存储池中创建一个`30`GB的原始磁盘：
- en: '[PRE58]'
  id: totrans-275
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE58]'
- en: 'Look up the path of the newly created volume, as follows:'
  id: totrans-276
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 查找新创建卷的路径，操作如下：
- en: '[PRE59]'
  id: totrans-277
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE59]'
- en: 'This will result in the path of your volume; here''s an example:'
  id: totrans-278
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: 这将显示你卷的路径；以下是一个示例：
- en: '[PRE60]'
  id: totrans-279
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE60]'
- en: 'Attach the disk to the guest, as follows:'
  id: totrans-280
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 按以下方式将磁盘附加到来宾：
- en: '[PRE61]'
  id: totrans-281
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE61]'
- en: How it works…
  id: totrans-282
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 工作原理……
- en: Creating a disk using `vol-create-as` may take some time depending on the speed
    of your host's disks and the size of the guest's disks.
  id: totrans-283
  prefs: []
  type: TYPE_NORMAL
  zh: 使用`vol-create-as`创建磁盘可能需要一些时间，这取决于主机磁盘的速度和来宾磁盘的大小。
- en: We will look up the path of the newly created volume as it is a required argument
    for the command that attaches the disk to the guest. In most cases, you won't
    need to do this as you'll know how your host is configured, but when you script
    this kind of functionality, you will require this step.
  id: totrans-284
  prefs: []
  type: TYPE_NORMAL
  zh: 我们将查找新创建卷的路径，因为这是将磁盘附加到来宾时所需的参数。在大多数情况下，你不需要这样做，因为你会知道主机的配置，但是当你编写脚本来实现此功能时，就需要这一步骤。
- en: Adding a disk in this way will attach a disk using the `virtio` driver, which,
    as specified earlier, is optimized for use with KVMs.
  id: totrans-285
  prefs: []
  type: TYPE_NORMAL
  zh: 以这种方式添加磁盘将使用`virtio`驱动程序附加磁盘，正如前面所述，`virtio`驱动程序经过优化，适用于KVM。
- en: There's more…
  id: totrans-286
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多内容……
- en: 'If, for some reason, the original guest doesn''t support `virtio` drivers or
    you do not have the `virtio` controller, you can create this yourself. Store the
    XML configuration file as `/tmp/controller.xml` with the following contents:'
  id: totrans-287
  prefs: []
  type: TYPE_NORMAL
  zh: 如果由于某种原因，原始来宾不支持`virtio`驱动程序，或者你没有`virtio`控制器，你可以自行创建此控制器。将XML配置文件保存为`/tmp/controller.xml`，并包含以下内容：
- en: '[PRE62]'
  id: totrans-288
  prefs: []
  type: TYPE_PRE
  zh: '[PRE62]'
- en: You can find this out by checking the host's XML file for the preceding statement.
  id: totrans-289
  prefs: []
  type: TYPE_NORMAL
  zh: 你可以通过检查主机的XML文件中的前述语句来了解这一点。
- en: 'Then, import the XML configuration file, as follows:'
  id: totrans-290
  prefs: []
  type: TYPE_NORMAL
  zh: 然后，导入XML配置文件，操作如下：
- en: '[PRE63]'
  id: totrans-291
  prefs: []
  type: TYPE_PRE
  zh: '[PRE63]'
- en: This will allow you to create disks using `virtio`.
  id: totrans-292
  prefs: []
  type: TYPE_NORMAL
  zh: 这将允许你使用`virtio`创建磁盘。
- en: Moving disks to another storage
  id: totrans-293
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 将磁盘移动到另一个存储位置
- en: Moving disks around is part of the life cycle of a guest. Disks in the storage
    pools (local or network) may fail or fill up due to bad capacity management. Another
    reason may be the cost or speed of the disks involved. Sooner or later, one of
    these things will happen, and then you will need to move the storage somewhere
    else.
  id: totrans-294
  prefs: []
  type: TYPE_NORMAL
  zh: 移动磁盘是来宾生命周期的一部分。存储池中的磁盘（无论是本地的还是网络上的）可能会因容量管理不当而发生故障或填满。另一个原因可能是涉及的磁盘的成本或速度。迟早这些事情会发生，届时你就需要将存储迁移到别的地方。
- en: Ordinarily, one would have to shut down the guest, copy the storage volume file
    elsewhere (if it is a file), wait, update the machine's XML configuration, and
    launch it again. However, in today's mission-critical enterprises, this may not
    always be possible.
  id: totrans-295
  prefs: []
  type: TYPE_NORMAL
  zh: 通常情况下，必须关闭来宾，复制存储卷文件到其他地方（如果它是一个文件），等待，更新机器的XML配置，并重新启动来宾。然而，在今天的关键任务企业中，这种操作可能并不总是可行。
- en: Getting ready
  id: totrans-296
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备工作
- en: In order to perform this copy, you need the source and destination paths of
    the disk. You can get the source path by checking the XML configuration file or,
    even better, by querying the storage volume itself. This does require you to know
    which storage pool it is located on.
  id: totrans-297
  prefs: []
  type: TYPE_NORMAL
  zh: 为了执行此复制，你需要磁盘的源路径和目标路径。你可以通过检查XML配置文件来获取源路径，或者更好的是，通过查询存储卷本身来获取。这确实要求你知道磁盘所在的存储池。
- en: 'Execute the following command:'
  id: totrans-298
  prefs: []
  type: TYPE_NORMAL
  zh: 执行以下命令：
- en: '[PRE64]'
  id: totrans-299
  prefs: []
  type: TYPE_PRE
  zh: '[PRE64]'
- en: Ensure that your destination is an existing storage pool; if not, go ahead and
    create it.
  id: totrans-300
  prefs: []
  type: TYPE_NORMAL
  zh: 确保目标是现有的存储池；如果没有，请创建一个。
- en: Check out the *Configuring resources* recipe in this chapter to create storage
    pools.
  id: totrans-301
  prefs: []
  type: TYPE_NORMAL
  zh: 查看本章中的*配置资源*教程，以创建存储池。
- en: 'If you can''t remember the path to your pool''s location, run the following:'
  id: totrans-302
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你记不住池的路径位置，可以执行以下命令：
- en: '[PRE65]'
  id: totrans-303
  prefs: []
  type: TYPE_PRE
  zh: '[PRE65]'
- en: How to do it…
  id: totrans-304
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作…
- en: 'Moving disks can take some time, so ensure that you have plenty of time available.
    Perform the following steps:'
  id: totrans-305
  prefs: []
  type: TYPE_NORMAL
  zh: 移动磁盘可能需要一些时间，因此确保你有足够的时间。执行以下步骤：
- en: 'Dump the inactive XML configuration file for the guest, as follows:'
  id: totrans-306
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 转储来宾的非活动XML配置文件，如下所示：
- en: '[PRE66]'
  id: totrans-307
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE66]'
- en: The `–-inactive` file will ensure that it doesn't copy any temporary information
    that is irrelevant to the guest.
  id: totrans-308
  prefs:
  - PREF_IND
  type: TYPE_NORMAL
  zh: '`–-inactive`文件将确保不会复制任何与来宾无关的临时信息。'
- en: 'Undefine the guest through the following command:'
  id: totrans-309
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 通过以下命令取消定义来宾：
- en: '[PRE67]'
  id: totrans-310
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE67]'
- en: 'Copy the virtual disk to another location by executing the following:'
  id: totrans-311
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 执行以下命令将虚拟磁盘复制到另一个位置：
- en: '[PRE68]'
  id: totrans-312
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE68]'
- en: Now, edit the guest's XML configuration file and change the path of the disk
    to the new location.
  id: totrans-313
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 现在，编辑来宾的XML配置文件，并将磁盘路径更改为新位置。
- en: 'Redefine the guest, as follows:'
  id: totrans-314
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 重新定义来宾，如下所示：
- en: '[PRE69]'
  id: totrans-315
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE69]'
- en: 'Remove the source disk after you are happy with the results. Run the following
    command:'
  id: totrans-316
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 在对结果满意后，移除源磁盘。执行以下命令：
- en: '[PRE70]'
  id: totrans-317
  prefs:
  - PREF_IND
  type: TYPE_PRE
  zh: '[PRE70]'
- en: How it works…
  id: totrans-318
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它的工作原理是…
- en: The moving of disks can only be performed on transient domains, which is the
    reason we execute the `virsh undefine` command. In order to be able to make it
    persistent again after the transfer, we also need to dump the XML configuration
    file and modify the storage volume path.
  id: totrans-319
  prefs: []
  type: TYPE_NORMAL
  zh: 磁盘移动只能在瞬态域中执行，这也是我们执行`virsh undefine`命令的原因。为了在迁移后能再次使其持久化，我们还需要转储XML配置文件并修改存储卷路径。
- en: 'Moving the disk does two things, which are:'
  id: totrans-320
  prefs: []
  type: TYPE_NORMAL
  zh: 移动磁盘时会做两件事，分别是：
- en: Firstly, it copies all the data of the source to the destination
  id: totrans-321
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 首先，它将源数据全部复制到目标位置
- en: Secondly, when the copying is complete, both source and destination remain mirrored
    until it is either canceled with `blockjob --abort` or actually switched over
    to the new target by executing the `blockjob --pivot` command
  id: totrans-322
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 其次，当复制完成时，源和目标将保持镜像状态，直到通过执行`blockjob --pivot`命令切换到新目标，或者通过`blockjob --abort`取消任务。
- en: 'The preceding `blockcopy` command does everything at the same time. The `--wait`
    command will not give control back to the user until the command fails or succeeds.
    It is essentially the same as the following:'
  id: totrans-323
  prefs: []
  type: TYPE_NORMAL
  zh: 上述`blockcopy`命令同时完成所有任务。`--wait`命令在命令失败或成功之前不会将控制权返回给用户。它本质上与以下命令相同：
- en: '[PRE71]'
  id: totrans-324
  prefs: []
  type: TYPE_PRE
  zh: '[PRE71]'
- en: 'Monitor the progress of the copy by executing the following:'
  id: totrans-325
  prefs: []
  type: TYPE_NORMAL
  zh: 通过执行以下命令监控复制进度：
- en: '[PRE72]'
  id: totrans-326
  prefs: []
  type: TYPE_PRE
  zh: '[PRE72]'
- en: 'When it''s done, execute this:'
  id: totrans-327
  prefs: []
  type: TYPE_NORMAL
  zh: 完成后，执行以下命令：
- en: '[PRE73]'
  id: totrans-328
  prefs: []
  type: TYPE_PRE
  zh: '[PRE73]'
- en: There's more…
  id: totrans-329
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多…
- en: It is also possible to change the disk format on the fly, by specifying the
    `--format` argument with the format that you want to convert your disk into. If
    you want to copy it to a block device, specify `--blockdev`.
  id: totrans-330
  prefs: []
  type: TYPE_NORMAL
  zh: 还可以在迁移过程中改变磁盘格式，通过指定`--format`参数和目标格式。如果你想将其复制到块设备，可以指定`--blockdev`。
- en: Moving VMs
  id: totrans-331
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 移动虚拟机
- en: Moving disks will mitigate the risk of failing disks. When your CPUs, memory,
    and other non-disk-related components start failing, you have no other option
    but to move the guests to other host(s).
  id: totrans-332
  prefs: []
  type: TYPE_NORMAL
  zh: 移动磁盘将减少磁盘故障的风险。当你的CPU、内存和其他非磁盘相关组件开始出现故障时，你别无选择，只能将来宾迁移到其他主机。
- en: The recipe for this task is rather simple, but it's the prerequisites that can
    make it succeed or fail miserably.
  id: totrans-333
  prefs: []
  type: TYPE_NORMAL
  zh: 本任务的过程相对简单，但正是前提条件决定了任务是否能够成功，或者彻底失败。
- en: Getting ready
  id: totrans-334
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 准备就绪
- en: The prerequisites for this recipe are quite extended.
  id: totrans-335
  prefs: []
  type: TYPE_NORMAL
  zh: 本教程的前提条件相当复杂。
- en: 'For the host, the following are the requirements:'
  id: totrans-336
  prefs: []
  type: TYPE_NORMAL
  zh: 对于主机，以下是要求：
- en: You'll need to have access to shared data. Both the source and destination KVM
    machine will need to be able to access the same storage—for example, iSCSI, NFS,
    and so on.
  id: totrans-337
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 你需要有访问共享数据的权限。源主机和目标主机上的KVM机器都需要能够访问相同的存储——例如iSCSI、NFS等。
- en: Both hosts need the same type of CPU—that is, Intel or AMD (one cannot live
    migrate a guest from a host with Intel CPUs to a host with AMD CPUs).
  id: totrans-338
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两台主机需要使用相同类型的CPU——即Intel或AMD（不能将来宾从Intel CPU的主机迁移到AMD CPU的主机）。
- en: Both hosts need to be installed with the same version and updates of libvirt.
  id: totrans-339
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两台主机需要安装相同版本和更新的libvirt。
- en: Both hosts need to have the same network ports open.
  id: totrans-340
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两台主机需要开放相同的网络端口。
- en: Both hosts must have identical KVM network configurations or at least the same
    network configurations for the interfaces used by the guest.
  id: totrans-341
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两台主机必须具有相同的 KVM 网络配置，或者至少在来宾使用的接口上有相同的网络配置。
- en: Both hosts must be accessible through the network.
  id: totrans-342
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 两台主机必须通过网络互通。
- en: It's a good idea to have a management network set up and connected to the two
    hosts, which can be used for data transfer. This will cause less network traffic
    on your "production" network and increase the overall speed.
  id: totrans-343
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 最好设置并连接一个管理网络，连接到两台主机，供数据传输使用。这会减少你“生产”网络上的流量，并提高整体速度。
- en: The `No execution` bit must be the same on both hosts.
  id: totrans-344
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '`No execution` 位必须在两台主机上保持一致。'
- en: 'The requirement for the guest is:'
  id: totrans-345
  prefs: []
  type: TYPE_NORMAL
  zh: 来宾的要求是：
- en: The `cache=none` must be specified for all block devices that are opened in
    write mode.
  id: totrans-346
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: 所有以写模式打开的块设备必须指定 `cache=none`。
- en: How to do it…
  id: totrans-347
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: There are multiple ways to migrate hosts, but we will only highlight the two
    most common ways.
  id: totrans-348
  prefs: []
  type: TYPE_NORMAL
  zh: 有多种方式迁移主机，但我们只会突出介绍两种最常见的方式。
- en: Live native migration over the default network
  id: totrans-349
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 默认网络上的实时本地迁移
- en: This process to migrate a host is luckily very simple and can be summarized
    in one command.
  id: totrans-350
  prefs: []
  type: TYPE_NORMAL
  zh: 迁移主机的过程幸运的是非常简单，可以通过一条命令来概括。
- en: 'On the source host, execute the following:'
  id: totrans-351
  prefs: []
  type: TYPE_NORMAL
  zh: 在源主机上执行以下操作：
- en: '[PRE74]'
  id: totrans-352
  prefs: []
  type: TYPE_PRE
  zh: '[PRE74]'
- en: Live native migration over a dedicated network
  id: totrans-353
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: 专用网络上的实时本地迁移
- en: It is possible to perform the migration over a dedicated network. By default,
    this will use the first network it finds that suits it needs. You'll need to specify
    the listening address (on the host) and the protocol. This requires the same command
    as before, but we'll need to specify the local listening IP address and protocol,
    such as TCP.
  id: totrans-354
  prefs: []
  type: TYPE_NORMAL
  zh: 可以通过专用网络进行迁移。默认情况下，它会使用找到的第一个适合的网络。你需要指定监听地址（在主机上）和协议。这个过程与之前的命令相同，只不过我们需要指定本地监听
    IP 地址和协议，例如 TCP。
- en: 'On the source host, execute the following:'
  id: totrans-355
  prefs: []
  type: TYPE_NORMAL
  zh: 在源主机上执行以下操作：
- en: '[PRE75]'
  id: totrans-356
  prefs: []
  type: TYPE_PRE
  zh: '[PRE75]'
- en: How it works…
  id: totrans-357
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的……
- en: This type of migration is called a "hypervisor native" transport. The biggest
    advantage of this type of migration is that it incurs the lowest computational
    cost by minimizing the number of data copies involved.
  id: totrans-358
  prefs: []
  type: TYPE_NORMAL
  zh: 这种类型的迁移被称为“虚拟化管理程序本地”传输。该类型迁移的最大优点是通过最小化涉及的数据复制次数，从而带来了最低的计算成本。
- en: When we migrate a host, it performs a copy of the memory of the guest to the
    new host. When the copying is successful, it kills the guest on the source host
    and starts it on the new host. As the memory is copied, the interruption will
    be very short-lived.
  id: totrans-359
  prefs: []
  type: TYPE_NORMAL
  zh: 当我们迁移主机时，它会将来宾的内存复制到新主机。当复制成功时，它会在源主机上终止来宾并在新主机上启动它。由于内存是逐步复制的，所以中断时间非常短。
- en: There's more…
  id: totrans-360
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 还有更多……
- en: Communication between the two hosts is over SSH, which is already pretty secure.
    However, it's also possible to tunnel the data over an even more strongly encrypted
    channel by specifying the `--tunnelled` option. This will impose more traffic
    on your network as there will be extra data communication between the two hosts.
  id: totrans-361
  prefs: []
  type: TYPE_NORMAL
  zh: 两台主机之间的通信通过 SSH，这已经相当安全。然而，通过指定 `--tunnelled` 选项，也可以通过一个更加加密的通道隧道化数据。这会在你的网络上增加更多流量，因为两台主机之间会有额外的数据通信。
- en: The `--compress` option can help you out if you wish to reduce the traffic over
    your network, but this will increase the load on both your hosts as they need
    to compress/decompress the data, which, in turn, may impact your guests performance.
    If time is not of the essence but traffic is, this is a good solution.
  id: totrans-362
  prefs: []
  type: TYPE_NORMAL
  zh: 如果你希望减少网络上的流量，`--compress` 选项可以帮助你，但这会增加主机的负载，因为它们需要进行数据的压缩/解压缩，这反过来可能会影响来宾的性能。如果时间不是关键，但流量需要减少，这是一个不错的解决方案。
- en: See also
  id: totrans-363
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 参见：
- en: There's very good and in-depth documentation about this process at [https://libvirt.org/migration.html](https://libvirt.org/migration.html).
  id: totrans-364
  prefs: []
  type: TYPE_NORMAL
  zh: 关于这个过程有非常详细的文档可以参考：[https://libvirt.org/migration.html](https://libvirt.org/migration.html)。
- en: Backing up your VM metadata
  id: totrans-365
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 备份你的虚拟机元数据
- en: While a KVM stores some of the resources' configuration on the disk in a human
    readable format, it is a good idea to query libvirt for the configuration of your
    resources.
  id: totrans-366
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 KVM 会将部分资源的配置以可读格式存储在磁盘上，但查询 libvirt 以获取资源的配置是一个不错的选择。
- en: How to do it…
  id: totrans-367
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 如何操作……
- en: 'In this recipe we''ll back up all relevant KVM metadata by performing the following
    steps:'
  id: totrans-368
  prefs: []
  type: TYPE_NORMAL
  zh: 在这个步骤中，我们将通过以下步骤备份所有相关的 KVM 元数据：
- en: 'Here''s the network configuration:'
  id: totrans-369
  prefs: []
  type: TYPE_NORMAL
  zh: 这是网络配置：
- en: '[PRE76]'
  id: totrans-370
  prefs: []
  type: TYPE_PRE
  zh: '[PRE76]'
- en: 'Here''s the storage configuration:'
  id: totrans-371
  prefs: []
  type: TYPE_NORMAL
  zh: 这是存储配置：
- en: '[PRE77]'
  id: totrans-372
  prefs: []
  type: TYPE_PRE
  zh: '[PRE77]'
- en: 'Here''s the guest configuration:'
  id: totrans-373
  prefs: []
  type: TYPE_NORMAL
  zh: 这是来宾配置：
- en: '[PRE78]'
  id: totrans-374
  prefs: []
  type: TYPE_PRE
  zh: '[PRE78]'
- en: How it works…
  id: totrans-375
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 它是如何工作的……
- en: The `virsh net-dumpxml` command allows you to dump the precise configuration
    of the specified network. In combination with `virsh net-list`, you can create
    a loop that enumerates all networks and dumps them on the file. By specifying
    `–-all`, you will export all networks, even those that are not active. If you
    do not wish to back up the configuration for nonactive networks, substitute `virsh
    net-list --all` with `virsh net-list`.
  id: totrans-376
  prefs: []
  type: TYPE_NORMAL
  zh: '`virsh net-dumpxml`命令允许你转储指定网络的精确配置。结合`virsh net-list`，你可以创建一个循环，列举所有网络并将其转储到文件中。通过指定`--all`，你将导出所有网络，包括那些不活跃的网络。如果你不希望备份非活动网络的配置，可以将`virsh
    net-list --all`替换为`virsh net-list`。'
- en: Storage pools can be enumerated, similarly to networks, using `virsh net-list`.
    However, besides the individual storage pool configuration, we are also interested
    in the configuration of individual storage volumes. Luckily, both implement a
    `list` and `dumpxml` command! If you're not interested in nonactive pools, you
    can omit the `--all` option with `virsh pool-list`.
  id: totrans-377
  prefs: []
  type: TYPE_NORMAL
  zh: 存储池可以像网络一样使用`virsh net-list`进行列举。不过，除了单个存储池配置外，我们还对单个存储卷的配置感兴趣。幸运的是，二者都实现了`list`和`dumpxml`命令！如果你不关心非活动存储池，可以在`virsh
    pool-list`中省略`--all`选项。
- en: Guests can similarly be enumerated and their XML configuration dumped using
    `dumpxml`. Again, if you're not interested in nonactive guests, you can omit the
    `--all` option with `virsh list`.
  id: totrans-378
  prefs: []
  type: TYPE_NORMAL
  zh: 客户机也可以类似地进行列举，并使用`dumpxml`转储其XML配置。同样，如果你不关心非活动客户机，可以在`virsh list`中省略`--all`选项。
- en: See also
  id: totrans-379
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: 另请参阅
- en: The man page for *virsh (1)* lists all the possible options for the commands
    used in the preceding section.
  id: totrans-380
  prefs: []
  type: TYPE_NORMAL
  zh: '*virsh (1)*的手册页列出了前面章节中使用的所有命令选项。'
